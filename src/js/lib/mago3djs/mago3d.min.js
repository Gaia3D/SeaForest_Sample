"use strict";function changeMagoStateAPI(t,e){if(null!==t){var i=new Mago3D.API("changeMagoState");i.setMagoEnable(e),t.callAPI(i)}}function changeLabelAPI(t,e){if(null!==t){var i=new Mago3D.API("changeLabel");i.setShowLabelInfo(e),t.callAPI(i)}}function changeOriginAPI(t,e){if(null!==t){var i=new Mago3D.API("changeOrigin");i.setShowOrigin(e),t.callAPI(i)}}function changeBoundingBoxAPI(t,e){if(null!==t){var i=new Mago3D.API("changeBoundingBox");i.setShowBoundingBox(e),t.callAPI(i)}}function changePropertyRenderingAPI(t,e,i,r){if(null!==t){var o=new Mago3D.API("changePropertyRendering");o.setShowShadow(e),o.setProjectId(i),o.setProperty(r),t.callAPI(o)}}function changeShadowAPI(t,e){if(null!==t){var i=new Mago3D.API("changeShadow");i.setShowShadow(e),t.callAPI(i)}}function changeColorAPI(t,e,i,r,o,n){if(null!==t){var a=new Mago3D.API("changeColor");a.setProjectId(e),a.setDataKey(i),a.setObjectIds(r),a.setProperty(o),a.setColor(n),t.callAPI(a)}}function changeLocationAndRotationAPI(t,e,i,r,o,n,a,s,l,h){if(null!==t){var d=new Mago3D.API("changeLocationAndRotation");d.setProjectId(e),d.setDataKey(i),d.setLatitude(r),d.setLongitude(o),d.setElevation(n),d.setHeading(a),d.setPitch(s),d.setRoll(l),d.setAnimationOption(h),t.callAPI(d)}}function changeObjectMoveAPI(t,e){if(null!==t){var i=new Mago3D.API("changeObjectMove");i.setObjectMoveMode(e),t.callAPI(i)}}function saveObjectMoveAPI(t,e){if(null!==t){var i=new Mago3D.API("saveObjectMove");i.setObjectMoveMode(e),t.callAPI(i)}}function deleteAllObjectMoveAPI(t,e){if(null!==t){var i=new Mago3D.API("deleteAllObjectMove");i.setObjectMoveMode(e),t.callAPI(i)}}function deleteAllChangeColorAPI(t){if(null!==t){var e=new Mago3D.API("deleteAllChangeColor");t.callAPI(e)}}function changeInsertIssueModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeInsertIssueMode");i.setIssueInsertEnable(e),t.callAPI(i)}}function changeObjectInfoViewModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeObjectInfoViewMode");i.setObjectInfoViewEnable(e),t.callAPI(i)}}function changeOcclusionCullingAPI(t,e,i){if(null!==t){var r=new Mago3D.API("changeOcclusionCulling");r.setOcclusionCullingEnable(e),r.setDataKey(i),t.callAPI(r)}}function changeFPVModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeFPVMode");i.setFPVMode(e),t.callAPI(i)}}function changeMagoModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeMagoMode");i.setMagoMode(e),t.callAPI(i)}}function changeNearGeoIssueListViewModeAPI(t,e){if(null!==t){var i=new Mago3D.API("changeNearGeoIssueListViewMode");i.setNearGeoIssueListEnable(e),t.callAPI(i)}}function changeInsertIssueStateAPI(t,e){if(null!==t){var i=new Mago3D.API("changeInsertIssueState");i.setInsertIssueState(e),t.callAPI(i)}}function changeLodAPI(t,e,i,r,o,n,a){if(null!==t){var s=new Mago3D.API("changeLod");s.setLod0DistInMeters(e),s.setLod1DistInMeters(i),s.setLod2DistInMeters(r),s.setLod3DistInMeters(o),s.setLod4DistInMeters(n),s.setLod5DistInMeters(a),t.callAPI(s)}}function changeLightingAPI(t,e,i,r,o,n){if(null!==t){var a=new Mago3D.API("changeLighting");a.setAmbientReflectionCoef(e),a.setDiffuseReflectionCoef(i),a.setSpecularReflectionCoef(r),a.setAmbientColor(o),a.setSpecularColor(n),t.callAPI(a)}}function changeSsaoRadiusAPI(t,e){if(null!==t){var i=new Mago3D.API("changeSsaoRadius");i.setSsaoRadius(e),t.callAPI(i)}}function clearAllDataAPI(t){if(null!==t){var e=new Mago3D.API("clearAllData");Mago3D.MagoConfig.clearAllData(),t.callAPI(e)}}function drawInsertIssueImageAPI(t,e,i,r,o,n,a,s){if(null!==t){var l=new Mago3D.API("drawInsertIssueImage");l.setDrawType(e),l.setIssueId(i),l.setIssueId(r),l.setDataKey(o),l.setLatitude(n),l.setLongitude(a),l.setElevation(s),t.callAPI(l)}}function gotoProjectAPI(t,e,i,r,o,n,a,s){if(null!==t){Mago3D.MagoConfig.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,i),Mago3D.MagoConfig.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+r,r);var l=new Mago3D.API("gotoProject");l.setProjectId(e),l.setProjectDataFolder(r),l.setLatitude(n),l.setLongitude(o),l.setElevation(a),l.setDuration(s),t.callAPI(l)}}function gotoIssueAPI(t,e,i,r,o,n,a,s,l,h){if(null!==t){Mago3D.MagoConfig.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,i),Mago3D.MagoConfig.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+r,r);var d=new Mago3D.API("gotoIssue");d.setProjectId(e),d.setProjectDataFolder(r),d.setIssueId(o),d.setIssueType(n),d.setLatitude(s),d.setLongitude(a),d.setElevation(l),d.setDuration(h),t.callAPI(d)}}function gotoFlyAPI(t,e,i,r,o){if(null!==t){var n=new Mago3D.API("gotoFly");n.setLongitude(e),n.setLatitude(i),n.setElevation(r),n.setDuration(o),t.callAPI(n)}}function mouseMoveAPI(t,e){null!==t&&t.mouseMove(e)}function searchDataAPI(t,e,i){if(null!==t){var r=new Mago3D.API("searchData");r.setProjectId(e),r.setDataKey(i),t.callAPI(r)}}function isDataExistAPI(t){return!!Mago3D.MagoConfig.isDataExist(t)}function getDataAPI(t){return Mago3D.MagoConfig.getData(t)}function getDataInfoByDataKeyAPI(t,e,i){if(null!==t){var r=new Mago3D.API("getDataInfoByDataKey");return r.setReturnable(!0),r.setProjectId(e),r.setDataKey(i),t.callAPI(r)}}function drawAppendDataAPI(t,e,i,r){if(null!==t&&!(e.length<=0)){var o=new Mago3D.API("drawAppendData");e.forEach(function(e,n){Mago3D.MagoConfig.setData(Mago3D.CODE.PROJECT_ID_PREFIX+e,i[n]),Mago3D.MagoConfig.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+r[n],r[n]),o.setProjectId(e),o.setProjectDataFolder(r[n]),t.callAPI(o)})}}function getCoordinateRelativeToBuildingAPI(t,e,i,r,o){if(null!==t){var n=new Mago3D.API("getCoordinateRelativeToBuilding");return n.setReturnable(!0),n.setProjectId(e),n.setDataKey(i),n.setInputPoint(r),n.setResultPoint(o),t.callAPI(n)}}function getAbsoluteCoodinateOfBuildingPointAPI(t,e,i,r,o){if(null!==t){var n=new Mago3D.API("getAbsoluteCoodinateOfBuildingPoint");return n.setReturnable(!0),n.setProjectId(e),n.setDataKey(i),n.setInputPoint(r),n.setResultPoint(o),t.callAPI(n)}}function getCameraCurrentPositionAPI(t,e){var i=new Mago3D.API("getCameraCurrentPosition");return i.setReturnable(!0),i.setUnit(e),t.callAPI(i)}function getCameraCurrentOrientaionAPI(t){var e=new Mago3D.API("getCameraCurrentOrientaion");return e.setReturnable(!0),t.callAPI(e)}function changeCameraOrientationAPI(t,e,i,r,o){var n=new Mago3D.API("changeCameraOrientation");n.setHeading(e),n.setPitch(i),n.setRoll(r),n.setDuration(o),t.callAPI(n)}function instantiateStaticModelAPI(t,e){var i=new Mago3D.API("instantiateStaticModel");i.setInstantiateObj(e),t.callAPI(i)}function addStaticModelAPI(t,e){var i=new Mago3D.API("addStaticModel");i.setStaticModelAttributeObj(e),t.callAPI(i)}function setTrackNodeAPI(t,e,i,r){var o=new Mago3D.API("setTrackNode");o.setProjectId(e),o.setDataKey(i),o.setTrackOption(r),t.callAPI(o)}function stopTrackAPI(t){var e=new Mago3D.API("stopTrack");t.callAPI(e)}function isExistStaticModelAPI(t,e){var i=new Mago3D.API("isExistStaticModel");return i.setReturnable(!0),i.setProjectId(e),t.callAPI(i)}function isExistDataAPI(t,e,i){var r=new Mago3D.API("isExistData");return r.setReturnable(!0),r.setProjectId(e),r.setDataKey(i),t.callAPI(r)}function isDataReadyToRenderAPI(t,e,i){var r=new Mago3D.API("isDataReadyToRender");return r.setReturnable(!0),r.setProjectId(e),r.setDataKey(i),t.callAPI(r)}function setNodeAttributeAPI(t,e,i,r){var o=new Mago3D.API("setNodeAttribute");o.setProjectId(e),o.setDataKey(i),o.setNodeAttribute(r),t.callAPI(o)}function togglePointCloudColorAPI(t){var e=new Mago3D.API("togglePointCloudColor");t.callAPI(e)}function selectF4dAPI(t,e,i){var r=new Mago3D.API("selectF4d");r.setProjectId(e),r.setDataKey(i),t.callAPI(r)}function apiResultCallback(t,e,i){window[t](e,i)}function selectedObjectCallback(t,e,i,r,o,n,a,s,l,h){window[t](e,i,r,o,n,a,s,l,h)}function movedDataCallback(t,e,i,r,o,n,a,s,l,h){window[t](e,i,r,o,n,a,s,l,h)}function dataInfoCallback(t,e,i,r,o,n,a,s,l,h){window[t](e,i,r,o,n,a,s,l,h)}function insertIssueCallback(t,e,i,r,o,n,a){window[t](e,i,r,o,n,a)}function clickPositionCallback(t,e){window[t](e)}var DataStream=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||1),this.position=0,this.endianness=null==i?DataStream.LITTLE_ENDIAN:i};DataStream.prototype={},void 0===Uint8Array.prototype.BYTES_PER_ELEMENT&&(Uint8Array.prototype.BYTES_PER_ELEMENT=Uint8Array.BYTES_PER_ELEMENT,Int8Array.prototype.BYTES_PER_ELEMENT=Int8Array.BYTES_PER_ELEMENT,Uint8ClampedArray.prototype.BYTES_PER_ELEMENT=Uint8ClampedArray.BYTES_PER_ELEMENT,Uint16Array.prototype.BYTES_PER_ELEMENT=Uint16Array.BYTES_PER_ELEMENT,Int16Array.prototype.BYTES_PER_ELEMENT=Int16Array.BYTES_PER_ELEMENT,Uint32Array.prototype.BYTES_PER_ELEMENT=Uint32Array.BYTES_PER_ELEMENT,Int32Array.prototype.BYTES_PER_ELEMENT=Int32Array.BYTES_PER_ELEMENT,Float64Array.prototype.BYTES_PER_ELEMENT=Float64Array.BYTES_PER_ELEMENT),DataStream.prototype.save=function(t){var e=new Blob(this.buffer),i=window.webkitURL||window.URL;if(!i||!i.createObjectURL)throw"DataStream.save: Can't create object URL.";var r=i.createObjectURL(e),o=document.createElement("a");o.setAttribute("href",r),o.setAttribute("download",t),o.click(),i.revokeObjectURL(r)},DataStream.BIG_ENDIAN=!1,DataStream.LITTLE_ENDIAN=!0,DataStream.prototype._dynamicSize=!0,Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),DataStream.prototype._byteLength=0,Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(DataStream.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),DataStream.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i)e>this._byteLength&&(this._byteLength=e);else{for(i<1&&(i=1);e>i;)i*=2;var r=new ArrayBuffer(i),o=new Uint8Array(this._buffer);new Uint8Array(r,0,o.length).set(o),this.buffer=r,this._byteLength=e}}},DataStream.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}},DataStream.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},DataStream.prototype.isEof=function(){return this.position>=this.byteLength},DataStream.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},DataStream.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},DataStream.prototype.mapInt8Array=function(t){this._realloc(1*t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},DataStream.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},DataStream.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},DataStream.prototype.mapUint8Array=function(t){this._realloc(1*t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},DataStream.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=8*t,i},DataStream.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},DataStream.prototype.readInt32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Int32Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readInt16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Int16Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readInt8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Int8Array(t);return DataStream.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},DataStream.prototype.readUint32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Uint32Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readUint16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Uint16Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readUint8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Uint8Array(t);return DataStream.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},DataStream.prototype.readFloat64Array=function(t,e){t=null==t?this.byteLength-this.position/8:t;var i=new Float64Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.readFloat32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Float32Array(t);return DataStream.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),DataStream.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},DataStream.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},DataStream.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},DataStream.prototype.writeInt8Array=function(t){if(this._realloc(1*t.length),t instanceof Int8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},DataStream.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},DataStream.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},DataStream.prototype.writeUint8Array=function(t){if(this._realloc(1*t.length),t instanceof Uint8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},DataStream.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},DataStream.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},DataStream.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,null==t?this.endianness:t);return this.position+=2,e},DataStream.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},DataStream.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,null==t?this.endianness:t);return this.position+=2,e},DataStream.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},DataStream.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,null==t?this.endianness:t);return this.position+=4,e},DataStream.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,null==t?this.endianness:t);return this.position+=8,e},DataStream.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},DataStream.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},DataStream.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},DataStream.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},DataStream.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},DataStream.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},DataStream.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,DataStream.memcpy=function(t,e,i,r,o){var n=new Uint8Array(t,e,o),a=new Uint8Array(i,r,o);n.set(a)},DataStream.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},DataStream.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},DataStream.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var r=i+t.BYTES_PER_ELEMENT-1,o=i;r>o;r--,o++){var n=e[o];e[o]=e[r],e[r]=n}return t},DataStream.createStringFromArray=function(t){for(var e=[],i=0;i<t.length;i+=32768)e.push(String.fromCharCode.apply(null,t.subarray(i,i+32768)));return e.join("")},DataStream.prototype.failurePosition=0,DataStream.prototype.readStruct=function(t){for(var e,i,r={},o=this.position,n=0;n<t.length;n+=2){if(e=t[n+1],null==(i=this.readType(e,r)))return 0==this.failurePosition&&(this.failurePosition=this.position),this.position=o,null;r[t[n]]=i}return r},DataStream.prototype.readUCS2String=function(t,e){return DataStream.createStringFromArray(this.readUint16Array(t,e))},DataStream.prototype.writeUCS2String=function(t,e,i){null==i&&(i=t.length);for(var r=0;r<t.length&&r<i;r++)this.writeUint16(t.charCodeAt(r),e);for(;r<i;r++)this.writeUint16(0)},DataStream.prototype.readString=function(t,e){return null==e||"ASCII"==e?DataStream.createStringFromArray(this.mapUint8Array(null==t?this.byteLength-this.position:t)):new TextDecoder(e).decode(this.mapUint8Array(t))},DataStream.prototype.writeString=function(t,e,i){if(null==e||"ASCII"==e)if(null!=i){var r=0,o=Math.min(t.length,i);for(r=0;r<o;r++)this.writeUint8(t.charCodeAt(r));for(;r<i;r++)this.writeUint8(0)}else for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},DataStream.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),r=e;null!=t&&(r=Math.min(t,e));for(var o=0;o<r&&0!=i[o];o++);var n=DataStream.createStringFromArray(this.mapUint8Array(o));return null!=t?this.position+=r-o:o!=e&&(this.position+=1),n},DataStream.prototype.writeCString=function(t,e){if(null!=e){var i=0,r=Math.min(t.length,e);for(i=0;i<r;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},DataStream.prototype.readType=function(t,e){if("function"==typeof t)return t(this,e);if(!("object"!=typeof t||t instanceof Array))return t.get(this,e);if(t instanceof Array&&3!=t.length)return this.readStruct(t,e);var i,r=null,o=null,n="ASCII",a=this.position;"string"==typeof t&&/:/.test(t)&&(t=(i=t.split(":"))[0],o=null!=e[s=i[1]]?parseInt(e[s]):parseInt(i[1]));"string"==typeof t&&/,/.test(t)&&(t=(i=t.split(","))[0],n=parseInt(i[1]));switch(t){case"uint8":r=this.readUint8();break;case"int8":r=this.readInt8();break;case"uint16":r=this.readUint16(this.endianness);break;case"int16":r=this.readInt16(this.endianness);break;case"uint32":r=this.readUint32(this.endianness);break;case"int32":r=this.readInt32(this.endianness);break;case"float32":r=this.readFloat32(this.endianness);break;case"float64":r=this.readFloat64(this.endianness);break;case"uint16be":r=this.readUint16(DataStream.BIG_ENDIAN);break;case"int16be":r=this.readInt16(DataStream.BIG_ENDIAN);break;case"uint32be":r=this.readUint32(DataStream.BIG_ENDIAN);break;case"int32be":r=this.readInt32(DataStream.BIG_ENDIAN);break;case"float32be":r=this.readFloat32(DataStream.BIG_ENDIAN);break;case"float64be":r=this.readFloat64(DataStream.BIG_ENDIAN);break;case"uint16le":r=this.readUint16(DataStream.LITTLE_ENDIAN);break;case"int16le":r=this.readInt16(DataStream.LITTLE_ENDIAN);break;case"uint32le":r=this.readUint32(DataStream.LITTLE_ENDIAN);break;case"int32le":r=this.readInt32(DataStream.LITTLE_ENDIAN);break;case"float32le":r=this.readFloat32(DataStream.LITTLE_ENDIAN);break;case"float64le":r=this.readFloat64(DataStream.LITTLE_ENDIAN);break;case"cstring":r=this.readCString(o);break;case"string":r=this.readString(o,n);break;case"u16string":r=this.readUCS2String(o,this.endianness);break;case"u16stringle":r=this.readUCS2String(o,DataStream.LITTLE_ENDIAN);break;case"u16stringbe":r=this.readUCS2String(o,DataStream.BIG_ENDIAN);break;default:if(3==t.length){var s,l=t[1],h=0;if(h="function"==typeof(s=t[2])?s(e,this,t):"string"==typeof s&&null!=e[s]?parseInt(e[s]):parseInt(s),"string"==typeof l){var d=l.replace(/(le|be)$/,""),c=null;switch(/le$/.test(l)?c=DataStream.LITTLE_ENDIAN:/be$/.test(l)&&(c=DataStream.BIG_ENDIAN),"*"==s&&(h=null),d){case"uint8":r=this.readUint8Array(h);break;case"uint16":r=this.readUint16Array(h,c);break;case"uint32":r=this.readUint32Array(h,c);break;case"int8":r=this.readInt8Array(h);break;case"int16":r=this.readInt16Array(h,c);break;case"int32":r=this.readInt32Array(h,c);break;case"float32":r=this.readFloat32Array(h,c);break;case"float64":r=this.readFloat64Array(h,c);break;case"cstring":case"utf16string":case"string":if(null==h)for(r=[];!this.isEof();){if(null==(p=this.readType(l,e)))break;r.push(p)}else{r=new Array(h);for(var u=0;u<h;u++)r[u]=this.readType(l,e)}}}else if("*"==s)for(r=[],this.buffer;;){var f=this.position;try{var g=this.readType(l,e);if(null==g){this.position=f;break}r.push(g)}catch(t){this.position=f;break}}else{r=new Array(h);for(u=0;u<h;u++){var p;if(null==(p=this.readType(l,e)))return null;r[u]=p}}break}}return null!=o&&(this.position=a+o),r},DataStream.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var r=t[i+1];this.writeType(r,e[t[i]],e)}},DataStream.prototype.writeType=function(t,e,i){if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,i);var r,o=null,n="ASCII",a=this.position;"string"==typeof t&&/:/.test(t)&&(t=(r=t.split(":"))[0],o=parseInt(r[1]));"string"==typeof t&&/,/.test(t)&&(t=(r=t.split(","))[0],n=parseInt(r[1]));switch(t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,DataStream.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,DataStream.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,DataStream.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,DataStream.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,DataStream.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,DataStream.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,DataStream.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,DataStream.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,DataStream.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,DataStream.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,DataStream.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,DataStream.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,o);break;case"string":this.writeString(e,n,o);break;case"u16string":this.writeUCS2String(e,this.endianness,o);break;case"u16stringle":this.writeUCS2String(e,DataStream.LITTLE_ENDIAN,o);break;case"u16stringbe":this.writeUCS2String(e,DataStream.BIG_ENDIAN,o);break;default:if(3==t.length){for(var s=t[1],l=0;l<e.length;l++)this.writeType(s,e[l]);break}this.writeStruct(t,e)}null!=o&&(this.position=a,this._realloc(o),this.position=a+o)},"function"==typeof define&&define.amd&&define("DataStream",[],function(){return DataStream}),"object"==typeof module&&module&&module.exports&&(module.exports=DataStream),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.glMatrix={})}(this,function(t){var e=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array,r=Math.random;var o=Math.PI/180;var n=Object.freeze({EPSILON:e,get ARRAY_TYPE(){return i},RANDOM:r,setMatrixArrayType:function(t){i=t},toRadian:function(t){return t*o},equals:function(t,i){return Math.abs(t-i)<=e*Math.max(1,Math.abs(t),Math.abs(i))}});function a(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=i[0],l=i[1],h=i[2],d=i[3];return t[0]=r*s+n*l,t[1]=o*s+a*l,t[2]=r*h+n*d,t[3]=o*h+a*d,t}function s(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}var l=a,h=s,d=Object.freeze({create:function(){var t=new i(4);return i!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new i(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},fromValues:function(t,e,r,o){var n=new i(4);return n[0]=t,n[1]=e,n[2]=r,n[3]=o,n},set:function(t,e,i,r,o){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t},transpose:function(t,e){if(t===e){var i=e[1];t[1]=e[2],t[2]=i}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},invert:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=i*n-o*r;return a?(a=1/a,t[0]=n*a,t[1]=-r*a,t[2]=-o*a,t[3]=i*a,t):null},adjoint:function(t,e){var i=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=i,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:a,rotate:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=r*l+n*s,t[1]=o*l+a*s,t[2]=r*-s+n*l,t[3]=o*-s+a*l,t},scale:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=i[0],l=i[1];return t[0]=r*s,t[1]=o*s,t[2]=n*l,t[3]=a*l,t},fromRotation:function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=-i,t[3]=r,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},str:function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},LDU:function(t,e,i,r){return t[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-t[2]*i[1],[t,e,i]},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},subtract:s,exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},equals:function(t,i){var r=t[0],o=t[1],n=t[2],a=t[3],s=i[0],l=i[1],h=i[2],d=i[3];return Math.abs(r-s)<=e*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-l)<=e*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-d)<=e*Math.max(1,Math.abs(a),Math.abs(d))},multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t},multiplyScalarAndAdd:function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t},mul:l,sub:h});function c(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=i[0],d=i[1],c=i[2],u=i[3],f=i[4],g=i[5];return t[0]=r*h+n*d,t[1]=o*h+a*d,t[2]=r*c+n*u,t[3]=o*c+a*u,t[4]=r*f+n*g+s,t[5]=o*f+a*g+l,t}function u(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t}var f=c,g=u,p=Object.freeze({create:function(){var t=new i(6);return i!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},clone:function(t){var e=new i(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},fromValues:function(t,e,r,o,n,a){var s=new i(6);return s[0]=t,s[1]=e,s[2]=r,s[3]=o,s[4]=n,s[5]=a,s},set:function(t,e,i,r,o,n,a){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t[4]=n,t[5]=a,t},invert:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=i*n-r*o;return l?(l=1/l,t[0]=n*l,t[1]=-r*l,t[2]=-o*l,t[3]=i*l,t[4]=(o*s-n*a)*l,t[5]=(r*a-i*s)*l,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:c,rotate:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=Math.sin(i),d=Math.cos(i);return t[0]=r*d+n*h,t[1]=o*d+a*h,t[2]=r*-h+n*d,t[3]=o*-h+a*d,t[4]=s,t[5]=l,t},scale:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=i[0],d=i[1];return t[0]=r*h,t[1]=o*h,t[2]=n*d,t[3]=a*d,t[4]=s,t[5]=l,t},translate:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=i[0],d=i[1];return t[0]=r,t[1]=o,t[2]=n,t[3]=a,t[4]=r*h+n*d+s,t[5]=o*h+a*d+l,t},fromRotation:function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=-i,t[3]=r,t[4]=0,t[5]=0,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},str:function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t},subtract:u,multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t},multiplyScalarAndAdd:function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},equals:function(t,i){var r=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=i[0],d=i[1],c=i[2],u=i[3],f=i[4],g=i[5];return Math.abs(r-h)<=e*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(o-d)<=e*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(n-c)<=e*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-u)<=e*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(s-f)<=e*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-g)<=e*Math.max(1,Math.abs(l),Math.abs(g))},mul:f,sub:g});function v(){var t=new i(9);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function y(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=e[8],u=i[0],f=i[1],g=i[2],p=i[3],v=i[4],y=i[5],m=i[6],x=i[7],b=i[8];return t[0]=u*r+f*a+g*h,t[1]=u*o+f*s+g*d,t[2]=u*n+f*l+g*c,t[3]=p*r+v*a+y*h,t[4]=p*o+v*s+y*d,t[5]=p*n+v*l+y*c,t[6]=m*r+x*a+b*h,t[7]=m*o+x*s+b*d,t[8]=m*n+x*l+b*c,t}function m(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t}var x=y,b=m,C=Object.freeze({create:v,fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new i(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromValues:function(t,e,r,o,n,a,s,l,h){var d=new i(9);return d[0]=t,d[1]=e,d[2]=r,d[3]=o,d[4]=n,d[5]=a,d[6]=s,d[7]=l,d[8]=h,d},set:function(t,e,i,r,o,n,a,s,l,h){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=h,t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){if(t===e){var i=e[1],r=e[2],o=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=r,t[7]=o}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},invert:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],d=e[8],c=d*a-s*h,u=-d*n+s*l,f=h*n-a*l,g=i*c+r*u+o*f;return g?(g=1/g,t[0]=c*g,t[1]=(-d*r+o*h)*g,t[2]=(s*r-o*a)*g,t[3]=u*g,t[4]=(d*i-o*l)*g,t[5]=(-s*i+o*n)*g,t[6]=f*g,t[7]=(-h*i+r*l)*g,t[8]=(a*i-r*n)*g,t):null},adjoint:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],d=e[8];return t[0]=a*d-s*h,t[1]=o*h-r*d,t[2]=r*s-o*a,t[3]=s*l-n*d,t[4]=i*d-o*l,t[5]=o*n-i*s,t[6]=n*h-a*l,t[7]=r*l-i*h,t[8]=i*a-r*n,t},determinant:function(t){var e=t[0],i=t[1],r=t[2],o=t[3],n=t[4],a=t[5],s=t[6],l=t[7],h=t[8];return e*(h*n-a*l)+i*(-h*o+a*s)+r*(l*o-n*s)},multiply:y,translate:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=e[8],u=i[0],f=i[1];return t[0]=r,t[1]=o,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=u*r+f*a+h,t[7]=u*o+f*s+d,t[8]=u*n+f*l+c,t},rotate:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=e[8],u=Math.sin(i),f=Math.cos(i);return t[0]=f*r+u*a,t[1]=f*o+u*s,t[2]=f*n+u*l,t[3]=f*a-u*r,t[4]=f*s-u*o,t[5]=f*l-u*n,t[6]=h,t[7]=d,t[8]=c,t},scale:function(t,e,i){var r=i[0],o=i[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=o*e[3],t[4]=o*e[4],t[5]=o*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},fromRotation:function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=0,t[3]=-i,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat2d:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},fromQuat:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=i+i,s=r+r,l=o+o,h=i*a,d=r*a,c=r*s,u=o*a,f=o*s,g=o*l,p=n*a,v=n*s,y=n*l;return t[0]=1-c-g,t[3]=d-y,t[6]=u+v,t[1]=d+y,t[4]=1-h-g,t[7]=f-p,t[2]=u-v,t[5]=f+p,t[8]=1-h-c,t},normalFromMat4:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],d=e[8],c=e[9],u=e[10],f=e[11],g=e[12],p=e[13],v=e[14],y=e[15],m=i*s-r*a,x=i*l-o*a,b=i*h-n*a,C=r*l-o*s,A=r*h-n*s,T=o*h-n*l,M=d*p-c*g,P=d*v-u*g,w=d*y-f*g,_=c*v-u*p,S=c*y-f*p,L=u*y-f*v,R=m*L-x*S+b*_+C*w-A*P+T*M;return R?(R=1/R,t[0]=(s*L-l*S+h*_)*R,t[1]=(l*w-a*L-h*P)*R,t[2]=(a*S-s*w+h*M)*R,t[3]=(o*S-r*L-n*_)*R,t[4]=(i*L-o*w+n*P)*R,t[5]=(r*w-i*S-n*M)*R,t[6]=(p*T-v*A+y*C)*R,t[7]=(v*b-g*T-y*x)*R,t[8]=(g*A-p*b+y*m)*R,t):null},projection:function(t,e,i){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/i,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},str:function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t},subtract:m,multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t},multiplyScalarAndAdd:function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t[6]=e[6]+i[6]*r,t[7]=e[7]+i[7]*r,t[8]=e[8]+i[8]*r,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},equals:function(t,i){var r=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],d=t[7],c=t[8],u=i[0],f=i[1],g=i[2],p=i[3],v=i[4],y=i[5],m=i[6],x=i[7],b=i[8];return Math.abs(r-u)<=e*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(o-f)<=e*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(n-g)<=e*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-p)<=e*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-v)<=e*Math.max(1,Math.abs(s),Math.abs(v))&&Math.abs(l-y)<=e*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(h-m)<=e*Math.max(1,Math.abs(h),Math.abs(m))&&Math.abs(d-x)<=e*Math.max(1,Math.abs(d),Math.abs(x))&&Math.abs(c-b)<=e*Math.max(1,Math.abs(c),Math.abs(b))},mul:x,sub:b});function A(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function T(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=e[8],u=e[9],f=e[10],g=e[11],p=e[12],v=e[13],y=e[14],m=e[15],x=i[0],b=i[1],C=i[2],A=i[3];return t[0]=x*r+b*s+C*c+A*p,t[1]=x*o+b*l+C*u+A*v,t[2]=x*n+b*h+C*f+A*y,t[3]=x*a+b*d+C*g+A*m,x=i[4],b=i[5],C=i[6],A=i[7],t[4]=x*r+b*s+C*c+A*p,t[5]=x*o+b*l+C*u+A*v,t[6]=x*n+b*h+C*f+A*y,t[7]=x*a+b*d+C*g+A*m,x=i[8],b=i[9],C=i[10],A=i[11],t[8]=x*r+b*s+C*c+A*p,t[9]=x*o+b*l+C*u+A*v,t[10]=x*n+b*h+C*f+A*y,t[11]=x*a+b*d+C*g+A*m,x=i[12],b=i[13],C=i[14],A=i[15],t[12]=x*r+b*s+C*c+A*p,t[13]=x*o+b*l+C*u+A*v,t[14]=x*n+b*h+C*f+A*y,t[15]=x*a+b*d+C*g+A*m,t}function M(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=r+r,l=o+o,h=n+n,d=r*s,c=r*l,u=r*h,f=o*l,g=o*h,p=n*h,v=a*s,y=a*l,m=a*h;return t[0]=1-(f+p),t[1]=c+m,t[2]=u-y,t[3]=0,t[4]=c-m,t[5]=1-(d+p),t[6]=g+v,t[7]=0,t[8]=u+y,t[9]=g-v,t[10]=1-(d+f),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function P(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function w(t,e){var i=e[0]+e[5]+e[10],r=0;return i>0?(r=2*Math.sqrt(i+1),t[3]=.25*r,t[0]=(e[6]-e[9])/r,t[1]=(e[8]-e[2])/r,t[2]=(e[1]-e[4])/r):e[0]>e[5]&&e[0]>e[10]?(r=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/r,t[0]=.25*r,t[1]=(e[1]+e[4])/r,t[2]=(e[8]+e[2])/r):e[5]>e[10]?(r=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/r,t[0]=(e[1]+e[4])/r,t[1]=.25*r,t[2]=(e[6]+e[9])/r):(r=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/r,t[0]=(e[8]+e[2])/r,t[1]=(e[6]+e[9])/r,t[2]=.25*r),t}function _(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t[9]=e[9]-i[9],t[10]=e[10]-i[10],t[11]=e[11]-i[11],t[12]=e[12]-i[12],t[13]=e[13]-i[13],t[14]=e[14]-i[14],t[15]=e[15]-i[15],t}var S=T,L=_,R=Object.freeze({create:function(){var t=new i(16);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},clone:function(t){var e=new i(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},fromValues:function(t,e,r,o,n,a,s,l,h,d,c,u,f,g,p,v){var y=new i(16);return y[0]=t,y[1]=e,y[2]=r,y[3]=o,y[4]=n,y[5]=a,y[6]=s,y[7]=l,y[8]=h,y[9]=d,y[10]=c,y[11]=u,y[12]=f,y[13]=g,y[14]=p,y[15]=v,y},set:function(t,e,i,r,o,n,a,s,l,h,d,c,u,f,g,p,v){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t[8]=h,t[9]=d,t[10]=c,t[11]=u,t[12]=f,t[13]=g,t[14]=p,t[15]=v,t},identity:A,transpose:function(t,e){if(t===e){var i=e[1],r=e[2],o=e[3],n=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=n,t[11]=e[14],t[12]=o,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],d=e[8],c=e[9],u=e[10],f=e[11],g=e[12],p=e[13],v=e[14],y=e[15],m=i*s-r*a,x=i*l-o*a,b=i*h-n*a,C=r*l-o*s,A=r*h-n*s,T=o*h-n*l,M=d*p-c*g,P=d*v-u*g,w=d*y-f*g,_=c*v-u*p,S=c*y-f*p,L=u*y-f*v,R=m*L-x*S+b*_+C*w-A*P+T*M;return R?(R=1/R,t[0]=(s*L-l*S+h*_)*R,t[1]=(o*S-r*L-n*_)*R,t[2]=(p*T-v*A+y*C)*R,t[3]=(u*A-c*T-f*C)*R,t[4]=(l*w-a*L-h*P)*R,t[5]=(i*L-o*w+n*P)*R,t[6]=(v*b-g*T-y*x)*R,t[7]=(d*T-u*b+f*x)*R,t[8]=(a*S-s*w+h*M)*R,t[9]=(r*w-i*S-n*M)*R,t[10]=(g*A-p*b+y*m)*R,t[11]=(c*b-d*A-f*m)*R,t[12]=(s*P-a*_-l*M)*R,t[13]=(i*_-r*P+o*M)*R,t[14]=(p*x-g*C-v*m)*R,t[15]=(d*C-c*x+u*m)*R,t):null},adjoint:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=e[4],s=e[5],l=e[6],h=e[7],d=e[8],c=e[9],u=e[10],f=e[11],g=e[12],p=e[13],v=e[14],y=e[15];return t[0]=s*(u*y-f*v)-c*(l*y-h*v)+p*(l*f-h*u),t[1]=-(r*(u*y-f*v)-c*(o*y-n*v)+p*(o*f-n*u)),t[2]=r*(l*y-h*v)-s*(o*y-n*v)+p*(o*h-n*l),t[3]=-(r*(l*f-h*u)-s*(o*f-n*u)+c*(o*h-n*l)),t[4]=-(a*(u*y-f*v)-d*(l*y-h*v)+g*(l*f-h*u)),t[5]=i*(u*y-f*v)-d*(o*y-n*v)+g*(o*f-n*u),t[6]=-(i*(l*y-h*v)-a*(o*y-n*v)+g*(o*h-n*l)),t[7]=i*(l*f-h*u)-a*(o*f-n*u)+d*(o*h-n*l),t[8]=a*(c*y-f*p)-d*(s*y-h*p)+g*(s*f-h*c),t[9]=-(i*(c*y-f*p)-d*(r*y-n*p)+g*(r*f-n*c)),t[10]=i*(s*y-h*p)-a*(r*y-n*p)+g*(r*h-n*s),t[11]=-(i*(s*f-h*c)-a*(r*f-n*c)+d*(r*h-n*s)),t[12]=-(a*(c*v-u*p)-d*(s*v-l*p)+g*(s*u-l*c)),t[13]=i*(c*v-u*p)-d*(r*v-o*p)+g*(r*u-o*c),t[14]=-(i*(s*v-l*p)-a*(r*v-o*p)+g*(r*l-o*s)),t[15]=i*(s*u-l*c)-a*(r*u-o*c)+d*(r*l-o*s),t},determinant:function(t){var e=t[0],i=t[1],r=t[2],o=t[3],n=t[4],a=t[5],s=t[6],l=t[7],h=t[8],d=t[9],c=t[10],u=t[11],f=t[12],g=t[13],p=t[14],v=t[15];return(e*a-i*n)*(c*v-u*p)-(e*s-r*n)*(d*v-u*g)+(e*l-o*n)*(d*p-c*g)+(i*s-r*a)*(h*v-u*f)-(i*l-o*a)*(h*p-c*f)+(r*l-o*s)*(h*g-d*f)},multiply:T,translate:function(t,e,i){var r,o,n,a,s,l,h,d,c,u,f,g,p=i[0],v=i[1],y=i[2];return e===t?(t[12]=e[0]*p+e[4]*v+e[8]*y+e[12],t[13]=e[1]*p+e[5]*v+e[9]*y+e[13],t[14]=e[2]*p+e[6]*v+e[10]*y+e[14],t[15]=e[3]*p+e[7]*v+e[11]*y+e[15]):(r=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=e[8],u=e[9],f=e[10],g=e[11],t[0]=r,t[1]=o,t[2]=n,t[3]=a,t[4]=s,t[5]=l,t[6]=h,t[7]=d,t[8]=c,t[9]=u,t[10]=f,t[11]=g,t[12]=r*p+s*v+c*y+e[12],t[13]=o*p+l*v+u*y+e[13],t[14]=n*p+h*v+f*y+e[14],t[15]=a*p+d*v+g*y+e[15]),t},scale:function(t,e,i){var r=i[0],o=i[1],n=i[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},rotate:function(t,i,r,o){var n,a,s,l,h,d,c,u,f,g,p,v,y,m,x,b,C,A,T,M,P,w,_,S,L=o[0],R=o[1],D=o[2],E=Math.sqrt(L*L+R*R+D*D);return E<e?null:(L*=E=1/E,R*=E,D*=E,n=Math.sin(r),s=1-(a=Math.cos(r)),l=i[0],h=i[1],d=i[2],c=i[3],u=i[4],f=i[5],g=i[6],p=i[7],v=i[8],y=i[9],m=i[10],x=i[11],b=L*L*s+a,C=R*L*s+D*n,A=D*L*s-R*n,T=L*R*s-D*n,M=R*R*s+a,P=D*R*s+L*n,w=L*D*s+R*n,_=R*D*s-L*n,S=D*D*s+a,t[0]=l*b+u*C+v*A,t[1]=h*b+f*C+y*A,t[2]=d*b+g*C+m*A,t[3]=c*b+p*C+x*A,t[4]=l*T+u*M+v*P,t[5]=h*T+f*M+y*P,t[6]=d*T+g*M+m*P,t[7]=c*T+p*M+x*P,t[8]=l*w+u*_+v*S,t[9]=h*w+f*_+y*S,t[10]=d*w+g*_+m*S,t[11]=c*w+p*_+x*S,i!==t&&(t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t)},rotateX:function(t,e,i){var r=Math.sin(i),o=Math.cos(i),n=e[4],a=e[5],s=e[6],l=e[7],h=e[8],d=e[9],c=e[10],u=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*o+h*r,t[5]=a*o+d*r,t[6]=s*o+c*r,t[7]=l*o+u*r,t[8]=h*o-n*r,t[9]=d*o-a*r,t[10]=c*o-s*r,t[11]=u*o-l*r,t},rotateY:function(t,e,i){var r=Math.sin(i),o=Math.cos(i),n=e[0],a=e[1],s=e[2],l=e[3],h=e[8],d=e[9],c=e[10],u=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*o-h*r,t[1]=a*o-d*r,t[2]=s*o-c*r,t[3]=l*o-u*r,t[8]=n*r+h*o,t[9]=a*r+d*o,t[10]=s*r+c*o,t[11]=l*r+u*o,t},rotateZ:function(t,e,i){var r=Math.sin(i),o=Math.cos(i),n=e[0],a=e[1],s=e[2],l=e[3],h=e[4],d=e[5],c=e[6],u=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*o+h*r,t[1]=a*o+d*r,t[2]=s*o+c*r,t[3]=l*o+u*r,t[4]=h*o-n*r,t[5]=d*o-a*r,t[6]=c*o-s*r,t[7]=u*o-l*r,t},fromTranslation:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},fromScaling:function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotation:function(t,i,r){var o,n,a,s=r[0],l=r[1],h=r[2],d=Math.sqrt(s*s+l*l+h*h);return d<e?null:(s*=d=1/d,l*=d,h*=d,o=Math.sin(i),a=1-(n=Math.cos(i)),t[0]=s*s*a+n,t[1]=l*s*a+h*o,t[2]=h*s*a-l*o,t[3]=0,t[4]=s*l*a-h*o,t[5]=l*l*a+n,t[6]=h*l*a+s*o,t[7]=0,t[8]=s*h*a+l*o,t[9]=l*h*a-s*o,t[10]=h*h*a+n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromXRotation:function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=i,t[7]=0,t[8]=0,t[9]=-i,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromYRotation:function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-i,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=i,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromZRotation:function(t,e){var i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=0,t[3]=0,t[4]=-i,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},fromRotationTranslation:M,fromQuat2:function(t,e){var r=new i(3),o=-e[0],n=-e[1],a=-e[2],s=e[3],l=e[4],h=e[5],d=e[6],c=e[7],u=o*o+n*n+a*a+s*s;return u>0?(r[0]=2*(l*s+c*o+h*a-d*n)/u,r[1]=2*(h*s+c*n+d*o-l*a)/u,r[2]=2*(d*s+c*a+l*n-h*o)/u):(r[0]=2*(l*s+c*o+h*a-d*n),r[1]=2*(h*s+c*n+d*o-l*a),r[2]=2*(d*s+c*a+l*n-h*o)),M(t,e,r),t},getTranslation:P,getScaling:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[4],a=e[5],s=e[6],l=e[8],h=e[9],d=e[10];return t[0]=Math.sqrt(i*i+r*r+o*o),t[1]=Math.sqrt(n*n+a*a+s*s),t[2]=Math.sqrt(l*l+h*h+d*d),t},getRotation:w,fromRotationTranslationScale:function(t,e,i,r){var o=e[0],n=e[1],a=e[2],s=e[3],l=o+o,h=n+n,d=a+a,c=o*l,u=o*h,f=o*d,g=n*h,p=n*d,v=a*d,y=s*l,m=s*h,x=s*d,b=r[0],C=r[1],A=r[2];return t[0]=(1-(g+v))*b,t[1]=(u+x)*b,t[2]=(f-m)*b,t[3]=0,t[4]=(u-x)*C,t[5]=(1-(c+v))*C,t[6]=(p+y)*C,t[7]=0,t[8]=(f+m)*A,t[9]=(p-y)*A,t[10]=(1-(c+g))*A,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t},fromRotationTranslationScaleOrigin:function(t,e,i,r,o){var n=e[0],a=e[1],s=e[2],l=e[3],h=n+n,d=a+a,c=s+s,u=n*h,f=n*d,g=n*c,p=a*d,v=a*c,y=s*c,m=l*h,x=l*d,b=l*c,C=r[0],A=r[1],T=r[2],M=o[0],P=o[1],w=o[2],_=(1-(p+y))*C,S=(f+b)*C,L=(g-x)*C,R=(f-b)*A,D=(1-(u+y))*A,E=(v+m)*A,I=(g+x)*T,O=(v-m)*T,F=(1-(u+p))*T;return t[0]=_,t[1]=S,t[2]=L,t[3]=0,t[4]=R,t[5]=D,t[6]=E,t[7]=0,t[8]=I,t[9]=O,t[10]=F,t[11]=0,t[12]=i[0]+M-(_*M+R*P+I*w),t[13]=i[1]+P-(S*M+D*P+O*w),t[14]=i[2]+w-(L*M+E*P+F*w),t[15]=1,t},fromQuat:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=i+i,s=r+r,l=o+o,h=i*a,d=r*a,c=r*s,u=o*a,f=o*s,g=o*l,p=n*a,v=n*s,y=n*l;return t[0]=1-c-g,t[1]=d+y,t[2]=u-v,t[3]=0,t[4]=d-y,t[5]=1-h-g,t[6]=f+p,t[7]=0,t[8]=u+v,t[9]=f-p,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},frustum:function(t,e,i,r,o,n,a){var s=1/(i-e),l=1/(o-r),h=1/(n-a);return t[0]=2*n*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(i+e)*s,t[9]=(o+r)*l,t[10]=(a+n)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*n*2*h,t[15]=0,t},perspective:function(t,e,i,r,o){var n,a=1/Math.tan(e/2);return t[0]=a/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(n=1/(r-o),t[10]=(o+r)*n,t[14]=2*o*r*n):(t[10]=-1,t[14]=-2*r),t},perspectiveFromFieldOfView:function(t,e,i,r){var o=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),s=Math.tan(e.rightDegrees*Math.PI/180),l=2/(a+s),h=2/(o+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(a-s)*l*.5,t[9]=(o-n)*h*.5,t[10]=r/(i-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*i/(i-r),t[15]=0,t},ortho:function(t,e,i,r,o,n,a){var s=1/(e-i),l=1/(r-o),h=1/(n-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+i)*s,t[13]=(o+r)*l,t[14]=(a+n)*h,t[15]=1,t},lookAt:function(t,i,r,o){var n,a,s,l,h,d,c,u,f,g,p=i[0],v=i[1],y=i[2],m=o[0],x=o[1],b=o[2],C=r[0],T=r[1],M=r[2];return Math.abs(p-C)<e&&Math.abs(v-T)<e&&Math.abs(y-M)<e?A(t):(c=p-C,u=v-T,f=y-M,n=x*(f*=g=1/Math.sqrt(c*c+u*u+f*f))-b*(u*=g),a=b*(c*=g)-m*f,s=m*u-x*c,(g=Math.sqrt(n*n+a*a+s*s))?(n*=g=1/g,a*=g,s*=g):(n=0,a=0,s=0),l=u*s-f*a,h=f*n-c*s,d=c*a-u*n,(g=Math.sqrt(l*l+h*h+d*d))?(l*=g=1/g,h*=g,d*=g):(l=0,h=0,d=0),t[0]=n,t[1]=l,t[2]=c,t[3]=0,t[4]=a,t[5]=h,t[6]=u,t[7]=0,t[8]=s,t[9]=d,t[10]=f,t[11]=0,t[12]=-(n*p+a*v+s*y),t[13]=-(l*p+h*v+d*y),t[14]=-(c*p+u*v+f*y),t[15]=1,t)},targetTo:function(t,e,i,r){var o=e[0],n=e[1],a=e[2],s=r[0],l=r[1],h=r[2],d=o-i[0],c=n-i[1],u=a-i[2],f=d*d+c*c+u*u;f>0&&(d*=f=1/Math.sqrt(f),c*=f,u*=f);var g=l*u-h*c,p=h*d-s*u,v=s*c-l*d;return(f=g*g+p*p+v*v)>0&&(g*=f=1/Math.sqrt(f),p*=f,v*=f),t[0]=g,t[1]=p,t[2]=v,t[3]=0,t[4]=c*v-u*p,t[5]=u*g-d*v,t[6]=d*p-c*g,t[7]=0,t[8]=d,t[9]=c,t[10]=u,t[11]=0,t[12]=o,t[13]=n,t[14]=a,t[15]=1,t},str:function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},frob:function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t[9]=e[9]+i[9],t[10]=e[10]+i[10],t[11]=e[11]+i[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]+i[15],t},subtract:_,multiplyScalar:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12]*i,t[13]=e[13]*i,t[14]=e[14]*i,t[15]=e[15]*i,t},multiplyScalarAndAdd:function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t[4]=e[4]+i[4]*r,t[5]=e[5]+i[5]*r,t[6]=e[6]+i[6]*r,t[7]=e[7]+i[7]*r,t[8]=e[8]+i[8]*r,t[9]=e[9]+i[9]*r,t[10]=e[10]+i[10]*r,t[11]=e[11]+i[11]*r,t[12]=e[12]+i[12]*r,t[13]=e[13]+i[13]*r,t[14]=e[14]+i[14]*r,t[15]=e[15]+i[15]*r,t},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},equals:function(t,i){var r=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],d=t[7],c=t[8],u=t[9],f=t[10],g=t[11],p=t[12],v=t[13],y=t[14],m=t[15],x=i[0],b=i[1],C=i[2],A=i[3],T=i[4],M=i[5],P=i[6],w=i[7],_=i[8],S=i[9],L=i[10],R=i[11],D=i[12],E=i[13],I=i[14],O=i[15];return Math.abs(r-x)<=e*Math.max(1,Math.abs(r),Math.abs(x))&&Math.abs(o-b)<=e*Math.max(1,Math.abs(o),Math.abs(b))&&Math.abs(n-C)<=e*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(a-A)<=e*Math.max(1,Math.abs(a),Math.abs(A))&&Math.abs(s-T)<=e*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(l-M)<=e*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(h-P)<=e*Math.max(1,Math.abs(h),Math.abs(P))&&Math.abs(d-w)<=e*Math.max(1,Math.abs(d),Math.abs(w))&&Math.abs(c-_)<=e*Math.max(1,Math.abs(c),Math.abs(_))&&Math.abs(u-S)<=e*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(f-L)<=e*Math.max(1,Math.abs(f),Math.abs(L))&&Math.abs(g-R)<=e*Math.max(1,Math.abs(g),Math.abs(R))&&Math.abs(p-D)<=e*Math.max(1,Math.abs(p),Math.abs(D))&&Math.abs(v-E)<=e*Math.max(1,Math.abs(v),Math.abs(E))&&Math.abs(y-I)<=e*Math.max(1,Math.abs(y),Math.abs(I))&&Math.abs(m-O)<=e*Math.max(1,Math.abs(m),Math.abs(O))},mul:S,sub:L});function D(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function E(t){var e=t[0],i=t[1],r=t[2];return Math.sqrt(e*e+i*i+r*r)}function I(t,e,r){var o=new i(3);return o[0]=t,o[1]=e,o[2]=r,o}function O(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function F(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t}function N(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t}function B(t,e){var i=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(i*i+r*r+o*o)}function V(t,e){var i=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2];return i*i+r*r+o*o}function j(t){var e=t[0],i=t[1],r=t[2];return e*e+i*i+r*r}function U(t,e){var i=e[0],r=e[1],o=e[2],n=i*i+r*r+o*o;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function k(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function G(t,e,i){var r=e[0],o=e[1],n=e[2],a=i[0],s=i[1],l=i[2];return t[0]=o*l-n*s,t[1]=n*a-r*l,t[2]=r*s-o*a,t}var z,H=O,W=F,X=N,Y=B,K=V,q=E,Z=j,Q=(z=D(),function(t,e,i,r,o,n){var a,s;for(e||(e=3),i||(i=0),s=r?Math.min(r*e+i,t.length):t.length,a=i;a<s;a+=e)z[0]=t[a],z[1]=t[a+1],z[2]=t[a+2],o(z,z,n),t[a]=z[0],t[a+1]=z[1],t[a+2]=z[2];return t}),J=Object.freeze({create:D,clone:function(t){var e=new i(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},length:E,fromValues:I,copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},set:function(t,e,i,r){return t[0]=e,t[1]=i,t[2]=r,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t},subtract:O,multiply:F,divide:N,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},min:function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t},max:function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},scale:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t},scaleAndAdd:function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t},distance:B,squaredDistance:V,squaredLength:j,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},normalize:U,dot:k,cross:G,lerp:function(t,e,i,r){var o=e[0],n=e[1],a=e[2];return t[0]=o+r*(i[0]-o),t[1]=n+r*(i[1]-n),t[2]=a+r*(i[2]-a),t},hermite:function(t,e,i,r,o,n){var a=n*n,s=a*(2*n-3)+1,l=a*(n-2)+n,h=a*(n-1),d=a*(3-2*n);return t[0]=e[0]*s+i[0]*l+r[0]*h+o[0]*d,t[1]=e[1]*s+i[1]*l+r[1]*h+o[1]*d,t[2]=e[2]*s+i[2]*l+r[2]*h+o[2]*d,t},bezier:function(t,e,i,r,o,n){var a=1-n,s=a*a,l=n*n,h=s*a,d=3*n*s,c=3*l*a,u=l*n;return t[0]=e[0]*h+i[0]*d+r[0]*c+o[0]*u,t[1]=e[1]*h+i[1]*d+r[1]*c+o[1]*u,t[2]=e[2]*h+i[2]*d+r[2]*c+o[2]*u,t},random:function(t,e){e=e||1;var i=2*r()*Math.PI,o=2*r()-1,n=Math.sqrt(1-o*o)*e;return t[0]=Math.cos(i)*n,t[1]=Math.sin(i)*n,t[2]=o*e,t},transformMat4:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=i[3]*r+i[7]*o+i[11]*n+i[15];return a=a||1,t[0]=(i[0]*r+i[4]*o+i[8]*n+i[12])/a,t[1]=(i[1]*r+i[5]*o+i[9]*n+i[13])/a,t[2]=(i[2]*r+i[6]*o+i[10]*n+i[14])/a,t},transformMat3:function(t,e,i){var r=e[0],o=e[1],n=e[2];return t[0]=r*i[0]+o*i[3]+n*i[6],t[1]=r*i[1]+o*i[4]+n*i[7],t[2]=r*i[2]+o*i[5]+n*i[8],t},transformQuat:function(t,e,i){var r=i[0],o=i[1],n=i[2],a=i[3],s=e[0],l=e[1],h=e[2],d=o*h-n*l,c=n*s-r*h,u=r*l-o*s,f=o*u-n*c,g=n*d-r*u,p=r*c-o*d,v=2*a;return d*=v,c*=v,u*=v,f*=2,g*=2,p*=2,t[0]=s+d+f,t[1]=l+c+g,t[2]=h+u+p,t},rotateX:function(t,e,i,r){var o=[],n=[];return o[0]=e[0]-i[0],o[1]=e[1]-i[1],o[2]=e[2]-i[2],n[0]=o[0],n[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),n[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},rotateY:function(t,e,i,r){var o=[],n=[];return o[0]=e[0]-i[0],o[1]=e[1]-i[1],o[2]=e[2]-i[2],n[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),n[1]=o[1],n[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},rotateZ:function(t,e,i,r){var o=[],n=[];return o[0]=e[0]-i[0],o[1]=e[1]-i[1],o[2]=e[2]-i[2],n[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),n[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),n[2]=o[2],t[0]=n[0]+i[0],t[1]=n[1]+i[1],t[2]=n[2]+i[2],t},angle:function(t,e){var i=I(t[0],t[1],t[2]),r=I(e[0],e[1],e[2]);U(i,i),U(r,r);var o=k(i,r);return o>1?0:o<-1?Math.PI:Math.acos(o)},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t},str:function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},equals:function(t,i){var r=t[0],o=t[1],n=t[2],a=i[0],s=i[1],l=i[2];return Math.abs(r-a)<=e*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(o-s)<=e*Math.max(1,Math.abs(o),Math.abs(s))&&Math.abs(n-l)<=e*Math.max(1,Math.abs(n),Math.abs(l))},sub:H,mul:W,div:X,dist:Y,sqrDist:K,len:q,sqrLen:Z,forEach:Q});function $(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function tt(t){var e=new i(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function et(t,e,r,o){var n=new i(4);return n[0]=t,n[1]=e,n[2]=r,n[3]=o,n}function it(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function rt(t,e,i,r,o){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t}function ot(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t}function nt(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}function at(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t}function st(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t[3]=e[3]/i[3],t}function lt(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function ht(t,e){var i=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(i*i+r*r+o*o+n*n)}function dt(t,e){var i=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2],n=e[3]-t[3];return i*i+r*r+o*o+n*n}function ct(t){var e=t[0],i=t[1],r=t[2],o=t[3];return Math.sqrt(e*e+i*i+r*r+o*o)}function ut(t){var e=t[0],i=t[1],r=t[2],o=t[3];return e*e+i*i+r*r+o*o}function ft(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=i*i+r*r+o*o+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=i*a,t[1]=r*a,t[2]=o*a,t[3]=n*a,t}function gt(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function pt(t,e,i,r){var o=e[0],n=e[1],a=e[2],s=e[3];return t[0]=o+r*(i[0]-o),t[1]=n+r*(i[1]-n),t[2]=a+r*(i[2]-a),t[3]=s+r*(i[3]-s),t}function vt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function yt(t,i){var r=t[0],o=t[1],n=t[2],a=t[3],s=i[0],l=i[1],h=i[2],d=i[3];return Math.abs(r-s)<=e*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-l)<=e*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(a-d)<=e*Math.max(1,Math.abs(a),Math.abs(d))}var mt=nt,xt=at,bt=st,Ct=ht,At=dt,Tt=ct,Mt=ut,Pt=function(){var t=$();return function(e,i,r,o,n,a){var s,l;for(i||(i=4),r||(r=0),l=o?Math.min(o*i+r,e.length):e.length,s=r;s<l;s+=i)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],n(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}(),wt=Object.freeze({create:$,clone:tt,fromValues:et,copy:it,set:rt,add:ot,subtract:nt,multiply:at,divide:st,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},min:function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t[3]=Math.min(e[3],i[3]),t},max:function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t[3]=Math.max(e[3],i[3]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},scale:lt,scaleAndAdd:function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t[2]=e[2]+i[2]*r,t[3]=e[3]+i[3]*r,t},distance:ht,squaredDistance:dt,length:ct,squaredLength:ut,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},normalize:ft,dot:gt,cross:function(t,e,i,r){var o=i[0]*r[1]-i[1]*r[0],n=i[0]*r[2]-i[2]*r[0],a=i[0]*r[3]-i[3]*r[0],s=i[1]*r[2]-i[2]*r[1],l=i[1]*r[3]-i[3]*r[1],h=i[2]*r[3]-i[3]*r[2],d=e[0],c=e[1],u=e[2],f=e[3];return t[0]=c*h-u*l+f*s,t[1]=-d*h+u*a-f*n,t[2]=d*l-c*a+f*o,t[3]=-d*s+c*n-u*o,t},lerp:pt,random:function(t,e){var i,o,n,a,s,l;e=e||1;do{s=(i=2*r()-1)*i+(o=2*r()-1)*o}while(s>=1);do{l=(n=2*r()-1)*n+(a=2*r()-1)*a}while(l>=1);var h=Math.sqrt((1-s)/l);return t[0]=e*i,t[1]=e*o,t[2]=e*n*h,t[3]=e*a*h,t},transformMat4:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3];return t[0]=i[0]*r+i[4]*o+i[8]*n+i[12]*a,t[1]=i[1]*r+i[5]*o+i[9]*n+i[13]*a,t[2]=i[2]*r+i[6]*o+i[10]*n+i[14]*a,t[3]=i[3]*r+i[7]*o+i[11]*n+i[15]*a,t},transformQuat:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=i[0],s=i[1],l=i[2],h=i[3],d=h*r+s*n-l*o,c=h*o+l*r-a*n,u=h*n+a*o-s*r,f=-a*r-s*o-l*n;return t[0]=d*h+f*-a+c*-l-u*-s,t[1]=c*h+f*-s+u*-a-d*-l,t[2]=u*h+f*-l+d*-s-c*-a,t[3]=e[3],t},zero:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},str:function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},exactEquals:vt,equals:yt,sub:mt,mul:xt,div:bt,dist:Ct,sqrDist:At,len:Tt,sqrLen:Mt,forEach:Pt});function _t(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function St(t,e,i){i*=.5;var r=Math.sin(i);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(i),t}function Lt(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=i[0],l=i[1],h=i[2],d=i[3];return t[0]=r*d+a*s+o*h-n*l,t[1]=o*d+a*l+n*s-r*h,t[2]=n*d+a*h+r*l-o*s,t[3]=a*d-r*s-o*l-n*h,t}function Rt(t,e,i){i*=.5;var r=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=r*l+a*s,t[1]=o*l+n*s,t[2]=n*l-o*s,t[3]=a*l-r*s,t}function Dt(t,e,i){i*=.5;var r=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=r*l-n*s,t[1]=o*l+a*s,t[2]=n*l+r*s,t[3]=a*l-o*s,t}function Et(t,e,i){i*=.5;var r=e[0],o=e[1],n=e[2],a=e[3],s=Math.sin(i),l=Math.cos(i);return t[0]=r*l+o*s,t[1]=o*l-r*s,t[2]=n*l+a*s,t[3]=a*l-n*s,t}function It(t,i,r,o){var n,a,s,l,h,d=i[0],c=i[1],u=i[2],f=i[3],g=r[0],p=r[1],v=r[2],y=r[3];return(a=d*g+c*p+u*v+f*y)<0&&(a=-a,g=-g,p=-p,v=-v,y=-y),1-a>e?(n=Math.acos(a),s=Math.sin(n),l=Math.sin((1-o)*n)/s,h=Math.sin(o*n)/s):(l=1-o,h=o),t[0]=l*d+h*g,t[1]=l*c+h*p,t[2]=l*u+h*v,t[3]=l*f+h*y,t}function Ot(t,e){var i,r=e[0]+e[4]+e[8];if(r>0)i=Math.sqrt(r+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var o=0;e[4]>e[0]&&(o=1),e[8]>e[3*o+o]&&(o=2);var n=(o+1)%3,a=(o+2)%3;i=Math.sqrt(e[3*o+o]-e[3*n+n]-e[3*a+a]+1),t[o]=.5*i,i=.5/i,t[3]=(e[3*n+a]-e[3*a+n])*i,t[n]=(e[3*n+o]+e[3*o+n])*i,t[a]=(e[3*a+o]+e[3*o+a])*i}return t}var Ft,Nt,Bt,Vt,jt,Ut,kt=tt,Gt=et,zt=it,Ht=rt,Wt=ot,Xt=Lt,Yt=lt,Kt=gt,qt=pt,Zt=ct,Qt=Zt,Jt=ut,$t=Jt,te=ft,ee=vt,ie=yt,re=(Ft=D(),Nt=I(1,0,0),Bt=I(0,1,0),function(t,e,i){var r=k(e,i);return r<-.999999?(G(Ft,Nt,e),q(Ft)<1e-6&&G(Ft,Bt,e),U(Ft,Ft),St(t,Ft,Math.PI),t):r>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(G(Ft,e,i),t[0]=Ft[0],t[1]=Ft[1],t[2]=Ft[2],t[3]=1+r,te(t,t))}),oe=(Vt=_t(),jt=_t(),function(t,e,i,r,o,n){return It(Vt,e,o,n),It(jt,i,r,n),It(t,Vt,jt,2*n*(1-n)),t}),ne=(Ut=v(),function(t,e,i,r){return Ut[0]=i[0],Ut[3]=i[1],Ut[6]=i[2],Ut[1]=r[0],Ut[4]=r[1],Ut[7]=r[2],Ut[2]=-e[0],Ut[5]=-e[1],Ut[8]=-e[2],te(t,Ot(t,Ut))}),ae=Object.freeze({create:_t,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},setAxisAngle:St,getAxisAngle:function(t,i){var r=2*Math.acos(i[3]),o=Math.sin(r/2);return o>e?(t[0]=i[0]/o,t[1]=i[1]/o,t[2]=i[2]/o):(t[0]=1,t[1]=0,t[2]=0),r},multiply:Lt,rotateX:Rt,rotateY:Dt,rotateZ:Et,calculateW:function(t,e){var i=e[0],r=e[1],o=e[2];return t[0]=i,t[1]=r,t[2]=o,t[3]=Math.sqrt(Math.abs(1-i*i-r*r-o*o)),t},slerp:It,random:function(t){var e=r(),i=r(),o=r(),n=Math.sqrt(1-e),a=Math.sqrt(e);return t[0]=n*Math.sin(2*Math.PI*i),t[1]=n*Math.cos(2*Math.PI*i),t[2]=a*Math.sin(2*Math.PI*o),t[3]=a*Math.cos(2*Math.PI*o),t},invert:function(t,e){var i=e[0],r=e[1],o=e[2],n=e[3],a=i*i+r*r+o*o+n*n,s=a?1/a:0;return t[0]=-i*s,t[1]=-r*s,t[2]=-o*s,t[3]=n*s,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},fromMat3:Ot,fromEuler:function(t,e,i,r){var o=.5*Math.PI/180;e*=o,i*=o,r*=o;var n=Math.sin(e),a=Math.cos(e),s=Math.sin(i),l=Math.cos(i),h=Math.sin(r),d=Math.cos(r);return t[0]=n*l*d-a*s*h,t[1]=a*s*d+n*l*h,t[2]=a*l*h-n*s*d,t[3]=a*l*d+n*s*h,t},str:function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},clone:kt,fromValues:Gt,copy:zt,set:Ht,add:Wt,mul:Xt,scale:Yt,dot:Kt,lerp:qt,length:Zt,len:Qt,squaredLength:Jt,sqrLen:$t,normalize:te,exactEquals:ee,equals:ie,rotationTo:re,sqlerp:oe,setAxes:ne});function se(t,e,i){var r=.5*i[0],o=.5*i[1],n=.5*i[2],a=e[0],s=e[1],l=e[2],h=e[3];return t[0]=a,t[1]=s,t[2]=l,t[3]=h,t[4]=r*h+o*l-n*s,t[5]=o*h+n*a-r*l,t[6]=n*h+r*s-o*a,t[7]=-r*a-o*s-n*l,t}function le(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}var he=zt;var de=zt;function ce(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=i[4],l=i[5],h=i[6],d=i[7],c=e[4],u=e[5],f=e[6],g=e[7],p=i[0],v=i[1],y=i[2],m=i[3];return t[0]=r*m+a*p+o*y-n*v,t[1]=o*m+a*v+n*p-r*y,t[2]=n*m+a*y+r*v-o*p,t[3]=a*m-r*p-o*v-n*y,t[4]=r*d+a*s+o*h-n*l+c*m+g*p+u*y-f*v,t[5]=o*d+a*l+n*s-r*h+u*m+g*v+f*p-c*y,t[6]=n*d+a*h+r*l-o*s+f*m+g*y+c*v-u*p,t[7]=a*d-r*s-o*l-n*h+g*m-c*p-u*v-f*y,t}var ue=ce;var fe=Kt;var ge=Zt,pe=ge,ve=Jt,ye=ve;var me=Object.freeze({create:function(){var t=new i(8);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},clone:function(t){var e=new i(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},fromValues:function(t,e,r,o,n,a,s,l){var h=new i(8);return h[0]=t,h[1]=e,h[2]=r,h[3]=o,h[4]=n,h[5]=a,h[6]=s,h[7]=l,h},fromRotationTranslationValues:function(t,e,r,o,n,a,s){var l=new i(8);l[0]=t,l[1]=e,l[2]=r,l[3]=o;var h=.5*n,d=.5*a,c=.5*s;return l[4]=h*o+d*r-c*e,l[5]=d*o+c*t-h*r,l[6]=c*o+h*e-d*t,l[7]=-h*t-d*e-c*r,l},fromRotationTranslation:se,fromTranslation:function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},fromRotation:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},fromMat4:function(t,e){var r=_t();w(r,e);var o=new i(3);return P(o,e),se(t,r,o),t},copy:le,identity:function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},set:function(t,e,i,r,o,n,a,s,l){return t[0]=e,t[1]=i,t[2]=r,t[3]=o,t[4]=n,t[5]=a,t[6]=s,t[7]=l,t},getReal:he,getDual:function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},setReal:de,setDual:function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},getTranslation:function(t,e){var i=e[4],r=e[5],o=e[6],n=e[7],a=-e[0],s=-e[1],l=-e[2],h=e[3];return t[0]=2*(i*h+n*a+r*l-o*s),t[1]=2*(r*h+n*s+o*a-i*l),t[2]=2*(o*h+n*l+i*s-r*a),t},translate:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=.5*i[0],l=.5*i[1],h=.5*i[2],d=e[4],c=e[5],u=e[6],f=e[7];return t[0]=r,t[1]=o,t[2]=n,t[3]=a,t[4]=a*s+o*h-n*l+d,t[5]=a*l+n*s-r*h+c,t[6]=a*h+r*l-o*s+u,t[7]=-r*s-o*l-n*h+f,t},rotateX:function(t,e,i){var r=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=s*a+d*r+l*n-h*o,u=l*a+d*o+h*r-s*n,f=h*a+d*n+s*o-l*r,g=d*a-s*r-l*o-h*n;return Rt(t,e,i),r=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*r+u*n-f*o,t[5]=u*a+g*o+f*r-c*n,t[6]=f*a+g*n+c*o-u*r,t[7]=g*a-c*r-u*o-f*n,t},rotateY:function(t,e,i){var r=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=s*a+d*r+l*n-h*o,u=l*a+d*o+h*r-s*n,f=h*a+d*n+s*o-l*r,g=d*a-s*r-l*o-h*n;return Dt(t,e,i),r=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*r+u*n-f*o,t[5]=u*a+g*o+f*r-c*n,t[6]=f*a+g*n+c*o-u*r,t[7]=g*a-c*r-u*o-f*n,t},rotateZ:function(t,e,i){var r=-e[0],o=-e[1],n=-e[2],a=e[3],s=e[4],l=e[5],h=e[6],d=e[7],c=s*a+d*r+l*n-h*o,u=l*a+d*o+h*r-s*n,f=h*a+d*n+s*o-l*r,g=d*a-s*r-l*o-h*n;return Et(t,e,i),r=t[0],o=t[1],n=t[2],a=t[3],t[4]=c*a+g*r+u*n-f*o,t[5]=u*a+g*o+f*r-c*n,t[6]=f*a+g*n+c*o-u*r,t[7]=g*a-c*r-u*o-f*n,t},rotateByQuatAppend:function(t,e,i){var r=i[0],o=i[1],n=i[2],a=i[3],s=e[0],l=e[1],h=e[2],d=e[3];return t[0]=s*a+d*r+l*n-h*o,t[1]=l*a+d*o+h*r-s*n,t[2]=h*a+d*n+s*o-l*r,t[3]=d*a-s*r-l*o-h*n,s=e[4],l=e[5],h=e[6],d=e[7],t[4]=s*a+d*r+l*n-h*o,t[5]=l*a+d*o+h*r-s*n,t[6]=h*a+d*n+s*o-l*r,t[7]=d*a-s*r-l*o-h*n,t},rotateByQuatPrepend:function(t,e,i){var r=e[0],o=e[1],n=e[2],a=e[3],s=i[0],l=i[1],h=i[2],d=i[3];return t[0]=r*d+a*s+o*h-n*l,t[1]=o*d+a*l+n*s-r*h,t[2]=n*d+a*h+r*l-o*s,t[3]=a*d-r*s-o*l-n*h,s=i[4],l=i[5],h=i[6],d=i[7],t[4]=r*d+a*s+o*h-n*l,t[5]=o*d+a*l+n*s-r*h,t[6]=n*d+a*h+r*l-o*s,t[7]=a*d-r*s-o*l-n*h,t},rotateAroundAxis:function(t,i,r,o){if(Math.abs(o)<e)return le(t,i);var n=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);o*=.5;var a=Math.sin(o),s=a*r[0]/n,l=a*r[1]/n,h=a*r[2]/n,d=Math.cos(o),c=i[0],u=i[1],f=i[2],g=i[3];t[0]=c*d+g*s+u*h-f*l,t[1]=u*d+g*l+f*s-c*h,t[2]=f*d+g*h+c*l-u*s,t[3]=g*d-c*s-u*l-f*h;var p=i[4],v=i[5],y=i[6],m=i[7];return t[4]=p*d+m*s+v*h-y*l,t[5]=v*d+m*l+y*s-p*h,t[6]=y*d+m*h+p*l-v*s,t[7]=m*d-p*s-v*l-y*h,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t},multiply:ce,mul:ue,scale:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t},dot:fe,lerp:function(t,e,i,r){var o=1-r;return fe(e,i)<0&&(r=-r),t[0]=e[0]*o+i[0]*r,t[1]=e[1]*o+i[1]*r,t[2]=e[2]*o+i[2]*r,t[3]=e[3]*o+i[3]*r,t[4]=e[4]*o+i[4]*r,t[5]=e[5]*o+i[5]*r,t[6]=e[6]*o+i[6]*r,t[7]=e[7]*o+i[7]*r,t},invert:function(t,e){var i=ve(e);return t[0]=-e[0]/i,t[1]=-e[1]/i,t[2]=-e[2]/i,t[3]=e[3]/i,t[4]=-e[4]/i,t[5]=-e[5]/i,t[6]=-e[6]/i,t[7]=e[7]/i,t},conjugate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},length:ge,len:pe,squaredLength:ve,sqrLen:ye,normalize:function(t,e){var i=ve(e);if(i>0){i=Math.sqrt(i);var r=e[0]/i,o=e[1]/i,n=e[2]/i,a=e[3]/i,s=e[4],l=e[5],h=e[6],d=e[7],c=r*s+o*l+n*h+a*d;t[0]=r,t[1]=o,t[2]=n,t[3]=a,t[4]=(s-r*c)/i,t[5]=(l-o*c)/i,t[6]=(h-n*c)/i,t[7]=(d-a*c)/i}return t},str:function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},equals:function(t,i){var r=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],h=t[6],d=t[7],c=i[0],u=i[1],f=i[2],g=i[3],p=i[4],v=i[5],y=i[6],m=i[7];return Math.abs(r-c)<=e*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(o-u)<=e*Math.max(1,Math.abs(o),Math.abs(u))&&Math.abs(n-f)<=e*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-g)<=e*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(s-p)<=e*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-v)<=e*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(h-y)<=e*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(d-m)<=e*Math.max(1,Math.abs(d),Math.abs(m))}});function xe(){var t=new i(2);return i!=Float32Array&&(t[0]=0,t[1]=0),t}function be(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t}function Ce(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t}function Ae(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t}function Te(t,e){var i=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(i*i+r*r)}function Me(t,e){var i=e[0]-t[0],r=e[1]-t[1];return i*i+r*r}function Pe(t){var e=t[0],i=t[1];return Math.sqrt(e*e+i*i)}function we(t){var e=t[0],i=t[1];return e*e+i*i}var _e=Pe,Se=be,Le=Ce,Re=Ae,De=Te,Ee=Me,Ie=we,Oe=function(){var t=xe();return function(e,i,r,o,n,a){var s,l;for(i||(i=2),r||(r=0),l=o?Math.min(o*i+r,e.length):e.length,s=r;s<l;s+=i)t[0]=e[s],t[1]=e[s+1],n(t,t,a),e[s]=t[0],e[s+1]=t[1];return e}}(),Fe=Object.freeze({create:xe,clone:function(t){var e=new i(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var r=new i(2);return r[0]=t,r[1]=e,r},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,i){return t[0]=e,t[1]=i,t},add:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t},subtract:be,multiply:Ce,divide:Ae,ceil:function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},floor:function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},min:function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t},max:function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t},round:function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},scale:function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t},scaleAndAdd:function(t,e,i,r){return t[0]=e[0]+i[0]*r,t[1]=e[1]+i[1]*r,t},distance:Te,squaredDistance:Me,length:Pe,squaredLength:we,negate:function(t,e){return t[0]=-e[0],t[1]=-e[1],t},inverse:function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},normalize:function(t,e){var i=e[0],r=e[1],o=i*i+r*r;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]},cross:function(t,e,i){var r=e[0]*i[1]-e[1]*i[0];return t[0]=t[1]=0,t[2]=r,t},lerp:function(t,e,i,r){var o=e[0],n=e[1];return t[0]=o+r*(i[0]-o),t[1]=n+r*(i[1]-n),t},random:function(t,e){e=e||1;var i=2*r()*Math.PI;return t[0]=Math.cos(i)*e,t[1]=Math.sin(i)*e,t},transformMat2:function(t,e,i){var r=e[0],o=e[1];return t[0]=i[0]*r+i[2]*o,t[1]=i[1]*r+i[3]*o,t},transformMat2d:function(t,e,i){var r=e[0],o=e[1];return t[0]=i[0]*r+i[2]*o+i[4],t[1]=i[1]*r+i[3]*o+i[5],t},transformMat3:function(t,e,i){var r=e[0],o=e[1];return t[0]=i[0]*r+i[3]*o+i[6],t[1]=i[1]*r+i[4]*o+i[7],t},transformMat4:function(t,e,i){var r=e[0],o=e[1];return t[0]=i[0]*r+i[4]*o+i[12],t[1]=i[1]*r+i[5]*o+i[13],t},rotate:function(t,e,i,r){var o=e[0]-i[0],n=e[1]-i[1],a=Math.sin(r),s=Math.cos(r);return t[0]=o*s-n*a+i[0],t[1]=o*a+n*s+i[1],t},angle:function(t,e){var i=t[0],r=t[1],o=e[0],n=e[1],a=i*i+r*r;a>0&&(a=1/Math.sqrt(a));var s=o*o+n*n;s>0&&(s=1/Math.sqrt(s));var l=(i*o+r*n)*a*s;return l>1?0:l<-1?Math.PI:Math.acos(l)},zero:function(t){return t[0]=0,t[1]=0,t},str:function(t){return"vec2("+t[0]+", "+t[1]+")"},exactEquals:function(t,e){return t[0]===e[0]&&t[1]===e[1]},equals:function(t,i){var r=t[0],o=t[1],n=i[0],a=i[1];return Math.abs(r-n)<=e*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(o-a)<=e*Math.max(1,Math.abs(o),Math.abs(a))},len:_e,sub:Se,mul:Le,div:Re,dist:De,sqrDist:Ee,sqrLen:Ie,forEach:Oe});t.glMatrix=n,t.mat2=d,t.mat2d=p,t.mat3=C,t.mat4=R,t.quat=ae,t.quat2=me,t.vec2=Fe,t.vec3=J,t.vec4=wt,Object.defineProperty(t,"__esModule",{value:!0})}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).i18next=e()}(this,function(){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function r(t,e,r){return e&&i(t.prototype,e),r&&i(t,r),t}function o(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function n(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),r.forEach(function(e){o(t,e,i[e])})}return t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&l(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function l(t,e){return(l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function h(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function d(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?h(t):e}function c(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],r=!0,o=!1,n=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(i.push(a.value),!e||i.length!==e);r=!0);}catch(t){o=!0,n=t}finally{try{r||null==s.return||s.return()}finally{if(o)throw n}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function u(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var f={type:"logger",log:function(t){this.output("log",t)},warn:function(t){this.output("warn",t)},error:function(t){this.output("error",t)},output:function(t,e){var i;console&&console[t]&&(i=console)[t].apply(i,u(e))}},g=new(function(){function t(i){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this.init(i,r)}return r(t,[{key:"init",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.prefix=e.prefix||"i18next:",this.logger=t||f,this.options=e,this.debug=e.debug}},{key:"setDebug",value:function(t){this.debug=t}},{key:"log",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"log","",!0)}},{key:"warn",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"warn","",!0)}},{key:"error",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"error","")}},{key:"deprecate",value:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.forward(e,"warn","WARNING DEPRECATED: ",!0)}},{key:"forward",value:function(t,e,i,r){return r&&!this.debug?null:("string"==typeof t[0]&&(t[0]="".concat(i).concat(this.prefix," ").concat(t[0])),this.logger[e](t))}},{key:"create",value:function(e){return new t(this.logger,n({},{prefix:"".concat(this.prefix,":").concat(e,":")},this.options))}}]),t}()),p=function(){function t(){e(this,t),this.observers={}}return r(t,[{key:"on",value:function(t,e){var i=this;return t.split(" ").forEach(function(t){i.observers[t]=i.observers[t]||[],i.observers[t].push(e)}),this}},{key:"off",value:function(t,e){var i=this;this.observers[t]&&this.observers[t].forEach(function(){if(e){var r=i.observers[t].indexOf(e);r>-1&&i.observers[t].splice(r,1)}else delete i.observers[t]})}},{key:"emit",value:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];this.observers[t]&&[].concat(this.observers[t]).forEach(function(t){t.apply(void 0,i)});this.observers["*"]&&[].concat(this.observers["*"]).forEach(function(e){e.apply(e,[t].concat(i))})}}]),t}();function v(){var t,e,i=new Promise(function(i,r){t=i,e=r});return i.resolve=t,i.reject=e,i}function y(t){return null==t?"":""+t}function m(t,e,i){function r(t){return t&&t.indexOf("###")>-1?t.replace(/###/g,"."):t}function o(){return!t||"string"==typeof t}for(var n="string"!=typeof e?[].concat(e):e.split(".");n.length>1;){if(o())return{};var a=r(n.shift());!t[a]&&i&&(t[a]=new i),t=t[a]}return o()?{}:{obj:t,k:r(n.shift())}}function x(t,e,i){var r=m(t,e,Object);r.obj[r.k]=i}function b(t,e){var i=m(t,e),r=i.obj,o=i.k;if(r)return r[o]}function C(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var A={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function T(t){return"string"==typeof t?t.replace(/[&<>"'\/]/g,function(t){return A[t]}):t}var M=function(t){function i(t){var r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ns:["translation"],defaultNS:"translation"};return e(this,i),r=d(this,s(i).call(this)),p.call(h(h(r))),r.data=t||{},r.options=o,void 0===r.options.keySeparator&&(r.options.keySeparator="."),r}return a(i,p),r(i,[{key:"addNamespaces",value:function(t){this.options.ns.indexOf(t)<0&&this.options.ns.push(t)}},{key:"removeNamespaces",value:function(t){var e=this.options.ns.indexOf(t);e>-1&&this.options.ns.splice(e,1)}},{key:"getResource",value:function(t,e,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=void 0!==r.keySeparator?r.keySeparator:this.options.keySeparator,n=[t,e];return i&&"string"!=typeof i&&(n=n.concat(i)),i&&"string"==typeof i&&(n=n.concat(o?i.split(o):i)),t.indexOf(".")>-1&&(n=t.split(".")),b(this.data,n)}},{key:"addResource",value:function(t,e,i,r){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{silent:!1},n=this.options.keySeparator;void 0===n&&(n=".");var a=[t,e];i&&(a=a.concat(n?i.split(n):i)),t.indexOf(".")>-1&&(r=e,e=(a=t.split("."))[1]),this.addNamespaces(e),x(this.data,a,r),o.silent||this.emit("added",t,e,i,r)}},{key:"addResources",value:function(t,e,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{silent:!1};for(var o in i)"string"!=typeof i[o]&&"[object Array]"!==Object.prototype.toString.apply(i[o])||this.addResource(t,e,o,i[o],{silent:!0});r.silent||this.emit("added",t,e,i)}},{key:"addResourceBundle",value:function(t,e,i,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{silent:!1},s=[t,e];t.indexOf(".")>-1&&(r=i,i=e,e=(s=t.split("."))[1]),this.addNamespaces(e);var l=b(this.data,s)||{};r?function t(e,i,r){for(var o in i)o in e?"string"==typeof e[o]||e[o]instanceof String||"string"==typeof i[o]||i[o]instanceof String?r&&(e[o]=i[o]):t(e[o],i[o],r):e[o]=i[o];return e}(l,i,o):l=n({},l,i),x(this.data,s,l),a.silent||this.emit("added",t,e,i)}},{key:"removeResourceBundle",value:function(t,e){this.hasResourceBundle(t,e)&&delete this.data[t][e],this.removeNamespaces(e),this.emit("removed",t,e)}},{key:"hasResourceBundle",value:function(t,e){return void 0!==this.getResource(t,e)}},{key:"getResourceBundle",value:function(t,e){return e||(e=this.options.defaultNS),"v1"===this.options.compatibilityAPI?n({},{},this.getResource(t,e)):this.getResource(t,e)}},{key:"getDataByLanguage",value:function(t){return this.data[t]}},{key:"toJSON",value:function(){return this.data}}]),i}(),P={processors:{},addPostProcessor:function(t){this.processors[t.name]=t},handle:function(t,e,i,r,o){var n=this;return t.forEach(function(t){n.processors[t]&&(e=n.processors[t].process(e,i,r,o))}),e}},w=function(i){function o(t){var i,r,n,a,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e(this,o),i=d(this,s(o).call(this)),p.call(h(h(i))),r=["resourceStore","languageUtils","pluralResolver","interpolator","backendConnector","i18nFormat"],n=t,a=h(h(i)),r.forEach(function(t){n[t]&&(a[t]=n[t])}),i.options=l,void 0===i.options.keySeparator&&(i.options.keySeparator="."),i.logger=g.create("translator"),i}return a(o,p),r(o,[{key:"changeLanguage",value:function(t){t&&(this.language=t)}},{key:"exists",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{interpolation:{}},i=this.resolve(t,e);return i&&void 0!==i.res}},{key:"extractFromKey",value:function(t,e){var i=e.nsSeparator||this.options.nsSeparator;void 0===i&&(i=":");var r=void 0!==e.keySeparator?e.keySeparator:this.options.keySeparator,o=e.ns||this.options.defaultNS;if(i&&t.indexOf(i)>-1){var n=t.split(i);(i!==r||i===r&&this.options.ns.indexOf(n[0])>-1)&&(o=n.shift()),t=n.join(r)}return"string"==typeof o&&(o=[o]),{key:t,namespaces:o}}},{key:"translate",value:function(e,i){var r=this;if("object"!==t(i)&&this.options.overloadTranslationOptionHandler&&(i=this.options.overloadTranslationOptionHandler(arguments)),i||(i={}),void 0===e||null===e)return"";Array.isArray(e)||(e=[String(e)]);var o=void 0!==i.keySeparator?i.keySeparator:this.options.keySeparator,a=this.extractFromKey(e[e.length-1],i),s=a.key,l=a.namespaces,h=l[l.length-1],d=i.lng||this.language,c=i.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if(d&&"cimode"===d.toLowerCase()){if(c){var u=i.nsSeparator||this.options.nsSeparator;return h+u+s}return s}var f=this.resolve(e,i),g=f&&f.res,p=f&&f.usedKey||s,v=f&&f.exactUsedKey||s,y=Object.prototype.toString.apply(g),m=void 0!==i.joinArrays?i.joinArrays:this.options.joinArrays,x=!this.i18nFormat||this.i18nFormat.handleAsObject;if(x&&g&&("string"!=typeof g&&"boolean"!=typeof g&&"number"!=typeof g)&&["[object Number]","[object Function]","[object RegExp]"].indexOf(y)<0&&("string"!=typeof m||"[object Array]"!==y)){if(!i.returnObjects&&!this.options.returnObjects)return this.logger.warn("accessing an object - but returnObjects options is not enabled!"),this.options.returnedObjectHandler?this.options.returnedObjectHandler(p,g,i):"key '".concat(s," (").concat(this.language,")' returned an object instead of string.");if(o){var b="[object Array]"===y,C=b?[]:{},A=b?v:p;for(var T in g)if(Object.prototype.hasOwnProperty.call(g,T)){var M="".concat(A).concat(o).concat(T);C[T]=this.translate(M,n({},i,{joinArrays:!1,ns:l})),C[T]===M&&(C[T]=g[T])}g=C}}else if(x&&"string"==typeof m&&"[object Array]"===y)(g=g.join(m))&&(g=this.extendTranslation(g,e,i));else{var P=!1,w=!1;if(!this.isValidLookup(g)&&void 0!==i.defaultValue){if(P=!0,void 0!==i.count){var _=this.pluralResolver.getSuffix(d,i.count);g=i["defaultValue".concat(_)]}g||(g=i.defaultValue)}this.isValidLookup(g)||(w=!0,g=s);var S=i.defaultValue&&i.defaultValue!==g&&this.options.updateMissing;if(w||P||S){this.logger.log(S?"updateKey":"missingKey",d,h,s,S?i.defaultValue:g);var L=[],R=this.languageUtils.getFallbackCodes(this.options.fallbackLng,i.lng||this.language);if("fallback"===this.options.saveMissingTo&&R&&R[0])for(var D=0;D<R.length;D++)L.push(R[D]);else"all"===this.options.saveMissingTo?L=this.languageUtils.toResolveHierarchy(i.lng||this.language):L.push(i.lng||this.language);var E=function(t,e){r.options.missingKeyHandler?r.options.missingKeyHandler(t,h,e,S?i.defaultValue:g,S,i):r.backendConnector&&r.backendConnector.saveMissing&&r.backendConnector.saveMissing(t,h,e,S?i.defaultValue:g,S,i),r.emit("missingKey",t,h,e,g)};if(this.options.saveMissing){var I=void 0!==i.count&&"string"!=typeof i.count;this.options.saveMissingPlurals&&I?L.forEach(function(t){r.pluralResolver.getPluralFormsOfKey(t,s).forEach(function(e){return E([t],e)})}):E(L,s)}}g=this.extendTranslation(g,e,i,f),w&&g===s&&this.options.appendNamespaceToMissingKey&&(g="".concat(h,":").concat(s)),w&&this.options.parseMissingKeyHandler&&(g=this.options.parseMissingKeyHandler(g))}return g}},{key:"extendTranslation",value:function(t,e,i,r){var o=this;if(this.i18nFormat&&this.i18nFormat.parse)t=this.i18nFormat.parse(t,i,r.usedLng,r.usedNS,r.usedKey,{resolved:r});else if(!i.skipInterpolation){i.interpolation&&this.interpolator.init(n({},i,{interpolation:n({},this.options.interpolation,i.interpolation)}));var a=i.replace&&"string"!=typeof i.replace?i.replace:i;this.options.interpolation.defaultVariables&&(a=n({},this.options.interpolation.defaultVariables,a)),t=this.interpolator.interpolate(t,a,i.lng||this.language,i),!1!==i.nest&&(t=this.interpolator.nest(t,function(){return o.translate.apply(o,arguments)},i)),i.interpolation&&this.interpolator.reset()}var s=i.postProcess||this.options.postProcess,l="string"==typeof s?[s]:s;return void 0!==t&&null!==t&&l&&l.length&&!1!==i.applyPostProcessor&&(t=P.handle(l,t,e,i,this)),t}},{key:"resolve",value:function(t){var e,i,r,o,n,a=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"==typeof t&&(t=[t]),t.forEach(function(t){if(!a.isValidLookup(e)){var l=a.extractFromKey(t,s),h=l.key;i=h;var d=l.namespaces;a.options.fallbackNS&&(d=d.concat(a.options.fallbackNS));var c=void 0!==s.count&&"string"!=typeof s.count,u=void 0!==s.context&&"string"==typeof s.context&&""!==s.context,f=s.lngs?s.lngs:a.languageUtils.toResolveHierarchy(s.lng||a.language,s.fallbackLng);d.forEach(function(t){a.isValidLookup(e)||(n=t,f.forEach(function(i){if(!a.isValidLookup(e)){o=i;var n,l,d=h,f=[d];if(a.i18nFormat&&a.i18nFormat.addLookupKeys)a.i18nFormat.addLookupKeys(f,h,i,t,s);else c&&(n=a.pluralResolver.getSuffix(i,s.count)),c&&u&&f.push(d+n),u&&f.push(d+="".concat(a.options.contextSeparator).concat(s.context)),c&&f.push(d+=n);for(;l=f.pop();)a.isValidLookup(e)||(r=l,e=a.getResource(i,t,l,s))}}))})}}),{res:e,usedKey:i,exactUsedKey:r,usedLng:o,usedNS:n}}},{key:"isValidLookup",value:function(t){return!(void 0===t||!this.options.returnNull&&null===t||!this.options.returnEmptyString&&""===t)}},{key:"getResource",value:function(t,e,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.i18nFormat&&this.i18nFormat.getResource?this.i18nFormat.getResource(t,e,i,r):this.resourceStore.getResource(t,e,i,r)}}]),o}();function _(t){return t.charAt(0).toUpperCase()+t.slice(1)}var S=function(){function t(i){e(this,t),this.options=i,this.whitelist=this.options.whitelist||!1,this.logger=g.create("languageUtils")}return r(t,[{key:"getScriptPartFromCode",value:function(t){if(!t||t.indexOf("-")<0)return null;var e=t.split("-");return 2===e.length?null:(e.pop(),this.formatLanguageCode(e.join("-")))}},{key:"getLanguagePartFromCode",value:function(t){if(!t||t.indexOf("-")<0)return t;var e=t.split("-");return this.formatLanguageCode(e[0])}},{key:"formatLanguageCode",value:function(t){if("string"==typeof t&&t.indexOf("-")>-1){var e=["hans","hant","latn","cyrl","cans","mong","arab"],i=t.split("-");return this.options.lowerCaseLng?i=i.map(function(t){return t.toLowerCase()}):2===i.length?(i[0]=i[0].toLowerCase(),i[1]=i[1].toUpperCase(),e.indexOf(i[1].toLowerCase())>-1&&(i[1]=_(i[1].toLowerCase()))):3===i.length&&(i[0]=i[0].toLowerCase(),2===i[1].length&&(i[1]=i[1].toUpperCase()),"sgn"!==i[0]&&2===i[2].length&&(i[2]=i[2].toUpperCase()),e.indexOf(i[1].toLowerCase())>-1&&(i[1]=_(i[1].toLowerCase())),e.indexOf(i[2].toLowerCase())>-1&&(i[2]=_(i[2].toLowerCase()))),i.join("-")}return this.options.cleanCode||this.options.lowerCaseLng?t.toLowerCase():t}},{key:"isWhitelisted",value:function(t){return("languageOnly"===this.options.load||this.options.nonExplicitWhitelist)&&(t=this.getLanguagePartFromCode(t)),!this.whitelist||!this.whitelist.length||this.whitelist.indexOf(t)>-1}},{key:"getFallbackCodes",value:function(t,e){if(!t)return[];if("string"==typeof t&&(t=[t]),"[object Array]"===Object.prototype.toString.apply(t))return t;if(!e)return t.default||[];var i=t[e];return i||(i=t[this.getScriptPartFromCode(e)]),i||(i=t[this.formatLanguageCode(e)]),i||(i=t.default),i||[]}},{key:"toResolveHierarchy",value:function(t,e){var i=this,r=this.getFallbackCodes(e||this.options.fallbackLng||[],t),o=[],n=function(t){t&&(i.isWhitelisted(t)?o.push(t):i.logger.warn("rejecting non-whitelisted language code: ".concat(t)))};return"string"==typeof t&&t.indexOf("-")>-1?("languageOnly"!==this.options.load&&n(this.formatLanguageCode(t)),"languageOnly"!==this.options.load&&"currentOnly"!==this.options.load&&n(this.getScriptPartFromCode(t)),"currentOnly"!==this.options.load&&n(this.getLanguagePartFromCode(t))):"string"==typeof t&&n(this.formatLanguageCode(t)),r.forEach(function(t){o.indexOf(t)<0&&n(i.formatLanguageCode(t))}),o}}]),t}(),L=[{lngs:["ach","ak","am","arn","br","fil","gun","ln","mfe","mg","mi","oc","pt","pt-BR","tg","ti","tr","uz","wa"],nr:[1,2],fc:1},{lngs:["af","an","ast","az","bg","bn","ca","da","de","dev","el","en","eo","es","et","eu","fi","fo","fur","fy","gl","gu","ha","hi","hu","hy","ia","it","kn","ku","lb","mai","ml","mn","mr","nah","nap","nb","ne","nl","nn","no","nso","pa","pap","pms","ps","pt-PT","rm","sco","se","si","so","son","sq","sv","sw","ta","te","tk","ur","yo"],nr:[1,2],fc:2},{lngs:["ay","bo","cgg","fa","id","ja","jbo","ka","kk","km","ko","ky","lo","ms","sah","su","th","tt","ug","vi","wo","zh"],nr:[1],fc:3},{lngs:["be","bs","dz","hr","ru","sr","uk"],nr:[1,2,5],fc:4},{lngs:["ar"],nr:[0,1,2,3,11,100],fc:5},{lngs:["cs","sk"],nr:[1,2,5],fc:6},{lngs:["csb","pl"],nr:[1,2,5],fc:7},{lngs:["cy"],nr:[1,2,3,8],fc:8},{lngs:["fr"],nr:[1,2],fc:9},{lngs:["ga"],nr:[1,2,3,7,11],fc:10},{lngs:["gd"],nr:[1,2,3,20],fc:11},{lngs:["is"],nr:[1,2],fc:12},{lngs:["jv"],nr:[0,1],fc:13},{lngs:["kw"],nr:[1,2,3,4],fc:14},{lngs:["lt"],nr:[1,2,10],fc:15},{lngs:["lv"],nr:[1,2,0],fc:16},{lngs:["mk"],nr:[1,2],fc:17},{lngs:["mnk"],nr:[0,1,2],fc:18},{lngs:["mt"],nr:[1,2,11,20],fc:19},{lngs:["or"],nr:[2,1],fc:2},{lngs:["ro"],nr:[1,2,20],fc:20},{lngs:["sl"],nr:[5,1,2,3],fc:21},{lngs:["he"],nr:[1,2,20,21],fc:22}],R={1:function(t){return Number(t>1)},2:function(t){return Number(1!=t)},3:function(t){return 0},4:function(t){return Number(t%10==1&&t%100!=11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2)},5:function(t){return Number(0===t?0:1==t?1:2==t?2:t%100>=3&&t%100<=10?3:t%100>=11?4:5)},6:function(t){return Number(1==t?0:t>=2&&t<=4?1:2)},7:function(t){return Number(1==t?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2)},8:function(t){return Number(1==t?0:2==t?1:8!=t&&11!=t?2:3)},9:function(t){return Number(t>=2)},10:function(t){return Number(1==t?0:2==t?1:t<7?2:t<11?3:4)},11:function(t){return Number(1==t||11==t?0:2==t||12==t?1:t>2&&t<20?2:3)},12:function(t){return Number(t%10!=1||t%100==11)},13:function(t){return Number(0!==t)},14:function(t){return Number(1==t?0:2==t?1:3==t?2:3)},15:function(t){return Number(t%10==1&&t%100!=11?0:t%10>=2&&(t%100<10||t%100>=20)?1:2)},16:function(t){return Number(t%10==1&&t%100!=11?0:0!==t?1:2)},17:function(t){return Number(1==t||t%10==1?0:1)},18:function(t){return Number(0==t?0:1==t?1:2)},19:function(t){return Number(1==t?0:0===t||t%100>1&&t%100<11?1:t%100>10&&t%100<20?2:3)},20:function(t){return Number(1==t?0:0===t||t%100>0&&t%100<20?1:2)},21:function(t){return Number(t%100==1?1:t%100==2?2:t%100==3||t%100==4?3:0)},22:function(t){return Number(1===t?0:2===t?1:(t<0||t>10)&&t%10==0?2:3)}};var D=function(){function t(i){var r,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this.languageUtils=i,this.options=o,this.logger=g.create("pluralResolver"),this.rules=(r={},L.forEach(function(t){t.lngs.forEach(function(e){r[e]={numbers:t.nr,plurals:R[t.fc]}})}),r)}return r(t,[{key:"addRule",value:function(t,e){this.rules[t]=e}},{key:"getRule",value:function(t){return this.rules[t]||this.rules[this.languageUtils.getLanguagePartFromCode(t)]}},{key:"needsPlural",value:function(t){var e=this.getRule(t);return e&&e.numbers.length>1}},{key:"getPluralFormsOfKey",value:function(t,e){var i=this,r=[],o=this.getRule(t);return o?(o.numbers.forEach(function(o){var n=i.getSuffix(t,o);r.push("".concat(e).concat(n))}),r):r}},{key:"getSuffix",value:function(t,e){var i=this,r=this.getRule(t);if(r){var o=r.noAbs?r.plurals(e):r.plurals(Math.abs(e)),n=r.numbers[o];this.options.simplifyPluralSuffix&&2===r.numbers.length&&1===r.numbers[0]&&(2===n?n="plural":1===n&&(n=""));var a=function(){return i.options.prepend&&n.toString()?i.options.prepend+n.toString():n.toString()};return"v1"===this.options.compatibilityJSON?1===n?"":"number"==typeof n?"_plural_".concat(n.toString()):a():"v2"===this.options.compatibilityJSON?a():this.options.simplifyPluralSuffix&&2===r.numbers.length&&1===r.numbers[0]?a():this.options.prepend&&o.toString()?this.options.prepend+o.toString():o.toString()}return this.logger.warn("no plural rule found for: ".concat(t)),""}}]),t}(),E=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.logger=g.create("interpolator"),this.init(i,!0)}return r(t,[{key:"init",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(arguments.length>1?arguments[1]:void 0)&&(this.options=t,this.format=t.interpolation&&t.interpolation.format||function(t){return t}),t.interpolation||(t.interpolation={escapeValue:!0});var e=t.interpolation;this.escape=void 0!==e.escape?e.escape:T,this.escapeValue=void 0===e.escapeValue||e.escapeValue,this.useRawValueToEscape=void 0!==e.useRawValueToEscape&&e.useRawValueToEscape,this.prefix=e.prefix?C(e.prefix):e.prefixEscaped||"{{",this.suffix=e.suffix?C(e.suffix):e.suffixEscaped||"}}",this.formatSeparator=e.formatSeparator?e.formatSeparator:e.formatSeparator||",",this.unescapePrefix=e.unescapeSuffix?"":e.unescapePrefix||"-",this.unescapeSuffix=this.unescapePrefix?"":e.unescapeSuffix||"",this.nestingPrefix=e.nestingPrefix?C(e.nestingPrefix):e.nestingPrefixEscaped||C("$t("),this.nestingSuffix=e.nestingSuffix?C(e.nestingSuffix):e.nestingSuffixEscaped||C(")"),this.maxReplaces=e.maxReplaces?e.maxReplaces:1e3,this.resetRegExp()}},{key:"reset",value:function(){this.options&&this.init(this.options)}},{key:"resetRegExp",value:function(){var t="".concat(this.prefix,"(.+?)").concat(this.suffix);this.regexp=new RegExp(t,"g");var e="".concat(this.prefix).concat(this.unescapePrefix,"(.+?)").concat(this.unescapeSuffix).concat(this.suffix);this.regexpUnescape=new RegExp(e,"g");var i="".concat(this.nestingPrefix,"(.+?)").concat(this.nestingSuffix);this.nestingRegexp=new RegExp(i,"g")}},{key:"interpolate",value:function(t,e,i,r){var o,n,a,s=this;function l(t){return t.replace(/\$/g,"$$$$")}var h=function(t){if(t.indexOf(s.formatSeparator)<0)return b(e,t);var r=t.split(s.formatSeparator),o=r.shift().trim(),n=r.join(s.formatSeparator).trim();return s.format(b(e,o),n,i)};this.resetRegExp();var d=r&&r.missingInterpolationHandler||this.options.missingInterpolationHandler;for(a=0;(o=this.regexpUnescape.exec(t))&&(n=h(o[1].trim()),t=t.replace(o[0],n),this.regexpUnescape.lastIndex=0,!(++a>=this.maxReplaces)););for(a=0;o=this.regexp.exec(t);){if(void 0===(n=h(o[1].trim())))if("function"==typeof d){var c=d(t,o,r);n="string"==typeof c?c:""}else this.logger.warn("missed to pass in variable ".concat(o[1]," for interpolating ").concat(t)),n="";else"string"==typeof n||this.useRawValueToEscape||(n=y(n));if(n=this.escapeValue?l(this.escape(n)):l(n),t=t.replace(o[0],n),this.regexp.lastIndex=0,++a>=this.maxReplaces)break}return t}},{key:"nest",value:function(t,e){var i,r,o=n({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{});function a(t,e){if(t.indexOf(",")<0)return t;var i=t.split(",");t=i.shift();var r=i.join(",");r=(r=this.interpolate(r,o)).replace(/'/g,'"');try{o=JSON.parse(r),e&&(o=n({},e,o))}catch(e){this.logger.error("failed parsing options string in nesting for key ".concat(t),e)}return t}for(o.applyPostProcessor=!1;i=this.nestingRegexp.exec(t);){if((r=e(a.call(this,i[1].trim(),o),o))&&i[0]===t&&"string"!=typeof r)return r;"string"!=typeof r&&(r=y(r)),r||(this.logger.warn("missed to resolve ".concat(i[1]," for nesting ").concat(t)),r=""),t=t.replace(i[0],r),this.regexp.lastIndex=0}return t}}]),t}();var I=function(t){function i(t,r,o){var n,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return e(this,i),n=d(this,s(i).call(this)),p.call(h(h(n))),n.backend=t,n.store=r,n.languageUtils=o.languageUtils,n.options=a,n.logger=g.create("backendConnector"),n.state={},n.queue=[],n.backend&&n.backend.init&&n.backend.init(o,a.backend,a),n}return a(i,p),r(i,[{key:"queueLoad",value:function(t,e,i,r){var o=this,n=[],a=[],s=[],l=[];return t.forEach(function(t){var r=!0;e.forEach(function(e){var s="".concat(t,"|").concat(e);!i.reload&&o.store.hasResourceBundle(t,e)?o.state[s]=2:o.state[s]<0||(1===o.state[s]?a.indexOf(s)<0&&a.push(s):(o.state[s]=1,r=!1,a.indexOf(s)<0&&a.push(s),n.indexOf(s)<0&&n.push(s),l.indexOf(e)<0&&l.push(e)))}),r||s.push(t)}),(n.length||a.length)&&this.queue.push({pending:a,loaded:{},errors:[],callback:r}),{toLoad:n,pending:a,toLoadLanguages:s,toLoadNamespaces:l}}},{key:"loaded",value:function(t,e,i){var r=c(t.split("|"),2),o=r[0],n=r[1];e&&this.emit("failedLoading",o,n,e),i&&this.store.addResourceBundle(o,n,i),this.state[t]=e?-1:2;var a={};this.queue.forEach(function(i){var r,s,l,h,d,c;r=i.loaded,s=n,h=m(r,[o],Object),d=h.obj,c=h.k,d[c]=d[c]||[],l&&(d[c]=d[c].concat(s)),l||d[c].push(s),function(t,e){for(var i=t.indexOf(e);-1!==i;)t.splice(i,1),i=t.indexOf(e)}(i.pending,t),e&&i.errors.push(e),0!==i.pending.length||i.done||(Object.keys(i.loaded).forEach(function(t){a[t]||(a[t]=[]),i.loaded[t].length&&i.loaded[t].forEach(function(e){a[t].indexOf(e)<0&&a[t].push(e)})}),i.done=!0,i.errors.length?i.callback(i.errors):i.callback())}),this.emit("loaded",a),this.queue=this.queue.filter(function(t){return!t.done})}},{key:"read",value:function(t,e,i){var r=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:250,a=arguments.length>5?arguments[5]:void 0;return t.length?this.backend[i](t,e,function(s,l){s&&l&&o<5?setTimeout(function(){r.read.call(r,t,e,i,o+1,2*n,a)},n):a(s,l)}):a(null,{})}},{key:"prepareLoading",value:function(t,e){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3?arguments[3]:void 0;if(!this.backend)return this.logger.warn("No backend was added via i18next.use. Will not load resources."),o&&o();"string"==typeof t&&(t=this.languageUtils.toResolveHierarchy(t)),"string"==typeof e&&(e=[e]);var n=this.queueLoad(t,e,r,o);if(!n.toLoad.length)return n.pending.length||o(),null;n.toLoad.forEach(function(t){i.loadOne(t)})}},{key:"load",value:function(t,e,i){this.prepareLoading(t,e,{},i)}},{key:"reload",value:function(t,e,i){this.prepareLoading(t,e,{reload:!0},i)}},{key:"loadOne",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=c(t.split("|"),2),o=r[0],n=r[1];this.read(o,n,"read",null,null,function(r,a){r&&e.logger.warn("".concat(i,"loading namespace ").concat(n," for language ").concat(o," failed"),r),!r&&a&&e.logger.log("".concat(i,"loaded namespace ").concat(n," for language ").concat(o),a),e.loaded(t,r,a)})}},{key:"saveMissing",value:function(t,e,i,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.backend&&this.backend.create&&this.backend.create(t,e,i,r,null,n({},a,{isUpdate:o})),t&&t[0]&&this.store.addResource(t[0],e,i,r)}}]),i}();function O(t){return"string"==typeof t.ns&&(t.ns=[t.ns]),"string"==typeof t.fallbackLng&&(t.fallbackLng=[t.fallbackLng]),"string"==typeof t.fallbackNS&&(t.fallbackNS=[t.fallbackNS]),t.whitelist&&t.whitelist.indexOf("cimode")<0&&(t.whitelist=t.whitelist.concat(["cimode"])),t}function F(){}return new(function(i){function o(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;if(e(this,o),t=d(this,s(o).call(this)),p.call(h(h(t))),t.options=O(i),t.services={},t.logger=g,t.modules={external:[]},r&&!t.isInitialized&&!i.isClone){if(!t.options.initImmediate)return t.init(i,r),d(t,h(h(t)));setTimeout(function(){t.init(i,r)},0)}return t}return a(o,p),r(o,[{key:"init",value:function(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;function o(t){return t?"function"==typeof t?new t:t:null}if("function"==typeof i&&(r=i,i={}),this.options=n({},{debug:!1,initImmediate:!0,ns:["translation"],defaultNS:["translation"],fallbackLng:["dev"],fallbackNS:!1,whitelist:!1,nonExplicitWhitelist:!1,load:"all",preload:!1,simplifyPluralSuffix:!0,keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_",partialBundledLanguages:!1,saveMissing:!1,updateMissing:!1,saveMissingTo:"fallback",saveMissingPlurals:!0,missingKeyHandler:!1,missingInterpolationHandler:!1,postProcess:!1,returnNull:!0,returnEmptyString:!0,returnObjects:!1,joinArrays:!1,returnedObjectHandler:function(){},parseMissingKeyHandler:!1,appendNamespaceToMissingKey:!1,appendNamespaceToCIMode:!1,overloadTranslationOptionHandler:function(e){var i={};if("object"===t(e[1])&&(i=e[1]),"string"==typeof e[1]&&(i.defaultValue=e[1]),"string"==typeof e[2]&&(i.tDescription=e[2]),"object"===t(e[2])||"object"===t(e[3])){var r=e[3]||e[2];Object.keys(r).forEach(function(t){i[t]=r[t]})}return i},interpolation:{escapeValue:!0,format:function(t,e,i){return t},prefix:"{{",suffix:"}}",formatSeparator:",",unescapePrefix:"-",nestingPrefix:"$t(",nestingSuffix:")",maxReplaces:1e3}},this.options,O(i)),this.format=this.options.interpolation.format,r||(r=F),!this.options.isClone){this.modules.logger?g.init(o(this.modules.logger),this.options):g.init(null,this.options);var a=new S(this.options);this.store=new M(this.options.resources,this.options);var s=this.services;s.logger=g,s.resourceStore=this.store,s.languageUtils=a,s.pluralResolver=new D(a,{prepend:this.options.pluralSeparator,compatibilityJSON:this.options.compatibilityJSON,simplifyPluralSuffix:this.options.simplifyPluralSuffix}),s.interpolator=new E(this.options),s.backendConnector=new I(o(this.modules.backend),s.resourceStore,s,this.options),s.backendConnector.on("*",function(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];e.emit.apply(e,[t].concat(r))}),this.modules.languageDetector&&(s.languageDetector=o(this.modules.languageDetector),s.languageDetector.init(s,this.options.detection,this.options)),this.modules.i18nFormat&&(s.i18nFormat=o(this.modules.i18nFormat),s.i18nFormat.init&&s.i18nFormat.init(this)),this.translator=new w(this.services,this.options),this.translator.on("*",function(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];e.emit.apply(e,[t].concat(r))}),this.modules.external.forEach(function(t){t.init&&t.init(e)})}["getResource","addResource","addResources","addResourceBundle","removeResourceBundle","hasResourceBundle","getResourceBundle","getDataByLanguage"].forEach(function(t){e[t]=function(){var i;return(i=e.store)[t].apply(i,arguments)}});var l=v(),h=function(){e.changeLanguage(e.options.lng,function(t,i){e.isInitialized=!0,e.logger.log("initialized",e.options),e.emit("initialized",e.options),l.resolve(i),r(t,i)})};return this.options.resources||!this.options.initImmediate?h():setTimeout(h,0),l}},{key:"loadResources",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:F;if(!this.options.resources||this.options.partialBundledLanguages){if(this.language&&"cimode"===this.language.toLowerCase())return e();var i=[],r=function(e){e&&t.services.languageUtils.toResolveHierarchy(e).forEach(function(t){i.indexOf(t)<0&&i.push(t)})};if(this.language)r(this.language);else this.services.languageUtils.getFallbackCodes(this.options.fallbackLng).forEach(function(t){return r(t)});this.options.preload&&this.options.preload.forEach(function(t){return r(t)}),this.services.backendConnector.load(i,this.options.ns,e)}else e(null)}},{key:"reloadResources",value:function(t,e,i){var r=v();return t||(t=this.languages),e||(e=this.options.ns),i||(i=F),this.services.backendConnector.reload(t,e,function(t){r.resolve(),i(t)}),r}},{key:"use",value:function(t){return"backend"===t.type&&(this.modules.backend=t),("logger"===t.type||t.log&&t.warn&&t.error)&&(this.modules.logger=t),"languageDetector"===t.type&&(this.modules.languageDetector=t),"i18nFormat"===t.type&&(this.modules.i18nFormat=t),"postProcessor"===t.type&&P.addPostProcessor(t),"3rdParty"===t.type&&this.modules.external.push(t),this}},{key:"changeLanguage",value:function(t,e){var i=this,r=v();this.emit("languageChanging",t);var o=function(t){t&&(i.language=t,i.languages=i.services.languageUtils.toResolveHierarchy(t),i.translator.language||i.translator.changeLanguage(t),i.services.languageDetector&&i.services.languageDetector.cacheUserLanguage(t)),i.loadResources(function(o){!function(t,o){i.translator.changeLanguage(o),o&&(i.emit("languageChanged",o),i.logger.log("languageChanged",o)),r.resolve(function(){return i.t.apply(i,arguments)}),e&&e(t,function(){return i.t.apply(i,arguments)})}(o,t)})};return t||!this.services.languageDetector||this.services.languageDetector.async?!t&&this.services.languageDetector&&this.services.languageDetector.async?this.services.languageDetector.detect(o):o(t):o(this.services.languageDetector.detect()),r}},{key:"getFixedT",value:function(e,i){var r=this,o=function e(i,o){var a=n({},o);if("object"!==t(o)){for(var s=arguments.length,l=new Array(s>2?s-2:0),h=2;h<s;h++)l[h-2]=arguments[h];a=r.options.overloadTranslationOptionHandler([i,o].concat(l))}return a.lng=a.lng||e.lng,a.lngs=a.lngs||e.lngs,a.ns=a.ns||e.ns,r.t(i,a)};return"string"==typeof e?o.lng=e:o.lngs=e,o.ns=i,o}},{key:"t",value:function(){var t;return this.translator&&(t=this.translator).translate.apply(t,arguments)}},{key:"exists",value:function(){var t;return this.translator&&(t=this.translator).exists.apply(t,arguments)}},{key:"setDefaultNamespace",value:function(t){this.options.defaultNS=t}},{key:"loadNamespaces",value:function(t,e){var i=this,r=v();return this.options.ns?("string"==typeof t&&(t=[t]),t.forEach(function(t){i.options.ns.indexOf(t)<0&&i.options.ns.push(t)}),this.loadResources(function(t){r.resolve(),e&&e(t)}),r):(e&&e(),Promise.resolve())}},{key:"loadLanguages",value:function(t,e){var i=v();"string"==typeof t&&(t=[t]);var r=this.options.preload||[],o=t.filter(function(t){return r.indexOf(t)<0});return o.length?(this.options.preload=r.concat(o),this.loadResources(function(t){i.resolve(),e&&e(t)}),i):(e&&e(),Promise.resolve())}},{key:"dir",value:function(t){if(t||(t=this.languages&&this.languages.length>0?this.languages[0]:this.language),!t)return"rtl";return["ar","shu","sqr","ssh","xaa","yhd","yud","aao","abh","abv","acm","acq","acw","acx","acy","adf","ads","aeb","aec","afb","ajp","apc","apd","arb","arq","ars","ary","arz","auz","avl","ayh","ayl","ayn","ayp","bbz","pga","he","iw","ps","pbt","pbu","pst","prp","prd","ur","ydd","yds","yih","ji","yi","hbo","men","xmn","fa","jpr","peo","pes","prs","dv","sam"].indexOf(this.services.languageUtils.getLanguagePartFromCode(t))>=0?"rtl":"ltr"}},{key:"createInstance",value:function(){return new o(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1?arguments[1]:void 0)}},{key:"cloneInstance",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:F,r=n({},this.options,e,{isClone:!0}),a=new o(r);return["store","services","language"].forEach(function(e){a[e]=t[e]}),a.translator=new w(a.services,a.options),a.translator.on("*",function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];a.emit.apply(a,[t].concat(i))}),a.init(r,i),a.translator.options=a.options,a}}]),o}())}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.i18nextBrowserLanguageDetector=e()}(this,function(){var t=[],e=t.forEach,i=t.slice;var r=function(t,e,i,r){var o=void 0;if(i){var n=new Date;n.setTime(n.getTime()+60*i*1e3),o="; expires="+n.toGMTString()}else o="";r=r?"domain="+r+";":"",document.cookie=t+"="+e+o+";"+r+"path=/"},o=function(t){for(var e=t+"=",i=document.cookie.split(";"),r=0;r<i.length;r++){for(var o=i[r];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(e))return o.substring(e.length,o.length)}return null},n={name:"cookie",lookup:function(t){var e=void 0;if(t.lookupCookie&&"undefined"!=typeof document){var i=o(t.lookupCookie);i&&(e=i)}return e},cacheUserLanguage:function(t,e){e.lookupCookie&&"undefined"!=typeof document&&r(e.lookupCookie,t,e.cookieMinutes,e.cookieDomain)}},a={name:"querystring",lookup:function(t){var e=void 0;if("undefined"!=typeof window)for(var i=window.location.search.substring(1).split("&"),r=0;r<i.length;r++){var o=i[r].indexOf("=");if(o>0)i[r].substring(0,o)===t.lookupQuerystring&&(e=i[r].substring(o+1))}return e}},s=void 0;try{s="undefined"!==window&&null!==window.localStorage;window.localStorage.setItem("i18next.translate.boo","foo"),window.localStorage.removeItem("i18next.translate.boo")}catch(t){s=!1}var l={name:"localStorage",lookup:function(t){var e=void 0;if(t.lookupLocalStorage&&s){var i=window.localStorage.getItem(t.lookupLocalStorage);i&&(e=i)}return e},cacheUserLanguage:function(t,e){e.lookupLocalStorage&&s&&window.localStorage.setItem(e.lookupLocalStorage,t)}},h={name:"navigator",lookup:function(t){var e=[];if("undefined"!=typeof navigator){if(navigator.languages)for(var i=0;i<navigator.languages.length;i++)e.push(navigator.languages[i]);navigator.userLanguage&&e.push(navigator.userLanguage),navigator.language&&e.push(navigator.language)}return e.length>0?e:void 0}},d={name:"htmlTag",lookup:function(t){var e=void 0,i=t.htmlTag||("undefined"!=typeof document?document.documentElement:null);return i&&"function"==typeof i.getAttribute&&(e=i.getAttribute("lang")),e}},c={name:"path",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var i=window.location.pathname.match(/\/([a-zA-Z-]*)/g);if(i instanceof Array)if("number"==typeof t.lookupFromPathIndex){if("string"!=typeof i[t.lookupFromPathIndex])return;e=i[t.lookupFromPathIndex].replace("/","")}else e=i[0].replace("/","")}return e}},u={name:"subdomain",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var i=window.location.href.match(/(?:http[s]*\:\/\/)*(.*?)\.(?=[^\/]*\..{2,5})/gi);i instanceof Array&&(e="number"==typeof t.lookupFromSubdomainIndex?i[t.lookupFromSubdomainIndex].replace("http://","").replace("https://","").replace(".",""):i[0].replace("http://","").replace("https://","").replace(".",""))}return e}},f=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}();var g=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.type="languageDetector",this.detectors={},this.init(e,i)}return f(t,[{key:"init",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.services=t,this.options=function(t){return e.call(i.call(arguments,1),function(e){if(e)for(var i in e)void 0===t[i]&&(t[i]=e[i])}),t}(r,this.options||{},{order:["querystring","cookie","localStorage","navigator","htmlTag"],lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"]}),this.options.lookupFromUrlIndex&&(this.options.lookupFromPathIndex=this.options.lookupFromUrlIndex),this.i18nOptions=o,this.addDetector(n),this.addDetector(a),this.addDetector(l),this.addDetector(h),this.addDetector(d),this.addDetector(c),this.addDetector(u)}},{key:"addDetector",value:function(t){this.detectors[t.name]=t}},{key:"detect",value:function(t){var e=this;t||(t=this.options.order);var i=[];t.forEach(function(t){if(e.detectors[t]){var r=e.detectors[t].lookup(e.options);r&&"string"==typeof r&&(r=[r]),r&&(i=i.concat(r))}});var r=void 0;if(i.forEach(function(t){if(!r){var i=e.services.languageUtils.formatLanguageCode(t);e.services.languageUtils.isWhitelisted(i)&&(r=i)}}),!r){var o=this.i18nOptions.fallbackLng;"string"==typeof o&&(o=[o]),o||(o=[]),r="[object Array]"===Object.prototype.toString.apply(o)?o[0]:o[0]||o.default&&o.default[0]}return r}},{key:"cacheUserLanguage",value:function(t,e){var i=this;e||(e=this.options.caches),e&&(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(t)>-1||e.forEach(function(e){i.detectors[e]&&i.detectors[e].cacheUserLanguage(t,i.options)}))}}]),t}();return g.type="languageDetector",g}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.i18nextXHRBackend=e()}(this,function(){var t=[],e=t.forEach,i=t.slice;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function o(t,e){if(e&&"object"===(void 0===e?"undefined":r(e))){var i="",o=encodeURIComponent;for(var n in e)i+="&"+o(n)+"="+o(e[n]);if(!i)return t;t=t+(-1!==t.indexOf("?")?"&":"?")+i.slice(1)}return t}function n(t,e,i,n,a){n&&"object"===(void 0===n?"undefined":r(n))&&(a||(n._t=new Date),n=o("",n).slice(1)),e.queryStringParams&&(t=o(t,e.queryStringParams));try{var s;(s=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0")).open(n?"POST":"GET",t,1),e.crossDomain||s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.withCredentials=!!e.withCredentials,n&&s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.overrideMimeType&&s.overrideMimeType("application/json");var l=e.customHeaders;if(l)for(var h in l)s.setRequestHeader(h,l[h]);s.onreadystatechange=function(){s.readyState>3&&i&&i(s.responseText,s)},s.send(n)}catch(t){console&&console.log(t)}}var a=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}();var s=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.init(e,i),this.type="backend"}return a(t,[{key:"init",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.services=t,this.options=function(t){return e.call(i.call(arguments,1),function(e){if(e)for(var i in e)void 0===t[i]&&(t[i]=e[i])}),t}(r,this.options||{},{loadPath:"/locales/{{lng}}/{{ns}}.json",addPath:"/locales/add/{{lng}}/{{ns}}",allowMultiLoading:!1,parse:JSON.parse,crossDomain:!1,ajax:n})}},{key:"readMulti",value:function(t,e,i){var r=this.options.loadPath;"function"==typeof this.options.loadPath&&(r=this.options.loadPath(t,e));var o=this.services.interpolator.interpolate(r,{lng:t.join("+"),ns:e.join("+")});this.loadUrl(o,i)}},{key:"read",value:function(t,e,i){var r=this.options.loadPath;"function"==typeof this.options.loadPath&&(r=this.options.loadPath([t],[e]));var o=this.services.interpolator.interpolate(r,{lng:t,ns:e});this.loadUrl(o,i)}},{key:"loadUrl",value:function(t,e){var i=this;this.options.ajax(t,this.options,function(r,o){if(o.status>=500&&o.status<600)return e("failed loading "+t,!0);if(o.status>=400&&o.status<500)return e("failed loading "+t,!1);var n=void 0,a=void 0;try{n=i.options.parse(r,t)}catch(e){a="failed parsing "+t+" to json"}if(a)return e(a,!1);e(null,n)})}},{key:"create",value:function(t,e,i,r){var o=this;"string"==typeof t&&(t=[t]);var n={};n[i]=r||"",t.forEach(function(t){var i=o.services.interpolator.interpolate(o.options.addPath,{lng:t,ns:e});o.options.ajax(i,o.options,function(t,e){},n)})}}]),t}();return s.type="backend",s}),function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).rbush=t()}}(function(){return function t(e,i,r){function o(a,s){if(!i[a]){if(!e[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var d=i[a]={exports:{}};e[a][0].call(d.exports,function(t){var i=e[a][1][t];return o(i||t)},d,d.exports,t,e,i,r)}return i[a].exports}for(var n="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(t,e,i){e.exports=o;var r=t("quickselect");function o(t,e){if(!(this instanceof o))return new o(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function n(t,e,i){if(!i)return e.indexOf(t);for(var r=0;r<e.length;r++)if(i(t,e[r]))return r;return-1}function a(t,e){s(t,0,t.children.length,e,t)}function s(t,e,i,r,o){o||(o=p(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var n,a=e;a<i;a++)n=t.children[a],l(o,t.leaf?r(n):n);return o}function l(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function h(t,e){return t.minX-e.minX}function d(t,e){return t.minY-e.minY}function c(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function g(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function v(t,e,i,o,n){for(var a,s=[e,i];s.length;)(i=s.pop())-(e=s.pop())<=o||(a=e+Math.ceil((i-e)/o/2)*o,r(t,a,e,i,n),s.push(e,a,a,i))}o.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,i=[],r=this.toBBox;if(!g(t,e))return i;for(var o,n,a,s,l=[];e;){for(o=0,n=e.children.length;o<n;o++)a=e.children[o],g(t,s=e.leaf?r(a):a)&&(e.leaf?i.push(a):f(t,s)?this._all(a,i):l.push(a));e=l.pop()}return i},collides:function(t){var e=this.data,i=this.toBBox;if(!g(t,e))return!1;for(var r,o,n,a,s=[];e;){for(r=0,o=e.children.length;r<o;r++)if(n=e.children[r],g(t,a=e.leaf?i(n):n)){if(e.leaf||f(t,a))return!0;s.push(n)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,i=t.length;e<i;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var o=this.data;this.data=r,r=o}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=p([]),this},remove:function(t,e){if(!t)return this;for(var i,r,o,a,s=this.data,l=this.toBBox(t),h=[],d=[];s||h.length;){if(s||(s=h.pop(),r=h[h.length-1],i=d.pop(),a=!0),s.leaf&&-1!==(o=n(t,s.children,e)))return s.children.splice(o,1),h.push(s),this._condense(h),this;a||s.leaf||!f(s,l)?r?(i++,s=r.children[i],a=!1):s=null:(h.push(s),d.push(i),i=0,r=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:h,compareMinY:d,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},_build:function(t,e,i,r){var o,n=i-e+1,s=this._maxEntries;if(n<=s)return a(o=p(t.slice(e,i+1)),this.toBBox),o;r||(r=Math.ceil(Math.log(n)/Math.log(s)),s=Math.ceil(n/Math.pow(s,r-1))),(o=p([])).leaf=!1,o.height=r;var l,h,d,c,u=Math.ceil(n/s),f=u*Math.ceil(Math.sqrt(s));for(v(t,e,i,f,this.compareMinX),l=e;l<=i;l+=f)for(v(t,l,d=Math.min(l+f-1,i),u,this.compareMinY),h=l;h<=d;h+=u)c=Math.min(h+u-1,d),o.children.push(this._build(t,h,c,r-1));return a(o,this.toBBox),o},_chooseSubtree:function(t,e,i,r){for(var o,n,a,s,l,h,d,u,f,g;r.push(e),!e.leaf&&r.length-1!==i;){for(d=u=1/0,o=0,n=e.children.length;o<n;o++)l=c(a=e.children[o]),f=t,g=a,(h=(Math.max(g.maxX,f.maxX)-Math.min(g.minX,f.minX))*(Math.max(g.maxY,f.maxY)-Math.min(g.minY,f.minY))-l)<u?(u=h,d=l<d?l:d,s=a):h===u&&l<d&&(d=l,s=a);e=s||e.children[0]}return e},_insert:function(t,e,i){var r=this.toBBox,o=i?t:r(t),n=[],a=this._chooseSubtree(o,this.data,e,n);for(a.children.push(t),l(a,o);e>=0&&n[e].children.length>this._maxEntries;)this._split(n,e),e--;this._adjustParentBBoxes(o,n,e)},_split:function(t,e){var i=t[e],r=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,r);var n=this._chooseSplitIndex(i,o,r),s=p(i.children.splice(n,i.children.length-n));s.height=i.height,s.leaf=i.leaf,a(i,this.toBBox),a(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(i,s)},_splitRoot:function(t,e){this.data=p([t,e]),this.data.height=t.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,i){var r,o,n,a,l,h,d,u,f,g,p,v,y,m;for(h=d=1/0,r=e;r<=i-e;r++)o=s(t,0,r,this.toBBox),n=s(t,r,i,this.toBBox),f=o,g=n,void 0,void 0,void 0,void 0,p=Math.max(f.minX,g.minX),v=Math.max(f.minY,g.minY),y=Math.min(f.maxX,g.maxX),m=Math.min(f.maxY,g.maxY),a=Math.max(0,y-p)*Math.max(0,m-v),l=c(o)+c(n),a<h?(h=a,u=r,d=l<d?l:d):a===h&&l<d&&(d=l,u=r);return u},_chooseSplitAxis:function(t,e,i){var r=t.leaf?this.compareMinX:h,o=t.leaf?this.compareMinY:d;this._allDistMargin(t,e,i,r)<this._allDistMargin(t,e,i,o)&&t.children.sort(r)},_allDistMargin:function(t,e,i,r){t.children.sort(r);var o,n,a=this.toBBox,h=s(t,0,e,a),d=s(t,i-e,i,a),c=u(h)+u(d);for(o=e;o<i-e;o++)n=t.children[o],l(h,t.leaf?a(n):n),c+=u(h);for(o=i-e-1;o>=e;o--)n=t.children[o],l(d,t.leaf?a(n):n),c+=u(d);return c},_adjustParentBBoxes:function(t,e,i){for(var r=i;r>=0;r--)l(e[r],t)},_condense:function(t){for(var e,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():a(t[i],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}},{quickselect:2}],2:[function(t,e,i){function r(t,e,i){var r=t[e];t[e]=t[i],t[i]=r}e.exports=function t(e,i,o,n,a){for(;n>o;){if(n-o>600){var s=n-o+1,l=i-o+1,h=Math.log(s),d=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*d*(s-d)/s)*(l-s/2<0?-1:1),u=Math.max(o,Math.floor(i-l*d/s+c)),f=Math.min(n,Math.floor(i+(s-l)*d/s+c));t(e,i,u,f,a)}var g=e[i],p=o,v=n;for(r(e,o,i),a(e[n],g)>0&&r(e,o,n);p<v;){for(r(e,p,v),p++,v--;a(e[p],g)<0;)p++;for(;a(e[v],g)>0;)v--}0===a(e[o],g)?r(e,o,v):r(e,++v,n),v<=i&&(o=v+1),i<=v&&(n=v-1)}}},{}]},{},[1])(1)}),function(t){function e(){if(1==arguments.length){var t=arguments[0];this.header={idLength:i((n=t).idLength,0),colorMapType:i(n.colorMapType,0),imageType:i(n.imageType,e.Type.RGB),colorMapIndex:i(n.colorMapIndex,0),colorMapLength:i(n.colorMapLength,0),colorMapDepth:i(n.colorMapDepth,0),offsetX:i(n.offsetX,0),offsetY:i(n.offsetY,0),width:i(n.width,0),height:i(n.height,0),pixelDepth:i(n.pixelDepth,32),flags:i(n.flags,8)},r(this.header),o(this.header)}var n}function i(t,e){return void 0!==t?t:e}function r(t){t.hasEncoding=t.imageType===e.Type.RLE_INDEXED||t.imageType===e.Type.RLE_RGB||t.imageType===e.Type.RLE_GREY,t.hasColorMap=t.imageType===e.Type.RLE_INDEXED||t.imageType===e.Type.INDEXED,t.isGreyColor=t.imageType===e.Type.RLE_GREY||t.imageType===e.Type.GREY,t.bytePerPixel=t.pixelDepth>>3,t.origin=(t.flags&e.Origin.MASK)>>e.Origin.SHIFT,t.alphaBits=t.flags&e.Origin.ALPHA}function o(t){if(t.imageType===e.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(t.hasColorMap){if(t.colorMapLength>256||1!==t.colorMapType)throw new Error("Targa::checkHeader() - Unsupported colormap for indexed type");if(16!==t.colorMapDepth&&24!==t.colorMapDepth&&32!==t.colorMapDepth)throw new Error("Targa::checkHeader() - Unsupported colormap depth")}else if(t.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(t.width<=0||t.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==t.pixelDepth&&16!==t.pixelDepth&&24!==t.pixelDepth&&32!==t.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+t.pixelDepth+'"');if(0!==t.alphaBits&&1!==t.alphaBits&&8!==t.alphaBits)throw new Error("Targa::checkHeader() - Unsuppported alpha size")}function n(t,e,i,r,o,n,a,s,l,h){var d,c,u,f,g,p,v=this.header.colorMapDepth>>3;for(f=0,p=o;p!==a;p+=n)for(g=s;g!==h;g+=l,f++)u=4*(g+r*p),c=e[f]*v,4===v?(t[u]=i[c+2],t[u+1]=i[c+1],t[u+2]=i[c],t[u+3]=i[c+3]):3===v?(t[u]=i[c+2],t[u+1]=i[c+1],t[u+2]=i[c],t[u+3]=255):2===v&&(d=i[c]|i[c+1]<<8,t[u]=(31744&d)>>7,t[u+1]=(992&d)>>2,t[u+2]=(31&d)<<3,t[u+3]=32768&d?0:255);return t}function a(t,e,i,r,o,n,a,s,l,h){var d,c,u,f,g;for(u=0,g=o;g!==a;g+=n)for(f=s;f!==h;f+=l,u+=2)d=e[u]|e[u+1]<<8,t[c=4*(f+r*g)]=(31744&d)>>7,t[c+1]=(992&d)>>2,t[c+2]=(31&d)<<3,t[c+3]=32768&d?0:255;return t}function s(t,e,i,r,o,n,a,s,l,h){var d,c,u,f,g=this.header.pixelDepth>>3;for(c=0,f=o;f!==a;f+=n)for(u=s;u!==h;u+=l,c+=g)t[(d=4*(u+r*f))+3]=255,t[d+2]=e[c],t[d+1]=e[c+1],t[d]=e[c+2];return t}function l(t,e,i,r,o,n,a,s,l,h){var d,c,u,f;for(d=0,u=o;u!==a;u+=n)for(c=s;c!==h;c+=l,d+=4)t[(f=4*(c+r*u))+2]=e[d],t[f+1]=e[d+1],t[f]=e[d+2],t[f+3]=e[d+3];return t}function h(t,e,i,r,o,n,a,s,l,h){var d,c,u,f,g;for(d=0,u=o;u!==a;u+=n)for(c=s;c!==h;c+=l,d+=4)f=4*(c+r*u),g=255*e[d+3],t[f+2]=e[d]/g,t[f+1]=e[d+1]/g,t[f]=e[d+2]/g,t[f+3]=e[d+3];return t}function d(t,e,i,r,o,n,a,s,l,h){var d,c,u,f,g;for(u=0,g=o;g!==a;g+=n)for(f=s;f!==h;f+=l,u++)d=e[u],t[c=4*(f+r*g)]=d,t[c+1]=d,t[c+2]=d,t[c+3]=255;return t}function c(t,e,i,r,o,n,a,s,l,h){var d,c,u,f,g;for(u=0,g=o;g!==a;g+=n)for(f=s;f!==h;f+=l,u+=2)d=e[u],t[c=4*(f+r*g)]=d,t[c+1]=d,t[c+2]=d,t[c+3]=e[u+1];return t}function u(t){var i=t.byteLength-e.FOOTER_SIZE,r=e.SIGNATURE,o={},n=new Uint8Array(t.buffer,i+8,r.length);return function(t){for(var i=e.SIGNATURE,r=0;r<i.length;r++)if(t.charCodeAt(r)!==i.charCodeAt(r))return!1;return!0}(String.fromCharCode.apply(null,n))?(o.hasFooter=!0,o.extensionOffset=t.getUint32(i,e.LITTLE_ENDIAN),o.developerOffset=t.getUint32(i+4,e.LITTLE_ENDIAN),o.hasExtensionArea=0!==o.extensionOffset,o.hasDeveloperArea=0!==o.developerOffset,o.extensionOffset&&(o.attributeType=t.getUint8(o.extensionOffset+494)),o):(o.hasFooter=!1,o)}e.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},e.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48,ALPHA:8},e.HEADER_SIZE=18,e.FOOTER_SIZE=26,e.LITTLE_ENDIAN=!0,e.RLE_BIT=128,e.RLE_MASK=127,e.RLE_PACKET=1,e.RAW_PACKET=2,e.SIGNATURE="TRUEVISION-XFILE.\0",e.prototype.open=function(t,e){var i,r=this;(i=new XMLHttpRequest).open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){200===this.status&&(r.arrayBuffer=i.response,r.load(r.arrayBuffer),e&&e.call(r))},i.send(null)},e.prototype.load=function(t){var i=new DataView(t);this.headerData=new Uint8Array(t,0,e.HEADER_SIZE),this.header=function(t){var i=e.LITTLE_ENDIAN;if(t.byteLength<18)throw new Error("Targa::load() - Not enough data to contain header");var r={};return r.idLength=t.getUint8(0),r.colorMapType=t.getUint8(1),r.imageType=t.getUint8(2),r.colorMapIndex=t.getUint16(3,i),r.colorMapLength=t.getUint16(5,i),r.colorMapDepth=t.getUint8(7),r.offsetX=t.getUint16(8,i),r.offsetY=t.getUint16(10,i),r.width=t.getUint16(12,i),r.height=t.getUint16(14,i),r.pixelDepth=t.getUint8(16),r.flags=t.getUint8(17),r}(i),r(this.header),o(this.header);var n=e.HEADER_SIZE;if((n+=this.header.idLength)>=t.byteLength)throw new Error("Targa::load() - No data");if(this.header.hasColorMap){var a=this.header.colorMapLength*(this.header.colorMapDepth>>3);this.palette=new Uint8Array(t,n,a),n+=a}var s=this.header.pixelDepth>>3,l=this.header.width*this.header.height,h=l*s;if(this.header.hasEncoding){var d=t.byteLength-n-e.FOOTER_SIZE,c=new Uint8Array(t,n,d);this.imageData=function(t,i,r){var o,n,a,s,l,h,d;for(d=new Uint8Array(r),h=new Uint8Array(i),l=0,o=0;o<r;)if(a=1+((n=t[l++])&e.RLE_MASK),n&e.RLE_BIT){for(s=0;s<i;++s)h[s]=t[l++];for(s=0;s<a;++s)d.set(h,o),o+=i}else for(a*=i,s=0;s<a;++s)d[o++]=t[l++];if(o>r)throw new Error("Targa::decodeRLE() - Read bytes: "+o+" Expected bytes: "+r);return d}(c,s,h)}else this.imageData=new Uint8Array(t,n,this.header.hasColorMap?l:h);this.footer=u(i),(0!==this.header.alphaBits||this.footer.hasExtensionArea&&(3===this.footer.attributeType||4===this.footer.attributeType))&&(this.footer.usesAlpha=!0)},e.prototype.getImageData=function(t){var i,r,o,u,f,g,p,v=this.header.width,y=this.header.height,m=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;switch(t||(t=document?document.createElement("canvas").getContext("2d").createImageData(v,y):{width:v,height:y,data:new Uint8ClampedArray(v*y*4)}),m===e.Origin.TOP_LEFT||m===e.Origin.TOP_RIGHT?(u=0,f=1,g=y):(u=y-1,f=-1,g=-1),m===e.Origin.TOP_LEFT||m===e.Origin.BOTTOM_LEFT?(i=0,r=1,o=v):(i=v-1,r=-1,o=-1),this.header.pixelDepth){case 8:p=this.header.isGreyColor?d:n;break;case 16:p=this.header.isGreyColor?c:a;break;case 24:p=s;break;case 32:p=this.footer.hasExtensionArea?3===this.footer.attributeType?l:4===this.footer.attributeType?h:s:0!==this.header.alphaBits?l:s}return p.call(this,t.data,this.imageData,this.palette,v,u,f,g,i,r,o),t},e.prototype.setImageData=function(t){if(!t)throw new Error("Targa::setImageData() - imageData argument missing");var i,r,o,n,a,s,h=this.header.width,d=this.header.height,c=h*d*(this.header.pixelDepth>>3),u=(this.header.flags&e.Origin.MASK)>>e.Origin.SHIFT;u===e.Origin.TOP_LEFT||u===e.Origin.TOP_RIGHT?(n=0,a=1,s=d):(n=d-1,a=-1,s=-1),u===e.Origin.TOP_LEFT||u===e.Origin.BOTTOM_LEFT?(i=0,r=1,o=h):(i=h-1,r=-1,o=-1),this.imageData||(this.imageData=new Uint8Array(c)),l(this.imageData,t.data,this.palette,h,n,a,s,i,r,o);var f=this.imageData;this.header.hasEncoding&&(f=function(t,i){for(var r,o,n,a,s=i,l=[],h=0,d=t.pixelDepth>>3,c=0,u=t.width*t.height*d,f=function(t,e){for(var i=0;i<d;i++)if(s[t*d+i]!==s[e*d+i])return!1;return!0},g=function(t){return f(t,t+1)?e.RLE_PACKET:e.RAW_PACKET};h*d<s.length&&h*d<u;){if(n=0,(o=g(h))===e.RLE_PACKET)for(;h+n<s.length&&n<128&&f(h,h+n);)n++;else for(;h+n<s.length&&n<128&&g(h+n)===e.RAW_PACKET;)n++;if(a=n-1,o===e.RLE_PACKET&&(a|=e.RLE_BIT),l[c++]=a,o===e.RLE_PACKET){for(r=0;r<d;r++)l[r+c]=s[r+h*d];c+=d}else{for(r=0;r<d*n;r++)l[r+c]=s[r+h*d];c+=d*n}h+=n}return new Uint8Array(l)}(this.header,f));var g=e.HEADER_SIZE+f.length+e.FOOTER_SIZE,p=new ArrayBuffer(g);this.arrayBuffer=p,this.headerData=new Uint8Array(p,0,e.HEADER_SIZE),this.RLEData=new Uint8Array(p,e.HEADER_SIZE,f.length),this.footerData=new Uint8Array(p,e.HEADER_SIZE+f.length,e.FOOTER_SIZE);var v,y,m,x=new DataView(this.headerData.buffer);v=this.header,y=x,m=e.LITTLE_ENDIAN,y.setUint8(0,v.idLength),y.setUint8(1,v.colorMapType),y.setUint8(2,v.imageType),y.setUint16(3,v.colorMapIndex,m),y.setUint16(5,v.colorMapLength,m),y.setUint8(7,v.colorMapDepth),y.setUint16(8,v.offsetX,m),y.setUint16(10,v.offsetY,m),y.setUint16(12,v.width,m),y.setUint16(14,v.height,m),y.setUint8(16,v.pixelDepth),y.setUint8(17,v.flags),this.RLEData.set(f),function(t){for(var i=e.SIGNATURE,r=t.byteLength-i.length,o=0;o<i.length;o++)t[r+o]=i.charCodeAt(o)}(this.footerData)},e.prototype.getCanvas=function(){var t,e,i;return i=(e=(t=document.createElement("canvas")).getContext("2d")).createImageData(this.header.width,this.header.height),t.width=this.header.width,t.height=this.header.height,e.putImageData(this.getImageData(i),0,0),t},e.prototype.getDataURL=function(t){return this.getCanvas().toDataURL(t||"image/png")},e.prototype.getBlobURL=function(){if(!this.arrayBuffer)throw new Error("Targa::getBlobURL() - No data available for blob");var t=new Blob([this.arrayBuffer],{type:"image/x-tga"});return URL.createObjectURL(t)};var f={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return e}):f.exports="undefined"!=typeof window?window:t:f.exports=exports,f.exports&&(f.exports.TGA=e)}(this);var Mago3D=function(){var t=function(){this._events={}};t.prototype.on=function(t,e,i){return this._events[t]||(this._events[t]=[]),this._events[t].push({fn:e,once:i}),this},t.prototype.once=function(t,e){return this.on(t,e,!0)},t.prototype.emit=function(t){var e=this._events[t],i=[];if(e){for(var r=arguments.length,o=Array(r>1?r-1:0),n=1;n<r;n++)o[n-1]=arguments[n];for(var a=0,s=s=e;;){if(a>=s.length)break;var l=s[a++];l.fn&&"function"==typeof l.fn&&l.fn.apply(this,o),l.once&&i.push(a-1)}}if(i.length>0&&Array.isArray(e))for(var h=i.length-1;h>=0;h--)e.splice(i[h],1);return this},t.prototype.off=function(t,e){if(!this._events||0===arguments.length)return this._events={},this;var i=this._events[t];if(!i)return this;if(1===arguments.length)return delete this._events[t],this;for(var r=0;r<i.length;r++){if(i[r].fn===e){i.splice(r,1);break}}return this};var e=function(t){this.objectsArray=[],this.id,this.name,this.owner,this.attributes={isVisible:!0},this.tMat,this.tMatOriginal,this.geoLocDataManager,this.dirty=!0,this.color4,this.wireframeColor4,this.selectedColor4,this.objectType=e.OBJECT_TYPE.MESH,this.eventObject={},this.options=t,void 0!==t&&t.color&&t.color instanceof _&&(this.color4=t.color)};e.EVENT_TYPE={RENDER_END:"renderEnd",RENDER_START:"renderStart",MOVE_END:"moveEnd",MOVE_START:"moveStart"},e.OBJECT_TYPE={MESH:0,VECTORMESH:1,POINTMESH:2},e.prototype.addEventListener=function(t){if(!t instanceof Q)throw new Error("args event must MagoEvent!");var i=t.getType();if(!e.EVENT_TYPE[i])throw new Error("this type is not support.");this.eventObject[i]||(this.eventObject[i]=[]),this.eventObject[i].push(t)},e.prototype.dispatchEvent=function(t,i){if(!e.EVENT_TYPE[t])throw new Error("this type is not support.");var r=this.eventObject[t];if(r&&Array.isArray(r))for(var o=0,n=r.length;o<n;o++){var a=r[o].getListener();"function"==typeof a&&a.apply(this,[this,i])}},e.prototype.init=function(t){var e=t.vboMemoryManager;this.deleteObjects(e),this instanceof Ji&&(this.knotGeoCoordsArray.length=0),this.setDirty(!0)},e.prototype.deleteObjects=function(t){this.texture&&this.texture.deleteObjects(t.gl);for(var e=this.objectsArray.length,i=0;i<e;i++)this.objectsArray[i].deleteObjects(t),this.objectsArray[i]=void 0;this.objectsArray.length=0},e.prototype.getRootOwner=function(){return void 0===this.owner?this:this.owner.getRootOwner()},e.prototype.getObject=function(t){if(t>this.objectsArray.length-1)throw new Error("out of bound range.");return this.objectsArray[t]},e.prototype.render=function(t,e,i,r,o){if(this.attributes){if(void 0!==this.attributes.isVisible&&!1===this.attributes.isVisible)return;if(2===i&&void 0!==this.attributes.isSelectable&&!1===this.attributes.isSelectable)return}if(this.dirty&&this.makeMesh(t),0===this.objectsArray.length)return!1;var n=t.getGl();void 0!==this.attributes.opacity&&n.uniform1f(e.externalAlpha_loc,this.attributes.opacity),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e);var a=!0;if(this.options&&!1===this.options.renderShaded&&(a=!1),n.uniform1i(e.bApplySpecularLighting_loc,!1),a&&this.renderAsChild(t,e,i,r,o,this.options),n.uniform1f(e.externalAlpha_loc,1),n.uniform1i(e.bApplySpecularLighting_loc,!1),this.options&&this.options.renderWireframe){var s=t.postFxShadersManager.getShader("thickLine");s.useProgram(),s.bindUniformGenerals(),(n=t.getGl()).uniform1i(s.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),n.disable(n.CULL_FACE),n.enableVertexAttribArray(s.prev_loc),n.enableVertexAttribArray(s.current_loc),n.enableVertexAttribArray(s.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,s);var l=t.sceneState,h=l.drawingBufferWidth,d=l.drawingBufferHeight;this.wireframeColor4?n.uniform4fv(s.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):n.uniform4fv(s.oneColor4_loc,[.6,.8,.9,1]),n.uniform2fv(s.viewport_loc,[h[0],d[0]]);this.renderAsChild(t,s,i,r,o,this.options,!0),e.useProgram()}},e.prototype.renderAsChild=function(t,e,i,r,o,n,a){this.dirty&&this.makeMesh(t);var s=t.getGl();if(0===i);else if(1===i){if(s.enable(s.BLEND),s.uniform1i(e.colorType_loc,0),t.selectionManager.isObjectSelected(this)&&(o=!0),o){var l=[.9,.1,.1,1];if(a)l=[.6,.6,.99,1];else if(this.attributes.selectedColor4){var h=this.attributes.selectedColor4;l=[h.r,h.g,h.b,h.a]}s.uniform4fv(e.oneColor4_loc,l)}else a?this.wireframeColor4&&s.uniform4fv(e.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):this.color4&&s.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}else if(2===i){var d=t.selectionColor,c=d.getAvailableColor(void 0),u=d.decodeColor3(c.r,c.g,c.b);t.selectionManager.setCandidateGeneral(u,this),s.uniform4fv(e.oneColor4_loc,[c.r/255,c.g/255,c.b/255,1]),s.disable(s.BLEND)}this.tMat&&s.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays);for(var f=this.objectsArray.length,g=0;g<f;g++){var p=this.objectsArray[g];if(p instanceof Ye){var v;if(0===i)continue;1!==i&&2!==i||(v=t.postFxShadersManager.getShader("thickLine")),t.postFxShadersManager.useProgram(v),v.bindUniformGenerals(),(s=t.getGl()).uniform1i(v.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),s.disable(s.CULL_FACE),s.enableVertexAttribArray(v.prev_loc),s.enableVertexAttribArray(v.current_loc),s.enableVertexAttribArray(v.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(s,v);var y=t.sceneState,m=y.drawingBufferWidth,x=y.drawingBufferHeight;this.wireframeColor4?s.uniform4fv(v.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):s.uniform4fv(v.oneColor4_loc,[.2,.4,.9,1]),s.uniform2fv(v.viewport_loc,[m[0],x[0]]),p.renderAsChild(t,v,i,r,o,n,a),t.postFxShadersManager.useProgram(e)}else if(p instanceof Ue){var b;0===i?b=t.postFxShadersManager.getShader("pointsCloudDepth"):1!==i&&2!==i||(b=t.postFxShadersManager.getShader("pointsCloud")),t.postFxShadersManager.useProgram(b),b.disableVertexAttribArrayAll(),b.resetLastBuffersBinded(),b.enableVertexAttribArray(b.position3_loc),b.bindUniformGenerals(),this.geoLocDataManager.getCurrentGeoLocationData().bindSplitedPositionUniforms(s,b),s.uniform1i(b.bPositionCompressed_loc,!1),s.uniform1i(b.bUse1Color_loc,!0),s.uniform1i(b.bUseFixPointSize_loc,1),s.uniform1i(b.uStrokeSize_loc,this.style.strokeSize),s.depthRange(0,0),p.renderAsChild(t,b,i,r,o,n,a),s.depthRange(0,1),t.postFxShadersManager.useProgram(e)}else p.renderAsChild(t,e,i,r,o,n,a)}s.disable(s.BLEND),this.dispatchEvent("RENDER_END",t)},e.prototype.makeMesh=function(t){return Ai()},e.prototype.moved=function(){},e.prototype.updateMatrix=function(t){if(t)this.tMat=this.tMatOriginal.getMultipliedByMatrix(t,this.tMat);else{if(void 0===this.geoLocDataManager||null===this.geoLocDataManager)return;var i=this.geoLocDataManager.getCurrentGeoLocationData();this.tMat=i.rotMatrix}if(void 0!==this.objectsArray)for(var r=0,o=this.objectsArray.length;r<o;++r){this.objectsArray[r]instanceof e&&this.objectsArray[r].updateMatrix(this.tMat)}},e.prototype.setDirty=function(t){this.dirty=t},e.prototype.setOneColor=function(t,e,i,r){void 0===this.color4&&(this.color4=new _),this.color4.setRGBA(t,e,i,r),r<1&&this.setOpaque(!1)},e.prototype.setWireframeColor=function(t,e,i,r){void 0===this.wireframeColor4&&(this.wireframeColor4=new _),this.wireframeColor4.setRGBA(t,e,i,r),r<1&&this.setOpaque(!1)},e.prototype.setOpaque=function(t){this.attributes.opaque=t},e.prototype.isOpaque=function(){return void 0===this.attributes.opaque||this.attributes.opaque},e.prototype.getGeoLocDataManager=function(){return this.geoLocDataManager};var i=function(t,e){if(!t||!document.getElementById(t))throw new Error("containerId is required.");f.init(e,null,null),this.targetId=t,this.magoManager,this.viewer,this.policy=f.getPolicy(),f.setContainerId(this.targetId),this.init()};i.prototype.init=function(){return Ai()},i.prototype.initMagoManager=function(){return Ai()},i.prototype.setEventHandler=function(){return Ai()},i.prototype.initPosition=function(){if(this.policy.initCameraEnable){var t=parseFloat(this.policy.initLongitude),e=parseFloat(this.policy.initLatitude),i=parseFloat(this.policy.initAltitude),r=parseInt(this.policy.initDuration);if(isNaN(t)||isNaN(e)||isNaN(i))throw new Error("Longitude, Latitude, Height must number type.");isNaN(r)&&(r=3),this.magoManager.flyTo(t,e,i,r)}};var r={changeColor:function(t,e){var i=t.getProjectId(),r=t.getDataKey(),o=t.getObjectIds(),n=t.getProperty(),a=null,s=null;if(null!==n&&""!==n){var l=n.split("=");a=l[0],s=l[1]}var h=t.getColor();if(void 0!==h&&0!==h){var c=t.getColor().split(","),u=255;4===c.length&&(u=c[3]/255);var g=[c[0]/255,c[1]/255,c[2]/255,u],p=!1;null!==o&&0!==o.length&&(p=!0);var v=[];if(p)for(var y=0,m=o.length;y<m;y++){var x;(x=new d).setProjectId(i),x.setDataKey(r),x.setObjectId(o[y]),x.setProperty(n),x.setPropertyKey(a),x.setPropertyValue(s),x.setColor(g),v.push(x)}else(x=new d).setProjectId(i),x.setDataKey(r),x.setObjectId(null),x.setProperty(n),x.setPropertyKey(a),x.setPropertyValue(s),x.setColor(g),v.push(x);var b=v.length;for(y=0;y<b;y++)x=v[y],f.saveColorHistory(i,r,x.getObjectId(),x)}}},o={drawAppendData:function(t,e){e.getObjectIndexFile(t.getProjectId(),t.getProjectDataFolder())},drawInsertIssueImage:function(t,e){void 0!==e.objMarkerSC&&0!==t.getDrawType()||(e.objMarkerSC=new st,e.objMarkerSC.geoLocationData.geographicCoord=new j,Ei.calculateGeoLocationData(parseFloat(t.getLongitude()),parseFloat(t.getLatitude()),parseFloat(t.getElevation()),void 0,void 0,void 0,e.objMarkerSC.geoLocationData,e));var i=e.objMarkerManager.newObjectMarker({imageFilePath:"defaultRed",sizeX:64,sizeY:64});e.objMarkerSC.issue_id=t.getIssueId(),e.objMarkerSC.issue_type=t.getIssueType(),e.objMarkerSC.geoLocationData.geographicCoord.setLonLatAlt(parseFloat(t.getLongitude()),parseFloat(t.getLatitude()),parseFloat(t.getElevation())),i.copyFrom(e.objMarkerSC),e.objMarkerSC=void 0}},n={changeLocationAndRotation:function(t,e){var i=new d;i.setProjectId(t.getProjectId()),i.setDataKey(t.getDataKey()),i.setLatitude(parseFloat(t.getLatitude())),i.setLongitude(parseFloat(t.getLongitude())),i.setElevation(parseFloat(t.getElevation())),i.setHeading(parseFloat(t.getHeading())),i.setPitch(parseFloat(t.getPitch())),i.setRoll(parseFloat(t.getRoll()));var r=t.getLatitude(),o=t.getLongitude(),n=t.getElevation(),a=t.getHeading(),s=t.getPitch(),l=t.getRoll();e.changeLocationAndRotation(t.getProjectId(),t.getDataKey(),r,o,n,a,s,l,t.getAnimationOption())}},a={changeLod:function(t,e){null!==t.getLod0DistInMeters()&&""!==t.getLod0DistInMeters()&&e.magoPolicy.setLod0DistInMeters(t.getLod0DistInMeters()),null!==t.getLod1DistInMeters()&&""!==t.getLod1DistInMeters()&&e.magoPolicy.setLod1DistInMeters(t.getLod1DistInMeters()),null!==t.getLod2DistInMeters()&&""!==t.getLod2DistInMeters()&&e.magoPolicy.setLod2DistInMeters(t.getLod2DistInMeters()),null!==t.getLod3DistInMeters()&&""!==t.getLod3DistInMeters()&&e.magoPolicy.setLod3DistInMeters(t.getLod3DistInMeters()),null!==t.getLod4DistInMeters()&&""!==t.getLod4DistInMeters()&&e.magoPolicy.setLod4DistInMeters(t.getLod4DistInMeters()),null!==t.getLod5DistInMeters()&&""!==t.getLod5DistInMeters()&&e.magoPolicy.setLod5DistInMeters(t.getLod5DistInMeters())}},s=function(t){if(!(this instanceof s))throw new Error(ot.CONSTRUCT_ERROR);this.effectsManager,this.birthData,this.durationSeconds,this.effectType="unknown",t&&(t.effectType&&(this.effectType=t.effectType),t.durationSeconds&&(this.durationSeconds=t.durationSeconds),t.zVelocity&&(this.zVelocity=t.zVelocity),t.zMax&&(this.zMax=t.zMax),t.zMin&&(this.zMin=t.zMin))};s.prototype.execute=function(t){var e=!1;if(void 0===this.birthData)return this.birthData=t,e;var i=t-this.birthData,r=this.effectsManager.gl;if("zBounceSpring"===this.effectType){var o=1;if(i>=this.durationSeconds)o=1,e=!0;else{var n=5/this.durationSeconds,a=i;o=(1-(o=1*Math.pow(Math.E,-.1*a)*(Math.cos(n*a+0)+Math.sin(n*a+0))))*Math.log(a/this.durationSeconds+1.1)}return r.uniform3fv(this.effectsManager.currShader.scaleLC_loc,[1,1,o]),e}if("zBounceLinear"===this.effectType){o=1;return i>=this.durationSeconds?(o=1,e=!0):o=i/this.durationSeconds,r.uniform3fv(this.effectsManager.currShader.scaleLC_loc,[1,1,o]),e}if("borningLight"===this.effectType){var s=1;if(i>=this.durationSeconds)s=1,e=!0;else{var l=i/this.durationSeconds;s=1/(l*l)}return r.uniform4fv(this.effectsManager.currShader.colorMultiplier_loc,[s,s,s,1]),e}if("zMovement"===this.effectType){if(void 0===this.zVelocity&&(this.zVelocity=1),void 0===this.zMax&&(this.zMax=1),void 0===this.zMin&&(this.zMin=-1),void 0===this.zOffset&&(this.zOffset=0),void 0===this.lastTime&&(this.lastTime=t),i>=this.durationSeconds)this.zOffset=0,e=!0;else{var h=t-this.lastTime;if(this.zOffset+=this.zVelocity*h,this.zVelocity>0){if(this.zOffset>this.zMax){var d=this.zOffset-this.zMax;this.zOffset=this.zMax-d,this.zVelocity*=-1}}else if(this.zOffset<this.zMin){d=this.zOffset-this.zMin;this.zOffset=this.zMin-d,this.zVelocity*=-1}}return r.uniform3fv(this.effectsManager.currShader.aditionalOffset_loc,[0,this.zOffset,0]),this.lastTime=t,e}};var l=function(t){if(!(this instanceof l))throw new Error(ot.CONSTRUCT_ERROR);this.effectsObjectsMap={},this.gl,this.currShader};function h(t){if(!(this instanceof h))throw new Error(ot.CONSTRUCT_ERROR);this.magoEnable=!0,this.returnable=!1,this.apiName=t,this.projectId=null,this.projectDataFolder=null,this.objectIds=null,this.dataKey=null,this.issueId=null,this.issueType=null,this.drawType=0,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.property=null,this.color=0,this.blockType=null,this.showOutFitting=!1,this.showLabelInfo=!0,this.showOrigin=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarDistance=0,this.objectMoveMode=c.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.insertIssueState=0,this.lod0DistInMeters=null,this.lod1DistInMeters=null,this.lod2DistInMeters=null,this.lod3DistInMeters=null,this.lod4DistInMeters=null,this.lod5DistInMeters=null,this.ambientReflectionCoef=null,this.diffuseReflectionCoef=null,this.specularReflectionCoef=null,this.ambientColor=null,this.specularColor=null,this.ssaoRadius=null,this.FPVMode=!1,this.inputPoint=null,this.resultPoint=null,this.magoMode=c.magoMode.NORMAL,this.unit=c.units.DEGREE,this.instantiateObj=null,this.staticModelAttributeObj=null,this.animationOption=null,this.trackOption=null,this.nodeAttribute=null}l.prototype.setCurrentShader=function(t){this.currShader=t},l.prototype.getEffectsObject=function(t){return this.effectsObjectsMap[t]},l.prototype.hasEffects=function(t){return!!this.effectsObjectsMap[t]&&!(!this.effectsObjectsMap[t].effectsArray||0===this.effectsObjectsMap[t].effectsArray.length)},l.prototype.addEffect=function(t,e){var i=this.getEffectsObject(t);void 0===i&&(i={},this.effectsObjectsMap[t]=i),void 0===i.effectsArray&&(i.effectsArray=[]),e.effectsManager=this,i.effectsArray.push(e)},l.prototype.executeEffects=function(t,e){var i=this.getEffectsObject(t),r=!1;if(void 0===i)return!1;for(var o=i.effectsArray.length,n=0;n<o;n++){i.effectsArray[n].execute(e/1e3)&&(i.effectsArray.splice(n,1),o=i.effectsArray.length),r=!0,0===i.effectsArray.length&&(this.effectsObjectsMap[t]=void 0,delete this.effectsObjectsMap[t])}return r},h.prototype.getMagoEnable=function(){return this.magoEnable},h.prototype.setMagoEnable=function(t){this.magoEnable=t},h.prototype.getReturnable=function(){return this.returnable},h.prototype.setReturnable=function(t){this.returnable=t},h.prototype.getAPIName=function(){return this.apiName},h.prototype.getProjectId=function(){return this.projectId},h.prototype.setProjectId=function(t){this.projectId=t},h.prototype.getProjectDataFolder=function(){return this.projectDataFolder},h.prototype.setProjectDataFolder=function(t){this.projectDataFolder=t},h.prototype.getObjectIds=function(){return this.objectIds},h.prototype.setObjectIds=function(t){this.objectIds=t},h.prototype.getIssueId=function(){return this.issueId},h.prototype.setIssueId=function(t){this.issueId=t},h.prototype.getIssueType=function(){return this.issueType},h.prototype.setIssueType=function(t){this.issueId=t},h.prototype.getDataKey=function(){return this.dataKey},h.prototype.setDataKey=function(t){this.dataKey=t},h.prototype.getLatitude=function(){return this.latitude},h.prototype.setLatitude=function(t){this.latitude=t},h.prototype.getLongitude=function(){return this.longitude},h.prototype.setLongitude=function(t){this.longitude=t},h.prototype.getElevation=function(){return this.elevation},h.prototype.setElevation=function(t){this.elevation=t},h.prototype.getHeading=function(){return this.heading},h.prototype.setHeading=function(t){this.heading=t},h.prototype.getPitch=function(){return this.pitch},h.prototype.setPitch=function(t){this.pitch=t},h.prototype.getRoll=function(){return this.roll},h.prototype.setRoll=function(t){this.roll=t},h.prototype.getProperty=function(){return this.property},h.prototype.setProperty=function(t){this.property=t},h.prototype.getColor=function(){return this.color},h.prototype.setColor=function(t){this.color=t},h.prototype.getBlockType=function(){return this.blockType},h.prototype.setBlockType=function(t){this.blockType=t},h.prototype.getShowOutFitting=function(){return this.showOutFitting},h.prototype.setShowOutFitting=function(t){this.showOutFitting=t},h.prototype.getShowLabelInfo=function(){return this.showLabelInfo},h.prototype.setShowLabelInfo=function(t){this.showLabelInfo=t},h.prototype.getShowOrigin=function(){return this.showOrigin},h.prototype.setShowOrigin=function(t){this.showOrigin=t},h.prototype.getShowBoundingBox=function(){return this.showBoundingBox},h.prototype.setShowBoundingBox=function(t){this.showBoundingBox=t},h.prototype.getShowShadow=function(){return this.showShadow},h.prototype.setShowShadow=function(t){this.showShadow=t},h.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},h.prototype.setFrustumFarDistance=function(t){this.frustumFarDistance=t},h.prototype.getObjectMoveMode=function(){return this.objectMoveMode},h.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t},h.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},h.prototype.setIssueInsertEnable=function(t){this.issueInsertEnable=t},h.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},h.prototype.setObjectInfoViewEnable=function(t){this.objectInfoViewEnable=t},h.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},h.prototype.setOcclusionCullingEnable=function(t){this.occlusionCullingEnable=t},h.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},h.prototype.setNearGeoIssueListEnable=function(t){this.nearGeoIssueListEnable=t},h.prototype.getInsertIssueState=function(){return this.insertIssueState},h.prototype.setInsertIssueState=function(t){this.insertIssueState=t},h.prototype.getDrawType=function(){return this.drawType},h.prototype.setDrawType=function(t){this.drawType=t},h.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},h.prototype.setLod0DistInMeters=function(t){this.lod0DistInMeters=t},h.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},h.prototype.setLod1DistInMeters=function(t){this.lod1DistInMeters=t},h.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},h.prototype.setLod2DistInMeters=function(t){this.lod2DistInMeters=t},h.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},h.prototype.setLod3DistInMeters=function(t){this.lod3DistInMeters=t},h.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},h.prototype.setLod4DistInMeters=function(t){this.lod4DistInMeters=t},h.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},h.prototype.setLod5DistInMeters=function(t){this.lod5DistInMeters=t},h.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},h.prototype.setAmbientReflectionCoef=function(t){this.ambientReflectionCoef=t},h.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},h.prototype.setDiffuseReflectionCoef=function(t){this.diffuseReflectionCoef=t},h.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},h.prototype.setSpecularReflectionCoef=function(t){this.specularReflectionCoef=t},h.prototype.getAmbientColor=function(){return this.ambientColor},h.prototype.setAmbientColor=function(t){this.ambientColor=t},h.prototype.getSpecularColor=function(){return this.specularColor},h.prototype.setSpecularColor=function(t){this.specularColor=t},h.prototype.getSsaoRadius=function(){return this.ssaoRadius},h.prototype.setSsaoRadius=function(t){this.ssaoRadius=t},h.prototype.getFPVMode=function(){return this.FPVMode},h.prototype.setFPVMode=function(t){this.FPVMode=t},h.prototype.getMagoMode=function(){return this.magoMode},h.prototype.setMagoMode=function(t){this.magoMode=t},h.prototype.getDuration=function(){return this.duration},h.prototype.setDuration=function(t){this.duration=t},h.prototype.getInputPoint=function(){return this.inputPoint},h.prototype.setInputPoint=function(t){this.inputPoint=t},h.prototype.getResultPoint=function(){return this.resultPoint},h.prototype.setResultPoint=function(t){this.resultPoint=t},h.prototype.getUnit=function(){return this.unit},h.prototype.setUnit=function(t){if(void 0!==t){if(isNaN(t)||t>c.units.RADIAN)throw new Error("unit parameter needs CODE.units");this.unit=t}},h.prototype.getInstantiateObj=function(){return this.instantiateObj},h.prototype.setInstantiateObj=function(t){this.instantiateObj=t},h.prototype.getStaticModelAttributeObj=function(){return this.staticModelAttributeObj},h.prototype.setStaticModelAttributeObj=function(t){this.staticModelAttributeObj=t},h.prototype.getAnimationOption=function(){return this.animationOption},h.prototype.setAnimationOption=function(t){this.animationOption=t},h.prototype.getTrackOption=function(){return this.trackOption},h.prototype.setTrackOption=function(t){this.trackOption=t},h.prototype.getNodeAttribute=function(){return this.nodeAttribute},h.prototype.setNodeAttribute=function(t){this.nodeAttribute=t};var d=function(){if(!(this instanceof d))throw new Error(ot.CONSTRUCT_ERROR);this.moveHistory=!1,this.colorHistory=!1,this.rotationHistory=!1,this.objectMoveMode=null,this.projectId=null,this.projectDataFolder=null,this.dataKey=null,this.objectId=null,this.objectIndexOrder=0,this.refObjectAditionalMove,this.refObjectAditionalMoveRelToBuilding,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.color=0,this.rgbColor=[],this.property=null,this.propertyKey=null,this.propertyValue=null};d.prototype.getReferenceObjectAditionalMovement=function(){return void 0===this.refObjectAditionalMove&&(this.refObjectAditionalMove=new ur),this.refObjectAditionalMove},d.prototype.getReferenceObjectAditionalMovementRelToBuilding=function(){return void 0===this.refObjectAditionalMoveRelToBuilding&&(this.refObjectAditionalMoveRelToBuilding=new ur),this.refObjectAditionalMoveRelToBuilding},d.prototype.getProjectId=function(){return this.projectId},d.prototype.setProjectId=function(t){this.projectId=t},d.prototype.getProjectDataFolder=function(){return this.projectDataFolder},d.prototype.setProjectDataFolder=function(t){this.projectDataFolder=t},d.prototype.getDataKey=function(){return this.dataKey},d.prototype.setDataKey=function(t){this.dataKey=t},d.prototype.getObjectId=function(){return this.objectId},d.prototype.setObjectId=function(t){this.objectId=t},d.prototype.getObjectIndexOrder=function(){return this.objectIndexOrder},d.prototype.setObjectIndexOrder=function(t){this.objectIndexOrder=t},d.prototype.getLatitude=function(){return this.latitude},d.prototype.setLatitude=function(t){this.latitude=t},d.prototype.getLongitude=function(){return this.longitude},d.prototype.setLongitude=function(t){this.longitude=t},d.prototype.getElevation=function(){return this.elevation},d.prototype.setElevation=function(t){this.elevation=t},d.prototype.getHeading=function(){return this.heading},d.prototype.setHeading=function(t){this.heading=t},d.prototype.getPitch=function(){return this.pitch},d.prototype.setPitch=function(t){this.pitch=t},d.prototype.getRoll=function(){return this.roll},d.prototype.setRoll=function(t){this.roll=t},d.prototype.getColor=function(){return this.color},d.prototype.setColor=function(t){this.color=t},d.prototype.getRgbColor=function(){return this.rgbColor},d.prototype.setRgbColor=function(t){this.rgbColor=t},d.prototype.getProperty=function(){return this.property},d.prototype.setProperty=function(t){this.property=t},d.prototype.getPropertyKey=function(){return this.propertyKey},d.prototype.setPropertyKey=function(t){this.propertyKey=t},d.prototype.getPropertyValue=function(){return this.propertyValue},d.prototype.setPropertyValue=function(t){this.propertyValue=t},d.prototype.getDuration=function(){return this.duration},d.prototype.setDuration=function(t){this.duration=t},d.prototype.getObjectMoveMode=function(){return this.objectMoveMode},d.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t};var c={magoManagerState:{INIT:0,STARTED:1,READY:2},fileLoadState:{READY:0,LOADING_STARTED:1,LOADING_FINISHED:2,PARSE_STARTED:3,PARSE_FINISHED:4,IN_QUEUE:5,IN_PARSE_QUEUE:6,BINDING_STARTED:7,BINDING_FINISHED:8,LOAD_FAILED:9},moveMode:{ALL:"0",OBJECT:"1",GEOGRAPHICPOINTS:"2",NONE:"3"},magoMode:{NORMAL:0,DRAWING:1},magoCurrentProcess:{Unknown:0,DepthRendering:1,ColorRendering:2,ColorCodeRendering:3,DepthShadowRendering:4,SilhouetteDepthRendering:5,StencilSilhouetteRendering:6},modelerMode:{INACTIVE:0,DRAWING_POLYLINE:1,DRAWING_PLANEGRID:2,DRAWING_GEOGRAPHICPOINTS:3,DRAWING_EXCAVATIONPOINTS:4,DRAWING_TUNNELPOINTS:5,DRAWING_BSPLINE:6,DRAWING_BASICFACTORY:7,DRAWING_STATICGEOMETRY:8,DRAWING_PIPE:9,DRAWING_SPHERE:10,DRAWING_BOX:11,DRAWING_CUTTINGPLANE:12,DRAWING_CLIPPINGBOX:13,DRAWING_CONCENTRICTUBES:14,DRAWING_TUBE:15,DRAWING_FREECONTOURWALL:16,DRAWING_CYLYNDER:17},boxFace:{UNKNOWN:0,LEFT:1,RIGHT:2,FRONT:3,REAR:4,TOP:5,BOTTOM:6},modelerDrawingState:{NO_STARTED:0,STARTED:1},modelerDrawingElement:{NOTHING:0,POINTS:1,LINES:2,POLYLINES:3,GEOGRAPHICPOINTS:4},units:{METRE:0,DEGREE:1,RADIAN:2},trackMode:{TRACKING:0,DRIVER:1},movementType:{NO_MOVEMENT:0,TRANSLATION:1,ROTATION:2,ROTATION_ZX:3},imageryType:{UNKNOWN:0,CRS84:1,WEB_MERCATOR:2},animationType:{UNKNOWN:0,REALTIME_POINTS:1,PATH:2},relativePosition2D:{UNKNOWN:0,LEFT:1,RIGHT:2,COINCIDENT:3},imageFilter:{UNKNOWN:0,BATHYMETRY:1},cesiumTerrainType:{GEOSERVER:"geoserver",CESIUM_DEFAULT:"cesium-default",CESIUM_ION_DEFAULT:"cesium-ion-default",CESIUM_ION_CDN:"cesium-ion-cdn",CESIUM_CUSTOMER:"cesium-customer"},magoEarthTerrainType:{PLAIN:"plain",ELEVATION:"elevation",REALTIME:"realtime"},drawGeometryType:{POINT:"point",LINE:"line",POLYGON:"polygon",RECTANGLE:"rectangle"},PROJECT_ID_PREFIX:"projectId_",PROJECT_DATA_FOLDER_PREFIX:"projectDataFolder_",parametricCurveState:{NORMAL:0,EDITED:1}},u={CESIUM:"cesium",WORLDWIND:"worldwind",MAGOWORLD:"magoworld",OBJECT_INDEX_FILE:"/objectIndexFile.ihe",TILE_INDEX_FILE:"/smartTile_f4d_indexFile.sii",CACHE_VERSION:"?cache_version=",SIMPLE_BUILDING_TEXTURE3x3_BMP:"/SimpleBuildingTexture3x3.bmp",RESULT_XDO2F4D:"/Result_xdo2f4d/Images/",RESULT_XDO2F4D_TERRAINTILES:"/Result_xdo2f4d/F4D_TerrainTiles/",RESULT_XDO2F4D_TERRAINTILEFILE_TXT:"/Result_xdo2f4d/f4dTerranTileFile.txt",INTERSECTION_OUTSIDE:0,INTERSECTION_INTERSECT:1,INTERSECTION_INSIDE:2,INTERSECTION_POINT_A:3,INTERSECTION_POINT_B:4},f={setContainerId:function(t){this.containerId=t},getContainerId:function(){return this.containerId},getPolicy:function(){return this.serverPolicy},getGeoserver:function(){return this.geoserver},getData:function(t){return this.dataObject[t]},isDataExist:function(t){return this.dataObject.hasOwnProperty(t)},deleteData:function(t){return delete this.dataObject[t]},setData:function(t,e){this.isDataExist(t)||(this.dataObject[t]=e)},getProjectDataFolder:function(t){var e=c.PROJECT_DATA_FOLDER_PREFIX+t;return this.dataObject[e]},isProjectDataFolderExist:function(t){var e=c.PROJECT_DATA_FOLDER_PREFIX+t;return this.dataObject.hasOwnProperty(e)},deleteProjectDataFolder:function(t){var e=c.PROJECT_DATA_FOLDER_PREFIX+t;return delete this.dataObject[e]},setProjectDataFolder:function(t,e){var i=c.PROJECT_DATA_FOLDER_PREFIX+t;this.isProjectDataFolderExist(i)||(this.dataObject[i]=e)},init:function(t,e,i){if(!t||!t instanceof Object)throw new Error("geopolicy is required object.");if(this.dataObject={},this.selectHistoryObject={},this.movingHistoryObject={},this.colorHistoryObject={},this.locationAndRotationHistoryObject={},this.serverPolicy=t,this.scriptRootPath=function(){for(var t,e=/((?:.*\/)|^)mago3d\.js\?(?:&?[^=&]*=[^=&]*)*/,i=/((?:.*\/)|^)mago3d\.js$/,r=document.getElementsByTagName("script"),o=0,n=r.length;o<n;++o){var a=r[o].getAttribute("src"),s=i.exec(a),l=e.exec(a),h=s||l;null!==h&&(t=h[1])}return t}(),this.twoDimension=!1,this.serverPolicy.geoserverEnable){this.geoserver=new be;var r={wmsVersion:this.serverPolicy.geoserverWmsVersion,dataUrl:this.serverPolicy.geoserverDataUrl,dataWorkspace:this.serverPolicy.geoserverDataWorkspace,dataStore:this.serverPolicy.geoserverDataStore,user:this.serverPolicy.geoserverUser,password:this.serverPolicy.geoserverPassword};this.geoserver.setServerInfo(r)}if(e&&e.length>0)for(var o=0;o<e.length;o++)this.isDataExist(c.PROJECT_ID_PREFIX+e[o])||(this.setData(c.PROJECT_ID_PREFIX+e[o],i[o]),this.setProjectDataFolder(c.PROJECT_DATA_FOLDER_PREFIX+i[o].data_key,i[o].data_key))},clearAllData:function(){this.dataObject={}},clearSelectHistory:function(){this.selectHistoryObject={}},getAllSelectHistory:function(){return this.selectHistoryObject},getSelectHistoryObjects:function(t,e){var i=this.selectHistoryObject[t];if(void 0!==i)return i[e]},getSelectHistoryObject:function(t,e,i){var r=this.selectHistoryObject[t];if(void 0!==r){var o=r[e];if(void 0!==o)return o[i]}},saveSelectHistory:function(t,e,i,r){var o=this.selectHistoryObject.get(t);void 0===o&&(o={},this.selectHistoryObject[t]=o);var n=o[e];void 0===n&&(n={},o[e]=n),n[i]=r},deleteSelectHistoryObject:function(t,e,i){var r=this.selectHistoryObject[t];if(void 0!==r){var o=r[e];if(void 0!==o)return delete o[i]}},clearMovingHistory:function(){this.movingHistoryObject={}},getAllMovingHistory:function(){return this.movingHistoryObject},getMovingHistoryObjects:function(t,e){var i=this.movingHistoryObject[t];if(void 0!==i)return i[e]},getMovingHistoryObject:function(t,e,i){var r=this.movingHistoryObject[t];if(void 0!==r){var o=r[e];if(void 0!==o)return o[i]}},saveMovingHistory:function(t,e,i,r){var o=this.movingHistoryObject[t];void 0===o&&(o={},this.movingHistoryObject[t]=o);var n=o[e];void 0===n&&(n={},o[e]=n),n[i]=r},deleteMovingHistoryObject:function(t,e,i){var r=this.movingHistoryObject[t];if(void 0!==r){var o=r[e];if(void 0!==o)return delete o[i]}},getAllColorHistory:function(){return this.colorHistoryObject},clearColorHistory:function(){this.colorHistoryObject={}},getColorHistorys:function(t,e){var i=this.colorHistoryObject[t];if(void 0!==i)return i[e]},getColorHistory:function(t,e,i){var r=this.colorHistoryObject[t];if(void 0!==r){var o=r[e];if(void 0!==o)return o[i]}},saveColorHistory:function(t,e,i,r){var o=this.colorHistoryObject[t];void 0===o&&(o={},this.colorHistoryObject[t]=o);var n=o[e];void 0===n&&(n={},o[e]=n),null===i||""===i?n[e]=r:n[i]=r},deleteColorHistory:function(t,e,i){var r=this.colorHistoryObject[t];if(void 0!==r){var o=r[e];if(void 0!==o)return delete o[i]}}};f.clearColorHistory=function(){this.colorHistoryObject={}},f.getAllLocationAndRotationHistory=function(){return this.locationAndRotationHistoryObject},f.getLocationAndRotationHistorys=function(t,e){var i=this.locationAndRotationHistoryObject[t];if(void 0!==i)return i[e]},f.getLocationAndRotationHistory=function(t,e){var i=this.locationAndRotationHistoryObject[t];if(void 0!==i)return i[e]},f.saveLocationAndRotationHistory=function(t,e,i){var r=this.locationAndRotationHistoryObject[t];void 0===r&&(r={},this.locationAndRotationHistoryObject[t]=r);var o=r[e];void 0===o&&(o={}),o[e]=i},f.deleteLocationAndRotationHistory=function(t,e){var i=this.locationAndRotationHistoryObject[t];if(void 0!==i)delete i[e]},f.clearLocationAndRotationHistory=function(){this.locationAndRotationHistoryObject={}},f.setTwoDimension=function(t){this.twoDimension=t},f.isTwoDimension=function(){return this.twoDimension};var g=function(){if(!(this instanceof g))throw new Error(ot.CONSTRUCT_ERROR);this.magoEnable=!0,this.showOutFitting=!1,this.showLabelInfo=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarSquaredDistance=5e6,this.frustumFarDistance=2e4,this.highLightedBuildings=[],this.colorBuildings=[],this.color=[],this.hideBuildings=[],this.objectMoveMode=c.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.showOrigin=!1,this.magoMode=c.magoMode.NORMAL,this.imagePath="",this.colorChangedObjectId,this.lod0DistInMeters=15,this.lod1DistInMeters=50,this.lod2DistInMeters=90,this.lod3DistInMeters=200,this.lod4DistInMeters=1e3,this.lod5DistInMeters=5e4,this.ambientReflectionCoef=.45,this.diffuseReflectionCoef=.75,this.specularReflectionCoef=.6,this.ambientColor=null,this.specularColor=new Float32Array([.6,.6,.6]),this.ssaoRadius=.15,this.modelMovable=!0;var t=f.getPolicy();this.pointsCloudSettings={},Si(t)?(this.pointsCloudSettings.maxPartitionsLod0=_i(t.maxPartitionsLod0,4),this.pointsCloudSettings.maxPartitionsLod1=_i(t.maxPartitionsLod1,2),this.pointsCloudSettings.maxPartitionsLod2orLess=_i(t.maxPartitionsLod2OrLess,1),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam0m=1/_i(t.maxRatioPointsDist0m,10),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam100m=1/_i(t.maxRatioPointsDist100m,120),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam200m=1/_i(t.maxRatioPointsDist200m,240),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam400m=1/_i(t.maxRatioPointsDist400m,480),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam800m=1/_i(t.maxRatioPointsDist800m,960),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam1600m=1/_i(t.maxRatioPointsDist1600m,1920),this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCamMoreThan1600m=1/_i(t.maxRatioPointsDistOver1600m,3840),this.pointsCloudSettings.maxPointSize=_i(t.maxPointSizeForPc,40),this.pointsCloudSettings.minPointSize=_i(t.minPointSizeForPc,3),this.pointsCloudSettings.pendentPointSize=_i(t.pendentPointSizeForPc,60),this.pointsCloudSettings.minHeightRainbow=_i(t.minHeight_rainbow_loc,0),this.pointsCloudSettings.maxHeightRainbow=_i(t.maxHeight_rainbow_loc,100)):(this.pointsCloudSettings.maxPartitionsLod0=4,this.pointsCloudSettings.maxPartitionsLod1=2,this.pointsCloudSettings.maxPartitionsLod2orLess=1,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam0m=.1,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam100m=1/120,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam200m=1/240,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam400m=1/480,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam800m=1/960,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCam1600m=1/1920,this.pointsCloudSettings.MaxPerUnitPointsRenderDistToCamMoreThan1600m=1/3840,this.pointsCloudSettings.maxPointSize=40,this.pointsCloudSettings.minPointSize=3,this.pointsCloudSettings.pendentPointSize=60,this.pointsCloudSettings.minHeightRainbow=0,this.pointsCloudSettings.maxHeightRainbow=100)};g.prototype.getPointsCloudSettings=function(){return this.pointsCloudSettings},g.prototype.getShowOrigin=function(){return this.showOrigin},g.prototype.setShowOrigin=function(t){this.showOrigin=t},g.prototype.getMagoEnable=function(){return this.magoEnable},g.prototype.setMagoEnable=function(t){this.magoEnable=t},g.prototype.getShowOutFitting=function(){return this.showOutFitting},g.prototype.setShowOutFitting=function(t){this.showOutFitting=t},g.prototype.getShowLabelInfo=function(){return this.showLabelInfo},g.prototype.setShowLabelInfo=function(t){this.showLabelInfo=t},g.prototype.getShowBoundingBox=function(){return this.showBoundingBox},g.prototype.setShowBoundingBox=function(t){this.showBoundingBox=t},g.prototype.getShowShadow=function(){return this.showShadow},g.prototype.setShowShadow=function(t){this.showShadow=t},g.prototype.getFrustumFarSquaredDistance=function(){return this.frustumFarSquaredDistance},g.prototype.setFrustumFarSquaredDistance=function(t){this.frustumFarSquaredDistance=t},g.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},g.prototype.setFrustumFarDistance=function(t){this.frustumFarDistance=t},g.prototype.getHighLightedBuildings=function(){return this.highLightedBuildings},g.prototype.setHighLightedBuildings=function(t){this.highLightedBuildings=t},g.prototype.getColorBuildings=function(){return this.colorBuildings},g.prototype.setColorBuildings=function(t){this.colorBuildings=t},g.prototype.getColor=function(){return this.color},g.prototype.setColor=function(t){this.color=t},g.prototype.getHideBuildings=function(){return this.hideBuildings},g.prototype.setHideBuildings=function(t){this.hideBuildings=t},g.prototype.getObjectMoveMode=function(){return this.objectMoveMode},g.prototype.setObjectMoveMode=function(t){this.objectMoveMode=t},g.prototype.getMagoMode=function(){return this.magoMode},g.prototype.setMagoMode=function(t){this.magoMode=t},g.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},g.prototype.setIssueInsertEnable=function(t){this.issueInsertEnable=t},g.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},g.prototype.setObjectInfoViewEnable=function(t){this.objectInfoViewEnable=t},g.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},g.prototype.setOcclusionCullingEnable=function(t){this.occlusionCullingEnable=t},g.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},g.prototype.setNearGeoIssueListEnable=function(t){this.nearGeoIssueListEnable=t},g.prototype.getImagePath=function(){return this.imagePath},g.prototype.setImagePath=function(t){this.imagePath=t},g.prototype.getLod=function(t){return t<this.lod0DistInMeters?0:t<this.lod1DistInMeters?1:t<this.lod2DistInMeters?2:t<this.lod3DistInMeters?3:t<this.lod4DistInMeters?4:5},g.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},g.prototype.setLod0DistInMeters=function(t){this.lod0DistInMeters=t},g.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},g.prototype.setLod1DistInMeters=function(t){this.lod1DistInMeters=t},g.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},g.prototype.setLod2DistInMeters=function(t){this.lod2DistInMeters=t},g.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},g.prototype.setLod3DistInMeters=function(t){this.lod3DistInMeters=t},g.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},g.prototype.setLod4DistInMeters=function(t){this.lod4DistInMeters=t},g.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},g.prototype.setLod5DistInMeters=function(t){this.lod5DistInMeters=t},g.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},g.prototype.setAmbientReflectionCoef=function(t){this.ambientReflectionCoef=t},g.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},g.prototype.setDiffuseReflectionCoef=function(t){this.diffuseReflectionCoef=t},g.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},g.prototype.setSpecularReflectionCoef=function(t){this.specularReflectionCoef=t},g.prototype.getAmbientColor=function(){return this.ambientColor},g.prototype.setAmbientColor=function(t){this.ambientColor=t},g.prototype.getSpecularColor=function(){return this.specularColor},g.prototype.setSpecularColor=function(t){this.specularColor=t},g.prototype.getSsaoRadius=function(){return this.ssaoRadius},g.prototype.setSsaoRadius=function(t){this.ssaoRadius=t},g.prototype.setModelMovable=function(t){this.modelMovable=t},g.prototype.isModelMovable=function(){return this.modelMovable};var p=function(){if(!(this instanceof p))throw new Error(ot.CONSTRUCT_ERROR);this.animationType=c.animationType.UNKNOWN,this.birthTime,this.lastTime,this.durationInSeconds,this.path,this.startLongitude,this.startLatitude,this.startAltitude,this.targetLongitude,this.targetLatitude,this.targetAltitude,this.targetHeading,this.targetPitch,this.targetRoll,this.linearVelocityInMetersSecond,this.headingAngDegSecondVelocity,this.pitchAngDegSecondVelocity,this.rollAngDegSecondVelocity},v=function(){if(!(this instanceof v))throw new Error(ot.CONSTRUCT_ERROR);this.nodesMap,this.objectsMap};v.prototype.putNode=function(t){void 0===this.nodesMap&&(this.nodesMap={});var e=t.data.nodeId;this.nodesMap[e]=t},v.prototype.putObject=function(t){void 0===this.objectsMap&&(this.objectsMap={});var e=t.id;this.objectsMap[e]=t},v.prototype.checkAnimation=function(t){if(void 0!==this.nodesMap)for(var e in this.nodesMap)Object.prototype.hasOwnProperty.call(this.nodesMap,e)&&this.nodesMap[e].finishedAnimation(t)&&delete this.nodesMap[e];if(void 0!==this.objectsMap)for(var e in this.objectsMap)Object.prototype.hasOwnProperty.call(this.objectsMap,e)&&this.objectsMap[e].finishedAnimation(t)&&delete this.objectsMap[e]},v.getNextPosition=function(t,e,i){return void 0===t||(t.animationType===c.animationType.PATH?v.getNextPositionByPath(t,e,i):void 0)},v.getNextPositionByPath=function(t,e,i){if(void 0===t)return!0;var r=t.path;if(void 0===r)return!0;void 0===t.linearVelocityInMetersSecond&&(t.linearVelocityInMetersSecond=20);var o=t.linearVelocityInMetersSecond,n=(e-t.birthTime)/1e3,a=o*n;if(ar.prototype.isPrototypeOf(r))return r.getTangent(a,void 0,i);if(Bi.prototype.isPrototypeOf(r)){if(t.durationInSeconds){if(t.currentLinearPos&&t.currentLinearPos>=t.totalLinearLength)return;if(void 0===t.totalLinearLength){if(void 0===r.knotPoints3dList){r.makeControlPoints(.3,i)}t.totalLinearLength=Bi.getLength(r,20)}var s=t.totalLinearLength;a=s*(n/t.durationInSeconds),t.currentLinearPos=a,a>s&&(a=s)}return Bi.getTangent(r,a,void 0,i)}};var y=function(){if(!(this instanceof y))throw new Error(ot.CONSTRUCT_ERROR);this.minX=1e6,this.minY=1e6,this.minZ=1e6,this.maxX=-1e6,this.maxY=-1e6,this.maxZ=-1e6};y.prototype.init=function(t){t=t||new ur,this.minX=t.x,this.minY=t.y,this.minZ=t.z,this.maxX=t.x,this.maxY=t.y,this.maxZ=t.z},y.prototype.readData=function(t,e){return this.minX=new Float32Array(t.slice(e,e+4))[0],e+=4,this.minY=new Float32Array(t.slice(e,e+4))[0],e+=4,this.minZ=new Float32Array(t.slice(e,e+4))[0],e+=4,this.maxX=new Float32Array(t.slice(e,e+4))[0],e+=4,this.maxY=new Float32Array(t.slice(e,e+4))[0],e+=4,this.maxZ=new Float32Array(t.slice(e,e+4))[0],e+=4},y.prototype.set=function(t,e,i,r,o,n){this.minX=t,this.minY=e,this.minZ=i,this.maxX=r,this.maxY=o,this.maxZ=n},y.prototype.deleteObjects=function(){this.minX=void 0,this.minY=void 0,this.minZ=void 0,this.maxX=void 0,this.maxY=void 0,this.maxZ=void 0},y.prototype.copyFrom=function(t){this.minX=t.minX,this.minY=t.minY,this.minZ=t.minZ,this.maxX=t.maxX,this.maxY=t.maxY,this.maxZ=t.maxZ},y.prototype.translateToOrigin=function(){var t=this.getXLength()/2,e=this.getYLength()/2,i=this.getZLength()/2;this.minX=-t,this.minY=-e,this.minZ=-i,this.maxX=t,this.maxY=e,this.maxZ=i},y.prototype.expand=function(t){t=t||0,t=Math.abs(t),this.minX-=t,this.minY-=t,this.minZ-=t,this.maxX+=t,this.maxY+=t,this.maxZ+=t},y.getBBoxByPonintAndSize=function(t,e){if(!t||!t instanceof ur)throw new Error("point is required");if(isNaN(e))throw new Error("size must number.");var i=new y,r=t.x+e,o=t.x-e,n=t.y+e,a=t.y-e,s=t.z-e,l=t.z+e;return i.set(o,a,s,r,n,l),i},y.getBBoxByXYZDataArray=function(t,e){if(void 0!==t){var i=t.length/3;if(0!==i){void 0===e&&(e=new y),e.init(new ur(t[0],t[1],t[2]));for(var r=0;r<i;r++)e.addXYZData(t[3*r],t[3*r+1],t[3*r+2]);return e}}},y.prototype.addXYZData=function(t,e,i){void 0!==t&&void 0!==e&&void 0!==i&&(t<this.minX?this.minX=t:t>this.maxX&&(this.maxX=t),e<this.minY?this.minY=e:e>this.maxY&&(this.maxY=e),i<this.minZ?this.minZ=i:i>this.maxZ&&(this.maxZ=i))},y.prototype.addPointsArray=function(t){if(void 0!==t)for(var e=t.length,i=0;i<e;++i)this.addPoint(t[i])},y.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y),t.z<this.minZ?this.minZ=t.z:t.z>this.maxZ&&(this.maxZ=t.z))},y.prototype.addBox=function(t){void 0!==t&&(t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY),t.minZ<this.minZ&&(this.minZ=t.minZ),t.maxZ>this.maxZ&&(this.maxZ=t.maxZ))},y.prototype.getMinLength=function(){return Math.min(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},y.prototype.getMaxLength=function(){return Math.max(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},y.prototype.getXLength=function(){return this.maxX-this.minX},y.prototype.getYLength=function(){return this.maxY-this.minY},y.prototype.getZLength=function(){return this.maxZ-this.minZ},y.prototype.getCenterPoint=function(t){return void 0===t&&(t=new ur),t.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,(this.maxZ+this.minZ)/2),t},y.prototype.getMinPoint=function(t){return void 0===t&&(t=new ur),t.set(this.minX,this.minY,this.minZ),t},y.prototype.getMaxPoint=function(t){return void 0===t&&(t=new ur),t.set(this.maxX,this.maxY,this.maxZ),t},y.prototype.getBottomCenterPoint=function(t){return void 0===t&&(t=new ur),t.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,0),t},y.prototype.getRadiusAprox=function(){return this.getMaxLength()/1.5},y.prototype.getRadius=function(){var t=this.getCenterPoint(),e=this.getMinPoint();return t.distToPoint(e)},y.prototype.getBoundingSphere=function(t){void 0===t&&(t=new mt);var e=this.getCenterPoint();return t.setCenterPoint(e.x,e.y,e.z),t.setRadius(this.getRadiusAprox()),t},y.prototype.intersectWithPoint=function(t){return void 0!==t&&!(t.x<this.minX||t.x>this.maxX||t.y<this.minY||t.y>this.maxY||t.z<this.minZ||t.z>this.maxZ)},y.prototype.isPoint3dInside=function(t,e,i){return!(t<this.minX||t>this.maxX)&&(!(e<this.minY||e>this.maxY)&&!(i<this.minZ||i>this.maxZ))},y.prototype.intersectWithBox=function(t){return void 0!==t&&!(t.minX>this.maxX||t.maxX<this.minX||t.minY>this.maxY||t.maxY<this.minY||t.minZ>this.maxZ||t.maxZ<this.minZ)},y.prototype.getPlaneTop=function(t){void 0===t&&(t=new ut);var e=this.getMaxPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,0,1),t},y.prototype.getPlaneBottom=function(t){void 0===t&&(t=new ut);var e=this.getMinPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,0,-1),t},y.prototype.getPlaneFront=function(t){void 0===t&&(t=new ut);var e=this.getMinPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,-1,0),t},y.prototype.getPlaneRear=function(t){void 0===t&&(t=new ut);var e=this.getMaxPoint();return t.setPointAndNormal(e.x,e.y,e.z,0,1,0),t},y.prototype.getPlaneLeft=function(t){void 0===t&&(t=new ut);var e=this.getMinPoint();return t.setPointAndNormal(e.x,e.y,e.z,-1,0,0),t},y.prototype.getPlaneRight=function(t){void 0===t&&(t=new ut);var e=this.getMaxPoint();return t.setPointAndNormal(e.x,e.y,e.z,1,0,0),t},y.prototype.isPoint3dInsideXYPrism=function(t){return void 0!==t&&!(t.x<this.minX||t.x>this.maxX||t.y<this.minY||t.y>this.maxY)},y.prototype.isPoint3dInsideXZPrism=function(t){return void 0!==t&&!(t.x<this.minX||t.x>this.maxX||t.z<this.minZ||t.z>this.maxZ)},y.prototype.isPoint3dInsideYZPrism=function(t){return void 0!==t&&!(t.y<this.minY||t.y>this.maxY||t.z<this.minZ||t.z>this.maxZ)},y.prototype.intersectsWithSegment3D=function(t){if(void 0===t)return!1;var e,i=t.getLine();return!(void 0===(e=this.getPlaneTop().intersectionLine(i,e))||!this.isPoint3dInsideXYPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneBottom().intersectionLine(i,e))||!this.isPoint3dInsideXYPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneFront().intersectionLine(i,e))||!this.isPoint3dInsideXZPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneRear().intersectionLine(i,e))||!this.isPoint3dInsideXZPrism(e)||!t.intersectionWithPoint(e))||(!(void 0===(e=this.getPlaneLeft().intersectionLine(i,e))||!this.isPoint3dInsideYZPrism(e)||!t.intersectionWithPoint(e))||!(void 0===(e=this.getPlaneRight().intersectionLine(i,e))||!this.isPoint3dInsideYZPrism(e)||!t.intersectionWithPoint(e))))))},y.prototype.intersectsWithTriangle=function(t){if(void 0===t)return!1;var e=t.getPlaneNormal();if(e.isNAN())return!1;var i=t.getBoundingBox();if(!this.intersectsWithBBox(i))return!1;if(this.intersectWithPoint(t.vertex0.getPosition())||this.intersectWithPoint(t.vertex1.getPosition())||this.intersectWithPoint(t.vertex2.getPosition()))return!0;var r=t.getPlane(),o=this.getCenterPoint(),n=r.getProjectedPoint(o);if(o.distToPoint(n)>this.getRadius())return!1;for(var a=0;a<3;a++){var s=t.getSegment(a,s);if(this.intersectsWithSegment3D(s))return!0}var l=Gi.getBestFacePlaneToProject(e),h=Li.projectTriangle3DInToBestPlaneToProject(t,l,void 0),d=Li.projectPoint3DInToBestPlaneToProject(o,l,void 0);return!!h.isPoint2dInside(d)},y.prototype.intersectsWithBBox=function(t){var e=!0;return this.maxX<t.minX?e=!1:this.minX>t.maxX?e=!1:this.maxY<t.minY?e=!1:this.minY>t.maxY?e=!1:this.maxZ<t.minZ?e=!1:this.minZ>t.maxZ&&(e=!1),e};var m=function(t,e,i,r){if(!(this instanceof m))throw new Error(ot.CONSTRUCT_ERROR);this.centerPoint=new ur,void 0!==t&&void 0!==e&&void 0!==i&&this.centerPoint.set(t,e,i),this.r=0,void 0!==r&&(this.r=r)};m.prototype.getCenterPoint=function(){return this.centerPoint},m.prototype.setCenterPoint=function(t,e,i){this.centerPoint.set(t,e,i)},m.prototype.getRadius=function(){return this.r},m.prototype.setRadius=function(t){this.r=t},m.prototype.intersectsWithBSphere=function(t){if(void 0===t)return u.INTERSECTION_OUTSIDE;var e=this.centerPoint.distToPoint(t.centerPoint);return e<this.r?u.INTERSECTION_INSIDE:e<t.r?u.INTERSECTION_INSIDE:e<this.r+t.r?u.INTERSECTION_INTERSECT:u.INTERSECTION_OUTSIDE},m.prototype.copyFrom=function(t){this.centerPoint.copyFrom(t.centerPoint),this.r=t.r},m.prototype.addBSphere=function(t){if(this.intersectsWithBSphere(t)===u.INTERSECTION_INSIDE)this.r<t.r&&this.copyFrom(t);else{var e=this.centerPoint.getVectorToPoint(t.centerPoint,void 0);e.unitary();var i=new ur(this.centerPoint.x-e.x*this.r,this.centerPoint.y-e.y*this.r,this.centerPoint.z-e.z*this.r),r=new ur(t.centerPoint.x+e.x*t.r,t.centerPoint.y+e.y*t.r,t.centerPoint.z+e.z*t.r),o=(i.x+r.x)/2,n=(i.y+r.y)/2,a=(i.z+r.z)/2;this.centerPoint.set(o,n,a),this.r=.5*i.distToPoint(r)}};var x=function(){if(!(this instanceof x))throw new Error(ot.CONSTRUCT_ERROR);this.fisrtName,this.name="",this.buildingId,this.buildingFileName,this.geographicCoord,this.rotationsDegree,this.bBox,this.geographicCoordOfBBox,this.smartTileOwner};x.prototype.deleteObjects=function(){this.fisrtName=void 0,this.name=void 0,this.buildingId=void 0,this.buildingFileName=void 0,this.geographicCoord.deleteObjects(),this.rotationsDegree.deleteObjects(),this.bBox.deleteObjects(),this.geographicCoordOfBBox.deleteObjects(),this.geographicCoord=void 0,this.rotationsDegree=void 0,this.bBox=void 0,this.geographicCoordOfBBox=void 0};var b=function(){if(!(this instanceof b))throw new Error(ot.CONSTRUCT_ERROR);this.buildingSeedArray=[],this.minGeographicCoord,this.maxGeographicCoord,this.dataArrayBuffer};b.prototype.deleteObjects=function(){if(this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.buildingSeedArray){for(var t=this.buildingSeedArray.length,e=0;e<t;e++)this.buildingSeedArray[e].deleteObjects(),this.buildingSeedArray[e]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},b.prototype.newBuildingSeed=function(){var t=new x;return this.buildingSeedArray.push(t),t},b.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var t,e,i,r,o=this.dataArrayBuffer,n=0,a=new Int32Array(o.slice(n,n+4))[0];n+=4;for(var s=0;s<a;s++){var l=this.newBuildingSeed();void 0===l.geographicCoord&&(l.geographicCoord=new j),void 0===l.bBox&&(l.bBox=new y),t=new Int32Array(o.slice(n,n+4))[0],n+=4;var h=new TextDecoder("utf-8").decode(new Uint8Array(o.slice(n,n+t)));n+=t,e=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.buildingId=h.substr(4,t-4),l.buildingFileName=h,l.geographicCoord.setLonLatAlt(e,i,r)}return!0},b.prototype.getBuildingSeedLength=function(){return this.buildingSeedArray.length},b.prototype.getBuildingSeed=function(t){if("string"!=typeof t&&"number"!=typeof t)throw new Error("idx is required to be a string or number.");if(!this.buildingSeedArray[t])throw new Error("range over.");return this.buildingSeedArray[t]};var C=function(){if(!(this instanceof C))throw new Error(ot.CONSTRUCT_ERROR);this.map=new Map,this.dataArrayBuffer};C.prototype.deleteObjects=function(){if(this.buildingSeedArray){for(var t=this.buildingSeedArray.length,e=0;e<t;e++)this.buildingSeedArray[e].deleteObjects(),this.buildingSeedArray[e]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},C.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var t,e,i,r,o=this.dataArrayBuffer,n=0,a=new Int32Array(o.slice(n,n+4))[0];n+=4;for(var s=0;s<a;s++){var l=new x;void 0===l.geographicCoord&&(l.geographicCoord=new j),void 0===l.bBox&&(l.bBox=new y),t=new Int32Array(o.slice(n,n+4))[0],n+=4;var h=new TextDecoder("utf-8").decode(new Uint8Array(o.slice(n,n+t)));n+=t,e=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.buildingId=h.substr(4,t-4),l.buildingFileName=h,l.geographicCoord.setLonLatAlt(e,i,r),this.map.set(l.buildingId,l)}return!0},C.prototype.getBuildingSeedLength=function(){return this.map.size},C.prototype.getBuildingSeed=function(t){if("string"!=typeof t&&"number"!=typeof t)throw new Error("buildingId is required to be a string or number.");return this.map.get(t)};var A=function(t){if(!(this instanceof A))throw new Error(ot.CONSTRUCT_ERROR);this.id="camera",this.name="noName",this.position=new ur,this.direction=new ur,this.up=new ur,this.right=new ur,this.frustum=new B,this.bigFrustum=new B,this.dirty=!0,this.frustumsArray=[],this.frustumsArray.push(this.frustum),this.nearCenterPoint=new ur,this.farCenterPoint=new ur,this.farLeftBottomPoint=new ur,this.farRightTopPoint=new ur,this.leftBottomDir=new ur,this.rightTopDir=new ur,this.leftNormal=new ur,this.rightNormal=new ur,this.bottomNormal=new ur,this.topNormal=new ur,this.lastMovement,this.tracked,this.trackType=c.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12,t&&(void 0!==t.name&&(this.name=t.name),void 0!==t.id&&(this.id=t.id))};A.prototype.copyPosDirUpFrom=function(t){this.position.copyFrom(t.position),this.direction.copyFrom(t.direction),this.up.copyFrom(t.up)},A.prototype.translate=function(t){this.position.add(t.x,t.y,t.z)},A.prototype.doInertialMovement=function(t){if(void 0===this.lastMovement)return!1;if(this.lastMovement.movementType===c.movementType.NO_MOVEMENT)return!1;var e=this.lastMovement,i=e.deltaTime,r=t.magoWorld,o=e.movementType;if(o===c.movementType.TRANSLATION){var n=e.currLinearVelocity,a=e.translationDir,s=n*i;Math.abs(s)<1e-4&&(e.movementType=c.movementType.NO_MOVEMENT),this.position.add(-a.x*s,-a.y*s,-a.z*s),r.updateModelViewMatrixByCamera(this),e.currLinearVelocity*=.9,Math.abs(e.currLinearVelocity)<1e-4&&(e.movementType=c.movementType.NO_MOVEMENT)}else if(o===c.movementType.ROTATION){var l=e.currAngularVelocity;e.angRad=l*i,Math.abs(e.angRad)<1e-11&&(e.movementType=c.movementType.NO_MOVEMENT);var h=e.angRad,d=e.rotationAxis;if(g=e.rotationPoint){(T=new rt).rotationAxisAngRad(h,d.x,d.y,d.z);var u=new ur(-g.x,-g.y,-g.z),f=new ur(g.x,g.y,g.z);this.translate(u),this.transformByMatrix4(T),this.translate(f)}else{(T=new rt).rotationAxisAngRad(-h,d.x,d.y,d.z),this.transformByMatrix4(T)}r.updateModelViewMatrixByCamera(this),e.currAngularVelocity*=.9,Math.abs(e.currAngularVelocity)<1e-11&&(e.movementType=c.movementType.NO_MOVEMENT)}else if(o===c.movementType.ROTATION_ZX){l=e.currAngularVelocity;e.angRad=l*i;var g;h=e.angRad,d=e.rotationAxis;if(g=e.rotationPoint){var p;p=W.normalAtCartesianPointWgs84(g.x,g.y,g.z,p);var v=this.getCameraRight(),y=e.zAngVelocity*i,m=e.xAngVelocity*i,x=-this.getOrientation().pitchRad;m+x>-.1&&(m=x<0?-x-.01:x-.01),Math.abs(y)<1e-11&&Math.abs(m)<1e-11&&(e.movementType=c.movementType.NO_MOVEMENT);var b=glMatrix.quat.create();b=glMatrix.quat.setAxisAngle(b,p,y);var C=glMatrix.quat.create();C=glMatrix.quat.setAxisAngle(C,[v.x,v.y,v.z],m);var A=glMatrix.quat.create();A=glMatrix.quat.multiply(A,b,C),(T=new rt)._floatArrays=glMatrix.mat4.fromQuat(T._floatArrays,A);u=new ur(-g.x,-g.y,-g.z),f=new ur(g.x,g.y,g.z);this.translate(u),this.transformByMatrix4(T),this.translate(f)}else{var T;(T=new rt).rotationAxisAngRad(-h,d.x,d.y,d.z),this.transformByMatrix4(T)}r.updateModelViewMatrixByCamera(this),e.zAngVelocity*=.9,e.xAngVelocity*=.9,Math.abs(e.zAngVelocity)<1e-11&&Math.abs(e.xAngVelocity)<1e-11&&(e.movementType=c.movementType.NO_MOVEMENT)}return!0},A.prototype.transformByMatrix4=function(t){this.position=t.transformPoint3D(this.position,this.position),this.direction=t.rotatePoint3D(this.direction,this.direction),this.up=t.rotatePoint3D(this.up,this.up)},A.prototype.getCameraDirectionLine=function(t){return void 0===t&&(t=new Yi),t.point.set(this.position.x,this.position.y,this.position.z),t.direction.set(this.direction.x,this.direction.y,this.direction.z),t},A.prototype.getCameraElevation=function(){var t,e=(t=W.CartesianToGeographicWgs84(this.position.x,this.position.y,this.position.z,t)).latitude;return this.position.getModul()-W.radiusAtLatitudeDeg(e)},A.prototype.getCameraRight=function(){return void 0===this.right&&(this.right=new ur),this.right=this.direction.crossProduct(this.up,this.right),this.right},A.prototype.setDirty=function(t){this.dirty=t},A.prototype.getDirty=function(){return this.dirty},A.prototype.isCameraMoved=function(t,e,i,r,o,n,a,s,l){var h=this.position;if(Math.abs(h.x-t)>.001||Math.abs(h.y-e)>.001||Math.abs(h.z-i)>.001)return!0;var d=this.direction;if(Math.abs(d.x-r)>.001||Math.abs(d.y-o)>.001||Math.abs(d.z-n)>1e-5)return!0;var c=this.up;return Math.abs(c.x-a)>.001||Math.abs(c.y-s)>.001||Math.abs(c.z-l)>1e-5},A.prototype.getFrustum=function(t){return void 0===this.frustumsArray[t]&&(this.frustumsArray[t]=new B,this.frustumsArray[t].fovRad[0]=this.frustumsArray[0].fovRad[0],this.frustumsArray[t].fovyRad[0]=this.frustumsArray[0].fovyRad[0],this.frustumsArray[t].aspectRatio[0]=this.frustumsArray[0].aspectRatio[0],this.frustumsArray[t].tangentOfHalfFovy[0]=this.frustumsArray[0].tangentOfHalfFovy[0]),this.frustumsArray[t]},A.prototype.getLastFrustum=function(){return this.getFrustum(this.frustumsArray.length-1)},A.prototype.setFrustumsDistances=function(t,e){for(var i,r=0;r<t;r++)e[r],(i=this.getFrustum(r)).near[0]=e[2*r],i.far[0]=e[2*r+1],0===r&&(this.bigFrustum.near[0]=e[2*r]),r===t-1&&(this.bigFrustum.far[0]=e[2*r+1])},A.prototype.setAspectRatioAndFovyRad=function(t,e){var i,r;(r=this.getFrustum(0)).aspectRatio[0]=t,r.fovyRad[0]=e,r.fovRad[0]=e*t,r.tangentOfHalfFovy[0]=Math.tan(e/2);for(var o=this.frustumsArray.length,n=1;n<o;n++)(i=this.getFrustum(n)).aspectRatio[0]=r.aspectRatio[0],i.fovyRad[0]=r.fovyRad[0],i.fovRad[0]=r.fovRad[0],i.tangentOfHalfFovy[0]=r.tangentOfHalfFovy[0];this.bigFrustum.aspectRatio[0]=r.aspectRatio[0],this.bigFrustum.fovyRad[0]=r.fovyRad[0],this.bigFrustum.fovRad[0]=r.fovRad[0],this.bigFrustum.tangentOfHalfFovy[0]=r.tangentOfHalfFovy[0]},A.prototype.setCurrentFrustum=function(t){this.frustum=this.getFrustum(t)},A.prototype.bindUniforms=function(t,e){var i=this.frustum;t.uniform1f(e.frustumNear_loc,i.near[0]),t.uniform1f(e.frustumFar_loc,i.far[0])},A.prototype.calculateFrustumsPlanes=function(){var t,e,i=(t=this.getFrustum(0)).tangentOfHalfFovy*t.near*2,r=t.tangentOfHalfFovy*t.far*2,o=(t.aspectRatio[0],r*t.aspectRatio[0]),n=this.position.x,a=this.position.y,s=this.position.z,l=this.direction.x,h=this.direction.y,d=this.direction.z;this.right=this.direction.crossProduct(this.up,this.right),this.nearCenterPoint.set(n+l*t.near,a+h*t.near,s+d*t.near),this.farCenterPoint.set(n+l*t.far,a+h*t.far,s+d*t.far),this.farLeftBottomPoint.set(this.farCenterPoint.x-this.right.x*o*.5-this.up.x*r*.5,this.farCenterPoint.y-this.right.y*o*.5-this.up.y*r*.5,this.farCenterPoint.z-this.right.z*o*.5-this.up.z*r*.5),this.farRightTopPoint.set(this.farLeftBottomPoint.x+this.right.x*o+this.up.x*r,this.farLeftBottomPoint.y+this.right.y*o+this.up.y*r,this.farLeftBottomPoint.z+this.right.z*o+this.up.z*r),this.leftBottomDir.set(this.farLeftBottomPoint.x-n,this.farLeftBottomPoint.y-a,this.farLeftBottomPoint.z-s),this.leftBottomDir.unitary(),this.rightTopDir.set(this.farRightTopPoint.x-n,this.farRightTopPoint.y-a,this.farRightTopPoint.z-s),this.rightTopDir.unitary(),t.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,h,d),t.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-h,-d),this.leftNormal=this.leftBottomDir.crossProduct(this.up,this.leftNormal),this.leftNormal.unitary(),t.planesArray[2].setPointAndNormal(n,a,s,this.leftNormal.x,this.leftNormal.y,this.leftNormal.z),this.bottomNormal=this.right.crossProduct(this.leftBottomDir,this.bottomNormal),this.bottomNormal.unitary(),t.planesArray[3].setPointAndNormal(n,a,s,this.bottomNormal.x,this.bottomNormal.y,this.bottomNormal.z),this.rightNormal=this.up.crossProduct(this.rightTopDir,this.rightNormal),this.rightNormal.unitary(),t.planesArray[4].setPointAndNormal(n,a,s,this.rightNormal.x,this.rightNormal.y,this.rightNormal.z),this.topNormal=this.rightTopDir.crossProduct(this.right,this.topNormal),this.topNormal.unitary(),t.planesArray[5].setPointAndNormal(n,a,s,this.topNormal.x,this.topNormal.y,this.topNormal.z);for(var c=this.frustumsArray.length,u=1;u<c;u++){e=this.getFrustum(u),this.nearCenterPoint.set(n+l*e.near,a+h*e.near,s+d*e.near),this.farCenterPoint.set(n+l*e.far,a+h*e.far,s+d*e.far),e.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,h,d),e.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-h,-d);for(var f=2;f<6;f++)e.planesArray[f]=t.planesArray[f]}this.nearCenterPoint.set(n+l*this.bigFrustum.near,a+h*this.bigFrustum.near,s+d*this.bigFrustum.near),this.farCenterPoint.set(n+l*this.bigFrustum.far,a+h*this.bigFrustum.far,s+d*this.bigFrustum.far),this.bigFrustum.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,h,d),this.bigFrustum.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-h,-d);for(this.getLastFrustum(),f=2;f<6;f++)this.bigFrustum.planesArray[f]=t.planesArray[f]},A.prototype.doTrack=function(t){if(this.tracked){var i=this.tracked;if(t.isCesiumGlobe()){var r,o,n=t.scene.camera,a=n.positionWC;if(i instanceof he?o=i.getNodeGeoLocDataManager():i instanceof e&&(o=i.geoLocDataManager),void 0===o)return;var s=o.getCurrentGeoLocationData();if(void 0===s)return;var l=o.getGeoLocationData(1);if(Si(l)){var h=s.positionLOW,d=l.positionLOW,u=new Float32Array([0,0,0]),f=new Float32Array([0,0,0]);Ei.calculateSplited3fv([a.x,a.y,a.z],u,f);var g=h[0]-d[0],p=h[1]-d[1],v=h[2]-d[2];(r=new Cesium.Cartesian3).x=u[0]+f[0]+g,r.y=u[1]+f[1]+p,r.z=u[2]+f[2]+v}var y=s.getGeographicCoords();if(void 0===y)return;var m=Cesium.Cartesian3.fromDegrees(y.longitude,y.latitude,y.altitude);if(this.trackType===c.trackMode.TRACKING){var x=Cesium.Cartesian3.distance(r||a,m),b=new Cesium.HeadingPitchRange(n.heading,n.pitch,x);n.lookAt(m,b)}else{var C=s.rotMatrix,T=C.rotatePoint3D(new ur(0,this.targetOffset,0)),M=C.rotatePoint3D(new ur(0,this.trackCameraOffsetY,this.trackCameraOffsetZ));M.x=m.x+M.x,M.y=m.y+M.y,M.z=m.z+M.z,T.x=m.x+T.x,T.y=m.y+T.y,T.z=m.z+T.z;var P=s.geoLocMatrix._floatArrays,w=new ur(P[8],P[9],P[10]);A.setByPositionAndTarget(n,T,M,w)}}}else this.gotoAnimation},A.prototype.stopTrack=function(t){this.tracked=void 0,t.isCesiumGlobe()&&t.scene.camera.lookAtTransform(Cesium.Matrix4.IDENTITY)},A.prototype.setTrack=function(t,e){this.initTrackOption(),this.tracked=t,e&&(this.trackType=wi(e.type,this.trackType),this.targetOffset=wi(e.targetOffset,this.targetOffset),e.trackCameraOffset&&(this.trackCameraOffsetY=_i(e.trackCameraOffset.y,this.trackCameraOffsetY),this.trackCameraOffsetZ=_i(e.trackCameraOffset.z,this.trackCameraOffsetZ)))},A.prototype.initTrackOption=function(){this.trackType=c.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12},A.prototype.getPosition=function(){return this.position},A.prototype.getDirection=function(){return this.direction},A.prototype.getUp=function(){return this.up},A.prototype.getTargetPositionAtDistance=function(t,e){void 0===e&&(e=new ur);var i=this.direction,r=this.position;return e.set(r.x+i.x*t,r.y+i.y*t,r.z+i.z*t),e},A.prototype.getTargetOnTerrain=function(t,e){void 0===e&&(e=new ur);var i=t.sceneState.getScreenCenterPositionPixels(void 0),r=t.getGl();return e=Ei.calculatePixelPositionWorldCoord(r,i.x,i.y,e,void 0,void 0,void 0,t)},A.setByPositionAndTarget=function(t,e,i,r){var o=new ur;o.set(e.x-i.x,e.y-i.y,e.z-i.z),o.unitary();var n=o.crossProduct(r).crossProduct(o);n.unitary(),t.setView({destination:i,orientation:{direction:new Cesium.Cartesian3(o.x,o.y,o.z),up:new Cesium.Cartesian3(n.x,n.y,n.z)}})},A.setOrientation=function(t,e,i,r){var o=t.position,n=new rt,a=Ei.calculateTransformMatrixAtWorldPosition(o,e,i,r,n,void 0),s=a.getZAxis(void 0);s.scale(-1);var l=a.getYAxis(void 0);t.direction.set(s.x,s.y,s.z),t.up.set(l.x,l.y,l.z)},A.prototype.getOrientation=function(t){var e,i,r,o=this.position,n=this.direction,a=this.up,s=this.getRight(),l=Ei.calculateGeoLocationMatrixAtWorldPosition(o,void 0).getInverse(),h=l.rotatePoint3D(n,void 0),d=l.rotatePoint3D(a,void 0),c=l.rotatePoint3D(s,void 0),u=Math.abs(h.z);return e=Math.abs(u-1)>1e-5?Math.atan2(h.y,h.x)+Math.PI+Math.PI/2:Math.atan2(d.y,d.x)+Math.PI+Math.PI/2,i=Math.PI-Math.acos(h.z),Math.abs(u-1)>1e-5&&(r=Math.atan2(-c.z,d.z)),void 0===t&&(t={}),t.headingRad=e,t.pitchRad=i,t.rollRad=r,t},A.prototype.getRight=function(){return this.right=this.direction.crossProduct(this.up,this.right),this.right},A.prototype.calculateUp=function(t){this.right=this.direction.crossProduct(t,this.right),this.right.unitary(),this.up=this.right.crossProduct(this.direction,this.up),this.up.unitary()},A.prototype.finishedAnimation=function(t){var e=this.animationData;if(void 0===e)return!0;var i=t.getCurrentTime();if(e.animationType===c.animationType.PATH){var r=v.getNextPosition(e,i,t);if(void 0===r)return e.finished=!0,!0;var o,n=this.position,a=this.direction,s=this.up,l=e.path.getGeoLocationDataManager().getCurrentGeoLocationData(),h=r.point,d=l.tMatrix.transformPoint3D(h,void 0),u=new ur(n.x,n.y,n.z),f=new ur(d.x,d.y,d.z);if(n.set(f.x,f.y,f.z),(o=u.crossProduct(f,o)).unitary(),o.isNAN())return!1;var g=u.angleRadToVector(f);if(0===g||isNaN(g))return!1;var p=new rt;return p.rotationAxisAngRad(g,o.x,o.y,o.z),a=p.transformPoint3D(a,a),s=p.transformPoint3D(s,s),t.magoWorld.updateModelViewMatrixByCamera(this),e.lastTime=i,!1}return!1},A.prototype.finishedAnimation__original=function(t){var e=this.animationData;if(void 0===e)return!0;var i=t.getCurrentTime();if(e.animationType===c.animationType.PATH){var r=v.getNextPosition(e,i,t);if(void 0===r)return e.finished=!0,!0;var o=e.path.getGeoLocationDataManager().getCurrentGeoLocationData(),n=r.point,a=(r.direction,o.tMatrix.transformPoint3D(n,void 0));this.position.copyFrom(a);var s=W.normalAtCartesianPointWgs84(a.x,a.y,a.z,void 0);return this.calculateUp(new ur(s[0],s[1],s[2])),t.magoWorld.updateModelViewMatrixByCamera(this),e.lastTime=i,!1}return!1};var T,M=function(t){if(!(this instanceof M))throw new Error(ot.CONSTRUCT_ERROR);this.name="noName",void 0!==t&&(this.name=t),this.geoLocationData=new z,this.minHeading=0,this.maxHeading=90,this.heading=0,this.pitch=0,this.roll=0,this.targetHeading,this.targetPitch,this.targetRoll,this.rotMat=new rt,this.camera=new A,this.vboKeyContainer,this.vboKeyContainerEdges,this.color=new _,this.color.setRGBA(0,.5,.9,.3),this.greenFactorSpeed=1,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.headingAngularSpeed=25,this.pitchAngularSpeed,this.rollAngularSpeed,this.lastTime,this.greenFactor=1,this.blueFactor=1,this.alphaFactor=1};M.prototype.updateTime=function(t){this.lastTime=t},M.prototype.setOrientation=function(t,e,i,r){if(this.targetHeading=t,this.targetPitch=e,this.targetRoll=i,void 0!==this.targetHeading){var o=this.targetHeading-this.heading;this.headingAngularSpeed=o/r,0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)}if(void 0!==this.targetPitch){var n=this.targetPitch-this.pitch;this.pitchAngularSpeed=n/r,0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=void 0)}if(void 0!==this.targetRoll){var a=this.targetRoll-this.roll;this.rollAngularSpeed=a/r,0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)}},M.prototype.updateOrientation=function(t){if(void 0!==this.targetHeading||void 0!==this.targetPitch||void 0!==this.targetRoll){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0!==this.headingAngularSpeed&&(this.heading+=e*this.headingAngularSpeed,this.headingAngularSpeed>0?this.heading>=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0):this.heading<=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0),0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)),void 0!==this.pitchAngularSpeed&&(this.pitch+=e*this.pitchAngularSpeed,this.pitchAngularSpeed>0?this.pitch>=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0):this.pitch<=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0),0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=0)),void 0!==this.rollAngularSpeed&&(this.roll+=e*this.rollAngularSpeed,this.rollAngularSpeed>0?this.roll>=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0):this.roll<=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0),0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)),this.calculateRotationMatrix()}},M.prototype.updateHeading=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;this.heading+=e*this.headingAngularSpeed,this.heading>this.maxHeading?(this.heading=this.maxHeading,this.headingAngularSpeed*=-1):this.heading<this.minHeading&&(this.heading=this.minHeading,this.headingAngularSpeed*=-1),this.calculateRotationMatrix()},M.prototype.updateColor=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.greenFactor+=this.greenFactorSpeed*e,this.blueFactor+=this.blueFactorSpeed*e,this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1),this.greenFactor<0&&(this.greenFactor=0,this.greenFactorSpeed*=-1),this.blueFactor>.9&&(this.blueFactor=.9,this.blueFactorSpeed*=-1),this.blueFactor<0&&(this.blueFactor=0,this.blueFactorSpeed*=-1),this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1),this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.color.setRGBA(0,this.greenFactor,this.blueFactor,this.alphaFactor)},M.prototype.calculateRotationMatrix=function(){var t;t=rt.getRotationDegZXYMatrix(this.heading,this.pitch,this.roll,t),this.rotMat=t.getMultipliedByMatrix(this.geoLocationData.rotMatrix,this.rotMat)},M.prototype.getVbo=function(t,e,i){var r;void 0===t&&(t=new Nt),void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new Nt),r=this.makeFrustumGeometry_2(r);var o=new rt,n=this.camera.bigFrustum.fovyRad/2;o.rotationAxisAngDeg(180*-n/Math.PI,1,0,0);var a=r.getSurfaceIndependentMesh(void 0,!0,!0);return a.transformByMatrix4(o),a.setColor(0,.5,.9,.3),a.getVbo(t,i),a.getVboEdges(this.vboKeyContainerEdges,i),t},M.prototype.render=function(t,e,i){if(void 0!==this.vboKeyContainer){var r;this.vboKeyContainer.vboCacheKeysArray.length;t.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,this.geoLocationData.rotMatrix._floatArrays),t.uniform3fv(i.buildingPosHIGH_loc,this.geoLocationData.positionHIGH),t.uniform3fv(i.buildingPosLOW_loc,this.geoLocationData.positionLOW),t.uniform1i(i.hasTexture_loc,!1),t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(1,3);t.uniform1i(i.refMatrixType_loc,2),t.uniformMatrix4fv(i.refMatrix_loc,!1,this.rotMat._floatArrays);var o=e.renderer;r=!0,o.renderNormals=!1,t.uniform4fv(i.oneColor4_loc,[0,0,0,1]),o.renderVboContainer(t,this.vboKeyContainerEdges,e,i,r),t.enable(t.BLEND),r=!1,o.renderNormals=!0,t.uniform4fv(i.oneColor4_loc,[this.blueFactor,0,0,this.alphaFactor]),o.renderVboContainer(t,this.vboKeyContainer,e,i,r),t.disable(t.BLEND),t.disable(t.POLYGON_OFFSET_FILL)}},M.prototype.makeFrustumGeometry_2=function(t){void 0===t&&(t=new nr),t.profile=new xr;var e,i,r=t.profile,o=this.camera.bigFrustum,n=o.far,a=o.fovyRad/2,s=o.fovRad/2,l=(Math.tan(s),Math.tan(a),r.newOuterRing());(e=l.newElement("POLYLINE")).newPoint2d(-n*Math.sin(s),n*Math.cos(s)),e.newPoint2d(0,0),e.newPoint2d(n*Math.sin(s),n*Math.cos(s));var h,d,c=90-180*s/Math.PI,u=90+180*s/Math.PI;i=l.newElement("ARC"),this.sweepSense=1,i.setCenterPosition(0,0),i.setRadius(n),i.setStartAngleDegree(c),i.setSweepAngleDegree(u-c),i.numPointsFor360Deg=36,h=2*a*180/Math.PI,d=new wr;var f=new dr(-1,0),g=new dr(1,0);return d.setPoints(f,g),6,t.revolve(r,h,6,d),t},M.prototype.makeFrustumGeometry=function(t){void 0===t&&(t=new rr),void 0===t.hedgesList&&(t.hedgesList=new Hi);var e,i,r,o,n,a,s=new ur(0,0,0),l=this.camera.bigFrustum,h=l.far,d=l.fovyRad/2,c=l.fovRad/2,u=-h*Math.tan(c),f=-u,g=h*Math.tan(d),p=-g,v=new ur(u,p,-h),y=new ur(f,p,-h),m=new ur(f,g,-h),x=new ur(u,g,-h),b=new jr(s),C=new jr(v),A=new jr(y),T=new jr(m),M=new jr(x);void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new Nt),(e=t.newSurface().newFace()).addVertex(C),e.addVertex(M),e.addVertex(T),e.addVertex(A);for(var P=0,w=[],_=[],S=e.vertexArray.length,L=0;L<S;L++)i=e.vertexArray[L],a=Ur.getNextIdx(L,e.vertexArray),r=e.vertexArray[a],o=i.point3d,n=r.point3d,w.push(o.x),w.push(o.y),w.push(o.z),w.push(n.x),w.push(n.y),w.push(n.z),_.push(P),P++,_.push(P),P++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(T),e.addVertex(M),S=e.vertexArray.length;for(L=0;L<S;L++)i=e.vertexArray[L],a=Ur.getNextIdx(L,e.vertexArray),r=e.vertexArray[a],o=i.point3d,n=r.point3d,w.push(o.x),w.push(o.y),w.push(o.z),w.push(n.x),w.push(n.y),w.push(n.z),_.push(P),P++,_.push(P),P++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(M),e.addVertex(C),S=e.vertexArray.length;for(L=0;L<S;L++)i=e.vertexArray[L],a=Ur.getNextIdx(L,e.vertexArray),r=e.vertexArray[a],o=i.point3d,n=r.point3d,w.push(o.x),w.push(o.y),w.push(o.z),w.push(n.x),w.push(n.y),w.push(n.z),_.push(P),P++,_.push(P),P++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(C),e.addVertex(A),S=e.vertexArray.length;for(L=0;L<S;L++)i=e.vertexArray[L],a=Ur.getNextIdx(L,e.vertexArray),r=e.vertexArray[a],o=i.point3d,n=r.point3d,w.push(o.x),w.push(o.y),w.push(o.z),w.push(n.x),w.push(n.y),w.push(n.z),_.push(P),P++,_.push(P),P++;(e=t.newSurface().newFace()).addVertex(b),e.addVertex(A),e.addVertex(T),S=e.vertexArray.length;for(L=0;L<S;L++)i=e.vertexArray[L],a=Ur.getNextIdx(L,e.vertexArray),r=e.vertexArray[a],o=i.point3d,n=r.point3d,w.push(o.x),w.push(o.y),w.push(o.z),w.push(n.x),w.push(n.y),w.push(n.z),_.push(P),P++,_.push(P),P++;var R=this.vboKeyContainerEdges.newVBOVertexIdxCacheKey();return R.posVboDataArray=Float32Array.from(w),R.idxVboDataArray=Int16Array.from(_),R.indicesCount=R.idxVboDataArray.length,t.calculateVerticesNormals(),t},(T=function(){if(!(this instanceof T))throw new Error(ot.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(t){var e=new M;return void 0!==t&&(e.name=t),this.camerasList.push(e),e},T.prototype.getCCTV=function(t){return this.camerasList[t]},T.prototype.getCCTVByName=function(t){for(var e,i,r=!1,o=this.getCCTVCount(),n=0;!r&&n<o;)(e=this.getCCTV(n)).name===t&&(i=e,r=!0),n++;return i},T.prototype.getCCTVCount=function(){return this.camerasList.length},T.prototype.render=function(t,e){var i=this.getCCTVCount();if(0!==i){var r=t.sceneState.gl;e.resetLastBuffersBinded();var o=e.program;r.useProgram(o),r.uniform1i(e.bApplySpecularLighting_loc,!1),r.disableVertexAttribArray(e.texCoord2_loc),r.enableVertexAttribArray(e.position3_loc),r.enableVertexAttribArray(e.normal3_loc),e.bindUniformGenerals(),r.uniform1i(e.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),r.uniform1i(e.colorType_loc,0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t.depthFboNeo.colorBuffer),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t.noiseTexture),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,t.textureAux_1x1),e.last_tex_id=t.textureAux_1x1,t.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<i;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(r,t,e),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&t.drawCCTVNames(this.camerasList),e.disableVertexAttribArrayAll()}},(T=function(){if(!(this instanceof T))throw new Error(ot.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(t){var e=new M;return void 0!==t&&(e.name=t),this.camerasList.push(e),e},T.prototype.getCCTV=function(t){return this.camerasList[t]},T.prototype.getCCTVByName=function(t){for(var e,i,r=!1,o=this.getCCTVCount(),n=0;!r&&n<o;)(e=this.getCCTV(n)).name===t&&(i=e,r=!0),n++;return i},T.prototype.getCCTVCount=function(){return this.camerasList.length},T.prototype.render=function(t,e){var i=this.getCCTVCount();if(0!==i){var r=t.sceneState.gl;e.resetLastBuffersBinded();var o=e.program;r.useProgram(o),r.uniform1i(e.bApplySpecularLighting_loc,!1),r.disableVertexAttribArray(e.texCoord2_loc),r.enableVertexAttribArray(e.position3_loc),r.enableVertexAttribArray(e.normal3_loc),e.bindUniformGenerals(),r.uniform1i(e.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),r.uniform1i(e.colorType_loc,0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,t.depthFboNeo.colorBuffer),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,t.noiseTexture),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,t.textureAux_1x1),e.last_tex_id=t.textureAux_1x1,t.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<i;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(r,t,e),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&t.drawCCTVNames(this.camerasList),e.disableVertexAttribArrayAll()}};var P=function(t,e,r,o){if(!window.Cesium)throw new Error("if basicGlobe is Cesium, add Cesium Library");this.options=r||{},this.DEFALUT_IMAGE="ESRI World Imagery",this.DEFALUT_TERRAIN="WGS84 Ellipsoid",i.call(this,t,e)};(P.prototype=Object.create(i.prototype)).constructor=P,P.prototype.init=function(){this.setCanvasEventHandler(),this.options.animation=this.options.animation||!1,this.options.timeline=this.options.timeline||!1,this.providerBuild(),this.options.shouldAnimate=!1,this.options.baseLayerPicker=!1,this.viewer=new Cesium.Viewer(this.targetId,this.options),this.postProcessDataProvider(),this.initMagoManager()},P.prototype.setCanvasEventHandler=function(){var t=document.getElementById(this.targetId);t.addEventListener("webglcontextlost",function(t){console.log(t)},!1),t.addEventListener("webglcontextrestored",function(t){console.log(t)},!1)},P.prototype.providerBuild=function(){var t=this.policy,e=t.online,i=t.geoserverEnable,r=t.terrainType;if(!e&&!i)throw new Error("If your env is offline, must use geoserver.");i&&t.geoserverImageproviderEnable&&this.geoserverImageProviderBuild(),i&&r===c.cesiumTerrainType.GEOSERVER&&this.geoserverTerrainProviderBuild(),t.cesiumIonToken&&t.cesiumIonToken.length>0&&(Cesium.Ion.defaultAccessToken=t.cesiumIonToken);r=t.terrainType;var o=t.terrainValue;if(r!==c.cesiumTerrainType.GEOSERVER&&!this.options.terrainProvider)switch(this.options.terrainProvider=new Cesium.EllipsoidTerrainProvider,r){case c.cesiumTerrainType.CESIUM_ION_DEFAULT:t.cesiumIonToken&&t.cesiumIonToken.length>0&&(this.options.terrainProvider=new Cesium.CesiumTerrainProvider({url:Cesium.IonResource.fromAssetId(1)}));break;case c.cesiumTerrainType.CESIUM_ION_CDN:(t.cesiumIonToken||t.cesiumIonToken.length>0)&&(this.options.terrainProvider=new Cesium.CesiumTerrainProvider({url:Cesium.IonResource.fromAssetId(parseInt(o))}));break;case c.cesiumTerrainType.CESIUM_CUSTOMER:this.options.terrainProvider=new Cesium.CesiumTerrainProvider({url:o})}this.options.imageryProvider||(this.options.imageryProvider=new Cesium.ArcGisMapServerImageryProvider({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}))},P.prototype.geoserverImageProviderBuild=function(){var t,e=this.policy,i=f.getGeoserver();if(e.geoserverImageproviderEnable||(e.geoserverImageproviderEnable=!0),!e.geoserverImageproviderUrl&&i&&(t=i.getDataRequestUrl()),!(t=e.geoserverImageproviderUrl))throw new Error("If use geoserverImageprovider, geoserverImageproviderUrl is required or input geoserverDataUrl and geoserverDataWorkspace.");var r=e.geoserverImageproviderLayerName;if(!r)throw new Error("If use geoserverImageprovider, geoserverImageproviderLayerName is required.");var o=i&&i.getWmsVersion()?i.getWmsVersion():"1.1.1",n=e.geoserverImageproviderStyleName?e.geoserverImageproviderStyleName:"",a=e.geoserverImageproviderParametersFormat?e.geoserverImageproviderParametersFormat:"image/jpeg",s=e.geoserverImageproviderParametersWidth?e.geoserverImageproviderParametersWidth:256,l=e.geoserverImageproviderParametersHeight?e.geoserverImageproviderParametersHeight:256,h={service:"WMS",version:o,request:"GetMap",styles:n,format:a},d=new Cesium.WebMapServiceImageryProvider({url:t,layers:r,parameters:h,tileWidth:s,tileHeight:l,enablePickFeatures:!1});this.options.imageryProvider=d,this.options.baseLayerPicker=!1},P.prototype.geoserverTerrainProviderBuild=function(){if(!Cesium.GeoserverTerrainProvider)throw new Error("If you want use GeoserverTerrainProvider, GeoserverTerrainProvider plugin required.");var t=this.policy,e={service:"WMTS"},i=t.terrainValue;if(!i)throw new Error("If use geoserverTerrainproviderEnable, geoserverTerrainproviderUrl is required.");var r=t.geoserverTerrainproviderLayerName,o=t.geoserverTerrainproviderStyleName;e.url=i,e.layerName=r,e.styleName=o,e.maxLevel=13,this.options.terrainProvider=new Cesium.GeoserverTerrainProvider(e)},P.prototype.postProcessDataProvider=function(){if(this.viewer.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}}),!this.options.imageryProvider){var t=null;if(this.viewer.baseLayerPicker){var e=this.viewer.baseLayerPicker.viewModel.imageryProviderViewModels;for(var i in e){if(e.hasOwnProperty(i))if((n=e[i]).name===this.DEFALUT_IMAGE){t=n;break}}t&&(this.viewer.baseLayerPicker.viewModel.selectedImagery=t)}else this.viewer.imageryLayers.removeAll(),this.viewer.imageryLayers.addImageryProvider(new Cesium.ArcGisMapServerImageryProvider({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}),0)}if(!this.options.terrainProvider){null!==this.policy.initDefaultTerrain&&""!==this.policy.initDefaultTerrain&&(this.DEFALUT_TERRAIN=this.policy.initDefaultTerrain);var r=null,o=this.viewer.baseLayerPicker.viewModel.terrainProviderViewModels;for(var i in o){var n;if(o.hasOwnProperty(i))if((n=o[i]).name===this.DEFALUT_TERRAIN){r=n;break}}r&&(this.viewer.baseLayerPicker.viewModel.selectedTerrain=r)}},P.prototype.initMagoManager=function(){var t=this.policy,e=this.viewer;this.viewer.scene.magoManager=new tt,this.viewer.scene.magoManager.sceneState.textureFlipYAxis=!1,this.viewer.camera.frustum.fov=1.8*Cesium.Math.PI_OVER_THREE,t.initDefaultFov>0&&(this.viewer.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*t.initDefaultFov);var i=this.viewer.scene.context._gl;this.viewer.scene.magoManager.postFxShadersManager.gl=i,this.viewer.scene.magoManager.postFxShadersManager.createDefaultShaders(i),this.viewer.scene.magoManager.createDefaultShaders(i),this.viewer.scene.magoManager.scene=this.viewer.scene;var r=this.viewer.scene.magoManager;this.magoManager=r,this.viewer.scene,this.viewer.scene.globe.depthTestAgainstTerrain=!1,this.viewer.scene.logarithmicDepthBuffer=!1,this.viewer.scene.highDynamicRange=!1,e.camera.changed.addEventListener(function(t){r.cameraChanged(t)}),e.camera.moveEnd.addEventListener(function(){r.cameraMoveEnd()}),e.camera.moveStart.addEventListener(function(){r.cameraMoveStart()})},P.prototype.setEventHandler=function(){var t=this.magoManager,e=t.scene;this.viewer;this.viewer.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(e.canvas),t.handler.setInputAction(function(e){t.mouseActionLeftDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.LEFT_DOWN),t.handler.setInputAction(function(e){t.mouseActionMiddleDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),t.handler.setInputAction(function(e){t.mouseActionRightDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.RIGHT_DOWN),t.handler.setInputAction(function(e){t.mouseActionMove(e.startPosition,e.endPosition)},Cesium.ScreenSpaceEventType.MOUSE_MOVE),t.handler.setInputAction(function(e){t.mouseActionLeftUp(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.LEFT_UP),t.handler.setInputAction(function(e){t.mouseActionMiddleUp(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_UP),t.handler.setInputAction(function(e){t.mouseActionRightUp(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.RIGHT_UP),t.handler.setInputAction(function(e){t.mouseActionLeftClick(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.LEFT_CLICK),t.handler.setInputAction(function(e){t.mouseActionLeftDoubleClick(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),t.handler.setInputAction(function(e){t.mouseActionRightClick(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.RIGHT_CLICK),this.viewer.clock.onTick.addEventListener(function(e){t.cameraFPV.update(t)})};var w=function(){if(!(this instanceof w))throw new Error(ot.CONSTRUCT_ERROR);this.hero,this.extrasArray};w.prototype.doCheck=function(t){if(void 0===this.hero)return!1;if(void 0===this.extrasArray||0===this.extrasArray.length)return!1;var e=this.hero.data.neoBuilding;if(void 0===e)return!1;var i=e.getCollisionCheckOctree();if(void 0===i)return!1;void 0===t&&(t=[]);for(var r=this.extrasArray.length,o=0;o<r;o++){var n=this.extrasArray[o].data.neoBuilding;if(void 0!==n){var a=n.getCollisionCheckOctree();void 0!==a&&i.checkCollision(a,t)}}};var _=function(t,e,i,r){if(!(this instanceof _))throw new Error(ot.CONSTRUCT_ERROR);this.r=0,this.g=0,this.b=0,this.a=1,void 0!==t&&(this.r=t),void 0!==e&&(this.g=e),void 0!==i&&(this.b=i),void 0!==r&&(this.a=r)};_.grayToRGB_MagoStyle=function(t,e){var i,r,o;return void 0===e&&(e=new _),t>1?t=1:t<0&&(t=0),i=1-t,r=t>.5?2*-t+2:2*t,o=t,e.setRGB(i,r,o),e},_.grayToRGBYCM_MagoStyle=function(t,e){var i,r,o;return void 0===e&&(e=new _),t>1?t=1:t<0&&(t=0),t<.16666?(o=0,r=6*t,i=1):t>=.16666&&t<.33333?(o=0,r=1,i=2-6*t):t>=.33333&&t<.5?(o=6*t-2,r=1,i=0):t>=.5&&t<.66666?(o=1,r=4-6*t,i=0):t>=.66666&&t<.83333?(o=1,r=0,i=6*t-4):t>=.83333&&(o=6-6*t,r=0,i=1),e.setRGB(i,r,o),e},_.prototype.copyFrom=function(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a},_.prototype.deleteObjects=function(){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0},_.mix=function(t,e,i,r){void 0===r&&(r=new _);var o=i,n=t.r*o+e.r*(1-o),a=t.g*o+e.g*(1-o),s=t.b*o+e.b*(1-o),l=t.a*o+e.a*(1-o);return r.setRGBA(n,a,s,l),r},_.prototype.set=function(t,e,i,r){this.r=t,this.g=e,this.b=i,this.a=r},_.prototype.setRGB=function(t,e,i){this.r=t,this.g=e,this.b=i},_.prototype.setRGBA=function(t,e,i,r){this.r=t,this.g=e,this.b=i,this.a=r},_.prototype.getHexCode=function(){var t=255*this.r,e=255*this.g,i=255*this.b;return _.getHexCode(t,e,i)},_.getHexCode=function(t,e,i){var r=255*e,o=255*i;return"#"+(255*t).toString(16).padStart(2,"0")+r.toString(16).padStart(2,"0")+o.toString(16).padStart(2,"0")},_.fromHexCode=function(t,e){var i=parseInt(t.slice(1,3),16),r=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16);return void 0===e&&(e=new _),e.setRGB(i/256,r/256,o/256),e};var S=function(t){_.call(this),this.redFactorSpeed=2,this.greenFactorSpeed=2,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.redFactor=1,this.greenFactor=1,this.blueFactor=1,this.alphaFactor=1,t&&(this.redFactorSpeed=_i(t.redFactorSpeed,1),this.greenFactorSpeed=_i(t.greenFactorSpeed,1),this.blueFactorSpeed=_i(t.blueFactorSpeed,2),this.alphaFactorSpeed=_i(t.alphaFactorSpeed,2),this.redFactor=_i(t.redFactor,1),this.greenFactor=_i(t.greenFactor,1),this.blueFactor=_i(t.blueFactor,1),this.alphaFactor=_i(t.alphaFactor,1))};(S.prototype=Object.create(_.prototype)).constructor=S,S.prototype.updateColorAlarm=function(t){void 0===this.lastTime&&(this.lastTime=t);var e=(t-this.lastTime)/1e3;void 0===this.redFactor&&(this.redFactor=1),void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.redFactor+=this.redFactorSpeed*e,this.greenFactor+=this.greenFactorSpeed*e,this.blueFactor+=this.blueFactorSpeed*e;this.redFactor>1&&(this.redFactor=1,this.redFactorSpeed*=-1);this.redFactor<.5&&(this.redFactor=.5,this.redFactorSpeed*=-1);this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1);this.greenFactor<.1&&(this.greenFactor=.1,this.greenFactorSpeed*=-1);this.blueFactor>.3&&(this.blueFactor=.3,this.blueFactorSpeed*=-1);this.blueFactor<.1&&(this.blueFactor=.1,this.blueFactorSpeed*=-1);this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1);this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.greenFactor>this.redFactor&&(this.greenFactor=this.redFactor),this.setRGBA(this.redFactor,this.greenFactor,this.blueFactor,this.alphaFactor),this.updateTime(t)},S.prototype.updateTime=function(t){this.lastTime=t};var L=function(e){if(!(this instanceof L))throw new Error(ot.CONSTRUCT_ERROR);if(!e||!e instanceof tt)throw new Error("magoManager is required.");t.call(this),this.magoManager=e,this.smartTilePathInfo={}};L.prototype=Object.create(t.prototype),L.prototype.constructor=L,L.prototype.addSmartTileGroup=function(t){var e=this.magoManager;if(Array.isArray(t))for(var i=0,r=t.length;i<r;i++)this.addSmartTileGroup(t[i]);else{var o,n,a=t.data_key||t.dataGroupId;t.data_key?(o=a,n=a):(o=(o=t.dataGroupPath).replace(/\/+$/,""),n=t.dataGroupKey),this.smartTilePathInfo[n]||(this.smartTilePathInfo[n]={}),this.smartTilePathInfo[n].projectId=a,this.smartTilePathInfo[n].projectFolderPath=o,t.smartTileIndexPath&&e.getObjectIndexFileSmartTileF4d(t.smartTileIndexPath)}},L.prototype.addF4dGroup=function(t){var e=this.magoManager;if(Array.isArray(t))for(var i=0,r=t.length;i<r;i++)this.addF4dGroup(t[i]);else{var o,n=t.data_key||t.dataKey||t.dataGroupId;o=t.data_key?n:(o=t.dataGroupPath).replace(/\/+$/,""),f.setData(c.PROJECT_ID_PREFIX+n,t),f.setProjectDataFolder(c.PROJECT_DATA_FOLDER_PREFIX+o,o),e.getObjectIndexFile(n,o)}},L.prototype.addF4dMember=function(t,e){if(!t)throw new Error("groupId is required.");this.magoManager.getObjectIndexFileForData(t,e)},L.prototype.deleteF4dGroup=function(t){if(!t)throw new Error("groupId is required.");var e=this.magoManager.hierarchyManager.getNodesMap(t);if(!e)throw new Error(t+" group is no exists.");for(var i=Object.keys(e),r=0,o=i.length;r<o;r++){var n=i[r];if("attributes"!==n)e[i[r]].data.attributes.isPhysical&&this.deleteF4dMember(t,n)}delete this.magoManager.hierarchyManager.projectsMap[t]},L.prototype.deleteF4dMember=function(t,e){if(!t)throw new Error("groupId is required.");if(!e)throw new Error("memberId is required.");var i=this.magoManager.hierarchyManager.getNodeByDataKey(t,e);if(!i)throw new Error("node is no exists.");var r=i.data.smartTileOwner;r&&r.eraseNode(i),i.deleteObjects(this.magoManager.sceneState.gl,this.magoManager.vboMemoryManager),delete this.magoManager.hierarchyManager.projectsMap[t][e]},L.f4dObjectValidate=function(t){console.info(t)};var R=function(t,e,i,r){if(!(this instanceof R))throw new Error(ot.CONSTRUCT_ERROR);var o;if(this.gl=t,this.width=new Int32Array(1),this.height=new Int32Array(1),this.fbo=t.createFramebuffer(),this.depthBuffer=t.createRenderbuffer(),r&&void 0!==r.colorBuffer&&(o=r.colorBuffer),this.colorBuffer=void 0!==o?o:t.createTexture(),this.dirty=!0,this.width[0]=e,this.height[0]=i,t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.colorBuffer),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],i[0],0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],i[0]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.colorBuffer,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";t.bindFramebuffer(t.FRAMEBUFFER,null)};R.prototype.setColorBuffer=function(t){this.colorBuffer=t;var e=this.gl;if(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width[0],this.height[0],0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width[0],this.height[0]),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";e.bindFramebuffer(e.FRAMEBUFFER,null)},R.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)},R.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},R.prototype.deleteObjects=function(t){this.depthBuffer&&t.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=void 0,this.colorBuffer&&t.deleteTexture(this.colorBuffer),this.colorBuffer=void 0,this.fbo&&t.deleteFramebuffer(this.fbo),this.fbo=void 0},R.createBuffer=function(t,e){var i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),i},R.bindFramebuffer=function(t,e,i){t.bindFramebuffer(t.FRAMEBUFFER,e),i&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0)},R.bindAttribute=function(t,e,i,r){t.bindBuffer(t.ARRAY_BUFFER,e),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,r,t.FLOAT,!1,0,0)},R.bindTexture=function(t,e,i){t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,e)};var D=function(){if(!(this instanceof D))throw new Error(ot.CONSTRUCT_ERROR);this.maxFilesRequestedCount=1,this.filesRequestedCount=0,this.headerFilesRequestedCount=0,this.modelRefFilesRequestedCount=0,this.lowLodDataRequestedCount=0,this.lowLodImagesRequestedCount=0,this.multiBuildingsDataRequestedCount=0,this.tinTerrainFilesRequested=0,this.tinTerrainTexturesRequested=0};D.prototype.isFull=function(){return this.filesRequestedCount>=this.maxFilesRequestedCount},D.prototype.isFullHeaders=function(){return this.headerFilesRequestedCount>=1},D.prototype.isFullPlus=function(t){return void 0===t&&(t=0),this.filesRequestedCount>=this.maxFilesRequestedCount+t},D.prototype.isFullPlusModelReferences=function(t){return void 0===t&&(t=0),this.modelRefFilesRequestedCount>=this.maxFilesRequestedCount+t},D.prototype.isFullPlusLowLodData=function(t){return void 0===t&&(t=0),this.lowLodDataRequestedCount>=this.maxFilesRequestedCount+t},D.prototype.isFullPlusLowLodImages=function(t){return void 0===t&&(t=0),this.lowLodImagesRequestedCount>=this.maxFilesRequestedCount+t};var E={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1};function I(t){switch(t){case 37:return"moveLeft";case 38:return"moveForward";case 39:return"moveRight";case 40:return"moveBackward";default:return}}function O(t){var e=I(t.keyCode);void 0!==e&&(E[e]=!0)}function F(t){var e=I(t.keyCode);void 0!==e&&(E[e]=!1)}function N(){this._camera=void 0,this._cameraBAK=void 0,this._position=new ur,this._rotation=new ur,this._positionSpeed=1,this._ratationSpeed=1}Object.defineProperties(N.prototype,{camera:{get:function(){return this._camera},set:function(t){this._camera=t}},position:{get:function(){return this._position},set:function(t){this._position=t}},rotation:{get:function(){return this._rotation},set:function(t){this._rotation=t}},positionSpeed:{get:function(){return this._positionSpeed},set:function(t){this._positionSpeed=t}},rotationSpeed:{get:function(){return this._ratationSpeed},set:function(t){this._ratationSpeed=t}}}),N.prototype.init=function(){this._position.set(0,0,0),this._rotation.set(0,0,0),document.addEventListener("keydown",O,!1),document.addEventListener("keyup",F,!1)},N.prototype.release=function(){this._camera=void 0,this._cameraBAK=void 0,document.removeEventListener("keydown",O,!1),document.removeEventListener("keyup",F,!1)},N.prototype.move=function(t){var e=glMatrix.vec3.fromValues(this._position.x,this._position.y,this.position.z),i=glMatrix.mat4.create();glMatrix.mat4.rotateY(i,i,this._rotation.y),glMatrix.vec3.transformMat4(t,t,i),glMatrix.vec3.add(e,e,t),this._position.set(e[0],e[1],e[2])},N.prototype.update=function(t){void 0!==this._camera&&(E.moveForward&&(this._camera.moveForward(.5),this.move(vec3.fromValues(0,1,0))),E.moveBackward&&(this._camera.moveBackward(.5),this.move(vec3.fromValues(0,-1,0))),E.moveLeft&&(this._camera.lookLeft(.1),this.move(vec3.fromValues(-1,0,0))),E.moveRight&&(this._camera.lookRight(.1),this.move(vec3.fromValues(1,0,0))))};var B=function(){if(!(this instanceof B))throw new Error(ot.CONSTRUCT_ERROR);this.near=new Float32Array([.1]),this.far=new Float32Array([1e3]),this.fovyRad=new Float32Array([.8037]),this.tangentOfHalfFovy=new Float32Array([0]),this.fovRad=new Float32Array([1.047]),this.aspectRatio=new Float32Array([1.3584]),this.planesArray=[],this.dirty=!0;for(var t=0;t<6;t++){var e=new ut;this.planesArray.push(e)}};B.prototype.copyParametersFrom=function(t){this.near[0]=t.near[0],this.far[0]=t.far[0],this.fovyRad[0]=t.fovyRad[0],this.tangentOfHalfFovy[0]=t.tangentOfHalfFovy[0],this.fovRad[0]=t.fovRad[0],this.aspectRatio[0]=t.aspectRatio[0]},B.prototype.setNear=function(t){this.near[0]=t},B.prototype.setFar=function(t){this.far[0]=t},B.prototype.intersectionNearFarSphere=function(t){for(var e=!1,i=0;i<2;i++){var r=this.planesArray[i].intersectionSphere(t);if(r===u.INTERSECTION_OUTSIDE)return u.INTERSECTION_OUTSIDE;r===u.INTERSECTION_INTERSECT&&(e=!0)}return e?u.INTERSECTION_INTERSECT:u.INTERSECTION_INSIDE},B.prototype.intersectionSphere=function(t){for(var e=!1,i=0;i<6;i++){var r=this.planesArray[i].intersectionSphere(t);if(r===u.INTERSECTION_OUTSIDE)return u.INTERSECTION_OUTSIDE;r===u.INTERSECTION_INTERSECT&&(e=!0)}return e?u.INTERSECTION_INTERSECT:u.INTERSECTION_INSIDE};var V=function(){if(!(this instanceof V))throw new Error(ot.CONSTRUCT_ERROR);this.frustumVolumensMap={}};V.prototype.getFrustumVolumeCulling=function(t){return this.frustumVolumensMap.hasOwnProperty(t)||(this.frustumVolumensMap[t]={},this.frustumVolumensMap[t].intersectedTilesArray=[],this.frustumVolumensMap[t].visibleNodes=new Bt),this.frustumVolumensMap[t]},V.prototype.initArrays=function(){var t;for(var e in this.frustumVolumensMap)Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,e)&&((t=this.frustumVolumensMap[e]).intersectedTilesArray.length=0,t.visibleNodes.initArrays())},V.prototype.getTotalBoundingFrustum=function(t){var e;for(var i in t={},this.frustumVolumensMap)if(Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,i)&&(e=this.frustumVolumensMap[i]).intersectedTilesArray.length>0){var r=e.visibleNodes.bFrustumNear,o=e.visibleNodes.bFrustumFar;void 0!==r&&void 0!==o&&(void 0===t.bFrustumNear?t.bFrustumNear=r:r<t.bFrustumNear&&(t.bFrustumNear=r),void 0===t.bFrustumFar?t.bFrustumFar=o:o>t.bFrustumFar&&(t.bFrustumFar=o))}return t},V.prototype.calculateBoundingFrustums=function(t){var e;for(var i in this.frustumVolumensMap)Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,i)&&(e=this.frustumVolumensMap[i]).intersectedTilesArray.length>0&&e.visibleNodes.calculateBoundingFrustum(t)};var j=function(t,e,i){if(!(this instanceof j))throw new Error(ot.CONSTRUCT_ERROR);this.longitude,this.latitude,this.altitude,void 0!==t&&(this.longitude=t),void 0!==e&&(this.latitude=e),void 0!==i&&(this.altitude=i),this.absolutePoint,this.vboKeysContainer,this.geoLocDataManager,this.owner};j.prototype.deleteObjects=function(t){this.longitude=void 0,this.latitude=void 0,this.altitude=void 0,void 0!==this.absolutePoint&&(this.absolutePoint.deleteObjects(),this.absolutePoint=void 0),void 0!==this.vboKeysContainer&&this.vboKeysContainer.deleteGlObjects(t.gl,t),void 0!==this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.owner=void 0},j.prototype.getWgs84Point3D=function(t){var e=W.geographicToCartesianWgs84(this.longitude,this.latitude,this.altitude,void 0);return void 0===t&&(t=new ur),t.set(e[0],e[1],e[2]),t},j.prototype.getMercatorProjection=function(t){return W.geographicToMercatorProjection(this.longitude,this.latitude,t)},j.prototype.makeDefaultGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new H);var t=this.geoLocDataManager.getCurrentGeoLocationData();void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default"),t=Ei.calculateGeoLocationData(this.longitude,this.latitude,this.altitude,void 0,void 0,void 0,t))},j.prototype.getGeoLocationDataManager=function(){return void 0===this.geoLocDataManager&&(this.geoLocDataManager=new H),this.geoLocDataManager},j.prototype.copyFrom=function(t){this.longitude=t.longitude,this.latitude=t.latitude,this.altitude=t.altitude},j.prototype.setLonLatAlt=function(t,e,i){void 0!==t&&(this.longitude=t),void 0!==e&&(this.latitude=e),void 0!==i&&(this.altitude=i)},j.prototype.setLongitude=function(t){this.longitude=t},j.prototype.setLatitude=function(t){this.latitude=t},j.prototype.setAltitude=function(t){this.altitude=t},j.prototype.getLatitudeRad=function(){if(void 0!==this.latitude)return this.latitude*Math.PI/180},j.prototype.getLongitudeRad=function(){if(void 0!==this.longitude)return this.longitude*Math.PI/180},j.getMidPoint=function(t,e,i){var r=(t.latitude+e.latitude)/2,o=(t.longitude+e.longitude)/2,n=(t.altitude+e.altitude)/2;return void 0===i?i=new j(o,r,n):i.setLonLatAlt(o,r,n),i},j.getAngleBetweenCoords=function(t,e){var i=e.longitude-t.longitude,r=e.latitude-t.latitude;return Math.sqrt(i*i+r*r)},j.prototype.prepareData=function(t){if(void 0===this.vboKeysContainer&&(this.vboKeysContainer=new Nt),0===this.vboKeysContainer.getVbosCount()){var e=this.vboKeysContainer.newVBOVertexIdxCacheKey(),i=new Float32Array([0,0,0]);e.setDataArrayPos(i,t)}return!0},j.prototype.readDataFromBuffer=function(t,e){return this.longitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.latitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.altitude=new Float32Array(t.slice(e,e+4))[0],e+=4},j.prototype.renderPoint=function(t,e,i,r){if(!this.prepareData(t.vboMemoryManager))return!1;if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,e),2===r){var o=t.selectionManager,n=t.selectionColor,a=n.getAvailableColor(void 0),s=n.decodeColor3(a.r,a.g,a.b);o.setCandidateGeneral(s,this),i.uniform4fv(e.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1])}var l=this.vboKeysContainer.vboCacheKeysArray[0];if(!l.bindDataPosition(e,t.vboMemoryManager))return!1;i.drawArrays(i.POINTS,0,l.vertexCount)};var U=function(t,e){if(!(this instanceof U))throw new Error(ot.CONSTRUCT_ERROR);this.strGeoCoord=t,this.endGeoCoord=e};U.calculateHeadingAngRadToNorthOfSegment=function(t,e){var i=t.strGeoCoord,r=t.endGeoCoord,o=Ei.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,e),n=Ei.geographicCoordToWorldPoint(r.longitude,r.latitude,r.altitude,void 0,e),a=Ei.calculateGeoLocationMatrixAtWorldPosition(o,void 0),s=glMatrix.mat4.create();s=glMatrix.mat4.invert(s,a._floatArrays);var l=new rt;l.setByFloat32Array(s);var h=l.transformPoint3D(n,void 0),d=new dr(0,1),c=new dr(h.x,h.y);c.unitary();var u=d.angleRadToVector(c);return c.x>0&&(u*=-1),u},U.getLengthInMeters=function(t,e){var i=t.strGeoCoord,r=t.endGeoCoord,o=Ei.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,e),n=Ei.geographicCoordToWorldPoint(r.longitude,r.latitude,r.altitude,void 0,e);return o.distToPoint(n)},U.getDirection=function(t,e){if(void 0===t)return e;var i=t.endGeoCoord.longitude-t.strGeoCoord.longitude,r=t.endGeoCoord.latitude-t.strGeoCoord.latitude,o=t.endGeoCoord.altitude-t.strGeoCoord.altitude;return void 0===e&&(e=new ur),e.set(i,r,o),e.unitary(),e},U.getLine=function(t,e){void 0===e&&(e=new Yi);var i=U.getDirection(t,void 0),r=t.strGeoCoord;return e.setPointAndDir(r.longitude,r.latitude,r.altitude,i.x,i.y,i.z),e},U.getProjectedCoordToLine=function(t,e,i){var r=U.getLine(t,void 0),o=new ur(e.longitude,e.latitude,e.altitude),n=r.getProjectedPoint(o,void 0);return void 0===i&&(i=new j),i.setLonLatAlt(n.x,n.y,n.z),i},U.intersectionWithGeoCoord=function(t,e){var i=t.strGeoCoord,r=t.endGeoCoord,o=new ur(e.longitude,e.latitude,e.altitude),n=new ur(i.longitude,i.latitude,i.altitude),a=new ur(r.longitude,r.latitude,r.altitude),s=new _r(n,a).getLength(),l=n.distToPoint(o)+a.distToPoint(o);return Math.abs(s-l)<1e-7},U.getNearestGeoCoord=function(t,e){var i=t.strGeoCoord,r=t.endGeoCoord,o=new ur(e.longitude,e.latitude,e.altitude),n=new ur(i.longitude,i.latitude,i.altitude),a=new ur(r.longitude,r.latitude,r.altitude);return n.distToPoint(o)<a.distToPoint(o)?i:r},U.getArcInterpolatedGeoCoords=function(t,e,i,r){void 0===i&&(i=2e3);var o=W.getArcDistanceBetweenGeographicCoords(t,e),n=Math.ceil(o/i),a=t.longitude,s=t.latitude,l=t.altitude,h=(e.longitude-a)/n,d=(e.latitude-s)/n,c=(e.altitude-l)/n;void 0===r&&(r=[]);for(var u=0;u<n+1;u++){var f=new j(a+h*u,s+d*u,l+c*u);r.push(f)}return r};var k=function(t){if(!(this instanceof k))throw new Error(ot.CONSTRUCT_ERROR);this.geographicCoordsArray=void 0!==t?t:[],this.vboKeysContainer,this.owner,this.id,this.points3dList};k.prototype.newGeoCoord=function(t,e,i){var r=new j(t,e,i);return this.addGeoCoord(r),r},k.prototype.addGeoCoord=function(t){this.geographicCoordsArray.push(t),t.owner=this},k.prototype.addGeoCoordsArray=function(t){for(var e=t.length,i=0;i<e;i++)this.geographicCoordsArray.push(t[i]),t[i].owner=this},k.prototype.getGeoCoord=function(t){if(void 0!==this.geographicCoordsArray)return this.geographicCoordsArray[t]},k.prototype.getGeoCoordsCount=function(){return void 0===this.geographicCoordsArray?0:this.geographicCoordsArray.length},k.prototype.getGeoCoordSegment=function(t,e){if(void 0===this.geographicCoordsArray)return e;var i,r=this.geographicCoordsArray.length;if(r<=1)return e;if(t>r-1)return e;i=t===r-1?0:t+1;var o=this.getGeoCoord(t),n=this.getGeoCoord(i);return void 0===e&&(e=new U),e.strGeoCoord=o,e.endGeoCoord=n,e},k.prototype.getCopy=function(t){void 0===t&&(t=new k);for(var e=this.getGeoCoordsCount(),i=0;i<e;i++){var r=this.getGeoCoord(i),o=new j(r.longitude,r.latitude,r.altitude);t.addGeoCoord(o)}return t},k.getPointsRelativeToGeoLocation=function(t,e,i){void 0===i&&(i=[]);for(var r=e.length,o=0;o<r;o++){var n=e[o],a=n.getGeoLocationDataManager(),s=a.getCurrentGeoLocationData();void 0===s&&(n.makeDefaultGeoLocationData(),s=a.getCurrentGeoLocationData());var l=s.position;i[o]=t.getTransformedRelativePosition(l,i[o])}return i},k.getRenderableObjectOfGeoCoordsArray=function(t,i,r){if(void 0!==t&&0!==t.length){var o=t[0],n=Ei.calculateGeoLocationData(o.longitude,o.latitude,o.altitude,0,0,0,void 0),a=k.getPointsRelativeToGeoLocation(n,t,void 0);void 0===r?r={thickness:2}:void 0===r.thickness&&(r.thickness=2);var s=new Ye(r);s.vboKeysContainer=fr.getVboThickLines(i,a,s.vboKeysContainer,r);var l=new ke;return l.geoLocDataManager=new H,l.geoLocDataManager.addGeoLocationData(n),l.objectType=e.OBJECT_TYPE.VECTORMESH,l.objectsArray.push(s),l}},k.prototype.getPointsWorldCoord=function(t){void 0===t&&(t=[]);for(var e=this.getGeoCoordsCount(),i=0;i<e;i++){var r=this.getGeoCoord(i),o=r.getGeoLocationDataManager(),n=o.getCurrentGeoLocationData();void 0===n&&(r.makeDefaultGeoLocationData(),n=o.getCurrentGeoLocationData());var a=n.position;t[i]=a}return t},k.prototype.deleteObjects=function(t){if(void 0!==this.geographicCoordsArray){for(var e=this.getGeoCoordsCount(),i=0;i<e;i++)this.geographicCoordsArray[i].deleteGlObjects(t),this.geographicCoordsArray[i]=void 0;this.geographicCoordsArray=void 0}void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t),this.vboKeysContainer=void 0),this.owner=void 0},k.prototype.test__makeThickLines=function(t){if(this.makeLines(t),void 0!==this.points3dList){var e=fr.getVboThickLines(t,this.points3dList.pointsArray,void 0);this.points3dList.vboKeysContainer=e}},k.prototype.getGeographicExtent=function(t){var e;t||(t=new G);for(var i=this.geographicCoordsArray.length,r=0;r<i;r++)e=this.geographicCoordsArray[r],0===r?t.setInitExtent(e.longitude,e.latitude,e.altitude):t.addGeographicCoord(e);return t},k.prototype.getMiddleGeographicCoords=function(t){return this.getGeographicExtent().getMidPoint(t)},k.prototype.addAltitude=function(t){for(var e=this.geographicCoordsArray.length,i=0;i<e;i++)this.geographicCoordsArray[i].altitude+=t},k.prototype.getExtrudedMeshRenderableObject=function(t,e,i,r,o){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return i;i||(i=new ke),i.geoLocDataManager=new H;var n=i.geoLocDataManager.newGeoLocationData(),a=this.getMiddleGeographicCoords(),s=this.getCopy();s.addAltitude(t),Ei.calculateGeoLocationData(a.longitude,a.latitude,a.altitude,0,0,0,n);var l=k.getPointsRelativeToGeoLocation(n,this.geographicCoordsArray,void 0),h=k.getPointsRelativeToGeoLocation(n,s.geographicCoordsArray,void 0),d=new Hr;d.newVtxProfile().makeByPoints3DArray(l,void 0),d.newVtxProfile().makeByPoints3DArray(h,void 0);var c=d.getMesh(void 0,!0,!0).getCopySurfaceIndependentMesh();return c.calculateVerticesNormals(),i.objectsArray.push(c),i},k.prototype.makeLines=function(t){if(void 0===this.geographicCoordsArray||0===this.geographicCoordsArray.length)return!1;void 0===this.points3dList&&(this.points3dList=new fr);var e=this.points3dList.getGeographicLocation(),i=this.getGeoCoord(0),r=i.getGeoLocationDataManager().getCurrentGeoLocationData();void 0===r&&(r=Ei.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,r,t)),e.copyFrom(r);var o=k.getPointsRelativeToGeoLocation(e,this.geographicCoordsArray,void 0);this.points3dList.deleteVboKeysContainer(t),this.points3dList.deletePoints3d(),this.points3dList.addPoint3dArray(o)},k.prototype.renderLines=function(t,e,i,r,o){if(void 0===this.geographicCoordsArray)return!1;if(void 0===this.points3dList)return!1;(e=t.postFxShadersManager.getShader("pointsCloud")).useProgram(),e.disableVertexAttribArrayAll(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals();var n=t.sceneState.gl;n.uniform1i(e.bPositionCompressed_loc,!1),n.uniform1i(e.bUse1Color_loc,!0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,1]),n.uniform1f(e.fixPointSize_loc,5),n.uniform1i(e.bUseFixPointSize_loc,!0),this.points3dList.renderLines(t,e,i,r,o),e.disableVertexAttribArrayAll()},k.prototype.renderPoints=function(t,e,i,r){if(void 0===this.geographicCoordsArray)return!1;var o,n=t.sceneState.gl,a=t.postFxShadersManager.getShader("pointsCloud");a.useProgram(),a.disableVertexAttribArrayAll(),a.resetLastBuffersBinded(),a.enableVertexAttribArray(a.position3_loc),a.bindUniformGenerals(),n.uniform1i(a.bPositionCompressed_loc,!1),n.uniform1i(a.bUse1Color_loc,!0),n.uniform4fv(a.oneColor4_loc,[1,1,.1,1]),n.uniform1f(a.fixPointSize_loc,5),n.uniform1i(a.bUseFixPointSize_loc,1),void 0===r&&(r=!0),r?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST);for(var s=this.geographicCoordsArray.length,l=0;l<s;l++)(o=this.geographicCoordsArray[l]).renderPoint(t,a,n,i);var h=t.selectionManager.getSelectedGeneral();void 0!==h&&"GeographicCoord"===h.constructor.name&&(n.uniform4fv(a.oneColor4_loc,[1,.1,.1,1]),n.uniform1f(a.fixPointSize_loc,10),h.renderPoint(t,a,n,i)),a.disableVertexAttribArrayAll(),n.enable(n.DEPTH_TEST);var d=t.getObjectLabel().getContext("2d");d.clearRect(0,0,d.canvas.width,d.canvas.height),d.font="13px Arial";var c,u;for(n=t.sceneState.gl,l=0;l<s;l++){if(c=(o=this.geographicCoordsArray[l]).getGeoLocationDataManager().getCurrentGeoLocationData().position,(u=Ei.calculateWorldPositionToScreenCoord(n,c.x,c.y,c.z,u,t)).x+=15,u.y-=15,u.x>=0&&u.y>=0){var f="lon: "+o.longitude.toFixed(5)+", lat: "+o.latitude.toFixed(5);d.strokeText(f,u.x,u.y),d.fillText(f,u.x,u.y)}}d.restore(),e.useProgram()},k.prototype.getWgs84Points3D=function(t){void 0===t&&(t=[]);for(var e=this.geographicCoordsArray.length,i=0;i<e;i++){var r=this.geographicCoordsArray[i].getWgs84Point3D(void 0);t.push(r)}return t};var G=function(t,e,i,r,o,n){if(!(this instanceof G))throw new Error(ot.CONSTRUCT_ERROR);this.minGeographicCoord,this.maxGeographicCoord,void 0!==t&&void 0!==e&&void 0!==i&&(void 0===this.minGeographicCoord&&(this.minGeographicCoord=new j),this.minGeographicCoord.setLonLatAlt(t,e,i)),void 0!==r&&void 0!==o&&void 0!==n&&(void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new j),this.maxGeographicCoord.setLonLatAlt(r,o,n))};G.prototype.deleteObjects=function(){void 0!==this.minGeographicCoord&&(this.minGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0),void 0!==this.maxGeographicCoord&&(this.maxGeographicCoord.deleteObjects(),this.maxGeographicCoord=void 0)},G.prototype.setExtent=function(t,e,i,r,o,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new j),this.minGeographicCoord.setLonLatAlt(t,e,i),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new j),this.maxGeographicCoord.setLonLatAlt(r,o,n)},G.prototype.setInitExtent=function(t,e,i){this.setExtent(t,e,i,t,e,i)},G.prototype.addGeographicCoord=function(t){var e=t.longitude,i=t.latitude,r=t.altitude;void 0===this.minGeographicCoord?(this.minGeographicCoord=new j,this.minGeographicCoord.setLonLatAlt(e,i,r)):(e<this.minGeographicCoord.longitude&&this.minGeographicCoord.setLongitude(e),i<this.minGeographicCoord.latitude&&this.minGeographicCoord.setLatitude(i),r<this.minGeographicCoord.altitude&&this.minGeographicCoord.setAltitude(r)),void 0===this.maxGeographicCoord?(this.maxGeographicCoord=new j,this.maxGeographicCoord.setLonLatAlt(e,i,r)):(e>this.maxGeographicCoord.longitude&&this.maxGeographicCoord.setLongitude(e),i>this.maxGeographicCoord.latitude&&this.maxGeographicCoord.setLatitude(i),r>this.maxGeographicCoord.altitude&&this.maxGeographicCoord.setAltitude(r))},G.prototype.getCenterLongitude=function(){var t=this.minGeographicCoord.longitude;return(this.maxGeographicCoord.longitude+t)/2},G.prototype.getCenterLatitude=function(){var t=this.minGeographicCoord.latitude;return(this.maxGeographicCoord.latitude+t)/2},G.prototype.getCenterAltitude=function(){var t=this.minGeographicCoord.altitude;return(this.maxGeographicCoord.altitude+t)/2},G.prototype.getMidPoint=function(t){return j.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,t)},G.prototype.getMinLatitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLatitudeRad()},G.prototype.getMinAltitude=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.altitude},G.prototype.getMaxAltitude=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.altitude},G.prototype.getMinLongitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLongitudeRad()},G.prototype.getMaxLatitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLatitudeRad()},G.prototype.getMaxLongitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLongitudeRad()},G.prototype.intersects2dWithGeoCoord=function(t){var e=t.longitude,i=t.latitude;return e>this.minGeographicCoord.longitude&&e<this.maxGeographicCoord.longitude&&i>this.minGeographicCoord.latitude&&i<this.maxGeographicCoord.latitude},G.prototype.intersects2dWithGeoExtent=function(t){var e=this.minGeographicCoord,i=this.maxGeographicCoord,r=t.minGeographicCoord,o=t.maxGeographicCoord;return!(e.longitude>o.longitude||i.longitude<r.longitude)&&!(e.latitude>o.latitude||i.latitude<r.latitude)};var z=function(t){if(!(this instanceof z))throw new Error(ot.CONSTRUCT_ERROR);this.name,this.name=void 0===t?"noName":t,this.geographicCoord,this.heading,this.pitch,this.roll,this.date,this.position,this.positionHIGH,this.positionLOW,this.pivotPoint,this.geoLocMatrix,this.geoLocMatrixInv,this.tMatrix,this.tMatrixInv,this.rotMatrix,this.rotMatrixInv,this.pivotPointTraslationLC,this.rotMatrixLC};z.prototype.setRotationHeadingPitchRoll=function(t,e,i){void 0!==t&&(this.heading=t),void 0!==e&&(this.pitch=e),void 0!==i&&(this.roll=i)},z.prototype.getGeographicCoords=function(){return this.geographicCoord},z.prototype.setGeographicCoordsLonLatAlt=function(t,e,i){void 0===this.geographicCoord&&(this.geographicCoord=new j),this.geographicCoord.setLonLatAlt(t,e,i)},z.prototype.deleteObjects=function(t){this.name=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(t),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.date=void 0,this.position&&this.position.deleteObjects(),this.position=void 0,this.positionHIGH=void 0,this.positionLOW=void 0,this.pivotPoint&&this.pivotPoint.deleteObjects(),this.pivotPoint=void 0,this.geoLocMatrix&&this.geoLocMatrix.deleteObjects(),this.geoLocMatrixInv&&this.geoLocMatrixInv.deleteObjects(),this.tMatrix&&this.tMatrix.deleteObjects(),this.tMatrixInv&&this.tMatrixInv.deleteObjects(),this.rotMatrix&&this.rotMatrix.deleteObjects(),this.rotMatrixInv&&this.rotMatrixInv.deleteObjects(),this.geoLocMatrix=void 0,this.geoLocMatrixInv=void 0,this.tMatrix=void 0,this.tMatrixInv=void 0,this.rotMatrix=void 0,this.rotMatrixInv=void 0,this.pivotPointTraslationLC&&this.pivotPointTraslationLC.deleteObjects(),this.pivotPointTraslationLC=void 0},z.prototype.doEffectivePivotPointTranslation=function(){var t;t=void 0===this.pivotPointTraslationLC?new ur(0,0,0):this.tMatrix.rotatePoint3D(this.pivotPointTraslationLC,t);var e=this.geographicCoord;this.position=Ei.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,this.position),void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array([0,0,0])),void 0===this.positionLOW&&(this.positionLOW=new Float32Array([0,0,0])),Ei.calculateSplited3fv([this.position.x,this.position.y,this.position.z],this.positionHIGH,this.positionLOW),this.position.x+=t.x,this.position.y+=t.y,this.position.z+=t.z,this.positionLOW[0]+=t.x,this.positionLOW[1]+=t.y,this.positionLOW[2]+=t.z,void 0===this.pivotPoint&&(this.pivotPoint=new ur),this.pivotPoint.set(this.position.x,this.position.y,this.position.z)},z.prototype.copyFrom=function(t){void 0!==t&&(this.name=t.name,t.geographicCoord&&(void 0===this.geographicCoord&&(this.geographicCoord=new j),this.geographicCoord.copyFrom(t.geographicCoord)),this.heading=t.heading,this.pitch=t.pitch,this.roll=t.roll,this.date=t.date,t.position&&(void 0===this.position&&(this.position=new ur),this.position.copyFrom(t.position)),t.positionHIGH&&(void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array(3)),this.positionHIGH[0]=t.positionHIGH[0],this.positionHIGH[1]=t.positionHIGH[1],this.positionHIGH[2]=t.positionHIGH[2]),t.positionLOW&&(void 0===this.positionLOW&&(this.positionLOW=new Float32Array(3)),this.positionLOW[0]=t.positionLOW[0],this.positionLOW[1]=t.positionLOW[1],this.positionLOW[2]=t.positionLOW[2]),t.pivotPoint&&(void 0===this.pivotPoint&&(this.pivotPoint=new ur),this.pivotPoint.copyFrom(t.pivotPoint)),t.geoLocMatrix&&(void 0===this.geoLocMatrix&&(this.geoLocMatrix=new rt),this.geoLocMatrix.copyFromMatrix4(t.geoLocMatrix)),t.geoLocMatrixInv&&(void 0===this.geoLocMatrixInv&&(this.geoLocMatrixInv=new rt),this.geoLocMatrixInv.copyFromMatrix4(t.geoLocMatrixInv)),t.tMatrix&&(void 0===this.tMatrix&&(this.tMatrix=new rt),this.tMatrix.copyFromMatrix4(t.tMatrix)),t.tMatrixInv&&(void 0===this.tMatrixInv&&(this.tMatrixInv=new rt),this.tMatrixInv.copyFromMatrix4(t.tMatrixInv)),t.rotMatrix&&(void 0===this.rotMatrix&&(this.rotMatrix=new rt),this.rotMatrix.copyFromMatrix4(t.rotMatrix)),t.rotMatrixInv&&(void 0===this.rotMatrixInv&&(this.rotMatrixInv=new rt),this.rotMatrixInv.copyFromMatrix4(t.rotMatrixInv)),t.aditionalTraslation&&(void 0===this.aditionalTraslation&&(this.aditionalTraslation=new ur),this.aditionalTraslation.copyFrom(t.aditionalTraslation)))},z.prototype.localCoordToWorldCoord=function(t,e){if(void 0!==t&&void 0!==this.tMatrix)return void 0===e&&(e=new ur),e=this.tMatrix.transformPoint3D(t,e)},z.prototype.worldCoordToLocalCoord=function(t,e){var i=this.getTMatrixInv();if(void 0!==t&&void 0!==i)return void 0===e&&(e=new ur),e=i.transformPoint3D(t,e)},z.prototype.getLocMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new rt,this.geoLocMatrixInv.setByFloat32Array(t)}return this.geoLocMatrixInv},z.prototype.getRotMatrixInv=function(){if(void 0===this.rotMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.rotMatrix._floatArrays),this.rotMatrixInv=new rt,this.rotMatrixInv.setByFloat32Array(t)}return this.rotMatrixInv},z.prototype.getTMatrixInv=function(){if(void 0===this.tMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.tMatrix._floatArrays),this.tMatrixInv=new rt,this.tMatrixInv.setByFloat32Array(t)}return this.tMatrixInv},z.prototype.getRotMatrixLC=function(){if(void 0===this.rotMatrixLC){var t=new rt,e=new rt,i=new rt,r=this.heading,o=this.pitch,n=this.roll;void 0!==r&&0!==r&&i.rotationAxisAngDeg(r,0,0,1),void 0!==o&&0!==o&&t.rotationAxisAngDeg(o,1,0,0),void 0!==n&&0!==n&&e.rotationAxisAngDeg(n,0,1,0);var a,s,l,h=new rt;a=i.getMultipliedByMatrix(h,a),s=t.getMultipliedByMatrix(a,s),l=e.getMultipliedByMatrix(s,l),this.rotMatrixLC=l}return this.rotMatrixLC},z.prototype.getGeoLocationMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var t=glMatrix.mat4.create();t=glMatrix.mat4.invert(t,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new rt,this.geoLocMatrixInv.setByFloat32Array(t)}return this.geoLocMatrixInv},z.prototype.getTransformedRelativeCamera=function(t,e){void 0===e&&(e=new A);var i=new ur;i.set(t.position.x-this.position.x,t.position.y-this.position.y,t.position.z-this.position.z);var r=this.getRotMatrixInv();return e.position=r.transformPoint3D(i,e.position),i.set(t.direction.x,t.direction.y,t.direction.z),e.direction=r.transformPoint3D(i,e.direction),i.set(t.up.x,t.up.y,t.up.z),e.up=r.transformPoint3D(i,e.up),i.x=void 0,i.y=void 0,i.z=void 0,i=void 0,e},z.prototype.getTransformedRelativePositionNoApplyHeadingPitchRoll=function(t,e){void 0===e&&(e=new ur);var i=new ur;return i.set(t.x,t.y,t.z),e=this.getLocMatrixInv().transformPoint3D(i,e)},z.prototype.getTransformedRelativePosition=function(t,e){void 0===e&&(e=new ur);var i=new ur;return i.set(t.x-this.position.x,t.y-this.position.y,t.z-this.position.z),e=this.getRotMatrixInv().transformPoint3D(i,e)},z.prototype.getRotatedRelativeVector=function(t,e){void 0===e&&(e=new ur);var i=new ur(t[0],t[1],t[2]);return e=this.getRotMatrixInv().transformPoint3D(i,e)},z.prototype.getTransformedRelativePositionsArray=function(t,e){if(void 0===t)return e;void 0===e&&(e=[]);for(var i=t.length,r=0;r<i;r++){var o=this.getTransformedRelativePosition(t[r],void 0);e.push(o)}return e},z.prototype.bindGeoLocationUniforms=function(t,e){t.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.rotMatrix._floatArrays),this.bindSplitedPositionUniforms(t,e)},z.prototype.bindSplitedPositionUniforms=function(t,e){t.uniform3fv(e.buildingPosHIGH_loc,[this.positionHIGH[0],this.positionHIGH[1],this.positionHIGH[2]]),t.uniform3fv(e.buildingPosLOW_loc,[this.positionLOW[0],this.positionLOW[1],this.positionLOW[2]])};var H=function(){if(!(this instanceof H))throw new Error(ot.CONSTRUCT_ERROR);this.geoLocationDataArray=[],this.geoLocationDataArrayMaxLengthAllowed=15};H.prototype.deleteObjects=function(){if(this.geoLocationDataArray){for(var t=0;t<this.geoLocationDataArray.length;t++)this.geoLocationDataArray[t].deleteObjects(),this.geoLocationDataArray[t]=void 0;this.geoLocationDataArray=[]}},H.prototype.popGeoLocationData=function(){this.geoLocationDataArray.pop()},H.prototype.newGeoLocationData=function(t){var e=this.getCurrentGeoLocationData();void 0===t&&(t="noName"+this.geoLocationDataArray.length.toString());var i=new z(t);return this.geoLocationDataArray.unshift(i),this.geoLocationDataArray.length>this.geoLocationDataArrayMaxLengthAllowed&&this.geoLocationDataArray.pop(),e&&i.copyFrom(e),i},H.prototype.addGeoLocationData=function(t){this.geoLocationDataArray.unshift(t),this.geoLocationDataArray.length>this.geoLocationDataArrayMaxLengthAllowed&&this.geoLocationDataArray.pop()},H.prototype.getGeoLocationDatasCount=function(){return this.geoLocationDataArray.length},H.prototype.getGeoLocationData=function(t){if(!(t>this.geoLocationDataArray.length-1))return this.geoLocationDataArray[t]},H.prototype.getCurrentGeoLocationData=function(){if(0!==this.geoLocationDataArray.length)return this.geoLocationDataArray[0]};var W=function(){if(!(this instanceof W))throw new Error(ot.CONSTRUCT_ERROR);this.equatorialRadius=6378137,this.polarRadius=6356752.3142,this.firstEccentricitySquared=.00669437999014,this.secondEccentricitySquared=.00673949674228,this.degToRadFactor=Math.PI/180};W.equatorialRadius=function(){return 6378137},W.equatorialRadiusSquared=function(){return 40680631590769},W.polarRadius=function(){return 6356752.3142},W.polarRadiusSquared=function(){return 40408299984087.055},W.radiusAtLatitudeDeg=function(t){var e=t*Math.PI/180,i=W.equatorialRadius(),r=W.polarRadius(),o=W.equatorialRadiusSquared(),n=W.polarRadiusSquared(),a=Math.sin(e),s=Math.cos(e),l=a*a,h=s*s;return i*r/Math.sqrt(o*l+n*h)},W.normalizeCartesian=function(t){if(void 0!==t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return t[0]/=e,t[1]/=e,t[2]/=e,t}},W.normalAtCartesianPointWgs84=function(t,e,i,r){void 0===r&&(r=new Float32Array(3));var o=W.equatorialRadius(),n=W.polarRadius(),a=o*o,s=n*n;return r[0]=t/a,r[1]=e/a,r[2]=i/s,r=W.normalizeCartesian(r)},W.planeAtCartesianPointWgs84=function(t,e,i,r){void 0===r&&(r=new ut);var o=W.normalAtCartesianPointWgs84(t,e,i,void 0);return r.setPointAndNormal(t,e,i,o[0],o[1],o[2]),r},W.transformMatrixAtGeographicCoord=function(t,e){if(void 0===t)return e;var i=W.geographicToCartesianWgs84(t.longitude,t.latitude,t.altitude,void 0);return W.transformMatrixAtCartesianPointWgs84(i[0],i[1],i[2],e)},W.transformMatrixAtCartesianPointWgs84=function(t,e,i,r){var o,n;n=W.normalAtCartesianPointWgs84(t,e,i,n),(o=new Float32Array(3))[0]=-e,o[1]=t,o[2]=0,o=W.normalizeCartesian(o);var a=new ur(o[0],o[1],o[2]),s=new ur,l=new ur(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===r&&(r=new Float32Array(16)),r[0]=a.x,r[1]=a.y,r[2]=a.z,r[3]=0,r[4]=s.x,r[5]=s.y,r[6]=s.z,r[7]=0,r[8]=l.x,r[9]=l.y,r[10]=l.z,r[11]=0,r[12]=t,r[13]=e,r[14]=i,r[15]=1,r},W.prototype.normalizeCartesian=function(t){return W.normalizeCartesian(t)},W.prototype.transformMatrixAtCartesianPointWgs84=function(t,e,i,r){var o,n;n=this.normalAtCartesianPointWgs84(t,e,i,n),(o=new Float32Array(3))[0]=-e,o[1]=t,o[2]=0,o=this.normalizeCartesian(o);var a=new ur(o[0],o[1],o[2]),s=new ur,l=new ur(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===r&&(r=new Float32Array(16)),r[0]=a.x,r[1]=a.y,r[2]=a.z,r[3]=0,r[4]=s.x,r[5]=s.y,r[6]=s.z,r[7]=0,r[8]=l.x,r[9]=l.y,r[10]=l.z,r[11]=0,r[12]=t,r[13]=e,r[14]=i,r[15]=1,r},W.prototype.intersectionLineWgs84=function(t,e,i){var r=t.point,o=t.direction,n=new ur(r.x+1e3*o.x,r.y+1e3*o.y,r.z+1e3*o.z),a=r.x,s=r.y,l=r.z,h=n.x,d=n.y,c=n.z,u=this.equatorialRadius;void 0!==i&&(u=i);var f=h-a,g=d-s,p=c-l,v=f*f+g*g+p*p,y=2*(f*(a-0)+g*(s-0)+p*(l-0)),m=y*y-4*v*(0+a*a+s*s+l*l-2*(0*a+0*s+0*l)-u*u);if(!(m<0)){if(0===m){void 0===e&&(e=[]);var x=new ur(a+(h-a)*(b=-y/(2*v)),s+(d-s)*b,l+(c-l)*b);e[0]=x.x,e[1]=x.y,e[2]=x.z}else{var b,C=Math.sqrt(m),A=(-y-C)/(2*v),T=(x=new ur(a+(h-a)*(b=(-y+C)/(2*v)),s+(d-s)*b,l+(c-l)*b),new ur(a+(h-a)*A,s+(d-s)*A,l+(c-l)*A)),M=r.squareDistToPoint(x),P=r.squareDistToPoint(T);void 0===e&&(e=[]),M<P?(e[0]=x.x,e[1]=x.y,e[2]=x.z):(e[0]=T.x,e[1]=T.y,e[2]=T.z)}return e}},W.prototype.normalAtCartesianPointWgs84=function(t,e,i,r){void 0===r&&(r=new Float32Array(3));var o=this.equatorialRadius*this.equatorialRadius,n=this.polarRadius*this.polarRadius;return r[0]=t/o,r[1]=e/o,r[2]=i/n,r=this.normalizeCartesian(r)},W.atan2Test=function(t,e){var i=Math.PI;return e>0?Math.atan(t/e):e<0?t>=0?Math.atan(t/e)+i:Math.atan(t/e)-i:0===e?t>0?i/2:t<0?-i/2:0:void 0},W.CartesianToGeographicWgs84=function(t,e,i,r,o){var n,a,s,l,h,d,c,u,f,g,p,v,y,m,x,b=t,C=e,A=i,T=b*b+C*C,M=Math.sqrt(T),P=6378137,w=1/(P*P),_=.00669437999014,S=_*_,L=T*w,R=A*A*(1-_)*w,D=(L+R-S)/6,E=8*D*D*D+S*L*R;E>0||0!==R?(E>0?(l=Math.sqrt(E),h=Math.sqrt(S*L*R),s=E>10*_?D+.5*(d=Math.cbrt((l+h)*(l+h)))+2*D*D/d:D+.5*Math.cbrt((l+h)*(l+h))+.5*Math.cbrt((l-h)*(l-h))):(l=Math.sqrt(-E),h=Math.sqrt(-8*D*D*D),d=Math.sqrt(S*L*R),c=2*W.atan2Test(d,l+h)/3,s=-4*D*Math.sin(c)*Math.cos(Math.PI/6+c)),f=_*(s+(u=Math.sqrt(s*s+S*R))-R)/(2*u),p=(g=(s+u)/(Math.sqrt(f*f+s+u)+f))*M/(g+_),n=(g+_-1)*(v=Math.sqrt(p*p+A*A))/g,a=2*W.atan2Test(A,v+p)):(n=-P*(l=Math.sqrt(1-_))*(h=Math.sqrt(_-L))/(y=Math.sqrt(_)),a=h/(y*h+l*Math.sqrt(L))),m=((x=Math.sqrt(2))-1)*C<M+b?2*W.atan2Test(C,M+b):M+C<(x+1)*b?.5*-Math.PI+2*W.atan2Test(b,M-C):.5*Math.PI-2*W.atan2Test(b,M+C),void 0===r&&(r=new j);var I=180/Math.PI;return r.latitude=I*a,r.longitude=I*m,r.altitude=n,void 0!==o&&!0===o&&(void 0===r.absolutePoint?r.absolutePoint=new ur(t,e,i):r.absolutePoint.set(t,e,i)),r},W.geographicToMercatorProjection=function(t,e,i){var r=Math.PI/180,o=t*r,n=e*r;return W.geographicRadianToMercatorProjection(o,n,i)},W.geographicRadianToMercatorProjection=function(t,e,i){var r=W.equatorialRadius();void 0===i&&(i=new dr);var o=Math.PI,n=r*t,a=0;0!==n&&(a=n/(180*t/o));var s=180/o*Math.log(Math.tan(o/4+e/2))*a;return i.set(n,s),i},W.geographicToCartesianWgs84=function(t,e,i,r){var o=Math.PI/180,n=W.equatorialRadius(),a=t*o,s=e*o,l=Math.cos(a),h=Math.cos(s),d=Math.sin(a),c=Math.sin(s),u=.00669437999014,f=n/Math.sqrt(1-u*c*c),g=i;return void 0===r&&(r=[]),r[0]=(f+g)*h*l,r[1]=(f+g)*h*d,r[2]=(f*(1-u)+g)*c,r},W.geographicRadianArrayToFloat32ArrayWgs84=function(t,e,i,r){var o,n,a,s,l,h,d,c,u=.00669437999014,f=t.length;void 0===r&&(r=new Float32Array(3*f));for(var g=0;g<f;g++)o=t[g],n=e[g],a=Math.cos(o),s=Math.cos(n),l=Math.sin(o),h=Math.sin(n),d=6378137/Math.sqrt(1-u*h*h),c=i[g],r[3*g]=(d+c)*s*a,r[3*g+1]=(d+c)*s*l,r[3*g+2]=(.99330562000986*d+c)*h;return r},W.getArcDistanceBetweenGeographicCoords=function(t,e){var i=Math.PI/180,r=(t.latitude+e.latitude)/2,o=W.radiusAtLatitudeDeg(r),n=(e.longitude-t.longitude)*i,a=(e.latitude-t.latitude)*i,s=t.latitude*i,l=e.latitude*i,h=Math.sin(n/2),d=Math.sin(a/2),c=d*d+h*h*Math.cos(s)*Math.cos(l);return o*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))};var X=function(){if(!(this instanceof X))throw new Error(ot.CONSTRUCT_ERROR);this.identifierMap={},this.identifiersCount=0};X.prototype.newId=function(){this.identifiersCount++;var t=this.identifiersCount.toString();return this.identifierMap[t]=1,t};var Y=function(e){if(!(this instanceof Y))throw new Error(ot.CONSTRUCT_ERROR);if(!(e&&e instanceof tt))throw new Error(ot.REQUIRED_EMPTY_ERROR("MagoManager"));t.call(this),this.manager=e,this.array=[];var i=this;this.on(Y.EVENT_TYPE.ADD,function(t){t.manager=e}),this.on(Y.EVENT_TYPE.ACTIVE,function(t){for(var e=0,r=i.array.length;e<r;e++){var o=i.array[e];o===t?(o.active=!0,o.start()):(o.active=!1,o.init())}}),this.on(Y.EVENT_TYPE.DEACTIVE,function(){for(var t=0,e=i.array.length;t<e;t++)i.array[t].clear(),i.array[t].active=!1})};Y.prototype=Object.create(t.prototype),Y.prototype.constructor=Y,Y.EVENT_TYPE={ADD:"add",ACTIVE:"active",DEACTIVE:"deactive"},Y.prototype.add=function(t){this.array.push(t),this.emit(Y.EVENT_TYPE.ADD,t)};var K=function(t){if(!(this instanceof K))throw new Error(ot.CONSTRUCT_ERROR);this.name,this.id,this.lightType=t,this.geoCoord,this.position,this.positionHIGH,this.positionLOW,this.tMatrix,this.tMatrixInv,this.depthFbo,this.bSphere,this.minDistToCam,this.maxDistToCam,this.targetTextureWidth=new Int32Array([2048]),this.targetTextureHeight=new Int32Array([2048])},q=function(e,i,r,o,n){if(!(this instanceof q))throw new Error(ot.CONSTRUCT_ERROR);if(!e||!document.getElementById(e))throw new Error("containerId is required.");t.call(this);var a,s=null;r&&(r.loadstart&&"function"==typeof r.loadstart&&this.on("loadstart",r.loadstart),r.loadend&&"function"==typeof r.loadend&&this.on("loadend",r.loadend));var l,h,d,f=c.magoManagerState.INIT;l=i,(h={}).basicGlobe=u.CESIUM,h.online=!0,h.lod0=15,h.lod1=60,h.lod2=90,h.lod3=200,h.lod4=1e3,h.lod5=5e4,h.ssaoRadius=.15,h.initDefaultFov=1,h.maxPartitionsLod0=8,h.maxPartitionsLod1=4,h.maxPartitionsLod2OrLess=2,h.maxRatioPointsDist0m=1,h.maxRatioPointsDist100m=10,h.maxRatioPointsDist200m=20,h.maxRatioPointsDist400m=40,h.maxRatioPointsDist800m=80,h.maxRatioPointsDist1600m=160,h.maxRatioPointsDistOver1600m=320,h.maxPointSizeForPc=10,h.minPointSizeForPc=2,h.pendentPointSizeForPc=60,h.minHeight_rainbow_loc=0,h.maxHeight_rainbow_loc=100,d=(i=Object.assign({},h,l||{})).basicGlobe===u.CESIUM?new P(e,i,o,n):new Z(e,i,o),a=d.viewer,s=d.magoManager;var g={callAPI:function(t){if(t.getReturnable())return s.callAPI(t);s.callAPI(t)},getViewer:function(){return a},getMagoManagerState:function(){return f},getMagoManager:function(){return s},setBaseUrl:function(t){if(!s)throw new Error("Mago3d is no ready");s.readerWriter.geometryDataPath=t},getF4dController:function(){return s.f4dController}};return f=c.magoManagerState.READY,d.initPosition(),d.setEventHandler(),this.emit("loadend",g),g};q.prototype=Object.create(t.prototype),q.prototype.constructor=q;var Z=function(t,e,r){this.options=r||{},i.call(this,t,e)};Z.prototype=Object.create(i.prototype),Z.prototype.constructor=Z,Z.prototype.init=function(){this.magoManager=new tt,this.viewer=new tr(this.magoManager),this.magoManager.magoWorld=this.viewer,this.magoManager.globe=new W,this.magoManager.tinTerrainManager=new ye(this.magoManager,this.options),this.viewer.updateModelViewMatrixByCamera(this.magoManager.sceneState.camera);var t=this.magoManager.sceneState.gl;this.magoManager.vboMemoryManager.gl=t,this.magoManager.postFxShadersManager.gl=t,this.magoManager.postFxShadersManager.createDefaultShaders(t),this.magoManager.createDefaultShaders(t);var e=this.viewer;!function(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)},function t(){requestAnimFrame(t);e.renderScene()}()}()},Z.prototype.setEventHandler=function(){var t=this.magoManager.sceneState.canvas,e=this.viewer;t.addEventListener("mousedown",function(t){e.mousedown(t)},!1),t.addEventListener("mouseup",function(t){e.mouseup(t)},!1),t.addEventListener("wheel",function(t){e.mousewheel(t)},!1),t.addEventListener("mousemove",function(t){e.mousemove(t)},!1),t.addEventListener("click",function(t){e.mouseclick(t)},!1),t.addEventListener("contextmenu",function(t){t.preventDefault(),e.mouseRightClick(t)},!1),t.addEventListener("dblclick",function(t){e.mouseDblClick(t)},!1),window.addEventListener("resize",function(i){t.width=t.offsetWidth,t.height=t.offsetHeight,e.magoManager.sceneState.setDrawingBufferSize(t.offsetWidth,t.offsetHeight)},!1);document.addEventListener("keydown",function(t){e.keydown(t)},!1)};var Q=function(t,e){this.type=t,this.listener=e};Q.prototype.getType=function(){return this.type},Q.prototype.getListener=function(){return this.listener};var J=function(t){if(!(this instanceof J))throw new Error(ot.CONSTRUCT_ERROR);if(Ri(t.dataGroupId))throw new Error(ot.REQUIRED_EMPTY_ERROR("dataGroupId"));if(Ri(t.dataGroupKey))throw new Error(ot.REQUIRED_EMPTY_ERROR("dataGroupKey"));if(Ri(t.dataGroupName))throw new Error(ot.REQUIRED_EMPTY_ERROR("dataGroupName"));if(Ri(t.dataGroupPath))throw new Error(ot.REQUIRED_EMPTY_ERROR("dataGroupPath"));this.ready=!1,this.buildingSeedMap,this.id=t.dataGroupId,this.key=t.dataGroupKey,this.name=t.dataGroupName,this.path=t.dataGroupPath.replace(/\/+$/,""),this.tiling=wi(t.tiling,!1),this.style=Object.assign({},t.style||{});var e=t.longitude,i=t.latitude,r=t.altitude;if(!isNaN(e)&&!isNaN(i)&&isNaN(r),this.datas=[],t.datas&&Array.isArray(t.datas))for(var o=0,n=t.datas.length;o<n;o++){var a=t.datas[o];this.addData(a)}};J.prototype.getObjectIndexFile=function(){var t=this;Di("/f4d/"+this.path+u.OBJECT_INDEX_FILE+u.CACHE_VERSION+(new Date).getTime()).then(function(e){var i=e;if(i){var r=new C;r.dataArrayBuffer=i,r.parseBuildingSeedArrayBuffer(),t.ready=!0,t.buildingSeedMap=r;var o=t.datas.length;if(o>0)for(var n=0;n<o;n++)t.readyData(t.datas[n])}},function(t){console.log("xhr status = "+t)})},J.prototype.addData=function(t){t instanceof et||(t=new et(t)),this.datas.push(t),this.ready&&that.buildingSeedMap&&this.readyData(t)},J.prototype.readyData=function(t){try{var e=this.buildingSeedMap.map.get(t.key);if(!e)throw new Error("This data("+t.key+") is seedless!");t.buildingSeed=e}catch(t){console.warn(t)}};var $=function(){if(!(this instanceof $))throw new Error(ot.CONSTRUCT_ERROR);t.call(this),this.layers=[]};$.prototype=Object.create(t.prototype),$.prototype.constructor=$,$.EVENT_TYPE={ADD:"add",REMOVE:"remove"},$.prototype.add=function(t){if(!Si(t))throw new Error(ot.REQUIRED_EMPTY_ERROR("layer"));t instanceof J||(t=new J(t)),t.tiling||t.getObjectIndexFile(),this.layers.push(t),this.emit($.EVENT_TYPE.ADD,{type:$.EVENT_TYPE.ADD,layer:t,timestamp:new Date})},$.prototype.removeById=function(t){if(!Si(t))throw new Error(ot.REQUIRED_EMPTY_ERROR("id"));for(var e=this.layers,i={id:t},r=e.length-1;r>=0;r--){if(e[r].id===t){e.slice(r,1),i.index=r;break}}if(!i.hasOwnProperty("index"))throw new Error("this id is not exist");this.emit($.EVENT_TYPE.REMOVE,{type:$.EVENT_TYPE.REMOVE,layer:i,timestamp:new Date})};var tt=function(){if(!(this instanceof tt))throw new Error(ot.CONSTRUCT_ERROR);t.call(this),this.renderer=new Ae(this),this.selectionManager=new _e(this),this.postFxShadersManager=new Je,this.readerWriter=new ge,this.magoPolicy=new g,this.animationManager,this.texturesStore=new Pt(this),this.smartTileManager=new yt,this.processQueue=new ue,this.parseQueue=new ce,this.hierarchyManager=new Wt,this.depthFboNeo,this.depthFboAux,this.selectionFbo,this.mouse_x=0,this.mouse_y=0,this.mouseLeftDown=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane,this.objectSelected,this.buildingSelected,this.octreeSelected,this.nodeSelected,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.startMovPoint=new ur,this.configInformation=f.getPolicy(),this.cameraFPV=new N,this.myCameraSCX,this.loadQueue=new qt(this),this.sceneState=new Me,this.sceneState.setApplySunShadows(!1),this.magoPolicy.objectMoveMode=c.moveMode.OBJECT,this.selectionColor=new gt,this.vboMemoryManager=new Ot,void 0!==this.configInformation&&(this.magoPolicy.setLod0DistInMeters(this.configInformation.lod0),this.magoPolicy.setLod1DistInMeters(this.configInformation.lod1),this.magoPolicy.setLod2DistInMeters(this.configInformation.lod2),this.magoPolicy.setLod3DistInMeters(this.configInformation.lod3),this.magoPolicy.setLod4DistInMeters(this.configInformation.lod4),this.magoPolicy.setLod5DistInMeters(this.configInformation.lod5),this.configInformation.ssaoRadius&&(this.sceneState.ssaoRadius[0]=Number(this.configInformation.ssaoRadius))),this.fileRequestControler=new D,this.visibleObjControlerOctrees=new Bt,this.visibleObjControlerNodes=new Bt,this.visibleObjControlerTerrain=new Bt,this.frustumVolumeControl=new V,this.boundingSphere_Aux,this.radiusAprox_aux,this.lastCamPos=new ur,this.squareDistUmbral=22,this.lowestOctreeArray=[],this.backGround_fileReadings_count=0,this.backGround_imageReadings_count=0,this.isCameraMoving=!1,this.isCameraInsideNeoBuilding=!1,this.renderingFase=0,this.bPicking=!1,this.scene,this.numFrustums,this.isLastFrustum=!1,this.currentFrustumIdx=0,this.highLightColor4=new Float32Array([.2,1,.2,1]),this.thereAreUrgentOctrees=!1,this.hierarchyManager=new Wt,this.smallObjectSize=.153,this.sqrtTable=new Float32Array(11);for(var e=0;e<11;e++)this.sqrtTable[e]=Math.sqrt(1+.1*e*(.1*e));this.managerUtil=new Ei,this.frustumVolumeControl=new V,this.currentSelectedObj_idx=-1,this.currentByteColorPicked=new Uint8Array(4),this.currentShader,this.pointSC=new ur,this.pointSC_2=new ur,this.arrayAuxSC=[],this.currentTimeSC,this.dateSC=new Date,this.startTimeSC,this.maxMilisecondsForRender=10,this.terranTileSC,this.resultRaySC=new Float32Array(3),this.matrix4SC=new rt,this.axisXYZ=new Oi,this.demoBlocksLoaded=!1,this.objMarkerManager=new lt(this),this.tempSettings={},this.tempSettings.renderWithTopology=1,this.tempSettings.renderSpaces=!0,this.tempSettings.spacesAlpha=.6,this._settings=new pt,this.tinTerrainManager,this.modeler=new or(this),this.materialsManager=new ir(this),this.idManager=new X,this.processCounterManager=new mr,this.f4dController=new L(this),this.effectsManager=new l,this.currentProcess=c.magoCurrentProcess.Unknown,this.interactions=new Y(this),this.magoLayerCollection=new $};tt.prototype=Object.create(t.prototype),tt.prototype.constructor=tt,tt.EVENT_TYPE={CLICK:"click",DBCLICK:"dbclick",RIGHTCLICK:"rightclick",MOUSEMOVE:"mousemove",LEFTDOWN:"leftdown",LEFTUP:"leftup",SMARTTILELOADSTART:"smarttileloadstart",SMARTTILELOADEND:"smarttileloadend",F4DLOADSTART:"f4dloadstart",F4DLOADEND:"f4dloadend",F4DRENDERREADY:"f4drenderready",SELECTEDF4D:"selectedf4d",SELECTEDF4DMOVED:"selectedf4dmoved",SELECTEDF4DOBJECT:"selectedf4dobject",SELECTEDGENERALOBJECT:"selectedgeneralobject",DESELECTEDF4D:"deselectedf4d",DESELECTEDF4DOBJECT:"deselectedf4dobject",DESELECTEDGENERALOBJECT:"deselectedgeneralobject",CAMERACHANGED:"camerachanged",CAMERAMOVEEND:"cameramoveend",CAMERAMOVESTART:"cameramovestart"},tt.prototype.init=function(t){this.bInit=!0,void 0===this.sceneState.gl&&(this.sceneState.gl=t),void 0===this.vboMemoryManager.gl&&(this.vboMemoryManager.gl=t),void 0===this.effectsManager.gl&&(this.effectsManager.gl=t)},tt.prototype.start=function(t,e,i,r){if(this.magoPolicy.getMagoEnable()){var o=!1;if(this.numFrustums=r,this.currentFrustumIdx=this.numFrustums-i-1,this.currentFrustumIdx===r-1&&(o=!0,this.isLastFrustum=!0),void 0===this.configInformation&&(this.configInformation=f.getPolicy()),t){var n=t.context._gl;if(n.getExtension("EXT_frag_depth"),this.bInit||this.init(n),n.isContextLost())return}this.startRender(o,this.currentFrustumIdx,r)}},tt.prototype.updateSize=function(){var t=this.sceneState,e=t.canvas;e.width=e.offsetWidth,e.height=e.offsetHeight,t.setDrawingBufferSize(e.offsetWidth,e.offsetHeight)},tt.prototype.isCesiumGlobe=function(){return this.configInformation.basicGlobe===u.CESIUM},tt.prototype.swapRenderingFase=function(){this.renderingFase=!this.renderingFase},tt.prototype.prepareNeoBuildingsAsimetricVersion=function(t,e){var i,r,o,n=this.readerWriter.geometryDataPath;void 0===this.headersRequestedCounter&&(this.headersRequestedCounter=0);for(var a=0,s=[].concat(e.currentVisibles0,e.currentVisibles2,e.currentVisibles3,e.currentVisiblesAux,e.currentVisiblesToPrepare),l=0,h=s.length;l<h;l++){var d=(r=s[l]).data.attributes;if(void 0!==d){i=s[l].data.neoBuilding,void 0!==d.projectId&&void 0!==d.isReference&&!0===d.isReference&&Er.manageStaticModel(r,this);var u=r.data.attributes.fromSmartTile;if(void 0===u&&(u=!1),i){var f=i.metaData;if(f.fileLoadState===c.fileLoadState.READY){if(!u){if(o=i.projectFolderName,this.fileRequestControler.isFullHeaders())return;var g=n+"/"+o+"/"+i.buildingFileName+"/HeaderAsimetric.hed";this.readerWriter.getNeoHeaderAsimetricVersion(t,g,i,this.readerWriter,this)}}else if(f.fileLoadState===c.fileLoadState.LOADING_FINISHED){if(i.parseHeader(i.headerDataArrayBuffer,0),++a>60)break}}}}s.length=0},tt.prototype.upDateSceneStateMatrices=function(t){if(void 0===this.myCameraSCX&&(this.myCameraSCX=new A({name:"cameraSCX"})),void 0!==this.configInformation){if(this.isCesiumGlobe()){var e=this.scene,i=e._context.uniformState;if(this.isFarestFrustum()){var r=(y=e.camera).positionWC.x,o=y.positionWC.y,n=y.positionWC.z,a=y.directionWC.x,s=y.directionWC.y,l=y.directionWC.z,h=y.upWC.x,d=y.upWC.y,c=y.upWC.z,u=r+1e3*a,f=o+1e3*s,g=n+1e3*l;(R=this.sceneState.modelViewMatrix)._floatArrays=rt.lookAt(R._floatArrays,[r,o,n],[u,f,g],[h,d,c])}Cesium.Matrix4.toArray(i._projection,t.projectionMatrix._floatArrays),(L=t.getModelViewMatrixInv())._floatArrays=glMatrix.mat4.invert(L._floatArrays,t.modelViewMatrix._floatArrays),t.normalMatrix4._floatArrays=glMatrix.mat4.transpose(t.normalMatrix4._floatArrays,L._floatArrays),t.modelViewRelToEyeMatrix._floatArrays=glMatrix.mat4.copy(t.modelViewRelToEyeMatrix._floatArrays,t.modelViewMatrix._floatArrays),t.modelViewRelToEyeMatrix._floatArrays[12]=0,t.modelViewRelToEyeMatrix._floatArrays[13]=0,t.modelViewRelToEyeMatrix._floatArrays[14]=0,t.modelViewRelToEyeMatrix._floatArrays[15]=1,t.modelViewRelToEyeMatrixInv._floatArrays=glMatrix.mat4.invert(t.modelViewRelToEyeMatrixInv._floatArrays,t.modelViewRelToEyeMatrix._floatArrays),t.modelViewProjMatrix._floatArrays=glMatrix.mat4.multiply(t.modelViewProjMatrix._floatArrays,t.projectionMatrix._floatArrays,t.modelViewMatrix._floatArrays),t.modelViewProjRelToEyeMatrix._floatArrays=glMatrix.mat4.multiply(t.modelViewProjRelToEyeMatrix._floatArrays,t.projectionMatrix._floatArrays,t.modelViewRelToEyeMatrix._floatArrays);var p=e.context._us._cameraPosition;Ei.calculateSplited3fv([p.x,p.y,p.z],t.encodedCamPosHigh,t.encodedCamPosLow);var v=this.scene._frustumCommandsList;void 0===v&&(v=this.scene.frustumCommandsList);r=this.scene.camera.positionWC.x,o=this.scene.camera.positionWC.y,n=this.scene.camera.positionWC.z,a=this.scene.camera.direction.x,s=this.scene.camera.direction.y,l=this.scene.camera.direction.z,h=this.scene.camera.up.x,d=this.scene.camera.up.y,c=this.scene.camera.up.z;t.camera.isCameraMoved(r,o,n,a,s,l,h,d,c)&&(this.isCameraMoved=!0),this.upDateCamera(t.camera),t.drawingBufferWidth[0]=e.drawingBufferWidth,t.drawingBufferHeight[0]=e.drawingBufferHeight}else{this.postFxShadersManager.bUseLogarithmicDepth=!0;var y,m=(y=t.camera).position,x=y.getFrustum(0),b=y.getCameraElevation(),C=W.equatorialRadius();b<0&&(b*=-1);Math.PI;var T=C+b,M=Math.acos(C/T),P=T*Math.sin(M)*.8;b>5e4&&(P*=1.5),x.near[0]=1e-4,x.near[0]=b>1e4?.1+.8*b:.1,x.far[0]=P,this.postFxShadersManager.bUseLogarithmicDepth&&(x.near[0]=1e-6),Ei.calculateSplited3fv([m.x,m.y,m.z],t.encodedCamPosHigh,t.encodedCamPosLow);var w=t.projectionMatrix;w._floatArrays=glMatrix.mat4.perspective(w._floatArrays,x.fovyRad[0],x.aspectRatio[0],x.near[0],x.far[0]);var _=C+1.5*b,S=t.projectionMatrixSky;S._floatArrays=glMatrix.mat4.perspective(S._floatArrays,x.fovyRad[0],x.aspectRatio[0],x.near[0],_);var L,R=t.modelViewMatrix;(L=t.getModelViewMatrixInv())._floatArrays=glMatrix.mat4.invert(L._floatArrays,R._floatArrays);var D=t.normalMatrix4;D._floatArrays=glMatrix.mat4.transpose(D._floatArrays,L._floatArrays);var E=t.modelViewRelToEyeMatrix;E._floatArrays=glMatrix.mat4.copy(E._floatArrays,R._floatArrays),E._floatArrays[12]=0,E._floatArrays[13]=0,E._floatArrays[14]=0,E._floatArrays[15]=1;var I=t.modelViewRelToEyeMatrixInv;I._floatArrays=glMatrix.mat4.invert(I._floatArrays,E._floatArrays);var O=t.modelViewProjMatrix;O._floatArrays=glMatrix.mat4.multiply(O._floatArrays,w._floatArrays,R._floatArrays);var F=t.modelViewProjRelToEyeMatrix;F._floatArrays=glMatrix.mat4.multiply(F._floatArrays,w._floatArrays,E._floatArrays);var N=t.modelViewProjRelToEyeMatrixSky;N._floatArrays=glMatrix.mat4.multiply(N._floatArrays,S._floatArrays,E._floatArrays)}if(t.modelViewProjMatrixInv=void 0,t.projectionMatrixInv=void 0,void 0!==this.depthFboNeo){var B=this.texturesStore.getNoiseTexture4x4();t.ssaoNoiseScale2[0]=this.depthFboNeo.width[0]/B.width,t.ssaoNoiseScale2[1]=this.depthFboNeo.height[0]/B.height}this.myCameraSCX.direction.set(t.camera.direction.x,t.camera.direction.y,t.camera.direction.z),this.myCameraSCX.up.set(t.camera.up.x,t.camera.up.y,t.camera.up.z);x=this.myCameraSCX.getFrustum(0);var V=t.camera.getFrustum(0);x.near[0]=V.near[0],x.far[0]=V.far[0],x.fovyRad[0]=V.fovyRad[0],x.tangentOfHalfFovy[0]=V.tangentOfHalfFovy[0],x.fovRad[0]=V.fovRad[0],x.aspectRatio[0]=V.aspectRatio[0],this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||this.sceneState.sunSystem&&this.sceneState.applySunShadows&&this.isFarestFrustum()&&this.sceneState.sunSystem.updateSun(this)}},tt.prototype.upDateCamera=function(t){if(this.isCesiumGlobe()){for(var e=this.scene,i=e.frustumCommandsList,r=this.currentFrustumIdx,o=this.sceneState.camera,n=i[r].far,a=i[r].near,s=e.opaqueFrustumNearOffset,l=i.length,h=[],d=void 0,c=0;c<l;c++){h[2*c]=i[c].near,h[2*c+1]=i[c].far,0!==c&&(h[2*c]*=s),(M=o.getFrustum(c)).far[0]=i[c].far,M.near[0]=i[c].near,M.fovRad[0]=e.camera.frustum._fov,M.fovyRad[0]=e.camera.frustum._fovy,M.aspectRatio[0]=e.camera.frustum._aspectRatio,void 0===d&&(d=Math.tan(M.fovyRad/2)),M.tangentOfHalfFovy[0]=d}var u=this.sceneState.getModelViewMatrixInv(),f=e.camera.positionWC.x,g=e.camera.positionWC.y,p=e.camera.positionWC.z,v=-u._floatArrays[8],y=-u._floatArrays[9],m=-u._floatArrays[10],x=u._floatArrays[4],b=u._floatArrays[5],C=u._floatArrays[6];t.position.set(f,g,p),t.direction.set(v,y,m),t.up.set(x,b,C);var A=M.aspectRatio[0],T=M.fovyRad;M=t.getFrustum(r),t.frustum.near[0]=a,t.frustum.far[0]=n,t.setFrustumsDistances(l,h),t.setAspectRatioAndFovyRad(A,T),t.calculateFrustumsPlanes()}else{(o=this.sceneState.camera).doInertialMovement(this);var M;r=0,A=(M=(o=this.sceneState.camera).getFrustum(r)).aspectRatio[0],T=M.fovyRad,n=M.far[0],a=M.near[0];this.sceneState.camera.frustum.near[0]=a,this.sceneState.camera.frustum.far[0]=n,this.sceneState.camera.frustum.aspectRatio[0]=A;for(l=1,h=[],c=0;c<l;c++)h[2*c]=M.near,h[2*c+1]=M.far;t.position.set(o.position.x,o.position.y,o.position.z),t.direction.set(o.direction.x,o.direction.y,o.direction.z),t.up.set(o.up.x,o.up.y,o.up.z),(M=t.getFrustum(r)).near[0]=a,M.far[0]=n,t.setFrustumsDistances(l,h),t.setAspectRatioAndFovyRad(A,T),t.calculateFrustumsPlanes()}},tt.prototype.getCurrentTime=function(){return void 0===this.currTime&&(this.dateSC=new Date,this.currTime=this.dateSC.getTime()),this.currTime},tt.prototype.getGl=function(){if(void 0!==this.sceneState)return this.sceneState.gl},tt.prototype.loadAndPrepareData=function(){var t,e=this.getGl();this.visibleObjControlerOctrees.initArrays(),this.checkPropertyFilters(this.visibleObjControlerNodes.currentVisibles0),this.checkPropertyFilters(this.visibleObjControlerNodes.currentVisibles2),this.checkPropertyFilters(this.visibleObjControlerNodes.currentVisibles3);for(var i=this.visibleObjControlerNodes.currentVisibles0.length,r=0;r<i;r++){"basicF4d"===(t=this.visibleObjControlerNodes.currentVisibles0[r]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,0)||(this.visibleObjControlerNodes.currentVisibles0.splice(r,1),r--,i=this.visibleObjControlerNodes.currentVisibles0.length))}if(this.prepareVisibleOctreesSortedByDistance(e,this.visibleObjControlerOctrees),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles0),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles1),this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles2),this.readerWriter.referencesList_requested<5){i=this.visibleObjControlerNodes.currentVisibles2.length;for(r=0;r<i;r++){"basicF4d"===(t=this.visibleObjControlerNodes.currentVisibles2[r]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(e,t,this.visibleObjControlerOctrees,2)||(this.visibleObjControlerNodes.currentVisibles2.splice(r,1),r--,i=this.visibleObjControlerNodes.currentVisibles2.length))}this.prepareVisibleOctreesSortedByDistanceLOD2(e,this.visibleObjControlerOctrees.currentVisibles2)}this.readerWriter.skinLegos_requested=0,this.prepareVisibleLowLodNodes(this.visibleObjControlerNodes.currentVisibles0),this.prepareVisibleLowLodNodes(this.visibleObjControlerNodes.currentVisibles2),this.prepareVisibleLowLodNodes(this.visibleObjControlerNodes.currentVisibles3),this.readerWriter.pCloudPartitionsMother_requested=0,this.isFarestFrustum()&&void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready&&this.tinTerrainManager.prepareVisibleTinTerrains(this),this.manageQueue()},tt.prototype.renderToSelectionBuffer=function(){var t=this.getGl();void 0===this.selectionFbo&&(this.selectionFbo=new R(t,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),(this.isCameraMoved||this.bPicking)&&(this.selectionFbo.bind(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthRange(0,1),t.disable(t.CULL_FACE),t.clear(t.DEPTH_BUFFER_BIT),this.isLastFrustum&&(t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.selectionManager.clearCandidates(),t.clearColor(0,0,0,1)),this.renderer.renderGeometryColorCoding(this.visibleObjControlerNodes),this.swapRenderingFase(),0===this.currentFrustumIdx&&(this.isCameraMoved=!1))},tt.prototype.managePickingProcess=function(){var t=this.getGl();if(void 0===this.selectionFbo&&(this.selectionFbo=new R(t,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),0===this.currentFrustumIdx){if(!0===this.bPicking){var e=this.selectionManager,i=!!e.currentGeneralObjectSelected;this.bPicking=!1,this.arrayAuxSC.length=0,e.clearCurrents();this.objectSelected=this.getSelectedObjects(t,this.mouse_x,this.mouse_y,this.arrayAuxSC,!0);var r=this.arrayAuxSC[0],o=this.arrayAuxSC[1],n=this.arrayAuxSC[3],a=this.magoPolicy.getObjectMoveMode();a===c.moveMode.ALL?r&&n?this.emit(tt.EVENT_TYPE.SELECTEDF4D,{type:tt.EVENT_TYPE.SELECTEDF4D,f4d:n,timestamp:new Date}):this.buildingSelected&&!r&&this.nodeSelected&&!n&&this.emit(tt.EVENT_TYPE.DESELECTEDF4D,{type:tt.EVENT_TYPE.DESELECTEDF4D}):a===c.moveMode.OBJECT&&(o&&this.objectSelected?this.emit(tt.EVENT_TYPE.SELECTEDF4DOBJECT,{type:tt.EVENT_TYPE.SELECTEDF4DOBJECT,octree:r,object:this.objectSelected,timestamp:new Date}):this.octreeSelected&&!o&&this.emit(tt.EVENT_TYPE.DESELECTEDF4DOBJECT,{type:tt.EVENT_TYPE.DESELECTEDF4DOBJECT})),this.buildingSelected=r,this.octreeSelected=o,this.nodeSelected=n,this.nodeSelected?this.rootNodeSelected=this.nodeSelected.getRoot():this.rootNodeSelected=void 0,this.arrayAuxSC.length=0,void 0!==this.buildingSelected&&(this.displayLocationAndRotation(this.buildingSelected),this.selectedObjectNotice(this.buildingSelected)),this.objectSelected,e.currentGeneralObjectSelected?this.emit(tt.EVENT_TYPE.SELECTEDGENERALOBJECT,{type:tt.EVENT_TYPE.SELECTEDGENERALOBJECT,generalObject:e.currentGeneralObjectSelected,timestamp:new Date}):i&&!e.currentGeneralObjectSelected&&this.emit(tt.EVENT_TYPE.DESELECTEDGENERALOBJECT,{type:tt.EVENT_TYPE.DESELECTEDGENERALOBJECT});var s=e.getSelectionCandidatesFamily("networkEdges"),l=e.getSelectionCandidatesFamily("networkNodes"),h=!1;if(s){var d=s.currentSelected;if(d&&d.vtxSegment){var u=this.sceneState.camera.position,f=d.vtxSegment,g=new ur,p=new ur;g.copyFrom(f.startVertex.point3d),p.copyFrom(f.endVertex.point3d),g.add(0,0,1.7),p.add(0,0,1.7);var v=(C=d.networkOwner.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData()).tMatrix;(A=C.pivotPointTraslationLC)&&(g.add(A.x,A.y,A.z),p.add(A.x,A.y,A.z));var y,m=v.transformPoint3D(g,void 0),x=v.transformPoint3D(p,void 0);y=u.squareDistToPoint(m)<u.squareDistToPoint(x)?x:m,this.flyToTopology(y,2),h=!0}}if(!h&&l){var b=l.currentSelected;if(b){u=this.sceneState.camera.position;(g=new ur(b.position.x,b.position.y,b.position.z)).add(0,0,1.7);var C,A;v=(C=b.networkOwner.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData()).tMatrix;(A=C.pivotPointTraslationLC)&&g.add(A.x,A.y,A.z);m=v.transformPoint3D(g,void 0);this.flyToTopology(m,2),h=!0}}}this.selectionColor.init()}this.selectionFbo.unbind(),t.enable(t.CULL_FACE)},tt.prototype.getSilhouetteDepthFbo=function(){var t=this.getGl();return void 0===this.silhouetteDepthFboNeo&&(this.silhouetteDepthFboNeo=new R(t,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.sceneState.drawingBufferWidth[0]===this.silhouetteDepthFboNeo.width[0]&&this.sceneState.drawingBufferHeight[0]===this.silhouetteDepthFboNeo.height[0]||(this.silhouetteDepthFboNeo.deleteObjects(t),this.silhouetteDepthFboNeo=new R(t,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight),this.sceneState.camera.frustum.dirty=!0),this.silhouetteDepthFboNeo},tt.prototype.doRender=function(t){var e=this.getGl(),i=(this.sceneState.camera.position,0);this.renderType=0;(void 0===t.depthFbo&&(t.depthFbo=new R(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.sceneState.drawingBufferWidth[0]===t.depthFbo.width[0]&&this.sceneState.drawingBufferHeight[0]===t.depthFbo.height[0]||(t.depthFbo.deleteObjects(e),t.depthFbo=new R(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight),this.sceneState.camera.frustum.dirty=!0,this.selectionFbo.deleteObjects(e),this.selectionFbo=void 0),this.depthFboNeo=t.depthFbo,this.depthFboNeo.bind(),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearStencil(0),e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.renderer.renderGeometry(e,i,this.visibleObjControlerNodes),this.depthFboNeo.unbind(),this.swapRenderingFase(),this.isCesiumGlobe())&&(this.scene._context._currentFramebuffer._bind(),this.currentFrustumIdx<2&&(i=3,this.renderer.renderTerrainShadow(e,i,this.visibleObjControlerNodes)));i=1,this.renderType=1,this.renderer.renderGeometry(e,i,this.visibleObjControlerNodes),0===this.currentFrustumIdx&&this.renderCluster(),this.weatherStation&&this.weatherStation.renderWindLayerDisplayPlanes(this),e.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.swapRenderingFase()},tt.prototype.renderCluster=function(){if(this.cluster&&this.cluster.quatTree){var t=this.cluster.quatTree,e=this.sceneState.camera.getPosition(),i=(t.getDisplayPoints(),t.getQuatTreeByCamDistance(void 0,e));i&&i.length>0&&this.cluster.renderFunction.call(this.cluster,i,this)}},tt.prototype.initCounters=function(){this.processCounterManager.reset()},tt.prototype.startRender=function(t,e,i){this.numFrustums=i,this.isLastFrustum=t;var r=this.getGl();this.upDateSceneStateMatrices(this.sceneState),this.isFarestFrustum()&&(this.dateSC=new Date,this.prevTime=this.currTime,this.currTime=this.dateSC.getTime(),this.initCounters(),void 0!==this.animationManager&&this.animationManager.checkAnimation(this),void 0===this.myCameraSCX&&(this.myCameraSCX=new A({name:"cameraSCX"})),this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.upDateCamera(this.myCameraSCX),this.doMultiFrustumCullingSmartTiles(this.myCameraSCX)),r.clearStencil(0),r.clear(r.STENCIL_BUFFER_BIT),this.sceneState.camera.doTrack(this),this.sceneState.resetStadistics(),this.clearCanvas2D());var o=this.sceneState.camera.position,n=this.frustumVolumeControl.getFrustumVolumeCulling(e);this.myCameraSCX.setCurrentFrustum(e),this.sceneState.camera.setCurrentFrustum(e);var a=n.visibleNodes;if(!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown){if(void 0===this.frustumVolumeControl)return;var s=this.myCameraSCX.bigFrustum;this.tilesMultiFrustumCullingFinished(n.intersectedTilesArray,a,o,s),this.prepareNeoBuildingsAsimetricVersion(r,a)}this.visibleObjControlerNodes=a,this.isCameraMoving||this.mouseMiddleDown||(this.loadAndPrepareData(),this.renderToSelectionBuffer()),this.doRender(n),this.magoPolicy.getShowLabelInfo()&&(0===this.currentFrustumIdx&&this.clearCanvas2D(),this.drawBuildingNames(this.visibleObjControlerNodes),this.canvasDirty=!0);this.currentFrustumIdx,this.objectMarkerTest},tt.prototype.clearCanvas2D=function(){if(void 0===this.canvasDirty&&(this.canvasDirty=!0),this.canvasDirty){var t=this.getObjectLabel().getContext("2d");t.clearRect(0,0,t.canvas.width,t.canvas.height),this.canvasDirty=!1}},tt.prototype.prepareVisibleLowLodNodes=function(t){if(!(this.readerWriter.skinLegos_requested>300))for(var e,i,r=t.length,o=0;o<r;o++){var n=(e=t[o]).data.attributes;if("basicF4d"===n.objectType)(i=e.data.neoBuilding).metaData&&i.metaData.fileLoadState===c.fileLoadState.PARSE_FINISHED&&i.prepareSkin(this);else if("multiBuildingsTile"===n.objectType){var a=e.data.multiBuildings;a&&a.prepareData(this)}if(this.readerWriter.skinLegos_requested>300)return}},tt.prototype.drawStadistics=function(){var t=this.getObjectLabel().getContext("2d");this.isFarestFrustum()&&this.clearCanvas2D();var e=new dr(130,60),i=this.sceneState;t.font="13px Arial",t.strokeText("Triangles : "+i.trianglesRenderedCount,e.x,e.y),t.fillText("Triangles : "+i.trianglesRenderedCount,e.x,e.y),t.strokeText("Points : "+i.pointsRenderedCount,e.x,e.y+30),t.fillText("Points : "+i.pointsRenderedCount,e.x,e.y+30),t.strokeText("FPS : "+i.fps,e.x,e.y+60),t.fillText("FPS : "+i.fps,e.x,e.y+60),t.restore()},tt.prototype.drawBuildingNames=function(t){for(var e,i,r,o,n,a=this.getObjectLabel().getContext("2d"),s=this.getGl(),l={},h=t.currentVisibles1.concat(t.currentVisibles2,t.currentVisibles3),d=h.length,c=0;c<d;c++){if(i=(e=h[c]).getRoot(),void 0!==e.data&&void 0!==e.data.neoBuilding)if(!(e.data.distToCam>1500))l[u=e.data.neoBuilding.buildingId]=i}for(var u in l)Object.prototype.hasOwnProperty.call(l,u)&&(r=(i=l[u]).data.geoLocDataManager.getCurrentGeoLocationData(),o=i.getBBoxCenterPositionWorldCoord(r),(n=Ei.calculateWorldPositionToScreenCoord(s,o.x,o.y,o.z,n,this)).x>=0&&n.y>=0&&(a.font="13px Arial",a.strokeText(i.data.data_name,n.x,n.y),a.fillText(i.data.data_name,n.x,n.y)));l={},a.restore()},tt.prototype.cameraMoved=function(){this.sceneState.camera.setDirty(!0),void 0===this.selectionFbo&&this.sceneState.gl&&(this.selectionFbo=new R(this.sceneState.gl,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.selectionFbo&&(this.selectionFbo.dirty=!0)},tt.prototype.TEST__RenderGeoCoords=function(){if(void 0===this.test_geoCoords){this.test_geoCoords=!0;var t=this.modeler.getGeographicCoordsList(),e=t.geographicCoordsArray,i=k.getRenderableObjectOfGeoCoordsArray(e,this,void 0);this.modeler.addObject(i,12),t.geographicCoordsArray.length=0}},tt.prototype.TEST__SelectionBuffer=function(){if(void 0!==this.selectionFbo){var t=this.getGl();this.selectionFbo.bind();var e=new Uint8Array(324),i=500-Math.floor(4.5),r=this.sceneState.drawingBufferHeight-500-Math.floor(4.5);i<0&&(i=0),r<0&&(r=0),t.readPixels(i,r,9,9,t.RGBA,t.UNSIGNED_BYTE,e),t.bindFramebuffer(t.FRAMEBUFFER,null);var o=Math.floor(40.5);this.selectionColor.decodeColor3(e[3*o],e[3*o+1],e[3*o+2]);this.selectionFbo.unbind()}},tt.prototype.TEST__ObjectMarker_toNeoReference=function(){var t=this.objMarkerManager,e={speechBubbleOptions:{width:128,height:128,commentTextOption:{pixel:36,color:"blue",borderColor:"white",text:"11011"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"11011"}};t.newObjectMarkerSpeechBubble(e,this);e={speechBubbleOptions:{width:128,height:128,commentTextOption:{pixel:36,color:"blue",borderColor:"white",text:"2953"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"2953"}};t.newObjectMarkerSpeechBubble(e,this);e={speechBubbleOptions:{width:128,height:128,commentTextOption:{pixel:36,color:"blue",borderColor:"white",text:"2837"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"2837"}};t.newObjectMarkerSpeechBubble(e,this)},tt.prototype.getSelectedObjects=function(t,e,i,r,o){void 0===o&&(o=!1),this.selectionFbo.bind(),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthRange(0,1),t.disable(t.CULL_FACE);var n=new Uint8Array(4),a=e-Math.floor(.5),s=this.sceneState.drawingBufferHeight-i-Math.floor(.5);a<0&&(a=0),s<0&&(s=0),t.readPixels(a,s,1,1,t.RGBA,t.UNSIGNED_BYTE,n),t.bindFramebuffer(t.FRAMEBUFFER,null);var l=this.selectionManager,h=Math.floor(.5),d=this.selectionColor.decodeColor3(n[3*h],n[3*h+1],n[3*h+2]);o?l.selectObjects(d):(l.currentReferenceSelected=l.referencesMap[d],l.currentOctreeSelected=l.octreesMap[d],l.currentBuildingSelected=l.buildingsMap[d],l.currentNodeSelected=l.nodesMap[d]);var c=l.currentReferenceSelected;r[0]=l.currentBuildingSelected,r[1]=l.currentOctreeSelected,r[2]=l.currentReferenceSelected,r[3]=l.currentNodeSelected;var u=l.getSelectionCandidatesFamily("networkEdges");if(u)for(var f=u.currentSelected,g=0;void 0===f&&g<1;){d=this.selectionColor.decodeColor3(n[3*g],n[3*g+1],n[3*g+2]);f=u.selectObject(d),g++}var p=l.getSelectionCandidatesFamily("general");if(p){var v=p.currentSelected;for(g=0;void 0===v&&g<1;){d=this.selectionColor.decodeColor3(n[3*g],n[3*g+1],n[3*g+2]);v=p.selectObject(d),g++}}return void 0===c&&(c=l.selCandidatesMap[d]),l.setSelectedGeneral(l.selCandidatesMap[d]),c},tt.prototype.calculateSelObjMovePlaneAsimetricMode=function(t,e,i,r){void 0===this.pointSC&&(this.pointSC=new ur),void 0===this.pointSC2&&(this.pointSC2=new ur);var o=this.nodeSelected.getNodeGeoLocDataManager();Ei.calculatePixelPositionWorldCoord(t,e,i,this.pointSC2,void 0,void 0,void 0,this);var n=o.getCurrentGeoLocationData().getTMatrixInv();return this.pointSC=n.transformPoint3D(this.pointSC2,this.pointSC),void 0===r&&(r=new ut),r.setPointAndNormal(this.pointSC.x,this.pointSC.y,this.pointSC.z,0,0,1),r},tt.prototype.isDragging=function(){if(!this.selectionFbo)return!1;var t=!1,i=this.sceneState.gl;if(this.arrayAuxSC.length=0,!this.selectionFbo)return!1;this.selectionFbo.bind();var r=this.getSelectedObjects(i,this.mouse_x,this.mouse_y,this.arrayAuxSC);if(this.magoPolicy.objectMoveMode===c.moveMode.ALL){this.arrayAuxSC[0];var o,n=this.arrayAuxSC[3];n&&(o=n.getRoot()),this.arrayAuxSC.length=0,t=void 0!==o&&o===this.rootNodeSelected}else if(this.magoPolicy.objectMoveMode===c.moveMode.OBJECT)t=void 0!==r&&r===this.objectSelected;else if(this.weatherStation){var a=this.selectionManager.getSelectionCandidatesFamily("general");if(a){var s=a.currentSelected;s?s instanceof Ui&&(t=!0):t=!1}else t=!1}return t||(r instanceof e&&(r=r.getRootOwner()),void 0!==r&&r===this.selectionManager.getSelectedGeneral()&&(t=!0)),t||this.selectionManager.clearCandidates(),this.selectionFbo.unbind(),t},tt.prototype.setCameraMotion=function(t){f.isTwoDimension()||this.isCesiumGlobe()&&(this.scene.screenSpaceCameraController.enableRotate=t,this.scene.screenSpaceCameraController.enableZoom=t,this.scene.screenSpaceCameraController.enableLook=t,this.scene.screenSpaceCameraController.enableTilt=t,this.scene.screenSpaceCameraController.enableTranslate=t)},tt.prototype.mouseActionLeftUp=function(t,e){if(this.magoPolicy.getMagoEnable()){if(this.objectMoved){this.objectMoved=!1;var i=this.selectionManager.currentNodeSelected;if(void 0===i)return;this.saveHistoryObjectMovement(this.objectSelected,i)}var r=Ei.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);r&&this.emit(tt.EVENT_TYPE.LEFTUP,{type:tt.EVENT_TYPE.LEFTUP,point:r,timestamp:new Date}),this.isCameraMoving=!1,this.mouseLeftDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.selObjMovePlaneCC=void 0,this.startGeoCoordDif=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!0),this.sceneState.mouseAction.clearStartPositionsAux(),this.sceneState.sunSystem&&this.sceneState.applySunShadows&&0===this.currentFrustumIdx&&this.sceneState.sunSystem.updateSun(this)}},tt.prototype.setBPicking=function(t,e){this.bPicking=!1,this.dateSC=new Date,this.currentTimeSC=this.dateSC.getTime(),this.currentTimeSC-this.startTimeSC<1500&&this.mouse_x===t&&this.mouse_y===e&&(this.bPicking=!0)},tt.prototype.keyDown=function(t){if(this.magoPolicy.getMagoEnable())if(void 0===this.modeler&&(this.modeler=new or(this)),32===t){var e=this._settings.getRenderingSettings(),i=e.getPointsCloudInColorRamp();e.setPointsCloudInColorRamp(!i)}else if(37===t)void 0===this.counterAux&&(this.counterAux=-1),-1===this.counterAux?(this.modeler.mode=c.modelerMode.DRAWING_GEOGRAPHICPOINTS,this.counterAux++):0===this.counterAux?(this.modeler.mode=c.modelerMode.DRAWING_BOX,this.counterAux++):1===this.counterAux?(this.modeler.mode=c.modelerMode.DRAWING_TUBE,this.counterAux++):2===this.counterAux?(this.modeler.mode=c.modelerMode.DRAWING_CONCENTRICTUBES,this.counterAux++):3===this.counterAux?(this.modeler.mode=c.modelerMode.DRAWING_BASICFACTORY,this.counterAux++):4===this.counterAux?(this.modeler.mode=c.modelerMode.DRAWING_SPHERE,this.counterAux++):5===this.counterAux?(this.modeler.mode=c.modelerMode.DRAWING_CLIPPINGBOX,this.counterAux++):6===this.counterAux&&(this.modeler.mode=c.modelerMode.DRAWING_FREECONTOURWALL,this.counterAux=0);else if(38===t)this.modeler.mode=c.modelerMode.DRAWING_STATICGEOMETRY;else if(39===t)this.modeler.mode=c.modelerMode.DRAWING_BSPLINE;else if(40===t)this.modeler.mode=c.modelerMode.DRAWING_BASICFACTORY;else if(49===t)void 0===this.pointsCloudWhite&&(this.pointsCloudWhite=!0),this.pointsCloudWhite?this.pointsCloudWhite=!1:this.pointsCloudWhite=!0;else if(80===t){var r=this.hierarchyManager.getNodeByDataKey("AutonomousBus","AutonomousBus_0");r.data.isTrailRender=!0;var o=r.getNodeGeoLocDataManager().getCurrentGeoLocationData().getGeographicCoords(),n=(o.longitude,o.latitude,o.altitude,this.modeler.bSplineCubic3d),a=n.geoCoordsList.geographicCoordsArray,s=new ar(a);if(void 0!==n){var l={animationType:c.animationType.PATH,path:s,linearVelocityInMetersSecond:30,autoChangeRotation:!0};this.changeLocationAndRotation("AutonomousBus","AutonomousBus_0",void 0,void 0,void 0,45,45,void 0,l)}}else if(83===t)this.sceneState.applySunShadows?this.sceneState.setApplySunShadows(!1):this.sceneState.setApplySunShadows(!0);else if(84===t){if(void 0!==this.modeler){var h=this.modeler.getGeographicCoordsList();if(void 0!==h&&h.getGeoCoordsCount()>0){var d=k.getRenderableObjectOfGeoCoordsArray(h.geographicCoordsArray,this);this.modeler.addObject(d,15),h.geographicCoordsArray.length=0}}if(void 0===this.smartTile_f4d_tested){this.smartTile_f4d_tested=1;var u=this.readerWriter.geometryDataPath+"/SmartTilesF4D_WorkFolder/smartTile_f4d_indexFile.sii";this.readerWriter.getObjectIndexFileSmartTileF4d(u,"SmartTilesF4D_WorkFolder",this)}}else if(87===t){if(void 0===this.windTest){void 0===this.weatherStation&&(this.weatherStation=new pi);var f=this.readerWriter.geometryDataPath+"/JeJu_wind_GolfPark_NineBridge1";this.weatherStation.test_loadWindData3d(this,["OBS-QWM_2016062000.grib2_wind_000","OBS-QWM_2016062001.grib2_wind_000","OBS-QWM_2016062002.grib2_wind_000","OBS-QWM_2016062003.grib2_wind_000","OBS-QWM_2016062004.grib2_wind_000","OBS-QWM_2016062005.grib2_wind_000","OBS-QWM_2016062006.grib2_wind_000","OBS-QWM_2016062007.grib2_wind_000","OBS-QWM_2016062008.grib2_wind_000","OBS-QWM_2016062009.grib2_wind_000","OBS-QWM_2016062010.grib2_wind_000","OBS-QWM_2016062011.grib2_wind_000","OBS-QWM_2016062012.grib2_wind_000","OBS-QWM_2016062013.grib2_wind_000","OBS-QWM_2016062014.grib2_wind_000","OBS-QWM_2016062015.grib2_wind_000","OBS-QWM_2016062016.grib2_wind_000","OBS-QWM_2016062017.grib2_wind_000","OBS-QWM_2016062018.grib2_wind_000","OBS-QWM_2016062019.grib2_wind_000","OBS-QWM_2016062020.grib2_wind_000","OBS-QWM_2016062021.grib2_wind_000","OBS-QWM_2016062022.grib2_wind_000","OBS-QWM_2016062023.grib2_wind_000"],f),this.TEST__golfPark(),this.windTest=!0}}else 89===t&&(void 0===this.magoMode&&(this.magoMode=c.magoMode.NORMAL),this.magoMode===c.magoMode.NORMAL?this.magoMode=c.magoMode.DRAWING:this.magoMode===c.magoMode.DRAWING&&(this.magoMode=c.magoMode.NORMAL,this.modeler.mode=c.modelerMode.INACTIVE))},tt.prototype.TEST__golfPark=function(){var t=(i=(e=new j(126.40310387701689,33.34144078912163,34)).getGeoLocationDataManager()).newGeoLocationData("noName");t=Ei.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,t,this),(r=new Be(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=i,void 0===r.attributes&&(r.attributes={}),r.attributes.isMovable=!0,this.modeler.addObject(r,15);t=(i=(e=new j(126.39837002777193,33.341987673830694,23.8)).getGeoLocationDataManager()).newGeoLocationData("noName");t=Ei.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,t,this),(r=new Be(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=i,void 0===r.attributes&&(r.attributes={}),r.attributes.isMovable=!0,this.modeler.addObject(r,15);var e,i,r;t=(i=(e=new j(126.39794580151037,33.341476458307255,18.5)).getGeoLocationDataManager()).newGeoLocationData("noName");t=Ei.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,t,this),(r=new Be(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=i,void 0===r.attributes&&(r.attributes={}),r.attributes.isMovable=!0,this.modeler.addObject(r,15)},tt.prototype.mouseActionLeftClick=function(t,e){if(this.magoPolicy.getMagoEnable()){var i=Ei.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);if(i&&this.emit(tt.EVENT_TYPE.CLICK,{type:tt.EVENT_TYPE.CLICK,clickCoordinate:i,timestamp:this.getCurrentTime()}),this.selectionManager.getSelectedGeneral()instanceof ve);if(this.magoMode===c.magoMode.DRAWING){var r,o;if(void 0===this.modeler&&(this.modeler=new or(this)),this.modeler.mode=c.modelerMode.DRAWING_GEOGRAPHICPOINTS,this.configInformation.geo_view_library===u.CESIUM){var n=this.scene.frameState.camera,a=this.scene,s=n.getPickRay(new Cesium.Cartesian2(t,e));o=a.globe.pick(s,a)}else{o=this.sceneState.mouseAction.strWorldPoint}if(void 0===o)return;if((r=W.CartesianToGeographicWgs84(o.x,o.y,o.z,void 0,!0)).absolutePoint=o,this.modeler.mode===c.modelerMode.DRAWING_GEOGRAPHICPOINTS)r.makeDefaultGeoLocationData(),this.modeler.getGeographicCoordsList().addGeoCoord(r)}}},tt.prototype.doTest__ObjectMarker=function(){var t=this.modeler.getGeographicCoordsList();if(t)for(var e=t.getGeoCoordsCount(),i=e-1;i<e;i++){this.speechBubble||(this.speechBubble=new Mago3D.SpeechBubble);var r=this.speechBubble,o=_.getHexCode(1,1,1),n=r.getPng([64,64],o,{pixel:12,color:"blue",borderColor:"white",text:"blabla"}),a=t.getGeoCoord(i),s=a.longitude,l=a.latitude,h=a.altitude,d={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(s,l,h),imageFilePath:n};this.objMarkerManager.newObjectMarker(d,this)}},tt.prototype.mouseActionLeftDoubleClick=function(t,e){if(this.magoPolicy.getMagoEnable()&&!this.isDragging()){var i=Ei.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);i&&this.emit(tt.EVENT_TYPE.DBCLICK,{type:tt.EVENT_TYPE.DBCLICK,clickCoordinate:i,timestamp:this.getCurrentTime()})}},tt.prototype.mouseActionRightClick=function(t,e){if(this.magoPolicy.getMagoEnable()&&!this.isDragging()){var i=Ei.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);i&&this.emit(tt.EVENT_TYPE.RIGHTCLICK,{type:tt.EVENT_TYPE.RIGHTCLICK,clickCoordinate:i,timestamp:this.getCurrentTime()})}},tt.prototype.cameraChanged=function(t){this.emit(tt.EVENT_TYPE.CAMERACHANGED,{type:tt.EVENT_TYPE.CAMERACHANGED,timestamp:new Date})},tt.prototype.cameraMoveStart=function(){this.emit(tt.EVENT_TYPE.CAMERAMOVESTART,{type:tt.EVENT_TYPE.CAMERAMOVESTART,timestamp:new Date})},tt.prototype.cameraMoveEnd=function(){this.emit(tt.EVENT_TYPE.CAMERAMOVEEND,{type:tt.EVENT_TYPE.CAMERAMOVEEND,timestamp:new Date})},tt.prototype.mouseActionLeftDown=function(t,e){if(this.magoPolicy.getMagoEnable()){this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=t,this.mouse_y=e,this.mouseLeftDown=!0,tr.updateMouseStartClick(t,e,this);var i=Ei.getComplexCoordinateByScreenCoord(this.getGl(),t,e,void 0,void 0,void 0,this);i&&this.emit(tt.EVENT_TYPE.LEFTDOWN,{type:tt.EVENT_TYPE.LEFTDOWN,point:i,timestamp:new Date}),this.setBPicking(t,e)}},tt.prototype.saveHistoryObjectMovement=function(t,e){var i=new d,r=i.getReferenceObjectAditionalMovement(),o=i.getReferenceObjectAditionalMovementRelToBuilding();if(void 0===t.moveVector&&(t.moveVector=new ur),void 0===t.moveVectorRelToBuilding&&(t.moveVectorRelToBuilding=new ur),r.set(t.moveVector.x,t.moveVector.y,t.moveVector.z),o.set(t.moveVectorRelToBuilding.x,t.moveVectorRelToBuilding.y,t.moveVectorRelToBuilding.z),void 0!==e){var n=e.data.projectId,a=e.data.nodeId,s=t._id;i.setProjectId(n),i.setDataKey(a),i.setObjectIndexOrder(s),f.saveMovingHistory(n,a,s,i)}},tt.prototype.mouseActionMiddleDown=function(t,e){this.magoPolicy.getMagoEnable()&&(this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=t,this.mouse_y=e,this.mouseMiddleDown=!0,this.isCameraMoving=!0)},tt.prototype.mouseActionMiddleUp=function(t,e){this.magoPolicy.getMagoEnable()&&(this.isCameraMoving=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!1))},tt.prototype.mouseActionRightDown=function(t,e){},tt.prototype.mouseActionRightUp=function(t,e){},tt.prototype.mouseActionMove=function(t,e){this.mouseLeftDown?t.x===e.x&&t.y===e.y||(this.manageMouseDragging(t.x,t.y),this.cameraMoved()):(this.mouseDragging=!1,this.isCesiumGlobe()&&this.setCameraMotion(!0),(this.mouseMiddleDown||this.mouseRightDown)&&(this.isCameraMoving=!0,this.cameraMoved()));var i=this.getGl(),r=Ei.getComplexCoordinateByScreenCoord(i,e.x,e.y,void 0,void 0,void 0,this),o=Ei.getComplexCoordinateByScreenCoord(i,t.x,t.y,void 0,void 0,void 0,this);r&&o&&this.emit(tt.EVENT_TYPE.MOUSEMOVE,{type:tt.EVENT_TYPE.MOUSEMOVE,startEvent:r,endEvent:o,timestamp:this.getCurrentTime()})},tt.prototype.manageMouseDragging=function(t,e){if(this.sceneState.camera.setDirty(!0),this.mouse_x=t,this.mouse_y=e,this.magoPolicy.objectMoveMode===c.moveMode.ALL)if(void 0!==this.buildingSelected&&this.selectionManager.currentNodeSelected){this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1);var i=this.buildingSelected.nodeOwner;if(void 0===i)return;var r=i.data.geoLocDataManager;if(void 0===r)return;var o=r.getGeoLocationData(0);if(void 0===o)return;var n=o.geographicCoord;if(void 0===n)return;this.emit(tt.EVENT_TYPE.SELECTEDF4DMOVED,{type:tt.EVENT_TYPE.SELECTEDF4DMOVED,result:{projectId:i.data.projectId,dataKey:i.data.nodeId,latitude:n.latitude,longitude:n.longitude,altitude:n.altitude,heading:o.heading,pitch:o.pitch,roll:o.roll},timestamp:new Date})}else this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===c.moveMode.OBJECT)void 0!==this.objectSelected&&this.selectionManager.currentOctreeSelected?this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1):this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===c.moveMode.GEOGRAPHICPOINTS){var a=this.selectionManager.getSelectedGeneral();if(a)"GeographicCoord"===a.constructor.name&&this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1)}this.mouseDragging||this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1),this.isCameraMoving=!0,this.mouseDragging&&this.moveSelectedObjectAsimetricMode(this.sceneState.gl)},tt.prototype.moveSelectedObjectGeneral=function(t,e){if(void 0!==e&&(!(e instanceof st)&&void 0!==(y=(e=e.getRootOwner()).attributes))){var i=y.isMovable;if(void 0!==i&&!1!==i){var r=e.getGeoLocDataManager();if(void 0!==r){var o=r.getCurrentGeoLocationData(),n=this.sceneState.mouseAction;if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new ut;var a=o.geoLocMatrix,s=this.sceneState.modelViewMatrix,l=this.sceneState.modelViewRelToEyeMatrix,h=s.transformPoint3D(n.strWorldPoint,void 0);if(y.movementInAxisZ){var d=new ur(a._floatArrays[4],a._floatArrays[5],a._floatArrays[6]),c=l.transformPoint3D(d,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,c.x,c.y,c.z)}else{var u=new ur(a._floatArrays[8],a._floatArrays[9],a._floatArrays[10]),f=l.transformPoint3D(u,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,f.x,f.y,f.z)}}void 0===this.lineCC&&(this.lineCC=new Yi);var g=Ei.getRayCamSpace(this.mouse_x,this.mouse_y,g,this);this.lineCC.setPointAndDir(0,0,0,g[0],g[1],g[2]);var p=new ur;p=this.selObjMovePlaneCC.intersectionLine(this.lineCC,p);var v=(s=this.sceneState.getModelViewMatrixInv()).transformPoint3D(p,v);if(this.thereAreStartMovePoint){var y,m=(R=Ei.pointToGeographicCoord(v,R,this)).longitude-this.startGeoCoordDif.longitude,x=R.latitude-this.startGeoCoordDif.latitude,b=R.altitude-this.startGeoCoordDif.altitude;if(void 0!==(y=e.attributes).minAltitude&&b<y.minAltitude&&(b=y.minAltitude),void 0!==y.maxAltitude&&b>y.maxAltitude&&(b=y.maxAltitude),y&&y.movementRestriction){var C=y.movementRestriction;if(C){C.restrictionType;var A=C.element;if(A&&"GeographicCoordSegment"===A.constructor.name){var T=A,M=new j(m,x,0),P=U.getProjectedCoordToLine(T,M,void 0);if(U.intersectionWithGeoCoord(T,P))m=P.longitude,x=P.latitude;else{var w=U.getNearestGeoCoord(T,P);m=w.longitude,x=w.latitude}}}}if(y&&y.hasStaticModel){var _=y.projectId,S=y.instanceId;if(!Si(_))return!1;if(!Si(S))return!1;var L=this.hierarchyManager.getNodeByDataKey(_,S);void 0!==L&&L.changeLocationAndRotation(x,m,0,y.f4dHeading,0,0,this)}o=y.movementInAxisZ?Ei.calculateGeoLocationData(void 0,void 0,b,void 0,void 0,void 0,o,this):Ei.calculateGeoLocationData(m,x,void 0,void 0,void 0,void 0,o,this)}else{var R=Ei.pointToGeographicCoord(v,R,this);this.thereAreStartMovePoint=!0;var D=o.geographicCoord;this.startGeoCoordDif=new j(R.longitude-D.longitude,R.latitude-D.latitude,R.altitude-D.altitude)}e.moved()}}}},tt.prototype.moveSelectedObjectAsimetricMode=function(t){if(this.magoPolicy.isModelMovable()){var e=this.selectionManager.getSelectedGeneral(),i="";if(e&&(i=e.constructor.name),this.magoPolicy.objectMoveMode===c.moveMode.ALL){if(void 0===this.selectionManager.currentNodeSelected)return;var r=(M=this.selectionManager.currentNodeSelected.getNodeGeoLocDataManager()).getCurrentGeoLocationData(),o=this.sceneState.mouseAction,n={};if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new ut;var a=r.geoLocMatrix,s=this.sceneState.modelViewMatrix,l=this.sceneState.modelViewRelToEyeMatrix,h=s.transformPoint3D(o.strWorldPoint,void 0);if(n.movementInAxisZ){var d=new ur(a._floatArrays[4],a._floatArrays[5],a._floatArrays[6]),u=l.transformPoint3D(d,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,u.x,u.y,u.z)}else{var g=new ur(a._floatArrays[8],a._floatArrays[9],a._floatArrays[10]),p=l.transformPoint3D(g,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,p.x,p.y,p.z)}}void 0===this.lineCC&&(this.lineCC=new Yi);var v=Ei.getRayCamSpace(this.mouse_x,this.mouse_y,v,this);this.lineCC.setPointAndDir(0,0,0,v[0],v[1],v[2]);var y=new ur;y=this.selObjMovePlaneCC.intersectionLine(this.lineCC,y);var m=(s=this.sceneState.getModelViewMatrixInv()).transformPoint3D(y,m);if(this.thereAreStartMovePoint){var x=D=(A=Ei.pointToGeographicCoord(m,A,this)).longitude-this.startGeoCoordDif.longitude,b=E=A.latitude-this.startGeoCoordDif.latitude,C=I=A.altitude-this.startGeoCoordDif.altitude;n.movementInAxisZ?this.changeLocationAndRotationNode(this.selectionManager.currentNodeSelected,void 0,void 0,C,void 0,void 0,void 0):this.changeLocationAndRotationNode(this.selectionManager.currentNodeSelected,b,x,void 0,void 0,void 0,void 0),this.displayLocationAndRotation(this.buildingSelected)}else{var A=Ei.pointToGeographicCoord(m,A,this);this.thereAreStartMovePoint=!0;var T=r.geographicCoord;this.startGeoCoordDif=new j(A.longitude-T.longitude,A.latitude-T.latitude,A.altitude-T.altitude)}}else if(this.magoPolicy.objectMoveMode===c.moveMode.OBJECT){if(void 0===this.objectSelected)return;if("NeoReference"!==this.objectSelected.constructor.name)return;void 0===this.selObjMovePlane&&(this.selObjMovePlane=this.calculateSelObjMovePlaneAsimetricMode(t,this.mouse_x,this.mouse_y,this.selObjMovePlane));var M=this.selectionManager.currentNodeSelected.getNodeGeoLocDataManager();void 0===this.lineSC&&(this.lineSC=new Yi),this.lineSC=Ei.getRayWorldSpace(t,this.mouse_x,this.mouse_y,this.lineSC,this);var P=M.getCurrentGeoLocationData(),w=new ur,_=new ur,S=P.getTMatrixInv();w=S.transformPoint3D(this.lineSC.point,w),_=S.rotatePoint3D(this.lineSC.direction,_);var L=new Yi;L.setPointAndDir(w.x,w.y,w.z,_.x,_.y,_.z);var R=new ur;if(R=this.selObjMovePlane.intersectionLine(L,R),void 0===this.objectSelected.moveVectorRelToBuilding&&(this.objectSelected.moveVectorRelToBuilding=new ur),this.thereAreStartMovePoint){var D=R.x-this.startMovPoint.x,E=R.y-this.startMovPoint.y,I=R.z-this.startMovPoint.z;this.objectSelected.moveVectorRelToBuilding.set(D,E,I),this.objectSelected.moveVector=P.tMatrix.rotatePoint3D(this.objectSelected.moveVectorRelToBuilding,this.objectSelected.moveVector)}else this.startMovPoint=R,this.startMovPoint.add(-this.objectSelected.moveVectorRelToBuilding.x,-this.objectSelected.moveVectorRelToBuilding.y,-this.objectSelected.moveVectorRelToBuilding.z),this.thereAreStartMovePoint=!0;var O=this.selectionManager.currentNodeSelected.data.projectId,F=this.selectionManager.currentNodeSelected.data.nodeId,N=this.objectSelected._id;f.deleteMovingHistoryObject(O,F,N),this.objectMoved=!0}else if(this.magoPolicy.objectMoveMode===c.moveMode.GEOGRAPHICPOINTS&&"GeographicCoord"===i){if(e){var B;r=(M=e.getGeoLocationDataManager()).getCurrentGeoLocationData();if(this.isCesiumGlobe()){var V=this.scene.frameState.camera,U=this.scene,k=V.getPickRay(new Cesium.Cartesian2(this.mouse_x,this.mouse_y));K=U.globe.pick(k,U),B=W.CartesianToGeographicWgs84(K.x,K.y,K.z,void 0,!0)}else{K=(o=this.sceneState.mouseAction).strWorldPoint,B=W.CartesianToGeographicWgs84(K.x,K.y,K.z,void 0,!0)}e.setLonLatAlt(B.longitude,B.latitude,void 0);var G=(M=e.getGeoLocationDataManager()).getCurrentGeoLocationData();G=Ei.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,G,this);var z=e.owner;if(z){"GeographicCoordsList"===z.constructor.name&&z.makeLines(this);var H=z.owner;H&&("Excavation"===H.constructor.name?H.remakeExtrudeObject(this):"Tunnel"===H.constructor.name&&H.remakeMesh(this))}}}else{if(this.weatherStation){var X=this.selectionManager.getSelectionCandidatesFamily("general");if(X){var Y=X.currentSelected;if(Y&&Y instanceof Ui){var K;r=(M=Y.geoLocDataManager).getCurrentGeoLocationData(),o=this.sceneState.mouseAction,v=Ei.getRayWorldSpace(t,this.mouse_x,this.mouse_y,void 0,this);if(K=o.strWorldPointAux){var q,Z=K.getModul();if(q=this.globe.intersectionLineWgs84(v,q,Z)){var Q=new ur(q[0],q[1],q[2]),J=Ei.pointToGeographicCoord(Q,void 0,this),$=o.strLocationAux,tt=r.geographicCoord,et=new j;et.setLonLatAlt(J.longitude-$.longitude,J.latitude-$.latitude,J.altitude-$.altitude);x=tt.longitude+et.longitude,b=tt.latitude+et.latitude;r=Ei.calculateGeoLocationData(x,b,void 0,void 0,void 0,void 0,r,this),o.strLocationAux.setLonLatAlt(J.longitude,J.latitude,J.altitude)}}}}}var it=this.selectionManager.getSelectedGeneral();it&&this.moveSelectedObjectGeneral(t,it)}}},tt.prototype.test_renderDepth_objectSelected=function(t){var e=this.sceneState.gl;void 0===this.depthFboAux&&(this.depthFboAux=new R(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.sceneState.drawingBufferWidth[0]===this.depthFboAux.width[0]&&this.sceneState.drawingBufferHeight[0]===this.depthFboAux.height[0]||(this.depthFboAux.deleteObjects(e),this.depthFboAux=new R(e,this.sceneState.drawingBufferWidth,this.sceneState.drawingBufferHeight)),this.depthFboAux.bind(),this.isFarestFrustum()&&(e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)),e.disable(e.BLEND),e.frontFace(e.CCW),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE);var i=this.postFxShadersManager.getShader("modelRefDepth");i.useProgram(),i.bindUniformGenerals(),i.enableVertexAttribArray(i.position3_loc);var r=t.geoLocDataManager.getCurrentGeoLocationData(),o=i.uniformsMapGeneral.frustumFar.uniformLocation;e.uniform1f(o,new Float32Array([1e8]));r.bindGeoLocationUniforms(e,i),e.uniform3fv(i.aditionalMov_loc,[0,0,0]),t.render(this,i,0),this.depthFboAux.unbind()},tt.prototype.getRenderablesDetailedNeoBuildingAsimetricVersion=function(t,e,i,r){var o=e.data,n=o.neoBuilding;o.currentLod;if(void 0===n||void 0===n.octree)return!1;var a=n.getLodBuildingData(o.currentLod);if(void 0===a)return!1;if(!a.isModelRef)return!0;var s=e.getNodeGeoLocDataManager(),l=(s.getCurrentGeoLocationData(),s.getCurrentGeoLocationData());if(void 0===l)return!1;void 0===o.currentVisibleOctreesControler&&(o.currentVisibleOctreesControler=new Bt);var h=this.magoPolicy.getLod0DistInMeters(),d=this.magoPolicy.getLod1DistInMeters(),c=this.magoPolicy.getLod2DistInMeters(),u=(this.magoPolicy.getLod3DistInMeters(),this.magoPolicy.getLod4DistInMeters(),this.magoPolicy.getLod5DistInMeters()),f=!1;if(void 0===o.myCameraRelative&&(o.myCameraRelative=new A),o.myCameraRelative.frustum.copyParametersFrom(this.myCameraSCX.bigFrustum),o.myCameraRelative=l.getTransformedRelativeCamera(this.sceneState.camera,o.myCameraRelative),o.currentVisibleOctreesControler.clear(),2===r)n.octree.extractLowestOctreesByLOD(o.currentVisibleOctreesControler,i,this.boundingSphere_Aux,o.myCameraRelative.position,h,d,u),f=!0;else{o.myCameraRelative.calculateFrustumsPlanes();var g=o.myCameraRelative.bigFrustum;f=n.octree.getFrustumVisibleLowestOctreesByLOD(g,o.currentVisibleOctreesControler,i,this.boundingSphere_Aux,o.myCameraRelative.position,h,d,100*c)}return f?(this.processQueue.eraseNodeToDeleteModelReferences(e),!0):(o.distToCam>100&&this.processQueue.putNodeToDeleteModelReferences(e,1),!1)},tt.prototype.manageQueue=function(){var t=this.sceneState.gl;this.processQueue.manageDeleteQueue(this),this.parseQueue.initCounters(),this.parseQueue.parseArrayOctreesLod0References(this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0References(this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod0Models(this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0Models(this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod2Legos(t,this.visibleObjControlerOctrees.currentVisibles2,this),this.parseQueue.parseArrayOctreesPCloud(t,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArrayOctreesPCloudPartition(t,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles0,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles2,this),this.parseQueue.parseArraySkins(t,this.visibleObjControlerNodes.currentVisibles3,this),this.parseQueue.parseMultiBuildings(t,this.visibleObjControlerNodes.currentVisibles0,this),this.parseQueue.parseMultiBuildings(t,this.visibleObjControlerNodes.currentVisibles2,this),this.parseQueue.parseMultiBuildings(t,this.visibleObjControlerNodes.currentVisibles3,this);var e=0;for(var i in this.parseQueue.tinTerrainsToParseMap){var r;if(Object.prototype.hasOwnProperty.call(this.parseQueue.tinTerrainsToParseMap,i))if(void 0!==(r=this.parseQueue.tinTerrainsToParseMap[i])&&this.parseQueue.eraseTinTerrainToParse(r)&&(r.parseData(r.dataArrayBuffer),e++),e>1)break}},tt.prototype.prepareVisibleOctreesSortedByDistancePointsCloudType=function(t,e,i){if(!(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)){var r=i,o=e.getAllVisibles();if(void 0!==o)for(var n,a,s,l,h=this.readerWriter.geometryDataPath,d=0,u=o.length;d<u;d++){if(this.fileRequestControler.isFullPlus(r))return;if(void 0!==(l=o[d]).octree_number_name&&(void 0===l.lego&&(l.lego=new Yt,l.lego.fileLoadState=c.fileLoadState.READY,l.lego.legoKey=l.octreeKey+"_lego"),void 0!==(a=l.neoBuildingOwner))){var f=a.metaData.projectDataType;if(void 0!==f&&4===f){if(n=a.projectFolderName,s=a.buildingFileName,l.lego.fileLoadState===c.fileLoadState.READY){var g=h+"/"+n+"/"+s+"/References"+"/"+l.octree_number_name.toString()+"_Ref";this.loadQueue.putLod2PCloudData(l,g,void 0,void 0,0)}if(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)return}}}}},tt.prototype.prepareVisibleOctreesSortedByDistance=function(t,e){if(!(this.readerWriter.referencesList_requested>5)){var i,r=[].concat(e.currentVisibles0,e.currentVisibles1);this.thereAreUrgentOctrees=!1;for(var o=0,n=r.length;o<n;o++){var a=(i=r[o]).neoBuildingOwner,s=a.getHeaderVersion();if(!0===a.getLodBuildingData(2).isModelRef&&this.readerWriter.octreesSkinLegos_requested<5&&(void 0!==i.lego&&i.lego.isReadyToRender()||i.prepareSkinData(this)),this.readerWriter.referencesList_requested<5)if(void 0!==i.neoReferencesMotherAndIndices&&i.neoReferencesMotherAndIndices.isReadyToRender()){if("0.0.2"===s){var l=i.neoReferencesMotherAndIndices.blocksList;l&&l.prepareData(this,i)}}else i.prepareModelReferencesListData(this);if(this.readerWriter.referencesList_requested>5)return;0}}},tt.prototype.prepareVisibleOctreesSortedByDistanceLOD2=function(t,e){if(!(this.readerWriter.octreesSkinLegos_requested>5)&&void 0!==e)for(var i,r=0,o=e.length;r<o;r++){if((i=e[r]).neoBuildingOwner.getLodBuildingData(2).isModelRef&&(i.prepareSkinData(this),this.readerWriter.octreesSkinLegos_requested>5))return}},tt.prototype.checkChangesHistoryMovements=function(t){for(var e,i,r,o,n,a=t.length,s=0;s<a;s++)void 0!==(i=(e=t[s]).getRoot())&&(i.getNodeGeoLocDataManager().getCurrentGeoLocationData(),r=e.data.projectId,o=e.data.nodeId,(n=f.getMovingHistoryObjects(r,o))&&(e.data.moveHistoryMap=n))},tt.prototype.checkPropertyFilters=function(t){if(void 0!==this.propertyFilterSC)for(var e,i=t.length,r=this.propertyFilterSC.propertyKey,o=this.propertyFilterSC.propertyValue,n=this.propertyFilterSC.visible,a=0;a<i;a++)(e=t[a]).data.projectId===this.propertyFilterSC.projectId&&e.data.attributes&&(void 0!==e.data.attributes[r]&&e.data.attributes[r].toString()===o?!0===n||(t.splice(a,1),a--,i=t.length):!0===n&&(t.splice(a,1),a--,i=t.length))},tt.prototype.checkChangesHistoryColors=function(t){for(var e,i,r=t.length,o=0;o<r;o++){if(void 0!==(e=t[o]).getRoot())if(u=e.data.projectId,i=e.data.nodeId,s=f.getColorHistorys(u,i))(m=e.data).colorChangedHistoryMap=s}var n=f.getAllColorHistory();if(n)for(var a in n)if(Object.prototype.hasOwnProperty.call(n,a)){var s=n[a];for(var l in s)if(Object.prototype.hasOwnProperty.call(s,l)){var h=s[l];for(var d in h)if(Object.prototype.hasOwnProperty.call(h,d)){var c=h[d],u=c.projectId,g=this.hierarchyManager.getNodesMap(u)[c.dataKey];if(g&&void 0!==g.data.attributes.isPhysical&&!1===g.data.attributes.isPhysical)if(null===c.property||void 0===c.property||""===c.property){t=[];g.extractNodes(t);for(r=t.length,o=0;o<r;o++){(m=(y=t[o]).data)&&(m.isColorChanged=!0,void 0===m.aditionalColor&&(m.aditionalColor=new _),m.aditionalColor.setRGBA(c.color[0],c.color[1],c.color[2],c.color[3]))}}else{var p=c.propertyKey,v=c.propertyValue;t=[];g.extractNodes(t);for(r=t.length,o=0;o<r;o++){var y,m;(m=(y=t[o]).data)&&void 0!==y.data.attributes[p]&&y.data.attributes[p].toString()===v&&(m.isColorChanged=!0,void 0===m.aditionalColor&&(m.aditionalColor=new _),m.aditionalColor.setRGBA(c.color[0],c.color[1],c.color[2],c.color[3]))}}}}}},tt.prototype.getObjectLabel=function(){if(void 0===this.canvasObjectLabel){if(this.canvasObjectLabel=document.getElementById("objectLabel"),void 0===this.canvasObjectLabel)return;var t=document.getElementById(f.getContainerId()),e=t.offsetLeft,i=t.offsetTop;t.offsetWidth,t.offsetHeight;this.canvasObjectLabel.style.opacity=1,this.canvasObjectLabel.width=this.sceneState.drawingBufferWidth,this.canvasObjectLabel.height=this.sceneState.drawingBufferHeight;var r=e.toString()+"px",o=i.toString()+"px";this.canvasObjectLabel.style.left=r,this.canvasObjectLabel.style.top=o,this.canvasObjectLabel.style.position="absolute",this.canvasObjectLabel.style.opacity=1,this.canvasObjectLabel.width=this.sceneState.drawingBufferWidth,this.canvasObjectLabel.height=this.sceneState.drawingBufferHeight;var n=this.canvasObjectLabel.getContext("2d");n.strokeStyle="DarkSlateGray",n.fillStyle="PapayaWhip",n.lineWidth=4,n.font="20px Arial",n.textAlign="center",n.fillRect(0,0,n.canvas.width,n.canvas.height),n.save(),n.clearRect(0,0,n.canvas.width,n.canvas.height);n.measureText("M").width}return this.canvasObjectLabel},tt.prototype.drawCCTVNames=function(t){var e=this.getObjectLabel().getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height);for(var i,r,o,n=this.sceneState.gl,a=t.length,s=0;s<a;s++)i=(o=t[s]).geoLocationData.position,(r=Ei.calculateWorldPositionToScreenCoord(n,i.x,i.y,i.z,r,this)).x>=0&&r.y>=0&&(e.font="13px Arial",e.strokeText(o.name,r.x,r.y),e.fillText(o.name,r.x,r.y));e.restore()},tt.prototype.setRenderCondition=function(t,e,i){if(!i||"function"!=typeof i)throw new Error("renderCondition is required.");if(!t)throw new Error("projectId is required.");if(!this.hierarchyManager.existProject(t))throw new Error(t+" project is not exist.");var r=this.hierarchyManager.getNodesMap(t);if(e)n(r[e],i);else for(var o in r)r.hasOwnProperty(o)&&n(r[o],i);function n(t,e){t instanceof he&&t.data.attributes.isPhysical&&t.setRenderCondition(e)}},tt.prototype.createDefaultShaders=function(t){var e="USE_LINEAR_DEPTH";this.isCesiumGlobe()||(t.getSupportedExtensions().indexOf("EXT_frag_depth")&&t.getExtension("EXT_frag_depth"),this.EXTENSIONS_init=!0,e="USE_LOGARITHMIC_DEPTH");var i="modelRefSsao",r=$e.ModelRefSsaoVS;l=(l=$e.ModelRefSsaoFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,e),(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).bUseLogarithmicDepth_loc=t.getUniformLocation(h.program,"bUseLogarithmicDepth");i="modelRefDepth";var o=$e.RenderShowDepthVS;s=(s=$e.RenderShowDepthFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,e),(h=this.postFxShadersManager.createShaderProgram(t,o,s,i,this)).bUseLogarithmicDepth_loc=t.getUniformLocation(h.program,"bUseLogarithmicDepth");i="modelRefColorCoding",o=$e.ColorSelectionSsaoVS;var n,a,s=$e.ColorSelectionSsaoFS;h=this.postFxShadersManager.createShaderProgram(t,o,s,i,this),i="tinTerrain",r=$e.TinTerrainVS,l=(l=$e.TinTerrainFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,e),(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).bIsMakingDepth_loc=t.getUniformLocation(h.program,"bIsMakingDepth"),h.bExistAltitudes_loc=t.getUniformLocation(h.program,"bExistAltitudes"),h.uMinMaxAltitudes_loc=t.getUniformLocation(h.program,"uMinMaxAltitudes"),h.uTileDepth_loc=t.getUniformLocation(h.program,"uTileDepth"),h.altitude_loc=t.getAttribLocation(h.program,"altitude"),h.uSeaOrTerrainType_loc=t.getUniformLocation(h.program,"uSeaOrTerrainType"),h.bUseLogarithmicDepth_loc=t.getUniformLocation(h.program,"bUseLogarithmicDepth"),h.bApplyCaustics_loc=t.getUniformLocation(h.program,"bApplyCaustics"),h.uActiveTextures_loc=t.getUniformLocation(h.program,"uActiveTextures"),h.externalAlphasArray_loc=t.getUniformLocation(h.program,"externalAlphasArray"),(a=h.getUniformDataPair("shadowMapTex")).intValue=0,(a=h.getUniformDataPair("shadowMapTex2")).intValue=1,(a=h.getUniformDataPair("diffuseTex")).intValue=2,null!==(n=t.getUniformLocation(h.program,"diffuseTex_1"))&&void 0!==n&&((a=h.newUniformDataPair("1i","diffuseTex_1")).uniformLocation=n,a.intValue=3),null!==(n=t.getUniformLocation(h.program,"diffuseTex_2"))&&void 0!==n&&((a=h.newUniformDataPair("1i","diffuseTex_2")).uniformLocation=n,a.intValue=4),null!==(n=t.getUniformLocation(h.program,"diffuseTex_3"))&&void 0!==n&&((a=h.newUniformDataPair("1i","diffuseTex_3")).uniformLocation=n,a.intValue=5),null!==(n=t.getUniformLocation(h.program,"diffuseTex_4"))&&void 0!==n&&((a=h.newUniformDataPair("1i","diffuseTex_4")).uniformLocation=n,a.intValue=6),null!==(n=t.getUniformLocation(h.program,"diffuseTex_5"))&&void 0!==n&&((a=h.newUniformDataPair("1i","diffuseTex_5")).uniformLocation=n,a.intValue=7),i="tinTerrainAltitudes",r=$e.TinTerrainAltitudesVS,l=$e.TinTerrainAltitudesFS,h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this),i="pointsCloud",r=$e.PointCloudVS,l=$e.PointCloudFS,(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).bPositionCompressed_loc=t.getUniformLocation(h.program,"bPositionCompressed"),h.minPosition_loc=t.getUniformLocation(h.program,"minPosition"),h.bboxSize_loc=t.getUniformLocation(h.program,"bboxSize"),h.maxPointSize_loc=t.getUniformLocation(h.program,"maxPointSize"),h.minPointSize_loc=t.getUniformLocation(h.program,"minPointSize"),h.pendentPointSize_loc=t.getUniformLocation(h.program,"pendentPointSize"),h.uStrokeColor_loc=t.getUniformLocation(h.program,"uStrokeColor"),h.uStrokeSize_loc=t.getUniformLocation(h.program,"uStrokeSize"),h.bUseLogarithmicDepth_loc=t.getUniformLocation(h.program,"bUseLogarithmicDepth"),i="testQuad",r=$e.Test_QuadVS,l=$e.Test_QuadFS,h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this),i="filterSilhouette",r=$e.wgs84_volumVS,l=$e.filterSilhouetteFS,h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this),i="pointsCloudDepth",r=$e.PointCloudDepthVS,l=$e.PointCloudDepthFS,(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).bPositionCompressed_loc=t.getUniformLocation(h.program,"bPositionCompressed"),h.minPosition_loc=t.getUniformLocation(h.program,"minPosition"),h.bboxSize_loc=t.getUniformLocation(h.program,"bboxSize"),h.maxPointSize_loc=t.getUniformLocation(h.program,"maxPointSize"),h.minPointSize_loc=t.getUniformLocation(h.program,"minPointSize"),h.pendentPointSize_loc=t.getUniformLocation(h.program,"pendentPointSize"),i="pointsCloudSsao",r=$e.PointCloudVS,l=$e.PointCloudSsaoFS,(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).bPositionCompressed_loc=t.getUniformLocation(h.program,"bPositionCompressed"),h.minPosition_loc=t.getUniformLocation(h.program,"minPosition"),h.bboxSize_loc=t.getUniformLocation(h.program,"bboxSize"),h.maxPointSize_loc=t.getUniformLocation(h.program,"maxPointSize"),h.minPointSize_loc=t.getUniformLocation(h.program,"minPointSize"),h.pendentPointSize_loc=t.getUniformLocation(h.program,"pendentPointSize"),h.bUseLogarithmicDepth_loc=t.getUniformLocation(h.program,"bUseLogarithmicDepth"),i="pointsCloudSsao_rainbow",r=$e.PointCloudVS_rainbow,l=$e.PointCloudSsaoFS_rainbow,(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).bPositionCompressed_loc=t.getUniformLocation(h.program,"bPositionCompressed"),h.minPosition_loc=t.getUniformLocation(h.program,"minPosition"),h.bboxSize_loc=t.getUniformLocation(h.program,"bboxSize"),h.bUseColorCodingByHeight_loc=t.getUniformLocation(h.program,"bUseColorCodingByHeight"),h.minHeight_rainbow_loc=t.getUniformLocation(h.program,"minHeight_rainbow"),h.maxHeight_rainbow_loc=t.getUniformLocation(h.program,"maxHeight_rainbow"),h.maxPointSize_loc=t.getUniformLocation(h.program,"maxPointSize"),h.minPointSize_loc=t.getUniformLocation(h.program,"minPointSize"),h.pendentPointSize_loc=t.getUniformLocation(h.program,"pendentPointSize"),h.bUseLogarithmicDepth_loc=t.getUniformLocation(h.program,"bUseLogarithmicDepth"),i="atmosphere",r=$e.atmosphereVS,l=$e.atmosphereFS,(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).bIsMakingDepth_loc=t.getUniformLocation(h.program,"bIsMakingDepth"),h.equatorialRadius_loc=t.getUniformLocation(h.program,"equatorialRadius"),(a=h.getUniformDataPair("mvpMat4RelToEye")).matrix4fv=this.sceneState.modelViewProjRelToEyeMatrixSky._floatArrays;i="imageViewerRectangle",r=$e.ImageViewerRectangleShaderVS;var l=$e.ImageViewerRectangleShaderFS;h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this);i="orthogonalDepth",r=$e.OrthogonalDepthShaderVS,l=$e.OrthogonalDepthShaderFS;(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).modelViewProjectionMatrixRelToEye_loc=t.getUniformLocation(h.program,"ModelViewProjectionMatrixRelToEye"),h.modelViewMatrixRelToEye_loc=t.getUniformLocation(h.program,"modelViewMatrixRelToEye"),h.encodedCameraPositionMCHigh_loc=t.getUniformLocation(h.program,"encodedCameraPositionMCHigh"),h.encodedCameraPositionMCLow_loc=t.getUniformLocation(h.program,"encodedCameraPositionMCLow"),h.fov_loc=t.getUniformLocation(h.program,"fov"),h.aspectRatio_loc=t.getUniformLocation(h.program,"aspectRatio"),h.screenWidth_loc=t.getUniformLocation(h.program,"screenWidth"),h.screenHeight_loc=t.getUniformLocation(h.program,"screenHeight");i="thickLine",r=$e.thickLineVS;l=(l=$e.thickLineFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,e),(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).projectionMatrix_loc=t.getUniformLocation(h.program,"projectionMatrix"),h.modelViewMatrix_loc=t.getUniformLocation(h.program,"modelViewMatrix"),h.viewport_loc=t.getUniformLocation(h.program,"viewport"),h.thickness_loc=t.getUniformLocation(h.program,"thickness"),h.bUseLogarithmicDepth_loc=t.getUniformLocation(h.program,"bUseLogarithmicDepth"),t.bindAttribLocation(h.program,0,"prev"),t.bindAttribLocation(h.program,1,"current"),t.bindAttribLocation(h.program,2,"next"),t.bindAttribLocation(h.program,3,"color4"),h.prev_loc=0,h.current_loc=1,h.next_loc=2,h.color4_loc=3;i="thickLineDepth",r=$e.thickLineDepthVS,l=$e.PointCloudDepthFS;(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).projectionMatrix_loc=t.getUniformLocation(h.program,"projectionMatrix"),h.modelViewMatrix_loc=t.getUniformLocation(h.program,"modelViewMatrix"),h.viewport_loc=t.getUniformLocation(h.program,"viewport"),h.thickness_loc=t.getUniformLocation(h.program,"thickness"),t.bindAttribLocation(h.program,0,"prev"),t.bindAttribLocation(h.program,1,"current"),t.bindAttribLocation(h.program,2,"next"),t.bindAttribLocation(h.program,3,"color4"),h.prev_loc=0,h.current_loc=1,h.next_loc=2,h.color4_loc=3;i="screenQuad",r=$e.ScreenQuadVS,l=$e.ScreenQuadFS;var h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this);i="pin",r=$e.PngImageVS,l=$e.PngImageFS;(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).position4_loc=t.getAttribLocation(h.program,"position"),h.texCoord2_loc=t.getAttribLocation(h.program,"texCoord"),h.scale2d_loc=t.getUniformLocation(h.program,"scale2d"),h.size2d_loc=t.getUniformLocation(h.program,"size2d"),h.imageSize_loc=t.getUniformLocation(h.program,"imageSize"),h.bUseOriginalImageSize_loc=t.getUniformLocation(h.program,"bUseOriginalImageSize"),h.aditionalOffset_loc=t.getUniformLocation(h.program,"aditionalOffset");i="texturesMerger",r=$e.texturesMergerVS,l=$e.texturesMergerFS;(h=this.postFxShadersManager.createShaderProgram(t,r,l,i,this)).position2_loc=t.getAttribLocation(h.program,"a_pos"),h.uActiveTextures_loc=t.getUniformLocation(h.program,"uActiveTextures"),h.externalAlphasArray_loc=t.getUniformLocation(h.program,"externalAlphasArray"),h.uExternalTexCoordsArray_loc=t.getUniformLocation(h.program,"uExternalTexCoordsArray"),h.uMinMaxAltitudes_loc=t.getUniformLocation(h.program,"uMinMaxAltitudes"),h.tex_0_loc=t.getUniformLocation(h.program,"texture_0"),h.tex_1_loc=t.getUniformLocation(h.program,"texture_1"),h.tex_2_loc=t.getUniformLocation(h.program,"texture_2"),h.tex_3_loc=t.getUniformLocation(h.program,"texture_3"),h.tex_4_loc=t.getUniformLocation(h.program,"texture_4"),h.tex_5_loc=t.getUniformLocation(h.program,"texture_5"),h.tex_6_loc=t.getUniformLocation(h.program,"texture_6"),h.tex_7_loc=t.getUniformLocation(h.program,"texture_7"),this.postFxShadersManager.useProgram(h),t.uniform1i(h.tex_0_loc,0),t.uniform1i(h.tex_1_loc,1),t.uniform1i(h.tex_2_loc,2),t.uniform1i(h.tex_3_loc,3),t.uniform1i(h.tex_4_loc,4),t.uniform1i(h.tex_5_loc,5),t.uniform1i(h.tex_6_loc,6),t.uniform1i(h.tex_7_loc,7)},tt.prototype.isFarestFrustum=function(){return this.numFrustums-this.currentFrustumIdx-1==0},tt.prototype.doMultiFrustumCullingSmartTiles=function(t){var e=this.myCameraSCX.bigFrustum,i=this.smartTileManager.tilesArray[0],r=this.smartTileManager.tilesArray[1];void 0===this.intersectedTilesArray&&(this.intersectedTilesArray=[]),void 0===this.lastIntersectedLowestTilesArray&&(this.lastIntersectedLowestTilesArray=[]),this.lastIntersectedLowestTilesArray=this.intersectedTilesArray,this.intersectedTilesArray=[];for(var o=this.lastIntersectedLowestTilesArray.length,n=0;n<o;n++)(h=this.lastIntersectedLowestTilesArray[n]).isVisible=!1;i.getFrustumIntersectedLowestTiles(t,e,this.intersectedTilesArray,5e3),r.getFrustumIntersectedLowestTiles(t,e,this.intersectedTilesArray,5e3),this.frustumVolumeControl.initArrays();var a=this.myCameraSCX.frustumsArray.length,s=this.intersectedTilesArray.length;for(n=0;n<s;n++)if(void 0!==(h=this.intersectedTilesArray[n]).sphereExtent){this.processQueue.eraseSmartTileToDelete(h),h.isVisible=!0;for(var l=a-1;l>=0;l--){if(this.myCameraSCX.frustumsArray[l].intersectionNearFarSphere(h.sphereExtent)!==u.INTERSECTION_OUTSIDE)this.frustumVolumeControl.getFrustumVolumeCulling(l).intersectedTilesArray.push(h)}}var h;for(o=this.lastIntersectedLowestTilesArray.length,n=0;n<o;n++)(h=this.lastIntersectedLowestTilesArray[n]).isVisible||this.processQueue.putSmartTileToDelete(h,0);this.lastIntersectedLowestTilesArray.length=0,void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready&&this.tinTerrainManager.doFrustumCulling(e,t,this)},tt.prototype.tilesMultiFrustumCullingFinished=function(t,e,i,r){var o=t.length;if(0!==o){var n,a,s,l,h,d=this.magoPolicy;d.getLod5DistInMeters();void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new mt);for(var f=d.getFrustumFarDistance(),g=!1,p=0;p<o;p++)if(void 0!==(a=t[p]).sphereExtent){if(n=i.distToSphere(a.sphereExtent),g=a.intersectionType!==u.INTERSECTION_INSIDE,a.nodesArray&&a.nodesArray.length>0)for(var v=a.nodesArray.length,y=0;y<v;y++){h=(l=a.nodesArray[y]).getRoot();l.data.attributes;if(void 0!==h.data.geoLocDataManager){var m=l.data;if(void 0!==(s=l.data.neoBuilding))if(void 0===s.metaData||s.metaData.fileLoadState===c.fileLoadState.PARSE_FINISHED){n=l.getDistToCamera(i,this.boundingSphere_Aux);var x=d.getLod(n);if(m.distToCam=n,m.currentLod=d.getLod(m.distToCam),!(n>f)){if(g)if(r.intersectionSphere(this.boundingSphere_Aux)===u.INTERSECTION_OUTSIDE)continue;var b=s.getHeaderVersion();if(void 0!==b)if("v"===b[0])e.putNodeByLod(l,x);else{var C=s.metaData.projectDataType;!C||4!==C&&5!==C?e.putNodeByLod(l,x):e.putNodeToArraySortedByDist(e.currentVisiblesAux,l)}}}else e.currentVisiblesToPrepare.push(l);else e.currentVisiblesToPrepare.push(l)}else l.calculateGeoLocData(this)}var A=a.nativeObjects,T=e.currentVisibleNativeObjects;Array.prototype.push.apply(T.opaquesArray,A.opaquesArray),Array.prototype.push.apply(T.transparentsArray,A.transparentsArray),Array.prototype.push.apply(T.excavationsArray,A.excavationsArray),Array.prototype.push.apply(T.vectorTypeArray,A.vectorTypeArray),A.pointTypeArray&&Array.prototype.push.apply(T.pointTypeArray,A.pointTypeArray),a.isNeededToCreateGeometriesFromSeeds()&&a.createGeometriesFromSeeds(this)}}},tt.prototype.flyToTopology=function(t,e){this.isCesiumGlobe()&&this.scene.camera.flyTo({destination:Cesium.Cartesian3.clone(t),orientation:{direction:new Cesium.Cartesian3(this.scene.camera.direction.x,this.scene.camera.direction.y,this.scene.camera.direction.z),up:new Cesium.Cartesian3(this.scene.camera.up.x,this.scene.camera.up.y,this.scene.camera.up.z)},duration:parseInt(e)})},tt.prototype.flyTo=function(t,e,i,r){this.isCesiumGlobe()?this.scene.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(t),parseFloat(e),parseFloat(i)),duration:parseInt(r)}):this.magoWorld.goto(parseFloat(t),parseFloat(e),parseFloat(i),parseInt(r))},tt.prototype.flyToBuilding=function(t,e,i){var r=this.hierarchyManager.getNodeByDataName(e,"nodeId",i);if(void 0!==r){var o,n=r.getRoot(),a=n.data.geoLocDataManager;if(void 0!==a||void 0!==(o=r.calculateGeoLocData(this))){o=(a=n.data.geoLocDataManager).getCurrentGeoLocationData();var s=r.getBBoxCenterPositionWorldCoord(o);if(void 0!==s&&n.data.bbox&&(this.radiusAprox_aux=n.data.bbox.getRadiusAprox(),void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new mt),this.boundingSphere_Aux.radius=this.radiusAprox_aux,this.isCesiumGlobe())){this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s);this.scene.camera.flyToBoundingSphere(this.boundingSphere_Aux,3)}}else apiResultCallback(f.getPolicy().geo_callback_apiresult,t,"-1")}else apiResultCallback(f.getPolicy().geo_callback_apiresult,t,"-1")},tt.prototype.displayLocationAndRotation=function(t){var e=t.nodeOwner.getNodeGeoLocDataManager();if(void 0!==e){var i=e.getCurrentGeoLocationData();i.geographicCoord.latitude,i.geographicCoord.longitude,i.geographicCoord.altitude,i.heading,i.pitch,i.roll,t.buildingId.split("_")}},tt.prototype.selectedObjectNotice=function(t){if(void 0!==t){var e=t.nodeOwner,i=e.getNodeGeoLocDataManager();if(void 0!==i){var r=i.getCurrentGeoLocationData(),o=e.data.nodeId,n=e.data.projectId;if("true"===f.getPolicy().geo_callback_enable){var a=null;void 0!==this.objectSelected&&(a=this.objectSelected.objectId),this.magoPolicy.getObjectInfoViewEnable()&&selectedObjectCallback(f.getPolicy().geo_callback_selectedobject,n,o,a,r.geographicCoord.latitude,r.geographicCoord.longitude,r.geographicCoord.altitude,r.heading,r.pitch,r.roll),this.magoPolicy.getIssueInsertEnable()&&insertIssueCallback(f.getPolicy().geo_callback_insertissue,n,o,a,r.geographicCoord.latitude,r.geographicCoord.longitude,parseFloat(r.geographicCoord.altitude))}}}},tt.prototype.changeLocationAndRotation=function(t,e,i,r,o,n,a,s,l){var h=this.hierarchyManager.getNodeByDataKey(t,e);void 0!==h&&this.changeLocationAndRotationNode(h,i,r,o,n,a,s,l)},tt.prototype.changeLocationAndRotationNode=function(t,e,i,r,o,n,a,s){if(void 0!==t){void 0!==s?(void 0===this.animationManager&&(this.animationManager=new v),this.animationManager.putNode(t),t.changeLocationAndRotationAnimated(e,i,r,o,n,a,this,s)):t.changeLocationAndRotation(e,i,r,o,n,a,this);t.data.neoBuilding}},tt.prototype.getObjectIndexFile=function(t,e){void 0===this.configInformation&&(this.configInformation=f.getPolicy());var i=e,r=this.readerWriter.geometryDataPath+"/"+i+u.OBJECT_INDEX_FILE+u.CACHE_VERSION+(new Date).getTime();this.readerWriter.getObjectIndexFileForSmartTile(r,this,void 0,t)},tt.prototype.getObjectIndexFileForData=function(t,e){void 0===this.configInformation&&(this.configInformation=f.getPolicy());var i=f.getData(c.PROJECT_ID_PREFIX+t),r=this.hierarchyManager.getNodeByDataKey(t,t).data.projectFolderName;r=r.replace(/\/+$/,"");var o=[],n=i.children;if(Array.isArray(e))for(var a=0,s=e.length;a<s;a++){if(!(e[a].attributes||JSON.parse(e[a].metainfo)).isPhysical)throw new Error("f4d member must isPhysical true.");e[a].groupDataFolder=r;var l=e[a].data_key||e[a].dataKey;o.push(l),n.push(e[a])}else{if(!(e.attributes||JSON.parse(e.metainfo)).isPhysical)throw new Error("f4d member must isPhysical true.");e.groupDataFolder=r;l=e.data_key||e.dataKey;o.push(l),n.push(e)}var h=r,d=this.readerWriter.geometryDataPath+"/"+h+u.OBJECT_INDEX_FILE+u.CACHE_VERSION+f.getPolicy().content_cache_version;this.readerWriter.getObjectIndexFileForData(d,this,t,o,e)},tt.prototype.getObjectIndexFileSmartTileF4d=function(t){void 0===this.configInformation&&(this.configInformation=f.getPolicy());var e=t,i=this.readerWriter.geometryDataPath+"/"+e+u.TILE_INDEX_FILE;this.readerWriter.getObjectIndexFileSmartTileF4d(i,e,this)},tt.prototype.makeNode=function(t,e,i,r,o){var n,a,s,l,h,d,c=void 0,u=void 0,f=void 0,g=void 0,p=void 0,v=void 0,m=void 0,x=void 0,b=void 0,C=void 0,A=void 0,T=void 0,M=void 0;if(void 0!==t&&(t.data_key?(f=t.data_group_id,t.data_group_name,g=t.data_id,p=t.data_key,v=t.data_name,m=t.heading,x=t.height,b=t.latitude,C=t.longitude,A=t.pitch,T=t.roll,M=t.mapping_type):(t.childrenCnt=t.children,t.attributes=t.attributes||JSON.parse(t.metainfo),t.children=t.datas,delete t.datas,f=t.dataGroupId,t.dataGroupName,g=t.dataId,p=t.dataKey||t.dataGroupKey,v=t.dataName||t.dataGroupName,m=t.heading,x=t.altitude,b=t.latitude,C=t.longitude,A=t.pitch,T=t.roll,M=t.mappingType||"origin"),c=t.attributes,u=t.children),void 0===m&&(m=0),void 0===A&&(A=0),void 0===T&&(T=0),void 0!==c&&!c.isReference){c.objectType="basicF4d",n=p;var P,w=(s=this.hierarchyManager.newNode(n,o,c)).data,_=c.relativePath;if(r=_&&_.length>0?r+_:r,w.projectFolderName=r,w.projectId=o,w.data_name=v,w.attributes=c,w.mapping_type=M,w.dataId=g,w.dataGroupId=f,c.isPhysical&&(a=i.getBuildingSeed(n))&&(w.buildingSeed=a,e.push(s)),C&&b&&(void 0===x&&(x=0),w.geographicCoord=new j,w.geographicCoord.setLonLatAlt(C,b,x),void 0===w.rotationsDegree&&(w.rotationsDegree=new ur),w.rotationsDegree.set(A,T,m),void 0!==a)){void 0===a.geographicCoord&&(a.geographicCoord=new j),void 0===a.rotationsDegree&&(a.rotationsDegree=new ur),a.geographicCoord.setLonLatAlt(C,b,x),a.rotationsDegree.set(A,T,m),void 0===a.geographicCoordOfBBox&&(a.geographicCoordOfBBox=new j);var S,L=Ei.geographicCoordToWorldPoint(C,b,x,L,this);P=Ei.calculateTransformMatrixAtWorldPosition(L,m,A,T,void 0,P,this),S=a.bBox.getCenterPoint(S);var R=P.transformPoint3D(S,R);a.geographicCoordOfBBox=Ei.pointToGeographicCoord(R,a.geographicCoordOfBBox,this),a.geographicCoordOfBBox.altitude=a.geographicCoord.altitude}if(w.bbox=new y,w.buildingSeed&&w.buildingSeed.bBox&&w.bbox.copyFrom(a.bBox),void 0!==P)if("origin"===w.mapping_type.toLowerCase()){S=w.bbox.getCenterPoint(S);R=P.transformPoint3D(S,R);w.bbox.geographicCoord=Ei.pointToGeographicCoord(R,w.bbox.geographicCoord,this)}else"boundingboxcenter"===w.mapping_type.toLowerCase()&&(w.bbox.geographicCoord=new j,w.bbox.geographicCoord.setLonLatAlt(C,b,x));if(void 0!==u){d=u.length;for(var D=0;D<d;D++)l=u[D],void 0===(h=this.makeNode(l,e,i,r,o)).data.geographicCoord&&s.addChildren(h)}}return s},tt.prototype.calculateBoundingBoxesNodes=function(t){var e,i,r,o,n,a,s,l,h,d=this.hierarchyManager.getNodesMap(t);for(var c in d)if(Object.prototype.hasOwnProperty.call(d,c)){if(void 0===(e=d[c]).data)continue;if(r=e.data.buildingSeed){o=(i=e.getClosestParentWithData("geographicCoord")).data.geographicCoord.longitude,n=i.data.geographicCoord.latitude,a=i.data.geographicCoord.altitude,s=i.data.rotationsDegree.z,l=i.data.rotationsDegree.x,h=i.data.rotationsDegree.y,void 0===r.geographicCoord&&(r.geographicCoord=new j),void 0===r.rotationsDegree&&(r.rotationsDegree=new ur),r.geographicCoord.setLonLatAlt(o,n,a),r.rotationsDegree.set(l,h,s),void 0===r.geographicCoordOfBBox&&(r.geographicCoordOfBBox=new j);var u=Ei.geographicCoordToWorldPoint(o,n,a,u,this),f=Ei.calculateTransformMatrixAtWorldPosition(u,s,l,h,void 0,f,this);r.geographicCoordOfBBox.setLonLatAlt(o,n,a)}}var g=[],p=[];this.hierarchyManager.getRootNodes(t,g);for(var v=!1,y=g.length,m=0;m<y;m++){i=g[m],p.length=0,i.extractNodesByDataName(p,"buildingSeed"),v=!1;for(var x=p.length,b=0;b<x;b++){var C=(e=p[b]).data.bbox;C&&(e.data.attributes?(e.data.attributes.isMain,!1===v?(i.data.bbox.copyFrom(C),v=!0):i.data.bbox.addBox(C)):!1===v?(i.data.bbox.copyFrom(C),v=!0):i.data.bbox.addBox(C))}}},tt.prototype.makeSmartTile=function(t,e,i,r){if(!t&&!r)throw new Error("buildingSeedMap or seedMap is required");var o=i||f.getData(c.PROJECT_ID_PREFIX+e),n=[],a=function(t){var e,i=Array.isArray(t)?t[0]:t;e=i.data_key?i.groupDataFolder||i.data_key:i.dataGroupPath?(e=i.dataGroupPath).replace(/\/+$/,""):i.groupDataFolder;return e}(o);if(Array.isArray(o))for(var s=0,l=o.length;s<l;s++){var h=o[s];this.makeNode(h,n,t,a,e)}else this.makeNode(o,n,t,a,e);this.calculateBoundingBoxesNodes(e);var d=JSON.parse(JSON.stringify(n));this.smartTileManager.makeTreeByDepth(15,n,this),this.emit(tt.EVENT_TYPE.F4DLOADEND,{type:tt.EVENT_TYPE.F4DLOADEND,f4d:d,timestamp:new Date})},tt.prototype.instantiateStaticModel=function(t){if(!Si(t.projectId))throw new Error("projectId is required.");if(!this.isExistStaticModel(t.projectId))throw new Error("static model is not exist.");if(!Si(t.instanceId))throw new Error("instanceId is required.");if(!Si(t.longitude))throw new Error("longitude is required.");if(!Si(t.latitude))throw new Error("latitude is required.");t.isReference||(t.isReference=!0),t.isPhysical||(t.isPhysical=!0),t.nodeType||(t.nodeType="TEST"),t.objectType="basicF4d";var e=t.projectId,i=t.instanceId,r=t.longitude,o=t.latitude,n=parseFloat(_i(t.height,0)),a=parseFloat(_i(t.heading,0)),s=parseFloat(_i(t.pitch,0)),l=parseFloat(_i(t.roll,0)),h=this.hierarchyManager.getNodeByDataKey(e,i);if(void 0===h){h=this.hierarchyManager.newNode(i,e,void 0);var d=new j;d.latitude=parseFloat(o),d.longitude=parseFloat(r),d.altitude=parseFloat(n);var c=d.getGeoLocationDataManager(),u=c.newGeoLocationData("noName");u=Ei.calculateGeoLocationData(d.longitude,d.latitude,d.altitude+1,a,s,l,u,this),h.data.projectId=e,h.data.attributes=t,h.data.geographicCoord=d,h.data.rotationsDegree=new ur(s,l,a),h.data.geoLocDataManager=c;this.smartTileManager.putNode(12,h,this)}else this.changeLocationAndRotation(e,i,o,r,n,a,s,l)},tt.prototype.addStaticModel=function(t){if(!Si(t.projectId))throw new Error("projectId is required.");if(!Si(t.projectFolderName))throw new Error("projectFolderName is required.");if(!Si(t.buildingFolderName))throw new Error("buildingFolderName is required.");var e=t.projectId,i=this.hierarchyManager.getStaticModelsManager(),r=new Dr;r.guid=e,r.projectFolderName=t.projectFolderName,r.buildingFolderName=t.buildingFolderName,r.neoBuilding=new re,i.addStaticModel(e,r)},tt.prototype.isExistStaticModel=function(t){var e=!1;return this.hierarchyManager.staticModelsManager&&this.hierarchyManager.staticModelsManager.staticModelsMap?(this.hierarchyManager.staticModelsManager.staticModelsMap.hasOwnProperty(t)&&(e=!0),e):e},tt.prototype.addLayer=function(t){if(!t)throw new Error("layer is empty");var e;t instanceof Tt?this.tinTerrainManager.addImageryLayer(t):((e=t)instanceof J||e.hasOwnProperty(dataGroupId)&&e.hasOwnProperty(dataGroupKey)&&e.hasOwnProperty(dataGroupPath))&&(this.magoLayerCollection||(this.magoLayerCollection=new $),this.magoLayerCollection.add(t))},tt.prototype.getLayerById=function(t){},tt.prototype.removeLayerById=function(t){this.tinTerrainManager.imagerys=this.tinTerrainManager.imagerys.filter(function(e,i){return e._id!==t}),this.tinTerrainManager.addDeleteTextureId(t)},tt.prototype.removeLayer=function(t){var e;this.tinTerrainManager.imagerys=this.tinTerrainManager.imagerys.filter(function(i,r){return i===t&&(e=i._id),i!==t}),this.tinTerrainManager.addDeleteTextureId(e)},tt.prototype.callAPI=function(t){var e=t.getAPIName();if("changeMagoState"===e)this.magoPolicy.setMagoEnable(t.getMagoEnable());else{if("searchData"===e)return this.flyToBuilding(e,t.getProjectId(),t.getDataKey());if("changeColor"===e)r.changeColor(t,this);else if("show"===e)this.magoPolicy.setHideBuildings.length=0;else if("hide"===e)this.magoPolicy.setHideBuildings(t.gethideBuilds());else if("changeOutFitting"===e)this.magoPolicy.setShowOutFitting(t.getShowOutFitting());else if("changeLabel"===e){this.magoPolicy.setShowLabelInfo(t.getShowLabelInfo());var i=document.getElementById("objectLabel").getContext("2d");i.clearRect(0,0,i.canvas.width,i.canvas.height)}else if("changeOrigin"===e)this.magoPolicy.setShowOrigin(t.getShowOrigin());else if("changeBoundingBox"===e)this.magoPolicy.setShowBoundingBox(t.getShowBoundingBox());else if("changeShadow"===e)this.sceneState.setApplySunShadows(t.getShowShadow());else if("changefrustumFarDistance"===e)this.magoPolicy.setFrustumFarSquaredDistance(t.getFrustumFarDistance()*t.getFrustumFarDistance());else if("changeLocationAndRotation"===e)n.changeLocationAndRotation(t,this);else if("changeObjectMove"===e){var s=t.getObjectMoveMode();s!==c.moveMode.GEOGRAPHICPOINTS&&s!==c.moveMode.NONE||(this.emit(tt.EVENT_TYPE.DESELECTEDF4D,{type:tt.EVENT_TYPE.DESELECTEDF4D}),this.emit(tt.EVENT_TYPE.DESELECTEDF4DOBJECT,{type:tt.EVENT_TYPE.DESELECTEDF4DOBJECT})),this.magoPolicy.setObjectMoveMode(s)}else if("saveObjectMove"===e);else if("deleteAllObjectMove"===e){var l=f.getAllMovingHistory();if(void 0===l)return void f.clearMovingHistory();for(var h in l)if(Object.prototype.hasOwnProperty.call(l,h)){if(void 0===(y=l[Y=h]))continue;for(var d in y)if(Object.prototype.hasOwnProperty.call(y,d)){var u=d;if(void 0===(m=y[d]))continue;for(var g in m)if(Object.prototype.hasOwnProperty.call(m,g)){if(void 0===(At=this.hierarchyManager.getNodeByDataKey(Y,u))||void 0===At.data)continue;if(void 0===(T=At.data.neoBuilding))continue;var p=T.getReferenceObject(g);delete At.data.moveHistoryMap[g],p&&(p.moveVector=void 0,p.moveVectorRelToBuilding=void 0)}}}f.clearMovingHistory()}else if("deleteAllChangeColor"===e){var v=f.getAllColorHistory();if(void 0===v)return void f.clearColorHistory();for(var h in v)if(Object.prototype.hasOwnProperty.call(v,h)){var y;if(void 0===(y=v[Y=h]))continue;for(var d in y)if(Object.prototype.hasOwnProperty.call(y,d)){var m;u=d;if(void 0===(m=y[d]))continue;for(var x in m)if(Object.prototype.hasOwnProperty.call(m,x)){if(void 0===(At=this.hierarchyManager.getNodeByDataKey(Y,u))||void 0===At.data)continue;if(At.data.isColorChanged=!1,At.data.colorChangedHistoryMap=void 0,void 0===(T=At.data.neoBuilding))continue;var b=T.getReferenceObjectsArrayByObjectId(x);if(void 0===b)continue;for(var C=b.length,A=0;A<C;A++){(p=b[A])&&(p.aditionalColor=void 0)}}}}f.clearColorHistory()}else if("changeInsertIssueMode"===e)this.magoPolicy.setIssueInsertEnable(t.getIssueInsertEnable());else if("changeObjectInfoViewMode"===e)this.magoPolicy.setObjectInfoViewEnable(t.getObjectInfoViewEnable());else if("changeNearGeoIssueListViewMode"===e)this.magoPolicy.setNearGeoIssueListEnable(t.getNearGeoIssueListEnable()),t.getNearGeoIssueListEnable()||(this.objMarkerManager.objectMarkerArray=[]);else if("changeOcclusionCulling"===e){var T;this.magoPolicy.setOcclusionCullingEnable(t.getOcclusionCullingEnable()),(T=this.selectionManager.currentBuildingSelected)&&T.setRenderSettingApplyOcclusionCulling(this.magoPolicy.getOcclusionCullingEnable())}else if("drawInsertIssueImage"===e)o.drawInsertIssueImage(t,this);else if("changeInsertIssueState"===e)this.sceneState.insertIssueState=0;else if("changeLod"===e)a.changeLod(t,this);else if("changeLighting"===e){var M=t.getAmbientReflectionCoef(),P=t.getDiffuseReflectionCoef(),w=t.getSpecularReflectionCoef(),_=t.getSpecularColor(),S=t.getAmbientColor();if(isNaN(M)||(this.sceneState.ambientReflectionCoef[0]=Number(M)),isNaN(P)||(this.sceneState.diffuseReflectionCoef[0]=Number(P)),isNaN(w)||(this.sceneState.specularReflectionCoef[0]=Number(w)),_){var L=_.split(",");if(3===L.length){var R=parseInt(L[0])/255,D=parseInt(L[1])/255,E=parseInt(L[2])/255;this.sceneState.specularColor[0]=R,this.sceneState.specularColor[1]=D,this.sceneState.specularColor[2]=E}}if(S){var I=S.split(",");if(3===I.length){var O=parseInt(I[0])/255,F=parseInt(I[1])/255,N=parseInt(I[2])/255;this.sceneState.ambientColor[0]=O,this.sceneState.ambientColor[1]=F,this.sceneState.ambientColor[2]=N}}}else if("changeSsaoRadius"===e){var B=t.getSsaoRadius();this.magoPolicy.setSsaoRadius(B),this.sceneState.ssaoRadius[0]=Number(B)}else if("changeFPVMode"===e)if(t.getFPVMode()){if(void 0!==this.cameraFPV._camera)return;if(this.cameraFPV.init(),this.isCesiumGlobe()){var V=new Cesium.Matrix4,j=new Cesium.Cartesian4,U=this.scene.camera;this.cameraFPV._camera=U,this.cameraFPV._cameraBAK=Cesium.Camera.clone(U,this.cameraFPV._cameraBAK);var k=new Cesium.Cartesian3,G=new Cesium.Cartesian3,z=new Cesium.Cartesian3,H=this.scene.globe.ellipsoid.cartesianToCartographic(U.position);H.height=this.scene.globe.getHeight(H)+1.5,this.scene.globe.ellipsoid.cartographicToCartesian(H,k);var W=Cesium.Transforms.eastNorthUpToFixedFrame(k,Cesium.Ellipsoid.WGS84,V);Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(W,1,j),G),Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(W,2,j),z),U.flyTo({destination:k,orientation:{direction:G,up:z},duration:1})}}else{if(void 0===this.cameraFPV._cameraBAK)return;this.isCesiumGlobe()&&(this.scene.camera=Cesium.Camera.clone(this.cameraFPV._cameraBAK,this.scene.camera)),this.cameraFPV.release()}else if("changePropertyRendering"===e){var X=t.getShowShadow(),Y=t.getProjectId(),K=t.getProperty().split("="),q=K[0],Z=K[1];void 0===this.propertyFilterSC&&(this.propertyFilterSC={}),this.propertyFilterSC.visible=X,this.propertyFilterSC.projectId=Y,this.propertyFilterSC.propertyKey=q,this.propertyFilterSC.propertyValue=Z}else if("drawAppendData"===e)o.drawAppendData(t,this);else if("drawDeleteData"===e)this.deleteAll();else if("clearAllData"===e)this.deleteAll();else{if("getDataInfoByDataKey"===e){Y=t.getProjectId(),u=t.getDataKey();if(void 0===(At=this.hierarchyManager.getNodeByDataKey(Y,u)))return void apiResultCallback(f.getPolicy().geo_callback_apiresult,e,"-1");var Q=At.data.data_name,J=At.data.geoLocDataManager;return void 0===Q||void 0===J?void apiResultCallback(f.getPolicy().geo_callback_apiresult,e,"-1"):void 0===(ot=J.getCurrentGeoLocationData())||void 0===ot.geographicCoord?void apiResultCallback(f.getPolicy().geo_callback_apiresult,e,"-1"):{projectId:Y=At.data.projectId,dataKey:u,dataName:Q,latitude:ot.geographicCoord.latitude,longitude:ot.geographicCoord.longitude,altitude:ot.geographicCoord.altitude,heading:lt=ot.heading,pitch:ht=ot.pitch,roll:dt=ot.roll}}if("gotoProject"===e){Y=t.getProjectId();var $=this.hierarchyManager.getNodesMap(Y);if(0===Object.keys($).length){var et=t.getProjectDataFolder();this.getObjectIndexFile(Y,et)}this.flyTo(t.getLongitude(),t.getLatitude(),t.getElevation(),t.getDuration())}else if("gotoIssue"===e){Y=t.getProjectId();if(!this.hierarchyManager.existProject(Y)){et=t.getProjectDataFolder();this.getObjectIndexFile(Y,et)}this.flyTo(t.getLongitude(),t.getLatitude(),t.getElevation(),t.getDuration()),null!==t.getIssueId()&&void 0!==t.getIssueType()&&o.drawInsertIssueImage(t,this)}else if("gotoFly"===e)this.flyTo(t.getLongitude(),t.getLatitude(),t.getElevation(),t.getDuration());else{if("getCoordinateRelativeToBuilding"===e){Y=t.getProjectId(),u=t.getDataKey();var it=t.getInputPoint(),rt=t.getResultPoint();if(void 0===Y||void 0===u||void 0===it)return;if(void 0===rt&&(rt=new ur),void 0===(At=this.hierarchyManager.getNodeByDataKey(Y,u)))return;if(void 0===(J=At.data.geoLocDataManager))return;return rt=(ot=J.getCurrentGeoLocationData()).worldCoordToLocalCoord(it,rt)}if("getAbsoluteCoodinateOfBuildingPoint"===e){Y=t.getProjectId(),u=t.getDataKey();var ot,nt=t.getInputPoint();rt=t.getResultPoint();if(void 0===Y||void 0===u||void 0===nt)return;if(void 0===rt&&(rt=new ur),void 0===(At=this.hierarchyManager.getNodeByDataKey(Y,u)))return;if(void 0===(J=At.data.geoLocDataManager))return;return rt=(ot=J.getCurrentGeoLocationData()).localCoordToWorldCoord(nt,rt)}if("changeMagoMode"===e)console.log("changeMagoMode");else if("getCameraCurrentPosition"===e){var at=t.getUnit();if(this.isCesiumGlobe()){k=this.scene.camera.position;switch(at){case c.units.METRE:return k;case c.units.RADIAN:return Cesium.Cartographic.fromCartesian(k);case c.units.DEGREE:var st=Cesium.Cartographic.fromCartesian(k);return{lat:Cesium.Math.toDegrees(st.latitude),lon:Cesium.Math.toDegrees(st.longitude),alt:st.height}}}}else if("getCameraCurrentOrientaion"===e){if(this.isCesiumGlobe()){if(!(U=this.scene.camera))throw new Error("Camera is broken.");return{heading:Cesium.Math.toDegrees(U.heading),pitch:Cesium.Math.toDegrees(U.pitch),roll:Cesium.Math.toDegrees(U.roll)}}}else if("changeCameraOrientation"===e){U=this.scene.camera;var lt=_i(t.getHeading(),Cesium.Math.toDegrees(U.heading)),ht=_i(t.getPitch(),Cesium.Math.toDegrees(U.pitch)),dt=_i(t.getRoll(),Cesium.Math.toDegrees(U.roll)),ct=_i(t.getDuration(),0);if(this.isCesiumGlobe()){if(!(U=this.scene.camera))throw new Error("Camera is broken.");U.flyTo({destination:U.positionWC,orientation:{heading:Cesium.Math.toRadians(lt),pitch:Cesium.Math.toRadians(ht),roll:Cesium.Math.toRadians(dt)},duration:parseInt(ct)})}}else if("instantiateStaticModel"===e){var ut=t.getInstantiateObj();this.instantiateStaticModel(ut)}else if("addStaticModel"===e){var ft=t.getStaticModelAttributeObj();this.addStaticModel(ft)}else if("setTrackNode"===e){if(!Si(At=this.hierarchyManager.getNodeByDataKey(t.getProjectId(),t.getDataKey())))throw new Error("This node is not exist.");if(At.isReadyToRender()){var gt=(J=At.getNodeGeoLocDataManager()).getCurrentGeoLocationData().getGeographicCoords(),pt=gt.longitude,vt=gt.latitude;this.flyTo(pt,vt,400,0),(U=this.sceneState.camera).stopTrack(this),U.setTrack(At,t.getTrackOption())}}else if("stopTrack"===e)this.sceneState.camera.stopTrack(this);else{if("isExistStaticModel"===e)return this.isExistStaticModel(t.getProjectId());if("isExistData"===e){Y=t.getProjectId(),u=t.getDataKey();if(!Si(Y))throw new Error("projectId is required.");if(!Si(u))throw new Error("dataKey is required.");return void 0!==(At=this.hierarchyManager.getNodeByDataKey(Y,u))}if("isDataReadyToRender"===e){Y=t.getProjectId(),u=t.getDataKey();if(!Si(Y))throw new Error("projectId is required.");if(!Si(u))throw new Error("dataKey is required.");return!(void 0===(At=this.hierarchyManager.getNodeByDataKey(Y,u))||!At.isReadyToRender())}if("setNodeAttribute"===e){Y=t.getProjectId(),u=t.getDataKey(),ft=t.getNodeAttribute();if(!Si(Y))throw new Error("projectId is required.");if(!Si(u))throw new Error("dataKey is required.");if(void 0!==(At=this.hierarchyManager.getNodeByDataKey(Y,u))&&At.data){var yt=At.data;yt.attributes||(yt.attributes={});var mt=yt.attributes;for(var xt in ft)ft.hasOwnProperty(xt)&&(mt[xt]=ft[xt])}return!1}if("togglePointCloudColor"===e){var bt=this._settings.getRenderingSettings(),Ct=bt.getPointsCloudInColorRamp();bt.setPointsCloudInColorRamp(!Ct)}else if("selectF4d"===e){var At;Y=t.getProjectId(),u=t.getDataKey();if(!Si(Y))throw new Error("projectId is required.");if(!Si(u))throw new Error("dataKey is required.");if(!(At=this.hierarchyManager.getNodeByDataKey(Y,u)))throw new Error("f4d is not exist.");this.magoPolicy.setObjectMoveMode(c.moveMode.ALL),this.nodeSelected=At,this.buildingSelected=At.data.neoBuilding,this.rootNodeSelected=this.nodeSelected.getRoot(),this.selectionManager.currentBuildingSelected=this.buildingSelected,this.selectionManager.currentNodeSelected=this.nodeSelected,this.emit(tt.EVENT_TYPE.SELECTEDF4D,{type:tt.EVENT_TYPE.SELECTEDF4D,f4d:At,timestamp:new Date})}}}}}},tt.prototype.deleteAll=function(){this.selectionManager.clearCandidates(),this.selectionManager.clearCurrents(),this.objectSelected=void 0,this.octreeSelected=void 0,this.buildingSelected=void 0,this.nodeSelected=void 0,this.parseQueue.clearAll(),this.processQueue.clearAll(),this.visibleObjControlerBuildings&&this.visibleObjControlerBuildings.clear(),this.visibleObjControlerNodes&&this.visibleObjControlerNodes.clear(),this.visibleObjControlerOctrees&&this.visibleObjControlerOctrees.clear(),this.smartTileManager.resetTiles(),this.hierarchyManager.deleteNodes(this.sceneState.gl,this.vboMemoryManager)},tt.prototype.checkCollision=function(t,e){var i=this.sceneState.gl;if(void 0!==i){var r=.5*this.sceneState.drawingBufferWidth,o=.5*this.sceneState.drawingBufferHeight;if(void 0!==this.getSelectedObjects(i,r,o,this.arrayAuxSC)){var n=this.buildingSelected;this.buildingSelected=this.arrayAuxSC[0];var a=new ur,s=new ur;Ei.calculatePixelPositionWorldCoord(i,r,o,a,void 0,void 0,void 0,this),this.swapRenderingFase(),Ei.calculatePixelPositionWorldCoord(i,r,this.sceneState.drawingBufferHeight,void 0,void 0,void 0,this),this.buildingSelected=n;var l=a.squareDistTo(t.x,t.y,t.z);if(this.swapRenderingFase(),l>3.5){var h=this.scene.globe.ellipsoid.cartesianToCartographic(s),d=this.scene.globe.ellipsoid.cartesianToCartographic(t),c=d.height,u=h.height+1.5;u<c&&(c-=.2),(u>c||u<c&&c-u>1.5)&&(c=u);var f=Cesium.Math.toDegrees(d.latitude),g=Cesium.Math.toDegrees(d.longitude);return this.cameraFPV.camera.position=Cesium.Cartesian3.fromDegrees(g,f,c),!1}return!0}}};var et=function(t){if(!(this instanceof et))throw new Error(ot.CONSTRUCT_ERROR);if(Ri(t.dataId))throw new Error(ot.REQUIRED_EMPTY_ERROR("dataId"));if(Ri(t.dataKey))throw new Error(ot.REQUIRED_EMPTY_ERROR("dataKey"));if(Ri(t.dataGroupId))throw new Error(ot.REQUIRED_EMPTY_ERROR("dataGroupId"));if(Ri(t.longitude)||Ri(t.latitude))throw new Error(ot.REQUIRED_EMPTY_ERROR("longitude","latitude"));this.ready=!1,this.id=t.dataId,this.layerId=t.dataGroupId,this.layerKey=t.dataGroupKey,this.key=t.dataKey,this.name=t.dataName,this.dataType=t.dataType,this.mappingType=wi(t.mappingType,et.MAPPING_TYPE.ORIGIN),this.reference=wi(t.reference,!1),this.geographicCoord=new j(t.longitude,t.latitude,wi(t.altitude,0)),this.rotationsDegree=new ur(wi(t.pitch,0),wi(t.roll,0),wi(t.heading,0)),this.bbox=new y,this.style=Object.assign({},et.DEFAULT_STYLE,t.style||{}),this._buildingSeed};Object.defineProperties(et.prototype,{buildingSeed:{get:function(){return this._buildingSeed},set:function(t){t instanceof x&&(this._buildingSeed=t,void 0===this._buildingSeed.geographicCoord&&(this._buildingSeed.geographicCoord=new j),void 0===this._buildingSeed.rotationsDegree&&(this._buildingSeed.rotationsDegree=new ur),void 0===this._buildingSeed.geographicCoordOfBBox&&(this._buildingSeed.geographicCoordOfBBox=new j),this._calculate(),this.ready=!0)}}}),et.prototype._calculate=function(){var t=this.geographicCoord.longitude,e=this.geographicCoord.latitude,i=this.geographicCoord.altitude;this.buildingSeed.geographicCoord.setLonLatAlt(t,e,i),this.buildingSeed.rotationsDegree.set(this.rotationsDegree.x,this.rotationsDegree.y,this.rotationsDegree.z);var r=this.getTmatrix(),o=this.buildingSeed.bBox.getCenterPoint(o),n=r.transformPoint3D(o,n);if(this.buildingSeed.geographicCoordOfBBox=Ei.pointToGeographicCoord(n,this.buildingSeed.geographicCoordOfBBox),this.buildingSeed.geographicCoordOfBBox.altitude=this.buildingSeed.geographicCoord.altitude,this.bbox.copyFrom(this.buildingSeed.bBox),void 0!==r)switch(this.mappingType.toLowerCase()){case et.MAPPING_TYPE.BOUNDINGBOXCENTER:this.bbox.geographicCoord=new j,this.bbox.geographicCoord.setLonLatAlt(t,e,height);break;case et.MAPPING_TYPE.ORIGIN:default:o=this.bbox.getCenterPoint(o);n=r.transformPoint3D(o,n);this.bbox.geographicCoord=Ei.pointToGeographicCoord(n,this.bbox.geographicCoord)}},et.prototype.getTmatrix=function(){var t=this.geographicCoord,e=this.rotationsDegree,i=Ei.geographicCoordToWorldPoint(t.longitude,t.latitude,t.altitude,i);return Ei.calculateTransformMatrixAtWorldPosition(i,e.heading,e.pitch,e.roll,void 0)},et.DEFAULT_STYLE={visible:!0},et.MAPPING_TYPE={ORIGIN:"origin",BOUNDINGBOXCENTER:"boundingboxcenter"};var it=function(t,e,i,r,o,n,a,s){if(!(this instanceof it))throw new Error(ot.CONSTRUCT_ERROR);var l=null,d=null,g=c.magoManagerState.INIT,p=s||{};function v(){l.handler.setInputAction(function(t){l.mouseActionLeftDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.LEFT_DOWN),l.handler.setInputAction(function(t){l.mouseActionMiddleDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),l.handler.setInputAction(function(t){l.mouseActionRightDown(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.RIGHT_DOWN),l.handler.setInputAction(function(e){var i;l.mouseLeftDown?e.startPosition.x===e.endPosition.x&&e.startPosition.y===e.endPosition.y||(l.manageMouseDragging(e.startPosition.x,e.startPosition.y),l.cameraMoved()):(l.mouseDragging=!1,i=!0,t.scene.screenSpaceCameraController.enableRotate=i,t.scene.screenSpaceCameraController.enableZoom=i,t.scene.screenSpaceCameraController.enableLook=i,t.scene.screenSpaceCameraController.enableTilt=i,t.scene.screenSpaceCameraController.enableTranslate=i,(l.mouseMiddleDown||l.mouseRightDown)&&(l.isCameraMoving=!0,l.cameraMoved()))},Cesium.ScreenSpaceEventType.MOUSE_MOVE),l.handler.setInputAction(function(t){l.mouseActionLeftUp(t.position.x,t.position.y);var e={lat:null,lon:null,alt:null},r=l.scene.camera.pickEllipsoid(t.position);if(r){var o=Cesium.Cartographic.fromCartesian(r);e.lat=Cesium.Math.toDegrees(o.latitude),e.lon=Cesium.Math.toDegrees(o.longitude),e.alt=o.height}"true"===f.getPolicy().geo_callback_enable&&""!==i.geo_callback_clickposition&&clickPositionCallback(i.geo_callback_clickposition,e)},Cesium.ScreenSpaceEventType.LEFT_UP),l.handler.setInputAction(function(t){l.mouseActionMiddleUp(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_UP),l.handler.setInputAction(function(t){l.mouseActionRightUp(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.RIGHT_UP),l.handler.setInputAction(function(t){l.mouseActionLeftClick(t.position.x,t.position.y)},Cesium.ScreenSpaceEventType.LEFT_CLICK)}function y(){var e,a;f.getPolicy().basicGlobe===u.CESIUM?function(){var e=t.scene.context._gl;if(t.scene.magoManager.postFxShadersManager.gl=e,t.scene.magoManager.postFxShadersManager.createDefaultShaders(e),t.scene.magoManager.createDefaultShaders(e),t.scene.magoManager.scene=t.scene,l=t.scene.magoManager,d=t.scene,t.scene.globe.depthTestAgainstTerrain=!0,t.scene.logarithmicDepthBuffer=!1,t.scene.highDynamicRange=!1,null!==r&&r.length>0)for(var a=0;a<r.length;a++){var s=n[a],h=o[a];h.data_key===s&&h.attributes.isReference||t.scene.magoManager.getObjectIndexFile(r[a],s)}i.geo_tile_path&&""!==i.geo_tile_path&&t.scene.magoManager.getObjectIndexFileSmartTileF4d(i.geo_tile_path),t.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(d.canvas),v(),t.clock.onTick.addEventListener(function(t){l.cameraFPV.update(l)}),t.camera.changed.addEventListener(function(t){l.cameraChanged(t)}),t.camera.moveEnd.addEventListener(function(t){l.cameraMoveEnd(t)}),t.camera.moveStart.addEventListener(function(t){l.cameraMoveStart(t)})}():f.getPolicy().basicGlobe===u.MAGOWORLD&&(e=t.magoManager.sceneState.gl,(a=t.magoManager).vboMemoryManager.gl=e,a.postFxShadersManager.gl=e,a.postFxShadersManager.createDefaultShaders(e),a.createDefaultShaders(e))}p.animation=p.animation||!1,p.timeline=p.timeline||!1,f.init(i,r,o);var m,x,b="ESRI World Imagery",C="WGS84 Ellipsoid";if(null===i.basicGlobe||""===i.basicGlobe||i.basicGlobe===u.CESIUM){if((T=document.getElementById(e)).addEventListener("webglcontextlost",function(t){console.log(t)},!1),T.addEventListener("webglcontextrestored",function(t){console.log(t)},!1),"true"===i.geo_server_enable&&null!==i.geo_server_url&&""!==i.geo_server_url){var A=new Cesium.WebMapServiceImageryProvider({url:i.geo_server_url,layers:i.geo_server_layers,parameters:{service:i.geo_server_parameters_service,version:i.geo_server_parameters_version,request:i.geo_server_parameters_request,transparent:i.geo_server_parameters_transparent,format:i.geo_server_parameters_format},enablePickFeatures:!1});p.imageryProvider=A,p.baseLayerPicker=!1,p.antialias=!0,null===t&&(t=new Cesium.Viewer(e,p))}else null!==i.cesiumIonToken&&""!==i.cesiumIonToken&&(Cesium.Ion.defaultAccessToken=i.cesiumIonToken,C="Cesium World Terrain"),p.shouldAnimate=!0,null===t&&(t=new Cesium.Viewer(e,p)),function(){if(null!==f.getPolicy().initDefaultTerrain&&""!==f.getPolicy().initDefaultTerrain&&(C=f.getPolicy().initDefaultTerrain),void 0!==t&&void 0!==t.baseLayerPicker){var e=null,i=t.baseLayerPicker.viewModel.imageryProviderViewModels;for(var r in i)if(i.hasOwnProperty(r)&&(a=i[r]).name===b){e=a;break}e&&(t.baseLayerPicker.viewModel.selectedImagery=e);var o=null,n=t.baseLayerPicker.viewModel.terrainProviderViewModels;for(var r in n){var a;if(n.hasOwnProperty(r)&&(a=n[r]).name===C){o=a;break}}o&&(t.baseLayerPicker.viewModel.selectedTerrain=o)}}();t.scene.magoManager=new tt,t.scene.magoManager.sceneState.textureFlipYAxis=!1,t.camera.frustum.fov=1.8*Cesium.Math.PI_OVER_THREE,f.getPolicy().initDefaultFov>0&&(t.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*f.getPolicy().initDefaultFov),"true"===i.geo_server_enable&&null!==i.geo_server_add_url&&""!==i.geo_server_add_url&&(x=new Cesium.WebMapServiceImageryProvider({url:f.getPolicy().geo_server_add_url,layers:f.getPolicy().geo_server_add_layers,parameters:{service:f.getPolicy().geo_server_add_parameters_service,version:f.getPolicy().geo_server_add_parameters_version,request:f.getPolicy().geo_server_add_parameters_request,transparent:f.getPolicy().geo_server_add_parameters_transparent,format:f.getPolicy().geo_server_add_parameters_format}}),t.imageryLayers.addImageryProvider(x)),y(),t.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}}),i.initCameraEnable&&t.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(f.getPolicy().initLatitude),parseFloat(f.getPolicy().initLongitude),parseFloat(f.getPolicy().initHeight)),duration:parseInt(f.getPolicy().initDuration)}),m=new h("renderMode"),l.callAPI(m)}else if(i.geo_view_library===u.MAGOWORLD){var T,M={antialias:!0,stencil:!0,premultipliedAlpha:!1},P=(T=document.getElementById(e)).getContext("webgl",M);P||(P=T.getContext("experimental-webgl",M)),T.width=T.clientWidth,T.height=T.clientHeight;var w=(l=new tt).sceneState;w.textureFlipYAxis=!1,w.gl=P,w.drawingBufferWidth[0]=T.clientWidth,w.drawingBufferHeight[0]=T.clientHeight,w.camera.frustum.aspectRatio[0]=T.clientWidth/T.clientHeight,w.camera.frustum.fovRad[0]=Math.PI/3*1.8,w.camera.frustum.fovyRad[0]=w.camera.frustum.fovRad[0]/w.camera.frustum.aspectRatio,w.camera.frustum.tangentOfHalfFovy[0]=Math.tan(w.camera.frustum.fovyRad[0]/2),w.camera.position.set(-7586937.743019165,10881859.054284709,5648264.99911627),w.camera.direction.set(.5307589970384617,-.7598419113077192,-.3754132585133587),w.camera.up.set(.23477224008249162,-.29380469331271475,.9265855321012102),w.encodedCamPosHigh[0]=-7536640,w.encodedCamPosHigh[1]=10878976,w.encodedCamPosHigh[2]=5636096,w.encodedCamPosLow[0]=-50297.7421875,w.encodedCamPosLow[1]=2883.05419921875,w.encodedCamPosLow[2]=12168.9990234375,t=new tr(l),l.magoWorld=t,l.globe=new W,t.updateModelViewMatrixByCamera(w.camera),l.tinTerrainManager=new ye,T.addEventListener("mousedown",function(e){t.mousedown(e)},!1),T.addEventListener("mouseup",function(e){t.mouseup(e)},!1),T.addEventListener("mousewheel",function(e){t.mousewheel(e)},!1),T.addEventListener("mousemove",function(e){t.mousemove(e)},!1),T.addEventListener("click",function(e){t.mouseclick(e)},!1),T.addEventListener("resize",function(t){console.log("resize")},!1),T.addEventListener("keydown",function(e){t.keydown(e)},!1),y()}return l.magoPolicy.imagePath=a,g=c.magoManagerState.READY,document.addEventListener("keydown",function(t){if(!l.magoPolicy.issueInsertEnable&&(l.keyDown(t.keyCode),void 0!==l.buildingSelected)){var e=l.selectionManager.currentNodeSelected;if(void 0!==e){var i=e.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==i&&l.magoPolicy.objectMoveMode===c.moveMode.ALL){var r=i.heading||0,o=i.pitch||0,n=i.roll||0,a=i.geographicCoord.altitude||0,s=!1;t.keyCode==="Q".charCodeAt(0)?(r+=3,s=!0):t.keyCode==="A".charCodeAt(0)&&(r-=3,s=!0),t.keyCode==="W".charCodeAt(0)?(o+=3,s=!0):t.keyCode==="S".charCodeAt(0)&&(o-=3,s=!0),t.keyCode==="E".charCodeAt(0)?(n+=3,s=!0):t.keyCode==="D".charCodeAt(0)&&(n-=3,s=!0),t.keyCode==="Z".charCodeAt(0)?(a+=.2,s=!0):t.keyCode==="X".charCodeAt(0)&&(a-=.2,s=!0),s&&l.changeLocationAndRotationNode(e,i.geographicCoord.latitude,i.geographicCoord.longitude,a,r,o,n)}}}},!1),{callAPI:function(t){if(t.getReturnable())return l.callAPI(t);l.callAPI(t)},getViewer:function(){return t},getMagoManagerState:function(){return g},getMagoManager:function(){return l}}},rt=function(){if(!(this instanceof rt))throw new Error(ot.CONSTRUCT_ERROR);this._floatArrays=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.dirty=!0};rt.prototype.Identity=function(){this._floatArrays[0]=1,this._floatArrays[1]=0,this._floatArrays[2]=0,this._floatArrays[3]=0,this._floatArrays[4]=0,this._floatArrays[5]=1,this._floatArrays[6]=0,this._floatArrays[7]=0,this._floatArrays[8]=0,this._floatArrays[9]=0,this._floatArrays[10]=1,this._floatArrays[11]=0,this._floatArrays[12]=0,this._floatArrays[13]=0,this._floatArrays[14]=0,this._floatArrays[15]=1},rt.prototype.deleteObjects=function(){this._floatArrays=void 0},rt.prototype.getRowMajorMatrix=function(){var t=new Float32Array(16);return t[0]=this.get(0,0),t[1]=this.get(1,0),t[2]=this.get(2,0),t[3]=this.get(3,0),t[4]=this.get(0,1),t[5]=this.get(1,1),t[6]=this.get(2,1),t[7]=this.get(3,1),t[8]=this.get(0,2),t[9]=this.get(1,2),t[10]=this.get(2,2),t[11]=this.get(3,2),t[12]=this.get(0,3),t[13]=this.get(1,3),t[14]=this.get(2,3),t[15]=this.get(3,3),t},rt.prototype.getXAxis=function(t){return void 0===t&&(t=new ur),t.set(this._floatArrays[0],this._floatArrays[1],this._floatArrays[2]),t},rt.prototype.getYAxis=function(t){return void 0===t&&(t=new ur),t.set(this._floatArrays[4],this._floatArrays[5],this._floatArrays[6]),t},rt.prototype.getZAxis=function(t){return void 0===t&&(t=new ur),t.set(this._floatArrays[8],this._floatArrays[9],this._floatArrays[10]),t},rt.getRotationDegZXYMatrix=function(t,e,i,r){void 0===r&&(r=new rt);var o,n,a,s=new rt,l=new rt,h=new rt;return void 0!==e&&0!==e&&s.rotationAxisAngDeg(e,1,0,0),void 0!==i&&0!==i&&l.rotationAxisAngDeg(i,0,1,0),void 0!==t&&0!==t&&h.rotationAxisAngDeg(t,0,0,1),o=h,n=s.getMultipliedByMatrix(o,n),r=a=l.getMultipliedByMatrix(n,a)},rt.prototype.rotationAxisAngDeg=function(t,e,i,r){var o=new ft;o.rotationAngDeg(t,e,i,r),this.rotationByQuaternion(o),o=void 0},rt.prototype.rotationAxisAngRad=function(t,e,i,r){var o=new ft;o.rotationAngRad(t,e,i,r),this.rotationByQuaternion(o),o=void 0},rt.prototype.rotationByQuaternion=function(t){var e=t.x,i=t.y,r=t.z,o=t.w;this._floatArrays[this.getIndexOfArray(0,0)]=1-2*i*i-2*r*r,this._floatArrays[this.getIndexOfArray(0,1)]=2*e*i+2*r*o,this._floatArrays[this.getIndexOfArray(0,2)]=2*e*r-2*i*o,this._floatArrays[this.getIndexOfArray(0,3)]=0,this._floatArrays[this.getIndexOfArray(1,0)]=2*e*i-2*r*o,this._floatArrays[this.getIndexOfArray(1,1)]=1-2*e*e-2*r*r,this._floatArrays[this.getIndexOfArray(1,2)]=2*i*r+2*e*o,this._floatArrays[this.getIndexOfArray(1,3)]=0,this._floatArrays[this.getIndexOfArray(2,0)]=2*e*r+2*i*o,this._floatArrays[this.getIndexOfArray(2,1)]=2*i*r-2*e*o,this._floatArrays[this.getIndexOfArray(2,2)]=1-2*e*e-2*i*i,this._floatArrays[this.getIndexOfArray(2,3)]=0,this._floatArrays[this.getIndexOfArray(3,0)]=0,this._floatArrays[this.getIndexOfArray(3,1)]=0,this._floatArrays[this.getIndexOfArray(3,2)]=0,this._floatArrays[this.getIndexOfArray(3,3)]=1},rt.prototype.setByFloat32Array=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t[e]},rt.prototype.getIndexOfArray=function(t,e){return 4*(t||0)+(e||0)},rt.prototype.get=function(t,e){return this._floatArrays[this.getIndexOfArray(t,e)]},rt.prototype.setTranslation=function(t,e,i){this.set(3,0,t),this.set(3,1,e),this.set(3,2,i)},rt.prototype.set=function(t,e,i){this._floatArrays[this.getIndexOfArray(t,e)]=i},rt.prototype.getInverse=function(t){return void 0===t&&(t=new rt),t._floatArrays=glMatrix.mat4.invert(t._floatArrays,this._floatArrays),t},rt.prototype.transformPoint3D=function(t,e){if(!t)return e;void 0===e&&(e=new ur);var i=t.x,r=t.y,o=t.z;return e.x=i*this.get(0,0)+r*this.get(1,0)+o*this.get(2,0)+this.get(3,0),e.y=i*this.get(0,1)+r*this.get(1,1)+o*this.get(2,1)+this.get(3,1),e.z=i*this.get(0,2)+r*this.get(1,2)+o*this.get(2,2)+this.get(3,2),e},rt.prototype.transformPoint4D__test=function(t,e){void 0===e&&(e=new ur);var i=t[0],r=t[1],o=t[2],n=t[3];return e[0]=i*this.get(0,0)+r*this.get(1,0)+o*this.get(2,0)+n*this.get(3,0),e[1]=i*this.get(0,1)+r*this.get(1,1)+o*this.get(2,1)+n*this.get(3,1),e[2]=i*this.get(0,2)+r*this.get(1,2)+o*this.get(2,2)+n*this.get(3,2),e[3]=i*this.get(0,3)+r*this.get(1,3)+o*this.get(2,3)+n*this.get(3,3),e},rt.prototype.rotateXYZDataArray=function(t,e){if(void 0===t)return e;var i,r,o;void 0===e&&(e=[]);for(var n=t.length/3,a=0;a<n;a++)i=t[3*a],r=t[3*a+1],o=t[3*a+2],e[3*a]=i*this.get(0,0)+r*this.get(1,0)+o*this.get(2,0),e[3*a+1]=i*this.get(0,1)+r*this.get(1,1)+o*this.get(2,1),e[3*a+2]=i*this.get(0,2)+r*this.get(1,2)+o*this.get(2,2);return e},rt.prototype.rotatePoint3D=function(t,e){void 0===e&&(e=new ur);var i=t.x,r=t.y,o=t.z;return e.x=i*this.get(0,0)+r*this.get(1,0)+o*this.get(2,0),e.y=i*this.get(0,1)+r*this.get(1,1)+o*this.get(2,1),e.z=i*this.get(0,2)+r*this.get(1,2)+o*this.get(2,2),e},rt.lookAt=function(t,e,i,r){var o=void 0,n=void 0,a=void 0,s=void 0,l=void 0,h=void 0,d=void 0,c=void 0,u=void 0,f=void 0,g=e[0],p=e[1],v=e[2],y=r[0],m=r[1],x=r[2],b=i[0],C=i[1],A=i[2];return Math.abs(g-b)<glMatrix.EPSILON&&Math.abs(p-C)<glMatrix.EPSILON&&Math.abs(v-A)<glMatrix.EPSILON?glMatrix.mat4.identity(t):(d=g-b,c=p-C,u=v-A,o=m*(u*=f=1/Math.sqrt(d*d+c*c+u*u))-x*(c*=f),n=x*(d*=f)-y*u,a=y*c-m*d,(f=Math.sqrt(o*o+n*n+a*a))?(o*=f=1/f,n*=f,a*=f):(o=0,n=0,a=0),s=c*a-u*n,l=u*o-d*a,h=d*n-c*o,(f=Math.sqrt(s*s+l*l+h*h))?(s*=f=1/f,l*=f,h*=f):(s=0,l=0,h=0),t[0]=o,t[1]=s,t[2]=d,t[3]=0,t[4]=n,t[5]=l,t[6]=c,t[7]=0,t[8]=a,t[9]=h,t[10]=u,t[11]=0,t[12]=-(o*g+n*p+a*v),t[13]=-(s*g+l*p+h*v),t[14]=-(d*g+c*p+u*v),t[15]=1,t)},rt.prototype.getMultipliedByMatrix=function(t,e){void 0===e&&(e=new rt);for(var i=0;i<4;i++)for(var r=0;r<4;r++){var o=this.getIndexOfArray(i,r);e._floatArrays[o]=0;for(var n=0;n<4;n++)e._floatArrays[o]+=t.get(n,r)*this.get(i,n)}return e},rt.prototype.setToPerspectiveProjection=function(t,e,i,r){var o=1/Math.tan(t/2),n=o/e,a=i-r;this.setByFloat32Array([n,0,0,0,0,o,0,0,0,0,(r+i)/a,-1,0,0,2*r*i/a,0])},rt.prototype.copyFromMatrix4=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t._floatArrays[e]},rt.prototype.copyFromFloatArray=function(t){for(var e=0;e<16;e++)this._floatArrays[e]=t[e]},rt.prototype.computeMatrixType=function(){return this.isRotationIdentity()?this.aproxEqual(this._floatArrays[3],0,1e-7)&&this.aproxEqual(this._floatArrays[7],0,1e-7)&&this.aproxEqual(this._floatArrays[11],0,1e-7)&&this.aproxEqual(this._floatArrays[12],0,1e-7)&&this.aproxEqual(this._floatArrays[13],0,1e-7)&&this.aproxEqual(this._floatArrays[14],0,1e-7)&&this.aproxEqual(this._floatArrays[15],1,1e-7)?0:1:2},rt.prototype.aproxEqual=function(t,e,i){return void 0===i&&(i=1e-7),t===e||t>e-i&&t<e+i},rt.perspective=function(t,e,i,r){var o=Math.tan(.5*Math.PI-.5*t),n=1/(i-r);return[o/e,0,0,0,0,o,0,0,0,0,(i+r)*n,-1,0,0,i*r*n*2,0]},rt.areEqualArrays=function(t,e){for(var i=!0,r=0;i&&r<16;)t[r]!==e[r]&&(i=!1),r++;return i},rt.copyArray=function(t,e){for(var i=0;i<16;i++)e[i]=t[i]},rt.prototype.isNAN=function(){for(var t=0;t<16;t++)if(isNaN(this._floatArrays[t]))return!0;return!1},rt.prototype.isRotationIdentity=function(t){return!!this.aproxEqual(this._floatArrays[0],1,t)&&(!!this.aproxEqual(this._floatArrays[1],0,t)&&(!!this.aproxEqual(this._floatArrays[2],0,t)&&(!!this.aproxEqual(this._floatArrays[4],0,t)&&(!!this.aproxEqual(this._floatArrays[5],1,t)&&(!!this.aproxEqual(this._floatArrays[6],0,t)&&(!!this.aproxEqual(this._floatArrays[8],0,t)&&(!!this.aproxEqual(this._floatArrays[9],0,t)&&!!this.aproxEqual(this._floatArrays[10],1,t))))))))};var ot={CONSTRUCT_ERROR:"  new   .",REQUIRED_EMPTY_ERROR:function(...t){return t.join(",")+"   ."}},nt=function(){if(!(this instanceof nt))throw new Error(ot.CONSTRUCT_ERROR);this.strX,this.strY,this.strLinealDepth,this.strCamCoordPoint,this.strWorldPoint,this.strModelViewMatrix=new rt,this.strModelViewMatrixInv=new rt,this.strCamera=new A,this.strCameraTarget=new Float32Array([0,0,0]),this.curX,this.curY,this.camRotPoint=new ur,this.camRotAxis=new ur,this.strTime,this.strWorldPointAux,this.strLocationAux};nt.prototype.clearStartPositionsAux=function(){this.strWorldPointAux&&this.strWorldPointAux.deleteObjects(),this.strWorldPointAux=void 0,this.strLocationAux&&this.strLocationAux.deleteObjects(),this.strLocationAux=void 0},nt.prototype.claculateStartPositionsAux=function(t){var e=1e8*this.strLinealDepth;t.resultRaySC=t.getRayCamSpace(this.strX,this.strY,t.resultRaySC);var i=new ur;i.set(t.resultRaySC[0]*e,t.resultRaySC[1]*e,t.resultRaySC[2]*e),this.strWorldPointAux=t.cameraCoordPositionToWorldCoord(i,this.strWorldPointAux),this.strLocationAux=Ei.pointToGeographicCoord(this.strWorldPointAux,void 0,t)},nt.prototype.saveCurrentToStart=function(){this.strX=this.curX,this.strY=this.curY,void 0===this.strWorldPoint&&(this.strWorldPoint=new ur),this.curWorldPoint&&this.strWorldPoint.copyFrom(this.curWorldPoint),void 0===this.strCamCoordPoint&&(this.strCamCoordPoint=new ur),this.curCamCoordPoint&&this.strCamCoordPoint.copyFrom(this.curCamCoordPoint)},nt.prototype.getStartWorldPoint=function(){return this.strWorldPoint};var at=function(t){if(!(this instanceof at))throw new Error(ot.CONSTRUCT_ERROR);this.movementType=c.movementType.NO_MOVEMENT,this.deltaTime,this.currLinearVelocity,this.translationDir,this.currAngularVelocity,this.rotationAxis,this.xAngVelocity,this.zAngVelocity,this.rotationPoint,t&&(void 0!==t.movementType&&(this.movementType=t.movementType),void 0!==t.linearVelocity&&(this.currLinearVelocity=t.linearVelocity),void 0!==t.translationDir&&(this.translationDir=t.translationDirection),void 0!==t.angularVelocity&&(this.currAngularVelocity=t.angularVelocity),void 0!==t.rotationAxis&&(this.rotationAxis=t.rotationAxis),void 0!==t.rotationPoint&&(this.rotationPoint=t.rotationPoint))},st=function(){if(!(this instanceof st))throw new Error(ot.CONSTRUCT_ERROR);this.id,this.geoLocationData=new z,this.issue_id=null,this.issue_type=null,this.target,this.imageFilePath,this.size2d=new Float32Array([25,25]),this.bUseOriginalImageSize=!0};st.prototype.deleteObjects=function(){this.geoLocationData&&this.geoLocationData.deleteObjects()},st.prototype.setImageFilePath=function(t){this.imageFilePath=t},st.prototype.copyFrom=function(t){void 0!==t&&(t.geoLocationData&&this.geoLocationData.copyFrom(t.geoLocationData),this.issue_id=t.issue_id,this.issue_type=t.issue_type)},st.prototype.getGeoLocationData=function(t){var e,i=this.target;if(i){if(void 0!==i.buildingId&&void 0!==i.projectId){var r=i.projectId,o=i.buildingId,n=t.hierarchyManager.getNodeByDataKey(r,o);if(n){var a=n.data.neoBuilding,s=n.data.geoLocDataManager;if(s){var l=s.getCurrentGeoLocationData();if(void 0!==i.objectId&&a){var h=a.getReferenceObjectsArrayByObjectId(i.objectId);if(h&&h.length>0){var d=h[0].getCenterPositionWC(a,void 0);d&&(void 0===e&&(e=new z),void 0===e.positionHIGH&&(e.positionHIGH=new Float32Array([0,0,0])),void 0===e.positionLOW&&(e.positionLOW=new Float32Array([0,0,0])),Ei.calculateSplited3fv([d.x,d.y,d.z],e.positionHIGH,e.positionLOW))}}else e=l}}}}else e=this.geoLocationData;return e};var lt=function(t){if(!(this instanceof lt))throw new Error(ot.CONSTRUCT_ERROR);this.magoManager=t,this.objectMarkerArray=[],this.objectMarkerMap={},this.pin=new ct};lt.prototype.deleteObjects=function(){for(var t=this.objectMarkerArray.length,e=0;e<t;e++)this.objectMarkerArray[e].deleteObjects(),this.objectMarkerArray[e]=void 0;this.objectMarkerArray.length=0,this.objectMarkerMap={}},lt.prototype.deleteObject=function(t){for(var e=this.objectMarkerArray.length,i=0;i<e;i++)if(this.objectMarkerArray[i].id===t){this.objectMarkerArray[i].deleteObjects(),delete this.objectMarderMap.objMarkerId,this.objectMarkerArray.splice(i,1);break}},lt.prototype.setMarkerByCondition=function(t){var e=this,i=e.objectMarkerArray.filter(function(i){return t.call(e,i)});e.objectMarkerArray=i},lt.prototype.loadDefaultImages=function(t){if(!1===this.pin.defaultImagesLoaded){t.getGl();var e=t.magoPolicy,i=this.pin,r=e.imagePath+"/defaultRed.png",o=i.loadImage(r,t);i.imageFileMap.defaultRed=o,r=e.imagePath+"/defaultBlue.png";o=i.loadImage(r,t);i.imageFileMap.defaultBlue=o,r=e.imagePath+"/defaultOrange.png";o=i.loadImage(r,t);i.imageFileMap.defaultOrange=o,r=e.imagePath+"/defaultCian.png";o=i.loadImage(r,t);i.imageFileMap.defaultCian=o,this.pin.defaultImagesLoaded=!0}},lt.prototype.newObjectMarker=function(t,e){var i=new st;if(this.objectMarkerArray.push(i),t){if(void 0!==t.id&&(i.id=t.id,this.objectMarkerMap[i.id]=i),t.positionWC){var r=t.positionWC;void 0===i.geoLocationData&&(i.geoLocationData=new z),Ei.calculateGeoLocationDataByAbsolutePoint(r.x,r.y,r.z,i.geoLocationData,e)}t.imageFilePath&&(i.imageFilePath=t.imageFilePath),t.imageFilePathSelected&&(i.imageFilePathSelected=t.imageFilePathSelected),t.sizeX&&t.sizeY?(void 0===i.size2d&&(i.size2d=new Float32Array([25,25])),i.size2d[0]=t.sizeX,void 0===i.size2d&&(i.size2d=new Float32Array([25,25])),i.size2d[1]=t.sizeY,i.bUseOriginalImageSize=!1):i.bUseOriginalImageSize=!0,t.target&&(i.target=t.target)}return i},lt.prototype.getObjectMarkerById=function(t){if(void 0===this.objectMarkerMap[t])for(var e=this.objectMarkerArray.length,i=!1,r=0;!i&&r<e;)this.objectMarkerArray[r].id===t&&(i=!0,this.objectMarkerMap[t]=this.objectMarkerArray[r]),r++;return this.objectMarkerMap[t]},lt.prototype.newObjectMarkerSpeechBubble=function(t,e){if(t){e.speechBubble||(e.speechBubble=new Mago3D.SpeechBubble);var i=e.speechBubble,r=t.speechBubbleOptions;if(r){var o=r.width,n=r.height,a=r.commentTextOption,s=r.bubbleColor,l=_.getHexCode(s.r,s.g,s.b),h=i.getPng([o,n],l,a),d=t.target;if(d){var c={target:d,imageFilePath:h,id:t.id};this.newObjectMarker(c,e)}else{var u=t.longitude,f=t.latitude,g=t.altitude;c={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(u,f,g),imageFilePath:h,id:t.id};this.newObjectMarker(c,e)}}}},lt.prototype.render=function(t,e){var i=this.objectMarkerArray.length;if(i>0){var r=t.getGl();void 0===this.pin.positionBuffer&&this.pin.createPinCenterBottom(r);var o=t.postFxShadersManager.getShader("pin");o.resetLastBuffersBinded();var n=o.program;r.useProgram(n),o.bindUniformGenerals(),t.effectsManager.setCurrentShader(o),r.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,t.sceneState.modelViewProjRelToEyeMatrix._floatArrays),r.uniform3fv(o.cameraPosHIGH_loc,t.sceneState.encodedCamPosHigh),r.uniform3fv(o.cameraPosLOW_loc,t.sceneState.encodedCamPosLow),r.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,t.sceneState.modelViewRelToEyeMatrixInv._floatArrays),r.uniform1i(o.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),r.uniform1i(o.texture_loc,0),r.enableVertexAttribArray(o.texCoord2_loc),r.enableVertexAttribArray(o.position4_loc),r.activeTexture(r.TEXTURE0),r.depthRange(0,.05),r.bindBuffer(r.ARRAY_BUFFER,this.pin.positionBuffer),r.vertexAttribPointer(o.position4_loc,4,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,this.pin.texcoordBuffer),r.vertexAttribPointer(o.texCoord2_loc,2,r.FLOAT,!1,0,0),r.activeTexture(r.TEXTURE0),r.uniform1i(o.colorType_loc,2),r.uniform4fv(o.oneColor4_loc,[.2,.7,.9,1]),r.uniform2fv(o.scale2d_loc,[1,1]),r.uniform2fv(o.size2d_loc,[25,25]),r.uniform1i(o.bUseOriginalImageSize_loc,!0),r.uniform3fv(o.aditionalOffset_loc,[0,0,0]),r.depthMask(!1),r.disable(r.BLEND);var a=t.selectionManager,s=void 0;if(1===e){for(var l=!1,h=0;h<i;h++){var d=t.objMarkerManager.objectMarkerArray[h];if(f=this.pin.getTexture(d.imageFilePath)){if(a.isObjectSelected(d)){if(r.uniform2fv(o.scale2d_loc,new Float32Array([1.5,1.5])),d.imageFilePathSelected){if(!(p=this.pin.getTexture(d.imageFilePathSelected))){this.pin.loadImage(d.imageFilePathSelected,t);continue}f=p}}else r.uniform2fv(o.scale2d_loc,new Float32Array([1,1]));r.uniform1i(o.bUseOriginalImageSize_loc,d.bUseOriginalImageSize),d.bUseOriginalImageSize||r.uniform2fv(o.size2d_loc,d.size2d),2!==e&&t.currentProcess!==c.magoCurrentProcess.StencilSilhouetteRendering&&(l=t.effectsManager.executeEffects(d.id,t.getCurrentTime())),r.uniform2fv(o.imageSize_loc,[f.texId.imageWidth,f.texId.imageHeight]),void 0!==(g=d.getGeoLocationData(t))&&(f.texId!==s&&(r.bindTexture(r.TEXTURE_2D,f.texId),s=f.texId),r.uniform3fv(o.buildingPosHIGH_loc,g.positionHIGH),r.uniform3fv(o.buildingPosLOW_loc,g.positionLOW),r.drawArrays(r.TRIANGLE_STRIP,0,4))}else this.pin.loadImage(d.imageFilePath,t)}l&&r.uniform3fv(o.aditionalOffset_loc,[0,0,0])}else if(2===e){var u=t.selectionColor;r.disable(r.BLEND),r.uniform1i(o.colorType_loc,0);for(h=0;h<i;h++){var f,g;d=t.objMarkerManager.objectMarkerArray[h];if(f=this.pin.getTexture(d.imageFilePath)){if(void 0!==(g=d.getGeoLocationData(t))){if(f.texId!==s&&(r.bindTexture(r.TEXTURE_2D,f.texId),s=f.texId),a.isObjectSelected(d)){if(r.uniform2fv(o.scale2d_loc,new Float32Array([1.5,1.5])),d.imageFilePathSelected){var p;if(!(p=this.pin.getTexture(d.imageFilePathSelected))){this.pin.loadImage(d.imageFilePathSelected,t);continue}f=p}}else r.uniform2fv(o.scale2d_loc,new Float32Array([1,1]));var v=u.getAvailableColor(void 0),y=u.decodeColor3(v.r,v.g,v.b);a.setCandidateGeneral(y,d),r.uniform4fv(o.oneColor4_loc,[v.r/255,v.g/255,v.b/255,1]),r.uniform3fv(o.buildingPosHIGH_loc,g.positionHIGH),r.uniform3fv(o.buildingPosLOW_loc,g.positionLOW),r.drawArrays(r.TRIANGLE_STRIP,0,4)}}else this.pin.loadImage(d.imageFilePath,t)}r.enable(r.BLEND)}r.enable(r.BLEND),r.depthRange(0,1),r.depthMask(!0),r.useProgram(null),r.bindTexture(r.TEXTURE_2D,null),o.disableVertexAttribArrayAll()}};var ht=function(){if(!(this instanceof ht))throw new Error(ot.CONSTRUCT_ERROR);this._ocCulling_box=new dt(null),this._infinite_ocCulling_box=new dt(null)},dt=function(t){if(!(this instanceof dt))throw new Error(ot.CONSTRUCT_ERROR);this._ocCulling_Cell_owner=t,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.minZ=0,this.maxZ=0,this._indicesArray=[],this._subBoxesArray=[],this.modelReferencedGroupsList};dt.prototype.createModelReferencedGroups=function(t){var e=this._subBoxesArray.length;if(0===e){if(0===this._indicesArray.length)return;void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new te),this.modelReferencedGroupsList.createModelReferencedGroups(this._indicesArray,t)}else for(var i=0;i<e;i++)this._subBoxesArray[i].createModelReferencedGroups(t)},dt.prototype.newSubBox=function(){var t=new dt(this);return this._subBoxesArray.push(t),t},dt.prototype.create8SubBoxes=function(){this._subBoxesArray.length=0;for(var t=0;t<8;t++)this.newSubBox()},dt.prototype.setDimensions=function(t,e,i,r,o,n){this.minX=t,this.maxX=e,this.minY=i,this.maxY=r,this.minZ=o,this.maxZ=n},dt.prototype.setSizesSubBoxes=function(){if(this._subBoxesArray.length>0){var t=(this.maxX+this.minX)/2,e=(this.maxY+this.minY)/2,i=(this.maxZ+this.minZ)/2;this._subBoxesArray[0].setDimensions(this.minX,t,this.minY,e,this.minZ,i),this._subBoxesArray[1].setDimensions(t,this.maxX,this.minY,e,this.minZ,i),this._subBoxesArray[2].setDimensions(t,this.maxX,e,this.maxY,this.minZ,i),this._subBoxesArray[3].setDimensions(this.minX,t,e,this.maxY,this.minZ,i),this._subBoxesArray[4].setDimensions(this.minX,t,this.minY,e,i,this.maxZ),this._subBoxesArray[5].setDimensions(t,this.maxX,this.minY,e,i,this.maxZ),this._subBoxesArray[6].setDimensions(t,this.maxX,e,this.maxY,i,this.maxZ),this._subBoxesArray[7].setDimensions(this.minX,t,e,this.maxY,i,this.maxZ);for(var r=0;r<this._subBoxesArray.length;r++)this._subBoxesArray[r].setSizesSubBoxes()}},dt.prototype.intersectsWithPoint3D=function(t,e,i){var r=!1;return t>this.minX&&t<this.maxX&&e>this.minY&&e<this.maxY&&i>this.minZ&&i<this.maxZ&&(r=!0),r},dt.prototype.getIntersectedSubBoxByPoint3D=function(t,e,i){if(void 0!==this._ocCulling_Cell_owner||this.intersectsWithPoint3D(t,e,i)){var r=void 0;if(this._subBoxesArray.length>0){var o,n=(this.minX+this.maxX)/2,a=(this.minY+this.maxY)/2,s=(this.minZ+this.maxZ)/2;o=t<n?e<a?i<s?0:4:i<s?3:7:e<a?i<s?1:5:i<s?2:6,r=this._subBoxesArray[o].getIntersectedSubBoxByPoint3D(t,e,i)}else r=this;return r}},dt.prototype.getIndicesVisiblesForEye=function(t,e,i,r,o){var n=this.getIntersectedSubBoxByPoint3D(t,e,i);return void 0!==n&&n._indicesArray.length>0&&(r=n._indicesArray,o&&(o=this.modelReferencedGroupsList)),r},dt.prototype.expandBox=function(t){this.minX-=t,this.maxX+=t,this.minY-=t,this.maxY+=t,this.minZ-=t,this.maxZ+=t},dt.prototype.parseArrayBuffer=function(t,e,i){var r=i.readInt8(t,e,e+1);if(e+=1,r){var o=i.readFloat32(t,e,e+4);e+=4;var n=i.readFloat32(t,e,e+4);e+=4;var a=i.readFloat32(t,e,e+4);e+=4;var s=i.readFloat32(t,e,e+4);e+=4;var l=i.readFloat32(t,e,e+4);e+=4;var h=i.readFloat32(t,e,e+4);e+=4,this.setDimensions(o,n,a,s,l,h)}var d=i.readUInt32(t,e,e+4);if(e+=4,0===d){var c=i.readUInt32(t,e,e+4);e+=4;for(var u=0;u<c;u++){var f=i.readUInt32(t,e,e+4);e+=4,this._indicesArray.push(f)}}else for(u=0;u<d;u++){e=this.newSubBox().parseArrayBuffer(t,e,i)}return e};var ct=function(){if(!(this instanceof ct))throw new Error(ot.CONSTRUCT_ERROR);this.texture,this.texturesArray=[],this.positionBuffer,this.texcoordBuffer,this.imageFileMap={},this.defaultImagesLoaded=!1};ct.prototype.createPin=function(t){this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,0,0,0,1,0,0,1,0,1,0,0,1,1,0]),t.STATIC_DRAW),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW)},ct.prototype.loadImage=function(t,e){var i=new At,r=e.getGl();return i.texId=r.createTexture(),e.readerWriter.readNeoReferenceTexture(r,t,i,void 0,e),this.texturesArray.push(i),this.imageFileMap[t]=i,i},ct.prototype.getTexture=function(t){return this.imageFileMap[t]},ct.prototype.createPinCenterBottom=function(t){this.positionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);var e=new Float32Array(16),i=new ur(0,0,0);e[0]=i.x,e[1]=i.y,e[2]=i.z,e[3]=1,e[4]=i.x,e[5]=i.y,e[6]=i.z,e[7]=-1,e[8]=i.x,e[9]=i.y,e[10]=i.z,e[11]=2,e[12]=i.x,e[13]=i.y,e[14]=i.z,e[15]=-2,t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),this.texcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texcoordBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),t.STATIC_DRAW)};var ut=function(){if(!(this instanceof ut))throw new Error(ot.CONSTRUCT_ERROR);this.a=0,this.b=0,this.c=0,this.d=0};ut.prototype.setPointAndNormal=function(t,e,i,r,o,n){this.a=r,this.b=o,this.c=n,this.d=-this.a*t-this.b*e-this.c*i},ut.prototype.setPoint=function(t,e,i){this.d=-this.a*t-this.b*e-this.c*i},ut.prototype.setNormalAndDistance=function(t,e,i,r){this.a=t,this.b=e,this.c=i,this.d=r},ut.prototype.getNormal=function(t){return void 0===t&&(t=new ur),t.set(this.a,this.b,this.c),t},ut.prototype.getRotationMatrix=function(t){var e=new ur(0,0,1),i=this.getNormal(void 0),r=e.getRelativeOrientationToVector(i,1e-9),o=glMatrix.mat4.create();if(0===r);else if(1===r){var n=glMatrix.mat4.create();o=glMatrix.mat4.rotateX(o,n,Math.PI)}else if(2===r){var a=e.crossProduct(i,void 0);a.unitary();var s=e.angleRadToVector(i),l=glMatrix.vec3.fromValues(a.x,a.y,a.z),h=quat.create();h=quat.setAxisAngle(h,l,s);n=glMatrix.mat4.create();o=glMatrix.mat4.fromQuat(n,h)}return void 0===t&&(t=new rt),t._floatArrays=o,t},ut.prototype.getProjectedPoint=function(t,e){if(void 0!==t){void 0===e&&(e=new ur);var i=this.getNormal(),r=new Yi;return r.setPointAndDir(t.x,t.y,t.z,i.x,i.y,i.z),e=this.intersectionLine(r,e)}},ut.prototype.intersectionLine=function(t,e){var i=t.point.x,r=t.point.y,o=t.point.z,n=t.direction.x,a=t.direction.y,s=t.direction.z,l=this.a*n+this.b*a+this.c*s;if(Math.abs(l)>1e-7){var h=-(this.a*i+this.b*r+this.c*o+this.d)/l;return void 0===e&&(e=new ur),e.set(i+h*n,r+h*a,o+h*s),e}},ut.prototype.intersectionSphere=function(t){if(void 0===t||void 0===t.centerPoint)return u.INTERSECTION_OUTSIDE;var e=t.centerPoint,i=e.x*this.a+e.y*this.b+e.z*this.c+this.d;return i<-t.r?u.INTERSECTION_OUTSIDE:i<t.r?u.INTERSECTION_INTERSECT:u.INTERSECTION_INSIDE};var ft=function(){if(!(this instanceof ft))throw new Error(ot.CONSTRUCT_ERROR);this.x=0,this.y=0,this.z=0,this.w=1};ft.prototype.Modul=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},ft.prototype.Unitary=function(){var t=this.Modul();this.x/=t,this.y/=t,this.z/=t,this.w/=t},ft.prototype.rotationAngDeg=function(t,e,i,r){var o=t*Math.PI/180;this.rotationAngRad(o,e,i,r)},ft.prototype.rotationAngRad=function(t,e,i,r){var o=Math.sqrt(e*e+i*i+r*r);if(!o<1e-12){var n=1/o,a=.5*t;o=Math.sin(a),this.x=e*n*o,this.y=i*n*o,this.z=r*n*o,this.w=Math.cos(a),this.Unitary()}else this.x=0,this.y=0,this.z=0,this.w=1};var gt=function(){if(!(this instanceof gt))throw new Error(ot.CONSTRUCT_ERROR);this.color=new _};gt.prototype.init=function(){this.color.r=0,this.color.g=0,this.color.b=0,this.cycle=0},gt.prototype.getAvailableColor=function(t){return void 0===t&&(t=new _),t.setRGB(this.color.r,this.color.g,this.color.b),this.color.b+=1,this.color.b>=254&&(this.color.b=0,this.color.g+=1,this.color.g>=254&&(this.color.g=0,this.color.r+=1,this.color.r>=254&&(this.color.r=0,this.cycle+=1))),t},gt.prototype.decodeColor3=function(t,e,i){return 64516*t+254*e+i};var pt=function(){if(!(this instanceof pt))throw new Error(ot.CONSTRUCT_ERROR);this._renderingSettings=new Te,this.keepVboPositionDataArrayBuffers=!0};pt.prototype.getRenderingSettings=function(){return this._renderingSettings};var vt=function(t){if(!(this instanceof vt))throw new Error(ot.CONSTRUCT_ERROR);this.name,t&&(this.name=t),this.depth,this.X,this.Y,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent,this.subTiles,this.nodeSeedsArray,this.smartTileF4dSeedArray,this.nodesFromSmartTileF4dArray,this.nodesArray,this.objectsArray,this.vectorTypeObjectsArray,this.nativeObjects={opaquesArray:[],transparentsArray:[],excavationsArray:[],vectorTypeArray:[]},this.isVisible,this.distToCamera};vt.prototype.deleteObjects=function(){if(this.name=void 0,this.depth=void 0,this.minGeographicCoord&&this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord&&this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.sphereExtent&&this.sphereExtent.deleteObjects(),this.sphereExtent=void 0,this.nodeSeedsArray){for(var t=this.nodeSeedsArray.length,e=0;e<t;e++)this.nodeSeedsArray[e]=void 0;this.nodeSeedsArray=void 0}if(this.nodesArray){var i=this.nodesArray.length;for(e=0;e<i;e++)this.nodesArray[e]=void 0;this.nodesArray=void 0}if(this.isVisible=void 0,this.subTiles){var r=this.subTiles.length;for(e=0;e<r;e++)this.subTiles[e].deleteObjects(),this.subTiles[e]=void 0;this.subTiles=void 0}},vt.prototype.newSubTile=function(t){if(t instanceof vt){void 0===this.subTiles&&(this.subTiles=[]);var e=new vt;return e.depth=t.depth+1,e.targetDepth=t.targetDepth,this.subTiles.push(e),e}},vt.prototype.clearNodesArray=function(){if(void 0!==this.nodesArray){for(var t=0;t<this.nodesArray.length;t++)this.nodesArray[t]=void 0;this.nodesArray=void 0}},vt.prototype.getNeoBuildingById=function(t,e){var i,r=this.getNodeByBuildingId(t,e);return void 0!==r&&(i=r.data.neoBuilding),i},vt.prototype.getBuildingSeedById=function(t,e){var i,r=!0;if(void 0===this.subTiles&&(r=!1),this.subTiles&&0===this.subTiles.length&&(r=!1),r){for(s=0;s<this.subTiles.length;s++)if(i=this.subTiles[s].getBuildingSeedById(t,e))return i}else if(this.nodeSeedsArray)for(var o,n=this.nodeSeedsArray.length,a=!1,s=0;!a&&s<n;){if(o=this.nodeSeedsArray[s].data.buildingSeed,t){if(o.buildingId===e&&o.buildingType===t)return a=!0,i=o}else if(o.buildingId===e)return a=!0,i=o;s++}return i},vt.prototype.TEST__hasLowestTiles_nodesArray=function(){var t=[];this.extractLowestTiles(t);for(var e=t.length,i=0;i<e;){if(t[i].nodesArray&&t[i].nodesArray.length>0)return!0;i++}return!1},vt.prototype.makeSphereExtent=function(t){this.sphereExtent=vt.computeSphereExtent(t,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent)},vt.computeSphereExtent=function(t,e,i,r){if(void 0!==e&&void 0!==i){void 0===r&&(r=new mt);var o,n=(i.longitude+e.longitude)/2,a=(i.latitude+e.latitude)/2,s=(i.altitude+e.altitude)/2;return r.centerPoint=Ei.geographicCoordToWorldPoint(n,a,s,r.centerPoint,t),o=Ei.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,o,t),r.r=1.1*r.centerPoint.distTo(o.x,o.y,o.z),r}},vt.prototype.putSmartTileF4dSeed=function(t,e,i){if(void 0===this.sphereExtent&&this.makeSphereExtent(i),this.depth<t){if(void 0===this.subTiles||0===this.subTiles.length)for(var r=0;r<4;r++)this.newSubTile(this);this.setSizesToSubTiles();var o,n=e.geographicCoord,a=!1;for(r=0;!a&&r<4;)(o=this.subTiles[r]).intersectPoint(n.longitude,n.latitude)&&(o.putSmartTileF4dSeed(t,e,i),a=!0),r++}else if(this.depth===t){void 0===this.smartTileF4dSeedArray&&(this.smartTileF4dSeedArray=[]),this.smartTileF4dSeedArray.push(e);var s=e.tileName.split(".")[0],l={};l.L=e.L,l.X=e.X,l.Y=e.Y,l.geographicCoord=e.geographicCoord,l.objectType=e.objectType,l.id=e.id,l.smartTileType=e.smartTileType,l.tileName=s+"_4.sti",l.projectFolderName=e.projectFolderName,l.fileLoadState=c.fileLoadState.READY,this.smartTileF4dSeedArray.push(l);var h={};return h.L=e.L,h.X=e.X,h.Y=e.Y,h.geographicCoord=e.geographicCoord,h.objectType=e.objectType,h.id=e.id,h.smartTileType=e.smartTileType,h.tileName=s+"_3.sti",h.projectFolderName=e.projectFolderName,h.fileLoadState=c.fileLoadState.READY,this.smartTileF4dSeedArray.push(h),!0}},vt.prototype.putNode=function(t,e,i){if(void 0===this.sphereExtent&&this.makeSphereExtent(i),this.depth<t){if(void 0===this.subTiles||0===this.subTiles.length)for(var r=0;r<4;r++)this.newSubTile(this);var o;this.setSizesToSubTiles();var n=!1;for(r=0;!n&&r<4;)(o=this.subTiles[r]).intersectsNode(e)&&(o.putNode(t,e,i),n=!0),r++}else if(this.depth===t)return void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),void 0===this.nodesArray&&(this.nodesArray=[]),e.data.smartTileOwner=this,this.nodeSeedsArray.push(e),this.nodesArray.push(e),!0},vt.prototype.putObject=function(t,i,r){if(void 0===this.sphereExtent&&this.makeSphereExtent(r),this.depth<t){if(void 0===this.subTiles||0===this.subTiles.length)for(var o=0;o<4;o++)this.newSubTile(this);this.setSizesToSubTiles();var n,a=i.geoLocDataManager.getCurrentGeoLocationData().getGeographicCoords(),s=!1;for(o=0;!s&&o<4;)(n=this.subTiles[o]).intersectPoint(a.longitude,a.latitude)&&(n.putObject(t,i,r),s=!0),o++}else if(this.depth===t)return i.smartTileOwner=this,i instanceof e?i.objectType===e.OBJECT_TYPE.MESH?i.isOpaque()?this.nativeObjects.opaquesArray.push(i):this.nativeObjects.transparentsArray.push(i):i.objectType===e.OBJECT_TYPE.VECTORMESH&&this.nativeObjects.vectorTypeArray.push(i):i instanceof j?(void 0===this.nativeObjects.pointTypeArray&&(this.nativeObjects.pointTypeArray=[]),this.nativeObjects.pointTypeArray.push(i)):i instanceof ki&&this.nativeObjects.excavationsArray.push(i),!0},vt.prototype.makeTreeByDepth=function(t,e){if(void 0!==this.nodeSeedsArray&&0!==this.nodeSeedsArray.length&&(this.targetDepth=t,this.makeSphereExtent(e),this.depth<t)){if(void 0===this.subTiles||0===this.subTiles.length)for(var i=0;i<4;i++)this.newSubTile(this);this.setSizesToSubTiles();for(i=0;i<4;i++)this.subTiles[i].takeIntersectedBuildingSeeds(this.nodeSeedsArray);for(i=0;i<4;i++)this.subTiles[i].makeTreeByDepth(t,e)}},vt.prototype.intersectsNode=function(t){var e,i,r=!1,o=t.data.buildingSeed,n=t.getRoot();return void 0!==n.data.bbox&&void 0!==n.data.bbox.geographicCoord?(e=n.data.bbox.geographicCoord.longitude,i=n.data.bbox.geographicCoord.latitude):void 0!==o?(e=o.geographicCoordOfBBox.longitude,i=o.geographicCoordOfBBox.latitude):(e=t.data.geographicCoord.longitude,i=t.data.geographicCoord.latitude),this.intersectPoint(e,i)&&(r=!0),r},vt.prototype.takeIntersectedBuildingSeeds=function(t){for(var e,i=t.length,r=0;r<i;r++){var o;if(e=t[r],this.intersectsNode(e))if(t.splice(r,1),r--,i=t.length,void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),e.data.smartTileOwner=this,this.nodeSeedsArray.push(e),void 0!==(o=e.data.buildingSeed)){var n=o.geographicCoordOfBBox.altitude,a=o.bBox.getRadiusAprox();n-a<this.minGeographicCoord.altitude&&(this.minGeographicCoord.altitude=n-a),n+a>this.maxGeographicCoord.altitude&&(this.maxGeographicCoord.altitude=n+a)}}},vt.prototype.intersectPoint=function(t,e){return!(t<this.minGeographicCoord.longitude||t>this.maxGeographicCoord.longitude)&&!(e<this.minGeographicCoord.latitude||e>this.maxGeographicCoord.latitude)},vt.prototype.eraseNode=function(t){if(void 0!==this.nodeSeedsArray)for(var e=this.nodeSeedsArray.length,i=!1,r=0;!i&&r<e;)this.nodeSeedsArray[r]===t&&(this.nodeSeedsArray.splice(r,1),i=!0),r++;if(void 0!==this.nodesArray){var o=this.nodesArray.length;for(i=!1,r=0;!i&&r<o;)this.nodesArray[r]===t&&(this.nodesArray.splice(r,1),i=!0),r++}},vt.prototype.calculateDistToCamera=function(t){var e=this.getSphereExtent();return this.distToCamera=e.distToPoint3D(t.position),this.distToCamera},vt.prototype.extractLowestTiles=function(t,e,i){this.hasRenderables()&&(this.calculateDistToCamera(t)<yt.maxDistToCameraByDepth(this.depth)&&(this.intersectionType=u.INTERSECTION_INSIDE,this.putSmartTileInEyeDistanceSortedArray(e,this)));if(void 0!==this.subTiles&&0!==this.subTiles.length)for(var r=this.subTiles.length,o=0;o<r;o++)this.subTiles[o].extractLowestTiles(t,e,i)},vt.prototype.getFrustumIntersectedLowestTiles=function(t,e,i,r){var o=[],n=[];this.getFrustumIntersectedTiles(t,e,o,n,r),i.push.apply(i,n);for(var a=o.length,s=0;s<a;s++)o[s].extractLowestTiles(t,i,r)},vt.prototype.getFrustumIntersectedTiles=function(t,e,i,r,o){if(void 0===this.sphereExtent)return u.INTERSECTION_OUTSIDE;if(this.intersectionType=e.intersectionSphere(this.sphereExtent),this.intersectionType!==u.INTERSECTION_OUTSIDE)if(this.intersectionType!==u.INTERSECTION_INSIDE){if(this.intersectionType===u.INTERSECTION_INTERSECT){if(this.hasRenderables())this.calculateDistToCamera(t)<yt.maxDistToCameraByDepth(this.depth)&&this.putSmartTileInEyeDistanceSortedArray(r,this);if(this.subTiles&&this.subTiles.length>0)for(var n=0;n<this.subTiles.length;n++)this.subTiles[n].sphereExtent&&this.subTiles[n].getFrustumIntersectedTiles(t,e,i,r,o)}}else i.push(this)},vt.prototype.getSphereIntersectedTiles=function(t,e,i){if(this.depth>i)return u.INTERSECTION_OUTSIDE;if(void 0===this.sphereExtent)return u.INTERSECTION_OUTSIDE;if(t.intersectionSphere(this.sphereExtent)===u.INTERSECTION_OUTSIDE)return u.INTERSECTION_OUTSIDE;if(this.hasRenderables()&&e.push(this),this.subTiles&&this.subTiles.length>0)for(var r=0;r<this.subTiles.length;r++)this.subTiles[r].sphereExtent&&this.subTiles[r].getSphereIntersectedTiles(t,e,i)},vt.prototype.putSmartTileInEyeDistanceSortedArray=function(t,e){if(t.length>0){var i=t.length-1,r=Ei.getIndexToInsertBySquaredDistToEye(t,e,0,i);t.splice(r,0,e)}else t.push(e)},vt.prototype.hasRenderables=function(){if(void 0!==this.nodeSeedsArray&&this.nodeSeedsArray.length>0)return!0;if(void 0!==this.nodesArray&&this.nodesArray.length>0)return!0;if(void 0!==this.smartTileF4dSeedArray&&this.smartTileF4dSeedArray.length>0)return!0;var t=this.nativeObjects;return t.opaquesArray.length>0||t.transparentsArray.length>0||t.excavationsArray.length>0||t.vectorTypeArray.length>0||!!(t.pointTypeArray&&t.pointTypeArray.length>0)},vt.prototype.isNeededToCreateGeometriesFromSeeds=function(){if(void 0!==this.nodeSeedsArray){if(void 0===this.nodesArray)return!0;if(this.nodesArray.length!==this.nodeSeedsArray.length)return!0}if(void 0!==this.smartTileF4dSeedArray&&this.smartTileF4dSeedArray.length>0)for(var t=this.smartTileF4dSeedArray.length,e=0;e<t;e++)if(this.smartTileF4dSeedArray[e].fileLoadState!==c.fileLoadState.PARSE_FINISHED)return!0;return!1},vt.prototype.setNodesAttribute=function(t,e,i){if(void 0!==t)for(var r=t.length,o=0;o<r;o++){var n=t[o];void 0===n.data.attributes&&(n.data.attributes={}),n.data.attributes[e]=i}},vt.prototype.createGeometriesFromSeeds=function(t){var e,i,r,o,n=!1;if(void 0!==this.nodeSeedsArray){void 0===this.nodesArray&&(this.nodesArray=[]);var a=this.nodeSeedsArray.length;if(a!==this.nodesArray.length){this.setNodesAttribute(this.nodeSeedsArray,"needCreated",1),this.setNodesAttribute(this.nodesArray,"needCreated",0);for(var s=0;s<a;s++)if(1===(e=this.nodeSeedsArray[s]).data.attributes.needCreated){var l=e.data.attributes;if("basicF4d"===l.objectType&&!l.fromSmartTile){if(void 0!==l.projectId&&void 0!==l.isReference&&!0===l.isReference&&Er.manageStaticModel(e,t),void 0!==e.data.neoBuilding){this.nodesArray.push(e);continue}(i=new re).setAttribute("keepDataArrayBuffers",!0),i.nodeOwner=e,e.data.neoBuilding=i,void 0===e.data.bbox&&(e.data.bbox=new y),r=e.data.bbox,o=e.data.buildingSeed,this.nodesArray.push(e),void 0===i.metaData&&(i.metaData=new Jt),void 0===i.metaData.geographicCoord&&(i.metaData.geographicCoord=new j),void 0===i.metaData.bbox&&(i.metaData.bbox=new y),i.name=o.name,i.buildingId=o.buildingId,i.buildingType="basicBuilding",i.buildingFileName=o.buildingFileName,i.metaData.geographicCoord.setLonLatAlt(o.geographicCoord.longitude,o.geographicCoord.latitude,o.geographicCoord.altitude),i.metaData.bbox.copyFrom(o.bBox),r.copyFrom(o.bBox),void 0===i.bbox&&(i.bbox=new y),i.bbox.copyFrom(o.bBox),i.metaData.heading=o.rotationsDegree.z,i.metaData.pitch=o.rotationsDegree.x,i.metaData.roll=o.rotationsDegree.y,i.projectFolderName=e.data.projectFolderName,n=!0,t.emit(tt.EVENT_TYPE.F4DRENDERREADY,{type:tt.EVENT_TYPE.F4DRENDERREADY,f4d:e,timestamp:new Date})}}}}var h=this.distToCamera;if(void 0!==this.smartTileF4dSeedArray)for(var d=this.smartTileF4dSeedArray.length,u=0;u<d;u++){var f=this.smartTileF4dSeedArray[u];if(void 0===f.fileLoadState&&(f.fileLoadState=c.fileLoadState.READY),u>0){if(this.smartTileF4dSeedArray[u-1].fileLoadState!==c.fileLoadState.PARSE_FINISHED)break;if(h>t.magoPolicy.getLod4DistInMeters())break}if(f.fileLoadState===c.fileLoadState.READY){if(t.readerWriter.smartTileF4d_requested<3){var g=t.readerWriter,p=f.projectFolderName,v=f.L.toString(),m=f.X.toString(),x=f.tileName,b=g.geometryDataPath+"/"+p+"/"+v+"/"+m+"/"+x;g.getSmartTileF4d(b,f,this,t)}break}if(f.fileLoadState===c.fileLoadState.LOADING_FINISHED){var C=30;u>0&&(C=5);var A=t.parseQueue;if(A.smartTileF4dParsesCount<C){this.parseSmartTileF4d(f.dataArrayBuffer,t),A.smartTileF4dParsesCount++,f.fileLoadState=c.fileLoadState.PARSE_FINISHED,n=!0;break}}}return n},vt.prototype.parseSmartTileF4d=function(t,e){var i=e.hierarchyManager,r=(e.readerWriter,e.smartTileManager,17);r>this.depth&&(r=this.depth),void 0===this.nodesArray&&(this.nodesArray=[]),void 0===this.sphereExtent&&this.makeSphereExtent(e);var o=new TextDecoder("utf-8"),n=0,a=new Int32Array(t.slice(n,n+4))[0];n+=4;var s=new Int32Array(t.slice(n,n+4))[0];n+=4,e.emit(tt.EVENT_TYPE.SMARTTILELOADSTART,{tile:this,timestamp:new Date});for(var l=e.f4dController.smartTilePathInfo,h=0;h<s;h++){var d,u=new Uint16Array(t.slice(n,n+2))[0];n+=2,d=o.decode(new Int8Array(t.slice(n,n+u))),n+=u;var f="";if(u=new Uint16Array(t.slice(n,n+2))[0],n+=2,f=o.decode(new Int8Array(t.slice(n,n+u))),n+=u,l[d]){var g=l[d].projectFolderPath,p=l[d].projectId,v={isPhysical:!0,objectType:"basicF4d"};g.indexOf("-tree")>0&&(v.isReference=!0,e.isExistStaticModel(p)||e.addStaticModel({projectId:p,projectFolderName:g,buildingFolderName:f}));var y=e.hierarchyManager.getNodeByDataKey(p,"attributes");y&&(v.isVisible=y.isVisible);var m,x,b=i.getNodeByDataKey(p,f),C=new Int32Array(t.slice(n,n+4))[0],A=n+=4,T=n+C,M=t.slice(A,T);n+=C;var P=f.startsWith("F4D_")?f.replace("F4D_",""):f;if(b){if(!v.isReference){void 0===(m=(x=b.data).neoBuilding)&&(m=new re,x.neoBuilding=m,m.buildingFileName=f,m.buildingId=f,m.projectFolderName=g,m.nodeOwner=b);var w=M;void 0===m.metaData&&(m.metaData=new Jt,m.headerDataArrayBuffer=w,m.metaData.fileLoadState=c.fileLoadState.LOADING_FINISHED)}}else v.isReference||((x=(b=i.newNode(f,p,v)).data).projectFolderName=g,x.projectId=p,x.data_name=P,x.attributes=v,x.attributes.fromSmartTile=!0,x.mapping_type="origin",m=new re,x.neoBuilding=m,m.buildingFileName=f,m.buildingId=f,m.projectFolderName=g,m.nodeOwner=b,m.headerDataArrayBuffer=M,void 0===m.metaData&&(m.metaData=new Jt),m.metaData.fileLoadState=c.fileLoadState.LOADING_FINISHED);var _="lod5";if(2===a){var S=new Int8Array(t.slice(n,n+1))[0];n+=1,_="lod"+S.toString()}var L=new Uint16Array(t.slice(n,n+2))[0];n+=2;var R=o.decode(new Int8Array(t.slice(n,n+L)));n+=L;var D=new Int32Array(t.slice(n,n+4))[0],E=(A=n+=4,T=n+D,t.slice(A,T));n+=D;var I=new Int32Array(t.slice(n,n+4))[0],O=(A=n+=4,T=n+1*I,t.slice(A,T));n+=1*I;var F=new j;n=F.readDataFromBuffer(t,n);var N=new ur;n=N.readDataFromBuffer(t,n);var B=new Int32Array(t.slice(n,n+4))[0];n+=4;new Int32Array(t.slice(n,n+4))[0];n+=4;var V=new Int8Array(t.slice(n,n+1))[0];n+=1;for(var U={};V>0;){if(5===V){var k=new Uint16Array(t.slice(n,n+2))[0];n+=2;var G=o.decode(new Int8Array(t.slice(n,n+k)));n+=k;var z=new Uint16Array(t.slice(n,n+2))[0];n+=2;var H=new Uint8Array(t.slice(n,n+z));n+=z;var W=new TextDecoder("utf-8").decode(H);U[G]=W}V=new Int8Array(t.slice(n,n+1))[0],n+=1}if(v.isReference){var X=F.longitude,Y=F.latitude,K=F.altitude;e.instantiateStaticModel({projectId:p,instanceId:f,longitude:X,latitude:Y,height:K,heading:N.z,pitch:N.x,roll:N.y});var q=i.getNodeByDataKey(p,f);for(var Z in q.data.dataId=B,q.data.dataGroupId=p,q.data.projectFolderName=g,U)U.hasOwnProperty(Z)&&(q.data[Z]=U[Z]);this.nodesArray.push(q)}else{var Q=m.getOrNewLodBuilding(_),J=m.getOrNewLodMesh(R);for(var Z in J.fileLoadState=c.fileLoadState.LOADING_FINISHED,J.dataArrayBuffer=E,void 0===Q.texture&&(Q.texture=new At),Q.texture.imageBinaryData=O,Q.texture.fileLoadState=c.fileLoadState.LOADING_FINISHED,b.data.geographicCoord=F,b.data.rotationsDegree=N,b.data.dataId=B,b.data.dataGroupId=p,b.data.smartTileOwner=this,U)U.hasOwnProperty(Z)&&(b.data[Z]=U[Z]);this.nodesArray.push(b)}}}e.emit(tt.EVENT_TYPE.SMARTTILELOADEND,{tile:this,timestamp:new Date})},vt.selectTileAngleRangeByDepth=function(t){if(!(void 0===t||t<0||t>21))return 0===t?180:1===t?90:2===t?45:3===t?22.5:4===t?11.25:5===t?5.625:6===t?2.8125:7===t?1.40625:8===t?.703125:9===t?.3515625:10===t?.17578125:11===t?.087890625:12===t?.043945313:13===t?.021972656:14===t?.010986328:15===t?.005493164:16===t?.002746582:17===t?.001373291:18===t?.0006866455:19===t?.00034332275:20===t?.000171661375:21===t?858306875e-13:void 0},vt.selectTileName=function(t,e,i,r){var o=vt.selectTileAngleRangeByDepth(t),n=Math.floor((e- -180)/o),a=Math.floor((90-i)/o);return t.toString()+"\\"+n.toString()+"\\"+a.toString()},vt.getGeographicExtentOfTileLXY=function(t,e,i,r,o){if(void 0===r&&(r=new G),o===c.imageryType.CRS84){var n=vt.selectTileAngleRangeByDepth(t),a=n*e-180,s=n*(e+1)-180,l=90-n*(i+1),h=90-n*i;return r.setExtent(a,l,0,s,h,0),r}if(o===c.imageryType.WEB_MERCATOR){for(var d,u=Math.pow(2,t),f=u,g=360/u,p=Math.PI,v=Math.E,y=p,m=-p,x=1.4844222297453324,b=-1.4844222297453324,C=(i+5e-4)/f,A=0,T=!1;!T&&A<=22;){if(A===t){var M=g*e-180,P=M+g,w=180*b/p,_=180*x/p;r.setExtent(M,w,0,P,_,0),T=!0}else{var S=(y+m)/2;d=2*Math.atan(Math.pow(v,S))-p/2,(p-S)/(p- -p)>C?(b=d,m=S):(x=d,y=S)}A++}return r}},vt.getFrustumIntersectedTilesNames=function(t,e,i,r,o){var n=new j,a=new j,s=0;return void 0===o&&(o=[]),n.setLonLatAlt(-180,-90,0),a.setLonLatAlt(0,90,0),s=0,vt.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,s,i,n,a,r,r.boundingSphere_Aux,o),n.setLonLatAlt(0,-90,0),a.setLonLatAlt(180,90,0),s=0,vt.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,s,i,n,a,r,r.boundingSphere_Aux,o),o},vt.getFrustumIntersectedTilesNamesForGeographicExtent=function(t,e,i,r,o,n,a,s,l){s=vt.computeSphereExtent(a,o,n,s);var h=t.intersectionSphere(s);if(h!==u.INTERSECTION_OUTSIDE){if(h===u.INTERSECTION_INSIDE){var d=(o.longitude+n.longitude)/2,c=(o.latitude+n.latitude)/2,f=vt.selectTileName(i,d,c,void 0);return(g=new G).minGeographicCoord=new j(o.longitude,o.latitude,o.altitude),g.maxGeographicCoord=new j(n.longitude,n.latitude,n.altitude),void(l[f]=g)}if(h===u.INTERSECTION_INTERSECT){if(r.distToSphere(s)>2e3){d=(o.longitude+n.longitude)/2,c=(o.latitude+n.latitude)/2,f=vt.selectTileName(i,d,c,void 0);return(g=new G).minGeographicCoord=new j(o.longitude,o.latitude,o.altitude),g.maxGeographicCoord=new j(n.longitude,n.latitude,n.altitude),void(l[f]=g)}if(!(i<e)){var g;d=(o.longitude+n.longitude)/2,c=(o.latitude+n.latitude)/2,f=vt.selectTileName(i,d,c,void 0);return(g=new G).minGeographicCoord=new j(o.longitude,o.latitude,o.altitude),g.maxGeographicCoord=new j(n.longitude,n.latitude,n.altitude),void(l[f]=g)}i+=1;var p=o.longitude,v=o.latitude,y=o.altitude,m=n.longitude,x=n.latitude,b=n.altitude,d=(p+m)/2,c=(v+x)/2;n.setLonLatAlt(d,c,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,r,o,n,a,s,l),o.setLonLatAlt(d,v,y),n.setLonLatAlt(m,c,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,r,o,n,a,s,l),o.setLonLatAlt(d,c,y),n.setLonLatAlt(m,x,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,r,o,n,a,s,l),o.setLonLatAlt(p,c,y),n.setLonLatAlt(d,x,b),this.getFrustumIntersectedTilesNamesForGeographicExtent(t,e,i,r,o,n,a,s,l)}}},vt.getTilesNamesByTargetDepth=function(t,e,i,r,o){if(!(e<t)){f=(i.longitude+r.longitude)/2,g=(i.latitude+r.latitude)/2;var n=vt.selectTileName(e,f,g,void 0),a=new G;return a.minGeographicCoord=new j(i.longitude,i.latitude,i.altitude),a.maxGeographicCoord=new j(r.longitude,r.latitude,r.altitude),void(o[n]=a)}e+=1;var s=i.longitude,l=i.latitude,h=i.altitude,d=r.longitude,c=r.latitude,u=r.altitude,f=(s+d)/2,g=(l+c)/2;r.setLonLatAlt(f,g,u),this.getTilesNamesByTargetDepth(t,e,i,r,o),i.setLonLatAlt(f,l,h),r.setLonLatAlt(d,g,u),this.getTilesNamesByTargetDepth(t,e,i,r,o),i.setLonLatAlt(f,g,h),r.setLonLatAlt(d,c,u),this.getTilesNamesByTargetDepth(t,e,i,r,o),i.setLonLatAlt(s,g,h),r.setLonLatAlt(f,c,u),this.getTilesNamesByTargetDepth(t,e,i,r,o)},vt.prototype.getSphereExtent=function(){return this.sphereExtent},vt.prototype.setSize=function(t,e,i,r,o,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new j),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new j),this.minGeographicCoord.setLonLatAlt(t,e,i),this.maxGeographicCoord.setLonLatAlt(r,o,n)},vt.prototype.setSizesToSubTiles=function(){if(this.subTiles.length<4)throw new Error("When subTiles length is 4, setSizesToSubTiles is ok.");var t=this.minGeographicCoord.longitude,e=this.maxGeographicCoord.longitude,i=this.minGeographicCoord.latitude,r=this.maxGeographicCoord.latitude,o=this.minGeographicCoord.altitude,n=this.maxGeographicCoord.altitude,a=(e+t)/2,s=(r+i)/2,l=this.subTiles[0];l.setSize(t,i,o,a,s,n),l.X=2*this.X,l.Y=2*this.Y+1,(l=this.subTiles[1]).setSize(a,i,o,e,s,n),l.X=2*this.X+1,l.Y=2*this.Y+1,(l=this.subTiles[2]).setSize(a,s,o,e,r,n),l.X=2*this.X+1,l.Y=2*this.Y,(l=this.subTiles[3]).setSize(t,s,o,a,r,n),l.X=2*this.X,l.Y=2*this.Y},vt.prototype.getId=function(){return void 0===this.id&&(this.id=this.depth.toString()+"_"+this.X.toString()+"_"+this.Y.toString()),this.id},vt.prototype.getLongitudeRangeDegree=function(){return this.maxGeographicCoord.longitude-this.minGeographicCoord.longitude},vt.prototype.getLatitudeRangeDegree=function(){return this.maxGeographicCoord.latitude-this.minGeographicCoord.latitude},vt.prototype.eraseObjectByComparision=function(t,e){if(!t[e])return!1;var i=t[e];if(this.objectsArray&&Array.isArray(this.objectsArray))for(var r=0,o=this.objectsArray.length;r<o;++r)if(this.objectsArray[r][e]&&this.objectsArray[r][e]===i){this.objectsArray.splice(r,1);break}};var yt=function(){if(!(this instanceof yt))throw new Error(ot.CONSTRUCT_ERROR);this.tilesArray=[],this.createMainTiles(),this.objectSeedsMap,this.maxDepth=17};yt.getDepthByBoundingBoxMaxSize=function(t){var e;if(void 0!==t)return t<30?e=16:t>=30&&t<50?e=15:t>=50&&t<100?e=14:t>=100&&(e=13),e},yt.maxDistToCameraByDepth=function(t){return t<13?1e4:13===t?9e3:14===t?4e3:15===t?2e3:16===t?1500:17===t?1e3:18===t?250:t>18?150:10},yt.prototype.createMainTiles=function(){var t=this.newSmartTile("AmericaSide");void 0===t.minGeographicCoord&&(t.minGeographicCoord=new j),void 0===t.maxGeographicCoord&&(t.maxGeographicCoord=new j),t.depth=0,t.X=0,t.Y=0,t.minGeographicCoord.setLonLatAlt(-180,-90,0),t.maxGeographicCoord.setLonLatAlt(0,90,0);var e=this.newSmartTile("AsiaSide");void 0===e.minGeographicCoord&&(e.minGeographicCoord=new j),void 0===e.maxGeographicCoord&&(e.maxGeographicCoord=new j),e.depth=0,e.X=1,e.Y=0,e.minGeographicCoord.setLonLatAlt(0,-90,0),e.maxGeographicCoord.setLonLatAlt(180,90,0)},yt.prototype.parseSmartTilesF4dIndexFile=function(t,e,i){var r=0,o=i.readerWriter;void 0===this.smartTileF4dSeedMap&&(this.smartTileF4dSeedMap={});var n=o.readInt32(t,r,r+4);r+=4;for(var a=0;a<n;a++){var s=o.readInt16(t,r,r+2);r+=2;for(var l="",h=0;h<s;h++)l+=String.fromCharCode(new Int8Array(t.slice(r,r+1))[0]),r+=1;var d=o.readUInt8(t,r,r+1);r+=1;var u=o.readInt32(t,r,r+4);r+=4;var f=o.readInt32(t,r,r+4);r+=4;var g=o.readUInt8(t,r,r+1);r+=1;var p=vt.getGeographicExtentOfTileLXY(d,u,f,void 0,c.imageryType.CRS84).getMidPoint();this.smartTileF4dSeedMap[l]={L:d,X:u,Y:f,geographicCoord:p,objectType:"F4dTile",id:"",smartTileType:g,tileName:l,projectFolderName:e,fileLoadState:c.fileLoadState.READY}}return this.smartTileF4dSeedMap},yt.prototype.makeTreeByDepth=function(t,e,i){void 0===t&&(t=17),this.targetDepth=t;for(var r=this.tilesArray.length,o=0;o<r;o++){var n=this.tilesArray[o];void 0===n.nodeSeedsArray&&(n.nodeSeedsArray=[]),n.nodeSeedsArray=e,n.makeTreeByDepth(t,i)}},yt.prototype.putNode=function(t,e,i){if(t=wi(t,this.maxDepth),void 0!==this.tilesArray)for(var r=this.tilesArray.length,o=0;o<r;o++)this.tilesArray[o].putNode(t,e,i)},yt.prototype.putObject=function(t,e,i){if(t=wi(t,this.maxDepth),void 0!==this.tilesArray)for(var r=this.tilesArray.length,o=0;o<r;o++)this.tilesArray[o].putObject(t,e,i)},yt.prototype.getSphereIntersectedTiles=function(t,e,i){if(void 0===i&&(i=this.maxDepth),void 0!==this.tilesArray)for(var r=this.tilesArray.length,o=0;o<r;o++)this.tilesArray[o].getSphereIntersectedTiles(t,e,i)},yt.prototype.deleteTiles=function(){if(this.tilesArray){for(var t=this.tilesArray.length,e=0;e<t;e++)this.tilesArray[e].deleteObjects(),this.tilesArray[e]=void 0;this.tilesArray.length=0}},yt.prototype.resetTiles=function(){this.deleteTiles(),this.createMainTiles()},yt.prototype.newSmartTile=function(t){void 0===this.tilesArray&&(this.tilesArray=[]);var e=new vt(t);return this.tilesArray.push(e),e},yt.prototype.getNeoBuildingById=function(t,e){for(var i,r=0,o=this.tilesArray.length;void 0===i&&r<o;)i=this.tilesArray[r].getNeoBuildingById(t,e),r++;return i},yt.prototype.getBuildingSeedById=function(t,e){for(var i,r=0,o=this.tilesArray.length;void 0===i&&r<o;)i=this.tilesArray[r].getBuildingSeedById(t,e),r++;return i};var mt=function(t){if(e.call(this),!(this instanceof mt))throw new Error(ot.CONSTRUCT_ERROR);if(this.r=0,this.centerPoint=new ur,this.geoLocDataManager,this.color4,this.vboKeyContainer,this.dirty=!0,void 0!==t){var i=t.color;if(i){this.color4=new S,this.color4.setRGBA(i.r,i.g,i.b,i.a);var r=new Q("RENDER_END",function(t,e){t.color4.updateColorAlarm(e.getCurrentTime())});this.addEventListener(r)}}};mt.prototype=Object.create(e.prototype),mt.prototype.constructor=mt,mt.prototype.setCenterPoint=function(t,e,i){this.centerPoint.set(t,e,i)},mt.prototype.setRadius=function(t){this.r=t},mt.prototype.deleteObjects=function(){this.r=void 0,this.centerPoint.deleteObjects(),this.centerPoint=void 0},mt.prototype.distToPoint3D=function(t){return this.centerPoint.distToPoint(t)-this.r},mt.prototype.distToSphere=function(t){var e=t.centerPoint;return this.centerPoint.distToPoint(e)-this.r-t.r},mt.prototype.getVbo=function(t,e){var i;void 0===t&&(t=new Nt);var r=(i=this.makePMesh(i)).getSurfaceIndependentMesh(void 0,!1,!1),o=new rt;return o.rotationAxisAngDeg(90,1,0,0),r.transformByMatrix4(o),r.setColor(0,.5,.9,.3),r.calculateVerticesNormals(),void 0!==e&&!0===e&&r.calculateTexCoordsSpherical(),r.getVbo(t),t},mt.prototype.makeMesh=function(){var t=new xr,e=t.newOuterRing().newElement("ARC");this.sweepSense=1,e.setCenterPosition(0,0),e.setRadius(this.r),e.setStartAngleDegree(91),e.setSweepAngleDegree(179),e.numPointsFor360Deg=8;var i=new wr,r=new dr(0,-1),o=new dr(0,1);i.setPoints(r,o);var n=or.getRevolvedSolidMesh(t,360,8,i,!1,!1,void 0);this.objectsArray.push(n),this.dirty=!1},mt.prototype.makePMesh=function(t){void 0===t&&(t=new nr),t.profile=new Profile;var e,i,r=t.profile,o=r.newOuterRing();(e=o.newElement("POLYLINE")).newPoint2d(.01*-this.r,-this.r),e.newPoint2d(.01*-this.r,this.r);var n;i=o.newElement("ARC"),this.sweepSense=1,i.setCenterPosition(0,0),i.setRadius(this.r),i.setStartAngleDegree(95),i.setSweepAngleDegree(170),i.numPointsFor360Deg=48,n=new wr;var a=new dr(0,-1),s=new dr(0,1);return n.setPoints(a,s),48,t.revolve(r,360,48,n),t},mt.prototype.intersectionSphere=function(t){if(void 0===t)return u.INTERSECTION_OUTSIDE;var e=this.centerPoint.distToPoint(t.centerPoint);return e<this.r?u.INTERSECTION_INSIDE:e<t.r?u.INTERSECTION_INSIDE:e<this.r+t.r?u.INTERSECTION_INTERSECT:u.INTERSECTION_OUTSIDE};var xt=function(){this.high=void 0,this.low=void 0},bt=function(t){if(!(this instanceof bt))throw new Error(ot.CONSTRUCT_ERROR);this.sunGeoLocDataManager=new H,this.lightSourcesArray,this.date,this.sunDirWC,this.bAnimation=!1,this.updated=!1;var e=this.sunGeoLocDataManager.newGeoLocationData("sunPosition"),i=(e=Ei.calculateGeoLocationData(115.31586919332165,10,0,void 0,void 0,void 0,e)).rotMatrix;this.sunDirWC=new Float32Array([-i._floatArrays[8],-i._floatArrays[9],-i._floatArrays[10]]),this.init()};bt.prototype.init=function(){void 0===this.lightSourcesArray&&(this.lightSourcesArray=[]);var t=2,e=new K(t);e.directionalBoxWidth=400,e.geoCoord=new j(126.61255088096084,37.58071053758259,50),this.lightSourcesArray.push(e),(e=new K(t=2)).directionalBoxWidth=400,e.geoCoord=new j(126.61255088096084,37.58071053758259,50),this.lightSourcesArray.push(e)},bt.prototype.getSunDirWC=function(){return this.sunDirWC},bt.prototype.getLight=function(t){if(void 0!==this.lightSourcesArray)return this.lightSourcesArray[t]},bt.prototype.getLightsMatrixFloat32Array=function(){var t=this.lightSourcesArray.length;void 0===this.lightMatrixFloat32Array&&(this.lightMatrixFloat32Array=new Float32Array(16*t));for(var e=0;e<t;e++){var i=this.getLight(e).tMatrix;if(void 0!==i)for(var r=0;r<16;r++)this.lightMatrixFloat32Array[r+16*e]=i._floatArrays[r]}return this.lightMatrixFloat32Array},bt.prototype.getLightsPosLOWFloat32Array=function(){var t=this.lightSourcesArray.length;void 0===this.lightPosLOWFloat32Array&&(this.lightPosLOWFloat32Array=new Float32Array(3*t));for(var e=0;e<t;e++){var i=this.getLight(e).positionLOW;if(void 0!==i)for(var r=0;r<3;r++)this.lightPosLOWFloat32Array[r+3*e]=i[r]}return this.lightPosLOWFloat32Array},bt.prototype.getLightsPosHIGHFloat32Array=function(){var t=this.lightSourcesArray.length;void 0===this.lightPosHIGHFloat32Array&&(this.lightPosHIGHFloat32Array=new Float32Array(3*t));for(var e=0;e<t;e++){var i=this.getLight(e).positionHIGH;if(void 0!==i)for(var r=0;r<3;r++)this.lightPosHIGHFloat32Array[r+3*e]=i[r]}return this.lightPosHIGHFloat32Array},bt.prototype.setDate=function(t){this.date=t,this.calculateSunGeographicCoords()},bt.prototype.setAnimation=function(t){if(void 0!==t){this.bAnimation=!0;t.timeSpeed,t.startHour,t.startMin,t.endHour,t.endMin}},bt.prototype.calculateSunGeographicCoords=function(){var t=180/Math.PI;void 0===this.date&&(this.date=new Date,this.date.setMonth(2),this.date.setHours(15),this.date.setMinutes(30));var e=this.date,i=(e.getFullYear(),new Date(e.getFullYear(),0,0).getTime()),r=new Date(e.getFullYear()+1,0,0).getTime(),o=(e.getTime()-i)/(r-i),n=(.5-(e.getUTCMilliseconds()/1e3+e.getUTCSeconds()+60*(e.getUTCMinutes()+60*e.getUTCHours()))/86400)*Math.PI*2;n*=t;var a=.41*Math.sin((o-.22)*Math.PI*2);a*=t;var s=this.sunGeoLocDataManager.getCurrentGeoLocationData(),l=(s=Ei.calculateGeoLocationData(n,a,0,void 0,void 0,void 0,s)).rotMatrix;this.sunDirWC=new Float32Array([-l._floatArrays[8],-l._floatArrays[9],-l._floatArrays[10]])},bt.prototype.updateSun=function(t,e){if(this.calculateSunGeographicCoords(),void 0!==this.lightSourcesArray&&void 0!==t.frustumVolumeControl){e&&e.date;var i=t.sceneState.getCamera(),r=i.position,o=i.getDirection(),n=t.frustumVolumeControl.getTotalBoundingFrustum(void 0);if(void 0!==n.bFrustumNear&&void 0!==n.bFrustumFar){var a=n.bFrustumNear,s=n.bFrustumFar,l=i.getFrustum(0).tangentOfHalfFovy,h=a;h<0&&(h=0);var d=s-h,c=h+.3*d;c<1&&(c=1);var u=this.lightSourcesArray[0],f=4*Math.abs(l*c),g=new ur(r.x+o.x*c,r.y+o.y*c,r.z+o.z*c);void 0===u.bSphere?u.bSphere=new m(g.x,g.y,g.z,f):(u.bSphere.setCenterPoint(g.x,g.y,g.z),u.bSphere.setRadius(f)),u.lightPosWC=u.bSphere.centerPoint,u.directionalBoxWidth=u.bSphere.r,u.minDistToCam=c-u.bSphere.r,u.maxDistToCam=c+u.bSphere.r,this.updateLight(u);var p=h+.6*d;p<10&&(p=10);u=this.lightSourcesArray[1],f=4*Math.abs(l*p),g=new ur(r.x+o.x*p,r.y+o.y*p,r.z+o.z*p);void 0===u.bSphere?u.bSphere=new m(g.x,g.y,g.z,f):(u.bSphere.setCenterPoint(g.x,g.y,g.z),u.bSphere.setRadius(f)),u.lightPosWC=u.bSphere.centerPoint,u.directionalBoxWidth=2*u.bSphere.r,u.minDistToCam=p-u.bSphere.r,u.maxDistToCam=p+u.bSphere.r,this.updateLight(u),this.updated=!0}}},bt.prototype.updateLight=function(t){var e=this.sunGeoLocDataManager.getCurrentGeoLocationData().getRotMatrixInv();void 0===t.tMatrix&&(t.tMatrix=new rt);var i=t.lightPosWC,r=new rt,o=t.directionalBoxWidth/2,n=-o,a=o,s=-o,l=o,h=-10*o,d=10*o;r._floatArrays=glMatrix.mat4.ortho(r._floatArrays,n,a,s,l,h,d),t.tMatrix=e.getMultipliedByMatrix(r,t.tMatrix),void 0===t.positionHIGH&&(t.positionHIGH=new Float32Array([0,0,0])),void 0===t.positionLOW&&(t.positionLOW=new Float32Array([0,0,0])),Ei.calculateSplited3fv([i.x,i.y,i.z],t.positionHIGH,t.positionLOW)};var Ct=function(){if(!(this instanceof Ct))throw new Error(ot.CONSTRUCT_ERROR);this._depth=0,this._numberName=1,this._terranTile_owner,this.projectsArray=[],this._BR_buildingsArray=[],this._boundingBox,this._pCloudMesh_array=[],this.position,this.radius,this.leftDown_position,this.rightDown_position,this.rightUp_position,this.leftUp_position,this.visibilityType,this.subTiles_array=[],this.terranIndexFile_readed=!1,this.empty_tile=!1,this.fileReading_started=!1,this.fileReading_finished=!1,this.fileArrayBuffer,this.fileBytesReaded=0,this.fileParsingFinished=!1,this.projectsParsed_count=0,this.current_BRProject_parsing,this.current_BRProject_parsing_state=0,this.readWriter};Ct.prototype.newBRProject=function(){var t=new BRBuildingProject;return this._BR_buildingsArray.push(t),t},Ct.prototype.newSubTerranTile=function(){var t=this.subTiles_array.length,e=new Ct;return e._depth=this._depth+1,e._numberName=10*this._numberName+t+1,this.subTiles_array.push(e),e},Ct.prototype.make4subTiles=function(){for(var t=0;t<4;t++)this.newSubTerranTile()},Ct.prototype.setDimensions=function(t,e,i,r){this.longitudeMin=t,this.longitudeMax=e,this.latitudeMin=i,this.latitudeMax=r},Ct.prototype.makeTree=function(t){if(this._depth<t)for(var e=0;e<4;e++)this.newSubTerranTile().makeTree(t)},Ct.prototype.calculatePositionByLonLat=function(){var t=(this.longitudeMax+this.longitudeMin)/2,e=(this.latitudeMax+this.latitudeMin)/2;this.position=Cesium.Cartesian3.fromDegrees(t,e,0),this.leftDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMin,0),this.rightDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMin,0),this.rightUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMax,0),this.leftUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMax,0),this.radius=Cesium.Cartesian3.distance(this.leftDown_position,this.rightUp_position)/2*.9},Ct.prototype.calculatePositionByLonLatSubTiles=function(){this.calculatePositionByLonLat();for(var t=this.subTiles_array.length,e=0;e<t;e++)this.subTiles_array[e].calculatePositionByLonLatSubTiles()},Ct.prototype.parseFileHeader=function(t){var e=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=e)){var i,r=t._header,o=this.fileArrayBuffer,n=this.fileBytesReaded;void 0===this.readWriter&&(this.readWriter=new ge);for(var a=0;a<5;a++)r._version+=String.fromCharCode(new Int8Array(o.slice(n,n+1))),n+=1;r._f4d_version=2,i=this.readWriter.readInt32(o,n,n+4),n+=4;for(a=0;a<i;a++)r._global_unique_id+=String.fromCharCode(new Int8Array(o.slice(n,n+1))),n+=1;r._longitude=new Float64Array(o.slice(n,n+8))[0],n+=8,r._latitude=new Float64Array(o.slice(n,n+8))[0],n+=8,r._elevation=new Float32Array(o.slice(n,n+4))[0],n+=4,r._boundingBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,r._boundingBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,r._boundingBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,r._boundingBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,r._boundingBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,r._boundingBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4;var s=(r._boundingBox.maxZ-r._boundingBox.minZ)/2;r._elevation=45+s-.5;var l=!1;(r._boundingBox.maxX-r._boundingBox.minX>40||r._boundingBox.maxY-r._boundingBox.minY>40)&&(l=!0),!l&&r._boundingBox.maxZ-r._boundingBox.minZ<30&&(r.isSmall=!0);this.readWriter.readUInt8(o,n,n+1);n+=1;var h=Cesium.Cartesian3.fromDegrees(r._longitude,r._latitude,r._elevation),d=Cesium.Ellipsoid.WGS84.cartesianToCartographic(h).height;h=Cesium.Cartesian3.fromDegrees(r._longitude,r._latitude,d),t.buildingPosition=h;Cesium.EncodedCartesian3.encode(h);var c=Cesium.EncodedCartesian3.encode(h.x),u=Cesium.EncodedCartesian3.encode(h.y),f=Cesium.EncodedCartesian3.encode(h.z);t.buildingPositionHIGH=new Float32Array(3),t.buildingPositionHIGH[0]=c.high,t.buildingPositionHIGH[1]=u.high,t.buildingPositionHIGH[2]=f.high,t.buildingPositionLOW=new Float32Array(3),t.buildingPositionLOW[0]=c.low,t.buildingPositionLOW[1]=u.low,t.buildingPositionLOW[2]=f.low,this.fileBytesReaded=n}},Ct.prototype.parseFileSimpleBuilding=function(t){var e=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=e)){void 0===this.readWriter&&(this.readWriter=new ge);var i,r,o=this.fileBytesReaded,n=this.fileArrayBuffer;void 0===t._simpleBuilding_v1&&(t._simpleBuilding_v1=new SimpleBuildingV1);var a=t._simpleBuilding_v1,s=this.readWriter.readUInt32(n,o,o+4);o+=4;for(var l=0;l<s;l++){var h=a.newSimpleObject()._vtCacheKeys_container.newVertexTexcoordsArraysCacheKey(),d=this.readWriter.readUInt32(n,o,o+4);i=o+=4,r=o+20*d,h.verticesArrayBuffer=n.slice(i,r),o+=20*d,h._vertices_count=d}this.readWriter.readInt32(n,o,o+4);o+=4,this.fileBytesReaded=o}},Ct.prototype.parseFileNailImage=function(t,e){void 0===t._simpleBuilding_v1&&(t._simpleBuilding_v1=new SimpleBuildingV1),void 0===this.readWriter&&(this.readWriter=new ge);var i=t._simpleBuilding_v1,r=this.fileBytesReaded,o=this.fileArrayBuffer,n=this.readWriter.readUInt32(o,r,r+4),a=r+=4,s=r+n;i.textureArrayBuffer=new Uint8Array(o.slice(a,s)),r+=n,this.fileBytesReaded=r},Ct.prototype.parseFileAllBuildings=function(t){var e=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=e)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new ge);var i=this.fileArrayBuffer,r=this.readWriter.readInt32(i,0,4);this.fileBytesReaded+=4,0===r&&(this.empty_tile=!0);for(var o=0;o<r;o++){var n=this.fileBytesReaded;this.fileBytesReaded=n,this.current_BRProject_parsing=this.newBRProject(),this.parseFileHeader(this.current_BRProject_parsing),this.parseFileSimpleBuilding(this.current_BRProject_parsing),this.parseFileNailImage(this.current_BRProject_parsing,t)}this.fileParsingFinished=!0,this.fileArrayBuffer=null}},Ct.prototype.parseFileOneBuilding=function(t,e){var i=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=i)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new ge);var r=this.readWriter.readInt32(this.fileArrayBuffer,0,4);if(this.projectsParsed_count>=r)return this.fileParsingFinished=!0,void(this.fileBytesReaded=null);0===this.current_BRProject_parsing_state&&(0===this.projectsParsed_count&&(this.fileBytesReaded=4),this.current_BRProject_parsing=this.newBRProject());var o=this.current_BRProject_parsing;0===this.current_BRProject_parsing_state?(this.parseFileHeader(o),this.current_BRProject_parsing_state=1):1===this.current_BRProject_parsing_state?e.backGround_imageReadings_count<1&&(this.parseFile_simpleBuilding_old(t,o),this.current_BRProject_parsing_state=2):2===this.current_BRProject_parsing_state&&e.backGround_imageReadings_count<1&&(this.parseFile_nailImage_old(t,o,e),this.current_BRProject_parsing_state=0,this.projectsParsed_count++,e.backGround_imageReadings_count++)}},Ct.prototype.setDimensionsSubTiles=function(){var t=this.subTiles_array.length;if(4===t){var e=(this.longitudeMax+this.longitudeMin)/2,i=(this.latitudeMax+this.latitudeMin)/2;this.subTiles_array[0].setDimensions(this.longitudeMin,e,this.latitudeMin,i),this.subTiles_array[1].setDimensions(e,this.longitudeMax,this.latitudeMin,i),this.subTiles_array[2].setDimensions(e,this.longitudeMax,i,this.latitudeMax),this.subTiles_array[3].setDimensions(this.longitudeMin,e,i,this.latitudeMax);for(var r=0;r<t;r++)this.subTiles_array[r].setDimensionsSubTiles()}},Ct.prototype.getSmallestTiles=function(t){if(this.subTiles_array.length>0)for(var e=0;e<this.subTiles_array.length;e++)this.subTiles_array[e].visibilityType=this.visibilityType,this.subTiles_array[e].getSmallestTiles(t);else this.empty_tile.length||t.push(this)},Ct.prototype.getIntersectedSmallestTiles=function(t,e,i){var r=[];this.getIntersectedTiles(t,r,i);for(var o=r.length,n=0;n<o;n++)r[n].getSmallestTiles(e);r.length=0},Ct.prototype.getIntersectedTiles=function(t,e,i){if(void 0!==this.position)if(void 0===i&&(i=new Cesium.BoundingSphere),i.radius=this.radius,i.center.x=this.position.x,i.center.y=this.position.y,i.center.z=this.position.z,this.visibilityType=t.computeVisibility(i),this.visibilityType===Cesium.Intersect.OUTSIDE);else if(this.visibilityType===Cesium.Intersect.INSIDE)e.push(this);else if(this.subTiles_array.length>0)for(var r=0;r<this.subTiles_array.length;r++)this.subTiles_array[r].getIntersectedTiles(t,e);else e.push(this)};var At=function(t){if(!(this instanceof At))throw new Error(ot.CONSTRUCT_ERROR);this.textureTypeName="",this.textureImageFileName="",this.texId,this.fileLoadState=c.fileLoadState.READY,this.imageBinaryData,this.imageWidth=32,this.imageHeight=32,this.url,this.blob,this.opacity=1,this.activeTextureType=1,t&&void 0!==t.opacity&&(this.opacity=t.opacity)};At.prototype.setActiveTextureType=function(t){this.activeTextureType=t},At.prototype.setOpacity=function(t){this.opacity=t},At.prototype.deleteObjects=function(t){if(this.textureTypeName=void 0,this.textureImageFileName=void 0,void 0!==this.texId)if(this.texId instanceof WebGLTexture)t.deleteTexture(this.texId);else;this.texId=void 0,this.fileLoadState=void 0,this.imageBinaryData=void 0},At.createTexture=function(t,e,i,r,o){var n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),i instanceof Uint8Array?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,o,0,t.RGBA,t.UNSIGNED_BYTE,i):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.bindTexture(t.TEXTURE_2D,null),n};var Tt=function(e){if(Ri(e))throw new Error(ot.REQUIRED_EMPTY_ERROR("url or urlFunction"));t.call(this),this._id=Pi();var i=wi(e.maxZoom,18),r=wi(e.minZoom,0);this._freezeAttr={maxZoom:i,minZoom:r},Object.freeze(this._freezeAttr),this._show=wi(e.show,!0),this._opacity=wi(e.opacity,1),e.minAltitude&&(this.minAltitude=e.minAltitude),e.maxAltitude&&(this.maxAltitude=e.maxAltitude)};Tt.prototype=Object.create(t.prototype),Tt.prototype.constructor=Tt,Tt.EVENT_TYPE={CHANGESHOW:"changeshow",CHANGEOPACITY:"changeopacity"},Object.defineProperties(Tt.prototype,{maxZoom:{get:function(){return this._freezeAttr.maxZoom}},minZoom:{get:function(){return this._freezeAttr.minZoom}},show:{get:function(){return this._show},set:function(t){var e=JSON.parse(t);"boolean"==typeof e&&this._show!==e&&(this._show=e,this.emit(Tt.EVENT_TYPE.CHANGESHOW,this))}},opacity:{get:function(){return this._opacity},set:function(t){this._opacity=t,this.emit(Tt.EVENT_TYPE.CHANGEOPACITY,this)}}}),Tt.prototype.getUrl=function(){return Ai()};var Mt=function(t){if(!(this instanceof Mt))throw new Error(ot.CONSTRUCT_ERROR);this._texturesLoaded=[],this.texturesMap={}};Mt.handleTextureLoaded=function(t,e,i){if(void 0===i&&(i=!0),void 0!==e){var r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),r}},Mt.prototype.getTexture=function(t){if(void 0!==t&&!(t<0)&&void 0!==this._texturesLoaded[t])return this._texturesLoaded[t]},Mt.prototype.getOrNewTexture=function(t){if(void 0!==t&&!(t<0)){if(void 0===this._texturesLoaded[t]){var e=new At;this._texturesLoaded[t]=e}return this._texturesLoaded[t]}},Mt.prototype.getTextureByName=function(t){return texturesMap[t]},Mt.loadTexture=function(t,e,i,r){var o=new Image;e.fileLoadState=c.fileLoadState.LOADING_STARTED,o.onload=function(){var t=i.getGl();void 0===e.texId&&(e.texId=t.createTexture()),void 0===r&&(r=!1),_t(t,o,e.texId,r),e.fileLoadState=c.fileLoadState.BINDING_FINISHED},o.onerror=function(){e.fileLoadState=c.fileLoadState.LOAD_FAILED},o.src=t},Mt.newWebGlTextureByBlob=function(t,e,i){var r=URL.createObjectURL(e);i.fileLoadState=c.fileLoadState.BINDING_STARTED;var o=new Image;o.onload=function(){URL.revokeObjectURL(r),i.texId=Mt.handleTextureLoaded(t,o),i.fileLoadState=c.fileLoadState.BINDING_FINISHED},o.src=r},Mt.newWebGlTextureByEmbeddedImage=function(t,e,i){var r=new Blob([e],{type:"application/octet-binary"});Mt.newWebGlTextureByBlob(t,r,i)};var Pt=function(t){if(!(this instanceof Pt))throw new Error(ot.CONSTRUCT_ERROR);this._magoManager=t,this._gl=this._magoManager.getGl(),this._textureAux_1x1,this._noiseTexture_4x4,this.texturesManager};function wt(t){return Math.log(t)/Math.log(2)%1==0}function _t(t,e,i,r){void 0===r&&(r=!0),i.imageWidth=e.width,i.imageHeight=e.height,wt(i.imageWidth)&&wt(i.imageHeight)?(t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_NEAREST),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)):(t.bindTexture(t.TEXTURE_2D,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null))}Pt.prototype.getGl=function(){return void 0===this._gl&&(this._gl=this._magoManager.getGl()),this._gl},Pt.prototype.getTextureAux1x1=function(){if(void 0===this._textureAux_1x1){var t=this.getGl();this._textureAux_1x1=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this._textureAux_1x1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([150,150,150,255])),t.bindTexture(t.TEXTURE_2D,null)}return this._textureAux_1x1},Pt.prototype.getNoiseTexture4x4=function(){if(void 0===this._noiseTexture_4x4){var t=this.getGl();this._noiseTexture_4x4=function(t,e,i,r){var o=t.createTexture();if(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o),void 0===r&&(r=new Uint8Array(64)),4===e&&4===i){var n=0;r[n]=50,r[++n]=58,r[++n]=229,r[++n]=120,r[++n]=212,r[++n]=236,r[++n]=251,r[++n]=148,r[++n]=75,r[++n]=92,r[++n]=246,r[++n]=59,r[++n]=197,r[++n]=95,r[++n]=235,r[++n]=216,r[++n]=130,r[++n]=124,r[++n]=215,r[++n]=154,r[++n]=25,r[++n]=41,r[++n]=221,r[++n]=146,r[++n]=187,r[++n]=217,r[++n]=130,r[++n]=199,r[++n]=142,r[++n]=112,r[++n]=61,r[++n]=135,r[++n]=67,r[++n]=125,r[++n]=159,r[++n]=153,r[++n]=215,r[++n]=49,r[++n]=49,r[++n]=69,r[++n]=126,r[++n]=168,r[++n]=61,r[++n]=215,r[++n]=21,r[++n]=93,r[++n]=183,r[++n]=1,r[++n]=125,r[++n]=44,r[++n]=22,r[++n]=130,r[++n]=197,r[++n]=118,r[++n]=109,r[++n]=23,r[++n]=195,r[++n]=4,r[++n]=148,r[++n]=245,r[++n]=124,r[++n]=125,r[++n]=185,r[++n]=28,n++}else for(var a=0;a<i;a++)for(var s=0;s<e;s++)r[4*(a*e+s)+0]=Math.floor(255*Math.random()),r[4*(a*e+s)+1]=Math.floor(255*Math.random()),r[4*(a*e+s)+2]=Math.floor(255*Math.random()),r[4*(a*e+s)+3]=Math.floor(255*Math.random());return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null),o.width=e,o.height=i,o}(t,4,4,void 0)}return this._noiseTexture_4x4};var St=function(){if(!(this instanceof St))throw new Error(ot.CONSTRUCT_ERROR);this.vertexMatrix=new kr,this.vertexList=this.vertexMatrix.newVertexList(),this.triSurfacesArray=[]};St.prototype.newTriSurface=function(){var t=new Lt;return this.triSurfacesArray.push(t),t},St.prototype.invertTrianglesSenses=function(){for(var t=this.triSurfacesArray.length,e=0;e<t;e++)this.triSurfacesArray[e].invertTrianglesSenses()},St.prototype.getVBOArrayModePosNorCol=function(t,e){void 0===t&&(t=new Ft),void 0===t.posVboDataArray&&(t.posVboDataArray=[]),void 0===t.norVboDataArray&&(t.norVboDataArray=[]),void 0===t.colVboDataArray&&(t.colVboDataArray=[]);var i,r,o,n,a,s,l=[],h=[],d=[];t.vertexCount=0;for(var c=this.triSurfacesArray.length,u=0;u<c;u++){a=(s=this.triSurfacesArray[u]).trianglesArray.length;for(var f=0;f<a;f++)void 0===(n=s.trianglesArray[f]).normal&&n.calculatePlaneNormal(),i=n.vertex0,r=n.vertex1,o=n.vertex2,l.push(i.point3d.x),l.push(i.point3d.y),l.push(i.point3d.z),l.push(r.point3d.x),l.push(r.point3d.y),l.push(r.point3d.z),l.push(o.point3d.x),l.push(o.point3d.y),l.push(o.point3d.z),h.push(n.normal.x),h.push(n.normal.y),h.push(n.normal.z),h.push(n.normal.x),h.push(n.normal.y),h.push(n.normal.z),h.push(n.normal.x),h.push(n.normal.y),h.push(n.normal.z),void 0===i.color4?(d.push(200),d.push(200),d.push(200),d.push(200),d.push(200),d.push(200),d.push(200),d.push(200),d.push(200),d.push(200),d.push(200),d.push(200)):(d.push(i.color4.r),d.push(i.color4.g),d.push(i.color4.b),d.push(i.color4.a),d.push(r.color4.r),d.push(r.color4.g),d.push(r.color4.b),d.push(r.color4.a),d.push(o.color4.r),d.push(o.color4.g),d.push(o.color4.b),d.push(o.color4.a)),t.vertexCount+=3}var g=t.vertexCount,p=new Float32Array(3*g);p.set(l);var v=new Int8Array(3*g);v.set(h);var y=new Uint8Array(4*g);return y.set(d),t.setDataArrayPos(p,e),t.setDataArrayNor(v,e),t.setDataArrayCol(y,e),t};var Lt=function(){if(!(this instanceof Lt))throw new Error(ot.CONSTRUCT_ERROR);this.vertexList,this.trianglesArray,this.trianglesList};Lt.prototype.newTriangle=function(){void 0===this.trianglesArray&&(this.trianglesArray=[]);var t=new Or;return this.trianglesArray.push(t),t},Lt.prototype.invertTrianglesSenses=function(){for(var t=this.trianglesArray.length,e=0;e<t;e++)this.trianglesArray[e].invertSense()};var Rt=function(t,e){if(!(this instanceof Rt))throw new Error(ot.CONSTRUCT_ERROR);this.dataArray,this.dataLength,this.dataGlType,this.key,this.dataTarget,this.dataTarget=void 0!==t?t:34962,this.dataDimensions,this.dataStride=0,this.dataOffSet=0,this.normalized=!1,this.id,this.bKeepDataArray=!1,e&&void 0!==e.bKeepDataArray&&(this.bKeepDataArray=e.bKeepDataArray),this.attribLocation};Rt.prototype.deleteGlObjects=function(t){if(void 0!==this.key){var e=t.gl;this.dataTarget===e.ARRAY_BUFFER?t.storeClassifiedBufferKey(e,this.key,this.dataLength):this.dataTarget===e.ELEMENT_ARRAY_BUFFER&&t.storeClassifiedElementKey(e,this.key,this.dataLength)}this.dataArray=void 0,this.dataLength=void 0,this.dataGlType=void 0,this.key=void 0,this.dataTarget=void 0},Rt.prototype.setDataArray=function(t,e,i,r,o){if(void 0!==t){this.dataGlType=Rt.getGlTypeOfArray(t);var n=t.length,a=n;r.enableMemoryManagement?(a=r.getClassifiedBufferSize(n),this.dataArray=Rt.newTypedArray(a,this.dataGlType),this.dataArray.set(t)):this.dataArray=t,this.dataLength=n,this.dataDimensions=e,this.normalized=i,this.attribLocation=o}},Rt.prototype.bindData=function(t,e,i){if(void 0===t)return!1;var r=t.gl;return!!this.isReady(r,i)&&(t.enableVertexAttribArray(e)?(this.key!==t.lastVboKeyBindedMap[e]&&(r.bindBuffer(this.dataTarget,this.key),r.vertexAttribPointer(e,this.dataDimensions,this.dataGlType,this.normalized,this.dataStride,this.dataOffSet),t.lastVboKeyBindedMap[e]=this.key),!0):(t.disableVertexAttribArray(e),!1))},Rt.prototype.isReady=function(t,e){return void 0!==this.key||void 0!==this.dataArray&&(void 0===this.dataLength&&(this.dataLength=this.dataArray.length),this.key=e.getClassifiedBufferKey(t,this.dataLength),void 0!==this.key&&(t.bindBuffer(this.dataTarget,this.key),t.bufferData(this.dataTarget,this.dataArray,t.STATIC_DRAW),this.bKeepDataArray||(this.dataArray=void 0),!0))},Rt.getGlTypeOfArray=function(t){var e=-1;return t.constructor===Float32Array?e=5126:t.constructor===Int16Array?e=5122:t.constructor===Uint16Array?e=5123:t.constructor===Int8Array?e=5120:t.constructor===Uint8Array&&(e=5121),e},Rt.newTypedArray=function(t,e){var i;return 5126===e?i=new Float32Array(t):5122===e?i=new Int16Array(t):5123===e?i=new Uint16Array(t):5120===e?i=new Int8Array(t):5121===e&&(i=new Uint8Array(t)),i},Rt.getByteSizeByGlType=function(t){return 5126===t?4:5122===t?2:5123===t?2:5120===t?1:5121===t?1:void 0};var Dt=function(t,e){if(!(this instanceof Dt))throw new Error(ot.CONSTRUCT_ERROR);var i;this.vboKeysStoreMap={},this.bufferSizes=t,this.minSize=e,this.maxSize=t[t.length-1],this.totalBytesUsed=0;for(var r=t.length,o=0;o<r;o++)i=new Et(t[o]),this.vboKeysStoreMap[t[o]]=i,t[o]>this.maxSize&&(this.maxSize=t[o])};Dt.prototype.getClassifiedBufferKey=function(t,e,i,r){var o=this.getClosestBufferSize(e),n=this.vboKeysStoreMap[o];return n?n.getBufferKey(t,this,i,r):-1},Dt.prototype.storeClassifiedBufferKey=function(t,e){var i=this.vboKeysStoreMap[e];i&&i.storeBufferKey(t)},Dt.prototype.getClosestBufferSize=function(t){if(!this.isInsideRange(t))return-1;for(var e=this.bufferSizes.length,i=0;i<e;i++)if(t<=this.bufferSizes[i])return this.bufferSizes[i];return-1},Dt.prototype.isInsideRange=function(t){return!(t>this.maxSize||t<this.minSize)};var Et=function(t){if(!(this instanceof Et))throw new Error(ot.CONSTRUCT_ERROR);this.classifiedSize=t,this.vboKeysArray=[],this.keysCreated=0};Et.prototype.getBufferKey=function(t,e,i,r){if(this.vboKeysArray.length>0)return o=this.vboKeysArray.pop();if(!r){var o=t.createBuffer();return this.keysCreated+=1,e.totalBytesUsed+=this.classifiedSize,i.totalBytesUsed+=this.classifiedSize,o}},Et.prototype.storeBufferKey=function(t){this.vboKeysArray.push(t)};var It=function(){if(!(this instanceof It))throw new Error(ot.CONSTRUCT_ERROR);this.totalBytesUsed=0,this.bytesLimit=1e3,this.vboKeysNationsArray=[],this.vboKeyNation12to128=new Dt(new Uint32Array([12,16,32,48,64,76,92,128]),0),this.vboKeysNationsArray.push(this.vboKeyNation12to128),this.vboKeyNation200to1000=new Dt(new Uint32Array([200,300,400,500,600,700,800,900,1e3]),129),this.vboKeysNationsArray.push(this.vboKeyNation200to1000),this.vboKeyNation1500to6000=new Dt(new Uint32Array([1500,2e3,2500,3e3,3500,4e3,4500,5e3,5500,6e3]),1001),this.vboKeysNationsArray.push(this.vboKeyNation1500to6000),this.vboKeyNation7000to16000=new Dt(new Uint32Array([7e3,8e3,9e3,1e4,11e3,12e3,13e3,14e3,15e3,16e3]),6001),this.vboKeysNationsArray.push(this.vboKeyNation7000to16000),this.vboKeyNation20000to56000=new Dt(new Uint32Array([2e4,24e3,28e3,32e3,36e3,4e4,44e3,48e3,52e3,56e3]),16001),this.vboKeysNationsArray.push(this.vboKeyNation20000to56000),this.vboKeyNation60000to150000=new Dt(new Uint32Array([6e4,7e4,8e4,9e4,1e5,11e4,12e4,13e4,14e4,15e4]),56001),this.vboKeysNationsArray.push(this.vboKeyNation60000to150000),this.vboKeyNation200000to1100000=new Dt(new Uint32Array([2e5,3e5,4e5,5e5,6e5,7e5,8e5,9e5,1e6,11e5]),150001),this.vboKeysNationsArray.push(this.vboKeyNation200000to1100000),this.vboKeyNation1500000to3000000=new Dt(new Uint32Array([15e5,2e6,25e5,3e6,6e6,12e6,24e6,36e6,6e7]),1100001),this.vboKeysNationsArray.push(this.vboKeyNation1500000to3000000)};It.prototype.getClassifiedBufferKey=function(t,e){var i=!1;this.totalBytesUsed>this.bytesLimit&&(i=!0);var r=this.getKeyNationBySize(e),o=void 0;return r&&(o=r.getClassifiedBufferKey(t,e,this,i)),o},It.prototype.storeClassifiedBufferKey=function(t,e){var i=this.getKeyNationBySize(e);i&&i.storeClassifiedBufferKey(t,e)},It.prototype.getKeyNationBySize=function(t){for(var e=this.vboKeysNationsArray.length,i=0;i<e;){if(this.vboKeysNationsArray[i].isInsideRange(t))return this.vboKeysNationsArray[i];i++}return-1},It.prototype.getClassifiedBufferSize=function(t){var e=this.getKeyNationBySize(t),i=-1;return-1!==e&&(i=e.getClosestBufferSize(t)),i};var Ot=function(){if(!(this instanceof Ot))throw new Error(ot.CONSTRUCT_ERROR);this.gl,this.enableMemoryManagement=wi(f.getPolicy().enableMemoryManagement,!1),this.buffersKeyWorld=new It,this.elementKeyWorld=new It,this.buffersKeyWorld.bytesLimit=8e8,this.elementKeyWorld.bytesLimit=3e8,this.currentMemoryUsage=0};Ot.prototype.isGpuMemFull=function(){return this.buffersKeyWorld.totalBytesUsed>this.buffersKeyWorld.bytesLimit||this.elementKeyWorld.totalBytesUsed>this.elementKeyWorld.bytesLimit},Ot.prototype.getClassifiedBufferKey=function(t,e){if(this.enableMemoryManagement){var i=this.buffersKeyWorld.getClassifiedBufferKey(t,e);return void 0!==i&&(this.currentMemoryUsage+=e),i}return this.currentMemoryUsage+=e,t.createBuffer()},Ot.prototype.storeClassifiedBufferKey=function(t,e,i){this.enableMemoryManagement?this.buffersKeyWorld.storeClassifiedBufferKey(e,i):t.deleteBuffer(e),this.currentMemoryUsage-=i,this.currentMemoryUsage<0&&(this.currentMemoryUsage=0)},Ot.prototype.getClassifiedElementKey=function(t,e){return this.enableMemoryManagement?this.elementKeyWorld.getClassifiedBufferKey(t,e):t.createBuffer()},Ot.prototype.storeClassifiedElementKey=function(t,e,i){this.enableMemoryManagement?this.elementKeyWorld.storeClassifiedBufferKey(e,i):t.deleteBuffer(e)},Ot.prototype.getClassifiedBufferSize=function(t){return this.enableMemoryManagement?this.buffersKeyWorld.getClassifiedBufferSize(t):t};var Ft=function(){if(!(this instanceof Ft))throw new Error(ot.CONSTRUCT_ERROR);this.indicesCount=-1,this.vertexCount=-1,this.bigTrianglesIndicesCount=-1,this.vboBufferPos,this.vboBufferNor,this.vboBufferIdx,this.vboBufferCol,this.vboBufferTCoord,this.vboBufferCustomMap,this.keepDataArrayBuffers,this.keepedColDataArray,this.keepedIdxDataArray,this.keepedNorDataArray,this.keepedPosDataArray,this.keepedTexCoordDataArray};Ft.prototype.setKeepDataArray=function(t){this.keepDataArrayBuffers=t},Ft.prototype.stepOverPosNorIdx=function(t,e,i,r){var o=e.readUInt32(t,r,r+4),n=3*o;r+=4,r+=4*n;var a=3*(o=e.readUInt32(t,r,r+4));r+=4,r+=1*a;var s=e.readUInt32(t,r,r+4);r+=4;var l=e.readUInt8(t,r,r+1);r+=1;for(var h=0;h<l;h++)r+=4;for(h=0;h<l;h++)r+=4;return r,r+2*s,r+=2*s},Ft.prototype.readPositions=function(t,e,i){var r=new Uint16Array(t.slice(i,i+2))[0];i+=2;var o=new Uint8Array(t.slice(i,i+1))[0];i+=1;var n=new Uint32Array(t.slice(i,i+4))[0]*o,a=i+=4,s=Rt.getByteSizeByGlType(r),l=i+s*n,h=new Float32Array(t.slice(a,l));return i+=s*n,this.setDataArrayPos(h,e),i},Ft.prototype.readNormals=function(t,e,i){var r=new Uint16Array(t.slice(i,i+2))[0];i+=2;var o=new Uint8Array(t.slice(i,i+1))[0];i+=1;var n=new Uint32Array(t.slice(i,i+4))[0]*o,a=i+=4,s=Rt.getByteSizeByGlType(r),l=i+s*n,h=new Int8Array(t.slice(a,l));return i+=s*n,this.setDataArrayNor(h,e),i},Ft.prototype.readTexCoords=function(t,e,i){var r=new Uint16Array(t.slice(i,i+2))[0];i+=2;var o=new Uint8Array(t.slice(i,i+1))[0];i+=1;var n=new Uint32Array(t.slice(i,i+4))[0]*o,a=i+=4,s=Rt.getByteSizeByGlType(r),l=i+s*n,h=new Float32Array(t.slice(a,l));return i+=s*n,this.setDataArrayTexCoord(h,e),i},Ft.prototype.readColors=function(t,e,i){var r=new Uint16Array(t.slice(i,i+2))[0];i+=2;var o=new Uint8Array(t.slice(i,i+1))[0];i+=1;var n=new Uint32Array(t.slice(i,i+4))[0]*o,a=i+=4,s=Rt.getByteSizeByGlType(r),l=i+s*n,h=new Int8Array(t.slice(a,l));return i+=s*n,this.setDataArrayCol(h,e),i},Ft.prototype.readPosNorIdx=function(t,e,i){var r,o,n=new Uint32Array(t.slice(i,i+4))[0];i+=4,this.vertexCount=n;var a=3*n;r=i,o=i+4*a;var s=new Float32Array(t.slice(r,o));this.setDataArrayPos(s,e),i+=4*a;var l=3*(n=new Uint32Array(t.slice(i,i+4))[0]);r=i+=4,o=i+1*l;var h=new Int8Array(t.slice(r,o));this.setDataArrayNor(h,e),i+=1*l;var d=new Uint32Array(t.slice(i,i+4))[0];i+=4;var c=new Uint8Array(t.slice(i,i+1))[0];i+=1;for(var u=[],f=0;f<c;f++)u.push(new Float32Array(t.slice(i,i+4))),i+=4;var g=[];for(f=0;f<c;f++)g.push(new Uint32Array(t.slice(i,i+4))),i+=4;var p=g[c-1];this.bigTrianglesIndicesCount=p,r=i,o=i+2*d;var v=new Uint16Array(t.slice(r,o));return this.setDataArrayIdx(v,e),i+=2*d},Ft.prototype.bindDataCustom=function(t,e,i){if(void 0===t||void 0===this.vboBufferCustomMap)return!1;var r=this.vboBufferCustomMap[i];return r.bindData(t,r.attribLocation,e)},Ft.prototype.bindDataPosition=function(t,e){return void 0!==t&&this.vboBufferPos.bindData(t,t.position3_loc,e)},Ft.prototype.bindDataNormal=function(t,e){if(void 0===t)return!1;var i=this.vboBufferNor;return void 0===i?(t.disableVertexAttribArray(t.normal3_loc),!0):i.bindData(t,t.normal3_loc,e)},Ft.prototype.bindDataTexCoord=function(t,e){if(void 0===t)return!1;var i=this.vboBufferTCoord;return void 0===i?(t.disableVertexAttribArray(t.texCoord2_loc),!0):i.bindData(t,t.texCoord2_loc,e)},Ft.prototype.bindDataColor=function(t,e){if(void 0===t)return!1;var i=this.vboBufferCol;return void 0===i?(t.disableVertexAttribArray(t.color4_loc),!0):i.bindData(t,t.color4_loc,e)},Ft.prototype.bindDataIndice=function(t,e){if(void 0===t)return!1;var i=t.gl,r=this.vboBufferIdx;return!!r.isReady(i,e)&&(r.key!==t.lastVboKeyBindedMap.elemIdx&&(i.bindBuffer(r.dataTarget,r.key),t.lastVboKeyBindedMap.elemIdx=r.key),!0)},Ft.prototype.getVboCustom=function(t){if(void 0!==this.vboBufferCustomMap)return this.vboBufferCustomMap[t]},Ft.prototype.setDataArrayCustom=function(t,e,i,r,o){if(void 0!==t&&void 0!==i&&void 0!==r&&void 0!==o){void 0===this.vboBufferCustomMap&&(this.vboBufferCustomMap={});var n=e.gl,a=new Rt(n.ARRAY_BUFFER);a.setDataArray(t,i,!1,e,o),this.vboBufferCustomMap[r]=a}},Ft.prototype.setDataArrayPos=function(t,e,i,r){if(void 0!==t){var o=e.gl;void 0===this.vboBufferPos&&(this.vboBufferPos=new Rt(o.ARRAY_BUFFER)),void 0===i&&(i=3);this.vboBufferPos.setDataArray(t,i,!1,e),this.vertexCount=this.vboBufferPos.dataLength/i,this.keepDataArrayBuffers&&(this.keepedPosDataArray=t)}},Ft.prototype.setDataArrayNor=function(t,e){if(void 0!==t){var i=e.gl;void 0===this.vboBufferNor&&(this.vboBufferNor=new Rt(i.ARRAY_BUFFER));this.vboBufferNor.setDataArray(t,3,!0,e),this.keepDataArrayBuffers&&(this.keepedNorDataArray=t)}},Ft.prototype.setDataArrayIdx=function(t,e){if(void 0!==t){var i=e.gl;void 0===this.vboBufferIdx&&(this.vboBufferIdx=new Rt(i.ELEMENT_ARRAY_BUFFER));this.vboBufferIdx.setDataArray(t,1,!1,e),this.indicesCount=this.vboBufferIdx.dataLength,this.keepDataArrayBuffers&&(this.keepedIdxDataArray=t)}},Ft.prototype.setDataArrayCol=function(t,e){if(void 0!==t){var i=e.gl;void 0===this.vboBufferCol&&(this.vboBufferCol=new Rt(i.ARRAY_BUFFER));this.vboBufferCol.setDataArray(t,4,!0,e),this.keepDataArrayBuffers&&(this.keepedColDataArray=t)}},Ft.prototype.setDataArrayTexCoord=function(t,e){if(void 0!==t){var i=e.gl;void 0===this.vboBufferTCoord&&(this.vboBufferTCoord=new Rt(i.ARRAY_BUFFER));this.vboBufferTCoord.setDataArray(t,2,!1,e),this.keepDataArrayBuffers&&(this.keepedTexCoordDataArray=t)}},Ft.prototype.deleteGlObjects=function(t,e){void 0!==this.vboBufferPos&&(this.vboBufferPos.deleteGlObjects(e),this.vboBufferPos=void 0),void 0!==this.vboBufferNor&&(this.vboBufferNor.deleteGlObjects(e),this.vboBufferNor=void 0),void 0!==this.vboBufferIdx&&(this.vboBufferIdx.deleteGlObjects(e),this.vboBufferIdx=void 0),void 0!==this.vboBufferCol&&(this.vboBufferCol.deleteGlObjects(e),this.vboBufferCol=void 0),void 0!==this.vboBufferTCoord&&(this.vboBufferTCoord.deleteGlObjects(e),this.vboBufferTCoord=void 0),this.keepedColDataArray=void 0,this.keepedIdxDataArray=void 0,this.keepedNorDataArray=void 0,this.keepedPosDataArray=void 0,this.keepedTexCoordDataArray=void 0};var Nt=function(){if(!(this instanceof Nt))throw new Error(ot.CONSTRUCT_ERROR);this.vboCacheKeysArray=[]};Nt.prototype.newVBOVertexIdxCacheKey=function(){void 0===this.vboCacheKeysArray&&(this.vboCacheKeysArray=[]);var t=new Ft;return this.vboCacheKeysArray.push(t),t},Nt.prototype.deleteGlObjects=function(t,e){if(void 0!==this.vboCacheKeysArray){for(var i=this.vboCacheKeysArray.length,r=0;r<i;r++)this.vboCacheKeysArray[r].deleteGlObjects(t,e),this.vboCacheKeysArray[r]=void 0;this.vboCacheKeysArray.length=0,this.vboCacheKeysArray=void 0}},Nt.prototype.getVbosCount=function(){return void 0===this.vboCacheKeysArray?0:this.vboCacheKeysArray.length},Nt.prototype.getVboKey=function(t){if(void 0!==this.vboCacheKeysArray)return this.vboCacheKeysArray[t]};var Bt=function(){if(!(this instanceof Bt))throw new Error(ot.CONSTRUCT_ERROR);this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisiblesAux=[],this.currentVisibleNativeObjects={opaquesArray:[],transparentsArray:[],excavationsArray:[],vectorTypeArray:[],pointTypeArray:[]},this.currentVisiblesToPrepare=[],this.bSphere,this.bFrustumNear,this.bFrustumFar};Bt.prototype.initArrays=function(){this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisiblesAux=[],this.currentVisibleNativeObjects={opaquesArray:[],transparentsArray:[],excavationsArray:[],vectorTypeArray:[],pointTypeArray:[]},this.currentVisiblesToPrepare=[],this.bSphere=void 0,this.bFrustumNear=void 0,this.bFrustumFar=void 0},Bt.prototype.clear=function(){this.currentVisibles0.length=0,this.currentVisibles1.length=0,this.currentVisibles2.length=0,this.currentVisibles3.length=0,this.currentVisiblesAux.length=0,this.currentVisibleNativeObjects.opaquesArray.length=0,this.currentVisibleNativeObjects.transparentsArray.length=0,this.currentVisibleNativeObjects.excavationsArray.length=0,this.currentVisibleNativeObjects.vectorTypeArray.length=0,this.currentVisibleNativeObjects.pointTypeArray.length=0,this.currentVisiblesToPrepare.length=0,this.bSphere=void 0,this.bFrustumNear=void 0,this.bFrustumFar=void 0},Bt.prototype.getAllVisibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1,this.currentVisibles2,this.currentVisibles3)},Bt.prototype.get01Visibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1)},Bt.prototype.hasRenderables=function(){return this.currentVisibles0.length>0||this.currentVisibles1.length>0||this.currentVisibles2.length>0||this.currentVisibles3.length>0||this.currentVisiblesAux.length>0||this.currentVisibleNativeObjects.opaquesArray.length>0||this.currentVisibleNativeObjects.transparentsArray.length>0||this.currentVisibleNativeObjects.excavationsArray.length>0||this.currentVisibleNativeObjects.vectorTypeArray.length>0||this.currentVisibleNativeObjects.pointTypeArray.length>0},Bt.prototype.putNativeObject=function(t){t instanceof e?t.isOpaque()?this.currentVisibleNativeObjects.opaquesArray.push(t):this.currentVisibleNativeObjects.transparentsArray.push(t):t instanceof ki?this.currentVisibleNativeObjects.excavationsArray.push(t):this.currentVisibleNativeObjects.opaquesArray.push(t)},Bt.prototype.getObjectIdxSortedByDist=function(t,e,i,r){var o=i-e;if(o<6){for(var n,a=!1,s=e;!a&&s<=i;){var l=t[s];r.distToCamera<l.distToCamera&&(n=s,a=!0),s++}return a?n:i+1}var h,d,c=e+Math.floor(o/2);return t[c].distToCamera>r.distToCamera?(h=e,d=c):(h=c,d=i),this.getObjectIdxSortedByDist(t,h,d,r)},Bt.prototype.putObjectToArraySortedByDist=function(t,e){if(t.length>0){var i=t.length-1,r=this.getObjectIdxSortedByDist(t,0,i,e);t.splice(r,0,e)}else t.push(e)},Bt.prototype.getNodeIdxSortedByDist=function(t,e,i,r){r.data.neoBuilding;var o=i-e;if(o<6){for(var n,a=!1,s=e;!a&&s<=i;){var l=t[s];r.data.distToCam<l.data.distToCam&&(n=s,a=!0),s++}return a?n:i+1}var h,d,c=e+Math.floor(o/2);return t[c].data.distToCam>r.data.distToCam?(h=e,d=c):(h=c,d=i),this.getNodeIdxSortedByDist(t,h,d,r)},Bt.calculateBoundingSphereForArray=function(t,e){void 0===e&&(e=new m);for(var i,r=t.length,o=0;o<r;o++){var n=t[o];void 0!==n&&(i=n.getBoundingSphereWC(i),0===o?e.copyFrom(i):e.addBSphere(i))}return e},Bt.getBoundaryNodes=function(t,e){var i,r,o,n,a,s,l,h;void 0===e&&(e=[]);for(var d=t.length,c=0;c<d;c++){var u=t[c],f=u.data.geographicCoord;0===c?(i=f.longitude,r=f.latitude,o=f.longitude,n=f.latitudes,a=u,s=u,l=u,h=u):(f.longitude<i?(i=f.longitude,a=u):f.longitude>o&&(o=f.longitude,s=u),f.latitude<r?(r=f.latitude,l=u):f.latitude>n&&(n=f.latitude,h=u))}return e.push.apply(e,[a,s,l,h]),e},Bt.prototype.calculateBoundingFrustum=function(t){var e=this.currentVisibles0.concat(this.currentVisibles1,this.currentVisibles2,this.currentVisibles3);if(0!==e.length){var i=t.getPosition(),r=t.getDirection(),o=new ur(i.x,i.y,i.z),n=new ur(r.x,r.y,r.z),a=new Yi(o,n),s=[];s=Bt.getBoundaryNodes(e,s);for(var l=1e11,h=0,d=new ur,c=s.length,u=0;u<c;u++){var f=s[u].getBoundingSphereWC(f);if(f){var g=f.getCenterPoint(),p=f.getRadius(),v=a.getProjectedPoint(g,void 0),y=new ur(v.x-r.x*p,v.y-r.y*p,v.z-r.z*p),m=new ur(v.x+r.x*p,v.y+r.y*p,v.z+r.z*p),x=i.squareDistTo(y.x,y.y,y.z),b=i.squareDistTo(m.x,m.y,m.z);if(l>0)d.set(y.x-i.x,y.y-i.y,y.z-i.z),r.scalarProduct(d)<0&&(x=0);else x=0;0===u?(l=x,h=b):(x<l&&(l=x),b>h&&(h=b))}}this.bFrustumNear=Math.sqrt(l),this.bFrustumFar=Math.sqrt(h)}},Bt.prototype.calculateBoundingSpheres=function(){void 0===this.bSphere&&(this.bSphere=new m);var t=this.currentVisibles0.concat(this.currentVisibles1,this.currentVisibles2,this.currentVisibles3);if(0!==t.length){var e=[];e=Bt.getBoundaryNodes(t,e),this.bSphere=Bt.calculateBoundingSphereForArray(e,this.bSphere)}},Bt.prototype.putNodeToArraySortedByDist=function(t,e){if(t.length>0){var i=t.length-1,r=this.getNodeIdxSortedByDist(t,0,i,e);t.splice(r,0,e)}else t.push(e)},Bt.prototype.putNodeByLod=function(t,e){0===e||1===e?this.putNodeToArraySortedByDist(this.currentVisibles0,t):2===e?this.putNodeToArraySortedByDist(this.currentVisibles2,t):e>2&&this.putNodeToArraySortedByDist(this.currentVisibles3,t)};var Vt=function(t){if(!(this instanceof Vt))throw new Error(ot.CONSTRUCT_ERROR);Tt.call(this,t),this.url=t.url,this.param=Object.assign({},Vt.DEAFULT_PARAM,t.param||{}),this.filter=wi(t.filter,void 0),this._requestParam=new URLSearchParams(this.param),"1.3.0"===this._requestParam.get("VERSION")?this._requestParam.delete("SRS"):this._requestParam.delete("CRS")};Vt.prototype=Object.create(Tt.prototype),Vt.prototype.constructor=Vt,Vt.DEAFULT_PARAM={SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",SRS:"EPSG:3857",CRS:"EPSG:3857",WIDTH:256,HEIGHT:256,FORMAT:"image/png",TRANSPARENT:!0},Vt.prototype.getUrl=function(t){var e=vt.getGeographicExtentOfTileLXY(parseInt(t.z),parseInt(t.x),parseInt(t.y),void 0,c.imageryType.WEB_MERCATOR),i=e.minGeographicCoord,r=e.maxGeographicCoord,o=W.geographicToMercatorProjection(i.longitude,i.latitude,void 0),n=W.geographicToMercatorProjection(r.longitude,r.latitude,void 0),a=(this._requestParam.get("VERSION"),o.x+","+o.y+","+n.x+","+n.y);return this._requestParam.set("BBOX",a),this.url+"?"+this._requestParam.toString()};var jt=function(t){if(!(this instanceof jt))throw new Error(ot.CONSTRUCT_ERROR);Tt.call(this,t);var e=t.url,i=t.urlFunction;if(Ri(e)&&Ri(i))throw new Error(ot.REQUIRED_EMPTY_ERROR("url or urlFunction"));this.url=e,this.reg=/{[^}]+}/g,this.urlFunction=wi(i,void 0),this.urlFunction||this._setDefaultUrlFunction()};jt.prototype=Object.create(Tt.prototype),jt.prototype.constructor=jt,jt.prototype.getUrl=function(t){return this.urlFunction.call(this,t)},jt.prototype._setDefaultUrlFunction=function(){var t=this;t.urlFunction=function(e){for(var i=t.url.match(t.reg),r=t.url,o=0,n=i.length;o<n;o++){var a=i[o],s=e[a.substring(1,a.length-1).toLowerCase()];r=r.replace(a,s)}return r}};var Ut=function(){if(!(this instanceof Ut))throw new Error(ot.CONSTRUCT_ERROR);this.bufferId,this.accesorType,this.bufferStart,this.stride,this.dataType,this.dimension,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},kt=function(){if(!(this instanceof kt))throw new Error(ot.CONSTRUCT_ERROR);this.vBOVertexIdxCacheKeysContainer=new Nt,this.mIFCEntityType=-1,this.isSmallObj=!1,this.bbox,this.radius=10,this.vertexCount=0,this.lego};kt.prototype.deleteObjects=function(t,e){this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),this.vBOVertexIdxCacheKeysContainer=void 0,this.mIFCEntityType=void 0,this.isSmallObj=void 0,this.radius=void 0,this.vertexCount=void 0,this.lego&&this.lego.deleteGlObjects(t),this.lego=void 0},kt.prototype.isReadyToRender=function(t,e,i){return!(i&&this.radius<i)&&!(e.isCameraMoving&&this.radius<e.smallObjectSize&&e.objectSelected!==t)};var Gt=function(t){if(!(this instanceof Gt))throw new Error(ot.CONSTRUCT_ERROR);this.fileLoadState=c.fileLoadState.READY,this.dataArraybuffer},zt=function(t){if(!(this instanceof zt))throw new Error(ot.CONSTRUCT_ERROR);this.name="",this.version=t||"",this.blocksArray,this.fileLoadState=c.fileLoadState.READY,this.dataArraybuffer,this.keepDataArrayBuffers,this.xhr,this.blocksArrayPartitionsCount,this.blocksArrayPartitionsArray,this.blocksArrayPartitionsMasterPathName};zt.prototype.newBlock=function(){void 0===this.blocksArray&&(this.blocksArray=[]);var t=new kt;return this.blocksArray.push(t),t},zt.prototype.getBlock=function(t){return void 0===this.blocksArray?null:t>=0&&t<this.blocksArray.length?this.blocksArray[t]:null},zt.prototype.deleteGlObjects=function(t,e){if(void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),void 0!==this.blocksArray){for(var i=0,r=this.blocksArray.length;i<r;i++){var o=this.blocksArray[i];o.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),o.vBOVertexIdxCacheKeysContainer=void 0,o.mIFCEntityType=void 0,o.isSmallObj=void 0,o.radius=void 0,o.vertexCount=void 0,o.lego&&(o.lego.vbo_vicks_container.deleteGlObjects(t,e),o.lego.vbo_vicks_container=void 0),o.lego=void 0,this.blocksArray[i]=void 0}this.blocksArray=void 0,this.name=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0}},zt.prototype.stepOverBlockVersioned=function(t,e,i){var r,o,n,a,s=i.readInt32(t,e,e+4);e+=4;for(var l=0;l<s;l++)r=i.readUInt32(t,e,e+4),e+=4,e+4*(o=3*r),e+=4*o,r=i.readUInt32(t,e,e+4),e+=4,e+=1*(3*r),n=i.readUInt32(t,e,e+4),e+=4,a=i.readUInt8(t,e,e+1),e+=1,e+=4*a,e+=4*a,e+=2*n;return e},zt.prototype.parseBlockVersioned=function(t,e,i,r,o,n){var a=o.vboMemoryManager,s=r.readInt32(t,e,e+4);e+=4;for(var l=0;l<s;l++){var h=i.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();void 0!==this.keepDataArrayBuffers&&this.keepDataArrayBuffers&&(h.keepDataArrayBuffers=!0),e=h.readPosNorIdx(t,a,e),i.vertexCount=h.vertexCount}return e},zt.prototype.parseBlocksListVersioned_v001=function(t,e,i,r){this.fileLoadState=c.fileLoadState.PARSE_STARTED;var o=0;o+=5;var n=e.readUInt32(t,o,o+4);o+=4;for(var a=0;a<n;a++){var s=e.readInt32(t,o,o+4);if(o+=4,i[s]){o+=24,o=this.stepOverBlockVersioned(t,o,e);var l=e.readUInt8(t,o,o+1);o+=1,l&&(o=this.stepOverBlockVersioned(t,o,e))}else{var h=new kt;h.idx=s,i[s]=h,h.bbox=new y;var d=h.bbox,u=new Float32Array(t.slice(o,o+4));o+=4;var f=new Float32Array(t.slice(o,o+4));o+=4;var g=new Float32Array(t.slice(o,o+4));o+=4;var p=new Float32Array(t.slice(o,o+4));o+=4;var v=new Float32Array(t.slice(o,o+4));o+=4;var m=new Float32Array(t.slice(o,o+4));o+=4,d.minX=u[0],d.minY=f[0],d.minZ=g[0],d.maxX=p[0],d.maxY=v[0],d.maxZ=m[0];var x=d.getMaxLength();h.isSmallObj=x<.5,h.radius=x/2,o=this.parseBlockVersioned(t,o,h,e,r);l=e.readUInt8(t,o,o+1);o+=1,l&&(void 0===h.lego&&(h.lego=new Yt),o=this.parseBlockVersioned(t,o,h.lego,e,r))}}return this.fileLoadState=c.fileLoadState.PARSE_FINISHED,!0},zt.prototype.parseBlocksListVersioned_partitionsVersion=function(t,e,i){var r=this.blocksArrayPartitionsArray.length,o=this.blocksArrayPartitionsArray[r-1];if(o.fileLoadState===c.fileLoadState.LOADING_FINISHED){var n=o.dataArraybuffer;o.fileLoadState=c.fileLoadState.PARSE_STARTED;var a=0,s=i.vboMemoryManager,l=t.readUInt32(n,a,a+4);a+=4;for(var h=0;h<l;h++){var d,u=t.readInt32(n,a,a+4);a+=4,e[u]?d=e[u]:((d=new kt).idx=u,e[u]=d);var f=t.readInt32(n,a,a+4);if(a+=4,0===f){var g=new y;g.minX=new Float32Array(n.slice(a,a+4)),a+=4,g.minY=new Float32Array(n.slice(a,a+4)),a+=4,g.minZ=new Float32Array(n.slice(a,a+4)),a+=4,g.maxX=new Float32Array(n.slice(a,a+4)),a+=4,g.maxY=new Float32Array(n.slice(a,a+4)),a+=4,g.maxZ=new Float32Array(n.slice(a,a+4)),a+=4;var p=g.getMaxLength();d.isSmallObj=p<.5,d.radius=p/2}var v=d.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[f];void 0===v?(v=new Ft,d.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[f]=v,a=v.readPosNorIdx(n,t,s,a),d.vertexCount=v.vertexCount):l>1&&(a=v.stepOverPosNorIdx(n,t,s,a))}return o.fileLoadState=c.fileLoadState.PARSE_FINISHED,this.fileLoadState=c.fileLoadState.PARSE_FINISHED,!0}},zt.prototype.parseBlocksList=function(t,e,i,r){this.fileLoadState=c.fileLoadState.PARSE_STARTED;var o=0,n=e.readUInt32(t,o,o+4);o+=4;for(var a=r.vboMemoryManager,s=0;s<n;s++){var l=e.readInt32(t,o,o+4);if(o+=4,i[l]){o+=24;var h=e.readInt32(t,o,o+4);o+=4;for(var d=0;d<h;d++){var u=e.readUInt32(t,o,o+4);o+=4;var f=3*u;startBuff=o,endBuff=o+4*f,o+=4*f,u=e.readUInt32(t,o,o+4),o+=4,o+=1*(3*u);var g=e.readUInt32(t,o,o+4);o+=4;var p=e.readUInt8(t,o,o+1);o+=1,o+=4*p,o+=4*p,o+=2*g}}else{var v=new kt;v.idx=l,i[l]=v;var m=new y;m.minX=new Float32Array(t.slice(o,o+4)),o+=4,m.minY=new Float32Array(t.slice(o,o+4)),o+=4,m.minZ=new Float32Array(t.slice(o,o+4)),o+=4,m.maxX=new Float32Array(t.slice(o,o+4)),o+=4,m.maxY=new Float32Array(t.slice(o,o+4)),o+=4,m.maxZ=new Float32Array(t.slice(o,o+4)),o+=4;var x=m.getMaxLength();v.isSmallObj=x<.5,v.radius=x/2,m.deleteObjects(),m=void 0;h=e.readInt32(t,o,o+4);o+=4;for(d=0;d<h;d++){var b=v.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();o=b.readPosNorIdx(t,a,o),v.vertexCount=b.vertexCount}}}return this.fileLoadState=c.fileLoadState.PARSE_FINISHED,!0},zt.prototype.prepareData=function(t,e){if("0.0.1"===this.version);else if("0.0.2"===this.version){void 0===this.blocksArrayPartitionsArray&&(this.blocksArrayPartitionsArray=[]);var i=this.blocksArrayPartitionsArray.length;if(0===i){var r=0,o=this.blocksArrayPartitionsMasterPathName+r.toString(),n=new Gt;this.blocksArrayPartitionsArray.push(n),t.readerWriter.getNeoBlocksArraybuffer_partition(o,e,n,t)}else{if(this.blocksArrayPartitionsArray[i-1].fileLoadState===c.fileLoadState.PARSE_FINISHED&&i<this.blocksArrayPartitionsCount){r=i,o=this.blocksArrayPartitionsMasterPathName+r.toString(),n=new Gt;this.blocksArrayPartitionsArray.push(n),t.readerWriter.getNeoBlocksArraybuffer_partition(o,e,n,t)}}}};var Ht=function(t){if(!(this instanceof Ht))throw new Error(ot.CONSTRUCT_ERROR);this.centerPos=new ur,this.transformedCenterPos,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,t&&(this.octree_owner=t,this.octree_level=t.octree_level+1),this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.neoBuildingOwner,this.octreeKey,this.lod,this.fileLoadState=c.fileLoadState.READY,this.subOctrees_array=[],this.lowestOctrees_array,this.trianglesArray,this.currentVisibleOctreesArray,this.collisionState=!1,this.boundingSphere,this.collidedWithMeCollisionOctreesArray,this.vboKeysContainer,this.geoLocDataManager};Ht.prototype.makeTreeByTrianglesArray=function(t){if(void 0!==this.trianglesArray&&0!==this.trianglesArray.length&&void 0!==t){var e=t.desiredMinOctreeSize/2;if(this.half_dx>e||this.half_dy>e||this.half_dz>e){this.createChildren();for(var i=0;i<8;i++)this.subOctrees_array[i].takeIntersectedTriangles(this.trianglesArray);for(i=0;i<8;i++)this.subOctrees_array[i].makeTreeByTrianglesArray(t);this.trianglesArray=void 0}}},Ht.prototype.takeIntersectedTriangles=function(t){if(void 0!==t){void 0===this.trianglesArray&&(this.trianglesArray=[]);for(var e=this.getBoundingBox(),i=t.length,r=0;r<i;r++){var o=t[r];e.intersectsWithTriangle(o)&&this.trianglesArray.push(o)}}},Ht.prototype.extractLowestOctreesIfHasTriangles=function(t){if(void 0!==this.subOctrees_array){var e=this.subOctrees_array.length;if(void 0!==this.trianglesArray&&this.trianglesArray.length>0)t.push(this);else for(var i=0;i<e;i++)this.subOctrees_array[i].extractLowestOctreesIfHasTriangles(t)}},Ht.prototype.render=function(t,e,i,r){if(void 0===this.sphere){var o=new _;o.setRGB(.9,.1,.1);var n={};return n.color=o,this.sphere=new mt(n),this.sphere.setRadius(this.getRadius()),void this.sphere.setCenterPoint(this.centerPos.x,this.centerPos.y,this.centerPos.z)}var a=t.getGl();a.uniform1i(e.hasAditionalMov_loc,!1);a.uniform1i(e.refMatrixType_loc,1),a.uniform3fv(e.refTranslationVec_loc,[this.centerPos.x,this.centerPos.y,this.centerPos.z]),this.sphere.renderLocal(t,e,i,r,!1)},Ht.prototype.hasChildren=function(){return void 0!==this.subOctrees_array&&this.subOctrees_array.length>0},Ht.prototype.createChildren=function(){this.subOctrees_array=[];for(var t=0;t<8;t++){var e=this.new_subOctree();e.octree_number_name=10*this.octree_number_name+(t+1),e.neoBuildingOwnerId=this.neoBuildingOwnerId,e.octreeKey=this.neoBuildingOwnerId+"_"+e.octree_number_name}this.setSizesSubBoxes()},Ht.prototype.new_subOctree=function(){var t=new Ht(this);return t.octree_level=this.octree_level+1,this.subOctrees_array.push(t),t},Ht.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>0){var t=this.centerPos.x,e=this.centerPos.y,i=this.centerPos.z,r=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(r,t,o,e,n,i),this.subOctrees_array[1].setBoxSize(t,a,o,e,n,i),this.subOctrees_array[2].setBoxSize(t,a,e,s,n,i),this.subOctrees_array[3].setBoxSize(r,t,e,s,n,i),this.subOctrees_array[4].setBoxSize(r,t,o,e,i,l),this.subOctrees_array[5].setBoxSize(t,a,o,e,i,l),this.subOctrees_array[6].setBoxSize(t,a,e,s,i,l),this.subOctrees_array[7].setBoxSize(r,t,e,s,i,l);for(var h=0;h<8;h++)this.subOctrees_array[h].setSizesSubBoxes()}},Ht.prototype.setBoxSize=function(t,e,i,r,o,n){this.centerPos.x=(e+t)/2,this.centerPos.y=(r+i)/2,this.centerPos.z=(n+o)/2,this.half_dx=(e-t)/2,this.half_dy=(r-i)/2,this.half_dz=(n-o)/2},Ht.prototype.getBoundingBox=function(t){return void 0===t&&(t=new y),void 0===this.transformedCenterPos&&(this.transformedCenterPos=new ur,this.transformedCenterPos.copyFrom(this.centerPos)),t.set(this.transformedCenterPos.x-this.half_dx,this.transformedCenterPos.y-this.half_dy,this.transformedCenterPos.z-this.half_dz,this.transformedCenterPos.x+this.half_dx,this.transformedCenterPos.y+this.half_dy,this.transformedCenterPos.z+this.half_dz),t},Ht.prototype.getRadius=function(){return this.getBoundingBox().getRadius()},Ht.prototype.getBoundingSphere=function(){return void 0===this.transformedCenterPos&&(this.transformedCenterPos=new ur,this.transformedCenterPos.copyFrom(this.centerPos)),this.boundingSphere=new m(this.transformedCenterPos.x,this.transformedCenterPos.y,this.transformedCenterPos.z,this.getRadius()),this.boundingSphere},Ht.prototype.checkCollision=function(t,e){if(void 0===t)return!1;var i=this.getBoundingSphere(),r=t.getBoundingSphere();if(i.intersectsWithBSphere(r)===u.INTERSECTION_OUTSIDE)return!1;if(!this.hasChildren()&&!t.hasChildren())return void 0!==t.trianglesArray&&0!==t.trianglesArray.length&&void 0!==this.trianglesArray&&0!==this.trianglesArray.length&&e.push(this),!0;if(i.r>r.r)if(this.hasChildren())for(var o=this.subOctrees_array.length,n=0;n<o;n++){(a=this.subOctrees_array[n]).checkCollision(t,e)}else for(o=t.subOctrees_array.length,n=0;n<o;n++){var a=t.subOctrees_array[n];this.checkCollision(a,e)}else if(t.hasChildren())for(o=t.subOctrees_array.length,n=0;n<o;n++){a=t.subOctrees_array[n];this.checkCollision(a,e)}else for(o=this.subOctrees_array.length,n=0;n<o;n++){(a=this.subOctrees_array[n]).checkCollision(t,e)}},Ht.prototype.translate=function(t,e){if(void 0!==t&&(void 0===this.transformedCenterPos&&(this.transformedCenterPos=new ur,this.transformedCenterPos.copyFrom(this.centerPos)),void 0===e&&(e=!1),e&&this.transformedCenterPos.copyFrom(this.centerPos),this.transformedCenterPos.addPoint(t),this.hasChildren()))for(var i=this.subOctrees_array.length,r=0;r<i;r++)this.subOctrees_array[r].translate(t,e)},Ht.prototype.transformByMatrix4=function(t,e){if(void 0!==t&&(void 0===this.transformedCenterPos&&(this.transformedCenterPos=new ur,this.transformedCenterPos.copyFrom(this.centerPos)),void 0===e&&(e=!1),e&&this.transformedCenterPos.copyFrom(this.centerPos),this.transformedCenterPos=t.transformPoint3D(this.transformedCenterPos,this.transformedCenterPos),this.hasChildren()))for(var i=this.subOctrees_array.length,r=0;r<i;r++)this.subOctrees_array[r].transformByMatrix4(t,e)};var Wt=function(){if(!(this instanceof Wt))throw new Error(ot.CONSTRUCT_ERROR);this.projectsMap={},this.staticModelsManager};Wt.prototype.deleteNodes=function(t,e){for(var i in this.projectsMap)if(Object.prototype.hasOwnProperty.call(this.projectsMap,i)){var r=this.projectsMap[i];for(var o in r)if(Object.prototype.hasOwnProperty.call(r,o)){var n=r[o];n instanceof he&&(n.deleteObjects(t,e),delete r[o])}delete this.projectsMap[i]}this.projectsMap={}},Wt.prototype.getStaticModelsManager=function(){return void 0===this.staticModelsManager&&(this.staticModelsManager=new Er),this.staticModelsManager},Wt.prototype.getNodeByDataName=function(t,e,i){var r=this.getNodesMap(t);if(void 0!==r){var o;for(var n in r)if(Object.prototype.hasOwnProperty.call(r,n)){var a=r[n];if(void 0!==a.data&&a.data[e]===i){o=a;break}}return o}},Wt.prototype.getNodeByDataKey=function(t,e){var i=this.getNodesMap(t);if(void 0!==i)return i[e]},Wt.prototype.getRootNodes=function(t,e){void 0===e&&(e=[]);var i=this.projectsMap[t];for(var r in i)if(Object.prototype.hasOwnProperty.call(i,r)){var o=i[r];o instanceof he&&void 0===o.parent&&e.push(o)}return e},Wt.prototype.existProject=function(t){return this.projectsMap.hasOwnProperty(t)},Wt.prototype.getNodesMap=function(t,e){var i=this.projectsMap[t];return void 0===i?(i={},void 0!==e&&(i.attributes=e),this.projectsMap[t]=i):void 0!==e&&void 0===i.attributes&&(i.attributes=e),i},Wt.prototype.newNode=function(t,e,i){var r,o=this.getNodesMap(e,i);void 0===(r=o[t])&&((r=new he).data={nodeId:t},o[t]=r);return r};var Xt=function(){if(!(this instanceof Xt))throw new Error(ot.CONSTRUCT_ERROR)},Yt=function(){if(!(this instanceof Yt))throw new Error(ot.CONSTRUCT_ERROR);this.vbo_vicks_container=new Nt,this.fileLoadState=c.fileLoadState.READY,this.bbox,this.dataArrayBuffer,this.selColor4,this.hasTexCoords,this.texture,this.textureName,this.legoKey,this.xhr,this.renderableType,this.hasColors,this.blendAlpha=0,this.birthTime,this.isAdult=!1,this.dataArrayBuffer};Yt.prototype.parseArrayBuffer=function(t,e){this.parseLegoData(t,e)},Yt.prototype.getBlendAlpha=function(t){return 1},Yt.prototype.isReadyToRender=function(){return this.fileLoadState===c.fileLoadState.PARSE_FINISHED&&(void 0!==this.texture&&void 0!==this.texture.texId)},Yt.prototype.deleteObjects=function(t,e){void 0!==this.vbo_vicks_container&&(this.vbo_vicks_container.deleteGlObjects(t,e),this.vbo_vicks_container=void 0),this.fileLoadState=void 0,this.dataArrayBuffer=void 0,void 0!==this.selColor4&&(this.selColor4.deleteObjects(),this.selColor4=void 0),this.textureName=void 0,this.texture&&this.texture.deleteObjects(t),this.texture=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0},Yt.prototype.parsePointsCloudData=function(t,e,i){if(this.fileLoadState===c.fileLoadState.LOADING_FINISHED){var r=new DataStream(t,0,DataStream.LITTLE_ENDIAN),o=r.readInt32(),n=i.vboMemoryManager;this.fileLoadState=c.fileLoadState.PARSE_STARTED,this.bbox=new y;var a=this.bbox,s=this.vbo_vicks_container.newVBOVertexIdxCacheKey();a.minX=r.readFloat32(),a.minY=r.readFloat32(),a.minZ=r.readFloat32(),a.maxX=r.readFloat32(),a.maxY=r.readFloat32(),a.maxZ=r.readFloat32(),this.bPositionsCompressed=r.readInt8();if(this.bPositionsCompressed?s.setDataArrayPos(r.readUint16Array(3*o),n):s.setDataArrayPos(r.readFloat32Array(3*o),n),this.hasNormals=r.readInt8(),this.hasNormals,this.hasColors=r.readInt8(),this.hasColors){var l=o;s.setDataArrayCol(r.readUint8Array(4*l),n)}this.hasTexCoords=r.readInt8(),this.hasTexCoords,this.hasIndices=r.readInt8(),this.hasIndices,this.fileLoadState=c.fileLoadState.PARSE_FINISHED}},Yt.prototype.parseLegoData=function(t,e,i){if(this.fileLoadState===c.fileLoadState.LOADING_FINISHED||this.fileLoadState===c.fileLoadState.IN_PARSE_QUEUE){if(void 0===t&&(t=this.dataArrayBuffer),void 0===t)return i;var r=e.vboMemoryManager,o=e._settings.keepVboPositionDataArrayBuffers;void 0===i&&(i=0),void 0===this.vbo_vicks_container&&(this.vbo_vicks_container=new Nt),this.fileLoadState=c.fileLoadState.PARSE_STARTED,this.bbox=new y;var n=this.bbox,a=this.vbo_vicks_container.newVBOVertexIdxCacheKey();i=n.readData(t,i);var s=new Int32Array(t.slice(i,i+4))[0],l=4,h=i+=4,d=i+l*s*3,u=new Float32Array(t.slice(h,d));a.setDataArrayPos(u,r),i+=l*s*3,o&&(a.vboBufferPos.bKeepDataArray=!0);var f=new Uint8Array(t.slice(i,i+1))[0];if(i+=1,f){var g=new Int32Array(t.slice(i,i+4))[0];h=i+=4,d=i+(l=1)*g*3;var p=new Int8Array(t.slice(h,d));a.setDataArrayNor(p,r),i+=l*g*3}var v=new Uint8Array(t.slice(i,i+1))[0];if(i+=1,v){var m=new Int32Array(t.slice(i,i+4))[0];h=i+=4,d=i+(l=1)*m*4;var x=new Int8Array(t.slice(h,d));a.setDataArrayCol(x,r),i+=l*m*4}if(this.hasTexCoords=new Uint8Array(t.slice(i,i+1))[0],i+=1,this.hasTexCoords){new Uint16Array(t.slice(i,i+2))[0];i+=2;var b=new Uint32Array(t.slice(i,i+4))[0];h=i+=4,d=i+(l=4)*b*2;var C=new Float32Array(t.slice(h,d));a.setDataArrayTexCoord(C,r),i+=l*b*2}return this.fileLoadState=c.fileLoadState.PARSE_FINISHED,i}},Yt.prototype.makeStencilShadowMesh=function(t){if(void 0!==this.vbo_vicks_container){this.shadowMeshesArray=[];for(var e=this.vbo_vicks_container.getVbosCount(),i=0;i<e;i++){var r=this.vbo_vicks_container.getVboKey(i),o=rr.fromVbo(r);void 0!==o&&this.shadowMeshesArray.push(o)}}},Yt.prototype.renderStencilShadowMeshes=function(t,e,i,r,o){},Yt.prototype.render=function(t,e,i,r,o){var n=!1,a=t.sceneState.gl;if(0===this.vbo_vicks_container.vboCacheKeysArray.length)return!1;if(a.frontFace(a.CCW),3!==e){var s=this.vbo_vicks_container.vboCacheKeysArray[0],l=s.vertexCount;if(0===l)return!1;if(0===e||2===e){if(r.disableVertexAttribArray(r.texCoord2_loc),r.disableVertexAttribArray(r.normal3_loc),r.disableVertexAttribArray(r.color4_loc),!s.bindDataPosition(r,t.vboMemoryManager))return!1;a.drawArrays(a.TRIANGLES,0,l),n=!0}else if(1===e){if(void 0===t.isTrailRender||!1===t.isTrailRender){var h=this.getBlendAlpha(t.currTime);a.uniform1f(r.externalAlpha_loc,h)}if(i){if(!s.bindDataTexCoord(r,t.vboMemoryManager))return!1}else a.uniform1i(r.bUse1Color_loc,!1),r.disableVertexAttribArray(r.texCoord2_loc);if(!s.bindDataPosition(r,t.vboMemoryManager))return!1;if(!s.bindDataNormal(r,t.vboMemoryManager))return!1;if(i&&void 0!==s.vboBufferTCoord&&(a.uniform1i(r.textureFlipYAxis_loc,!1),r.disableVertexAttribArray(r.color4_loc),!s.bindDataTexCoord(r,t.vboMemoryManager)))return!1;a.drawArrays(a.TRIANGLES,0,l),t.sceneState.trianglesRenderedCount+=l/3,n=!0,r.disableVertexAttribArray(r.color4_loc)}return n}var d=t.processCounterManager;if(void 0!==o)if(void 0!==this.shadowMeshesArray)for(var c=this.shadowMeshesArray.length,u=0;u<c;u++){this.shadowMeshesArray[u].renderAsChild(t,r,e,void 0,!1)}else if(0===d.shadowMeshesMadeCount){var f=o.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData(),g=t.sceneState.sunSystem.getSunDirWC(),p=f.getRotatedRelativeVector(g,p);this.makeStencilShadowMesh(p),d.shadowMeshesMadeCount++}};var Kt=function(){if(!(this instanceof Kt))throw new Error(ot.CONSTRUCT_ERROR);this.dataType,this.distToCam,this.lod,this.filePath,this.texFilePath,this.skinMesh,this.octree,this.texture};Kt.prototype.deleteObjects=function(){this.dataType=void 0,this.distToCam=void 0,this.lod=void 0,this.filePath=void 0,this.texFilePath=void 0,this.skinMesh=void 0,this.octree=void 0,this.texture=void 0};var qt=function(t){if(!(this instanceof qt))throw new Error(ot.CONSTRUCT_ERROR);this.magoManager,void 0!==t&&(this.magoManager=t),this.lod2PCloudDataMap={},this.tinTerrainDataMap={}};qt.prototype.putLod2PCloudData=function(t,e,i,r,o){t.lego.fileLoadState=c.fileLoadState.IN_QUEUE;var n=new Kt;n.filePath=e,n.octree=t,n.texFilePath=r,n.texture=i,this.lod2PCloudDataMap[e]=n},qt.prototype.resetQueue=function(){for(var t in this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,t)){var e=this.lod2PCloudDataMap[t];if(void 0===e.octree||void 0===e.octree.lego)continue;e.octree.lego.fileLoadState=c.fileLoadState.READY}this.lod2PCloudDataMap={}},qt.prototype.manageQueue=function(){var t=this.magoManager.readerWriter,e=(this.magoManager.sceneState.gl,0);if(!this.magoManager.fileRequestControler.isFullPlusLowLodImages()){for(var i in e=0,this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,i)){var r=this.lod2PCloudDataMap[i],o=r.octree,n=r.filePath;if(void 0!==o.lego&&t.getOctreePCloudArraybuffer(n,o,this.magoManager),delete this.lod2PCloudDataMap[i],r.deleteObjects(),r=void 0,++e>4){!0;break}}this.resetQueue()}};var Zt=function(){if(!(this instanceof Zt))throw new Error(ot.CONSTRUCT_ERROR);this.attributes,this.skinLego,this.texture};Zt.prototype.isReadyToRender=function(){return void 0!==this.skinLego&&(this.skinLego.fileLoadState===c.fileLoadState.PARSE_FINISHED&&("noTexture"===this.skinLego.textureName||void 0!==this.texture&&void 0!==this.texture.texId))},Zt.prototype.render=function(t,e,i,r,o){return this.skinLego.render(t,e,i,r,o)};var Qt=function(){if(!(this instanceof Qt))throw new Error(ot.CONSTRUCT_ERROR);this.lod,this.isModelRef,this.geometryFileName,this.textureFileName},Jt=function(){if(!(this instanceof Jt))throw new Error(ot.CONSTRUCT_ERROR);this.guid,this.version="",this.geographicCoord,this.heading,this.pitch,this.roll,this.bbox,this.imageLodCount,this.projectDataType,this.offSetX,this.offSetY,this.offSetZ,this.oct_min_x=0,this.oct_max_x=0,this.oct_min_y=0,this.oct_max_y=0,this.oct_min_z=0,this.oct_max_z=0,this.isSmall=!1,this.fileLoadState=c.fileLoadState.READY};Jt.prototype.deleteObjects=function(){this.guid=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0,this.imageLodCount=void 0,this.oct_min_x=void 0,this.oct_max_x=void 0,this.oct_min_y=void 0,this.oct_max_y=void 0,this.oct_min_z=void 0,this.oct_max_z=void 0,this.isSmall=void 0,this.fileLoadState=void 0},Jt.prototype.parseFileHeaderAsimetricVersion=function(t,e){var i,r=new TextDecoder("utf-8");this.version="",this.version=r.decode(new Int8Array(t.slice(e,e+5))),e+=5,void 0===this.guid&&(this.guid=""),i=ge.readInt32(t,e,e+4),e+=4,this.guid=r.decode(new Int8Array(t.slice(e,e+i))),e+=i,void 0===this.longitude?(this.longitude=new Float64Array(t.slice(e,e+8))[0],e+=8):e+=8,void 0===this.latitude?(this.latitude=new Float64Array(t.slice(e,e+8))[0],e+=8):e+=8,void 0===this.altitude?(this.altitude=new Float32Array(t.slice(e,e+4))[0],e+=4):e+=4,void 0===this.bbox&&(this.bbox=new y),e=this.bbox.readData(t,e);var o=!1;return(this.bbox.maxX-this.bbox.minX>40||this.bbox.maxY-this.bbox.minY>40)&&(o=!0),!o&&this.bbox.maxZ-this.bbox.minZ<30&&(this.isSmall=!0),this.projectDataType=0,"0.0.2"===this.version&&(this.projectDataType=new Uint16Array(t.slice(e,e+2))[0],e+=2,this.offSetX=new Float64Array(t.slice(e,e+8))[0],e+=8,this.offSetY=new Float64Array(t.slice(e,e+8))[0],e+=8,this.offSetZ=new Float64Array(t.slice(e,e+8))[0],e+=8),e};var $t=function(){if(!(this instanceof $t))throw new Error(ot.CONSTRUCT_ERROR);this.modelIdx,this.referencesIdxArray=[]},te=function(){if(!(this instanceof te))throw new Error(ot.CONSTRUCT_ERROR);this.modelReferencedGroupsMap=[],this.modelReferencedGroupsArray=[]};te.prototype.getModelReferencedGroup=function(t){var e=this.modelReferencedGroupsMap[t];return void 0===e&&((e=new $t).modelIdx=t,this.modelReferencedGroupsMap[t]=e),e},te.prototype.makeModelReferencedGroupsArray=function(){this.modelReferencedGroupsArray.length=0;for(var t=this.modelReferencedGroupsMap.length,e=0;e<t;e++)void 0!==this.modelReferencedGroupsMap[e]&&this.modelReferencedGroupsArray.push(this.modelReferencedGroupsMap[e]);this.modelReferencedGroupsMap.length=0},te.prototype.createModelReferencedGroups=function(t,e){if(void 0!==t&&void 0!==e){for(var i,r,o=t.length,n=0;n<o;n++)r=e[i=t[n]]._block_idx,this.getModelReferencedGroup(r).referencesIdxArray.push(i);this.makeModelReferencedGroupsArray()}};var ee=function(){if(!(this instanceof ee))throw new Error(ot.CONSTRUCT_ERROR);this.skinBuildingsArray,this.fileLoadState=c.fileLoadState.READY,this.dataArrayBuffer,this.bbox,this.geoCoords,this.vboKeysContainer,this.multiBuildingsElementsArray=[]};ee.prototype.prepareData=function(t){if(this.fileLoadState===c.fileLoadState.READY){var e=this.nodeOwner,i=e.data.projectFolderName,r=e.data.multiBuildingsFolderName,o=r,n=t.readerWriter,a=t.readerWriter.geometryDataPath+"/"+i+"/"+r+"/"+o;n.getMultiBuildingsDataArrayBuffer(a,this,t)}},ee.prototype.render=function(t,e){if(!this.isReadyToRender())return!1;if(void 0===this.vboKeysContainer)return!1;var i=t.getGl();this.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,e);var r=t.vboMemoryManager;if(0===this.vboKeysContainer.getVbosCount())return!1;var o=this.vboKeysContainer.getVboKey(0);if(!o.bindDataPosition(e,r))return!1;if(!o.bindDataNormal(e,r))return!1;if(!o.bindDataTexCoord(e,r))return!1;for(var n=this.multiBuildingsElementsArray.length,a=0;a<n;a++){this.multiBuildingsElementsArray[a].render(t,e)}},ee.prototype.isReadyToRender=function(){return this.fileLoadState===c.fileLoadState.PARSE_FINISHED},ee.prototype.parseData=function(t){if(this.fileLoadState!==c.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.dataArrayBuffer)return!1;this.fileLoadState=c.fileLoadState.PARSE_STARTED,void 0===this.vboKeysContainer&&(this.vboKeysContainer=new Nt);var e=this.vboKeysContainer.newVBOVertexIdxCacheKey(),i=this.dataArrayBuffer,r=0,o=t.vboMemoryManager;this.version="";for(var n=0;n<5;n++)this.version+=String.fromCharCode(new Int8Array(i.slice(r,r+1))[0]),r+=1;void 0===this.bbox&&(this.bbox=new y),r=this.bbox.readData(i,r),void 0===this.geoCoords&&(this.geoCoords=new j),this.geoCoords.longitude=new Float64Array(i.slice(r,r+8))[0],r+=8,this.geoCoords.latitude=new Float64Array(i.slice(r,r+8))[0],r+=8,this.geoCoords.altitude=new Float32Array(i.slice(r,r+4))[0],r+=4,r=e.readPositions(i,o,r);var a=new Int8Array(i.slice(r,r+1))[0];r+=1,a&&(r=e.readNormals(i,o,r));var s=new Int8Array(i.slice(r,r+1))[0];r+=1,s&&(r=e.readTexCoords(i,o,r));var l=new Int8Array(i.slice(r,r+1))[0];r+=1,l&&(r=e.readColors(i,o,r));new Int8Array(i.slice(r,r+1))[0];r+=1;var h=new Int32Array(i.slice(r,r+4))[0];r+=4;for(var d=0;d<h;d++){var u=new ie;r=u.parseData(i,r),u.multiBuildingsOwner=this,this.multiBuildingsElementsArray.push(u)}var f=new Int32Array(i.slice(r,r+4))[0];r+=4,f>0&&void 0===this.texturesManager&&(this.texturesManager=new Mt);for(d=0;d<f;d++){var g=new Int32Array(i.slice(r,r+4))[0];r+=4;var p=new Int32Array(i.slice(r,r+4))[0];r+=4;var v="";for(n=0;n<p;n++)v+=String.fromCharCode(new Int8Array(i.slice(r,r+1))[0]),r+=1;var m=new Int32Array(i.slice(r,r+4))[0],x=r+=4,b=r+1*m,C=i.slice(x,b);r+=1*m;var A=this.texturesManager.getOrNewTexture(g);A.textureTypeName="diffuse",A.textureImageFileName=v,A.imageBinaryData=C,A.fileLoadState=c.fileLoadState.LOADING_FINISHED}this.fileLoadState=c.fileLoadState.PARSE_FINISHED};var ie=function(){if(!(this instanceof ie))throw new Error(ot.CONSTRUCT_ERROR);this.multiBuildingsOwner,this.name,this.id,this.bbox,this.geoCoords,this.indexRange,this.localIndexRangesArray};ie.prototype.render=function(t,e){if(void 0===this.localIndexRangesArray)return!1;for(var i=t.getGl(),r=this.localIndexRangesArray.length,o=0;o<r;o++){var n=this.localIndexRangesArray[o],a=n.strIdx,s=n.endIdx-a+1,l=n.attributes.materialId;if(void 0!==l&&l>=0){var h=this.multiBuildingsOwner.texturesManager.getTexture(l);if(void 0!==h&&void 0===h.texId){Mt.newWebGlTextureByEmbeddedImage(i,h.imageBinaryData,h)}void 0!==h&&void 0!==h.texId&&(i.uniform1i(e.colorType_loc,2),e.last_tex_id!==h.texId&&(i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,h.texId),e.last_tex_id=h.texId))}i.drawArrays(i.TRIANGLES,a,s)}return!0},ie.prototype.parseData=function(t,e){this.name="";var i=new Int16Array(t.slice(e,e+2))[0];e+=2;for(var r=0;r<i;r++)this.name+=String.fromCharCode(new Int8Array(t.slice(e,e+1))[0]),e+=1;this.id="";var o=new Int16Array(t.slice(e,e+2))[0];e+=2;for(r=0;r<o;r++)this.id+=String.fromCharCode(new Int8Array(t.slice(e,e+1))[0]),e+=1;void 0===this.bbox&&(this.bbox=new y),e=this.bbox.readData(t,e),void 0===this.geoCoords&&(this.geoCoords=new j),this.geoCoords.longitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.geoCoords.latitude=new Float64Array(t.slice(e,e+8))[0],e+=8,this.geoCoords.altitude=new Float32Array(t.slice(e,e+4))[0],e+=4,void 0===this.indexRange&&(this.indexRange=new Xi),this.indexRange.strIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4,this.indexRange.endIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4,this.localIndexRangesArray=[];var n=new Uint32Array(t.slice(e,e+4))[0];e+=4;for(var a=0;a<n;a++){var s=new Xi;s.strIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4,s.endIdx=new Uint32Array(t.slice(e,e+4))[0],e+=4;var l=new Uint32Array(t.slice(e,e+4))[0];e+=4,s.attributes={materialId:l},this.localIndexRangesArray.push(s)}return e};var re=function(){if(!(this instanceof re))throw new Error(ot.CONSTRUCT_ERROR);this.name="",this.metaData,this.buildingId,this.buildingType,this.buildingFileName="",this.bbox,this.bboxAbsoluteCenterPos,this.motherNeoReferencesArray=[],this.motherNeoReferencesMap,this.motherBlocksArray=[],this.isHighLighted,this.isColorChanged,this.aditionalColor,this.texturesLoaded,this.texturesManager,this.octree,this.currentLod,this.currentVisibleOctreesControler,this.myCameraRelative,this.simpleBuilding3x3Texture,this.lodMeshesMap,this.lodBuildingDatasMap,this.lodBuildingMap,this.applyOcclusionCulling,this.headerDataArrayBuffer,this.attributes};re.prototype.getImageFileNameForLOD=function(t){var e=this.getLodBuildingData(t);if(void 0!==e)return e.textureFileName},re.prototype.setAttribute=function(t,e){void 0===this.attributes&&(this.attributes={}),this.attributes[t]=e},re.prototype.getReferenceObject=function(t){if(void 0!==this.motherNeoReferencesArray)return this.motherNeoReferencesArray[t]},re.prototype.getReferenceObjectsArrayByObjectId=function(t){if(void 0!==this.motherNeoReferencesMap)return this.motherNeoReferencesMap[t]},re.prototype.putReferenceObject=function(t,e){void 0===this.motherNeoReferencesArray&&(this.motherNeoReferencesArray=[]),this.motherNeoReferencesArray[e]=t,void 0===this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={});var i=this.motherNeoReferencesMap[t.objectId];void 0===i&&(i=[]),i.push(t),this.motherNeoReferencesMap[t.objectId]=i},re.prototype.getRenderSettingApplyOcclusionCulling=function(){return this.applyOcclusionCulling},re.prototype.setRenderSettingApplyOcclusionCulling=function(t){this.applyOcclusionCulling=t},re.prototype.deleteObjectsModelReferences=function(t,e){this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={},this.motherNeoReferencesMap=void 0);for(var i=this.motherBlocksArray.length,r=0;r<i;r++)this.motherBlocksArray[r]&&this.motherBlocksArray[r].deleteObjects(t,e),this.motherBlocksArray[r]=void 0;this.motherBlocksArray=[];var o=this.motherNeoReferencesArray.length;for(r=0;r<o;r++)this.motherNeoReferencesArray[r]&&this.motherNeoReferencesArray[r].deleteObjects(t,e),this.motherNeoReferencesArray[r]=void 0;if(this.motherNeoReferencesArray=[],this.texturesLoaded){var n,a=this.texturesLoaded.length;for(r=0;r<a;r++)(n=this.texturesLoaded[r])&&n.texId&&(t.deleteTexture(n.texId),n.texId=void 0,n.fileLoadState=c.fileLoadState.READY)}},re.prototype.deleteObjectsLodMesh=function(t,e,i){if(void 0!==this.lodMeshesMap&&Object.prototype.hasOwnProperty.call(this.lodMeshesMap,i)){var r=this.lodMeshesMap[i];if(void 0===r)return;delete this.lodMeshesMap[i],r.deleteObjects(t,e),r=void 0}},re.prototype.deleteObjectsLod2=function(t,e){void 0!==this.octree&&this.octree.deleteObjectsLego(t,e)},re.prototype.isDeletable=function(){return void 0===this.attributes||void 0===this.attributes.isDeletable||!1!==this.attributes.isDeletable},re.prototype.deleteObjects=function(t,e,i){if(this.isDeletable()){if(i&&this.metaData.deleteObjects(),this.metaData.fileLoadState=c.fileLoadState.READY,this.deleteObjectsModelReferences(t,e),void 0!==this.octree&&this.octree.deleteObjects(t,e),this.octree=void 0,this.allFilesLoaded=!1,this.isReadyToRender=!1,this.texturesLoaded){for(var r=this.texturesLoaded.length,o=0;o<r;o++)this.texturesLoaded[o]&&this.texturesLoaded[o].deleteObjects(t),this.texturesLoaded[o]=void 0;this.texturesLoaded.length=0}if(this.texturesLoaded=void 0,void 0!==this.lodMeshesMap){for(var n in this.lodMeshesMap)if(Object.prototype.hasOwnProperty.call(this.lodMeshesMap,n)){var a=this.lodMeshesMap[n];if(void 0===a)continue;a.deleteObjects(t,e),a=void 0}this.lodMeshesMap=void 0}}},re.prototype.deleteLodMesh=function(t,e,i){if(void 0!==this.lodMeshesMap){var r=this.lodMeshesMap[e];void 0!==r&&(r.deleteObjects(t,i),r=void 0)}},re.prototype.getBBox=function(){return void 0!==this.bbox?this.bbox:void 0!==this.metaData&&void 0!==this.metaData.bbox?this.metaData.bbox:void 0},re.prototype.getBBoxCenterPositionWorldCoord=function(t){return void 0===this.bboxAbsoluteCenterPos&&this.calculateBBoxCenterPositionWorldCoord(t),this.bboxAbsoluteCenterPos},re.prototype.calculateBBoxCenterPositionWorldCoord=function(t){var e,i;(e=this.bbox.getCenterPoint(e),this.bboxAbsoluteCenterPos=t.tMatrix.transformPoint3D(e,this.bboxAbsoluteCenterPos),t.pivotPointTraslation)&&(i=t.tMatrix.rotatePoint3D(t.pivotPointTraslation,i),this.bboxAbsoluteCenterPos.add(i.x,i.y,i.z))},re.prototype.getTextureId=function(t){for(var e,i=this.texturesLoaded.length,r=!1,o=0;!r&&o<i;)this.texturesLoaded[o].textureImageFileName===t.textureImageFileName&&(r=!0,e=this.texturesLoaded[o].texId),o++;return e},re.prototype.getSameTexture=function(t){for(var e,i=this.texturesLoaded.length,r=!1,o=0;!r&&o<i;)this.texturesLoaded[o].textureImageFileName===t.textureImageFileName&&(r=!0,e=this.texturesLoaded[o]),o++;return e},re.prototype.updateCurrentVisibleIndicesExterior=function(t,e,i){this._neoRefLists_Container.updateCurrentVisibleIndicesOfLists(t,e,i)},re.prototype.updateCurrentAllIndicesExterior=function(){this._neoRefLists_Container.updateCurrentAllIndicesOfLists()},re.prototype.isCameraInsideOfBuilding=function(t,e,i){return this.metaData.bbox.isPoint3dInside(t,e,i)},re.prototype.getTransformedRelativeEyePositionToBuilding=function(t,e,i,r){var o=this.buildingPosition,n=t-o.x,a=e-o.y,s=i-o.z;void 0===this.buildingPosMatInv&&(this.buildingPosMatInv=new rt,this.buildingPosMatInv.setByFloat32Array(this.moveMatrixInv));var l=new ur;return void 0===r&&(r=new ur),l.set(n,a,s),r=this.buildingPosMatInv.transformPoint3D(l,r)},re.prototype.getHeaderVersion=function(){return this.metaData?this.metaData.version:void 0},re.prototype.getLodBuildingData=function(t){if(void 0!==this.lodBuildingDatasMap)return this.lodBuildingDatasMap[t]},re.prototype.getOrNewLodMesh=function(t){void 0===this.lodMeshesMap&&(this.lodMeshesMap={});var e=this.lodMeshesMap[t];return void 0===e&&((e=new Yt).fileLoadState=c.fileLoadState.READY,e.legoKey=this.buildingId+"_"+t,this.lodMeshesMap[t]=e),e},re.prototype.getOrNewLodBuilding=function(t){void 0===this.lodBuildingMap&&(this.lodBuildingMap={});var e=this.lodBuildingMap[t];return void 0===e&&((e=new Zt).attributes={},this.lodBuildingMap[t]=e),e},re.prototype.getCurrentLodString=function(){return this.getLodBuildingData(this.currentLod).geometryFileName},re.prototype.getLowerSkinLodToLoad=function(t){for(var e,i=5;i>=0&&!(i<t);i--){var r,o="lod"+i.toString();if(void 0!==this.lodBuildingMap&&(r=this.lodBuildingMap[o]),void 0===r||void 0===r.skinLego||r.skinLego.fileLoadState!==c.fileLoadState.PARSE_FINISHED){e=i;break}if(void 0===r.skinLego.vbo_vicks_container.vboCacheKeysArray){e=i;break}if(r.skinLego.vbo_vicks_container.vboCacheKeysArray[0]&&r.skinLego.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord){if(void 0===r.texture){e=i;break}if(void 0===r.texture.texId){if(r.texture.fileLoadState!==c.fileLoadState.BINDING_FINISHED&&r.texture.fileLoadState!==c.fileLoadState.LOADING_STARTED){e=i;break}break}}}return e},re.prototype.getLowerSkinLodToLoad__original=function(t){for(var e,i=5;i>=0&&!(i<t);i--){var r=this.getLodBuildingData(i);if(void 0!==r&&!r.isModelRef){var o,n=r.geometryFileName;if(void 0!==this.lodMeshesMap&&(o=this.lodMeshesMap[n]),void 0===o||o.fileLoadState!==c.fileLoadState.PARSE_FINISHED){e=i;break}if(void 0===o.vbo_vicks_container.vboCacheKeysArray){e=i;break}if(o.vbo_vicks_container.vboCacheKeysArray[0]&&o.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord&&(void 0===o.texture||void 0===o.texture.texId)){e=i;break}}}return e},re.prototype.getCurrentSkin=function(){if(void 0!==this.lodMeshesMap){var t=this.getLodBuildingData(this.currentLod);if(void 0!==t){var e=t.geometryFileName,i=this.lodBuildingMap[e];return void 0!==i&&i.isReadyToRender()?i:(0===this.currentLod?void 0!==(i=this.lodBuildingMap.lod0)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod1)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod2)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod3)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod4)&&i.isReadyToRender()||(i=this.lodBuildingMap.lod5):1===this.currentLod?void 0!==(i=this.lodBuildingMap.lod1)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod2)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod3)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod4)&&i.isReadyToRender()||(i=this.lodBuildingMap.lod5):2===this.currentLod?void 0!==(i=this.lodBuildingMap.lod2)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod3)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod4)&&i.isReadyToRender()||(i=this.lodBuildingMap.lod5):3===this.currentLod?void 0!==(i=this.lodBuildingMap.lod3)&&i.isReadyToRender()||void 0!==(i=this.lodBuildingMap.lod4)&&i.isReadyToRender()||(i=this.lodBuildingMap.lod5):4===this.currentLod?void 0!==(i=this.lodBuildingMap.lod4)&&i.isReadyToRender()||(i=this.lodBuildingMap.lod5):5===this.currentLod&&(i=this.lodBuildingMap.lod5),i)}}},re.prototype.getCurrentSkin__original=function(){if(void 0!==this.lodMeshesMap){var t,e=this.getLodBuildingData(this.currentLod);if(void 0!==e){var i=e.geometryFileName;return void 0!==(t=this.lodMeshesMap[i])&&t.isReadyToRender()?t:(0===this.currentLod?void 0!==(t=this.lodMeshesMap.lod0)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod1)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):1===this.currentLod?void 0!==(t=this.lodMeshesMap.lod1)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):2===this.currentLod?void 0!==(t=this.lodMeshesMap.lod2)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):3===this.currentLod?void 0!==(t=this.lodMeshesMap.lod3)&&t.isReadyToRender()||void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):4===this.currentLod?void 0!==(t=this.lodMeshesMap.lod4)&&t.isReadyToRender()||(t=this.lodMeshesMap.lod5):5===this.currentLod&&(t=this.lodMeshesMap.lod5),t)}}},re.prototype.manageNeoReferenceTexture=function(t,e){void 0===this.texturesManager&&(this.texturesManager=new Mt);var i=void 0,r=this.metaData.version;if("v"===r[0]){if(void 0===t.texture)return;if(void 0===t.texture.texId&&""!==t.texture.textureImageFileName){void 0===this.texturesLoaded&&(this.texturesLoaded=[]);var o=this.getSameTexture(t.texture);if(void 0===o){if(e.backGround_fileReadings_count>10)return;if(t.texture.fileLoadState===c.fileLoadState.READY){var n=e.sceneState.gl;t.texture.texId=n.createTexture();var a=this.projectFolderName,s=e.readerWriter.geometryDataPath+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+t.texture.textureImageFileName;this.texturesLoaded.push(t.texture),e.readerWriter.readNeoReferenceTexture(n,s,t.texture,this,e),e.backGround_fileReadings_count++}}else o.fileLoadState===c.fileLoadState.LOADING_FINISHED&&(t.texture=o)}return t.texture.fileLoadState}if("0"===r[0]&&"0"===r[2]&&"1"===r[4]){if(void 0===t.texture||t.texture.fileLoadState===c.fileLoadState.READY){var l=t.materialId;if(i=this.texturesLoaded[l],t.texture=i,i&&void 0===i.texId&&""!==i.textureImageFileName){if(e.backGround_fileReadings_count>10)return;if(i.fileLoadState===c.fileLoadState.READY){n=e.sceneState.gl;i.texId=n.createTexture();a=this.projectFolderName,s=e.readerWriter.getCurrentDataPath()+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+i.textureImageFileName;e.readerWriter.readNeoReferenceTexture(n,s,i,this,e),e.backGround_fileReadings_count++}}}if(t.texture)return t.texture.fileLoadState}else if("0"===r[0]&&"0"===r[2]&&"2"===r[4]){if(void 0===this.metaData.projectDataType||this.metaData.projectDataType>3)return t.texture.fileLoadState;if(void 0===t.texture||t.texture.fileLoadState===c.fileLoadState.READY){l=t.materialId;if(i=this.texturesLoaded[l],t.texture=i,i&&void 0===i.texId&&""!==i.textureImageFileName){if(e.backGround_fileReadings_count>10)return;if(i.fileLoadState===c.fileLoadState.READY){n=e.sceneState.gl;i.texId=n.createTexture();a=this.projectFolderName,s=e.readerWriter.getCurrentDataPath()+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+i.textureImageFileName;e.readerWriter.readNeoReferenceTexture(n,s,i,this,e),e.backGround_fileReadings_count++}}}if(t.texture)return t.texture.fileLoadState}},re.prototype.getShaderName=function(t,e,i){var r;return 0===i?t<=1&&(r="modelRefDepth"):1===i?t<=2&&(r="modelRefSsao"):2===i&&t<=1&&(r="modelRefSsao"),r},re.prototype.parseTexturesList=function(t,e){var i=new TextDecoder("utf-8"),r=ge.readInt32(t,e,e+4);e+=4;for(var o=0;o<r;o++){var n,a,s=ge.readUInt32(t,e,e+4);e+=4,n=i.decode(new Int8Array(t.slice(e,e+s))),e+=s;var l=ge.readUInt32(t,e,e+4);e+=4;var h=new Uint8Array(t.slice(e,e+l));if(e+=l,a=i.decode(h),l>0){var d=new At;d.textureTypeName=n,d.textureImageFileName=a,void 0===this.texturesLoaded&&(this.texturesLoaded=[]),this.texturesLoaded.push(d)}}return e},re.prototype.getTriangles=function(t){if(void 0===this.motherNeoReferencesArray||void 0===this.motherBlocksArray)return!1;var e;void 0===t&&(t=[]);for(var i=this.motherNeoReferencesArray.length,r=0;r<i;r++)void 0!==(e=this.motherNeoReferencesArray[r])&&(t=e.getTriangles(this,t));return t},re.prototype.allModelsAndReferencesAreParsed=function(t){if(void 0===this.octree)return!1;var e=[];this.octree.extractLowestOctreesIfHasTriPolyhedrons(e);for(var i=e.length,r=0;r<i;r++){var o=e[r];if(void 0===o.neoReferencesMotherAndIndices)return!1;if(o.neoReferencesMotherAndIndices.fileLoadState!==c.fileLoadState.PARSE_FINISHED)return!1;if(o.neoReferencesMotherAndIndices.blocksList.fileLoadState!==c.fileLoadState.PARSE_FINISHED)return!1}return!0},re.prototype.forceToLoadModelsAndReferences=function(t){var e={parseImmediately:!0},i=[];this.octree.extractLowestOctreesIfHasTriPolyhedrons(i);for(var r=i.length,o=0;o<r;o++){var n=i[o];if(0!==n.triPolyhedronsCount){var a=t.readerWriter.geometryDataPath,s=this.buildingFileName,l=this.projectFolderName,h=!1,d=this.attributes;if(void 0!==d&&void 0!==d.keepDataArrayBuffers&&!0===d.keepDataArrayBuffers&&(h=!0),void 0===n.neoReferencesMotherAndIndices&&(n.neoReferencesMotherAndIndices=new ae,n.neoReferencesMotherAndIndices.motherNeoRefsList=this.motherNeoReferencesArray),n.neoReferencesMotherAndIndices.fileLoadState===c.fileLoadState.READY){void 0===n.neoReferencesMotherAndIndices.blocksList&&(n.neoReferencesMotherAndIndices.blocksList=new zt("0.0.1")),h&&(n.neoReferencesMotherAndIndices.blocksList.keepDataArrayBuffers=h);var u=a+"/"+l+"/"+s+"/References"+"/"+n.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(u,n,t,e)}else n.neoReferencesMotherAndIndices.fileLoadState===c.fileLoadState.LOADING_FINISHED&&ce.parseOctreesLod0References(n,t);var f=n.neoReferencesMotherAndIndices.blocksList;if(void 0===f)return;if(f.fileLoadState===c.fileLoadState.READY){var g=a+"/"+l+"/"+s+"/Models"+"/"+n.octree_number_name.toString()+"_Model";t.readerWriter.getNeoBlocksArraybuffer(g,n,t,e)}else f.fileLoadState===c.fileLoadState.LOADING_FINISHED&&ce.parseArrayOctreesLod0Models(n,t)}}return!0},re.prototype.makeCollisionCheckOctree=function(t){if(void 0===this.motherNeoReferencesArray||void 0===this.motherBlocksArray)return!1;if(void 0===this.collisionCheckOctree){var e=new Ht,i=this.octree;if(e.centerPos.copyFrom(i.centerPos),e.half_dx=i.half_dx,e.half_dy=i.half_dy,e.half_dz=i.half_dz,e.octree_level=i.octree_level,e.trianglesArray=this.getTriangles(),!e.trianglesArray)return!1;var r={};r.desiredMinOctreeSize=t,e.makeTreeByTrianglesArray(r),this.collisionCheckOctree=e}var o=this.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData(),n=o.pivotPointTraslationLC,a=!0;void 0!==n&&(this.collisionCheckOctree.translate(n,a),a=!1);var s=o.tMatrix;this.collisionCheckOctree.transformByMatrix4(s,a)},re.prototype.getCollisionCheckOctree=function(){return this.collisionCheckOctree},re.prototype.parseHeader=function(t,e){void 0===this.metaData&&(this.metaData=new Jt),void 0===e&&(e=0);var i=this.metaData;return e=i.parseFileHeaderAsimetricVersion(t,e),void 0===this.octree&&(this.octree=new de(void 0)),this.octree.neoBuildingOwnerId=this.buildingId,this.octree.octreeKey=this.buildingId+"_"+this.octree.octree_number_name,e=5===i.projectDataType?this.octree.parsePyramidVersion(t,e,this):this.octree.parseAsimetricVersion(t,e,this),i.oct_min_x=this.octree.centerPos.x-this.octree.half_dx,i.oct_max_x=this.octree.centerPos.x+this.octree.half_dx,i.oct_min_y=this.octree.centerPos.y-this.octree.half_dy,i.oct_max_y=this.octree.centerPos.y+this.octree.half_dy,i.oct_min_z=this.octree.centerPos.z-this.octree.half_dz,i.oct_max_z=this.octree.centerPos.z+this.octree.half_dz,"0.0.1"!==i.version&&"0.0.2"!==i.version||(e=this.parseTexturesList(t,e),e=this.parseLodBuildingData(t,e)),i.fileLoadState=c.fileLoadState.PARSE_FINISHED,this.headerDataArrayBuffer=void 0,this.bbox=this.metaData.bbox,e},re.prototype.parseLodBuildingData=function(t,e){var i,r=new Uint8Array(t.slice(e,e+1))[0];if(e+=1,void 0!==r){this.lodBuildingDatasMap={};for(var o=new TextDecoder("utf-8"),n=0;n<r;n++){var a=new Qt;a.lod=new Uint8Array(t.slice(e,e+1))[0],e+=1,a.isModelRef=new Uint8Array(t.slice(e,e+1))[0],e+=1,2===a.lod&&(i=new Int8Array(t.slice(e,e+1))[0],e+=1,a.textureFileName="",a.textureFileName=o.decode(new Int8Array(t.slice(e,e+i))),e+=i),a.isModelRef||(i=new Int8Array(t.slice(e,e+1))[0],e+=1,a.geometryFileName="",a.geometryFileName=o.decode(new Int8Array(t.slice(e,e+i))),e+=i,i=new Int8Array(t.slice(e,e+1))[0],e+=1,a.textureFileName="",a.textureFileName=o.decode(new Int8Array(t.slice(e,e+i))),e+=i),this.lodBuildingDatasMap[a.lod]=a}new Uint8Array(t.slice(e,e+1))[0];e+=1}return e},re.prototype.prepareSkin=function(t){var e,i=this.getHeaderVersion();if(void 0===i)return!1;if("0"!==i[0])return!1;this.currentLod||(this.currentLod=this.nodeOwner.data.currentLod),e=this.getLowerSkinLodToLoad(this.currentLod);var r=this.getLodBuildingData(e);if(void 0===r)return!1;if(r.isModelRef)return!1;var o=this.projectFolderName,n=this.buildingFileName,a=t.readerWriter.geometryDataPath,s=r.textureFileName,l="lod"+r.lod.toString(),h=this.getOrNewLodBuilding(l);"noTexture"!==s&&(h.attributes.hasTexture=!0,h.textureName=s);var d=r.geometryFileName,u=this.getOrNewLodMesh(d);if(u.textureName=s,h.skinLego=u,-1===u.fileLoadState)return!1;var f=this.nodeOwner.data.attributes.fromSmartTile;if(void 0===f&&(f=!1),u.fileLoadState===c.fileLoadState.READY){if(f){if(e<3&&t.readerWriter.skinLegos_requested<5){var g=a+"/"+o+"/"+n+"/"+d;t.readerWriter.getLegoArraybuffer(g,u,t),void 0===u.vbo_vicks_container.vboCacheKeysArray&&(u.vbo_vicks_container.vboCacheKeysArray=[])}}else if(t.readerWriter.skinLegos_requested<5){g=a+"/"+o+"/"+n+"/"+d;t.readerWriter.getLegoArraybuffer(g,u,t),void 0===u.vbo_vicks_container.vboCacheKeysArray&&(u.vbo_vicks_container.vboCacheKeysArray=[])}}else if(u.fileLoadState===c.fileLoadState.LOADING_FINISHED)u.parseArrayBuffer(u.dataArrayBuffer,t);else if(u.vbo_vicks_container.vboCacheKeysArray[0]&&u.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord)if(void 0===h.texture){if(f){if(e<3&&t.fileRequestControler.lowLodImagesRequestedCount<4){h.texture=new At;var p=a+"/"+o+"/"+n+"/"+s,v=t.sceneState.gl,y=!0;t.readerWriter.readLegoSimpleBuildingTexture(v,p,h.texture,t,y)}}else if(t.fileRequestControler.lowLodImagesRequestedCount<4){h.texture=new At;p=a+"/"+o+"/"+n+"/"+s,v=t.sceneState.gl,y=!0;t.readerWriter.readLegoSimpleBuildingTexture(v,p,h.texture,t,y)}}else if(h.texture.fileLoadState===c.fileLoadState.LOADING_FINISHED&&void 0===h.texture.texId){v=t.sceneState.gl;Mt.newWebGlTextureByEmbeddedImage(v,h.texture.imageBinaryData,h.texture),t.readerWriter.skinLegos_requested++}return!0},re.prototype.renderCollisionCheckSpheres=function(t,e,i){if(void 0!==this.collisionCheckOctree){var r=[];this.collisionCheckOctree.extractLowestOctreesIfHasTriangles(r);for(var o=r.length,n=0;n<o;n++);}},re.prototype.render=function(t,e,i,r,o,n){var a=t.sceneState.gl;if(void 0!==n&&(this.currentLod=n),5!==this.metaData.projectDataType){if(this.currentLod<=2){var s=this.getLodBuildingData(this.currentLod);if(s&&!s.isModelRef)this.renderSkin(t,e,i);else{var l=this.renderDetailed(t,e,i,r,o);if(void 0===this.currentVisibleOctreesControler)this.renderSkin(t,e,i);else{var h=this.currentVisibleOctreesControler.currentVisibles0.length,d=this.currentVisibleOctreesControler.currentVisibles1.length,c=this.currentVisibleOctreesControler.currentVisibles2.length;2===this.metaData.projectDataType?l<=0&&this.renderSkin(t,e,i):l<.4*(h+d+c)&&this.renderSkin(t,e,i)}}}else this.currentLod>2&&this.renderSkin(t,e,i);if(void 0!==this.collisionCheckOctree&&void 0!==this.collisionCheckOctree.currentVisibleOctreesArray){a.uniform1i(e.refMatrixType_loc,0);for(var u=this.collisionCheckOctree.currentVisibleOctreesArray,f=u.length,g=0;g<f;g++)u[g].render(t,e,i,void 0)}}},re.prototype.renderShadowMesh=function(t,e,i){var r=this.getCurrentSkin();if(void 0!==r&&r.isReadyToRender()){var o=t.sceneState.gl;o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[.7,.7,.7,1]),o.uniform1i(e.refMatrixType_loc,0),r.render(t,i,!0,e,this)}},re.prototype.renderSkin=function(t,e,i){var r=this.getCurrentSkin();if(void 0!==r&&r.isReadyToRender()){var o=t.sceneState.gl;t.renderer.currentObjectsRendering.curOctree=this;var n,a=t.renderer.currentObjectsRendering;2===i&&(t.selectionManager,t.selectionColor,s=!1,n=a.curNode,a.curOctree);var s=!0;if(1===i)o.uniform4fv(e.oneColor4_loc,[.7,.7,.7,1]),this.isHighLighted?(o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,this.highLightColor4),s=!1):this.isColorChanged&&(o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a]),s=!1),s&&(void 0!==r.texture&&r.texture.texId?(e.enableVertexAttribArray(e.texCoord2_loc),o.uniform1i(e.colorType_loc,2),e.last_tex_id!==r.texture.texId&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,r.texture.texId),e.last_tex_id=r.texture.texId)):void 0!==t.textureAux_1x1?(e.enableVertexAttribArray(e.texCoord2_loc),o.uniform1i(e.colorType_loc,2),o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,t.textureAux_1x1)):o.uniform1i(e.colorType_loc,0));else if(2===i){var l;l=t.selectionColor.getAvailableColor(l);var h=t.selectionColor.decodeColor3(l.r,l.g,l.b);t.selectionManager.setCandidates(h,void 0,void 0,this,n),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[l.r/255,l.g/255,l.b/255,1])}else 3===i&&(o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[.7,.7,.7,1]));o.uniform1i(e.refMatrixType_loc,0),r.render(t,i,s,e,this)}},re.prototype.renderSkin__original=function(t,e,i){var r=this.getCurrentSkin();if(void 0!==r&&r.fileLoadState===c.fileLoadState.PARSE_FINISHED){var o=t.sceneState.gl;t.renderer.currentObjectsRendering.curOctree=this;var n,a=t.renderer.currentObjectsRendering;2===i&&(t.selectionManager,t.selectionColor,s=!1,n=a.curNode,a.curOctree);var s=!0;if(1===i)o.uniform4fv(e.oneColor4_loc,[.7,.7,.7,1]),this.isHighLighted?(o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,this.highLightColor4),s=!1):this.isColorChanged&&(o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a]),s=!1),s&&(void 0!==r.texture&&r.texture.texId?(e.enableVertexAttribArray(e.texCoord2_loc),o.uniform1i(e.colorType_loc,2),e.last_tex_id!==r.texture.texId&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,r.texture.texId),e.last_tex_id=r.texture.texId)):void 0!==t.textureAux_1x1?(e.enableVertexAttribArray(e.texCoord2_loc),o.uniform1i(e.colorType_loc,2),o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,t.textureAux_1x1)):o.uniform1i(e.colorType_loc,0));else if(2===i){var l;l=t.selectionColor.getAvailableColor(l);var h=t.selectionColor.decodeColor3(l.r,l.g,l.b);t.selectionManager.setCandidates(h,void 0,void 0,this,n),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[l.r/255,l.g/255,l.b/255,1])}o.uniform1i(e.refMatrixType_loc,0),r.render(t,i,s,e)}},re.prototype.renderDetailed=function(t,e,i,r,o){var n=0;if(void 0===this.currentVisibleOctreesControler)return n;var a,s=!1;t.sceneState.gl;0===i?s=!1:1===i&&(s=!!(this.texturesLoaded&&this.texturesLoaded.length>0)),t.renderer.currentObjectsRendering.curBuilding=this;var l,h,d,c=this.getRenderSettingApplyOcclusionCulling();void 0===c&&(c=!0),c&&(l=this.myCameraRelative.position.x,h=this.myCameraRelative.position.y,d=this.myCameraRelative.position.z);for(var u=0,f=this.currentVisibleOctreesControler.currentVisibles0.length,g=0;g<f;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles0[g]).neoReferencesMotherAndIndices&&(a.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(l,h,d,c),a.lod=0,a.renderContent(t,this,i,s,e,u,0,o)&&n++);u=.45,f=this.currentVisibleOctreesControler.currentVisibles1.length;for(g=0;g<f;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles1[g]).neoReferencesMotherAndIndices&&(a.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(l,h,d,c),a.lod=1,a.renderContent(t,this,i,s,e,u,0,o)&&n++);e.disableVertexAttribArray(e.color4_loc),f=this.currentVisibleOctreesControler.currentVisibles2.length;for(g=0;g<f;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles2[g]).lego&&(a.lod=2,a.renderContent(t,this,i,s,e,u,0,o)&&n++);return n};var oe=function(){if(!(this instanceof oe))throw new Error(ot.CONSTRUCT_ERROR);this.neoBuildingsArray=[]};oe.prototype.newNeoBuilding=function(){var t=new re;return this.neoBuildingsArray.push(t),t},oe.prototype.getNeoBuildingByTypeId=function(t,e){for(var i,r=this.neoBuildingsArray.length,o=!1,n=0;!o&&n<r;)this.neoBuildingsArray[n].buildingType===t&&this.neoBuildingsArray[n].buildingId===e&&(o=!0,i=this.neoBuildingsArray[n]),n++;return i},oe.prototype.get=function(t){return this.neoBuildingsArray[t]},oe.prototype.add=function(t){void 0!==t&&this.neoBuildingsArray.push(t)};var ne=function(){if(!(this instanceof ne))throw new Error(ot.CONSTRUCT_ERROR);this._id=0,this.objectId="",this._block_idx=-1,this._originalMatrix4=new rt,this._matrix4=new rt,this.tMatrixAuxArray,this.refMatrixType=2,this.refTranslationVec,this.vBOVertexIdxCacheKeysContainer,this.materialId,this.hasTexture=!1,this.texture,this.color4,this.aditionalColor,this.moveVectorRelToBuilding,this.moveVector,this.renderingFase=!1,this.blendAlpha=0,this.birthTime,this.isAdult=!1};ne.prototype.getCenterPositionWC=function(t,e){var i=this._block_idx,r=t.motherBlocksArray[i];if(void 0===r)return e;var o=t.nodeOwner;if(void 0===o)return e;var n=r.bbox.getCenterPoint();return 1===this.refMatrixType?n.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(n=this._originalMatrix4.transformPoint3D(n,n)),this.moveVectorRelToBuilding&&n.add(this.moveVectorRelToBuilding.x,this.moveVectorRelToBuilding.y,this.moveVectorRelToBuilding.z),e=o.data.geoLocDataManager.getCurrentGeoLocationData().tMatrix.transformPoint3D(n,e)},ne.prototype.swapRenderingFase=function(){this.renderingFase=!this.renderingFase},ne.prototype.getBlendAlpha=function(t){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=t),void 0===this.blendAlpha&&(this.blendAlpha=0);var e=1e-4*(t-this.birthTime);return this.blendAlpha+=e,this.blendAlpha>=1&&(this.isAdult=!0),this.blendAlpha},ne.prototype.multiplyTransformMatrix=function(t){this._matrix4=this._originalMatrix4.getMultipliedByMatrix(t)},ne.prototype.multiplyKeyTransformMatrix=function(t,e){void 0===this.tMatrixAuxArray&&(this.tMatrixAuxArray=[]),this.tMatrixAuxArray[t]=this._originalMatrix4.getMultipliedByMatrix(e,this.tMatrixAuxArray[t]),this.moveVectorRelToBuilding&&(this.moveVector=e.rotatePoint3D(this.moveVectorRelToBuilding,this.moveVector))},ne.prototype.hasKeyMatrix=function(t){return void 0!==this.tMatrixAuxArray&&void 0!==this.tMatrixAuxArray[t]},ne.prototype.isReadyToRender=function(){return void 0!==this.tMatrixAuxArray},ne.prototype.solveReferenceColorOrTexture=function(t,e,i,r){var o=t.sceneState.gl,n=!1;t.selectionManager.parentSelected&&t.objectSelected===this&&(n=!0),e.isHighLighted?(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,t.highLightColor4)):e.isColorChanged?(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,[e.aditionalColor.r,e.aditionalColor.g,e.aditionalColor.b,e.aditionalColor.a])):this.aditionalColor?(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a])):t.magoPolicy.getObjectMoveMode()===c.moveMode.OBJECT&&n?(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,[1,0,0,1])):t.magoPolicy.colorChangedObjectId===this.objectId?(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,[t.magoPolicy.color[0],t.magoPolicy.color[1],t.magoPolicy.color[2],1])):this.hasTexture?void 0!==this.texture&&void 0!==this.texture.texId?(o.uniform1i(i.colorType_loc,2),i.last_tex_id!==this.texture.texId&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,this.texture.texId),i.last_tex_id=this.texture.texId)):(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,[.8,0,.8,1])):(o.uniform1i(i.bUse1Color_loc,!0),this.color4?(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,[this.color4.r/255,this.color4.g/255,this.color4.b/255,this.color4.a/255])):(o.uniform1i(i.colorType_loc,0),o.uniform4fv(i.oneColor4_loc,[.8,.8,.8,1])))},ne.prototype.getTriangles=function(t,e){if(void 0===t||void 0===t.motherBlocksArray)return motherBlocksArray;void 0===e&&(e=[]);var i=this._block_idx,r=t.motherBlocksArray[i];if(!r)return e;for(var o,n=r.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length,a=this._originalMatrix4,s={},l=0;l<n;l++){var h=(o=r.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[l]).keepedPosDataArray;if(void 0===h)return e;h.length;for(var d=o.keepedIdxDataArray,c=d.length/3,u=0;u<c;u++){var f=d[3*u],g=d[3*u+1],p=d[3*u+2],v=s[f];if(void 0===v){var y=new ur(h[3*f],h[3*f+1],h[3*f+2]);1===this.refMatrixType?y.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(y=a.transformPoint3D(y,y)),v=new jr(y),s[f]=v}var m=s[g];if(void 0===m){var x=new ur(h[3*g],h[3*g+1],h[3*g+2]);1===this.refMatrixType?x.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(x=a.transformPoint3D(x,x)),m=new jr(x),s[g]=m}var b=s[p];if(void 0===b){var C=new ur(h[3*p],h[3*p+1],h[3*p+2]);1===this.refMatrixType?C.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(C=a.transformPoint3D(C,C)),b=new jr(C),s[p]=b}var A=new Or(v,m,b);e.push(A)}}return e},ne.prototype.render=function(t,e,i,r,o,n,a){if(!this.isReadyToRender())return!1;if(this.hasTexture){if(e.manageNeoReferenceTexture(this,t)!==c.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.texture)return!1;if(void 0===this.texture.texId)return!1}if(2===i&&"C1826"===this.objectId)t.currentFrustumIdx;var s,l,h,d,u=t.renderer.currentObjectsRendering;2===i&&(s=t.selectionManager,l=t.selectionColor,r=!1,h=u.curNode,d=u.curOctree);var f=t.sceneState.gl,g=this._block_idx,p=e.motherBlocksArray[g];if(void 0===p)return!1;if((t.mouseLeftDown||t.mouseMiddleDown)&&(a=.5),t.currentProcess!==c.magoCurrentProcess.ColorCodeRendering&&!p.isReadyToRender(this,t,a)&&t.objectSelected!==this)return!1;if(1===i)this.solveReferenceColorOrTexture(t,e,o,u);else if(2===i){this.selColor4=l.getAvailableColor(this.selColor4);var v=l.decodeColor3(this.selColor4.r,this.selColor4.g,this.selColor4.b);s.setCandidates(v,this,d,e,h),this.selColor4&&f.uniform4fv(o.oneColor4_loc,[this.selColor4.r/255,this.selColor4.g/255,this.selColor4.b/255,1])}if(this.aditionalColor=void 0,void 0===t.isTrailRender||!1===t.isTrailRender){var y=this.getBlendAlpha(t.currTime);f.uniform1f(o.externalAlpha_loc,y)}var m,x=p.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length;f.uniform1i(o.refMatrixType_loc,this.refMatrixType),1===this.refMatrixType?f.uniform3fv(o.refTranslationVec_loc,this.refTranslationVec):2===this.refMatrixType&&f.uniformMatrix4fv(o.refMatrix_loc,!1,this.tMatrixAuxArray[n]._floatArrays),void 0!==this.moveVector?(f.uniform1i(o.hasAditionalMov_loc,!0),f.uniform3fv(o.aditionalMov_loc,[this.moveVector.x,this.moveVector.y,this.moveVector.z]),o.last_isAditionalMovedZero=!1):o.last_isAditionalMovedZero||(f.uniform1i(o.hasAditionalMov_loc,!1),f.uniform3fv(o.aditionalMov_loc,[0,0,0]),o.last_isAditionalMovedZero=!0);for(var b=0;b<x;b++){if(!(m=p.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[b]).bindDataPosition(o,t.vboMemoryManager))return!1;if(1===i){if(!m.bindDataNormal(o,t.vboMemoryManager))return!1;if(r&&this.hasTexture)if(p.vertexCount<=this.vertexCount){if(!this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[b].bindDataTexCoord(o,t.vboMemoryManager))return!1}else o.disableVertexAttribArray(o.texCoord2_loc);else o.disableVertexAttribArray(o.texCoord2_loc)}var C;if(t.isCameraMoving?C=m.indicesCount:t.thereAreUrgentOctrees?(C=m.bigTrianglesIndicesCount)>m.indicesCount&&(C=m.indicesCount):C=m.indicesCount,!m.bindDataIndice(o,t.vboMemoryManager))return!1;f.drawElements(f.TRIANGLES,C,f.UNSIGNED_SHORT,0),1===i&&(t.sceneState.trianglesRenderedCount+=C/3)}return!0},ne.prototype.deleteObjects=function(t,e){this._id=void 0,this._block_idx=void 0,this._matrix4._floatArrays=void 0,this._matrix4=void 0,this._originalMatrix4._floatArrays=void 0,this._originalMatrix4=void 0,this.hasTexture=void 0,this.texture=void 0,this.color4&&this.color4.deleteObjects(),this.color4=void 0,this.selColor4&&this.selColor4.deleteObjects(),this.selColor4=void 0,this.moveVector&&this.moveVector.deleteObjects(),this.moveVector=void 0,this.bRendered=void 0,void 0!==this.vBOVertexIdxCacheKeysContainer&&(this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(t,e),this.vBOVertexIdxCacheKeysContainer=void 0)};var ae=function(){if(!(this instanceof ae))throw new Error(ot.CONSTRUCT_ERROR);this.motherNeoRefsList,this.neoRefsIndices=[],this.modelReferencedGroupsList,this.blocksList,this.fileLoadState=0,this.dataArraybuffer,this.succesfullyGpuDataBinded,this.exterior_ocCullOctree,this.interior_ocCullOctree,this.currentVisibleIndices=[],this.currentVisibleMRG,this.xhr};ae.prototype.multiplyKeyTransformMatrix=function(t,e){for(var i,r=this.neoRefsIndices.length,o=0;o<r;o++)(i=this.motherNeoRefsList[this.neoRefsIndices[o]])&&i.multiplyKeyTransformMatrix(t,e)},ae.prototype.updateCurrentVisibleIndices=function(t,e,i,r){void 0===r&&(r=!0);var o=!1;if(void 0!==this.interior_ocCullOctree){var n=!1;if(this.interior_ocCullOctree._subBoxesArray&&this.interior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&r){var a=this.interior_ocCullOctree.getIntersectedSubBoxByPoint3D(t,e,i);void 0!==a&&a._indicesArray.length>0?(this.currentVisibleIndices=a._indicesArray,o=!1):o=!0}else this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList}if(o&&void 0!==this.exterior_ocCullOctree){n=!1;this.exterior_ocCullOctree._subBoxesArray&&this.exterior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&r?(void 0===this.currentVisibleMRG&&(this.currentVisibleMRG=new te),this.currentVisibleIndices=this.exterior_ocCullOctree.getIndicesVisiblesForEye(t,e,i,this.currentVisibleIndices,this.currentVisibleMRG)):(this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList)}},ae.prototype.getNeoReference=function(t){return this.motherNeoRefsList[this.neoRefsIndices[t]]},ae.prototype.deleteObjects=function(t,e){void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),this.motherNeoRefsList=void 0,this.neoRefsIndices=void 0,void 0!==this.blocksList&&void 0!==this.blocksList.xhr&&this.fileLoadState!==c.fileLoadState.READY&&(this.blocksList.xhr.abort(),this.blocksList.xhr=void 0),this.blocksList=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0,this.exterior_ocCullOctree=void 0,this.interior_ocCullOctree=void 0},ae.prototype.isReadyToRender=function(){return void 0!==this.neoRefsIndices&&0!==this.neoRefsIndices.length&&(void 0!==this.blocksList&&this.blocksList.fileLoadState===c.fileLoadState.PARSE_FINISHED)},ae.prototype.setRenderedFalseToAllReferences=function(){for(var t=this.neoRefsIndices.length,e=0;e<t;e++)this.motherNeoRefsList[this.neoRefsIndices[e]].bRendered=!1},ae.prototype.createModelReferencedGroups=function(){void 0!==this.neoRefsIndices&&(void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new te),this.modelReferencedGroupsList.createModelReferencedGroups(this.neoRefsIndices,this.motherNeoRefsList))},ae.prototype.parseArrayBufferReferencesVersioned=function(t,e,i,r,o){this.fileLoadState=c.fileLoadState.PARSE_STARTED;var n,a,s,l,h,d,u=o.getGl(),f=0,g=o.vboMemoryManager;this.succesfullyGpuDataBinded=!0;String.fromCharCode.apply(null,new Int8Array(t.slice(f,f+5)));f+=5;var p=e.readUInt32(t,f,f+4);f+=4;for(var v=0;v<p;v++){var y=new ne,m=e.readUInt32(t,f,f+4);if(f+=4,y._id=m,this.motherNeoRefsList=i.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[y._id]){y=this.motherNeoRefsList[y._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);var x=e.readUInt8(t,f,f+1);f+=1;var b=String.fromCharCode.apply(null,new Int8Array(t.slice(f,f+x)));f+=x;var C=e.readUInt32(t,f,f+4);f+=4;var A=e.readUInt8(t,f,f+1);f+=1,0===A||(1===A?f+=12:2===A&&(f+=64));var T=e.readUInt8(t,f,f+1);if(f+=1,T){var M=e.readUInt16(t,f,f+2);f+=2;var P=e.readUInt8(t,f,f+1);f+=1,5121===M&&(V=1);var w=e.readUInt8(t,f,f+V);f+=V;var S=e.readUInt8(t,f,f+V);f+=V;var L=e.readUInt8(t,f,f+V);f+=V;var R=255;4===P&&(R=e.readUInt8(t,f,f+V),f+=V)}var D=e.readUInt8(t,f,f+1);f+=1;var E=e.readUInt8(t,f,f+1);if(f+=1,D||E){var I=e.readInt32(t,f,f+4);f+=4;for(var O=0;O<I;O++){if(D){M=e.readUInt16(t,f,f+2);f+=2;P=e.readUInt8(t,f,f+1);f+=1,5120===M||5121===M?V=1:5122===M||5123===M?V=2:5126===M&&(V=4);var F=e.readUInt32(t,f,f+4);n=f+=4,a=f+V*(j=F*P),f+=V*j}if(E){M=e.readUInt16(t,f,f+2);f+=2,5120===M||5121===M?V=1:5122===M||5123===M?V=2:5126===M&&(V=4);F=e.readUInt32(t,f,f+4);n=f+=4,a=f+V*(j=2*F),f+=V*j}}}e.readInt32(t,f,f+4);f+=4,0===y.refMatrixType&&1,1===y.refMatrixType&&1,2===y.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);x=e.readUInt8(t,f,f+1);f+=1,"noObjectId"!==(b=String.fromCharCode.apply(null,new Int8Array(t.slice(f,f+x))))&&0!==b.length||(b=y._id.toString()),y.objectId=b,f+=x,i.putReferenceObject(y,y._id);C=e.readUInt32(t,f,f+4);f+=4,y._block_idx=C,y.refMatrixType=e.readUInt8(t,f,f+1),f+=1,0===y.refMatrixType?1:1===y.refMatrixType?(l=e.readFloat32(t,f,f+4),f+=4,h=e.readFloat32(t,f,f+4),f+=4,d=e.readFloat32(t,f,f+4),f+=4,y.refTranslationVec=new Float32Array([l,h,d]),1):2===y.refMatrixType&&(y._originalMatrix4._floatArrays[0]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[1]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[2]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[3]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[4]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[5]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[6]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[7]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[8]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[9]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[10]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[11]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[12]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[13]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[14]=e.readFloat32(t,f,f+4),f+=4,y._originalMatrix4._floatArrays[15]=e.readFloat32(t,f,f+4),f+=4,1);T=e.readUInt8(t,f,f+1);if(f+=1,T){M=e.readUInt16(t,f,f+2);f+=2;P=e.readUInt8(t,f,f+1);f+=1,5121===M&&(V=1);w=e.readUInt8(t,f,f+V);f+=V;S=e.readUInt8(t,f,f+V);f+=V;L=e.readUInt8(t,f,f+V);f+=V;R=255;4===P&&(R=e.readUInt8(t,f,f+V),f+=V),y.color4=new _,y.color4.set(w,S,L,R)}D=e.readUInt8(t,f,f+1);f+=1;E=e.readUInt8(t,f,f+1);if(f+=1,D||E){I=e.readInt32(t,f,f+4);f+=4,I>0&&void 0===y.vBOVertexIdxCacheKeysContainer&&(y.vBOVertexIdxCacheKeysContainer=new Nt);for(O=0;O<I;O++){var N=y.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(D){M=e.readUInt16(t,f,f+2);f+=2;P=e.readUInt8(t,f,f+1);f+=1,5120===M||5121===M?V=1:5122===M||5123===M?V=2:5126===M&&(V=4);F=e.readUInt32(t,f,f+4);f+=4,s=j=F*P,g.getClassifiedBufferSize(s),y.vertexCount=F,n=f,a=f+V*j;var B=new Float32Array(t.slice(n,a));N.setDataArrayColor(B,g),f+=V*j,N.isReadyColors(u,o.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(E){var V;M=e.readUInt16(t,f,f+2);f+=2,5120===M||5121===M?V=1:5122===M||5123===M?V=2:5126===M&&(V=4);F=e.readUInt32(t,f,f+4);f+=4;var j=2*F;y.vertexCount=F,n=f,a=f+V*j;var U=new Float32Array(t.slice(n,a));N.setDataArrayTexCoord(U,g),f+=V*j}}}y.materialId=e.readInt32(t,f,f+4),f+=4,-1===y.materialId?y.hasTexture=!1:y.hasTexture=!0,r&&y.multiplyTransformMatrix(r)}}e.readUInt32(t,f,f+4);f+=4,void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new dt);var k=this.exterior_ocCullOctree;f=this.exterior_ocCullOctree.parseArrayBuffer(t,f,e),k.expandBox(1e3),k.setSizesSubBoxes(),k.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new dt);var G=this.interior_ocCullOctree;return f=this.interior_ocCullOctree.parseArrayBuffer(t,f,e),G.setSizesSubBoxes(),G.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=c.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},ae.prototype.parseArrayBufferReferences=function(t,e,i,r,o){this.fileLoadState=c.fileLoadState.PARSE_STARTED;var n,a,s=o.getGl(),l=0,h=e.readUInt32(t,l,l+4);l+=4;var d,u,f=o.vboMemoryManager,g=0,p=0;this.succesfullyGpuDataBinded=!0;for(var v=0;v<h;v++){var y=new ne,m=e.readUInt32(t,l,l+4);if(l+=4,y._id=m,this.motherNeoRefsList=i.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[y._id]){y=this.motherNeoRefsList[y._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);var x=e.readUInt8(t,l,l+1);l+=1;var b=String.fromCharCode.apply(null,new Int8Array(t.slice(l,l+x)));l+=x;var C=e.readUInt32(t,l,l+4);l+=4,y._block_idx=C,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4,e.readFloat32(t,l,l+4),l+=4;var A=e.readUInt8(t,l,l+1);if(l+=1,A){var T=e.readUInt16(t,l,l+2);l+=2;var M=e.readUInt8(t,l,l+1);l+=1,5121===T&&(j=1);var P=e.readUInt8(t,l,l+j);l+=j;var w=e.readUInt8(t,l,l+j);l+=j;var S=e.readUInt8(t,l,l+j);l+=j;var L=255;4===M&&(L=e.readUInt8(t,l,l+j),l+=j)}var R=e.readUInt8(t,l,l+1);l+=1;var D=e.readUInt8(t,l,l+1);if(l+=1,R||D){var E=e.readInt32(t,l,l+4);l+=4;for(var I=0;I<E;I++){if(R){T=e.readUInt16(t,l,l+2);l+=2;M=e.readUInt8(t,l,l+1);l+=1,5120===T||5121===T?j=1:5122===T||5123===T?j=2:5126===T&&(j=4);var O=e.readUInt32(t,l,l+4);n=l+=4,a=l+j*(U=O*M),l+=j*U}if(D){T=e.readUInt16(t,l,l+2);l+=2,5120===T||5121===T?j=1:5122===T||5123===T?j=2:5126===T&&(j=4);O=e.readUInt32(t,l,l+4);n=l+=4,a=l+j*(U=2*O),l+=j*U}}}var F=e.readUInt32(t,l,l+4);if(l+=4,F>0){var N=e.readUInt32(t,l,l+4);l+=4;for(I=0;I<N;I++)l+=1;var B=e.readUInt32(t,l,l+4);l+=4;for(I=0;I<B;I++)l+=1}0===y.refMatrixType&&1,1===y.refMatrixType&&1,2===y.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(y._id);x=e.readUInt8(t,l,l+1);l+=1,"noObjectId"!==(b=String.fromCharCode.apply(null,new Int8Array(t.slice(l,l+x))))&&""!==b||(b=y._id),y.objectId=b,l+=x,i.putReferenceObject(y,y._id);C=e.readUInt32(t,l,l+4);l+=4,y._block_idx=C,y._originalMatrix4._floatArrays[0]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[1]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[2]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[3]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[4]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[5]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[6]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[7]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[8]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[9]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[10]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[11]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[12]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[13]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[14]=e.readFloat32(t,l,l+4),l+=4,y._originalMatrix4._floatArrays[15]=e.readFloat32(t,l,l+4),l+=4,y.refMatrixType=y._originalMatrix4.computeMatrixType(),0===y.refMatrixType&&1,1===y.refMatrixType&&(y.refTranslationVec=new Float32Array([y._originalMatrix4._floatArrays[12],y._originalMatrix4._floatArrays[13],y._originalMatrix4._floatArrays[14]]),1),2===y.refMatrixType&&1;A=e.readUInt8(t,l,l+1);if(l+=1,A){T=e.readUInt16(t,l,l+2);l+=2;M=e.readUInt8(t,l,l+1);l+=1,5121===T&&(j=1);P=e.readUInt8(t,l,l+j);l+=j;w=e.readUInt8(t,l,l+j);l+=j;S=e.readUInt8(t,l,l+j);l+=j;L=255;4===M&&(L=e.readUInt8(t,l,l+j),l+=j),y.color4=new _,y.color4.set(P,w,S,L)}R=e.readUInt8(t,l,l+1);l+=1;D=e.readUInt8(t,l,l+1);if(l+=1,R||D){E=e.readInt32(t,l,l+4);l+=4,E>0&&void 0===y.vBOVertexIdxCacheKeysContainer&&(y.vBOVertexIdxCacheKeysContainer=new Nt);for(I=0;I<E;I++){var V=y.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(R){T=e.readUInt16(t,l,l+2);l+=2;M=e.readUInt8(t,l,l+1);l+=1,5120===T||5121===T?j=1:5122===T||5123===T?j=2:5126===T&&(j=4);O=e.readUInt32(t,l,l+4);l+=4,d=j*(U=O*M),p=f.getClassifiedBufferSize(d),y.vertexCount=O,n=l,a=l+j*U,V.colVboDataArray=new Float32Array(p),V.colVboDataArray.set(new Float32Array(t.slice(n,a))),V.colArrayByteSize=p,l+=j*U,V.isReadyColors(s,o.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(D){var j;T=e.readUInt16(t,l,l+2);l+=2,5120===T||5121===T?j=1:5122===T||5123===T?j=2:5126===T&&(j=4);var U;O=e.readUInt32(t,l,l+4);l+=4,u=j*(U=2*O),g=f.getClassifiedBufferSize(u),y.vertexCount=O,n=l,a=l+j*U,V.tcoordVboDataArray=new Float32Array(g),V.tcoordVboDataArray.set(new Float32Array(t.slice(n,a))),V.tcoordArrayByteSize=g,l+=j*U}}}F=e.readUInt32(t,l,l+4);if(l+=4,F>0){var k,G="";N=e.readUInt32(t,l,l+4);l+=4;for(I=0;I<N;I++)G+=String.fromCharCode(new Int8Array(t.slice(l,l+1))),l+=1;B=e.readUInt32(t,l,l+4);l+=4;var z=new Uint8Array(t.slice(l,l+B));l+=B,k=new TextDecoder("utf-8").decode(z),B>0&&(y.texture=new At,y.hasTexture=!0,y.texture.textureTypeName=G,y.texture.textureImageFileName=k)}else y.hasTexture=!1;r&&y.multiplyTransformMatrix(r)}}void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new dt);var H=this.exterior_ocCullOctree;l=this.exterior_ocCullOctree.parseArrayBuffer(t,l,e),H.expandBox(1e3),H.setSizesSubBoxes(),H.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new dt);var W=this.interior_ocCullOctree;return l=this.interior_ocCullOctree.parseArrayBuffer(t,l,e),W.setSizesSubBoxes(),W.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=c.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},ae.prototype.render=function(t,e,i,r,o,n,a){var s=!0;if(!this.isReadyToRender())return!1;2===i&&(r=!1);var l=t.sceneState.gl;2===i&&(o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc)),0===i&&(o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc)),r&&(l.activeTexture(l.TEXTURE2),1===i&&l.uniform1i(o.colorType_loc,2));for(var h=this.currentVisibleIndices.length,d=0,u=0;u<h;u++){var f=this.motherNeoRefsList[this.currentVisibleIndices[u]];if(void 0!==f)if(t.currentProcess===c.magoCurrentProcess.SilhouetteDepthRendering)f.render(t,e,i,r,o,a,n);else{if(f.renderingFase===t.renderingFase)continue;f.render(t,e,i,r,o,a,n)||d++,f.swapRenderingFase()}}return(h-d)/h<.4&&(s=!1),d/h>.2&&(s=!1),s};var se=function(){if(!(this instanceof se))throw new Error(ot.CONSTRUCT_ERROR);this.accesorsArray=[],this.vbo_vicks_container=new Nt,this.texturesArray=[]};se.prototype.newAccesor=function(){var t=new Ut;return this.accesorsArray.push(t),t},se.prototype.newTexture=function(){var t=new le;return this.texturesArray.push(t),t};var le=function(){if(!(this instanceof le))throw new Error(ot.CONSTRUCT_ERROR);this.lod,this.textureId,this.texImage,this.loadStarted=!1,this.loadFinished=!1},he=function(){if(!(this instanceof he))throw new Error(ot.CONSTRUCT_ERROR);this.parent,this.children=[],this.data};he.prototype.isReferenceNode=function(){var t=!1;if(void 0!==this.data){var e=this.data.attributes;void 0!==e&&void 0!==e.isReference&&(t=e.isReference)}return t},he.prototype.isReadyToRender=function(){var t=this.getNodeGeoLocDataManager();if(void 0===t)return!1;var e=t.getCurrentGeoLocationData();if(void 0===e)return!1;var i=e.getGeographicCoords();return void 0!==i&&(void 0!==i.longitude&&void 0!==i.latitude&&void 0!==i.altitude)},he.prototype.deleteObjects=function(t,e){this.parent=void 0;var i=this.data;if(void 0!==i){if(this.isReferenceNode())return;i.neoBuilding&&(i.neoBuilding.deleteObjects(t,e),i.neoBuilding=void 0),i.geographicCoord&&(i.geographicCoord.deleteObjects(),i.geographicCoord=void 0),i.rotationsDegree&&(i.rotationsDegree.deleteObjects(),i.rotationsDegree=void 0),i.bbox&&(i.bbox.deleteObjects(),i.bbox=void 0),this.data=void 0}if(this.children){for(var r=this.children.length,o=0;o<r;o++)this.children[o].deleteObjects(t,e),this.children[o]=void 0;this.children=void 0}},he.prototype.calculateGeoLocData=function(t){var e=this.getRoot();void 0===e.data.geoLocDataManager&&(e.data.geoLocDataManager=new H);var i,r,o=e.data.geoLocDataManager,n=o.getCurrentGeoLocationData();if(void 0===n&&(n=o.newGeoLocationData("deploymentLoc")),void 0===this.data.geographicCoord){var a=this.data.buildingSeed;i=a.geographicCoord,r=a.rotationsDegree}else i=this.data.geographicCoord,r=this.data.rotationsDegree;void 0===r&&(r=new ur(0,0,0));var s=i.longitude,l=i.latitude,h=i.altitude,d=r.z,c=r.x,u=r.y;return Ei.calculateGeoLocationData(s,l,h,d,c,u,n,t),this.correctGeoLocationDataByMappingType(n),n},he.prototype.correctGeoLocationDataByMappingType=function(t){if(void 0!==this.data.mapping_type){var e=this.data.buildingSeed;if(void 0!==e){var i=e.bBox;"boundingboxcenter"===this.data.mapping_type.toLowerCase()?this.pointSC=i.getCenterPoint(this.pointSC):"boundingboxbottomcenter"===this.data.mapping_type.toLowerCase()?this.pointSC=i.getBottomCenterPoint(this.pointSC):(t.pivotPointTraslationLC=void 0,this.pointSC=new ur(0,0,0)),Ei.translatePivotPointGeoLocationData(t,this.pointSC)}}else this.data.mapping_type="origin"},he.prototype.checkChangesHistoryMovements=function(){var t=this.data.moveHistoryMap;if(void 0!==t){var e=this.data.neoBuilding;for(var i in t)if(Object.prototype.hasOwnProperty.call(t,i)){var r=t[i],o=r.getObjectIndexOrder(),n=e.getReferenceObject(o);if(void 0===n)continue;void 0===n.moveVector&&(n.moveVector=new ur),void 0===n.moveVectorRelToBuilding&&(n.moveVectorRelToBuilding=new ur);var a=r.getReferenceObjectAditionalMovement(),s=r.getReferenceObjectAditionalMovementRelToBuilding();n.moveVectorRelToBuilding.set(s.x,s.y,s.z),n.moveVector.set(a.x,a.y,a.z);var l=this.getRoot();if(void 0===l)continue;var h=l.getNodeGeoLocDataManager().getCurrentGeoLocationData();n.moveVector=h.tMatrix.rotatePoint3D(n.moveVectorRelToBuilding,n.moveVector)}}},he.prototype.checkChangesHistoryColors=function(){var t=this.data;if(void 0!==t){var e=t.colorChangedHistoryMap;if(void 0!==e){for(var i in e)if(Object.prototype.hasOwnProperty.call(e,i)){var r=e[i];if(null===r.objectId||void 0===r.objectId||""===r.objectId)if(null===r.property||void 0===r.property||""===r.property)t.isColorChanged=!0,void 0===t.aditionalColor&&(t.aditionalColor=new _),t.aditionalColor.setRGBA(r.color[0],r.color[1],r.color[2],r.color[3]);else{var o=[];this.extractNodes(o);for(var n,a=o.length,s=0;s<a;s++){n=o[s];var l=r.propertyKey,h=r.propertyValue;void 0!==n.data.attributes[l]&&n.data.attributes[l].toString()===h&&(t.isColorChanged=!0,void 0===t.aditionalColor&&(t.aditionalColor=new _),t.aditionalColor.setRGBA(r.color[0],r.color[1],r.color[2],r.color[3]))}}else{var d=this.data.neoBuilding;if(void 0===d)return;var c=r.objectId,u=d.getReferenceObjectsArrayByObjectId(c);if(u)for(var f=u.length,g=0;g<f;g++){var p=u[g];void 0===p.aditionalColor&&(p.aditionalColor=new _),p.aditionalColor.setRGBA(r.color[0],r.color[1],r.color[2],r.color[3])}}}}}},he.prototype.renderContent=function(t,e,i,r){var o=this.data;if(void 0!==o){this.renderCondition&&"function"==typeof this.renderCondition&&this.renderCondition.call(this,o);var n=o.attributes;if(n){if(void 0!==n.isVisible&&!1===n.isVisible)return;if(t.currentProcess===c.magoCurrentProcess.DepthShadowRendering&&void 0!==n.castShadow&&!1===n.castShadow)return}if(2!==i&&t.currentProcess!==c.magoCurrentProcess.StencilSilhouetteRendering)var a=t.effectsManager.executeEffects(o.nodeId,t.getCurrentTime());var s=t.selectionManager;t.nodeSelected===this?s.parentSelected=!0:s.parentSelected=!1;var l=o.neoBuilding;if(void 0!==l){l.currentVisibleOctreesControler=o.currentVisibleOctreesControler,l.myCameraRelative=o.myCameraRelative,l.isColorChanged=o.isColorChanged,l.aditionalColor=o.aditionalColor,this.checkChangesHistoryColors(),this.checkChangesHistoryMovements();l.metaData.projectDataType;var h=this.getRoot().data.geoLocDataManager,d=t.sceneState.gl,u=t.hierarchyManager.getNodesMap(o.projectId);if(void 0!==u.attributes&&void 0!==u.attributes.specularLighting&&void 0!==e.bApplySpecularLighting_loc)u.attributes.specularLighting?d.uniform1i(e.bApplySpecularLighting_loc,!0):d.uniform1i(e.bApplySpecularLighting_loc,!1);t.renderer.currentObjectsRendering.curNode=this;var f=!1;void 0!==o.attributes.flipYTexCoords&&(f=o.attributes.flipYTexCoords),d.uniform1i(e.textureFlipYAxis_loc,f);var g=t.renderingFase;this.isReferenceNode()&&(t.renderingFase=-10);var p,v=this.data.isTrailRender;if(void 0!==v&&!0===v){t.isTrailRender=!0,d.depthRange(.1,1);for(var y=h.getGeoLocationDatasCount(),m=1;m<y;m++){h.getGeoLocationData(m).bindGeoLocationUniforms(d,e);var x=(y-m)/(7*y);d.uniform1f(e.externalAlpha_loc,x),l.currentLod=o.currentLod,l.render(t,e,i,r,f,o.currentLod)}d.depthRange(0,1),t.isTrailRender=!1}p=h.getGeoLocationDatasCount()>1?1:0,h.getGeoLocationData(p).bindGeoLocationUniforms(d,e),d.uniform1f(e.externalAlpha_loc,1),l.currentLod=o.currentLod,l.render(t,e,i,r,f,o.currentLod),t.renderingFase=g,void 0!==this.data.animationData&&!0===this.data.animationData.finished&&(h.getGeoLocationDatasCount()>1?h.popGeoLocationData():this.data.animationData=void 0),a&&(d.uniform3fv(e.scaleLC_loc,[1,1,1]),1===i&&d.uniform4fv(e.colorMultiplier_loc,[1,1,1,1]))}}},he.prototype.addChildren=function(t){t.setParent(this),this.children.push(t)},he.prototype.setParent=function(t){this.parent=t},he.prototype.getRoot=function(){return void 0===this.parent?this:this.parent.getRoot()},he.prototype.setRenderCondition=function(t){if(!t||"function"!=typeof t)throw new Error("renderCondition is required.");this.renderCondition=t},he.prototype.getRenderCondition=function(){return this.renderCondition},he.prototype.getClosestParentWithData=function(t){return this.data&&this.data[t]?this:this.parent?this.parent.getClosestParentWithData(t):void 0},he.prototype.extractNodesByDataName=function(t,e){this.data[e]&&t.push(this);for(var i=this.children.length,r=0;r<i;r++)this.children[r].extractNodesByDataName(t,e)},he.prototype.extractNodes=function(t){t.push(this);for(var e=this.children.length,i=0;i<e;i++)this.children[i].extractNodes(t)},he.prototype.getBBox=function(){var t,e=this.data;if(void 0===e.bbox){var i=e.neoBuilding;if(void 0!==i&&void 0!==i.metaData){var r=i.metaData;e.bbox=new y,e.bbox.copyFrom(r.bbox),t=e.bbox}else if(void 0!==e.buildingSeed){t=e.buildingSeed.bbox}}else t=e.bbox;return t},he.prototype.getBBoxCenterPositionWorldCoord=function(t){return void 0===this.bboxAbsoluteCenterPos?this.calculateBBoxCenterPositionWorldCoord(t):this.bboxAbsoluteCenterPos},he.prototype.calculateBBoxCenterPositionWorldCoord=function(t){var e,i=this.data,r=i.mapping_type;void 0===r&&(r="origin");var o,n=new ur(0,0,0);if("origin"===r.toLowerCase())i.bbox||this.getBBox(),n=i.bbox.getCenterPoint(n);else if("boundingboxcenter"===r.toLowerCase())n.set(0,0,0);else if("boundingboxbottomcenter"===r.toLowerCase()){var a=i.bbox.getZLength();n.set(0,0,a/2)}(e=t.tMatrix.transformPoint3D(n,e),t.pivotPointTraslation)&&(o=t.tMatrix.rotatePoint3D(t.pivotPointTraslation,o),e.add(o.x,o.y,o.z));return e},he.prototype.getBoundingSphereWC=function(t){if(void 0===this.bboxAbsoluteCenterPos)return t;void 0===t&&(t=new m);var e,i=this.getRoot().data.geoLocDataManager.getCurrentGeoLocationData(),r=this.getBBoxCenterPositionWorldCoord(i);return e=this.getBBox().getRadiusAprox(),t.setCenterPoint(r.x,r.y,r.z),t.setRadius(e),t},he.prototype.getDistToCamera=function(t,e){var i=this.data,r=this.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0===this.bboxAbsoluteCenterPos){void 0===i.mapping_type&&(i.mapping_type="origin");var o=new ur(0,0,0);if("origin"===i.mapping_type.toLowerCase())this.data.bbox||this.getBBox(),o=this.data.bbox.getCenterPoint(o);else if("boundingboxcenter"===i.mapping_type.toLowerCase())o.set(0,0,0);else if("boundingboxbottomcenter"===i.mapping_type.toLowerCase()){var n=this.data.bbox.getZLength();o.set(0,0,n/2)}this.bboxAbsoluteCenterPos=r.tMatrix.transformPoint3D(o,this.bboxAbsoluteCenterPos)}var a,s=this.getBBoxCenterPositionWorldCoord(r);a=this.getBBox().getRadiusAprox(),e.setCenterPoint(s.x,s.y,s.z),e.setRadius(a);var l=i.neoBuilding,h=l.metaData.projectDataType;if(h&&(4===h||5===h)){var d,c=l.octree;if(void 0===c)return;d=r.getTransformedRelativePosition(t,d);i.distToCam=c.getMinDistToCameraInTree(d,e,120),e.setCenterPoint(s.x,s.y,s.z),e.setRadius(l.bbox.getRadiusAprox())}return i.distToCam=t.distToSphere(e),i.distToCam},he.prototype.getNodeGeoLocDataManager=function(){var t=this.getClosestParentWithData("geoLocDataManager");if(void 0!==t&&void 0!==t.data)return t.data.geoLocDataManager},he.prototype.finishedAnimation=function(t){var e=!1,i=this.data.animationData;if(void 0===i)return!0;var r,o,n,a,s,l,h=t.getCurrentTime(),d=i.autoChangeRotation;if(void 0===d&&(d=!1),i.animationType===c.animationType.PATH){var u=v.getNextPosition(i,h,t);if(void 0===u)return i.finished=!0,!0;var f=i.path.getGeoLocationDataManager().getCurrentGeoLocationData(),g=u.point,p=u.direction,y=f.tMatrix.transformPoint3D(g,void 0),m=W.CartesianToGeographicWgs84(y.x,y.y,y.z,void 0);if(o=m.latitude,r=m.longitude,n=m.altitude,d){var x=new dr(0,1),b=new dr(p.x,p.y);b.unitary(),a=x.angleDegToVector(b),b.x>0&&(a*=-1)}else a=i.targetHeading,s=i.targetPitch,l=i.targetRoll;return this.changeLocationAndRotation(o,r,n,a,s,l,t),i.lastTime=h,e}if(i.finished)return!0;if(void 0===i.startLongitude||void 0===i.startLatitude||void 0===i.startAltitude)return!0;void 0===i.lastTime&&(i.lastTime=i.birthTime);var C=(h-i.birthTime)/1e3,A=(i.targetLongitude-i.startLongitude)/i.durationInSeconds,T=(i.targetLatitude-i.startLatitude)/i.durationInSeconds,M=(i.targetAltitude-i.startAltitude)/i.durationInSeconds,P=this.getNodeGeoLocDataManager();if(void 0===P)return!0;var w=P.getCurrentGeoLocationData();if(void 0===w)return!0;w.geographicCoord;if(C>i.durationInSeconds)r=i.targetLongitude,o=i.targetLatitude,n=i.targetAltitude,a=i.targetHeading,s=i.targetPitch,l=i.targetRoll,e=!0,this.data.animationData.finished=!0;else{var _=C/i.durationInSeconds;if(_>.3)a=i.targetHeading,s=i.targetPitch,l=i.targetRoll;else{var S=i.targetHeading-i.startHeading;a=i.startHeading+S*_/.3,s=i.startPitch,l=i.startRoll}i.targetLongitude,i.targetLatitude,i.targetAltitude;r=i.startLongitude+A*C,o=i.startLatitude+T*C,n=i.startAltitude+M*C,i.lastTime=h,e=!1}return this.changeLocationAndRotation(o,r,n,a,s,l,t),e},he.prototype.changeLocationAndRotationAnimated=function(t,e,i,r,o,n,a,s){void 0===this.data.animationData&&(this.data.animationData=new p);var l=this.data.animationData;l.finished=!1,l.animationType=s.animationType,l.path=s.path,l.linearVelocityInMetersSecond=s.linearVelocityInMetersSecond,l.autoChangeRotation=s.autoChangeRotation;var h=this.getNodeGeoLocDataManager();if(void 0!==h){var d=h.getCurrentGeoLocationData();if(void 0!==d){var c=h.getGeoLocationData(1);void 0===c&&(c=h.getCurrentGeoLocationData());var u=d.getGeographicCoords();if(void 0!==u&&void 0!==u.longitude&&void 0!==u.latitude&&void 0!==u.altitude){var f=u.longitude-e,g=u.latitude-t,v=(u.altitude,Math.sqrt(f*f+g*g));if(v<65e-6)l.finished=!0;else{for(l.birthTime=a.getCurrentTime(),l.startLongitude=u.longitude,l.startLatitude=u.latitude,l.startAltitude=u.altitude;d.heading>360;)d.heading-=360;for(;d.heading<-360;)d.heading+=360;l.startHeading=d.heading,l.startPitch=d.pitch,l.startRoll=d.roll,l.targetLongitude=e,l.targetLatitude=t,l.targetAltitude=i;u.longitude,u.latitude,u.altitude;l.targetHeading=r,l.targetPitch=o,l.targetRoll=n;var y=3;if("object"==typeof s&&isNaN(s))if(s.duration&&(y=s.duration),s.autoChangeRotation){var m,x=W.geographicToCartesianWgs84(l.targetLongitude,l.targetLatitude,l.targetAltitude,void 0),b=new ur(x[0],x[1],x[2]);(m=c.getTransformedRelativePositionNoApplyHeadingPitchRoll(b,m)).unitary();var C=new dr(0,1),A=new dr(m.x,m.y);A.unitary();var T=C.angleDegToVector(A);m.x>0&&(T*=-1),T>180?T-=360:T<180&&(T+=360);var M=T;for(Math.sqrt(m.x*m.x+m.y*m.y);M>360;)M-=360;for(;M<-360;)M+=360;(P=M-l.startHeading)>180?M-=360:P<-180&&(M+=360),v<65e-6*1.5&&A.y<.1&&(M=l.startHeading),l.targetHeading=M,l.targetPitch=0,l.targetRoll=n}else{for(;r>360;)r-=360;for(;r<-360;)r+=360;var P;(P=r-l.startHeading)>180?r-=360:P<-180&&(r+=360),l.targetHeading=r}else y=s;l.durationInSeconds=y}}}}},he.prototype.nodeMoved=function(t){if(void 0!==t){var e=t.data.smartTileOwner;if(!e.intersectsNode(t)){e.eraseNode(t);var i=e.targetDepth;magoManager.smartTileManager.putNode(i,t,magoManager)}}},he.prototype.changeLocationAndRotation=function(t,e,i,r,o,n,a){var s;if(void 0!==(s=this.getClosestParentWithData("geoLocDataManager"))&&s.data.bbox){var l,h=[];s.extractNodesByDataName(h,"neoBuilding"),s.data.geographicCoord.longitude=e,s.data.geographicCoord.latitude=t,s.data.geographicCoord.altitude=i;for(var d=h.length,c=0;c<d;c++){var u,f=(l=h[c]).getNodeGeoLocDataManager();if(void 0!==f)if(void 0!==(u=void 0!==this.data.animationData?f.newGeoLocationData():f.getCurrentGeoLocationData())&&(u=Ei.calculateGeoLocationData(e,t,i,r,o,n,u,a),this.correctGeoLocationDataByMappingType(u),void 0!==u&&void 0!==u.geographicCoord)){var g=l.data.buildingSeed;g&&(g.geographicCoordOfBBox.longitude=e,g.geographicCoordOfBBox.latitude=t);var p=l.data.neoBuilding;p.octree&&p.octree.multiplyKeyTransformMatrix(0,u.rotMatrix),p.calculateBBoxCenterPositionWorldCoord(u),s.bboxAbsoluteCenterPos=void 0,s.bboxAbsoluteCenterPos=s.calculateBBoxCenterPositionWorldCoord(u),l.bboxAbsoluteCenterPos=void 0,l.bboxAbsoluteCenterPos=l.calculateBBoxCenterPositionWorldCoord(u),void 0===s.data.bbox.geographicCoord&&(s.data.bbox.geographicCoord=new j),s.data.bbox.geographicCoord.setLonLatAlt(e,t,i);var v=l.data.smartTileOwner;if(!v.intersectsNode(l)){v.eraseNode(l);var y=v.depth;a.smartTileManager.putNode(y,l,a)}}}}};var de=function(t){if(!(this instanceof de))throw new Error(ot.CONSTRUCT_ERROR);this.centerPos=new ur,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,t&&(this.octree_owner=t,this.octree_level=t.octree_level+1),this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.neoBuildingOwner,this.octreeKey,this.lod,this.distToCamera,this.triPolyhedronsCount=0,this.fileLoadState=c.fileLoadState.READY,this.subOctrees_array=[],this.neoReferencesMotherAndIndices,this.lowestOctrees_array,this.lego,this.pCloudPartitionsCount,this.pCloudPartitionsArray,this.objectsArray};de.prototype.new_subOctree=function(){var t=new de(this);return t.octree_level=this.octree_level+1,this.subOctrees_array.push(t),t},de.prototype.deleteObjectsModelReferences=function(t,e){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),this.neoReferencesMotherAndIndices=void 0,void 0!==this.subOctrees_array)for(var i=0,r=this.subOctrees_array.length;i<r;i++)this.subOctrees_array[i].deleteObjectsModelReferences(t,e)},de.prototype.deleteObjectsLego=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),void 0!==this.subOctrees_array)for(var i=0,r=this.subOctrees_array.length;i<r;i++)this.subOctrees_array[i].deleteObjectsLego(t,e)},de.prototype.deleteObjects=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),this.legoDataArrayBuffer=void 0,this.centerPos&&this.centerPos.deleteObjects(),this.centerPos=void 0,this.half_dx=void 0,this.half_dy=void 0,this.half_dz=void 0,this.octree_owner=void 0,this.octree_level=void 0,this.octree_number_name=void 0,this.distToCamera=void 0,this.triPolyhedronsCount=void 0,this.fileLoadState=void 0,this.neoBuildingOwner=void 0,this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),this.neoReferencesMotherAndIndices=void 0,this.deletePCloudObjects(t,e),void 0!==this.subOctrees_array){for(var i=0,r=this.subOctrees_array.length;i<r;i++)this.subOctrees_array[i].deleteObjects(t,e),this.subOctrees_array[i]=void 0;this.subOctrees_array=void 0}},de.prototype.deletePCloudObjects=function(t,e){if(void 0!==this.pCloudPartitionsArray){for(var i=this.pCloudPartitionsArray.length,r=0;r<i;r++){this.pCloudPartitionsArray[r].deleteObjects(t,e)}this.pCloudPartitionsArray=void 0}if(void 0!==this.subOctrees_array){var o=this.subOctrees_array.length;for(r=0;r<o;r++){this.subOctrees_array[r].deletePCloudObjects(t,e)}}},de.prototype.deleteLod0GlObjects=function(t,e){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),void 0!==this.subOctrees_array)for(var i=0,r=this.subOctrees_array.length;i<r;i++)this.subOctrees_array[i].deleteLod0GlObjects(t,e)},de.prototype.deleteLod2GlObjects=function(t,e){if(void 0!==this.lego&&(this.lego.deleteObjects(t,e),this.lego=void 0),this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(t,e),void 0!==this.subOctrees_array)for(var i=0,r=this.subOctrees_array.length;i<r;i++)this.subOctrees_array[i].deleteLod2GlObjects(t,e)},de.prototype.createChildren=function(){this.subOctrees_array=[];for(var t=0;t<8;t++){var e=this.new_subOctree();e.octree_number_name=10*this.octree_number_name+(t+1),e.neoBuildingOwnerId=this.neoBuildingOwnerId,e.octreeKey=this.neoBuildingOwnerId+"_"+e.octree_number_name}this.setSizesSubBoxes()},de.prototype.makeTree=function(t){if(this.octree_level<t){this.createChildren();for(var e=0;e<8;e++)this.subOctrees_array[e].makeTree(t)}},de.prototype.prepareData=function(t){this.lod<2?this.prepareModelReferencesListData(t):this.lod>=2&&this.prepareSkinData(t)},de.prototype.prepareSkinData=function(t){if(void 0!==this.octree_number_name){void 0===this.lego&&(this.lego=new Yt,this.lego.birthTime=t.currTime,this.lego.fileLoadState=c.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego");var e=this.neoBuildingOwner;if(void 0!==e){var i=t.sceneState.gl,r=t.readerWriter.geometryDataPath,o=e.projectFolderName,n=e.buildingFileName,a=e.getHeaderVersion();if(this.lego.fileLoadState===c.fileLoadState.READY){var s=r+"/"+o+"/"+n+"/Bricks"+"/"+this.octree_number_name.toString()+"_Brick";if("v"===a[0])if(this.lego.vbo_vicks_container.vboCacheKeysArray[0]&&this.lego.vbo_vicks_container.vboCacheKeysArray[0].meshTexcoordsCacheKey){if(void 0===e.simpleBuilding3x3Texture){e.simpleBuilding3x3Texture=new At;var l=r+"/"+o+"/"+(n=e.buildingFileName)+"/SimpleBuildingTexture3x3.png"}void 0!==e.simpleBuilding3x3Texture&&e.simpleBuilding3x3Texture.fileLoadState===c.fileLoadState.READY&&t.readerWriter.readLegoSimpleBuildingTexture(i,l,e.simpleBuilding3x3Texture,t),t.readerWriter.getOctreeLegoArraybuffer(s,this,t)}else t.readerWriter.getOctreeLegoArraybuffer(s,this,t);else{void 0===e.simpleBuilding3x3Texture&&(e.simpleBuilding3x3Texture=new At);l=r+"/"+o+"/"+n+"/"+e.getImageFileNameForLOD(2);void 0!==e.simpleBuilding3x3Texture&&e.simpleBuilding3x3Texture.fileLoadState===c.fileLoadState.READY&&t.readerWriter.readLegoSimpleBuildingTexture(i,l,e.simpleBuilding3x3Texture,t,!0),t.readerWriter.getOctreeLegoArraybuffer(s,this,t)}}}}},de.prototype.prepareModelReferencesListData=function(t){var e=this.neoBuildingOwner;if(void 0!==e&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){e.getHeaderVersion();var i=t.readerWriter.geometryDataPath,r=e.buildingFileName,o=e.projectFolderName,n=!1,a=e.attributes;if(void 0!==a&&void 0!==a.keepDataArrayBuffers&&!0===a.keepDataArrayBuffers&&(n=!0),void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new ae,this.neoReferencesMotherAndIndices.motherNeoRefsList=e.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===c.fileLoadState.READY){void 0===this.neoReferencesMotherAndIndices.blocksList&&(this.neoReferencesMotherAndIndices.blocksList=new zt("0.0.1")),n&&(this.neoReferencesMotherAndIndices.blocksList.keepDataArrayBuffers=n);var s=i+"/"+o+"/"+r+"/References"+"/"+this.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(s,this,t)}var l=this.neoReferencesMotherAndIndices.blocksList;if(void 0!==l&&l.fileLoadState===c.fileLoadState.READY){var h=i+"/"+o+"/"+r+"/Models"+"/"+this.octree_number_name.toString()+"_Model";t.readerWriter.getNeoBlocksArraybuffer(h,this,t)}}},de.prototype.prepareModelReferencesListData_partitionsVersion=function(t){var e=this.neoBuildingOwner;if(void 0!==e&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){var i=t.readerWriter.geometryDataPath,r=e.buildingFileName,o=e.projectFolderName;if(void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new ae,this.neoReferencesMotherAndIndices.motherNeoRefsList=e.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===c.fileLoadState.READY){if(void 0===this.neoReferencesMotherAndIndices.blocksList){var n=new zt("0.0.2");this.neoReferencesMotherAndIndices.blocksList=n,n.blocksArrayPartitionsCount=this.blocksListsPartitionsCount;var a=i+"/"+o+"/"+r+"/Models"+"/"+this.octree_number_name.toString()+"_Model_";n.blocksArrayPartitionsMasterPathName=a}var s=i+"/"+o+"/"+r+"/References"+"/"+this.octree_number_name.toString()+"_Ref";t.readerWriter.getNeoReferencesArraybuffer(s,this,t)}void 0!==(n=this.neoReferencesMotherAndIndices.blocksList)&&n.prepareData(t,this)}},de.prototype.renderSkin=function(t,e,i,r,o){var n=t.sceneState.gl;if(void 0===this.lego)return this.lego=new Yt,this.lego.fileLoadState=c.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego",!1;if(this.lego.fileLoadState!==c.fileLoadState.PARSE_FINISHED)return!1;if(r=!0,n.uniform1i(o.refMatrixType_loc,0),1===i){if(e.isHighLighted?(n.uniform1i(o.colorType_loc,0),n.uniform4fv(o.oneColor4_loc,this.highLightColor4),r=!1):e.isColorChanged&&(n.uniform1i(o.colorType_loc,0),n.uniform4fv(o.oneColor4_loc,[e.aditionalColor.r,e.aditionalColor.g,e.aditionalColor.b,e.aditionalColor.a]),r=!1),void 0===e.simpleBuilding3x3Texture||!e.simpleBuilding3x3Texture.texId||!r)return!1;n.uniform1i(o.colorType_loc,2),o.last_tex_id!==e.simpleBuilding3x3Texture.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,e.simpleBuilding3x3Texture.texId),o.last_tex_id=e.simpleBuilding3x3Texture.texId)}else if(2===i){var a;a=t.selectionColor.getAvailableColor(a);var s=t.selectionColor.decodeColor3(a.r,a.g,a.b),l=t.renderer.currentObjectsRendering.curNode;t.selectionManager.setCandidates(s,void 0,this,e,l),n.uniform1i(o.colorType_loc,0),n.uniform4fv(o.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1])}return this.lego.render(t,i,r,o)},de.prototype.renderContent=function(t,e,i,r,o,n,a,s){var l=!1,h=t.sceneState.gl;if(this.lod<2){if(void 0===this.neoReferencesMotherAndIndices)return;h.uniform1i(o.textureFlipYAxis_loc,s),(l=this.neoReferencesMotherAndIndices.render(t,e,i,r,o,n,a))||(l=this.renderSkin(t,e,i,r,o))}else 2===this.lod&&(l=this.renderSkin(t,e,i,r,o));return l},de.prototype.getPartitionsCountsForLod=function(t,e,i){var r=1;if(0===t)(r=e)>(o=i.magoPolicy.getPointsCloudSettings()).maxPartitionsLod0&&(r=o.maxPartitionsLod0);else if(1===t){var o=i.magoPolicy.getPointsCloudSettings();(r=Math.ceil(e/4))>o.maxPartitionsLod1&&(r=o.maxPartitionsLod1)}else t>1&&(r=1);return r},de.prototype.preparePCloudData=function(t){if(void 0===this.pCloudPartitionsCount&&0===this.pCloudPartitionsCount)return!1;var e=this.neoBuildingOwner;if(void 0===e)return!1;if(t.processQueue.existOctreeToDeletePCloud(this))return!1;void 0===this.pCloudPartitionsArray&&(this.pCloudPartitionsArray=[]);for(var i=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,t),r=0;r<i;r++){var o=this.pCloudPartitionsArray[r];if(r<this.pCloudPartitionsArray.length){if(void 0!==o&&o.fileLoadState===c.fileLoadState.LOADING_FINISHED&&t.parseQueue.pCloudPartitionsParsed<4){var n=t.sceneState.gl;o.parsePointsCloudData(o.dataArrayBuffer,n,t),o.dataArrayBuffer=void 0,t.parseQueue.pCloudPartitionsParsed++}}else if(void 0===o){var a=t.readerWriter;if((0===this.octree_level?a.pCloudPartitionsMother_requested:a.pCloudPartitions_requested)<3&&t.vboMemoryManager.currentMemoryUsage<t.vboMemoryManager.buffersKeyWorld.bytesLimit/1.5){var s=new Yt;this.pCloudPartitionsArray.push(s),s.legoKey=this.octreeKey+"_"+r.toString();var l=e.projectFolderName,h=e.buildingFileName,d=t.readerWriter.geometryDataPath+"/"+l+"/"+h+"/References"+"/"+this.octree_number_name.toString()+"_Ref_"+r.toString();return a.getOctreePCloudPartitionArraybuffer(d,this,s,t),!0}}}return!1},de.prototype.test__renderPCloud=function(t,e,i,r,o,n){var a=this.pCloudPartitionsCount;if(void 0!==a&&0!==a){var s=t.magoPolicy,l=(t.sceneState.camera,o.bigFrustum),h=o.position,d=this.centerPos.distToPoint(h)-this.getRadiusAprox();if(this.distToCamera=d,0===i){var f=t.visibleObjControlerPCloudOctrees;f.putObjectToArraySortedByDist(f.currentVisibles0,this)}this.lod=s.getLod(d);var g=t.sceneState.gl;if(this.intersectionFrustum(l,t.boundingSphere_Aux)!==u.INTERSECTION_OUTSIDE){t.processQueue.eraseOctreeToDeletePCloud(this);if(void 0===this.pCloudPartitionsArray)return;for(var p=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,t),v=!0,y=0;y<p;y++){if(void 0===(C=this.pCloudPartitionsArray[y])||C.fileLoadState!==c.fileLoadState.PARSE_FINISHED){v=!1;break}var m=C.bPositionsCompressed;g.uniform1i(r.bPositionCompressed_loc,m);var x=C.bbox;g.uniform3fv(r.bboxSize_loc,[x.getXLength(),x.getYLength(),x.getZLength()]),g.uniform3fv(r.minPosition_loc,[x.minX,x.minY,x.minZ]),t.renderer.renderPCloud(g,C,t,r,i,d,this.lod)}if(this.lod>2&&(v=!1),2===this.lod&&this.octree_level>0&&(v=!1),v){y=0;for(var b=this.subOctrees_array.length;y<b;y++){this.subOctrees_array[y].test__renderPCloud(t,e,i,r,o,n)}}t.processQueue.eraseOctreeToDeletePCloud(this)}else if(d>50){if(void 0!==this.pCloudPartitionsArray)for(p=this.pCloudPartitionsArray.length,y=0;y<p;y++){var C=this.pCloudPartitionsArray[y];t.parseQueue.eraseOctreePCloudPartitionToParse(C)}t.processQueue.putOctreeToDeletePCloud(this)}}},de.prototype.getNumberOfDigits=function(t){return t>0?Math.floor(Math.log10(t)+1):1},de.prototype.getMotherOctree=function(){return void 0===this.octree_owner?this:this.octree_owner.getMotherOctree()},de.prototype.getOctree=function(t,e){if(1===e)return 0===t?this.getMotherOctree():this.subOctrees_array[t-1];var i=e-1,r=Math.pow(10,i),o=Math.floor(t/r)%10,n=t-o*r;return this.subOctrees_array[o-1].getOctree(n,e-1)},de.prototype.getOctreeByNumberName=function(t){var e=this.getMotherOctree(),i=this.getNumberOfDigits(t);if(1===i)return 0===t?e:e.subOctrees_array[t-1];if(0!==e.subOctrees_array.length){var r=i-1,o=Math.pow(10,r),n=Math.floor(t/o)%10,a=t-n*o;return e.subOctrees_array[n-1].getOctree(a,i-1)}},de.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>7){var t=this.centerPos.x,e=this.centerPos.y,i=this.centerPos.z,r=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(r,t,o,e,n,i),this.subOctrees_array[1].setBoxSize(t,a,o,e,n,i),this.subOctrees_array[2].setBoxSize(t,a,e,s,n,i),this.subOctrees_array[3].setBoxSize(r,t,e,s,n,i),this.subOctrees_array[4].setBoxSize(r,t,o,e,i,l),this.subOctrees_array[5].setBoxSize(t,a,o,e,i,l),this.subOctrees_array[6].setBoxSize(t,a,e,s,i,l),this.subOctrees_array[7].setBoxSize(r,t,e,s,i,l);for(var h=this.subOctrees_array.length,d=0;d<h;d++)this.subOctrees_array[d].setSizesSubBoxes()}},de.prototype.setBoxSize=function(t,e,i,r,o,n){this.centerPos.x=(e+t)/2,this.centerPos.y=(r+i)/2,this.centerPos.z=(n+o)/2,this.half_dx=(e-t)/2,this.half_dy=(r-i)/2,this.half_dz=(n-o)/2},de.prototype.getCenterPos=function(){return this.centerPos},de.prototype.getRadiusAprox=function(){return 1.7*this.half_dx},de.prototype.getFrustumVisibleLowestOctreesByLOD=function(t,e,i,r,o,n,a,s){for(var l=[],h=!1,d=(l=this.getFrustumVisibleOctreesNeoBuildingAsimetricVersion(t,l,r)).length,c=0;c<d;c++)l[c].setDistToCamera(o);for(c=0;c<d;c++)l[c].distToCamera<n?l[c].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles0,l[c]),e.currentVisibles0.push(l[c]),l[c].lod=0,h=!0):l[c].distToCamera<a?l[c].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles1,l[c]),e.currentVisibles1.push(l[c]),l[c].lod=1,h=!0):l[c].distToCamera<s?l[c].triPolyhedronsCount>0&&(i&&this.putOctreeInEyeDistanceSortedArray(i.currentVisibles2,l[c]),e.currentVisibles2.push(l[c]),l[c].lod=2,h=!0):l[c].triPolyhedronsCount>0&&(i&&i.currentVisibles3.push(l[c]),e.currentVisibles3.push(l[c]),l[c].lod=3,h=!0);return l=void 0,h},de.prototype.getBoundingBox=function(t){return void 0===t&&(t=new y),t.set(this.centerPos.x-this.half_dx,this.centerPos.y-this.half_dy,this.centerPos.z-this.half_dz,this.centerPos.x+this.half_dx,this.centerPos.y+this.half_dy,this.centerPos.z+this.half_dz),t},de.prototype.intersectsWithTriangle=function(t){if(void 0===t)return!1;this.getBoundingBox();return!0},de.prototype.intersectsWithPoint3D=function(t,e,i){var r=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dz,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dz,l=this.centerPos.z+this.half_dz,h=!1;return t>r&&t<a&&e>o&&e<s&&i>n&&i<l&&(h=!0),h},de.prototype.getIntersectedSubBoxByPoint3D=function(t,e,i){if(void 0===this.octree_owner&&!this.intersectsWithPoint3D(t,e,i))return!1;var r=void 0;if(this.subOctrees_array.length>0){var o,n=this.centerPos.x,a=this.centerPos.y,s=this.centerPos.z;o=t<n?e<a?i<s?0:4:i<s?3:7:e<a?i<s?1:5:i<s?2:6,r=this.subOctrees_array[o].getIntersectedSubBoxByPoint3D(t,e,i)}else r=this;return r},de.prototype.getMinDistToCamera=function(t){var e,i=1e6;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var r=this.lowestOctrees_array.length,o=0;o<r;o++)(e=this.lowestOctrees_array[o].centerPos.distToPoint(t)-this.getRadiusAprox())<i&&(i=e);return i},de.prototype.extractLowestOctreesByLOD=function(t,e,i,r,o,n,a){var s=!1;r.x,r.y,r.z;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var l=this.lowestOctrees_array.length,h=0;h<l;h++)this.lowestOctrees_array[h].setDistToCamera(r);for(h=0;h<l;h++)this.lowestOctrees_array[h].distToCamera<o?this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles0,this.lowestOctrees_array[h]),t.currentVisibles0.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=0,s=!0):this.lowestOctrees_array[h].distToCamera<n?this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles1,this.lowestOctrees_array[h]),t.currentVisibles1.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=1,s=!0):this.lowestOctrees_array[h].distToCamera<a?this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&this.putOctreeInEyeDistanceSortedArray(e.currentVisibles2,this.lowestOctrees_array[h]),t.currentVisibles2.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=2,s=!0):this.lowestOctrees_array[h].triPolyhedronsCount>0&&(e&&e.currentVisibles3.push(this.lowestOctrees_array[h]),t.currentVisibles3.push(this.lowestOctrees_array[h]),this.lowestOctrees_array[h].lod=3,s=!0);return s},de.prototype.intersectionFrustum=function(t,e){return void 0===e&&(e=new mt),e.centerPoint.x=this.centerPos.x,e.centerPoint.y=this.centerPos.y,e.centerPoint.z=this.centerPos.z,e.r=this.getRadiusAprox(),t.intersectionSphere(e)},de.prototype.getFrustumVisibleOctreesNeoBuildingAsimetricVersion=function(t,e,i){if(void 0!==this.subOctrees_array&&(0!==this.subOctrees_array.length||0!==this.triPolyhedronsCount)){void 0===e&&(e=[]);var r=this.intersectionFrustum(t,i);if(r===u.INTERSECTION_INSIDE)this.getAllSubOctreesIfHasRefLists(e);else if(r===u.INTERSECTION_INTERSECT)if(0===this.subOctrees_array.length)e.push(this);else for(var o=0,n=this.subOctrees_array.length;o<n;o++)this.subOctrees_array[o].getFrustumVisibleOctreesNeoBuildingAsimetricVersion(t,e,i);return e}},de.prototype.getBBoxIntersectedOctreesNeoBuildingAsimetricVersion=function(t,e,i){void 0!==this.subOctrees_array&&(0===this.subOctrees_array.length&&0===this.triPolyhedronsCount||(void 0===e&&(e=[]),void 0===i&&(i=new y),i.minX=this.centerPos.x-this.half_dx,i.maxX=this.centerPos.x+this.half_dx,i.minY=this.centerPos.y-this.half_dy,i.maxY=this.centerPos.y+this.half_dy,i.minZ=this.centerPos.z-this.half_dz,i.maxZ=this.centerPos.z+this.half_dz,t.intersectsWithBBox(i)&&this.getAllSubOctreesIfHasRefLists(e)))},de.prototype.setDistToCamera=function(t){var e=this.centerPos.distToPoint(t)-this.getRadiusAprox();return this.distToCamera=e,e},de.prototype.putOctreeInEyeDistanceSortedArray=function(t,e){if(t.length>0){var i=t.length-1,r=Ei.getIndexToInsertBySquaredDistToEye(t,e,0,i);t.splice(r,0,e)}else t.push(e)},de.prototype.getAllSubOctreesIfHasRefLists=function(t){if(void 0!==this.subOctrees_array)if(void 0===t&&(t=[]),this.subOctrees_array.length>0)for(var e=0,i=this.subOctrees_array.length;e<i;e++)this.subOctrees_array[e].getAllSubOctreesIfHasRefLists(t);else this.triPolyhedronsCount>0&&t.push(this)},de.prototype.getAllSubOctrees=function(t){if(void 0===t&&(t=[]),this.subOctrees_array.length>0)for(var e=0,i=this.subOctrees_array.length;e<i;e++)this.subOctrees_array[e].getAllSubOctrees(t);else t.push(this)},de.prototype.extractLowestOctreesIfHasTriPolyhedrons=function(t){if(void 0!==this.subOctrees_array){var e=this.subOctrees_array.length;if(0===e&&this.triPolyhedronsCount>0)t.push(this);else for(var i=0;i<e;i++)this.subOctrees_array[i].extractLowestOctreesIfHasTriPolyhedrons(t)}},de.prototype.multiplyKeyTransformMatrix=function(t,e){var i=this.subOctrees_array.length;if(0===i&&this.triPolyhedronsCount>0)this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(t,e);else for(var r=0;r<i;r++)this.subOctrees_array[r].multiplyKeyTransformMatrix(t,e)},de.prototype.parseAsimetricVersion=function(t,e,i){i.getHeaderVersion();var r=ge.readInt32(t,e,e+4);if(e+=4,0===r){var o=ge.readFloat32(t,e,e+4);e+=4;var n=ge.readFloat32(t,e,e+4);e+=4;var a=ge.readFloat32(t,e,e+4);e+=4;var s=ge.readFloat32(t,e,e+4);e+=4;var l=ge.readFloat32(t,e,e+4);e+=4;var h=ge.readFloat32(t,e,e+4);e+=4,this.setBoxSize(o,n,a,s,l,h),this.octree_number_name=0}var d=ge.readUInt8(t,e,e+1);e+=1,this.triPolyhedronsCount=ge.readInt32(t,e,e+4),e+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=i),d>0&&this.createChildren();for(var c=0;c<d;c++){e=this.subOctrees_array[c].parseAsimetricVersion(t,e,i)}return e},de.prototype.parsePyramidVersion=function(t,e,i){var r=ge.readInt32(t,e,e+4);if(e+=4,0===r){var o=ge.readFloat32(t,e,e+4);e+=4;var n=ge.readFloat32(t,e,e+4);e+=4;var a=ge.readFloat32(t,e,e+4);e+=4;var s=ge.readFloat32(t,e,e+4);e+=4;var l=ge.readFloat32(t,e,e+4);e+=4;var h=ge.readFloat32(t,e,e+4);e+=4,this.setBoxSize(o,n,a,s,l,h),this.octree_number_name=0}var d=ge.readUInt8(t,e,e+1);e+=1,this.triPolyhedronsCount=ge.readInt32(t,e,e+4),e+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=i),this.pCloudPartitionsCount=ge.readInt32(t,e,e+4),e+=4;for(var c=0;c<d;c++){(u=this.new_subOctree()).octree_number_name=10*this.octree_number_name+(c+1),u.neoBuildingOwnerId=this.neoBuildingOwnerId,u.octreeKey=this.neoBuildingOwnerId+"_"+u.octree_number_name}this.setSizesSubBoxes();for(c=0;c<d;c++){var u;e=(u=this.subOctrees_array[c]).parsePyramidVersion(t,e,i)}return e},de.prototype.getDistToCamera=function(t,e){return e.setCenterPoint(this.centerPos.x,this.centerPos.y,this.centerPos.z),e.setRadius(this.getRadiusAprox()),t.distToSphere(e)},de.prototype.getMinDistToCameraInTree=function(t,e,i){var r,o=this.getRadiusAprox(),n=this.subOctrees_array.length;if(o>i&&n>0){for(var a,s,l,h=0;h<n;h++){var d=!1,c=this.subOctrees_array[h];c.pCloudPartitionsCount&&c.pCloudPartitionsCount>0&&(d=!0),c.triPolyhedronsCount&&c.triPolyhedronsCount>0&&(d=!0),d&&(a=c.centerPos.squareDistToPoint(t),void 0===s?(s=a,l=c):a<s&&(s=a,l=c))}if(l)return l.getMinDistToCameraInTree(t,e,i)}else r=this.centerPos.distToPoint(t);return r};var ce=function(){if(!(this instanceof ce))throw new Error(ot.CONSTRUCT_ERROR);this.objectsToParseMap={},this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={},this.octreesPCloudToParseMap={},this.octreesPCloudPartitionToParseMap={},this.skinLegosToParseMap={},this.tinTerrainsToParseMap={},this.multiBuildingsToParseMap={},this.maxNumParses=10,this.smartTileF4dParsesCount=0,this.pCloudPartitionsParsed=0,this.lowlodMeshesParsed=0};ce.prototype.putMultiBuildingsToParse=function(t,e){void 0===e&&(e=0),this.multiBuildingsToParseMap[t.id]=t},ce.prototype.eraseMultiBuildingsToParse=function(t){if(void 0!==t){var e=t.id;return!!this.multiBuildingsToParseMap.hasOwnProperty(e)&&(delete this.multiBuildingsToParseMap[e],!0)}},ce.prototype.putTinTerrainToParse=function(t,e){void 0===e&&(e=0),this.tinTerrainsToParseMap[t.getPathName()]=t},ce.prototype.eraseTinTerrainToParse=function(t){if(void 0!==t){var e=t.getPathName();return!!this.tinTerrainsToParseMap.hasOwnProperty(e)&&(delete this.tinTerrainsToParseMap[e],!0)}},ce.prototype.parseMultiBuildings=function(t,e,i){if(Object.keys(this.multiBuildingsToParseMap).length>0){this.maxNumParses;for(var r=e.length,o=0;o<r;o++){var n=e[o].data.multiBuildings;this.eraseMultiBuildingsToParse(n)&&n.parseData(i)}}},ce.prototype.parseArraySkins=function(t,e,i){if(Object.keys(this.skinLegosToParseMap).length>0){var r,o,n=0;this.maxNumParses;50;for(var a=e.length,s=0;s<a;s++)if(void 0!==(o=e[s].data.neoBuilding)&&void 0!==o.lodMeshesMap){var l=o.currentLod;if(!(l<0)){var h=void 0;if(0===l?h="lod0":1===l?h="lod1":2===l?h="lod2":3===l?h="lod3":4===l?h="lod4":5===l&&(h="lod5"),void 0!==h&&void 0!==(r=o.getLowerSkinLodToLoad(l))&&(this.eraseSkinLegosToParse(r)&&(r.parseArrayBuffer(r.dataArrayBuffer,i),r.dataArrayBuffer=void 0,n++),n>50))break}}for(var d in this.skinLegosToParseMap)if(Object.prototype.hasOwnProperty.call(this.skinLegosToParseMap,d)){if(void 0===(r=this.skinLegosToParseMap[d]))continue;if(this.eraseSkinLegosToParse(r)&&(r.parseArrayBuffer(r.dataArrayBuffer,i),r.dataArrayBuffer=void 0,n++),n>50)break}}},ce.prototype.parseArrayOctreesPCloud=function(t,e,i){if(Object.keys(this.octreesPCloudToParseMap).length>0){for(var r,o=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++){if(r=e[s],this.eraseOctreePCloudToParse(r)){if(void 0===r.lego)continue;r.lego.parsePointsCloudData(t,r.lego.dataArrayBuffer,i),r.lego.dataArrayBuffer=void 0,n++}if(n>o)break}if(0===n)for(var l in this.octreesPCloudToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudToParseMap,l)){if(r=this.octreesPCloudToParseMap[l],this.eraseOctreePCloudToParse(r)){if(void 0===r.lego)continue;r.lego.parsePointsCloudData(r.lego.dataArrayBuffer,t,i),r.lego.dataArrayBuffer=void 0,n++}if(n>o)break}n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},ce.prototype.parseArrayOctreesPCloudPartition=function(t,e,i){if(Object.keys(this.octreesPCloudPartitionToParseMap).length>0){for(var r,o=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++)if(void 0!==(r=e[s]).pCloudPartitionsArray){for(var l=r.pCloudPartitionsArray.length,h=0;h<l;h++){var d=r.pCloudPartitionsArray[h];this.eraseOctreePCloudPartitionToParse(d)&&(d.parsePointsCloudData(t,d.dataArrayBuffer,i),d.dataArrayBuffer=void 0,n++)}if(n>o)break}if(0===n)for(var c in this.octreesPCloudPartitionToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudPartitionToParseMap,c)&&(r=this.octreesPCloudPartitionToParseMap[c],this.eraseOctreePCloudPartitionToParse(r)&&(d.parsePointsCloudData(t,d.dataArrayBuffer,i),d.dataArrayBuffer=void 0,n++),n>o))break;n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},ce.prototype.parseArrayOctreesLod2Legos=function(t,e,i){if(Object.keys(this.octreesLod2LegosToParseMap).length>0){for(var r,o=this.maxNumParses,n=0,a=e.length,s=0;s<a;s++){if(r=e[s],this.eraseOctreeLod2LegosToParse(r)){if(void 0===r.lego)continue;r.lego.parseArrayBuffer(r.lego.dataArrayBuffer,i),r.lego.dataArrayBuffer=void 0,n++}if(n>o)break}n>0&&i.selectionFbo&&(i.selectionFbo.dirty=!0)}},ce.parseArrayOctreesLod0Models=function(t,e){if(void 0!==t.neoReferencesMotherAndIndices){var i=t.neoReferencesMotherAndIndices.blocksList;if(void 0!==i){var r=t.neoBuildingOwner,o=r.getHeaderVersion();void 0!==i.dataArraybuffer&&i.fileLoadState===c.fileLoadState.LOADING_FINISHED&&("v"===o[0]?i.parseBlocksList(i.dataArraybuffer,e.readerWriter,r.motherBlocksArray,e):"0.0.1"!==o&&"0.0.2"!==o||i.parseBlocksListVersioned_v001(i.dataArraybuffer,e.readerWriter,r.motherBlocksArray,e),i.dataArraybuffer=void 0)}}},ce.prototype.parseArrayOctreesLod0Models=function(t,e){if(Object.keys(this.octreesLod0ModelsToParseMap).length>0){for(var i,r=this.maxNumParses,o=0,n=t.length,a=0;a<n&&(i=t[a],this.eraseOctreeLod0ModelsToParse(i)&&(ce.parseArrayOctreesLod0Models(i,e),o++),!(o>r));a++);o>0&&e.selectionFbo&&(e.selectionFbo.dirty=!0)}},ce.prototype.parseArrayOctreesLod0References=function(t,e){if(Object.keys(this.octreesLod0ReferencesToParseMap).length>0){for(var i,r=this.maxNumParses,o=0,n=t.length,a=0;a<n&&(i=t[a],this.parseOctreesLod0References(i,e)&&o++,!(o>r));a++);o>0&&e.selectionFbo&&(e.selectionFbo.dirty=!0)}},ce.prototype.parseOctreesLod0References=function(t,e){var i=!1;return this.eraseOctreeLod0ReferencesToParse(t)&&(ce.parseOctreesLod0References(t,e),i=!0),i},ce.parseOctreesLod0References=function(t,e){if(void 0===t.neoReferencesMotherAndIndices)return!1;if(void 0===t.neoReferencesMotherAndIndices.dataArraybuffer)return!1;if(t.neoReferencesMotherAndIndices.fileLoadState!==c.fileLoadState.LOADING_FINISHED)return!1;var i,r=t.neoBuildingOwner,o=r.nodeOwner;if(void 0===(i=o?o.getRoot():void 0))return!1;if(void 0===i.data)return!1;var n=i.data.geoLocDataManager;if(void 0===n)return!1;void 0===e.matrix4SC&&(e.matrix4SC=new rt);var a=n.getCurrentGeoLocationData(),s=r.getHeaderVersion();return e.matrix4SC.setByFloat32Array(a.rotMatrix._floatArrays),"v"===s[0]?t.neoReferencesMotherAndIndices.parseArrayBufferReferences(t.neoReferencesMotherAndIndices.dataArraybuffer,e.readerWriter,r,e.matrix4SC,e):t.neoReferencesMotherAndIndices.parseArrayBufferReferencesVersioned(t.neoReferencesMotherAndIndices.dataArraybuffer,e.readerWriter,r,e.matrix4SC,e),t.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(0,a.rotMatrix),t.neoReferencesMotherAndIndices.dataArraybuffer=void 0,!0},ce.prototype.putOctreeLod0ReferencesToParse=function(t,e){void 0===e&&(e=0),this.octreesLod0ReferencesToParseMap[t.octreeKey]=t},ce.prototype.eraseOctreeLod0ReferencesToParse=function(t){var e=t.octreeKey;return!!this.octreesLod0ReferencesToParseMap.hasOwnProperty(e)&&(delete this.octreesLod0ReferencesToParseMap[e],!0)},ce.prototype.putOctreeLod0ModelsToParse=function(t,e){void 0===e&&(e=0),this.octreesLod0ModelsToParseMap[t.octreeKey]=t},ce.prototype.eraseOctreeLod0ModelsToParse=function(t){var e=t.octreeKey;return!!this.octreesLod0ModelsToParseMap.hasOwnProperty(e)&&(delete this.octreesLod0ModelsToParseMap[e],!0)},ce.prototype.putOctreeLod2LegosToParse=function(t,e){void 0===e&&(e=0),this.octreesLod2LegosToParseMap[t.octreeKey]=t},ce.prototype.eraseOctreeLod2LegosToParse=function(t){var e=t.octreeKey;return!!this.octreesLod2LegosToParseMap.hasOwnProperty(e)&&(delete this.octreesLod2LegosToParseMap[e],!0)},ce.prototype.putOctreePCloudToParse=function(t,e){void 0===e&&(e=0),this.octreesPCloudToParseMap[t.octreeKey]=t},ce.prototype.eraseOctreePCloudToParse=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreesPCloudToParseMap.hasOwnProperty(e)&&(delete this.octreesPCloudToParseMap[e],!0)},ce.prototype.putOctreePCloudPartitionToParse=function(t,e){void 0===e&&(e=0),this.octreesPCloudPartitionToParseMap[t.legoKey]=t},ce.prototype.eraseOctreePCloudPartitionToParse=function(t){if(void 0===t)return!1;var e=t.legoKey;return!!this.octreesPCloudPartitionToParseMap.hasOwnProperty(e)&&(delete this.octreesPCloudPartitionToParseMap[e],!0)},ce.prototype.putSkinLegosToParse=function(t,e){void 0===e&&(e=0),this.skinLegosToParseMap[t.legoKey]=t,t.fileLoadState=c.fileLoadState.IN_PARSE_QUEUE},ce.prototype.eraseSkinLegosToParse=function(t){var e=t.legoKey;return!!this.skinLegosToParseMap.hasOwnProperty(e)&&(delete this.skinLegosToParseMap[e],!0)},ce.prototype.clearAll=function(){this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={}},ce.prototype.eraseAny=function(t){this.eraseOctreeLod0ReferencesToParse(t),this.eraseOctreeLod0ModelsToParse(t),this.eraseOctreeLod2LegosToParse(t)},ce.prototype.initCounters=function(){this.smartTileF4dParsesCount=0,this.pCloudPartitionsParsed=0};var ue=function(){if(!(this instanceof ue))throw new Error(ot.CONSTRUCT_ERROR);this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={},this.nodesToDeleteLessThanLod3Map={},this.nodesToDeleteLessThanLod4Map={},this.nodesToDeleteLessThanLod5Map={},this.nodesToDeleteLodMeshMap={},this.tinTerrainsToDeleteMap={},this.smartTilesToDeleteMap={},this.octreeToDeletePCloudsMap={}};ue.prototype.putSmartTileToDelete=function(t,e){if(void 0===e&&(e=0),void 0!==t){var i=t.getId();this.smartTilesToDeleteMap[i]=t}},ue.prototype.eraseSmartTileToDelete=function(t){if(void 0===t)return!1;var e=t.getId();return!!this.smartTilesToDeleteMap.hasOwnProperty(e)&&(delete this.smartTilesToDeleteMap[e],!0)},ue.prototype.putOctreeToDeletePCloud=function(t,e){if(void 0===e&&(e=0),void 0!==t){var i=t.octreeKey;this.octreeToDeletePCloudsMap[i]=t}},ue.prototype.existOctreeToDeletePCloud=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(e)},ue.prototype.eraseOctreeToDeletePCloud=function(t){if(void 0===t)return!1;var e=t.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(e)&&(delete this.octreeToDeletePCloudsMap[e],!0)},ue.prototype.putNodeToDeleteLodMesh=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLodMeshMap[i]=t}},ue.prototype.eraseNodeToDeleteLodMesh=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLodMeshMap.hasOwnProperty(e)&&(delete this.nodesToDeleteLodMeshMap[e],!0)}},ue.prototype.putTinTerrainToDelete=function(t,e){if(void 0===e&&(e=0),void 0!==t){var i=t.pathName;this.tinTerrainsToDeleteMap[i]=t}},ue.prototype.eraseTinTerrainToDelete=function(t){if(void 0===t)return!1;var e=t.pathName;return!!this.tinTerrainsToDeleteMap.hasOwnProperty(e)&&(delete this.tinTerrainsToDeleteMap[e],!0)},ue.prototype.putNodeToDeleteLessThanLod3=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod3Map[i]=t}},ue.prototype.eraseNodeToDeleteLessThanLod3=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod3Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod3Map[e],!0)}},ue.prototype.putNodeToDeleteLessThanLod4=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod4Map[i]=t}},ue.prototype.eraseNodeToDeleteLessThanLod4=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod4Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod4Map[e],!0)}},ue.prototype.putNodeToDeleteLessThanLod5=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod5Map[i]=t}},ue.prototype.eraseNodeToDeleteLessThanLod5=function(t){if(void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod5Map.hasOwnProperty(e)&&(delete this.nodesToDeleteLessThanLod5Map[e],!0)}},ue.prototype.putNodeToDeleteModelReferences=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteModelReferencesMap[i]=t}},ue.prototype.eraseNodeToDeleteModelReferences=function(t){if(t&&void 0!==t.data&&void 0!==t.data.neoBuilding){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteModelReferencesMap.hasOwnProperty(e)&&(delete this.nodesToDeleteModelReferencesMap[e],!0)}},ue.prototype.putNodeToDelete=function(t,e){if(!t.isReferenceNode()&&(void 0===e&&(e=0),void 0!==t.data&&void 0!==t.data.neoBuilding)){var i=t.data.neoBuilding.buildingId;this.nodesToDeleteMap[i]=t}},ue.prototype.putNodesArrayToDelete=function(t,e){if(void 0!==t){void 0===e&&(e=0);for(var i=t.length,r=0;r<i;r++)this.putNodeToDelete(t[r],e)}},ue.prototype.eraseNodeToDelete=function(t){var e=t.data.neoBuilding.buildingId;return!!this.nodesToDeleteMap.hasOwnProperty(e)&&(delete this.nodesToDeleteMap[e],!0)},ue.prototype.eraseNodesArrayToDelete=function(t){for(var e,i=t.length,r=0;r<i;r++)e=t[r].data.neoBuilding.buildingId,delete this.nodesToDeleteMap[e]},ue.prototype.clearAll=function(){this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={}},ue.prototype.deleteNeoBuilding=function(t,e,i){var r=i.vboMemoryManager;e===i.buildingSelected&&(i.buildingSelected=void 0,i.octreeSelected=void 0,i.objectSelected=void 0),e.deleteObjects(t,r)},ue.prototype.deleteSmartTiles=function(t){var e,i,r=0,o=t.sceneState.gl;for(var n in this.smartTilesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.smartTilesToDeleteMap,n)){var a=this.smartTilesToDeleteMap[n];if(void 0===a)continue;if(this.eraseSmartTileToDelete(a)){if(void 0!==a.nodesArray)for(var s=a.nodesArray.length,l=0;l<s;l++)void 0!==(i=(e=a.nodesArray[l]).data.neoBuilding)&&(this.deleteNeoBuilding(o,i,t),e.data.neoBuilding=void 0);else a.nodesArray=[];if(a.nodesArray.length=0,void 0!==a.smartTileF4dSeedArray){var h=a.smartTileF4dSeedArray.length;for(l=0;l<h;l++)a.smartTileF4dSeedArray[l].fileLoadState=c.fileLoadState.READY}if(++r>=1)break}}},ue.prototype.manageDeleteQueue=function(t){var e,i,r=t.sceneState.gl,o=8,n=Object.keys(this.nodesToDeleteMap).length;n<o&&(o=n);var a=0;for(var s in this.deleteSmartTiles(t),this.nodesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteMap,s)){if(void 0===(i=this.nodesToDeleteMap[s]))continue;if(e=i.data.neoBuilding,this.eraseNodeToDelete(i)){if(void 0===e)continue;if(this.deleteNeoBuilding(r,e,t),++a>=10)break}}var l=0;for(var s in this.nodesToDeleteModelReferencesMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteModelReferencesMap,s)){if(void 0===(i=this.nodesToDeleteModelReferencesMap[s]).data)continue;if(e=i.data.neoBuilding,this.eraseNodeToDeleteModelReferences(i),void 0===e)continue;if(e.octree&&(e.octree.deleteObjectsModelReferences(r,t.vboMemoryManager),e.octree.deletePCloudObjects(r,t.vboMemoryManager)),(e.motherBlocksArray.length>0||e.motherNeoReferencesArray.length>0)&&l++,e.deleteObjectsModelReferences(r,t.vboMemoryManager),l>10)break}a=0;for(var s in this.nodesToDeleteLessThanLod3Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod3Map,s)){if(void 0===(i=this.nodesToDeleteLessThanLod3Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod3(i)){if(void 0===(e=i.data.neoBuilding))continue;if(e.octree&&(e.octree.deleteObjectsModelReferences(r,t.vboMemoryManager),e.octree.deletePCloudObjects(r,t.vboMemoryManager)),(e.motherBlocksArray.length>0||e.motherNeoReferencesArray.length>0)&&l++,e.deleteObjectsModelReferences(r,t.vboMemoryManager),e.deleteObjectsLod2(r,t.vboMemoryManager),++a>10)break}}for(var s in a=0,this.nodesToDeleteLessThanLod4Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod4Map,s)){if(void 0===(i=this.nodesToDeleteLessThanLod4Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod4(i)){if(void 0===(e=i.data.neoBuilding))continue;if(e.deleteObjectsModelReferences(r,t.vboMemoryManager),e.deleteObjectsLod2(r,t.vboMemoryManager),e.deleteObjectsLodMesh(r,t.vboMemoryManager,"lod3"),++a>10)break}}for(var s in a=0,this.nodesToDeleteLessThanLod5Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod5Map,s)){if(void 0===(i=this.nodesToDeleteLessThanLod5Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod5(i)){if(void 0===(e=i.data.neoBuilding))continue;if(e.deleteObjectsModelReferences(r,t.vboMemoryManager),e.deleteObjectsLod2(r,t.vboMemoryManager),e.deleteObjectsLodMesh(r,t.vboMemoryManager,"lod3"),e.deleteObjectsLodMesh(r,t.vboMemoryManager,"lod4"),++a>10)break}}a=0;for(var s in this.tinTerrainsToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.tinTerrainsToDeleteMap,s)){var h=this.tinTerrainsToDeleteMap[s];if(void 0===h)continue;if(this.eraseTinTerrainToDelete(h)&&(delete h.owner.childMap[h.indexName],h.deleteObjects(t),h=void 0,a++),a>20)break}a=0;for(var s in this.octreeToDeletePCloudsMap)if(Object.prototype.hasOwnProperty.call(this.octreeToDeletePCloudsMap,s)){var d=this.octreeToDeletePCloudsMap[s];if(void 0===d)continue;if(this.eraseOctreeToDeletePCloud(d)&&(d.deletePCloudObjects(r,t.vboMemoryManager),d=void 0,a++),a>1e4)break}};var fe=function(){if(!(this instanceof fe))throw new Error(ot.CONSTRUCT_ERROR);this.root,this.nodesArray=[]},ge=function(){if(!(this instanceof ge))throw new Error(ot.CONSTRUCT_ERROR);var t=f.getPolicy();void 0!==t&&(this.geometryDataPath=t.geo_data_path),this.geometryDataPath||(this.geometryDataPath="/f4d"),this.geometrySubDataPath,this.j_counter,this.k_counter,this.referencesList_requested=0,this.blocksList_requested=0,this.blocksListPartitioned_requested=0,this.octreesSkinLegos_requested=0,this.skinLegos_requested=0,this.pCloudPartitionsMother_requested=0,this.pCloudPartitions_requested=0,this.smartTileF4d_requested=0,this.gl,this.incre_latAng=.001,this.incre_longAng=.001,this.GAIA3D__offset_latitude=-.001,this.GAIA3D__offset_longitude=-.001,this.GAIA3D__counter=0,this.uint32,this.uint16,this.int16,this.float32,this.float16,this.int8,this.int8_value,this.max_color_value=126,this.startBuff,this.endBuff,this.filesReadings_count=0,this.temp_var_to_waste,this.countSC,this.xSC,this.ySC,this.zSC,this.point3dSC=new ur,this.bboxSC=new y};ge.prototype.getCurrentDataPath=function(){return void 0!==this.geometrySubDataPath&&""!==this.geometrySubDataPath?this.geometryDataPath+"/"+this.geometrySubDataPath:this.geometryDataPath},ge.prototype.readUInt32=function(t,e,i){return new Uint32Array(t.slice(e,i))[0]},ge.readUInt32=function(t,e,i){return new Uint32Array(t.slice(e,i))[0]},ge.prototype.readInt32=function(t,e,i){return new Int32Array(t.slice(e,i))[0]},ge.readInt32=function(t,e,i){return new Int32Array(t.slice(e,i))[0]},ge.prototype.readUInt16=function(t,e,i){return new Uint16Array(t.slice(e,i))[0]},ge.readUInt16=function(t,e,i){return new Uint16Array(t.slice(e,i))[0]},ge.prototype.readInt16=function(t,e,i){return new Int16Array(t.slice(e,i))[0]},ge.readInt16=function(t,e,i){return new Int16Array(t.slice(e,i))[0]},ge.prototype.readFloat64=function(t,e,i){return new Float64Array(t.slice(e,i))[0]},ge.readFloat64=function(t,e,i){return new Float64Array(t.slice(e,i))[0]},ge.prototype.readFloat32=function(t,e,i){return new Float32Array(t.slice(e,i))[0]},ge.readFloat32=function(t,e,i){return new Float32Array(t.slice(e,i))[0]},ge.prototype.readFloat16=function(t,e,i){return new Float32Array(t.slice(e,i))[0]},ge.prototype.readInt8=function(t,e,i){return new Int8Array(t.slice(e,i))[0]},ge.readInt8=function(t,e,i){return new Int8Array(t.slice(e,i))[0]},ge.prototype.readUInt8=function(t,e,i){return new Uint8Array(t.slice(e,i))[0]},ge.readUInt8=function(t,e,i){return new Uint8Array(t.slice(e,i))[0]},ge.prototype.readInt8ByteColor=function(t,e,i){var r=new Int8Array(t.slice(e,i))[0];return r>max_color_value&&(r=max_color_value),r<0&&(r+=256),r},ge.prototype.getNeoBlocksArraybuffer=function(t,e,i,r){i.fileRequestControler.modelRefFilesRequestedCount+=1;var o=e.neoReferencesMotherAndIndices.blocksList;o.fileLoadState=c.fileLoadState.LOADING_STARTED,o.xhr=void 0;var n=!1;void 0!==r&&void 0!==r.parseImmediately&&(n=r.parseImmediately),this.blocksList_requested++,Di(t,void 0).then(function(t){var r=t;r?(o.dataArraybuffer=r,o.fileLoadState=c.fileLoadState.LOADING_FINISHED,r=null,n?ce.parseArrayOctreesLod0Models(e,i):i.parseQueue.putOctreeLod0ModelsToParse(e)):o.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),o.fileLoadState=0===t?500:-1===t?c.fileLoadState.READY:t}).finally(function(){i.readerWriter.blocksList_requested--,i.fileRequestControler.modelRefFilesRequestedCount-=1,i.fileRequestControler.modelRefFilesRequestedCount<0&&(i.fileRequestControler.modelRefFilesRequestedCount=0)})},ge.prototype.getNeoBlocksArraybuffer_partition=function(t,e,i,r){r.fileRequestControler.modelRefFilesRequestedCount+=1,i.fileLoadState=c.fileLoadState.LOADING_STARTED,this.blocksListPartitioned_requested++,Di(t,void 0).then(function(t){var o=t;o?(i.dataArraybuffer=o,i.fileLoadState=c.fileLoadState.LOADING_FINISHED,o=null,r.parseQueue.putOctreeLod0ModelsToParse(e)):i.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),i.fileLoadState=0===t?500:-1===t?c.fileLoadState.READY:t}).finally(function(){r.readerWriter.blocksListPartitioned_requested--,r.fileRequestControler.blocksListPartitioned_requested<0&&(r.fileRequestControler.blocksListPartitioned_requested=0)})},ge.prototype.getNeoReferencesArraybuffer=function(t,e,i,r){if(void 0!==e.neoReferencesMotherAndIndices){i.fileRequestControler.modelRefFilesRequestedCount+=1,e.neoReferencesMotherAndIndices.fileLoadState=c.fileLoadState.LOADING_STARTED,e.neoReferencesMotherAndIndices.xhr=void 0;var o=!1;void 0!==r&&void 0!==r.parseImmediately&&(o=r.parseImmediately),this.referencesList_requested++,Di(t,void 0).then(function(t){var r=t;if(r){var n=e.neoReferencesMotherAndIndices;n&&(n.dataArraybuffer=r,n.fileLoadState=c.fileLoadState.LOADING_FINISHED,o?ce.parseOctreesLod0References(e,i):i.parseQueue.putOctreeLod0ReferencesToParse(e)),r=null}else e.neoReferencesMotherAndIndices.fileLoadState=c.fileLoadState.LOAD_FAILED},function(t){console.log("xhr status = "+t),e.neoReferencesMotherAndIndices.fileLoadState=0===t?c.fileLoadState.LOAD_FAILED:-1===t?c.fileLoadState.READY:t}).finally(function(){i.readerWriter.referencesList_requested--,i.fileRequestControler.modelRefFilesRequestedCount-=1,i.fileRequestControler.modelRefFilesRequestedCount<0&&(i.fileRequestControler.modelRefFilesRequestedCount=0)})}},ge.prototype.getOctreeLegoArraybuffer=function(t,e,i){if(void 0!==e.lego){this.octreesSkinLegos_requested++,i.fileRequestControler.filesRequestedCount+=1,e.lego.fileLoadState=c.fileLoadState.LOADING_STARTED;var r=new XMLHttpRequest;e.lego.xhr=r,Di(t,r).then(function(t){var r=t;r?(e.lego?(e.lego.dataArrayBuffer=r,e.lego.fileLoadState=c.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreeLod2LegosToParse(e)):e=void 0,r=null):e.lego.fileLoadState=500},function(t){console.log("xhr status = "+t),e.lego.fileLoadState=0===t?500:t}).finally(function(){i.readerWriter.octreesSkinLegos_requested--,i.fileRequestControler.filesRequestedCount-=1,i.fileRequestControler.filesRequestedCount<0&&(i.fileRequestControler.filesRequestedCount=0)})}},ge.prototype.getOctreePCloudArraybuffer=function(t,e,i){void 0!==e.lego&&(i.fileRequestControler.filesRequestedCount+=1,e.lego.fileLoadState=c.fileLoadState.LOADING_STARTED,Di(t).then(function(t){var r=t;r?(e.lego?(e.lego.dataArrayBuffer=r,e.lego.fileLoadState=c.fileLoadState.LOADING_FINISHED,i.parseQueue.putOctreePCloudToParse(e)):e=void 0,r=null):e.lego.fileLoadState=500},function(t){console.log("xhr status = "+t),e.lego.fileLoadState=0===t?500:t}).finally(function(){i.fileRequestControler.filesRequestedCount-=1,i.fileRequestControler.filesRequestedCount<0&&(i.fileRequestControler.filesRequestedCount=0)}))},ge.prototype.getOctreePCloudPartitionArraybuffer=function(t,e,i,r){i.fileLoadState=c.fileLoadState.LOADING_STARTED;var o=e.octree_level;0===o?r.readerWriter.pCloudPartitionsMother_requested++:r.readerWriter.pCloudPartitions_requested++,Di(t).then(function(t){var r=t;r?(e&&i&&(i.dataArrayBuffer=r,i.fileLoadState=c.fileLoadState.LOADING_FINISHED),r=null):i.fileLoadState=500},function(t){console.log("xhr status = "+t),i.fileLoadState=0===t?500:t}).finally(function(){0===o?(r.readerWriter.pCloudPartitionsMother_requested--,r.readerWriter.pCloudPartitionsMother_requested<0&&(r.readerWriter.pCloudPartitionsMother_requested=0)):(r.readerWriter.pCloudPartitions_requested--,r.readerWriter.pCloudPartitions_requested<0&&(r.readerWriter.pCloudPartitions_requested=0))})},ge.prototype.getLegoArraybuffer=function(t,e,i){this.skinLegos_requested++,i.fileRequestControler.lowLodDataRequestedCount+=1,e.fileLoadState=c.fileLoadState.LOADING_STARTED,e.xhr=void 0,Di(t,void 0).then(function(t){var r=t;r?(e&&(e.dataArrayBuffer=r,e.fileLoadState=c.fileLoadState.LOADING_FINISHED,i.parseQueue.putSkinLegosToParse(e)),r=null):e.fileLoadState=500},function(t){console.log("xhr status = "+t),e.fileLoadState=0===t?500:-1}).finally(function(){i.readerWriter.skinLegos_requested--,i.fileRequestControler.lowLodDataRequestedCount-=1,i.fileRequestControler.lowLodDataRequestedCount<0&&(i.fileRequestControler.lowLodDataRequestedCount=0)})},ge.prototype.getObjectIndexFileSmartTileF4d=function(t,e,i){Di(t).then(function(t){var r=t;r&&(void 0===i.smartTileManager&&(i.smartTileManager=new yt),i.smartTileManager.parseSmartTilesF4dIndexFile(r,e,i),r=void 0)},function(t){console.log("xhr status = "+t)}).finally(function(){})},ge.prototype.getSmartTileF4d=function(t,e,i,r){this.smartTileF4d_requested++,e.fileLoadState=c.fileLoadState.LOADING_STARTED,Di(t).then(function(t){var i=t;i?(e.fileLoadState=c.fileLoadState.LOADING_FINISHED,e.dataArrayBuffer=i,i=void 0):e.fileLoadState=c.fileLoadState.LOAD_FAILED,r.readerWriter.smartTileF4d_requested--,r.readerWriter.smartTileF4d_requested<0&&(r.readerWriter.smartTileF4d_requested=0)},function(t){console.log("xhr status = "+t)}).finally(function(){})},ge.prototype.getMultiBuildingsDataArrayBuffer=function(t,e,i){this.skinLegos_requested++,i.fileRequestControler.multiBuildingsDataRequestedCount+=1,e.fileLoadState=c.fileLoadState.LOADING_STARTED,Di(t,void 0).then(function(t){var r=t;r?(e&&(e.dataArrayBuffer=r,e.fileLoadState=c.fileLoadState.LOADING_FINISHED,i.parseQueue.putMultiBuildingsToParse(e,0)),r=null):e.fileLoadState=500},function(t){console.log("xhr status = "+t),e.fileLoadState=0===t?500:-1}).finally(function(){i.fileRequestControler.multiBuildingsDataRequestedCount-=1,i.fileRequestControler.multiBuildingsDataRequestedCount<0&&(i.fileRequestControler.multiBuildingsDataRequestedCount=0)})},ge.prototype.getObjectIndexFileForSmartTile=function(t,e,i,r){Di(t).then(function(t){var i=t;if(i){var o=new C;o.dataArrayBuffer=i,o.parseBuildingSeedArrayBuffer(),e.makeSmartTile(o,r),i=null}},function(t){console.log("xhr status = "+t)}).finally(function(){})},ge.prototype.getObjectIndexFileForData=function(t,e,i,r,o){Di(t).then(function(t){var n=t;if(n){var a=new b;a.dataArrayBuffer=n,a.parseBuildingSeedArrayBuffer();for(var s={},l=a.buildingSeedArray.length,h=0;h<l;h++){var d=a.buildingSeedArray[h],c=d.buildingId;r.indexOf(c)>=0&&(s[c]=d)}if(Object.keys(s).length!==r.length)throw new Error("ObjectIndexFile is not ready. Please make objectIndexFile and try add data.");e.makeSmartTile(s,i,o,s),n=null}},function(t){console.log("xhr status = "+t)}).finally(function(){})},ge.prototype.getObjectIndexFile=function(t,e,i,r){Di(t).then(function(t){var o=t;o&&(e.parseObjectIndexFile(o,i),o=null,r.createDeploymentGeoLocationsForHeavyIndustries())},function(t){console.log("xhr status = "+t)}).finally(function(){})},ge.prototype.parseObjectIndexFile=function(t,e){var i,r,o,n,a=0,s=this.readInt32(t,a,a+4);a+=4;for(var l=0;l<s;l++){var h=e.newNeoBuilding();void 0===h.metaData&&(h.metaData=new Jt),void 0===h.metaData.geographicCoord&&(h.metaData.geographicCoord=new j),void 0===h.metaData.bbox&&(h.metaData.bbox=new y),i=this.readInt32(t,a,a+4),a+=4;var d=String.fromCharCode.apply(null,new Int8Array(t.slice(a,a+i)));a+=i,r=this.readFloat64(t,a,a+8),a+=8,o=this.readFloat64(t,a,a+8),a+=8,n=this.readFloat32(t,a,a+4),a+=4,h.bbox=new y,h.bbox.minX=this.readFloat32(t,a,a+4),a+=4,h.bbox.minY=this.readFloat32(t,a,a+4),a+=4,h.bbox.minZ=this.readFloat32(t,a,a+4),a+=4,h.bbox.maxX=this.readFloat32(t,a,a+4),a+=4,h.bbox.maxY=this.readFloat32(t,a,a+4),a+=4,h.bbox.maxZ=this.readFloat32(t,a,a+4),a+=4,h.buildingId=d.substr(4,i-4),h.buildingType="basicBuilding",h.buildingFileName=d,h.metaData.geographicCoord.setLonLatAlt(r,o,n)}e.neoBuildingsArray.reverse()},ge.prototype.getNeoHeaderAsimetricVersion=function(t,e,i,r,o){o.fileRequestControler.headerFilesRequestedCount+=1,i.metaData.fileLoadState=c.fileLoadState.LOADING_STARTED,Di(e).then(function(t){var e=t;if(e){i.metaData.fileLoadState=c.fileLoadState.LOADING_FINISHED,i.headerDataArrayBuffer=e,e=void 0}else i.metaData.fileLoadState=500,e=void 0},function(t){console.log("xhr status = "+t),i.metaData.fileLoadState=0===t?500:t}).finally(function(){o.fileRequestControler.headerFilesRequestedCount-=1,o.fileRequestControler.headerFilesRequestedCount<0&&(o.fileRequestControler.headerFilesRequestedCount=0)})},ge.prototype.readTexture=function(t,e,i,r){i.loadStarted=!0,i.texImage=new Image,i.texImage.onload=function(){i.loadFinished=!0,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1)},i.texImage.onerror=function(){i.loadStarted=!1,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1)},i.texImage.src=e},ge.prototype.decodeTGA=function(t){var e,i,r,o,n,a=new Uint8Array(t),s=18+a[0],l=a[2],h=a[12]+(a[13]<<8),d=a[14]+(a[15]<<8),c=a[16],u=c/8,f=4*h;if(!h||!d)return console.error("Invalid dimensions"),null;if(2!==l)return console.error("Unsupported TGA format:",l),null;for(e=new Uint8Array(h*d*4),i=s,n=d-1;n>=0;--n)for(o=0;o<h;++o,i+=u)e[r=4*o+n*f]=a[i+2],e[r+1]=a[i+1],e[r+2]=a[i+0],e[r+3]=32===c?a[i+3]:255;return{width:h,height:d,data:e}},ge.prototype.readNeoReferenceTexture=function(t,e,i,r,o){var n=e.split(".").pop();if("tga"===n||"TGA"===n||"Tga"===n)i.fileLoadState=c.fileLoadState.LOADING_STARTED,Di(e).then(function(e){var r=e;if(r){var o=new TGA;if(o.load(r),o){var n;if(3===o.header.bytePerPixel)n=t.RGB;else if(4===o.header.bytePerPixel){n=t.RGBA;for(var a,s,l,h,d=o.imageData.length/4,u=0;u<d;u++)a=o.imageData[4*u],s=o.imageData[4*u+1],l=o.imageData[4*u+2],h=o.imageData[4*u+3],o.imageData[4*u]=l,o.imageData[4*u+1]=s,o.imageData[4*u+2]=a,o.imageData[4*u+3]=h}void 0!==o.imageData&&o.imageData.length>0&&void 0!==i.texId&&(t.bindTexture(t.TEXTURE_2D,i.texId),t.texImage2D(t.TEXTURE_2D,0,n,o.header.width,o.header.height,0,n,t.UNSIGNED_BYTE,o.imageData),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.generateMipmap(t.TEXTURE_2D),i.fileLoadState=c.fileLoadState.LOADING_FINISHED,t.bindTexture(t.TEXTURE_2D,null))}}},function(t){r&&(console.log("xhr status = "+t),r.metaData.fileLoadState=0===t?500:t)}).finally(function(){o.backGround_fileReadings_count-=1,o.backGround_fileReadings_count<0&&(o.backGround_fileReadings_count=0)});else{var a=new Image;i.fileLoadState=c.fileLoadState.LOADING_STARTED,a.onload=function(){void 0!==i.texId&&(_t(t,a,i.texId),i.fileLoadState=c.fileLoadState.LOADING_FINISHED,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1))},a.onerror=function(){},a.src=e}},ge.loadBinaryData=function(t,e,i){e.fileLoadState=c.fileLoadState.LOADING_STARTED,Di(t).then(function(t){var r=t;r?(e.dataArraybuffer=r,e.fileLoadState=c.fileLoadState.LOADING_FINISHED,r=null,i.parseData(e)):e.fileLoadState=500},function(t){console.log("Invalid XMLHttpRequest status = "+t),e.fileLoadState=0===t?500:t}).finally(function(){})},ge.loadImage=function(t,e,i){var r=new Image;i.fileLoadState=c.fileLoadState.LOADING_STARTED,r.onload=function(){var e,o,n,a,s,l;void 0!==i.texId&&(i.imageWidth=r.width,i.imageHeight=r.height,i.texId=(e=t,o=t.LINEAR,n=r,l=e.createTexture(),e.bindTexture(e.TEXTURE_2D,l),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,o),n instanceof Uint8Array?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a,s,0,e.RGBA,e.UNSIGNED_BYTE,n):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_2D,null),l),i.fileLoadState=c.fileLoadState.BINDING_FINISHED)},r.onerror=function(){},r.src=e},ge.prototype.readLegoSimpleBuildingTexture=function(t,e,i,r,o){var n=new Image;i.fileLoadState=c.fileLoadState.LOADING_STARTED,r.fileRequestControler.lowLodImagesRequestedCount+=1,n.onload=function(){void 0===i.texId&&(i.texId=t.createTexture()),void 0===o&&(o=!0),_t(t,n,i.texId,o),i.fileLoadState=c.fileLoadState.LOADING_FINISHED,r.fileRequestControler.lowLodImagesRequestedCount-=1,r.backGround_fileReadings_count>0&&(r.backGround_fileReadings_count-=1),r.fileRequestControler.lowLodImagesRequestedCount<0&&(r.fileRequestControler.lowLodImagesRequestedCount=0)},n.onerror=function(){void 0===i.texId&&(i.texId=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i.texId),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([200,200,200,255])),t.bindTexture(t.TEXTURE_2D,null)),i.fileLoadState=c.fileLoadState.READY,r.fileRequestControler.lowLodImagesRequestedCount-=1,r.fileRequestControler.lowLodImagesRequestedCount<0&&(r.fileRequestControler.lowLodImagesRequestedCount=0)},n.src=e},ge.prototype.getTileArrayBuffer=function(t,e,i,r,o){i.fileReading_started=!0,Di(e).then(function(t){var e=t;e&&(i.fileArrayBuffer=e,i.fileReading_finished=!0,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1),e=null)},function(t){console.log("xhr status = "+t)}).finally(function(){})},ge.prototype.loadTINTerrain=function(t,e,i){e.fileLoadState=c.fileLoadState.LOADING_STARTED,i.fileRequestControler.tinTerrainFilesRequested+=1,Di(t).then(function(t){var i=t;i?(e.dataArrayBuffer=i,e.fileLoadState=c.fileLoadState.LOADING_FINISHED,i=void 0):e.fileLoadState=500},function(t){e.fileLoadState=c.fileLoadState.LOAD_FAILED}).finally(function(){i.fileRequestControler.tinTerrainFilesRequested-=1,i.fileRequestControler.tinTerrainFilesRequested<0&&(i.fileRequestControler.tinTerrainFilesRequested=0)})},ge.prototype.imageFromArrayBuffer=function(t,e,i,r,o){var n=new Blob([e],{type:"image/png"}),a=(window.URL||window.webkitURL).createObjectURL(n),s=new Image;s.onload=function(){void 0===o&&(o=!1),void 0===i.texId&&(i.texId=t.createTexture()),_t(t,s,i.texId,o),i.fileLoadState=c.fileLoadState.LOADING_FINISHED,e=null},s.onerror=function(){},s.src=a},ge.prototype.loadWMSImage=function(t,e,i,r,o){i.fileLoadState=c.fileLoadState.LOADING_STARTED;r.fileRequestControler.tinTerrainTexturesRequested+=1,Di(e,void 0,void 0,"blob").then(function(e){var r=e;!r||"image/png"!==r.type&&"image/jpeg"!==r.type?(i.texId="failed",i.fileLoadState=c.fileLoadState.LOADING_FINISHED):createImageBitmap(r).then(function(e){e.blob=r,void 0===i.texId&&(i.texId=t.createTexture()),void 0===o&&(o=!0),i.imageWidth=e.width,i.imageHeight=e.height,t.bindTexture(t.TEXTURE_2D,i.texId),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),i.fileLoadState=c.fileLoadState.LOADING_FINISHED})},function(t){console.log(t),i.texId="failed",i.fileLoadState=c.fileLoadState.LOADING_FINISHED}).finally(function(){r.backGround_fileReadings_count-=1,r.backGround_fileReadings_count<0&&(r.backGround_fileReadings_count=0),r.fileRequestControler.tinTerrainTexturesRequested-=1,r.fileRequestControler.tinTerrainTexturesRequested<0&&(r.fileRequestControler.tinTerrainTexturesRequested=0)})};var pe=function(){if(!(this instanceof pe))throw new Error(ot.CONSTRUCT_ERROR);this.multiBuildingsOwner,this.indexRange},ve=function(t){if(!(this instanceof ve))throw new Error(ot.CONSTRUCT_ERROR);this.owner,this.depth,t?(this.owner=t,this.depth=t.depth+1):this.depth=0,this.childArray,this.childMap,this.X,this.Y,this.centerX,this.centerY,this.centerZ,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.skirtCartesiansArray,this.skirtTexCoordsArray,this.geographicExtent,this.sphereExtent,this.webMercatorExtent,this.fileLoadState=0,this.dataArrayBuffer,this.vboKeyContainer,this.terrainPositionHIGH,this.terrainPositionLOW,this.indexName,this.pathName,this.texture={},this.textureMaster,this.textureElevation={},this.visible,this.tinTerrainManager,this.isAdult=!1,this.birthTime,this.renderingFase=0};ve.prototype.deleteObjects=function(t){var e=t.sceneState.gl;if(void 0!==this.childMap){var i=this.childMap.LU;void 0!==i&&(i.deleteObjects(t),delete this.childMap.LU);var r=this.childMap.LD;void 0!==r&&(r.deleteObjects(t),delete this.childMap.LD);var o=this.childMap.RU;void 0!==o&&(o.deleteObjects(t),delete this.childMap.RU);var n=this.childMap.RD;void 0!==n&&(n.deleteObjects(t),delete this.childMap.RD),this.childMap=void 0}if(!(this.depth<3)){if(this.owner=void 0,this.depth=void 0,this.childArray=void 0,this.childMap=void 0,this.X=void 0,this.Y=void 0,void 0!==this.geographicExtent&&(this.geographicExtent.deleteObjects(),this.geographicExtent=void 0),void 0!==this.sphereExtent&&(this.sphereExtent.deleteObjects(),this.sphereExtent=void 0),this.fileLoadState=0,this.dataArrayBuffer=void 0,void 0!==this.vboKeyContainer&&(this.vboKeyContainer.deleteGlObjects(e,t.vboMemoryManager),this.vboKeyContainer=void 0),this.terrainPositionHIGH=void 0,this.terrainPositionLOW=void 0,this.indexName=void 0,this.pathName=void 0,void 0!==this.texture){for(var a=Object.keys(this.texture),s=0,l=a.length;s<l;s++){var h=this.texture[a[s]];h.deleteObjects(e),delete this.texture[a[s]],h=void 0}this.texture={}}this.visible=void 0,delete this.altArray,delete this.boundingSphereCenterX,delete this.boundingSphereCenterY,delete this.boundingSphereCenterZ,delete this.boundingSphereRadius,delete this.cartesiansArray,delete this.cartesiansArraySea,delete this.centerX,delete this.centerY,delete this.centerZ,delete this.eastIndices,delete this.eastVertexCount,delete this.westIndices,delete this.westVertexCount,delete this.extensionId,delete this.extensionLength,delete this.hValues,delete this.uValues,delete this.vValues,delete this.horizonOcclusionPointX,delete this.horizonOcclusionPointY,delete this.horizonOcclusionPointZ,delete this.indices,delete this.latArray,delete this.lonArray,delete this.maxHeight,delete this.minHeight,delete this.normalsArray,delete this.normalsArraySea,delete this.northIndices,delete this.northVertexCount,delete this.skirtAltitudesArray,delete this.skirtCartesiansArray,delete this.skirtCartesiansArraySea,delete this.skirtTexCoordsArray,delete this.skirtTexCoordsArraySea,delete this.southIndices,delete this.southVertexCount,delete this.texCoordsArray,delete this.texture,delete this.textureElevation,this.textureMaster&&e.deleteTexture(this.textureMaster),delete this.textureMaster,delete this.vertexCount}},ve.prototype.getPathName=function(){return this.depth.toString()+"/"+this.X.toString()+"/"+this.Y.toString()},ve.prototype.getPathInfo=function(){return{z:this.depth.toString(),x:this.X.toString(),y:this.Y.toString()}},ve.prototype.checkAvailableTerrain=function(){for(var t=this.getPathInfo(),e=this.tinTerrainManager.terrainTilesInfo.available,i=!0,r=t.z,o=t.x,n=t.y,a=0,s=e.length;a<s;a++){var l=e[a];if(!l.hasOwnProperty(r)){i=!1;break}for(var h=l[r],d=0,c=h.length;d<c;d++){var u=h[d],f=u.startX,g=u.startY,p=u.endX,v=u.endY;if(o<f||o>p||n<g||n>v){i=!1;break}}}return i},ve.prototype.getBlendAlpha=function(t){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=t),void 0===this.blendAlpha&&(this.blendAlpha=.1);var e=1e-4*(t-this.birthTime);return this.blendAlpha+=e,this.blendAlpha>=1&&(this.blendAlpha=1,this.isAdult=!0),this.blendAlpha},ve.prototype.setWebMercatorExtent=function(t,e,i,r){void 0===this.webMercatorExtent&&(this.webMercatorExtent=new Ar),this.webMercatorExtent.setExtension(t,e,i,r)},ve.prototype.setGeographicExtent=function(t,e,i,r,o,n){void 0===this.geographicExtent&&(this.geographicExtent=new G);var a=this.geographicExtent;void 0===a.minGeographicCoord&&(a.minGeographicCoord=new j),void 0===a.maxGeographicCoord&&(a.maxGeographicCoord=new j),a.minGeographicCoord.setLonLatAlt(t,e,i),a.maxGeographicCoord.setLonLatAlt(r,o,n)},ve.prototype.isChildrenPrepared=function(){if(void 0===this.childMap)return!1;if(this.childMap.length<4)return!1;var t=this.childMap.LU.isVisible(),e=this.childMap.LD.isVisible(),i=this.childMap.RU.isVisible(),r=this.childMap.RD.isVisible();return!(!this.childMap.LU.isPrepared()&&t||!this.childMap.LD.isPrepared()&&e||!this.childMap.RU.isPrepared()&&i||!this.childMap.RD.isPrepared()&&r)},ve.prototype.hasAnyChildVisible=function(){return void 0!==this.childMap&&(!(this.childMap.length<4)&&(!!this.childMap.LU.isVisible()||(!!this.childMap.LD.isVisible()||(!!this.childMap.RU.isVisible()||!!this.childMap.RD.isVisible()))))},ve.prototype.isVisible=function(){return this.intersectionType===u.INTERSECTION_INTERSECT||this.intersectionType===u.INTERSECTION_INSIDE},ve.prototype.isTexturePrepared=function(t){for(var e=!0,i=Object.keys(t),r=i.length,o=this.depth.toString(),n=this.tinTerrainManager.getImageryLayers(),a=n.length,s=0;s<a;s++){var l=n[s];if(!this.texture[l._id]&&l.show&&l.maxZoom>parseInt(o)&&l.minZoom<parseInt(o)){e=!1;break}}if(!e)return e;for(s=0;s<r;s++){var h=t[i[s]];if(h.fileLoadState!==c.fileLoadState.LOADING_FINISHED||!h.texId){e=!1;break}}return e},ve.prototype.isPrepared=function(){return this.fileLoadState===c.fileLoadState.PARSE_FINISHED&&(!!this.isTexturePrepared(this.texture)&&(void 0!==this.vboKeyContainer&&void 0!==this.vboKeyContainer.vboCacheKeysArray&&0!==this.vboKeyContainer.vboCacheKeysArray.length&&!(this.depth>2&&!this.textureMasterPrepared)))},ve.prototype.getTexCoordsOfGeoExtent=function(t){var e=t.geographicExtent.minGeographicCoord,i=t.geographicExtent.maxGeographicCoord,r=(e.longitude,e.latitude,i.longitude,i.latitude,this.geographicExtent.minGeographicCoord),o=this.geographicExtent.maxGeographicCoord,n=r.longitude,a=r.latitude;o.longitude,o.latitude},ve.prototype.mergeTexturesToTextureMaster=function(t,e,i){var r=i.length;r>8&&(r=8);for(var o,n=new Int32Array([0,0,0,0,0,0,0,0]),a=new Float32Array([1,1,1,1,1,1,1,1]),s=!1,l=0;l<r;l++){var h=i[l];if(t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,h.texId),n[l]=h.activeTextureType,a[l]=h.opacity,2===h.activeTextureType){if(void 0===h.temp_clampToTerrainTexCoord);void 0===o&&(o=new Float32Array([0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1])),s=!0,o[4*l]=h.temp_clampToTerrainTexCoord[0],o[4*l+1]=h.temp_clampToTerrainTexCoord[1],o[4*l+2]=h.temp_clampToTerrainTexCoord[2],o[4*l+3]=h.temp_clampToTerrainTexCoord[3]}else if(10===h.activeTextureType){var d=h.imagery.filter.properties;t.uniform2fv(e.uMinMaxAltitudes_loc,[d.minAltitude,d.maxAltitude])}}t.uniform1iv(e.uActiveTextures_loc,n),t.uniform1fv(e.externalAlphasArray_loc,a),s&&t.uniform4fv(e.uExternalTexCoordsArray_loc,o),t.drawArrays(t.TRIANGLES,0,6);for(l=0;l<r;l++){(h=i[l]).temp_clampToTerrainTexCoord=void 0}},ve.prototype.makeTextureMasterImageryLayers=function(){if(!this.textureMasterImageryLayersPrepared){var t=this.tinTerrainManager.magoManager,e=t.postFxShadersManager,i=t.getGl();if(void 0===this.textureMasterImageryLayers){this.textureMasterImageryLayers=new At;var r=new Uint8Array(262144);this.textureMasterImageryLayers.texId=At.createTexture(i,i.LINEAR,r,256,256)}var o=this.tinTerrainManager.texturesMergerFbo;if(R.bindFramebuffer(i,o,this.textureMasterImageryLayers.texId),i.viewport(0,0,256,256),i.clear(i.COLOR_BUFFER_BIT),void 0===this.tinTerrainManager.quadBuffer){var n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.tinTerrainManager.quadBuffer=R.createBuffer(i,n)}var a=e.getCurrentShader(),s=e.getShader("texturesMerger");e.useProgram(s);for(var l=0;l<8;l++)i.activeTexture(i.TEXTURE0+l),i.bindTexture(i.TEXTURE_2D,null);i.enableVertexAttribArray(s.position2_loc),R.bindAttribute(i,this.tinTerrainManager.quadBuffer,s.position2_loc,2);Object.keys(this.texture).length;var h=[],d=[],u=this.tinTerrainManager.imagerys,f=u.length;for(l=0;l<f;l++){var g=u[l],p=this.texture[g._id];if(p){var v=g._id,y=1,m=p.imagery.filter;m&&m.type===c.imageFilter.BATHYMETRY&&(y=10),p.texId instanceof WebGLTexture&&(this.tinTerrainManager.textureIdDeleteMap[v]?(this.tinTerrainManager.eraseTexture(p,t),delete this.texture[v]):p.imagery.show&&(p.setOpacity(p.imagery.opacity),p.setActiveTextureType(y),d.push(p),8===d.length&&(h.push(d),d=[])))}}d.length>0&&h.push(d),i.enable(i.BLEND);var x=h.length;for(l=0;l<x;l++)this.mergeTexturesToTextureMaster(i,s,h[l]);i.disable(i.BLEND),this.isTexturePrepared(this.texture)&&(this.textureMasterImageryLayersPrepared=!0,this.layersStyleId=this.tinTerrainManager.layersStyleId),R.bindFramebuffer(i,null),e.useProgram(a)}},ve.prototype.makeTextureMaster=function(){this.makeTextureMasterImageryLayers();var t=this.tinTerrainManager.getIntersectedObjectToClampToTerrain(this.geographicExtent),e=this.tinTerrainManager.magoManager,i=e.postFxShadersManager,r=e.getGl();if(void 0===this.textureMaster){var o=new Uint8Array(262144);this.textureMaster=At.createTexture(r,r.LINEAR,o,256,256)}var n=this.tinTerrainManager.texturesMergerFbo;if(R.bindFramebuffer(r,n,this.textureMaster),r.viewport(0,0,256,256),void 0===this.tinTerrainManager.quadBuffer){var a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.tinTerrainManager.quadBuffer=R.createBuffer(r,a)}var s=i.getCurrentShader(),l=i.getShader("texturesMerger");i.useProgram(l);for(var h=0;h<8;h++)r.activeTexture(r.TEXTURE0+h),r.bindTexture(r.TEXTURE_2D,null);r.enableVertexAttribArray(l.position2_loc),R.bindAttribute(r,this.tinTerrainManager.quadBuffer,l.position2_loc,2);Object.keys(this.texture).length;var d=[],u=[];u.push(this.textureMasterImageryLayers);var f=!0;if(t&&t.length>0){var g=t.length;for(h=0;h<g;h++){var p=t[h];8===u.length&&(d.push(u),u=[]),p.texture&&p.texture.fileLoadState===c.fileLoadState.BINDING_FINISHED?u.push(p.texture):f=!1}}if(u.length>0&&d.push(u),f){r.clear(r.COLOR_BUFFER_BIT),r.enable(r.BLEND);var v=d.length;for(h=0;h<v;h++)this.mergeTexturesToTextureMaster(r,l,d[h]);r.disable(r.BLEND)}f&&this.isTexturePrepared(this.texture)&&(this.textureMasterPrepared=!0,this.objToClampToTerrainStyleId=this.tinTerrainManager.objToClampToTerrainStyleId),R.bindFramebuffer(r,null),i.useProgram(s)},ve.prototype.bindTexture=function(t,e){var i=new Int32Array([1,1,0,0,1,0,0,0]),r=new Float32Array([1,1,1,1,1,1,1,1]);if(this.textureMaster){t.activeTexture(t.TEXTURE4+0),t.bindTexture(t.TEXTURE_2D,this.textureMaster);for(var o=(l=Object.keys(this.texture)).length,n=0;n<o;n++){var a=l[n];if((h=this.texture[a]).texId instanceof WebGLTexture)if(this.tinTerrainManager.textureIdDeleteMap[a])this.tinTerrainManager.eraseTexture(h,magoManager),delete this.texture[a];else if(h.imagery.show)if((d=h.imagery.filter)&&d.type===c.imageFilter.BATHYMETRY){i[5]=10,t.activeTexture(t.TEXTURE4+1),t.bindTexture(t.TEXTURE_2D,h.texId);var s=d.properties;t.uniform2fv(e.uMinMaxAltitudes_loc,new Float32Array([s.minAltitude,s.maxAltitude])),t.uniform1i(e.bApplyCaustics_loc,s.caustics)}}return t.uniform1iv(e.uActiveTextures_loc,i),void t.uniform1fv(e.externalAlphasArray_loc,r)}var l;for(o=(l=Object.keys(this.texture)).length,n=0;n<o;n++){var h,d;a=l[n];if((h=this.texture[a]).texId instanceof WebGLTexture)if(this.tinTerrainManager.textureIdDeleteMap[a])this.tinTerrainManager.eraseTexture(h,magoManager),delete this.texture[a];else if(h.imagery.show)t.activeTexture(t.TEXTURE4+n),t.bindTexture(t.TEXTURE_2D,h.texId),i[4+n]=1,r[4+n]=h.imagery.opacity,(d=h.imagery.filter)&&d.type===c.imageFilter.BATHYMETRY&&(i[4+n]=10,t.bindTexture(t.TEXTURE_2D,h.texId))}t.uniform1iv(e.uActiveTextures_loc,i),t.uniform1fv(e.externalAlphasArray_loc,r)},ve.prototype.prepareTexture=function(t,e,i,r){for(var o=i.sceneState.gl,n=this.depth.toString(),a=this.X.toString(),s=this.Y.toString(),l=0,h=e.length;l<h;l++){var d=e[l];if(!(!d.show||d.maxZoom<parseInt(n)||d.minZoom>parseInt(n))){var c=d._id;if(!this.texture[c]){var u=new At,f=d.getUrl({x:a,y:s,z:n});this.texFilePath__TEST=f;i.readerWriter.loadWMSImage(o,f,u,i,!1),this.texture[c]=u,this.texture[c].imagery=d,r.addTextureId(c)}}}},ve.prototype.prepareTinTerrainPlain=function(t,e){return!!this.tinTerrainManager.terrainReady&&(void 0===this.owner||this.owner.isPrepared()?(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState=c.fileLoadState.PARSE_FINISHED,this.fileLoadState===c.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.calculateCenterPosition(),this.makeMeshVirtually(20,20,void 0,void 0),this.makeVbo(t.vboMemoryManager),!1):!!this.isTexturePrepared(this.texture)||(this.prepareTexture(this.texture,e.imagerys,t,e),!1)):this.owner.prepareTinTerrainPlain(t,e))},ve.prototype.prepareTinTerrain=function(t,e){if(!this.tinTerrainManager.terrainReady)return!1;if(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState===c.fileLoadState.READY){if(!this.checkAvailableTerrain())return this.fileLoadState=c.fileLoadState.LOAD_FAILED,!1;var i=this.getPathName(),r=(t.readerWriter.geometryDataPath,this.tinTerrainManager.terrainValue+i+".terrain");return t.readerWriter.loadTINTerrain(r,this,t),!1}if(this.fileLoadState===c.fileLoadState.LOADING_FINISHED)return t.parseQueue.putTinTerrainToParse(this,0),!1;if(this.fileLoadState===c.fileLoadState.PARSE_STARTED){var o=e.textureParsedTerrainMap,n=this.depth,a=this.X,s=this.Y;if(!o[n])return;if(!o[n][a])return;if(!o[n][a][s])return;var l=o[n][a][s];return this.centerX=l.centerX,this.centerY=l.centerY,this.centerZ=l.centerZ,this.minHeight=l.minHeight,this.maxHeight=l.maxHeight,this.geographicExtent.setExtent(void 0,void 0,this.minHeight[0],void 0,void 0,this.maxHeight[0]),this.boundingSphereCenterX=l.boundingSphereCenterX,this.boundingSphereCenterY=l.boundingSphereCenterY,this.boundingSphereCenterZ=l.boundingSphereCenterZ,this.boundingSphereRadius=l.boundingSphereRadius,this.horizonOcclusionPointX=l.horizonOcclusionPointX,this.horizonOcclusionPointY=l.horizonOcclusionPointY,this.horizonOcclusionPointZ=l.horizonOcclusionPointZ,this.vertexCount=l.vertexCount,this.uValues=l.uValues,this.vValues=l.vValues,this.hValues=l.hValues,this.trianglesCount=l.trianglesCount,this.indices=l.indices,this.westVertexCount=l.westVertexCount,this.westIndices=l.westIndices,this.southVertexCount=l.southVertexCount,this.southIndices=l.southIndices,this.eastVertexCount=l.eastVertexCount,this.eastIndices=l.eastIndices,this.northVertexCount=l.northVertexCount,this.northIndices=l.northIndices,this.extensionId=l.extensionId,this.extensionLength=l.extensionLength,this.fileLoadState=c.fileLoadState.PARSE_FINISHED,delete this.tinTerrainManager.textureParsedTerrainMap[n][a][s],!1}if(this.fileLoadState===c.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer){if(!this.requestDecodeData)return this.decodeData(e.imageryType),!1;n=this.depth,a=this.X,s=this.Y;var h=e.textureDecodedTerrainMap;if(!h[n])return!1;if(!h[n][a])return!1;if(!h[n][a][s])return!1;l=h[n][a][s];return this.texCoordsArray=l.texCoordsArray,this.cartesiansArray=l.cartesiansArray,this.skirtCartesiansArray=l.skirtCartesiansArray,this.skirtTexCoordsArray=l.skirtTexCoordsArray,this.skirtAltitudesArray=l.skirtAltitudesArray,this.altArray=l.altArray,this.normalsArray=l.normalsArray,this.lonArray=l.longitudesArray,this.latArray=l.latitudesArray,delete this.tinTerrainManager.textureDecodedTerrainMap[n][a][s],this.makeVbo(t.vboMemoryManager),this.makeSeaMeshVirtually(void 0),this.makeVboSea(t.vboMemoryManager),!1}return this.isTexturePrepared(this.texture)?this.fileLoadState===c.fileLoadState.LOAD_FAILED?this.prepareTinTerrainPlain(t,e):(this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterImageryLayersPrepared=void 0,this.textureMasterPrepared=void 0),!this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster(),!(void 0!==this.owner&&!this.owner.isPrepared())||this.owner.prepareTinTerrain(t,e)):(this.prepareTexture(this.texture,e.imagerys,t,e),!1)},ve.prototype.prepareTinTerrain__original=function(t,e){if(!this.tinTerrainManager.terrainReady)return!1;if(void 0===this.owner||this.owner.isPrepared()&&this.owner.hasAnyChildVisible()){if(t.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState===c.fileLoadState.READY){if(!this.checkAvailableTerrain())return this.fileLoadState=c.fileLoadState.LOAD_FAILED,!1;var i=this.getPathName(),r=(t.readerWriter.geometryDataPath,this.tinTerrainManager.terrainValue+i+".terrain");return t.readerWriter.loadTINTerrain(r,this,t),!1}if(this.fileLoadState===c.fileLoadState.LOADING_FINISHED)return t.parseQueue.putTinTerrainToParse(this,0),!1;if(this.fileLoadState===c.fileLoadState.PARSE_STARTED){var o=e.textureParsedTerrainMap,n=this.depth,a=this.X,s=this.Y;if(!o[n])return;if(!o[n][a])return;if(!o[n][a][s])return;var l=o[n][a][s];return this.centerX=l.centerX,this.centerY=l.centerY,this.centerZ=l.centerZ,this.minHeight=l.minHeight,this.maxHeight=l.maxHeight,this.geographicExtent.setExtent(void 0,void 0,this.minHeight[0],void 0,void 0,this.maxHeight[0]),this.boundingSphereCenterX=l.boundingSphereCenterX,this.boundingSphereCenterY=l.boundingSphereCenterY,this.boundingSphereCenterZ=l.boundingSphereCenterZ,this.boundingSphereRadius=l.boundingSphereRadius,this.horizonOcclusionPointX=l.horizonOcclusionPointX,this.horizonOcclusionPointY=l.horizonOcclusionPointY,this.horizonOcclusionPointZ=l.horizonOcclusionPointZ,this.vertexCount=l.vertexCount,this.uValues=l.uValues,this.vValues=l.vValues,this.hValues=l.hValues,this.trianglesCount=l.trianglesCount,this.indices=l.indices,this.westVertexCount=l.westVertexCount,this.westIndices=l.westIndices,this.southVertexCount=l.southVertexCount,this.southIndices=l.southIndices,this.eastVertexCount=l.eastVertexCount,this.eastIndices=l.eastIndices,this.northVertexCount=l.northVertexCount,this.northIndices=l.northIndices,this.extensionId=l.extensionId,this.extensionLength=l.extensionLength,this.fileLoadState=c.fileLoadState.PARSE_FINISHED,delete this.tinTerrainManager.textureParsedTerrainMap[n][a][s],!1}if(this.fileLoadState===c.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer){if(!this.requestDecodeData)return this.decodeData(e.imageryType),!1;n=this.depth,a=this.X,s=this.Y;var h=e.textureDecodedTerrainMap;if(!h[n])return!1;if(!h[n][a])return!1;if(!h[n][a][s])return!1;l=h[n][a][s];return this.texCoordsArray=l.texCoordsArray,this.cartesiansArray=l.cartesiansArray,this.skirtCartesiansArray=l.skirtCartesiansArray,this.skirtTexCoordsArray=l.skirtTexCoordsArray,this.skirtAltitudesArray=l.skirtAltitudesArray,this.altArray=l.altArray,this.normalsArray=l.normalsArray,this.lonArray=l.longitudesArray,this.latArray=l.latitudesArray,delete this.tinTerrainManager.textureDecodedTerrainMap[n][a][s],this.makeVbo(t.vboMemoryManager),this.makeSeaMeshVirtually(void 0),this.makeVboSea(t.vboMemoryManager),!1}return this.isTexturePrepared(this.texture)?this.fileLoadState===c.fileLoadState.LOAD_FAILED?this.prepareTinTerrainPlain(t,e):(this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterPrepared=void 0),void 0===this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster(),!0):(this.prepareTexture(this.texture,e.imagerys,t,e),!1)}return this.owner.prepareTinTerrain(t,e)},ve.prototype.prepareTinTerrainRealTimeElevation=function(t,e){if(this.depth<10)return this.prepareTinTerrainPlain(t,e);if(void 0===this.owner||this.owner.isPrepared()){if(t.processQueue.eraseTinTerrainToDelete(this),!this.isTexturePrepared(this.textureElevation))return this.prepareTexture(this.textureElevation,e.imagerysDEM,t,e),!1;if(this.fileLoadState===c.fileLoadState.READY){var i=Object.keys(this.textureElevation);if(i.length>0){var r=this.textureElevation[i[0]];if(r){this.minHeight=new Float32Array([-200]),this.maxHeight=new Float32Array([1943.15]);var o=this.makeAltitudesSliceByTexture(16,16,void 0,r,t);this.test_mesh=1;var n={};n.altitudesSlice=o,this.makeMeshVirtually(16,16,void 0,n),this.fileLoadState=c.fileLoadState.PARSE_FINISHED}}return!1}return this.fileLoadState===c.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.makeVbo(t.vboMemoryManager),!1):this.isTexturePrepared(this.texture)?this.fileLoadState!==c.fileLoadState.LOAD_FAILED||this.prepareTinTerrainPlain(t,e):(this.prepareTexture(this.texture,e.imagerys,t,e),!1)}return this.owner.prepareTinTerrainRealTimeElevation(t,e)},ve.prototype.hasChildren=function(){return!(void 0===this.childMap||!(this.childMap.LD||this.childMap.RD||this.childMap.RU||this.childMap.LU))},ve.prototype.deleteTinTerrain=function(t){if(this.hasChildren()){for(var e in this.childMap){if(Object.prototype.hasOwnProperty.call(this.childMap,e))this.childMap[e].deleteTinTerrain(t)}return!1}return t.parseQueue.eraseTinTerrainToParse(this),t.processQueue.putTinTerrainToDelete(this,0),!0},ve.prototype.renderBorder=function(t,e){},ve.prototype.render=function(t,e,i,r,o){if(0===this.depth)return!0;if(void 0===this.owner||this.owner.isPrepared()&&this.owner.isChildrenPrepared())if(this.isPrepared()){if(this.fileLoadState===c.fileLoadState.LOAD_FAILED)return!1;if(!this.isTexturePrepared(this.texture))return!1;if(this.renderingFase===this.tinTerrainManager.renderingFase)return;if(this.owner.renderingFase===this.tinTerrainManager.renderingFase)return;var n=e.getGl();if(2===r){var a;a=e.selectionColor.getAvailableColor(a);var s=e.selectionColor.decodeColor3(a.r,a.g,a.b);e.selectionManager.setCandidateGeneral(s,this),n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1])}else if(1===r){var l=!1;if(this.objToClampToTerrainStyleId!==this.tinTerrainManager.objToClampToTerrainStyleId&&(l=!0),this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(l=!0),l&&this.isTexturePrepared(this.texture)){this.makeTextureMaster(),t.resetLastBuffersBinded(),e.postFxShadersManager.useProgram(t),t.enableVertexAttribArray(t.position3_loc),i?t.disableVertexAttribArray(t.texCoord2_loc):t.enableVertexAttribArray(t.texCoord2_loc),n.viewport(0,0,e.sceneState.drawingBufferWidth[0],e.sceneState.drawingBufferHeight[0]);n.uniform1i(t.bApplySsao_loc,!0),n.uniform1f(t.aspectRatio_loc,e.sceneState.camera.frustum.aspectRatio),n.uniform1f(t.screenWidth_loc,e.sceneState.drawingBufferWidth);var h=e.texturesStore.getNoiseTexture4x4();n.uniform2fv(t.noiseScale2_loc,[e.depthFboNeo.width/h.width,e.depthFboNeo.height/h.height]),n.uniform3fv(t.kernel16_loc,e.sceneState.ssaoKernel16),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,e.depthFboNeo.colorBuffer),n.activeTexture(n.TEXTURE3),n.bindTexture(n.TEXTURE_2D,h)}new Int32Array([1,1,0,0,0,0,0,0]);n.uniform1i(t.colorType_loc,2),n.uniform1f(t.externalAlpha_loc,1),n.uniform1i(t.bApplySsao_loc,this.depth>8);var d=(new Date).getTime()/1e3%1e3;void 0===this.timeRandomFactor&&(this.timeRandomFactor=1e3*Math.random()),(d+=this.timeRandomFactor)>1e3&&(d-=1e3),n.uniform1f(t.uTime_loc,d),this.bindTexture(n,t)}var f=e.vboMemoryManager;if(n.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW),n.uniform1i(t.uTileDepth_loc,this.depth),n.uniform1i(t.uSeaOrTerrainType_loc,0),!(g=this.vboKeyContainer.vboCacheKeysArray[0]).bindDataPosition(t,f))return void 0!==this.owner&&this.owner.render(t,e,i,r,o),!1;if(!i&&!g.bindDataTexCoord(t,f))return void 0!==this.owner&&this.owner.render(t,e,i,r,o),!1;if(!g.bindDataNormal(t,f))return void 0!==this.owner&&this.owner.render(t,e,i,r,o),!1;if(!g.bindDataIndice(t,f))return void 0!==this.owner&&this.owner.render(t,e,i,r,o),!1;var g,p=g.indicesCount;if(e.selectionManager.getSelectedGeneral()!==this&&n.drawElements(n.TRIANGLES,p,n.UNSIGNED_SHORT,0),o.push(this),this.intersectionType=u.INTERSECTION_OUTSIDE,1===r)if(n.uniform1i(t.colorType_loc,2),e.selectionManager.getSelectedGeneral()===this){n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[0,.9,.9,1]);for(var v=p,y=0;y<v-1;y++)n.drawElements(n.LINE_LOOP,3,n.UNSIGNED_SHORT,3*y);this.drawTerrainName(e)}if(void 0===(g=this.vboKeyContainer.vboCacheKeysArray[1]))return;if(!g.bindDataPosition(t,f))return!1;if(1===r&&!g.bindDataTexCoord(t,f))return!1;n.uniform1i(t.bApplySsao_loc,!1),e.selectionManager.getSelectedGeneral()!==this&&n.drawArrays(n.TRIANGLE_STRIP,0,g.vertexCount),this.renderingFase=this.tinTerrainManager.renderingFase}else void 0!==this.owner&&this.owner.render(t,e,i,r,o);else void 0!==this.owner&&this.owner.render(t,e,i,r,o);return!0},ve.prototype.renderSea=function(t,e,i,r){if(0===this.depth)return!0;if(this.minHeight[0]>0)return!1;if(void 0!==this.vboKeyContainer){var o=this.vboKeyContainer.vboCacheKeysArray[2];if(void 0!==o){var n=e.getGl(),a=new Int32Array([1,1,0,0,0,0,0,0]);n.uniform1i(t.colorType_loc,2),n.uniform1f(t.externalAlpha_loc,1);for(var s=Object.keys(this.texture),l=s.length,h=0;h<l;h++){n.activeTexture(n.TEXTURE2+h);var d=this.texture[s[h]];n.bindTexture(n.TEXTURE_2D,d.texId),a[2+h]=1;var u=d.imagery.filter;u&&u.type===c.imageFilter.BATHYMETRY&&(a[2+h]=10)}n.uniform1iv(t.uActiveTextures_loc,a);var f=e.vboMemoryManager;n.uniform3fv(t.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(t.buildingPosLOW_loc,this.terrainPositionLOW),n.uniform1i(t.uTileDepth_loc,this.depth);var g=this.vboKeyContainer.vboCacheKeysArray[0];if(1===r&&o){if(n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[.1,.7,.9,.5]),n.uniform1i(t.uSeaOrTerrainType_loc,1),!o.bindDataPosition(t,f))return!1;if(!o.bindDataNormal(t,f))return!1;if(!g.bindDataTexCoord(t,f))return!1;if(!(g=this.vboKeyContainer.vboCacheKeysArray[0]).bindDataIndice(t,f))return!1;var p=g.indicesCount;if(!1){var v=p;for(h=0;h<v;h++)n.drawElements(n.LINE_LOOP,3,n.UNSIGNED_SHORT,3*h)}else n.drawElements(n.TRIANGLES,p,n.UNSIGNED_SHORT,0)}return!0}}},ve.prototype.drawTerrainName=function(t){var e,i=t.getObjectLabel().getContext("2d"),r=t.getGl(),o=this.geographicExtent.getMidPoint(),n=Ei.geographicCoordToWorldPoint(o.longitude,o.latitude,o.altitude,void 0);if((e=Ei.calculateWorldPositionToScreenCoord(r,n.x,n.y,n.z,e,t)).x>=0&&e.y>=0){i.font="13px Arial";var a=this.getPathName();i.strokeText(a,e.x,e.y),i.fillText(a,e.x,e.y),t.canvasDirty=!0}i.restore()},ve.prototype.extractLowestTinTerrains=function(t){if(hasChildren())for(var e in this.childMap)if(Object.prototype.hasOwnProperty.call(this.childMap,e)){var i=this.childMap[e];i.visible=!1,t.push(i)}},ve.prototype.getObjectIdxSortedByDist=function(t,e,i,r){var o=i-e;if(o<6){for(var n,a=!1,s=e;!a&&s<=i;){var l=t[s];r.distToCam<l.distToCam&&(n=s,a=!0),s++}return a?n:i+1}var h,d,c=e+Math.floor(o/2);return t[c].distToCam>r.distToCam?(h=e,d=c):(h=c,d=i),this.getObjectIdxSortedByDist(t,h,d,r)},ve.prototype.putObjectToArraySortedByDist=function(t,e){if(t.length>0){var i=t.length-1,r=this.getObjectIdxSortedByDist(t,0,i,e);t.splice(r,0,e)}else t.push(e)},ve.prototype.getFrustumIntersectedTinTerrainsQuadTree=function(t,e,i,r,o,n){if(void 0!==this.geographicExtent&&void 0!==this.geographicExtent.minGeographicCoord&&void 0!==this.geographicExtent.maxGeographicCoord){var a=this.geographicExtent.minGeographicCoord,s=this.geographicExtent.maxGeographicCoord;void 0===this.sphereExtent&&(this.sphereExtent=vt.computeSphereExtent(r,a,s,this.sphereExtent));var l=this.sphereExtent,h=this.depth;this.intersectionType=t.intersectionSphere(this.sphereExtent),this.distToCam=i.distToSphere(l),this.intersectionType===u.INTERSECTION_OUTSIDE&&this.depth>0&&(this.distToCam<0&&(this.distToCam=1),this.distToCam*=1e5);var d=this.tinTerrainManager.distLimitByDepth[h];if(this.distToCam>d)return this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),this.putObjectToArraySortedByDist(o[this.depth],this),void(this.hasChildren()&&(n.push(this.childMap.LU),n.push(this.childMap.LD),n.push(this.childMap.RU),n.push(this.childMap.RD)));if(!(h<e))return this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),void this.putObjectToArraySortedByDist(o[this.depth],this);var f=this.X,g=this.Y,p=a.longitude,v=a.latitude,y=a.altitude,m=s.longitude,x=s.latitude,b=s.altitude,C=(p+m)/2,A=(v+x)/2;this.tinTerrainManager.imageryType===c.imageryType.WEB_MERCATOR&&(A=180*this.getMidLatitudeRadWebMercator()/Math.PI);var T=this.webMercatorExtent.minX,M=this.webMercatorExtent.minY,P=this.webMercatorExtent.maxX,w=this.webMercatorExtent.maxY,_=(P+T)/2,S=(w+M)/2;void 0===this.childMap&&(this.childMap={});var L=this.childMap.LU;void 0===L&&((L=new ve(this)).X=2*f,L.Y=2*g,L.setGeographicExtent(p,A,y,C,x,b),L.indexName="LU",L.tinTerrainManager=this.tinTerrainManager,this.childMap.LU=L,L.setWebMercatorExtent(T,S,_,w));var R=this.childMap.LD;void 0===R&&((R=new ve(this)).X=2*f,R.Y=2*g+1,R.setGeographicExtent(p,v,y,C,A,b),R.indexName="LD",R.tinTerrainManager=this.tinTerrainManager,this.childMap.LD=R,R.setWebMercatorExtent(T,M,_,S));var D=this.childMap.RU;void 0===D&&((D=new ve(this)).X=2*f+1,D.Y=2*g,D.setGeographicExtent(C,A,y,m,x,b),D.indexName="RU",D.tinTerrainManager=this.tinTerrainManager,this.childMap.RU=D,D.setWebMercatorExtent(_,S,P,w));var E=this.childMap.RD;if(void 0===E&&((E=new ve(this)).X=2*f+1,E.Y=2*g+1,E.setGeographicExtent(C,v,y,m,A,b),E.indexName="RD",E.tinTerrainManager=this.tinTerrainManager,this.childMap.RD=E,E.setWebMercatorExtent(_,M,P,S)),!this.isPrepared()){this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),this.putObjectToArraySortedByDist(o[this.depth],this);var I=this.depth+1;return void 0===o[I]&&(o[I]=[]),this.putObjectToArraySortedByDist(o[I],this.childMap.LU),this.putObjectToArraySortedByDist(o[I],this.childMap.LD),this.putObjectToArraySortedByDist(o[I],this.childMap.RU),void this.putObjectToArraySortedByDist(o[I],this.childMap.RD)}L.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,r,o,n),R.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,r,o,n),D.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,r,o,n),E.getFrustumIntersectedTinTerrainsQuadTree(t,e,i,r,o,n)}},ve.prototype.calculateCenterPosition=function(){if(0===this.depth)this.centerX=new Float64Array([0]),this.centerY=new Float64Array([0]),this.centerZ=new Float64Array([0]);else{var t,e,i=(t=this.geographicExtent.getMidPoint(t)).longitude,r=t.latitude;e=W.geographicToCartesianWgs84(i,r,0,e),this.centerX=new Float64Array([e[0]]),this.centerY=new Float64Array([e[1]]),this.centerZ=new Float64Array([e[2]])}},ve.prototype.getMidLatitudeRadWebMercator=function(){if(void 0!==this.webMercatorExtent){var t=(this.webMercatorExtent.maxY+this.webMercatorExtent.minY)/2;return 2*Math.atan(Math.pow(Math.E,t))-Math.PI/2}},ve.prototype.makeAltitudesSliceByTexture=function(t,e,i,r,o){var n=o.getGl(),a=n.createFramebuffer();if(n.bindFramebuffer(n.FRAMEBUFFER,a),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,r.texId,0),n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE){var s=r.imageWidth,l=r.imageHeight,h=new Uint8Array(4),d=new Float32Array((t+1)*(e+1));this.minHeight[0]=-200,this.maxHeight[0]=1943.15;var c=this.minHeight[0],u=this.maxHeight[0];void 0===c&&(c=0),void 0===u&&(u=0);for(var f=u-c,g=0,p=0;p<e+1;p++){var v=Math.floor((1-p/(e+1))*l);v<0&&(v=0),v>255&&(v=255);for(var y=0;y<t+1;y++){var m=Math.floor(y/(t+1)*s);m<0&&(m=0),n.readPixels(m,v,1,1,n.RGBA,n.UNSIGNED_BYTE,h);var x=c+h[0]/256*f;d[g]=x,g+=1}}}return n.bindFramebuffer(n.FRAMEBUFFER,null),d},ve.prototype.makeMeshVirtually=function(t,e,i,r){var o;r&&r.altitudesSlice&&(o=r.altitudesSlice);var n=Math.PI/180,a=this.geographicExtent.minGeographicCoord.longitude*n,s=this.geographicExtent.minGeographicCoord.latitude*n,l=this.geographicExtent.maxGeographicCoord.longitude*n,h=this.geographicExtent.maxGeographicCoord.latitude*n;void 0===this.minHeight&&(this.minHeight=new Float32Array([0])),void 0===this.maxHeight&&(this.maxHeight=new Float32Array([0]));var d=l-a,c=h-s,u=this.depth,f=d/t,g=c/e,p=(t+1)*(e+1),v=new Float32Array(p),y=new Float32Array(p),m=new Float32Array(p);this.texCoordsArray=new Float32Array(2*p);var x,b,C=a,A=s,T=0,M=Math.PI,P=1/(2*M)*Math.pow(2,u),w=0;i&&(w=i);var _=M/4,S=Math.round(P*(M-Math.log(Math.tan(_+s/2)))),L=Math.round(P*(M-Math.log(Math.tan(_+h/2)))),R=Math.round(P*(a+M)),D=(Math.round(P*(l+M)),Math.floor(R));S=1-S,L=1-L;for(var E=this.tinTerrainManager.getTexCorrection(u),I=0;I<e+1;I++){(A=s+g*I)>h&&(A=h),b=1-(b=P*(M-Math.log(Math.tan(_+A/2)))),b-=S,x<0?x=0:x>1&&(x=1),b<0?b=0:b>1&&(b=1);for(var O=0;O<t+1;O++)(C=a+f*O)>l&&(C=l),v[T]=C,y[T]=A,m[T]=o?o[T]:w,x=P*(C+M),x-=D,0===O?x+=E/2:O===t&&(x+=-E/2),this.texCoordsArray[2*T]=x,this.texCoordsArray[2*T+1]=b,T++}this.cartesiansArray=W.geographicRadianArrayToFloat32ArrayWgs84(v,y,m,void 0),this.normalsArray=new Int8Array(3*p);for(var F=new ur,N=0;N<p;N++)F.set(this.cartesiansArray[3*N],this.cartesiansArray[3*N+1],this.cartesiansArray[3*N+2]),F.unitary(),this.normalsArray[3*N]=126*F.x,this.normalsArray[3*N+1]=126*F.y,this.normalsArray[3*N+2]=126*F.z;var B=t+1,V=e+1,j=(r={bCalculateBorderIndices:!0},Li.getIndicesTrianglesRegularNet(B,V,void 0,void 0,void 0,void 0,void 0,r));this.indices=j.indicesArray,this.southIndices=j.southIndicesArray,this.eastIndices=j.eastIndicesArray,this.northIndices=j.northIndicesArray,this.westIndices=j.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;r={skirtDepth:1e4,texCorrectionFactor:E};var U=ve.getSkirtTrianglesStrip(v,y,m,this.texCoordsArray,this.southIndices,this.eastIndices,this.northIndices,this.westIndices,r);this.skirtCartesiansArray=U.skirtCartesiansArray,this.skirtTexCoordsArray=U.skirtTexCoordsArray,this.calculateCenterPosition()},ve.prototype.makeSeaMeshVirtually=function(t){var e=this.lonArray.length,i=new Float32Array(e);this.cartesiansArraySea=W.geographicRadianArrayToFloat32ArrayWgs84(this.lonArray,this.latArray,i,void 0),this.normalsArraySea=new Int8Array(3*e);for(var r=new ur,o=0;o<e;o++)r.set(this.cartesiansArraySea[3*o],this.cartesiansArraySea[3*o+1],this.cartesiansArraySea[3*o+2]),r.unitary(),this.normalsArraySea[3*o]=126*r.x,this.normalsArraySea[3*o+1]=126*r.y,this.normalsArraySea[3*o+2]=126*r.z;t={skirtDepth:1e4,texCorrectionFactor:this.tinTerrainManager.getTexCorrection(this.depth)};var n=ve.getSkirtTrianglesStrip(this.lonArray,this.latArray,i,this.texCoordsArray,this.southIndices,this.eastIndices,this.northIndices,this.westIndices,t);this.skirtCartesiansArraySea=n.skirtCartesiansArray,this.skirtTexCoordsArraySea=n.skirtTexCoordsArray},ve.prototype.makeMeshVirtuallyCRS84=function(t,e,i,r){var o=Math.PI/180,n=this.geographicExtent.minGeographicCoord.longitude*o,a=this.geographicExtent.minGeographicCoord.latitude*o,s=this.geographicExtent.maxGeographicCoord.longitude*o,l=this.geographicExtent.maxGeographicCoord.latitude*o,h=s-n,d=l-a,c=(this.depth,h/t),u=d/e,f=(t+1)*(e+1),g=new Float32Array(f),p=new Float32Array(f),v=new Float32Array(f);this.texCoordsArray=new Float32Array(2*f);var y,m,x=n,b=a,C=0,A=0;i&&(A=i);for(var T=0;T<e+1;T++){(b=a+u*T)>l&&(b=l);for(var M=0;M<t+1;M++)(x=n+c*M)>s&&(x=s),g[C]=x,p[C]=b,v[C]=r?r.getValue(M,T):A,y=(x-n)/h,m=(b-a)/d,this.texCoordsArray[2*C]=y,this.texCoordsArray[2*C+1]=m,C++}this.cartesiansArray=W.geographicRadianArrayToFloat32ArrayWgs84(g,p,v,this.cartesiansArray),this.normalsArray=new Int8Array(3*f);for(var P=new ur,w=0;w<f;w++)P.set(this.cartesiansArray[3*w],this.cartesiansArray[3*w+1],this.cartesiansArray[3*w+2]),P.unitary(),this.normalsArray[3*w]=126*P.x,this.normalsArray[3*w+1]=126*P.y,this.normalsArray[3*w+2]=126*P.z;var _=t+1,S=e+1,L=Li.getIndicesTrianglesRegularNet(_,S,void 0,void 0,void 0,void 0,void 0,{bCalculateBorderIndices:!0});this.indices=L.indicesArray,this.southIndices=L.southIndicesArray,this.eastIndices=L.eastIndicesArray,this.northIndices=L.northIndicesArray,this.westIndices=L.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length,this.calculateCenterPosition()},ve.prototype.zigZagDecode=function(t){return t>>1^-(1&t)},ve.prototype.makeVbo=function(t){if(void 0!==this.cartesiansArray){for(var e=this.cartesiansArray.length/3,i=0;i<e;i++)this.cartesiansArray[3*i]-=this.centerX[0],this.cartesiansArray[3*i+1]-=this.centerY[0],this.cartesiansArray[3*i+2]-=this.centerZ[0];void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),Ei.calculateSplited3fv([this.centerX[0],this.centerY[0],this.centerZ[0]],this.terrainPositionHIGH,this.terrainPositionLOW),void 0===this.vboKeyContainer&&(this.vboKeyContainer=new Nt);var r=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(r.setDataArrayPos(this.cartesiansArray,t),this.normalsArray&&r.setDataArrayNor(this.normalsArray,t),this.texCoordsArray&&r.setDataArrayTexCoord(this.texCoordsArray,t),r.setDataArrayIdx(this.indices,t),void 0!==this.skirtCartesiansArray){var o=this.skirtCartesiansArray.length;for(i=0;i<o;i++)this.skirtCartesiansArray[3*i]-=this.centerX[0],this.skirtCartesiansArray[3*i+1]-=this.centerY[0],this.skirtCartesiansArray[3*i+2]-=this.centerZ[0];var n=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(n.setDataArrayPos(this.skirtCartesiansArray,t),this.skirtTexCoordsArray&&n.setDataArrayTexCoord(this.skirtTexCoordsArray,t),void 0!==this.seaCartesiansArray)this.vboKeyContainer.newVBOVertexIdxCacheKey().setDataArrayPos(this.seaCartesiansArray,t)}}},ve.prototype.makeVboSea=function(t){if(void 0!==this.cartesiansArraySea){for(var e=this.cartesiansArraySea.length/3,i=0;i<e;i++)this.cartesiansArraySea[3*i]-=this.centerX[0],this.cartesiansArraySea[3*i+1]-=this.centerY[0],this.cartesiansArraySea[3*i+2]-=this.centerZ[0];void 0===this.vboKeyContainer&&(this.vboKeyContainer=new Nt);var r=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(r.setDataArrayPos(this.cartesiansArraySea,t),this.normalsArraySea&&r.setDataArrayNor(this.normalsArraySea,t),this.texCoordsArraySea&&r.setDataArrayTexCoord(this.texCoordsArraySea,t),r.setDataArrayIdx(this.indicesSea,t),void 0!==this.skirtCartesiansArraySea){var o=this.skirtCartesiansArraySea.length;for(i=0;i<o;i++)this.skirtCartesiansArraySea[3*i]-=this.centerX[0],this.skirtCartesiansArraySea[3*i+1]-=this.centerY[0],this.skirtCartesiansArraySea[3*i+2]-=this.centerZ[0];var n=this.vboKeyContainer.newVBOVertexIdxCacheKey();n.setDataArrayPos(this.skirtCartesiansArraySea,t),this.skirtTexCoordsArraySea&&n.setDataArrayTexCoord(this.skirtTexCoordsArraySea,t)}}},ve.getSkirtTrianglesStrip=function(t,e,i,r,o,n,a,s,l){var h=1e3,d=1,c=!1;l&&(void 0!==l.skirtDepth&&(h=l.skirtDepth),void 0!==l.texCorrectionFactor&&(d=l.texCorrectionFactor),l.bMakeAltitudesArray&&(c=!0));for(var u=s.length,f=o.length,g=n.length,p=a.length,v=u+f+g+p,y=new Float32Array(2*v),m=new Float32Array(2*v),x=new Float32Array(2*v),b=new Float32Array(4*v),C=new Float32Array(4*v),A=0,T=0;T<u;T++){r[2*(M=s[T])]+=d,y[A]=t[M],m[A]=e[M],x[A]=i[M],b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),y[A+=1]=t[M],m[A]=e[M],x[A]=i[M]-h,b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),A+=1}for(T=0;T<f;T++){r[2*(M=o[T])+1]=d,y[A]=t[M],m[A]=e[M],x[A]=i[M],b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),y[A+=1]=t[M],m[A]=e[M],x[A]=i[M]-h,b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),A+=1}for(T=0;T<g;T++){r[2*(M=n[T])]-=d,y[A]=t[M],m[A]=e[M],x[A]=i[M],b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),y[A+=1]=t[M],m[A]=e[M],x[A]=i[M]-h,b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),A+=1}for(T=0;T<p;T++){var M;r[2*(M=a[T])+1]=1-d,y[A]=t[M],m[A]=e[M],x[A]=i[M],b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),y[A+=1]=t[M],m[A]=e[M],x[A]=i[M]-h,b[2*A]=r[2*M],b[2*A+1]=r[2*M+1],c&&(C[A]=i[M]),A+=1}var P={skirtCartesiansArray:W.geographicRadianArrayToFloat32ArrayWgs84(y,m,x,void 0),skirtTexCoordsArray:b,skirtAltitudesArray:x};return c&&(P.skirtAltitudesValuesArray=C),P},ve.getNormalCartesiansArray=function(t,e,i,r){for(var o,n,a,s,l,h,d=[],c=e.length/3,u=0;u<c;u++)o=e[3*u],n=e[3*u+1],a=e[3*u+2],s=new ur(t[3*o],t[3*o+1],t[3*o+2]),l=new ur(t[3*n],t[3*n+1],t[3*n+2]),h=new ur(t[3*a],t[3*a+1],t[3*a+2]),g=Or.calculateNormal(s,h,l,void 0),void 0!==d[o]?d[o].addPoint(g):d[o]=g,void 0!==d[n]?d[n].addPoint(g):d[n]=g,void 0!==d[a]?d[a].addPoint(g):d[a]=g;var f=d.length;void 0===i&&(i=new Int8Array(3*f));for(u=0;u<f;u++){var g;(g=d[u]).unitary(),i[3*u]=Math.floor(255*g.x),i[3*u+1]=Math.floor(255*g.y),i[3*u+2]=Math.floor(255*g.z)}return i},ve.prototype.getAltitudes_byAltitudesMap=function(t,e,i){},ve.prototype.getAltitudes_byAltitudesOwnMap=function(t,e,i){void 0===this.altitudesFbo&&this.makeAltitudesOwnMap(i);var r=this.geographicExtent.minGeographicCoord.longitude,o=this.geographicExtent.minGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.longitude-r,a=this.geographicExtent.maxGeographicCoord.latitude-o,s=this.minHeight[0],l=this.maxHeight[0]-s,h=new Uint8Array(4),d=this.altitudesFbo.width,c=this.altitudesFbo.height;void 0===e&&(e=[]),this.altitudesFbo.bind();for(var u=t.length,f=0;f<u;f++){var g=t[f],p=(g.longitude-r)/n*d,v=(g.latitude-o)/a*c;gl.readPixels(p,v,1,1,gl.RGBA,gl.UNSIGNED_BYTE,h);var y=s+(h[0]/16777216+h[1]/65536+h[2]/256+h[3])/256*l;g.altitude=y,e.push(g)}return this.altitudesFbo.unbind(),e},ve.prototype.makeAltitudesOwnMap=function(t){var e=t.getGl();if(void 0===this.altitudesFbo){this.altitudesFbo=new R(e,256,256)}for(var i,r,o,n,a,s,l=this.uValues,h=this.vValues,d=this.hValues,c=(this.indices,l.length),u=new Float32Array(3*c),f=0;f<c;f++)u[3*f]=l[f]/32767,u[3*f+1]=h[f]/32767,u[3*f+2]=d[f]/32767,0===f?(i=u[3*f],r=u[3*f+1],o=u[3*f+2],n=u[3*f],a=u[3*f+1],s=u[3*f+2]):(u[3*f]<n?n=u[3*f]:u[3*f]>i&&(i=u[3*f]),u[3*f+1]<a?a=u[3*f+1]:u[3*f+1]>r&&(r=u[3*f+1]),u[3*f+2]<s?s=u[3*f+2]:u[3*f+2]>o&&(o=u[3*f+2]));void 0===this.vboKeyContainerAltitudes&&(this.vboKeyContainerAltitudes=new Nt);var g=this.vboKeyContainerAltitudes.newVBOVertexIdxCacheKey(),p=this.vboKeyContainer.vboCacheKeysArray[0],v=t.vboMemoryManager;g.setDataArrayPos(u,v);var y=new rt,m=new rt;this.altitudesMapMVPMat=new rt;var x=1*-depthFactor,b=1*depthFactor;m._floatArrays=glMatrix.mat4.ortho(m._floatArrays,-1,1,-1,1,x,b),this.altitudesMapMVPMat=y.getMultipliedByMatrix(m,this.altitudesMapMVPMat),this.altitudesFbo.bind();var C=t.postFxShadersManager.getShader("tinTerrainAltitudes");if(C.useProgram(),C.enableVertexAttribArray(C.position3_loc),!g.bindDataPosition(C,v))return!1;if(!p.bindDataIndice(C,v))return!1;var A=p.indicesCount;e.drawElements(e.TRIANGLES,A,e.UNSIGNED_SHORT,0),this.altitudesFbo.unbind()},ve.prototype.decodeData=function(t){if(void 0!==this.geographicExtent){void 0===this.vertexArray&&(this.vertexArray=[]);var e=this.tinTerrainManager;this.tinTerrainManager.workerDecodedTerrain||(this.tinTerrainManager.workerDecodedTerrain=new Worker(f.scriptRootPath+"Worker/workerDecodeTerrain.js"),this.tinTerrainManager.workerDecodedTerrain.onmessage=function(t){var i=t.data.info,r=t.data.decodedTerrain,o=e.textureDecodedTerrainMap;o[i.z]||(o[i.z]={}),o[i.z][i.x]||(o[i.z][i.x]={}),o[i.z][i.x][i.y]||(o[i.z][i.x][i.y]=r)});this.tinTerrainManager.workerDecodedTerrain.postMessage({param:{minGeographicLongitude:this.geographicExtent.minGeographicCoord.longitude,minGeographicLatitude:this.geographicExtent.minGeographicCoord.latitude,maxGeographicLongitude:this.geographicExtent.maxGeographicCoord.longitude,maxGeographicLatitude:this.geographicExtent.maxGeographicCoord.latitude,minHeight:this.minHeight,maxHeight:this.maxHeight,vertexCount:this.vertexCount,uValues:this.uValues,vValues:this.vValues,hValues:this.hValues,imageryType:t,depth:this.depth,southIndices:this.southIndices,eastIndices:this.eastIndices,northIndices:this.northIndices,westIndices:this.westIndices,bMakeNormals:!0,indices:this.indices,X:this.X,Y:this.Y},info:{x:this.X,y:this.Y,z:this.depth}}),this.requestDecodeData=!0}},ve.prototype.parseData=function(t){var e=this.tinTerrainManager;this.fileLoadState=c.fileLoadState.PARSE_STARTED,this.tinTerrainManager.workerParseTerrain||(this.tinTerrainManager.workerParseTerrain=new Worker(f.scriptRootPath+"Worker/workerParseTerrain.js"),this.tinTerrainManager.workerParseTerrain.onmessage=function(t){var i=t.data.info,r=t.data.parsedTerrain,o=e.textureParsedTerrainMap;o[i.z]||(o[i.z]={}),o[i.z][i.x]||(o[i.z][i.x]={}),o[i.z][i.x][i.y]||(o[i.z][i.x][i.y]=r)}),this.tinTerrainManager.workerParseTerrain.postMessage({dataArrayBuffer:t,info:{x:this.X,y:this.Y,z:this.depth}})};var ye=function(t,e){if(!(this instanceof ye))throw new Error(ot.CONSTRUCT_ERROR);this.ready=!0,this.maxDepth=17,this.currentVisibles_terrName_geoCoords_map={},this.currentTerrainsMap={},this.visibleTilesArray=[],this.noVisibleTilesArray=[],this.visibleSeaTilesArray=[],this.noVisibleSeaTilesArray=[],this.tinTerrainsQuadTreeAsia,this.tinTerrainsQuadTreeAmerica,this.tinTerrainQuadTreeMercator;var i=f.getPolicy();this.terrainType=wi(i.terrainType,c.magoEarthTerrainType.PLAIN),this.terrainValue=i.terrainValue,this.terrainReady=!1,this.terrainTilesInfo,this.selectable=!0,this.magoManager=t;var r=t.getGl();if(this.texturesMergerFbo=r.createFramebuffer(),this.terrainType!==c.magoEarthTerrainType.PLAIN&&!this.terrainValue)throw new Error("If use elevation model, require terrain value.");if(e&&(void 0!==e.createSea&&(this.bRenderSea=e.createSea),void 0!==e.terrainSelectable&&(this.selectable=e.terrainSelectable),void 0!==e.maxDepth&&(this.maxDepth=e.maxDepth)),this.imageryType=c.imageryType.WEB_MERCATOR,this.imagerys=[],e.layers&&Array.isArray(e.layers))for(var o=0,n=e.layers.length;o<n;o++){var a=e.layers[o];(a instanceof Vt||a instanceof jt)&&this.addImageryLayer(a)}this.textureParsedTerrainMap={},this.textureDecodedTerrainMap={},this.textureIdCntMap={},this.textureIdDeleteMap={},this.bRenderSea=!0,this.renderingFase=0,this.layersStyleId=0,this.objToClampToTerrainStyleId=0,this.objectsToClampToTerrainArray,this.init(),this.makeTinTerrainWithDEMIndex()};ye.INFO_FILE="terrainTiles-info.json",ye.prototype.getImageryLayers=function(){return this.imagerys},ye.prototype.imageryLayersChanged=function(){this.layersStyleId+=1,this.layersStyleId>1e6&&(this.layersStyleId=0)},ye.prototype.objectsClampToTerrainChanged=function(){this.objToClampToTerrainStyleId+=1,this.objToClampToTerrainStyleId>1e6&&(this.objToClampToTerrainStyleId=0)},ye.prototype.addObjectToClampToTerrain=function(t){void 0===this.objectsToClampToTerrainArray&&(this.objectsToClampToTerrainArray=[]),this.objectsToClampToTerrainArray.push(t),this.objectsClampToTerrainChanged()},ye.prototype.removeObjectToClampToTerrain=function(t){this.objectsToClampToTerrainArray=this.objectsToClampToTerrainArray.filter(function(e){return e!==t}),this.imageryLayersChanged()},ye.prototype.prepareObjectToClampToTerrain=function(){var t=this.objectsToClampToTerrainArray;if(t&&t.length>0)for(var e=t.length,i=0;i<e;i++){var r=t[i];if(r instanceof $i)if(void 0===r.texture){r.texture=new At,r.texture.setActiveTextureType(2);var o=r.style;if(o){var n=o.imageUrl;r.texture.url=n;var a=!1;Mt.loadTexture(n,r.texture,this.magoManager,a)}}else r.texture.texId instanceof WebGLTexture||(r.texture.blob?Mt.newWebGlTextureByBlob(gl,r.texture.blob,r.texture):r.texture.url&&Mt.loadTexture(r.texture.url,r.texture,this.magoManager,a))}},ye.prototype.getIntersectedObjectToClampToTerrain=function(t,e){var i=this.objectsToClampToTerrainArray;if(i&&i.length>0)for(var r=i.length,o=0;o<r;o++){var n=i[o];if(n instanceof $i){var a=n.minGeographicCoord,s=n.maxGeographicCoord,l=a.longitude,h=a.latitude,d=s.longitude,c=s.latitude;if(new G(l,h,a.altitude,d,c,s.altitude).intersects2dWithGeoExtent(t)){if(void 0===n.texture){n.texture=new At,n.texture.setActiveTextureType(2);var u=n.style;if(u){var f=u.imageUrl;n.texture.url=f;var g=!1;Mt.loadTexture(f,n.texture,this.magoManager,g)}}else n.texture.texId instanceof WebGLTexture||(n.texture.blob?Mt.newWebGlTextureByBlob(gl,n.texture.blob,n.texture):n.texture.url&&Mt.loadTexture(n.texture.url,n.texture,this.magoManager,g));var p=t.minGeographicCoord.longitude,v=t.minGeographicCoord.latitude,y=t.maxGeographicCoord.longitude-p,m=t.maxGeographicCoord.latitude-v,x=(l-p)/y,b=(h-v)/m,C=(d-p)/y,A=(c-v)/m;n.texture.temp_clampToTerrainTexCoord=new Float32Array([x,b,C,A]),void 0===e&&(e=[]),e.push(n)}}}return e},ye.prototype.getTerrainType=function(){return this.terrainType},ye.prototype.setMaxDepth=function(t){this.maxDepth=t},ye.prototype.init=function(){if(this.imageryType===c.imageryType.WEB_MERCATOR){this.tinTerrainQuadTreeMercator=new ve(void 0);var t=180*(2*Math.atan(Math.pow(Math.E,Math.PI))-Math.PI/2)/Math.PI,e=-180,i=-90,r=0,o=180,n=90,a=0;i=-t,n=t,this.tinTerrainQuadTreeMercator.setGeographicExtent(e,i,r,o,n,a),this.tinTerrainQuadTreeMercator.setWebMercatorExtent(-1,-Math.PI,1,Math.PI),this.tinTerrainQuadTreeMercator.X=0,this.tinTerrainQuadTreeMercator.Y=0,this.tinTerrainQuadTreeMercator.indexName="RU",this.tinTerrainQuadTreeMercator.tinTerrainManager=this}else{this.tinTerrainsQuadTreeAsia=new ve(void 0),this.tinTerrainsQuadTreeAmerica=new ve(void 0);e=0,i=-90,r=0,o=180,n=90,a=0;this.tinTerrainsQuadTreeAsia.setGeographicExtent(e,i,r,o,n,a),this.tinTerrainsQuadTreeAsia.setWebMercatorExtent(0,-Math.PI,1,Math.PI),this.tinTerrainsQuadTreeAsia.X=1,this.tinTerrainsQuadTreeAsia.Y=0,this.tinTerrainsQuadTreeAsia.indexName="RU",this.tinTerrainsQuadTreeAsia.tinTerrainManager=this,e=-180,i=-90,r=0,o=0,n=90,a=0,this.tinTerrainsQuadTreeAmerica.setGeographicExtent(e,i,r,o,n,a),this.tinTerrainsQuadTreeAmerica.setWebMercatorExtent(-1,-Math.PI,0,Math.PI),this.tinTerrainsQuadTreeAmerica.X=0,this.tinTerrainsQuadTreeAmerica.Y=0,this.tinTerrainsQuadTreeAmerica.indexName="LU",this.tinTerrainsQuadTreeAmerica.tinTerrainManager=this}this.makeDistanceLimitByDepth(),this.loadTerrainMeta()},ye.prototype.loadTerrainMeta=function(){var t=this;t.terrainType!==c.magoEarthTerrainType.PLAIN?t.terrainType===c.magoEarthTerrainType.ELEVATION&&t.terrainValue&&!t.terrainReady&&Di(t.terrainValue+ye.INFO_FILE,void 0,void 0,"json").done(function(e){t.terrainTilesInfo=e,t.terrainReady=!0},function(e){console.warn("Invalid or not exist "+ye.INFO_FILE),t.terrainType=c.magoEarthTerrainType.PLAIN,t.terrainReady=!0}):t.terrainReady=!0},ye.prototype.makeTinTerrainWithDEMIndex=function(){this.tinTerrainWithDEMIndex=[],this.tinTerrainWithDEMIndex[0]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[1]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[2]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[3]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[4]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[5]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[6]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[7]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[8]={minX:213,minY:94,maxX:222,maxY:105},this.tinTerrainWithDEMIndex[9]={minX:425,minY:189,maxX:443,maxY:211},this.tinTerrainWithDEMIndex[10]={minX:852,minY:376,maxX:885,maxY:423},this.tinTerrainWithDEMIndex[11]={minX:1705,minY:753,maxX:1770,maxY:844},this.tinTerrainWithDEMIndex[12]={minX:3412,minY:1506,maxX:3539,maxY:1689},this.tinTerrainWithDEMIndex[13]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[14]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[15]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[16]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[17]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[18]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[19]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[20]={minX:-1,minY:-1,maxX:-1,maxY:-1}},ye.prototype.makeDistanceLimitByDepth=function(){void 0===this.distLimitByDepth&&(this.distLimitByDepth=[]),this.distLimitByDepth[0]=1e8,this.distLimitByDepth[1]=2e7,this.distLimitByDepth[2]=1e7,this.distLimitByDepth[3]=6e6,this.distLimitByDepth[4]=2e6,this.distLimitByDepth[5]=16e5,this.distLimitByDepth[6]=1e6,this.distLimitByDepth[7]=6e5,this.distLimitByDepth[8]=2e5,this.distLimitByDepth[9]=1e5,this.distLimitByDepth[10]=6e4,this.distLimitByDepth[11]=3e4,this.distLimitByDepth[12]=9e3,this.distLimitByDepth[13]=6e3,this.distLimitByDepth[14]=4e3,this.distLimitByDepth[15]=2e3,this.distLimitByDepth[16]=800,this.distLimitByDepth[17]=400,this.distLimitByDepth[18]=200,this.distLimitByDepth[19]=100,this.distLimitByDepth[20]=50},ye.prototype.getTexCorrection=function(t){return void 0===this.texCorrection&&(this.texCorrection=[],this.texCorrection[0]=.003,this.texCorrection[1]=.003,this.texCorrection[2]=.003,this.texCorrection[3]=.003,this.texCorrection[4]=.003,this.texCorrection[5]=.003,this.texCorrection[6]=.003,this.texCorrection[7]=.003,this.texCorrection[8]=.003,this.texCorrection[9]=.003,this.texCorrection[10]=.003,this.texCorrection[11]=.003,this.texCorrection[12]=.003,this.texCorrection[13]=.003,this.texCorrection[14]=.002,this.texCorrection[15]=.002,this.texCorrection[16]=.002,this.texCorrection[17]=.002,this.texCorrection[18]=.002,this.texCorrection[19]=.002,this.texCorrection[20]=.002,this.texCorrection[21]=.002,this.texCorrection[22]=.002),this.texCorrection[t]},ye.prototype.doFrustumCulling=function(t,e,i,r){if(void 0===r&&(r=this.maxDepth),!(i.fileRequestControler.tinTerrainFilesRequested>=4||i.fileRequestControler.tinTerrainTexturesRequested>=2)){var o=e.position;this.visibleTilesArray.length=0,this.noVisibleTilesArray.length=0,this.visibleTilesArrayMap=[],this.imageryType===c.imageryType.WEB_MERCATOR?this.tinTerrainQuadTreeMercator.getFrustumIntersectedTinTerrainsQuadTree(t,r,o,i,this.visibleTilesArrayMap,this.noVisibleTilesArray):(this.tinTerrainsQuadTreeAsia.getFrustumIntersectedTinTerrainsQuadTree(t,r,o,i,this.visibleTilesArrayMap,this.noVisibleTilesArray),this.tinTerrainsQuadTreeAmerica.getFrustumIntersectedTinTerrainsQuadTree(t,r,o,i,this.visibleTilesArrayMap,this.noVisibleTilesArray));for(var n=this.maxDepth;n>=0;n--){var a=this.visibleTilesArrayMap[n];a&&a.length>0&&[].push.apply(this.visibleTilesArray,a)}}},ye.prototype.prepareVisibleTinTerrains=function(t){for(var e,i=0;i<=this.maxDepth&&!(t.fileRequestControler.tinTerrainFilesRequested>=4||t.fileRequestControler.tinTerrainTexturesRequested>=2);i++){var r=this.visibleTilesArrayMap[i];if(r&&r.length>0){var o=r.length;if(this.terrainType===c.magoEarthTerrainType.PLAIN)for(var n=0;n<o;n++)(e=r[n]).prepareTinTerrainPlain(t,this);else if(this.terrainType===c.magoEarthTerrainType.ELEVATION){var a=0;for(n=0;n<o;n++)(e=r[n]).prepareTinTerrain(t,this)||(a+=1)}else if(this.terrainType===c.magoEarthTerrainType.REALTIME)for(a=0,n=0;n<o&&((e=r[n]).prepareTinTerrainRealTimeElevation(t,this)||(a+=1),!(a>5));n++);var s=0;for(this.noVisibleTilesArray.length,n=0;n<o&&(void 0!==(e=this.noVisibleTilesArray[n])&&e.depth>2&&(e.deleteTinTerrain(t),s++),!(s>50));n++);}}},ye.prototype.getAltitudes=function(t,e){for(var i=t.length,r=0;r<i;r++)t[r]},ye.prototype.render=function(t,e,i,r){var o,n=t.sceneState.gl;(o=r||t.postFxShadersManager.getShader("tinTerrain")).resetLastBuffersBinded(),t.postFxShadersManager.useProgram(o),o.enableVertexAttribArray(o.position3_loc),e?o.disableVertexAttribArray(o.texCoord2_loc):o.enableVertexAttribArray(o.texCoord2_loc),o.bindUniformGenerals(),n.uniform1i(o.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),t.test__makingTerrainByAltitudesImage=0;for(var a=0;a<8;a++)n.activeTexture(n.TEXTURE0+a),n.bindTexture(n.TEXTURE_2D,null);if(void 0===this.identityMat&&(this.identityMat=new rt),n.uniform1i(o.bIsMakingDepth_loc,e),n.uniform1i(o.uRenderType_loc,1),1===i){var s=t.texturesStore.getTextureAux1x1();n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,s.texId);var l=t.texturesStore.getTextureAux1x1(),h=t.texturesStore.getNoiseTexture4x4();n.uniform1i(o.colorType_loc,2),n.uniform4fv(o.oneColor4_loc,[.5,.5,.5,1]),n.uniform1i(o.refMatrixType_loc,0),n.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,this.identityMat._floatArrays),n.uniform1i(o.bApplySpecularLighting_loc,!0),n.uniform1i(o.bApplyCaustics_loc,!1),n.uniform1i(o.bExistAltitudes_loc,!1);var d=!1;void 0!==t.sceneState.sunSystem&&t.sceneState.applySunShadows&&(d=!0),n.uniform1i(o.bApplyShadow_loc,d);if(d){var c=t.sceneState.sunSystem,u=c.getLightsMatrixFloat32Array(),f=c.getLightsPosLOWFloat32Array(),g=c.getLightsPosHIGHFloat32Array(),p=c.getSunDirWC();if(void 0!==(v=c.getLight(0)).tMatrix&&(n.uniformMatrix4fv(o.sunMatrix_loc,!1,u),n.uniform3fv(o.sunPosHigh_loc,g),n.uniform3fv(o.sunPosLow_loc,f),n.uniform1f(o.shadowMapWidth_loc,v.targetTextureWidth),n.uniform1f(o.shadowMapHeight_loc,v.targetTextureHeight),n.uniform3fv(o.sunDirWC_loc,p),n.uniform1i(o.sunIdx_loc,1)),n.activeTexture(n.TEXTURE0),d&&v.depthFbo){var v=c.getLight(0);n.bindTexture(n.TEXTURE_2D,v.depthFbo.colorBuffer)}else n.bindTexture(n.TEXTURE_2D,l);if(n.activeTexture(n.TEXTURE1),d&&v.depthFbo){v=c.getLight(1);n.bindTexture(n.TEXTURE_2D,v.depthFbo.colorBuffer)}else n.bindTexture(n.TEXTURE_2D,l)}n.uniform1i(o.bApplySsao_loc,!0),n.uniform1f(o.aspectRatio_loc,t.sceneState.camera.frustum.aspectRatio),n.uniform1f(o.screenWidth_loc,t.sceneState.drawingBufferWidth);h=t.texturesStore.getNoiseTexture4x4();n.uniform2fv(o.noiseScale2_loc,[t.depthFboNeo.width/h.width,t.depthFboNeo.height/h.height]),n.uniform3fv(o.kernel16_loc,t.sceneState.ssaoKernel16),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,t.depthFboNeo.colorBuffer),n.activeTexture(n.TEXTURE3),n.bindTexture(n.TEXTURE_2D,h);var y=!0;t.isCesiumGlobe()&&(y=!1),n.uniform1i(o.textureFlipYAxis_loc,y),n.uniform1f(o.externalAlpha_loc,1),n.activeTexture(n.TEXTURE2)}else 2===i&&(n.uniform1i(o.bApplySpecularLighting_loc,!1),n.uniform1i(o.uRenderType_loc,2));var m,x=t.sceneState,b=(d=x.applySunShadows,this.visibleTilesArray.length),C=x.sunSystem.getLight(0),A=(C.maxDistToCam,C.bSphere);void 0===A&&(d=!1);var T=[];if(n.depthRange(0,1),d){var M=A.getRadius(),P=A.getCenterPoint();for(a=0;a<b;a++)if(void 0!==(m=this.visibleTilesArray[a])){var w=m.sphereExtent;P.distToPoint(w.centerPoint)+w.r<5*M?n.uniform1i(o.sunIdx_loc,0):n.uniform1i(o.sunIdx_loc,1),m.render(o,t,e,i,T)}}else for(a=0;a<b;a++)void 0!==(m=this.visibleTilesArray[a])&&m.render(o,t,e,i,T);n.depthRange(0,1),n.depthFunc(n.LEQUAL),o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.position3_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc),n.useProgram(null),this.renderingFase+=1,this.renderingFase>1e6&&(this.renderingFase=0)},ye.prototype.addImageryLayer=function(t){var e=this;t.on(Tt.EVENT_TYPE.CHANGEOPACITY,function(t){e.imageryLayersChanged()}),t.on(Tt.EVENT_TYPE.CHANGESHOW,function(t){e.imageryLayersChanged()}),this.imagerys.push(t),this.imageryLayersChanged()},ye.prototype.addTextureId=function(t){this.textureIdCntMap[t]||(this.textureIdCntMap[t]=0),this.textureIdCntMap[t]+=1},ye.prototype.addDeleteTextureId=function(t){this.textureIdDeleteMap[t]||(this.textureIdDeleteMap[t]=0),this.textureIdDeleteMap[t]+=1},ye.prototype.eraseTexture=function(t,e){var i=e.sceneState.gl,r=t.imagery._id;t.deleteObjects(i),this.addDeleteTextureId(r),this.clearMap(r),this.imageryLayersChanged()},ye.prototype.clearMap=function(t){this.textureIdDeleteMap[t]===this.textureIdCntMap[t]&&(delete this.textureIdDeleteMap[t],delete this.textureIdCntMap[t]),this.imageryLayersChanged()};var me=function(t,e){this.handle=t,this.message=e||xe};me.prototype.init=function(t){var e=this.handle;this.handle.use(i18nextXHRBackend).use(i18nextBrowserLanguageDetector).init({debug:!1,detection:{lookupQuerystring:"lang",lookupCookie:"i18nextLang",lookupLocalStorage:"i18nextLang"},fallbackLng:"en",resources:this.message,load:"languageOnly",ns:["common"],defaultNS:"common",keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_"},function(i,r){console.log("detected user language: "+e.language),console.log("loaded languages: "+e.languages.join(", ")),e.changeLanguage(e.languages[0]),t(i,r)})},me.prototype.getHandle=function(){return this.handle},me.prototype.getMessage=function(){return this.message};var xe={en:{common:{welcome:"Welcome",error:{title:"Error",construct:{create:"This object should be created using new."}}}},ko:{common:{welcome:".",error:{title:"",construct:{create:"  new    ."}}}}},be=function(){this.serverInfo={}};be.prototype.setServerInfo=function(t){this.serverInfo=t},be.prototype.getDataUrl=function(){return this.serverInfo.dataUrl},be.prototype.getDataWorkspace=function(){return this.serverInfo.dataWorkspace},be.prototype.getDataRequestUrl=function(){return this.getDataUrl()+"/"+this.getDataWorkspace()},be.prototype.getWmsVersion=function(){return this.serverInfo.wmsVersion};var Ce=function(){if(!(this instanceof Ce))throw new Error(ot.CONSTRUCT_ERROR);this.curNode=void 0,this.curBuilding=void 0,this.curOctree=void 0,this.curObject=void 0},Ae=function(t){if(!(this instanceof Ae))throw new Error(ot.CONSTRUCT_ERROR);this.currentObjectsRendering=new Ce,this.renderNormals=!0,this.renderTexture=!0,this.magoManager=t};Ae.prototype.renderNodes=function(t,e,i,r,o,n,a,s){var l,h=e.length,d=i.sceneState;if(d.applySunShadows&&1===n){var c=d.sunSystem.getLight(0),u=(c.maxDistToCam,c.bSphere);if(void 0===u)return;for(var f=u.getRadius(),g=u.getCenterPoint(),p=0;p<h;p++){var v=(l=e[p]).bboxAbsoluteCenterPos;if(void 0===v)t.uniform1i(r.sunIdx_loc,1);else{l.data.bbox.getRadiusAprox();g.distToPoint(v)<f?t.uniform1i(r.sunIdx_loc,0):t.uniform1i(r.sunIdx_loc,1)}l.renderContent(i,r,n,s)}}else for(p=0;p<h;p++)(l=e[p]).renderContent(i,r,n,s)},Ae.prototype.getPointsCountForDistance=function(t,e,i){var r=i.magoPolicy.getPointsCloudSettings();return t<=10?Math.floor(r.MaxPerUnitPointsRenderDistToCam0m*e):t<100?Math.floor(r.MaxPerUnitPointsRenderDistToCam100m*e):t<200?Math.floor(r.MaxPerUnitPointsRenderDistToCam200m*e):t<400?Math.floor(r.MaxPerUnitPointsRenderDistToCam400m*e):t<800?Math.floor(r.MaxPerUnitPointsRenderDistToCam800m*e):t<1600?Math.floor(r.MaxPerUnitPointsRenderDistToCam1600m*e):Math.floor(r.MaxPerUnitPointsRenderDistToCamMoreThan1600m*e)},Ae.prototype.renderPCloud=function(t,e,i,r,o,n){if(0!==e.vbo_vicks_container.vboCacheKeysArray.length){t.frontFace(t.CCW);var a=e.vbo_vicks_container.vboCacheKeysArray[0],s=a.vertexCount;if(0!==s){var l=this.getPointsCountForDistance(n,s,i);if(i.isCameraMoving&&(l=Math.floor(l/5)),!(l<=0))if(0===o){if(!a.bindDataPosition(r,i.vboMemoryManager))return!1;t.drawArrays(t.POINTS,0,l)}else if(1===o){if(!a.bindDataPosition(r,i.vboMemoryManager))return!1;if(!a.bindDataColor(r,i.vboMemoryManager))return!1;t.drawArrays(t.POINTS,0,l),i.sceneState.pointsRenderedCount+=l}}}},Ae.prototype.renderNeoBuildingsPCloud=function(t,e,i,r,o,n){var a,s,l;t.uniform1f(r.fixPointSize_loc,1),t.uniform1i(r.bUseFixPointSize_loc,!1);for(var h=e.length,d=0;d<h;d++){var c=(a=e[d]).data.attributes;if((!c||void 0===c.isVisible||!1!==c.isVisible)&&(s=a.getRoot().data.geoLocDataManager,void 0!==(l=a.data.neoBuilding)&&void 0!==l.octree)){var u=l.metaData.projectDataType,f=s.getCurrentGeoLocationData();if(t.uniformMatrix4fv(r.buildingRotMatrix_loc,!1,f.rotMatrix._floatArrays),t.uniform3fv(r.buildingPosHIGH_loc,f.positionHIGH),t.uniform3fv(r.buildingPosLOW_loc,f.positionLOW),void 0!==u&&5===u){void 0===i.myCameraRelative&&(i.myCameraRelative=new A);var g=i.myCameraRelative;g.frustum.copyParametersFrom(i.myCameraSCX.bigFrustum),(g=f.getTransformedRelativeCamera(i.sceneState.camera,g)).calculateFrustumsPlanes();n=n;l.octree.test__renderPCloud(i,l,n,r,g,!0)}}}r.disableVertexAttribArrayAll()},Ae.prototype.enableStencilBuffer=function(t){t.enable(t.STENCIL_TEST),t.stencilFunc(t.ALWAYS,1,1),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.enable(t.POLYGON_OFFSET_FILL)},Ae.prototype.disableStencilBuffer=function(t){t.disable(t.STENCIL_TEST),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.disable(t.POLYGON_OFFSET_FILL)},Ae.prototype.renderObject=function(t,e,i,r,o,n){var a=e.getVboKeysContainer();if(void 0!==a&&0!==a.vboCacheKeysArray.length){void 0===n&&(n=!1);for(var s=a.getVbosCount(),l=0;l<s;l++){var h=a.vboCacheKeysArray[l],d=h.vertexCount;if(0===d)return;if(!h.bindDataPosition(r,i.vboMemoryManager))return!1;if(1===o){if(!h.bindDataNormal(r,i.vboMemoryManager))return!1;if(!h.bindDataColor(r,i.vboMemoryManager))return!1}if(!1===n)if(h.indicesCount>0){if(!h.bindDataIndice(r,i.vboMemoryManager))return!1;t.drawElements(t.TRIANGLES,h.indicesCount,t.UNSIGNED_SHORT,0)}else t.drawArrays(t.TRIANGLES,0,d);else t.drawArrays(t.LINE_STRIP,0,d)}}},Ae.prototype.renderGeometryDepth=function(t,e,i){var r=this.magoManager;e=0;if(r.currentProcess=c.magoCurrentProcess.DepthRendering,void 0!==r.tinTerrainManager){r.tinTerrainManager.render(r,!0,e),t.useProgram(null)}if(void 0!==r.modeler){(C=r.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),C.program,C.useProgram(),r.effectsManager.setCurrentShader(C),C.disableVertexAttribArrayAll(),C.enableVertexAttribArray(C.position3_loc),t.uniform1i(C.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),C.bindUniformGenerals(),t.uniform3fv(C.scaleLC_loc,[1,1,1]),t.uniform1i(C.bApplySsao_loc,!1);var o=0,n=0,a=0;r.modeler.render(r,C,e),C.disableVertexAttribArrayAll(),t.useProgram(null)}if(i.hasRenderables()){if((C=r.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),C.program,C.useProgram(),C.disableVertexAttribArrayAll(),C.enableVertexAttribArray(C.position3_loc),C.bindUniformGenerals(),t.uniform3fv(C.scaleLC_loc,[1,1,1]),void 0!==r.modeler.clippingBox){var s=r.modeler.clippingBox.getPlanesRelToEyevec4Array(r),l=new Float32Array(s);t.uniform1i(C.bApplyClippingPlanes_loc,!0),t.uniform1i(C.clippingPlanesCount_loc,6),t.uniform4fv(C.clippingPlanes_loc,l)}else t.uniform1i(C.bApplyClippingPlanes_loc,!1);o=0;this.renderExcavationObjects(t,C,e,i),r.renderer.renderNodes(t,i.currentVisibles0,r,C,!1,e,0,0,o),r.renderer.renderNodes(t,i.currentVisibles2,r,C,!1,e,0,0,o),r.renderer.renderNodes(t,i.currentVisibles3,r,C,!1,e,0,0,o);this.renderNativeObjects(t,C,e,i,!1),C.disableVertexAttribArray(C.position3_loc),t.useProgram(null)}if(r.visibleObjControlerNodes.currentVisiblesAux.length>0){(C=r.postFxShadersManager.getShader("pointsCloudDepth")).useProgram(),C.resetLastBuffersBinded(),C.disableVertexAttribArrayAll(),C.enableVertexAttribArray(C.position3_loc),C.bindUniformGenerals();var h=r.magoPolicy.getPointsCloudSettings();t.uniform1f(C.maxPointSize_loc,h.maxPointSize),t.uniform1f(C.minPointSize_loc,h.minPointSize),t.uniform1f(C.pendentPointSize_loc,h.pendentPointSize),void 0===r.visibleObjControlerPCloudOctrees&&(r.visibleObjControlerPCloudOctrees=new Bt),r.visibleObjControlerPCloudOctrees.clear(),r.renderer.renderNeoBuildingsPCloud(t,r.visibleObjControlerNodes.currentVisiblesAux,r,C,!1,e),C.disableVertexAttribArrayAll(),t.useProgram(null);var d=r.visibleObjControlerPCloudOctrees.currentVisibles0,u=d.length,f=0;if(!r.isCameraMoving&&!r.mouseLeftDown&&!r.mouseMiddleDown)for(var g=0;g<u;g++){if(d[g].preparePCloudData(r)&&f++,f>1)break}}r.weatherStation&&r.weatherStation.test_renderCuttingPlanes(r,e);var p=r.selectionManager.getSelectionCandidatesFamily("general");if(p){var v=p.currentSelected;v&&v instanceof Ui&&r.test_renderDepth_objectSelected(v)}if(r.nodeSelected&&r.magoPolicy.getObjectMoveMode()===c.moveMode.ALL&&r.buildingSelected&&void 0!==(y=r.nodeSelected)){if(r.currentProcess=c.magoCurrentProcess.SilhouetteDepthRendering,(b=r.getSilhouetteDepthFbo()).bind(),r.isFarestFrustum()&&(t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)),r.swapRenderingFase(),(C=r.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),C.useProgram(),C.disableVertexAttribArrayAll(),C.enableVertexAttribArray(C.position3_loc),C.bindUniformGenerals(),t.uniform3fv(C.scaleLC_loc,[1,1,1]),void 0!==r.modeler.clippingBox){s=r.modeler.clippingBox.getPlanesRelToEyevec4Array(r),l=new Float32Array(s);t.uniform1i(C.bApplyClippingPlanes_loc,!0),t.uniform1i(C.clippingPlanesCount_loc,6),t.uniform4fv(C.clippingPlanes_loc,l)}else t.uniform1i(C.bApplyClippingPlanes_loc,!1);e=0,a=0;y.renderContent(r,C,e,a),b.unbind(),r.swapRenderingFase()}if(r.magoPolicy.getObjectMoveMode()===c.moveMode.OBJECT&&r.objectSelected){var y=r.nodeSelected,m=r.buildingSelected;if(r.objectSelected instanceof ne&&void 0!==y&&void 0!==m){r.currentProcess=c.magoCurrentProcess.SilhouetteDepthRendering;var x=y.getNodeGeoLocDataManager().getCurrentGeoLocationData();r.octreeSelected.neoReferencesMotherAndIndices,t.POINTS;t.TRIANGLES;var b,C;a=0;r.currentProcess=c.magoCurrentProcess.StencilSilhouetteRendering,(b=r.getSilhouetteDepthFbo()).bind(),r.isFarestFrustum()&&(t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)),(C=r.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),C.useProgram(),C.disableVertexAttribArrayAll(),C.enableVertexAttribArray(C.position3_loc),C.bindUniformGenerals(),t.uniform3fv(C.scaleLC_loc,[1,1,1]),x.bindGeoLocationUniforms(t,C),t.TRIANGLES;n=0;t.disable(t.CULL_FACE),r.objectSelected.render(r,m,0,!1,C,a,n),b.unbind(),t.enable(t.CULL_FACE)}}},Ae.prototype.renderDepthSunPointOfView=function(t,e,i,r){if(void 0!==i.tMatrix){var o=this.magoManager;o.currentProcess=c.magoCurrentProcess.DepthShadowRendering;var n=o.postFxShadersManager.getShader("orthogonalDepth");n.resetLastBuffersBinded(),n.useProgram(),o.effectsManager.setCurrentShader(n),n.disableVertexAttribArrayAll(),n.enableVertexAttribArray(n.position3_loc),n.bindUniformGenerals(),t.uniformMatrix4fv(n.modelViewProjectionMatrixRelToEye_loc,!1,i.tMatrix._floatArrays),t.uniform3fv(n.encodedCameraPositionMCHigh_loc,i.positionHIGH),t.uniform3fv(n.encodedCameraPositionMCLow_loc,i.positionLOW),t.uniform3fv(n.scaleLC_loc,[1,1,1]),t.uniform1i(n.bApplySsao_loc,!1),t.disable(t.CULL_FACE);if(o.renderer.renderNodes(t,e.currentVisibles0,o,n,!1,0,0,0,0),o.renderer.renderNodes(t,e.currentVisibles2,o,n,!1,0,0,0,0),o.renderer.renderNodes(t,e.currentVisibles3,o,n,!1,0,0,0,0),this.renderNativeObjects(t,n,0,e),void 0!==o.tinTerrainManager);t.enable(t.CULL_FACE),n.disableVertexAttribArrayAll(),t.useProgram(null)}},Ae.prototype.renderImageViewRectangle=function(t,e,i){if(void 0===e.imageViewerRectangle){e.imageViewerRectangle=new Ve(100,100),e.imageViewerRectangle.geoLocDataManager=new H;var r=e.imageViewerRectangle.geoLocDataManager.newGeoLocationData("noName");r=Ei.calculateGeoLocationData(126.61673801297405,37.580105647225956,50,void 0,void 0,void 0,r,e)}if(void 0!==i){var o=e.postFxShadersManager.getShader("imageViewerRectangle");o.useProgram();t.uniform1i(o.refMatrixType_loc,0),t.enableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals(),t.uniform1f(o.externalAlpha_loc,1),t.uniform1i(o.colorType_loc,2),t.uniform4fv(o.oneColor4_loc,[.1,.8,.99,1]),t.uniform3fv(o.buildingPosHIGH_loc,[0,0,0]),t.uniform3fv(o.buildingPosLOW_loc,[0,0,0]),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.depthFboNeo.colorBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,i.colorBuffer),o.last_tex_id=i.colorBuffer,e.imageViewerRectangle.render(e,o),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,null),o.disableVertexAttribArrayAll(),t.useProgram(null)}},Ae.prototype.renderAtmosphere=function(t,e){var i=this.magoManager;void 0===i.sky&&(i.sky=new Lr);var r=i.postFxShadersManager.getShader("atmosphere");r.useProgram();t.uniform1i(r.bApplySsao_loc,!1),t.uniform1i(r.bApplySpecularLighting_loc,!1),t.disableVertexAttribArray(r.texCoord2_loc),t.enableVertexAttribArray(r.position3_loc),r.bindUniformGenerals(),t.uniform1f(r.externalAlpha_loc,1),t.uniform1i(r.colorType_loc,0),t.uniform4fv(r.oneColor4_loc,[.1,.8,.99,1]),t.uniform3fv(r.buildingPosHIGH_loc,[0,0,0]),t.uniform3fv(r.buildingPosLOW_loc,[0,0,0]);i.sky.render(i,r,1,void 0),r.disableVertexAttribArrayAll(),t.useProgram(null),void 0!==i.sunDepthFbo&&this.renderImageViewRectangle(t,i,i.sunDepthFbo)},Ae.prototype.renderNativeObjects=function(t,e,i,r,o){var n=this.magoManager;void 0===o&&(o=!0);for(var a=r.currentVisibleNativeObjects.opaquesArray,s=a.length,l=0;l<s;l++)a[l].render(n,e,i,void 0);if(o){var h=r.currentVisibleNativeObjects.transparentsArray;s=h.length;for(l=0;l<s;l++)h[l].render(n,e,i,void 0)}if(1===i){var d=r.currentVisibleNativeObjects.vectorTypeArray,c=d.length;if(c>0){var u=n.sceneState,f=n.postFxShadersManager.getShader("thickLine");f.useProgram(),f.bindUniformGenerals(),t.uniform4fv(f.oneColor4_loc,[.3,.9,.5,1]),t.uniform1i(f.colorType_loc,0),t.uniform2fv(f.viewport_loc,[u.drawingBufferWidth,u.drawingBufferHeight]),t.uniform1f(f.thickness_loc,5);for(l=0;l<c;l++)d[l].render(n,f,i,void 0);e.useProgram()}var g=r.currentVisibleNativeObjects.pointTypeArray;if(g){var p=g.length;if(p>0){var v=n.postFxShadersManager.getShader("pointsCloud");v.useProgram(),v.disableVertexAttribArrayAll(),v.resetLastBuffersBinded(),v.enableVertexAttribArray(v.position3_loc),v.bindUniformGenerals(),t.uniform1i(v.bPositionCompressed_loc,!1),t.uniform1i(v.bUse1Color_loc,!0),t.uniform4fv(v.oneColor4_loc,[1,1,.1,1]),t.uniform1f(v.fixPointSize_loc,10),t.uniform1i(v.bUseFixPointSize_loc,1);var y=!0;void 0===y&&(y=!0),y?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST);for(l=0;l<p;l++)g[l].renderPoint(n,v,t,i);e.useProgram()}}}},Ae.prototype.renderExcavationObjects=function(t,e,i,r){for(var o=this.magoManager,n=r.currentVisibleNativeObjects.excavationsArray,a=n.length,s=0;s<a;s++)n[s].render(o,e,i,void 0)},Ae.prototype.renderSilhouette=function(){var t,e=(t=this.magoManager).getGl(),i=(t=this.magoManager).sceneState,r=t.postFxShadersManager.getShader("screenQuad");r.useProgram(),r.bindUniformGenerals();var o=i.getProjectionMatrixInv();e.uniformMatrix4fv(r.projectionMatrixInv_loc,!1,o._floatArrays);var n=i.getModelViewRelToEyeMatrixInv();e.uniformMatrix4fv(r.modelViewMatrixRelToEyeInv_loc,!1,n._floatArrays);e.uniform1i(r.bApplyShadow_loc,!1),e.uniform1i(r.bSilhouette_loc,!0);i.sunSystem.getLight(0);var a=t.texturesStore.getTextureAux1x1(),s=t.getSilhouetteDepthFbo();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,s.colorBuffer),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,a),e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,a),r.last_tex_id=a,e.disable(e.POLYGON_OFFSET_FILL),e.colorMask(!0,!0,!0,!0),e.depthMask(!1),e.depthRange(0,.01),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),void 0===this.screenQuad&&(this.screenQuad=new Pr(t.vboMemoryManager)),this.screenQuad.render(t,r),e.colorMask(!0,!0,!0,!0),e.depthMask(!0),e.disable(e.BLEND),e.depthRange(0,1)},Ae.prototype.renderTerrainShadow=function(t){var e,i=this.magoManager,r=i.sceneState;void 0===i.czm_globeDepthText&&(i.czm_globeDepthText=i.scene._context._us.globeDepthTexture._texture);var o=!1;if(void 0!==r.sunSystem&&r.applySunShadows&&(o=!0),o&&i.czm_globeDepthText){(e=i.postFxShadersManager.getShader("screenQuad")).useProgram(),e.bindUniformGenerals();var n=r.getProjectionMatrixInv();t.uniformMatrix4fv(e.projectionMatrixInv_loc,!1,n._floatArrays);var a=r.getModelViewRelToEyeMatrixInv();t.uniformMatrix4fv(e.modelViewMatrixRelToEyeInv_loc,!1,a._floatArrays);t.uniform1i(e.bApplyShadow_loc,o),t.uniform1i(e.bSilhouette_loc,!1);var s=(f=r.sunSystem).getLight(0),l=i.texturesStore.getTextureAux1x1();if(o){var h=f.getLightsMatrixFloat32Array(),d=f.getLightsPosLOWFloat32Array(),c=f.getLightsPosHIGHFloat32Array(),u=f.getSunDirWC();void 0!==s.tMatrix&&(t.uniformMatrix4fv(e.sunMatrix_loc,!1,h),t.uniform3fv(e.sunPosHigh_loc,c),t.uniform3fv(e.sunPosLow_loc,d),t.uniform1f(e.shadowMapWidth_loc,s.targetTextureWidth),t.uniform1f(e.shadowMapHeight_loc,s.targetTextureHeight),t.uniform3fv(e.sunDirWC_loc,u),t.uniform1i(e.sunIdx_loc,1))}if(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,i.czm_globeDepthText),t.activeTexture(t.TEXTURE3),o&&s.depthFbo){s=(f=r.sunSystem).getLight(0);t.bindTexture(t.TEXTURE_2D,s.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,l);if(t.activeTexture(t.TEXTURE4),o&&s.depthFbo){var f;s=(f=r.sunSystem).getLight(1);t.bindTexture(t.TEXTURE_2D,s.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,l);e.last_tex_id=l,t.disable(t.POLYGON_OFFSET_FILL),t.colorMask(!0,!0,!0,!0),t.depthMask(!1),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),void 0===this.screenQuad&&(this.screenQuad=new Pr(i.vboMemoryManager)),this.screenQuad.render(i,e),t.colorMask(!0,!0,!0,!0),t.depthMask(!0),t.disable(t.BLEND),t.depthRange(0,1)}},Ae.prototype.renderScreenQuadShadow=function(t,e){var i,r=this.magoManager,o=r.sceneState,n=!1;void 0!==o.sunSystem&&o.applySunShadows&&(n=!0),n=!0,(i=r.postFxShadersManager.getShader("screenQuad")).useProgram(),i.bindUniformGenerals();var a=o.getProjectionMatrixInv();if(a._floatArrays){t.uniformMatrix4fv(i.projectionMatrixInv_loc,!1,a._floatArrays);var s=o.getModelViewRelToEyeMatrixInv();t.uniformMatrix4fv(i.modelViewMatrixRelToEyeInv_loc,!1,s._floatArrays),t.uniform1i(i.bApplyShadow_loc,n);var l=(g=o.sunSystem).getLight(0),h=r.texturesStore.getTextureAux1x1();if(n){var d=g.getLightsMatrixFloat32Array(),c=g.getLightsPosLOWFloat32Array(),u=g.getLightsPosHIGHFloat32Array(),f=g.getSunDirWC();void 0!==l.tMatrix&&(t.uniformMatrix4fv(i.sunMatrix_loc,!1,d),t.uniform3fv(i.sunPosHigh_loc,u),t.uniform3fv(i.sunPosLow_loc,c),t.uniform1f(i.shadowMapWidth_loc,l.targetTextureWidth),t.uniform1f(i.shadowMapHeight_loc,l.targetTextureHeight),t.uniform3fv(i.sunDirWC_loc,f),t.uniform1i(i.sunIdx_loc,1))}if(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e),t.activeTexture(t.TEXTURE3),n&&l.depthFbo){l=(g=o.sunSystem).getLight(0);t.bindTexture(t.TEXTURE_2D,l.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,h);if(t.activeTexture(t.TEXTURE4),n&&l.depthFbo){var g;l=(g=o.sunSystem).getLight(1);t.bindTexture(t.TEXTURE_2D,l.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,h);i.last_tex_id=h,t.disable(t.POLYGON_OFFSET_FILL),t.colorMask(!0,!0,!0,!0),t.depthMask(!1),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),void 0===this.screenQuad&&(this.screenQuad=new Pr(r.vboMemoryManager)),this.screenQuad.render(r,i),t.colorMask(!0,!0,!0,!0),t.depthMask(!0),t.disable(t.BLEND),t.depthRange(0,1)}},Ae.prototype.renderGeometryStencilShadowMeshes__original=function(t,e,i){var r;t.frontFace(t.CCW),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE);var o=this.magoManager;o._settings.getRenderingSettings();t.colorMask(!1,!1,!1,!1),t.depthMask(!1),t.enable(t.CULL_FACE),t.enable(t.STENCIL_TEST),o.isFarestFrustum()&&t.clearStencil(0);var n=o.texturesStore.getTextureAux1x1(),a=o.texturesStore.getNoiseTexture4x4();i.hasRenderables();if(t.enable(t.BLEND),(r=o.postFxShadersManager.getShader("modelRefSsao")).useProgram(),t.uniform1i(r.bApplySsao_loc,!1),t.uniform1i(r.bApplyShadow_loc,!1),t.uniform1i(r.bApplySpecularLighting_loc,!1),void 0!==o.modeler.clippingBox){var s=o.modeler.clippingBox.getPlanesRelToEyevec4Array(o),l=new Float32Array(s);t.uniform1i(r.bApplyClippingPlanes_loc,!0),t.uniform1i(r.clippingPlanesCount_loc,6),t.uniform4fv(r.clippingPlanes_loc,l)}else t.uniform1i(r.bApplyClippingPlanes_loc,!1);t.disableVertexAttribArray(r.texCoord2_loc),t.enableVertexAttribArray(r.position3_loc),t.enableVertexAttribArray(r.normal3_loc),t.disableVertexAttribArray(r.color4_loc),r.bindUniformGenerals(),t.uniform1f(r.externalAlpha_loc,1),t.uniform1i(r.textureFlipYAxis_loc,o.sceneState.textureFlipYAxis),t.uniform1i(r.refMatrixType_loc,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o.depthFboNeo.colorBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,a),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,n),r.last_tex_id=n;t.stencilMask(255),t.cullFace(t.FRONT),t.stencilFunc(t.ALWAYS,0,255),t.stencilOp(t.KEEP,t.INCR,t.KEEP),this.renderNodes(t,i.currentVisibles3,o,r,!1,e,0,0),t.cullFace(t.BACK),t.stencilFunc(t.ALWAYS,0,255),t.stencilOp(t.KEEP,t.DECR,t.KEEP),this.renderNodes(t,i.currentVisibles3,o,r,!1,e,0,0),r.disableVertexAttribArrayAll(),t.useProgram(null),(r=o.postFxShadersManager.getShader("screenQuad")).useProgram(),t.disable(t.POLYGON_OFFSET_FILL),t.colorMask(!0,!0,!0,!0),t.depthMask(!1),t.stencilMask(0),t.stencilFunc(t.EQUAL,1,255),t.stencilOp(t.REPLACE,t.KEEP,t.REPLACE),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),void 0===this.screenQuad&&(this.screenQuad=new Pr(o.vboMemoryManager)),this.screenQuad.render(o,r),t.stencilMask(255),t.colorMask(!0,!0,!0,!0),t.depthMask(!0),t.disable(t.STENCIL_TEST),t.disable(t.BLEND),t.depthRange(0,1)},Ae.prototype.renderScreenRectangle=function(t){if(void 0===this.quadBuffer){var e=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=R.createBuffer(t,e)}var i=this.magoManager,r=i.postFxShadersManager;if(void 0!==r){r.getCurrentShader();var o=r.getShader("texturesMerger");r.useProgram(o);i.texturesStore.getTextureAux1x1();for(var n=0;n<8;n++)t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,null);t.enableVertexAttribArray(o.position2_loc),R.bindAttribute(t,this.quadBuffer,o.position2_loc,2);var a=new Int32Array([0,0,0,0,0,0,0,0]),s=new Float32Array([1,1,1,1,1,1,1,1]),l=i.selectionFbo.colorBuffer;void 0!==l&&(t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,l),a[0]=1,t.uniform1iv(o.uActiveTextures_loc,a),t.uniform1fv(o.externalAlphasArray_loc,s),t.drawArrays(t.TRIANGLES,0,6))}},Ae.prototype.renderGeometry=function(t,e,i){var r;t.frontFace(t.CCW),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE);var o=this.magoManager,n=o._settings.getRenderingSettings();if(0===e){if(t.disable(t.BLEND),o.renderer.renderGeometryDepth(t,e,i),o.magoPolicy.getShowOrigin()&&void 0!==o.nodeSelected){var a=[o.nodeSelected];this.renderAxisNodes(a,e)}var s=o.sceneState;if(s.applySunShadows&&!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown){i.calculateBoundingFrustum(s.camera);for(var l=(m=s.sunSystem).lightSourcesArray.length,h=0;h<l;h++){var d=(x=m.getLight(h)).targetTextureWidth,u=x.targetTextureHeight;void 0===x.depthFbo&&(x.depthFbo=new R(t,d,u)),o.swapRenderingFase(),x.depthFbo.bind(),o.isFarestFrustum()&&(t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)),t.viewport(0,0,d,u),this.renderDepthSunPointOfView(t,i,x,m),x.depthFbo.unbind()}o.depthFboNeo.bind(),t.viewport(0,0,s.drawingBufferWidth[0],s.drawingBufferHeight[0]),t.clearColor(0,0,0,1)}}if(1===e){var f=o.texturesStore.getTextureAux1x1(),g=o.texturesStore.getNoiseTexture4x4();if(o.currentProcess=c.magoCurrentProcess.ColorRendering,t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),void 0!==o.tinTerrainManager){t.enable(t.BLEND),this.renderAtmosphere(t,e);o.tinTerrainManager.render(o,!1,e)}var p=!1,v=!1;o.currentFrustumIdx<2&&(p=!0),void 0!==o.sceneState.sunSystem&&o.sceneState.applySunShadows&&(v=!0),o.checkChangesHistoryMovements(i.currentVisibles0),o.checkChangesHistoryColors(i.currentVisibles0),o.checkChangesHistoryMovements(i.currentVisibles2),o.checkChangesHistoryColors(i.currentVisibles2),o.checkChangesHistoryMovements(i.currentVisibles3),o.checkChangesHistoryColors(i.currentVisibles3);var y=i.hasRenderables();if(y||void 0!==o.modeler){t.enable(t.BLEND),(r=o.postFxShadersManager.getShader("modelRefSsao")).useProgram(),o.effectsManager.setCurrentShader(r),t.uniform1i(r.bUseLogarithmicDepth_loc,o.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(r.bApplySsao_loc,p),t.uniform1i(r.bApplyShadow_loc,v),t.uniform1i(r.bApplySpecularLighting_loc,!0);var m,x=(m=o.sceneState.sunSystem).getLight(0);if(v){var b=m.getLightsMatrixFloat32Array(),C=m.getLightsPosLOWFloat32Array(),A=m.getLightsPosHIGHFloat32Array(),T=m.getSunDirWC();void 0!==x.tMatrix&&(t.uniformMatrix4fv(r.sunMatrix_loc,!1,b),t.uniform3fv(r.sunPosHigh_loc,A),t.uniform3fv(r.sunPosLow_loc,C),t.uniform1f(r.shadowMapWidth_loc,x.targetTextureWidth),t.uniform1f(r.shadowMapHeight_loc,x.targetTextureHeight),t.uniform3fv(r.sunDirWC_loc,T),t.uniform1i(r.sunIdx_loc,1))}if(void 0!==o.modeler.clippingBox){var M=o.modeler.clippingBox.getPlanesRelToEyevec4Array(o),P=new Float32Array(M);t.uniform1i(r.bApplyClippingPlanes_loc,!0),t.uniform1i(r.clippingPlanesCount_loc,6),t.uniform4fv(r.clippingPlanes_loc,P)}else t.uniform1i(r.bApplyClippingPlanes_loc,!1);if(t.enableVertexAttribArray(r.texCoord2_loc),t.enableVertexAttribArray(r.position3_loc),t.enableVertexAttribArray(r.normal3_loc),-1!==r.color4_loc&&t.disableVertexAttribArray(r.color4_loc),r.bindUniformGenerals(),t.uniform1f(r.externalAlpha_loc,1),t.uniform1i(r.textureFlipYAxis_loc,o.sceneState.textureFlipYAxis),t.uniform1i(r.refMatrixType_loc,0),t.uniform3fv(r.scaleLC_loc,[1,1,1]),t.uniform4fv(r.colorMultiplier_loc,[1,1,1,1]),t.uniform3fv(r.aditionalMov_loc,[0,0,0]),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o.depthFboNeo.colorBuffer),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,g),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,f),r.last_tex_id=f,t.activeTexture(t.TEXTURE3),v&&x.depthFbo){x=m.getLight(0);t.bindTexture(t.TEXTURE_2D,x.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,f);if(t.activeTexture(t.TEXTURE4),v&&x.depthFbo){x=m.getLight(1);t.bindTexture(t.TEXTURE_2D,x.depthFbo.colorBuffer)}else t.bindTexture(t.TEXTURE_2D,f);t.enable(t.CULL_FACE);e=1;o.modeler.render(o,r,e),(r=o.postFxShadersManager.getShader("modelRefSsao")).useProgram(),this.renderExcavationObjects(t,r,e,i),this.renderNodes(t,i.currentVisibles0,o,r,!1,e,0,0),t.uniform1i(r.bApplySsao_loc,p),this.renderNodes(t,i.currentVisibles2,o,r,!1,e,0,0),this.renderNodes(t,i.currentVisibles3,o,r,!1,e,0,0),this.renderNativeObjects(t,r,e,i),r.disableVertexAttribArrayAll(),t.useProgram(null)}if(o.nodeSelected&&(o.magoPolicy.getObjectMoveMode()===c.moveMode.OBJECT&&o.objectSelected&&this.renderSilhouette(),o.magoPolicy.getObjectMoveMode()===c.moveMode.ALL&&o.buildingSelected&&void 0!==o.nodeSelected&&this.renderSilhouette(),o.magoPolicy.getShowOrigin())){a=[o.nodeSelected];this.renderAxisNodes(a,e)}if(y&&o.magoPolicy.getShowBoundingBox()){this.renderBoundingBoxesNodes(o.visibleObjControlerNodes.currentVisibles0,void 0,!0),this.renderBoundingBoxesNodes(o.visibleObjControlerNodes.currentVisibles2,void 0,!0),this.renderBoundingBoxesNodes(o.visibleObjControlerNodes.currentVisibles3,void 0,!0),this.renderBoundingBoxesNodes(o.visibleObjControlerNodes.currentVisiblesAux,void 0,!0)}if(o.objMarkerManager.render(o,e),o.visibleObjControlerNodes.currentVisiblesAux.length>0){o.sceneState.camera.setCurrentFrustum(0);var w=o.currentFrustumIdx;o.sceneState.camera.frustum.near[0]=o.sceneState.camera.frustumsArray[w].near[0],o.sceneState.camera.frustum.far[0]=o.sceneState.camera.frustumsArray[w].far[0],(r=n.getApplySsao()?n.getPointsCloudInColorRamp()?o.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):o.postFxShadersManager.getShader("pointsCloudSsao"):n.getPointsCloudInColorRamp()?o.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):o.postFxShadersManager.getShader("pointsCloud")).useProgram(),r.resetLastBuffersBinded(),r.enableVertexAttribArray(r.position3_loc),r.enableVertexAttribArray(r.color4_loc),r.bindUniformGenerals(),t.uniform1f(r.externalAlpha_loc,1);p=!0;t.uniform1i(r.bApplySsao_loc,p),void 0!==o.pointsCloudWhite&&o.pointsCloudWhite?(t.uniform1i(r.bUse1Color_loc,!0),t.uniform4fv(r.oneColor4_loc,[.99,.99,.99,1])):t.uniform1i(r.bUse1Color_loc,!1);var _=o.magoPolicy.getPointsCloudSettings();t.uniform1i(r.bUseColorCodingByHeight_loc,!0),t.uniform1f(r.minHeight_rainbow_loc,_.minHeightRainbow),t.uniform1f(r.maxHeight_rainbow_loc,_.maxHeightRainbow),t.uniform1f(r.maxPointSize_loc,_.maxPointSize),t.uniform1f(r.minPointSize_loc,_.minPointSize),t.uniform1f(r.pendentPointSize_loc,_.pendentPointSize),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o.depthFboNeo.colorBuffer),void 0===o.visibleObjControlerPCloudOctrees&&(o.visibleObjControlerPCloudOctrees=new Bt),o.visibleObjControlerPCloudOctrees.clear(),o.renderer.renderNeoBuildingsPCloud(t,o.visibleObjControlerNodes.currentVisiblesAux,o,r,!1,e),r.disableVertexAttribArrayAll(),t.useProgram(null)}}t.disable(t.BLEND),t.depthRange(0,1)},Ae.prototype.renderAxisNodes=function(t,e){var i=this.magoManager;0===i.axisXYZ.vbo_vicks_container.vboCacheKeysArray.length&&i.axisXYZ.makeMesh(30).getVboTrianglesConvex(i.axisXYZ.vbo_vicks_container,i.vboMemoryManager);var r,o,n=i.getGl();0===e&&(o=i.postFxShadersManager.getShader("modelRefDepth"),n.disable(n.BLEND)),1===e&&(o=i.postFxShadersManager.getShader("modelRefSsao"),n.enable(n.BLEND));var a=i.texturesStore.getNoiseTexture4x4();o.useProgram(),n.uniform1i(o.bApplySsao_loc,!0),n.uniform1i(o.refMatrixType_loc,0),n.uniform1i(o.colorType_loc,1),o.disableVertexAttribArray(o.texCoord2_loc);o.program;if(o.bindUniformGenerals(),n.enableVertexAttribArray(o.position3_loc),1===e){var s=i.texturesStore.getTextureAux1x1();n.enableVertexAttribArray(o.normal3_loc),n.enableVertexAttribArray(o.color4_loc),n.uniform1i(o.bUse1Color_loc,!1),n.uniform4fv(o.oneColor4_loc,[1,.1,.1,1]),n.uniform1i(o.bUseNormal_loc,!0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,i.depthFboNeo.colorBuffer),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,a),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,s)}for(var l=t.length,h=0;h<l;h++){(r=t[h]).data.neoBuilding,n.uniform3fv(o.scale_loc,[1,1,1]),r.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(n,o),n.uniform3fv(o.aditionalMov_loc,[0,0,0]),i.renderer.renderObject(n,i.axisXYZ,i,o,e)}o.disableVertexAttribArrayAll(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,null),n.disable(n.BLEND)},Ae.prototype.renderBoundingBoxesNodes=function(t,e,i){var r=this.magoManager,o=r.getGl();if(void 0!==t&&0!==t.length){var n;void 0===r.unitaryBoxSC&&(r.unitaryBoxSC=new Ni,r.unitaryBoxSC.makeAABB(1,1,1),r.unitaryBoxSC.vBOVertexIdxCacheKey=r.unitaryBoxSC.triPolyhedron.getVBOArrayModePosNorCol(r.unitaryBoxSC.vBOVertexIdxCacheKey,r.vboMemoryManager));var a=r.postFxShadersManager.getTriPolyhedronShader(),s=a.program;o.enable(o.BLEND),o.frontFace(o.CCW),o.useProgram(s),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll(),o.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,r.sceneState.modelViewProjRelToEyeMatrix._floatArrays),o.uniformMatrix4fv(a.modelViewMatrix4RelToEye_loc,!1,r.sceneState.modelViewRelToEyeMatrix._floatArrays),o.uniformMatrix4fv(a.modelViewMatrix4_loc,!1,r.sceneState.modelViewMatrix._floatArrays),o.uniformMatrix4fv(a.projectionMatrix4_loc,!1,r.sceneState.projectionMatrix._floatArrays),o.uniform3fv(a.cameraPosHIGH_loc,r.sceneState.encodedCamPosHigh),o.uniform3fv(a.cameraPosLOW_loc,r.sceneState.encodedCamPosLow),o.uniform1f(a.near_loc,r.sceneState.camera.frustum.near),o.uniform1f(a.far_loc,r.sceneState.camera.frustum.far),o.uniform1i(a.bApplySsao_loc,!1),o.uniformMatrix4fv(a.normalMatrix4_loc,!1,r.sceneState.normalMatrix4._floatArrays),o.uniform1i(a.hasAditionalMov_loc,!0),o.uniform3fv(a.aditionalMov_loc,[0,0,0]),o.uniform1i(a.bScale_loc,!0);o.uniform1i(a.bUse1Color_loc,!0),e?o.uniform4fv(a.oneColor4_loc,[e.r,e.g,e.b,1]):o.uniform4fv(a.oneColor4_loc,[1,0,1,1]),o.uniform1i(a.depthTex_loc,0),o.uniform1i(a.noiseTex_loc,1),o.uniform1i(a.diffuseTex_loc,2),o.uniform1f(a.fov_loc,r.sceneState.camera.frustum.fovyRad),o.uniform1f(a.aspectRatio_loc,r.sceneState.camera.frustum.aspectRatio),o.uniform1f(a.screenWidth_loc,r.sceneState.drawingBufferWidth),o.uniform1f(a.screenHeight_loc,r.sceneState.drawingBufferHeight);var l,h=r.texturesStore.getNoiseTexture4x4();o.uniform2fv(a.noiseScale2_loc,[r.depthFboNeo.width/h.width,r.depthFboNeo.height/h.height]),o.uniform3fv(a.kernel16_loc,r.sceneState.ssaoKernel16),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,r.depthFboNeo.colorBuffer),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,h);for(var d=t.length,c=0;c<d;c++){a.resetLastBuffersBinded(),(n=t[c]).data.neoBuilding,l=n.getBBox(),o.uniform3fv(a.scale_loc,[l.getXLength(),l.getYLength(),l.getZLength()]),n.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(o,a),r.pointSC=l.getCenterPoint(r.pointSC),o.uniform3fv(a.aditionalMov_loc,[r.pointSC.x,r.pointSC.y,r.pointSC.z]),this.renderObject(o,r.unitaryBoxSC,r,a,1,i)}a.resetLastBuffersBinded(),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll(),o.disable(o.BLEND)}},Ae.prototype.renderFilter=function(){var t=this.magoManager,e=t.getGl();if(void 0===t.screenQuad){t.sceneState;var i=t.myCameraSCX.bigFrustum,r=(t.sceneState.camera.frustum.fovyRad,i.aspectRatio[0]),o=i.tangentOfHalfFovy[0],n=o*r,a=new ur(-n,-o,-1),s=new ur(n,-o,-1),l=new ur(n,o,-1),h=new ur(-n,o,-1),d=new Float32Array([a.x,a.y,a.z,s.x,s.y,s.z,h.x,h.y,h.z,s.x,s.y,s.z,l.x,l.y,l.z,h.x,h.y,h.z]);t.screenQuad=R.createBuffer(e,d)}var c=t.postFxShadersManager.getShader("filterSilhouette");c.useProgram(),e.uniform1i(c.bApplySsao_loc,!0);var u=t.texturesStore.getNoiseTexture4x4();e.enable(e.BLEND),e.disable(e.DEPTH_TEST),e.enableVertexAttribArray(c.position3_loc),c.bindUniformGenerals(),e.uniform1i(c.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,u),e.activeTexture(e.TEXTURE2),e.bindBuffer(e.ARRAY_BUFFER,t.screenQuad),e.vertexAttribPointer(c.position3_loc,3,e.FLOAT,!1,0,0),e.drawArrays(e.TRIANGLES,0,6),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.disable(e.BLEND),e.enable(e.DEPTH_TEST),c.disableVertexAttribArrayAll(),e.useProgram(null)},Ae.prototype.renderGeometryColorCoding=function(t){var e=this.magoManager,i=e.getGl();if(e.currentProcess=c.magoCurrentProcess.ColorCodeRendering,void 0!==e.modeler){(o=e.postFxShadersManager.getShader("modelRefColorCoding")).useProgram(),o.enableVertexAttribArray(o.position3_loc),o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.bindUniformGenerals();var r=0;i.uniform1i(o.refMatrixType_loc,0),e.modeler.render(e,o,2),o.disableVertexAttribArrayAll(),i.useProgram(null)}r=0;var o=e.postFxShadersManager.getShader("modelRefColorCoding");o.useProgram(),o.enableVertexAttribArray(o.position3_loc),o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.bindUniformGenerals(),i.disable(i.CULL_FACE);e.renderer.renderNodes(i,t.currentVisibles0,e,o,!1,2,0,r),e.renderer.renderNodes(i,t.currentVisibles2,e,o,!1,2,0,r),e.renderer.renderNodes(i,t.currentVisibles3,e,o,!1,2,0,r);if(this.renderNativeObjects(i,o,2,t),i.enable(i.CULL_FACE),o.disableVertexAttribArray(o.position3_loc),i.useProgram(null),e.weatherStation&&e.weatherStation.test_renderCuttingPlanes(e,2),e.magoPolicy.objectMoveMode===c.moveMode.GEOGRAPHICPOINTS&&void 0!==e.modeler){var n=e.postFxShadersManager.getShader("modelRefColorCoding");n.useProgram(),n.enableVertexAttribArray(n.position3_loc),n.disableVertexAttribArray(n.texCoord2_loc),n.disableVertexAttribArray(n.normal3_loc),n.bindUniformGenerals(),i.disable(i.CULL_FACE),e.modeler.render(e,n,2)}if(void 0!==e.tinTerrainManager&&e.tinTerrainManager.selectable){e.tinTerrainManager.render(e,!1,2),i.useProgram(null)}e.objMarkerManager.render(e,2)},Ae.prototype.renderMagoGeometries=function(t){var e=this.magoManager;if(void 0===e.nativeProjectsArray){e.nativeProjectsArray=[];var i=new Zi;e.nativeProjectsArray.push(i),(c=i.newParametricMesh()).profile=new xr;var r,o=c.profile;o.TEST__setFigureHole_2(),void 0===c.vboKeyContainer&&(c.vboKeyContainer=new Nt),void 0===c.vboKeyContainerEdges&&(c.vboKeyContainerEdges=new Nt),90,r=new wr;var n=new dr(20,-10),a=new dr(20,10);r.setPoints(n,a),24,c.revolve(o,90,24,r),!0,!0;var s=c.getSurfaceIndependentMesh(void 0,!0,!0);if(s.setColor(.1,.5,.5,1),s.getVbo(c.vboKeyContainer,e.vboMemoryManager),s.getVboEdges(c.vboKeyContainerEdges,e.vboMemoryManager),void 0===i.geoLocDataManager){i.geoLocDataManager=new H;var l=i.geoLocDataManager.newGeoLocationData("deploymentLoc");Ei.calculateGeoLocationData(126.61120237344926,37.577213509597016,50,0,0,0,l,e)}}var h,d=e.sceneState.gl;0===t&&(h=e.postFxShadersManager.getShader("modelRefDepth"),d.disable(d.BLEND)),1===t&&(h=e.postFxShadersManager.getShader("modelRefSsao"),d.enable(d.BLEND)),h.useProgram(),d.uniform1i(h.bApplySsao_loc,!0),d.uniform1i(h.refMatrixType_loc,0),d.uniform1i(h.colorType_loc,1),d.uniform1i(h.bApplySpecularLighting_loc,!0),h.disableVertexAttribArray(h.texCoord2_loc);var c,u;h.program;if(h.bindUniformGenerals(),d.enableVertexAttribArray(h.position3_loc),1===t){var f=e.texturesStore.getTextureAux1x1(),g=e.texturesStore.getNoiseTexture4x4();d.enableVertexAttribArray(h.normal3_loc),d.enableVertexAttribArray(h.color4_loc),d.uniform1i(h.bUse1Color_loc,!1),d.uniform4fv(h.oneColor4_loc,[1,.1,.1,1]),d.uniform1i(h.bUseNormal_loc,!0),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,e.depthFboNeo.colorBuffer),d.activeTexture(d.TEXTURE1),d.bindTexture(d.TEXTURE_2D,g),d.activeTexture(d.TEXTURE2),d.bindTexture(d.TEXTURE_2D,f)}for(var p=e.nativeProjectsArray.length,v=0;v<p;v++){u=(i=e.nativeProjectsArray[v]).geoLocDataManager,d.uniform3fv(h.scale_loc,[1,1,1]),u.getCurrentGeoLocationData().bindGeoLocationUniforms(d,h),d.uniform3fv(h.aditionalMov_loc,[0,0,0]);for(var y=i.getMeshesCount(),m=0;m<y;m++)c=i.getMesh(m),e.renderer.renderObject(d,c,e,h,t,!1)}h&&(-1!==h.texCoord2_loc&&d.disableVertexAttribArray(h.texCoord2_loc),-1!==h.position3_loc&&d.disableVertexAttribArray(h.position3_loc),-1!==h.normal3_loc&&d.disableVertexAttribArray(h.normal3_loc),-1!==h.color4_loc&&d.disableVertexAttribArray(h.color4_loc)),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,null),d.activeTexture(d.TEXTURE1),d.bindTexture(d.TEXTURE_2D,null),d.activeTexture(d.TEXTURE2),d.bindTexture(d.TEXTURE_2D,null),d.disable(d.BLEND)};var Te=function(){if(!(this instanceof Te))throw new Error(ot.CONSTRUCT_ERROR);this._bApplySsao=!0,this._bPointsCloudInColorRamp=!1};Te.prototype.getApplySsao=function(){return this._bApplySsao},Te.prototype.setApplySsao=function(t){this._bApplySsao=t},Te.prototype.getPointsCloudInColorRamp=function(){return this._bPointsCloudInColorRamp},Te.prototype.setPointsCloudInColorRamp=function(t){this._bPointsCloudInColorRamp=t};var Me=function(){if(!(this instanceof Me))throw new Error(ot.CONSTRUCT_ERROR);this.gl,this.modelMatrix=new rt,this.viewMatrix=new rt,this.modelViewProjRelToEyeMatrix=new rt,this.modelViewRelToEyeMatrix=new rt,this.modelViewRelToEyeMatrixInv=new rt,this.modelViewMatrix=new rt,this.modelViewMatrixInv=new rt,this.projectionMatrix=new rt,this.projectionMatrixInv=new rt,this.modelViewProjMatrix=new rt,this.modelViewProjMatrixInv,this.normalMatrix4=new rt,this.identityMatrix4=new rt,this.modelViewMatrixLast=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.projectionMatrixLast=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.projectionMatrixSky=new rt,this.modelViewProjRelToEyeMatrixSky=new rt,this.encodedCamPosHigh=new Float32Array([0,0,0]),this.encodedCamPosLow=new Float32Array([0,0,0]),this.camera=new A,this.camera.id="mainCamera",this.drawingBufferWidth=new Int32Array([1e3]),this.drawingBufferHeight=new Int32Array([1e3]),this.mouseAction=new nt;this.sunLight=new K(2),this.sunSystem=new bt,this.applySunShadows=!1,this.ambientReflectionCoef=new Float32Array([.5]),this.diffuseReflectionCoef=new Float32Array([1]),this.specularReflectionCoef=new Float32Array([.6]),this.specularColor=new Float32Array([.7,.7,.7]),this.ambientColor=new Float32Array([1,1,1]),this.ssaoRadius=new Float32Array([.15]),this.shininessValue=new Float32Array([40]),this.ssaoNoiseScale2=new Float32Array([1,1]),this.ssaoKernel16=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35]),this.ssaoSphereKernel32=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35,.33,0,-.85,.25,.3,-.5,.1,.3,-.85,-.15,.2,-.85,-.33,.05,-.6,-.1,-.15,-.85,-.05,-.32,-.25,.2,-.15,-.85,.6,0,-.55,.5,.6,-.45,-.01,.7,-.35,-.33,.5,-.45,-.45,0,-.55,-.65,-.5,-.7,0,-.5,-.55,.33,.3,-.35]),this.bMust=!1,this.dc,this.insertIssueState=0,this.textureFlipYAxis=!1,this.mouseButton=-1,this.trianglesRenderedCount=0,this.pointsRenderedCount=0,this.fps=0,"cesium"!==f.getPolicy().basicGlobe&&this.initMagoSceneState()};Me.prototype.initMagoSceneState=function(){var t=document.getElementById(f.getContainerId());if(!t)throw new Error("container is empty.");var e=document.createElement("canvas");e.id="_mago3dCanvas",e.style.width="100%",e.style.height="100%",t.appendChild(e);var i={antialias:!0,stencil:!0,premultipliedAlpha:!1},r=e.getContext("webgl",i);r||(r=e.getContext("experimental-webgl",i)),e.width=e.clientWidth,e.height=e.clientHeight,this.canvas=e,this.gl=r,this.setDrawingBufferSize(e.offsetWidth,e.offsetHeight),this.camera.position.set(-7586937.743019165,10881859.054284709,5648264.99911627),this.camera.direction.set(.5307589970384617,-.7598419113077192,-.3754132585133587),this.camera.up.set(.23477224008249162,-.29380469331271475,.9265855321012102),this.encodedCamPosHigh[0]=-7536640,this.encodedCamPosHigh[1]=10878976,this.encodedCamPosHigh[2]=5636096,this.encodedCamPosLow[0]=-50297.7421875,this.encodedCamPosLow[1]=2883.05419921875,this.encodedCamPosLow[2]=12168.9990234375},Me.prototype.resetStadistics=function(){this.trianglesRenderedCount=0,this.pointsRenderedCount=0,this.fps=0},Me.prototype.restoreDefaultValuesAmbientDiffuseSpecularCoeficients=function(){this.ambientReflectionCoef[0]=.7,this.diffuseReflectionCoef[0]=.4,this.specularReflectionCoef[0]=.6},Me.prototype.getModelViewMatrixInv=function(){return this.modelViewMatrixInv.dirty&&(this.modelViewMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewMatrixInv._floatArrays,this.modelViewMatrix._floatArrays),this.modelViewMatrixInv.dirty=!1),this.modelViewMatrixInv},Me.prototype.getProjectionMatrixInv=function(){return void 0===this.projectionMatrixInv&&(this.projectionMatrixInv=new rt,this.projectionMatrixInv._floatArrays=glMatrix.mat4.invert(this.projectionMatrixInv._floatArrays,this.projectionMatrix._floatArrays)),this.projectionMatrixInv},Me.prototype.getModelViewProjectionMatrixInv=function(){return void 0===this.modelViewProjMatrixInv&&(this.modelViewProjMatrixInv=new rt,this.modelViewProjMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewProjMatrixInv._floatArrays,this.modelViewProjMatrix._floatArrays)),this.modelViewProjMatrixInv},Me.prototype.getModelViewRelToEyeMatrixInv=function(){return void 0===this.modelViewRelToEyeMatrixInv&&(this.modelViewRelToEyeMatrixInv=new rt,this.modelViewRelToEyeMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewRelToEyeMatrixInv._floatArrays,this.modelViewRelToEyeMatrix._floatArrays)),this.modelViewRelToEyeMatrixInv},Me.prototype.getCamera=function(){return this.camera},Me.prototype.getScreenCenterPositionPixels=function(t){var e=this.drawingBufferWidth[0],i=this.drawingBufferHeight[0];return void 0===t&&(t=new dr),t.set(Math.floor(e/2),Math.floor(i/2)),t},Me.prototype.setApplySunShadows=function(t){this.applySunShadows=t},Me.prototype.setDrawingBufferSize=function(t,e){if(t!==this.drawingBufferWidth[0]||e!==this.drawingBufferHeight[0]){this.drawingBufferWidth[0]=t,this.drawingBufferHeight[0]=e;var i=this.camera,r=i.getFrustum(0);i.frustum.aspectRatio[0]=t/e;var o=i.frustum.fovRad[0]/i.frustum.aspectRatio[0];i.frustum.fovyRad[0]=o,i.frustum.tangentOfHalfFovy[0]=Math.tan(i.frustum.fovyRad[0]/2),r.aspectRatio[0]=i.frustum.aspectRatio[0],r.fovyRad[0]=i.frustum.fovyRad[0],r.tangentOfHalfFovy[0]=i.frustum.tangentOfHalfFovy[0]}};var Pe=function(){if(!(this instanceof Pe))throw new Error(ot.CONSTRUCT_ERROR);this.drawing_height,this.drawing_width,this.GAIA_selectFrameBuffer,this.GAIA_selectRenderBuffer,this.GAIA_selectRttTexture,this.currentByteColorPicked=new Uint8Array(4),this.currentSelectedObj_idx=-1};Pe.prototype.init=function(t,e,i){this.drawing_height=i,this.drawing_width=e,this.GAIA_selectFrameBuffer=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.GAIA_selectFrameBuffer),this.GAIA_selectRenderBuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.GAIA_selectRenderBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.drawing_width,this.drawing_height),this.GAIA_selectRttTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.GAIA_selectRttTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.drawing_width,this.drawing_height,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.GAIA_selectRttTexture,0),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.GAIA_selectRenderBuffer),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null),t.bindFramebuffer(t.FRAMEBUFFER,null)};var we=function(){if(!(this instanceof we))throw new Error(ot.CONSTRUCT_ERROR);this.familyTypeName,this.candidatesMap={},this.currentSelected};we.prototype.setCandidate=function(t,e){void 0!==t&&e&&(this.candidatesMap[t]=e)},we.prototype.clearCandidate=function(){this.candidatesMap={},this.currentSelected=void 0},we.prototype.clearCurrentSelected=function(){this.currentSelected=void 0},we.prototype.selectObject=function(t){return this.currentSelected=this.candidatesMap[t],this.currentSelected};var _e=function(t){if(!(this instanceof _e))throw new Error(ot.CONSTRUCT_ERROR);this.magoManager=t,this.selCandidatesMap={},this.currentGeneralObjectSelected,this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.currentReferenceSelected,this.currentOctreeSelected,this.currentBuildingSelected,this.currentNodeSelected,this.selCandidatesFamilyMap={},this.parentSelected=!1};_e.prototype.newCandidatesFamily=function(t){var e=new we;return e.familyTypeName=t,this.selCandidatesFamilyMap[t]=e,e},_e.prototype.getSelectionCandidatesFamily=function(t){return this.selCandidatesFamilyMap[t]},_e.prototype.setCandidateCustom=function(t,e,i){var r=this.getSelectionCandidatesFamily(e);r&&r.setCandidate(t,i)},_e.prototype.setCandidateGeneral=function(t,e){this.selCandidatesMap[t]=e},_e.prototype.getCandidateGeneral=function(t){return this.selCandidatesMap[t]},_e.prototype.getSelectedGeneral=function(){return this.currentGeneralObjectSelected},_e.prototype.setSelectedGeneral=function(t){this.currentGeneralObjectSelected=t},_e.prototype.setCandidates=function(t,e,i,r,o){e&&(this.referencesMap[t]=e),i&&(this.octreesMap[t]=i),r&&(this.buildingsMap[t]=r),o&&(this.nodesMap[t]=o)},_e.prototype.clearCandidates=function(){for(var t in this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,t))this.selCandidatesFamilyMap[t].clearCandidate()}this.selCandidatesMap={}},_e.prototype.selectObjects=function(t){for(var e in this.currentReferenceSelected=this.referencesMap[t],this.currentOctreeSelected=this.octreesMap[t],this.currentBuildingSelected=this.buildingsMap[t],this.currentNodeSelected=this.nodesMap[t],this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,e))this.selCandidatesFamilyMap[e].selectObject(t)}this.currentGeneralObjectSelected=this.selCandidatesMap[t]},_e.prototype.isObjectSelected=function(t){return void 0!==t&&(this.currentReferenceSelected===t||(this.currentBuildingSelected===t||(this.currentNodeSelected===t||this.currentGeneralObjectSelected===t)))},_e.prototype.clearCurrents=function(){for(var t in this.currentReferenceSelected=void 0,this.currentOctreeSelected=void 0,this.currentBuildingSelected=void 0,this.currentNodeSelected=void 0,this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,t))this.selCandidatesFamilyMap[t].clearCurrentSelected()}this.currentGeneralObjectSelected=void 0},_e.prototype.TEST__CurrGeneralObjSel=function(){return!!this.currentGeneralObjectSelected};var Se=function(t){this.skeletalAnimObject};Se.prototype.render=function(t){};var Le=function(t,i,r,o){if(e.call(this),this.color4=new _,this.color4.setRGBA(.2,.2,.25,1),this.type="extruded",this.totalLength=10,i&&(this.totalLength=i),this.bodyWidth=1,t&&(this.bodyWidth=.5*t),this.headWidth=1.5,t&&(this.headWidth=t),this.extrude=1,r&&(this.extrude=r),this.tailLength=.7*this.totalLength,o){var n=o.bodyWidth;n&&(this.bodyWidth=n);var a=o.headWidth;a&&(this.headWidth=a);var s=o.headLength;s&&(this.headLength=s);var l=o.totalLength;l&&(this.totalLength=l);var h=o.tailLength;h&&(this.tailLength=h);var d=o.extrude;d&&(this.extrude=d)}this.headWidth<this.bodyWidth&&(this.headWidth=1.5*this.bodyWidth),this.headLength||(this.headLength=.3*this.totalLength)};(Le.prototype=Object.create(e.prototype)).constructor=Le,Le.prototype.makeMesh=function(){var t=new xr,e=t.newOuterRing(),i=.5*this.bodyWidth,r=.5*this.headWidth,o=this.totalLength-this.headLength,n=e.newElement("POLYLINE");this.tailLength?(n.newPoint2d(0,0),n.newPoint2d(i,this.tailLength),n.newPoint2d(i,o),n.newPoint2d(r,o),n.newPoint2d(0,this.totalLength),n.newPoint2d(-r,o),n.newPoint2d(-i,o),n.newPoint2d(-i,this.tailLength)):(n.newPoint2d(-i,0),n.newPoint2d(i,0),n.newPoint2d(i,o),n.newPoint2d(r,o),n.newPoint2d(0,this.totalLength),n.newPoint2d(-r,o),n.newPoint2d(-i,o));var a=or.getExtrudedMesh(t,this.extrude,1,void 0,!1,!1,a);this.mesh=a,this.dirty=!1},Le.prototype.render=function(t,e,i,r){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();if(2===i){t.selectionColor;var n=t.selectionColor.getAvailableColor(void 0),a=t.selectionColor.decodeColor3(n.r,n.g,n.b);t.selectionManager.setCandidateGeneral(a,this),o.uniform4fv(e.oneColor4_loc,[n.r/255,n.g/255,n.b/255,1]),o.disable(o.BLEND)}this.renderRaw(t,e,i,r),o.disable(o.BLEND)}},Le.prototype.renderAsChild=function(t,e,i,r,o){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var n=t.getGl();if(this.tMat&&this.tMat instanceof rt&&n.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays),0===i);else if(1===i){n.enable(n.BLEND),n.uniform1i(e.colorType_loc,0);var a=t.selectionManager;void 0!==o&&o?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):a.isObjectSelected(this)?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(t,e,i,r,o),n.disable(n.BLEND)}},Le.prototype.renderRaw=function(t,e,i,r,o){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var n=t.getGl();if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),0===i);else if(1===i){n.enable(n.BLEND),n.uniform1i(e.colorType_loc,0);var a=t.selectionManager;void 0!==o&&o?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):a.isObjectSelected(this)?n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(t,e,i,r,o),n.disable(n.BLEND)};var Re=function(t,i,r,o){if(!(this instanceof Re))throw new Error(ot.CONSTRUCT_ERROR);e.call(this),this.name,this.width=t,this.length=i,this.height=r,this.bHasGround=!1,this.roofMinHeight,this.geoLocDataManager,this.objectsArray,this.objectsMap,this.bbox,this.dirty=!0,this.roofColor4=new _,this.roofColor4.setRGBA(98/256,233/256,134/256,.3),this.options=o,this.bbox=new y,this.bbox.set(-this.width/2,-this.length/2,0,this.width/2,this.length/2,this.height),this.attributes={isVisible:!0}};Re.prototype=Object.create(e.prototype),Re.prototype.constructor=Re,Re.wallType={FRONT:"front",REAR:"rear",LEFT:"left",RIGHT:"right"},Re.prototype.getBoundingBox=function(){return this.bbox},Re.getFactoryDimensionsByGeoCoordsArray=function(t,e,i){if(!(void 0===t||t.length<4)){var r=t[0],o=t[1],n=t[2],a=t[3];if(0===e)var s=new U(r,o),l=new U(o,n);else if(1===e)s=new U(o,n),l=new U(n,a);else if(2===e)s=new U(n,a),l=new U(a,r);else if(3===e)s=new U(a,r),l=new U(r,o);return{factoryWidth:U.getLengthInMeters(s,i),factoryLength:U.getLengthInMeters(l,i),headingDeg:180*U.calculateHeadingAngRadToNorthOfSegment(l,i)/Math.PI,longitude:(r.longitude+r.longitude+r.longitude+r.longitude)/4,latitude:(r.latitude+r.latitude+r.latitude+r.latitude)/4}}},Re.getTriangularWallProfile2d=function(t,e){if(void 0===t)return e;void 0===e&&(e=new xr);var i=t.hasOpening;void 0===i&&(i=!1);var r=t.width,o=t.height,n=t.roofMinHeight;void 0===n&&(n=.75*o);var a=.5*r;if(i){var s=t.openingHeight;void 0===s&&(s=.6*o);var l=t.openingWidth;void 0===l&&(l=.8*r);var h=.5*l,d=.5*l;(c=e.newOuterRing().newElement("POLYLINE")).newPoint2d(-a,0),c.newPoint2d(-h,0),c.newPoint2d(-h,s),c.newPoint2d(d,s),c.newPoint2d(d,0),c.newPoint2d(a,0),c.newPoint2d(a,n),c.newPoint2d(0,o),c.newPoint2d(-a,n)}else{var c;(c=e.newOuterRing().newElement("POLYLINE")).newPoint2d(-a,0),c.newPoint2d(a,0),c.newPoint2d(a,n),c.newPoint2d(0,o),c.newPoint2d(-a,n)}return e},Re.getLateralWallProfile2d=function(t,e){void 0===e&&(e=new xr);var i=t.height,r=t.length,o=e.newOuterRing().newElement("POLYLINE");o.newPoint2d(0,0);var n=0,a=t.openingsDataArray,s=0;void 0!==a&&(s=a.length);for(var l=0;l<s;l++){var h=t.openingsDataArray[l],d=h.offSet,c=h.height,u=h.width;o.newPoint2d(n+d,0),o.newPoint2d(n+d,c),o.newPoint2d(n+d+u,c),o.newPoint2d(n+d+u,0),n=n+d+u}return o.newPoint2d(r,0),o.newPoint2d(r,i),o.newPoint2d(0,i),e},Re.prototype.getWallProfile2d=function(t,e,i){void 0===i&&(i=new xr);var r=t===Re.wallType.FRONT||t===Re.wallType.REAR,o=r?this.width:this.length,n=this.height,a=this.roofMinHeight,s=i.newOuterRing().newElement("POLYLINE");if(s.newPoint2d(0,0),e&&e.openingInfo)if(Array.isArray(e.openingInfo))for(var l=0,h=e.openingInfo,d=0,c=h.length;d<c;d++){if(Si((p=h[d]).offset)){var u=p.offset,f=p.height,g=p.width;l+=u,p.centerPropterties=this.calculateOpeningProperties(t,l,g,f,p.thickness),s.newPoint2d(l,0),s.newPoint2d(l,f),l+=g,s.newPoint2d(l,f),s.newPoint2d(l,0)}}else{var p,v=Si((p=e.openingInfo).offset)?p.offset:.5*(o-p.width);f=p.height,g=p.width;p.centerPropterties=this.calculateOpeningProperties(t,v,g,f,p.thickness),s.newPoint2d(v,0),s.newPoint2d(v,f),s.newPoint2d(v+g,f),s.newPoint2d(v+g,0)}return s.newPoint2d(o,0),s.newPoint2d(o,a),r&&s.newPoint2d(.5*o,n),s.newPoint2d(0,a),i},Re.prototype.calculateOpeningProperties=function(t,e,i,r){var o=new xr,n=(s=o.newOuterRing()).newElement("POLYLINE");n.newPoint2d(e,0),n.newPoint2d(e+i,0),n.newPoint2d(e+i,r),n.newPoint2d(e,r);var a=new zr;a.makeByProfile2D(o),this.validateWallGeom(t,a);var s,l=(s=a.outerVtxRing).vertexList.getBoundingBox().getCenterPoint(),h=s.calculatePlaneNormal(),d=this.geoLocDataManager.getCurrentGeoLocationData(),c=d.rotMatrix;return{openeingProfile2d:o,centerLC:l,normalLC:h,centerWC:d.localCoordToWorldCoord(l),normalWC:c.transformPoint3D(h)}},Re.prototype.getOpeningProperties=function(t,e){var i,r,o=this.options.wallOptions;if(Si(e)||(e=0),o)for(var n in o)o[n].type===t&&(i=o[n]);return Array.isArray(i.openingInfo)?(i.openingInfo[e].centerPropterties&&(i.openingInfo[e].centerPropterties.wallType=t),r=i.openingInfo[e].centerPropterties):(i.openingInfo.centerPropterties&&(i.openingInfo.centerPropterties.wallType=t),r=i.openingInfo.centerPropterties),r},Re.prototype.makeMesh=function(){if(void 0!==this.width&&void 0!==this.length&&void 0!==this.height){if(void 0===this.objectsArray&&(this.objectsArray=[]),void 0===this.objectsMap&&(this.objectsMap={}),this.bHasGround){var t=this.width,e=this.length,i=.02*this.height,r=new Ee(t,e,i,"ground");r.setOneColor(.2,.3,.3,1),r.owner=this,this.objectsArray.push(r),this.objectsMap[r.name]=r}this.roofMinHeight=wi(this.options.roofMinHeight,.75*this.height);var o=this.options.wallOptions,n=.4;for(var a in Re.wallType)if(Re.wallType.hasOwnProperty(a)){var s,l=Re.wallType[a];if(o){for(var h in o){if(o[h].type===l){n=wi((s=o[h]).thickness,.4);break}s=null}var d=l+"Wall";if(!this.objectsMap[d]){var c=this.getWallProfile2d(l,s,void 0);(p=or.getExtrudedMesh(c,n,1,void 0,!0,!0,void 0)).name=d,this.objectsArray.push(p),this.objectsMap[d]=p,this.validateWallGeom(l,p)}}}var u=.5*this.width,f=this.roofMinHeight,g=new vr;g.newPoint2d(u,f),g.newPoint2d(0,this.height),g.newPoint2d(-u,f);var p,v,m=new vr;m.point2dArray=cr.getExpandedPoints(g.point2dArray,m.point2dArray,0,.2),(c=new xr).newOuterRing().addElement(m),n=this.length,(p=or.getExtrudedMesh(c,n,1,void 0,!0,!0,void 0)).name="roof",p.owner=this,this.objectsArray.push(p),this.objectsMap[p.name]=p,p.rotate(90,1,0,0),p.translate(0,.5*this.length,0),p.setOneColor(98/256,233/256,134/256,.3);var x=this.options.roofOptions;if(void 0!==x&&void 0!==(v=x.material)&&void 0!==v.diffuseTexture){var b=new y,C=this.width;b.set(-C,-60,-20,C,60,20),p.calculateTexCoordsBox(b),p.material=v}this.dirty=!1}},Re.prototype.getObjectByName=function(t){return this.objectsMap[t]},Re.prototype.removeMesh=function(t){this.objectsMap&&this.objectsMap[t]&&(this.objectsMap[t]=void 0),this.objectsArray&&Array.isArray(this.objectsArray)&&(this.objectsArray=this.objectsArray.filter(function(e){return e.name!==t}))},Re.prototype.validateWallGeom=function(t,e,i){if("function"!=typeof e.rotate||"function"!=typeof e.translate)throw new Error("invalid geometry type.");switch(Si(i)||(i=.4),t){case"front":e.rotate(90,1,0,0),e.translate(.5*-this.width,.5*-this.length+i,0);break;case"rear":e.rotate(90,1,0,0),e.translate(.5*-this.width,.5*this.length,0);break;case"left":e.rotate(90,1,0,0),e.rotate(90,0,0,1),e.translate(.5*-this.width,.5*-this.length,0);break;case"right":e.rotate(90,1,0,0),e.rotate(90,0,0,1),e.translate(.5*this.width-i,.5*-this.length,0)}e instanceof rr&&e.setOneColor(.9,.9,.9,1)};var De=function(){};De.degreeValidator=function(t){return t},De.MODE={NORMAL:0,PARALLEL_TRANSLATE:1,PARALLEL_ROTATION:2,CIRCULAR_ROTATION:3},De.ACCEL_STATUS={FORWARD:0,REVERSE:1,NONE:2};var Ee=function(t,i,r,o){if(e.call(this),!(this instanceof Ee))throw new Error(ot.CONSTRUCT_ERROR);this.mesh,this.centerPoint,this.width,this.length,this.height,this.owner,void 0!==o&&(this.name=o),void 0!==t&&(this.width=t),void 0!==i&&(this.length=i),void 0!==r&&(this.height=r)};Ee.prototype=Object.create(e.prototype),Ee.prototype.constructor=Ee,Ee.prototype.getMesh=function(){return void 0===this.mesh&&(this.mesh=this.makeMesh(this.width,this.length,this.height)),this.mesh},Ee.prototype.moved=function(){},Ee.prototype.makeMesh=function(){var t=new xr,e=t.newOuterRing(),i=.5*this.width,r=.5*this.length,o=e.newElement("POLYLINE");o.newPoint2d(-i,-r),o.newPoint2d(i,-r),o.newPoint2d(i,r),o.newPoint2d(-i,r);var n=this.height,a=or.getExtrudedMesh(t,n,1,void 0,!0,!0,void 0);this.objectsArray.push(a),this.dirty=!1};var Ie=function(t,i,r,o){if(e.call(this),!(this instanceof Ie))throw new Error(ot.CONSTRUCT_ERROR);this.centerPoint,this.width,this.length,this.height,void 0!==o&&(this.name=o),void 0!==t&&(this.width=t),void 0!==i&&(this.length=i),void 0!==r&&(this.height=r),this.planesVec4Array};Ie.prototype=Object.create(e.prototype),Ie.prototype.constructor=Ie,Ie.prototype.getPlanesRelToEyevec4Array=function(t){this.planesVec4Array=[];for(var e=this.getPlanesRelToEye(void 0,t),i=e.length,r=0;r<i;r++){var o=e[r];this.planesVec4Array.push(o.a),this.planesVec4Array.push(o.b),this.planesVec4Array.push(o.c),this.planesVec4Array.push(o.d)}return this.planesVec4Array},Ie.prototype.moved=function(){this.planesVec4Array=void 0},Ie.prototype.getPlanesRelToEye=function(t,e){void 0===t&&(t=[]);var i,r=e.sceneState,o=r.modelViewMatrix,n=r.modelViewRelToEyeMatrix,a=(r.camera.position,r.getModelViewMatrixInv(),this.getGeoLocDataManager().getCurrentGeoLocationData()),s=a.rotMatrix,l=new ur,h=new ur,d=new ur,c=new ur,u=new ur,f=new ur;return l.set(0,0,this.height),h.set(0,0,1),d=a.localCoordToWorldCoord(l,d),c=s.transformPoint3D(h,c),u=o.transformPoint3D(d,u),f=n.transformPoint3D(c,f),(i=new ut).setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z),t.push(i),l.set(0,0,0),h.set(0,0,-1),d=a.localCoordToWorldCoord(l,d),c=s.transformPoint3D(h,c),u=o.transformPoint3D(d,u),f=n.transformPoint3D(c,f),(i=new ut).setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z),t.push(i),l.set(0,-this.length/2,this.height/2),h.set(0,-1,0),d=a.localCoordToWorldCoord(l,d),c=s.transformPoint3D(h,c),u=o.transformPoint3D(d,u),f=n.transformPoint3D(c,f),(i=new ut).setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z),t.push(i),l.set(0,this.length/2,this.height/2),h.set(0,1,0),d=a.localCoordToWorldCoord(l,d),c=s.transformPoint3D(h,c),u=o.transformPoint3D(d,u),f=n.transformPoint3D(c,f),(i=new ut).setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z),t.push(i),l.set(-this.width/2,0,this.height/2),h.set(-1,0,0),d=a.localCoordToWorldCoord(l,d),c=s.transformPoint3D(h,c),u=o.transformPoint3D(d,u),f=n.transformPoint3D(c,f),(i=new ut).setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z),t.push(i),l.set(this.width/2,0,this.height/2),h.set(1,0,0),d=a.localCoordToWorldCoord(l,d),c=s.transformPoint3D(h,c),u=o.transformPoint3D(d,u),f=n.transformPoint3D(c,f),(i=new ut).setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z),t.push(i),t},Ie.prototype.getPlanes=function(t,e){void 0===t&&(t=[]);var i,r=e.sceneState,o=(r.modelViewMatrix,r.modelViewRelToEyeMatrix,r.camera.position,r.modelViewMatrixInv,this.getGeoLocDataManager().getCurrentGeoLocationData().rotMatrix),n=new ur,a=new ur,s=new ur,l=new ur;new ur,new ur;return n.set(0,0,this.height),a.set(0,0,1),s=o.transformPoint3D(n,s),l=o.transformPoint3D(a,l),(i=new ut).setPointAndNormal(s.x,s.y,s.z,l.x,l.y,l.z),t.push(i),n.set(0,0,0),a.set(0,0,-1),s=o.transformPoint3D(n,s),l=o.transformPoint3D(a,l),(i=new ut).setPointAndNormal(s.x,s.y,s.z,l.x,l.y,l.z),t.push(i),n.set(0,-this.length/2,this.height/2),a.set(0,-1,0),s=o.transformPoint3D(n,s),l=o.transformPoint3D(a,l),(i=new ut).setPointAndNormal(s.x,s.y,s.z,l.x,l.y,l.z),t.push(i),n.set(0,this.length/2,this.height/2),a.set(0,1,0),s=o.transformPoint3D(n,s),l=o.transformPoint3D(a,l),(i=new ut).setPointAndNormal(s.x,s.y,s.z,l.x,l.y,l.z),t.push(i),n.set(-this.width/2,0,this.height/2),a.set(-1,0,0),s=o.transformPoint3D(n,s),l=o.transformPoint3D(a,l),(i=new ut).setPointAndNormal(s.x,s.y,s.z,l.x,l.y,l.z),t.push(i),n.set(this.width/2,0,this.height/2),a.set(1,0,0),s=o.transformPoint3D(n,s),l=o.transformPoint3D(a,l),(i=new ut).setPointAndNormal(s.x,s.y,s.z,l.x,l.y,l.z),t.push(i),t},Ie.prototype.makeMesh=function(){var t=new xr,e=t.newOuterRing(),i=.5*this.width,r=.5*this.length,o=e.newElement("POLYLINE");o.newPoint2d(-i,-r),o.newPoint2d(i,-r),o.newPoint2d(i,r),o.newPoint2d(-i,r);var n=this.height,a=or.getExtrudedMesh(t,n,1,void 0,!0,!0,void 0);return this.setOneColor(.2,.7,.8,.3),this.attributes.isMovable=!0,this.attributes.isSelectable=!0,this.attributes.name="clippingBox",this.attributes.selectedColor4=new _(1,0,0,0),void 0===this.options&&(this.options={}),this.options.renderWireframe=!0,this.options.renderShaded=!0,this.options.depthMask=!0,this.objectsArray.push(a),this.dirty=!1,a};var Oe=function(t,i){e.call(this),this.height=wi(t.height,0),this.geoLocDataManager,Si(i)&&(this.geoLocDataManager=i),this.bbox,this.options=t};(Oe.prototype=Object.create(e.prototype)).constructor=Oe,Oe.prototype.clear=function(){this.objectsArray=[]},Oe.prototype.makeMesh=function(){var t=this.options.tubeInfos;if(Si(t)){this.clear();for(var e=0,i=t.length;e<i;e++)this.makeTube(t[e]);this.setDirty(!1)}},Oe.prototype.makeTube=function(t){var e=t.interiorRadius,i=t.exteriorRadius,r=this.getHeight(),o=new Xe(e,i,r,t);o.owner=this,this.objectsArray.push(o)},Oe.prototype.getBoundingBox=function(){if(void 0===this.bbox){this.bbox=new y;for(var t=0,e=this.getSize();t<e;t++){var i=this.getTube(t).getBoundingBox();0===t?this.bbox.copyFrom(i):this.bbox.addBox(i)}}return this.bbox},Oe.prototype.setHeight=function(t){this.height=t},Oe.prototype.getHeight=function(t){return this.height},Oe.prototype.addTube=function(t){this.objectsArray.push(t)},Oe.prototype.getTubes=function(){return this.objectsArray},Oe.prototype.getTube=function(t){return this.objectsArray[t]},Oe.prototype.getSize=function(){return this.objectsArray.length};var Fe=function(t,i,r){if(e.call(this),!(this instanceof Fe))throw new Error(ot.CONSTRUCT_ERROR);if(this.radius=10,this.height=5,void 0!==t&&(this.radius=t),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==r){var o=r.color;o&&(this.color4=new _,this.color4.setRGBA(o.r,o.g,o.b,o.a));var n=r.selectedColor;n&&(this.selectedColor4=new _,this.selectedColor4.setRGBA(n.r,n.g,n.b,n.a))}};Fe.prototype=Object.create(e.prototype),Fe.prototype.constructor=Fe,Fe.prototype.makeMesh=function(){var t,e=new xr;(t=e.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.radius);var i=this.height,r=or.getExtrudedMesh(e,i,1,void 0,!0,!0,void 0);this.objectsArray.push(r),this.dirty=!1};var Ne=function(t,e,i){if(!(this instanceof Ne))throw new Error(ot.CONSTRUCT_ERROR);this.radiusX,this.radiusY,this.radiusZ,this.centerPosition,this.strLonRad,this.endLonRad,this.strLatRad,this.endLatRad,this.lonSegments=120,this.latSegments=60,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.mesh,void 0!==t&&(this.radiusX=t),void 0!==e&&(this.radiusY=e),void 0!==i&&(this.radiusZ=i),void 0===this.strLonRad&&(this.strLonRad=0),void 0===this.endLonRad&&(this.endLonRad=2*Math.PI),void 0===this.strLatRad&&(this.strLatRad=-Math.PI/2),void 0===this.endLatRad&&(this.endLatRad=Math.PI/2)};Ne.prototype.render=function(t,e,i,r){var o=t.getGl();if(2===i){var n;n=t.selectionColor.getAvailableColor(n);var a=t.selectionColor.decodeColor3(n.r,n.g,n.b);t.selectionManager.setCandidateGeneral(a,this),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[n.r/255,n.g/255,n.b/255,1])}var s=this.vboKeyContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(e,t.vboMemoryManager))return!1;if(void 0!==s.vboBufferNor&&!s.bindDataNormal(e,t.vboMemoryManager))return!1;if(!s.bindDataIndice(e,t.vboMemoryManager))return!1;var l=s.indicesCount;o.drawElements(o.TRIANGLES,l,o.UNSIGNED_SHORT,0)},Ne.prototype.makeVbo=function(t){if(void 0!==this.cartesiansArray){void 0===this.vboKeyContainer&&(this.vboKeyContainer=new Nt);var e=this.vboKeyContainer.newVBOVertexIdxCacheKey();e.setDataArrayPos(this.cartesiansArray,t),this.normalsArray&&e.setDataArrayNor(this.normalsArray,t),this.texCoordsArray&&e.setDataArrayTexCoord(this.texCoordsArray,t),e.setDataArrayIdx(this.indices,t)}},Ne.prototype.makeMesh=function(t){var e=!0;void 0!==t&&void 0!==t.bTrianglesSenseCCW&&(e=t.bTrianglesSenseCCW),this.strLonRad>this.endLonRad&&(this.strLonRad-=2*Math.PI);var i=(this.endLonRad-this.strLonRad)/this.lonSegments,r=(this.endLatRad-this.strLatRad)/this.latSegments,o=this.strLonRad,n=this.strLatRad,a=this.radiusX,s=this.radiusY,l=this.radiusZ,h=a*a,d=s*s,c=l*l,u=(this.lonSegments+1)*(this.latSegments+1);this.cartesiansArray=new Float32Array(3*u),this.normalsArray=new Int8Array(3*u);for(var f=0,g=new y,p=0;p<this.latSegments+1;p++){n=this.strLatRad+p*r;for(var v=Math.sin(n),m=Math.cos(n),x=0;x<this.lonSegments+1;x++){o=this.strLonRad+x*i;var b=Math.sin(o),C=a*m*Math.cos(o),A=s*m*b,T=l*v;this.cartesiansArray[3*f]=C,this.cartesiansArray[3*f+1]=A,this.cartesiansArray[3*f+2]=T;var M=new ur(C,A,T);0===f?g.init(M):g.addPoint(M),M.set(C/h,A/d,T/c),M.unitary(),e?(this.normalsArray[3*f]=127*M.x,this.normalsArray[3*f+1]=127*M.y,this.normalsArray[3*f+2]=127*M.z):(this.normalsArray[3*f]=127*-M.x,this.normalsArray[3*f+1]=127*-M.y,this.normalsArray[3*f+2]=127*-M.z),f+=1}}this.centerPosition=g.getCenterPoint();for(x=0;x<u;x++)this.cartesiansArray[3*x]-=this.centerPosition.x,this.cartesiansArray[3*x+1]-=this.centerPosition.y,this.cartesiansArray[3*x+2]-=this.centerPosition.z;void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),Ei.calculateSplited3fv([this.centerPosition.x,this.centerPosition.y,this.centerPosition.z],this.terrainPositionHIGH,this.terrainPositionLOW);var P=this.lonSegments+1,w=this.latSegments+1,_=Li.getIndicesTrianglesRegularNet(P,w,void 0,void 0,void 0,void 0,void 0,t);this.indices=_.indicesArray};var Be=function(t,i,r){if(e.call(this),!(this instanceof Be))throw new Error(ot.CONSTRUCT_ERROR);if(this.radius=1,this.height=5,void 0!==t&&(this.radius=t),void 0!==i&&(this.height=i),this.baseRadius=4*this.radius,this.flagOrientation,this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==r){var o=r.color;o&&(this.color4=new _,this.color4.setRGBA(o.r,o.g,o.b,o.a));var n=r.selectedColor;n&&(this.selectedColor4=new _,this.selectedColor4.setRGBA(n.r,n.g,n.b,n.a))}};Be.prototype=Object.create(e.prototype),Be.prototype.constructor=Be,Be.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]);var t=.01*this.height,e={color:new _(1,1,0,1)},i=new Fe(this.baseRadius,t,e);this.objectsArray.push(i);e={color:new _(.9,.9,.95,1)};var r=new Fe(this.radius,this.height,e);this.objectsArray.push(r);var o=new xr,n=o.newOuterRing().newElement("POLYLINE");n.newPoint2d(-1,0),n.newPoint2d(1,0),n.newPoint2d(0,10);var a=or.getExtrudedMesh(o,.1,1,void 0,!1,!1,a);a.setOneColor(1,.1,.1,1),a.rotate(90,0,1,0),a.rotate(45,0,0,1),a.translate(0,0,this.height-1),this.objectsArray.push(a),this.dirty=!1};var Ve=function(t,e){if(!(this instanceof Ve))throw new Error(ot.CONSTRUCT_ERROR);this.width=t,this.height=e,this.geoLocDataManager,this.vboKeysContainer};Ve.prototype.makeMesh=function(t){var e=this.width/2,i=this.height/2,r=new jr;r.point3d.set(-e,-i,0),r.normal=new ur(0,0,1),r.texCoord=new dr(0,0);var o=new jr;o.point3d.set(e,-i,0),o.normal=new ur(0,0,1),o.texCoord=new dr(1,0);var n=new jr;n.point3d.set(e,i,0),n.normal=new ur(0,0,1),n.texCoord=new dr(1,1);var a=new jr;a.point3d.set(-e,i,0),a.normal=new ur(0,0,1),a.texCoord=new dr(0,1);var s=[r,o,n,a];void 0===this.vboKeysContainer&&(this.vboKeysContainer=new Nt);var l=t.vboMemoryManager,h=this.vboKeysContainer.newVBOVertexIdxCacheKey();Ur.setIdxInList(s),Ur.getVboDataArrays(s,h,l);var d=new Uint16Array([0,1,3,1,2,3]);h.setDataArrayIdx(d,l)},Ve.prototype.render=function(t,e,i){void 0===this.vboKeysContainer&&this.makeMesh(t);var r,o=t.vboMemoryManager,n=t.sceneState.gl;this.color4&&n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]),e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.enableVertexAttribArray(e.texCoord2_loc),e.bindUniformGenerals(),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e);for(var a=this.vboKeysContainer.vboCacheKeysArray.length,s=0;s<a;s++){var l=this.vboKeysContainer.vboCacheKeysArray[s];if(!l.bindDataPosition(e,o))return!1;if(l.vboBufferNor){if(!l.bindDataNormal(e,o))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(l.vboBufferCol){if(!l.bindDataColor(e,o))return!1}else e.disableVertexAttribArray(e.color4_loc);if(l.vboBufferTCoord){if(!l.bindDataTexCoord(e,o))return!1}else e.disableVertexAttribArray(e.texCoord2_loc);if(!l.bindDataIndice(e,o))return!1;r=i||n.TRIANGLES,n.drawElements(r,l.indicesCount,n.UNSIGNED_SHORT,0)}};var je=function(t,e,i,r){if(!(this instanceof je))throw new Error(ot.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.height=5,void 0!==t&&(this.intRadius=t),void 0!==e&&(this.extRadius=e),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.geoLocDataManager,this.color4,void 0!==r){var o=r.color;o&&(this.color4=new _,this.color4.setRGBA(o.r,o.g,o.b,o.a))}};je.prototype.makeMesh=function(){var t,e=new xr;(t=e.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.extRadius),(t=e.newInnerRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.intRadius);var i=this.height;this.mesh=or.getExtrudedMesh(e,i,1,void 0,!0,!0,void 0),this.dirty=!1},je.prototype.render=function(t,e,i,r){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.uniform1i(e.refMatrixType_loc,0),0===i);else if(1===i){o.enable(o.BLEND),o.uniform1i(e.colorType_loc,0),t.selectionManager.isObjectSelected(this)?(o.disable(o.BLEND),o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])):o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}else if(2===i){t.selectionColor;var n=t.selectionColor.getAvailableColor(void 0),a=t.selectionColor.decodeColor3(n.r,n.g,n.b);t.selectionManager.setCandidateGeneral(a,this),o.uniform4fv(e.oneColor4_loc,[n.r/255,n.g/255,n.b/255,1]),o.disable(o.BLEND)}this.mesh.render(t,e,i,r)};var Ue=function(t){if(!(this instanceof Ue))throw new Error(ot.CONSTRUCT_ERROR);if(this.name,this.id,this.size=1,this.color4,this.strokeColor4,this.opacity=1,this.vertexList,this.vboKeysContainer,t){if(t.size&&(this.size=t.size),t.color)if("string"==typeof t.color){var e=_.fromHexCode(t.color,void 0);this.color4=e}else this.color4=t.color;if(t.strokeColor)if("string"==typeof t.strokeColor){e=_.fromHexCode(t.strokeColor,void 0);this.strokeColor4=e}else this.strokeColor4=t.strokeColor;t.opacity&&(this.opacity=t.opacity)}};Ue.prototype.renderAsChild=function(t,e,i,r,o,n){var a=t.getGl();a.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform1f(e.fixPointSize_loc,this.size);var s=this.strokeColor4;if(s&&a.uniform4fv(e.uStrokeColor_loc,new Float32Array([s.r,s.g,s.b,s.a])),2===i){var l=t.selectionManager,h=t.selectionColor,d=h.getAvailableColor(void 0),c=h.decodeColor3(d.r,d.g,d.b);l.setCandidateGeneral(c,this),a.uniform4fv(e.oneColor4_loc,[d.r/255,d.g/255,d.b/255,1])}var u=this.vboKeysContainer.vboCacheKeysArray[0];if(!u.bindDataPosition(e,t.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,u.vertexCount)},Ue.prototype.deleteObjects=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)};var ke=function(t){if(e.call(this),!(this instanceof ke))throw new Error(ot.CONSTRUCT_ERROR);this.setDirty(!1)};ke.prototype=Object.create(e.prototype),ke.prototype.constructor=ke;var Ge=function(t){this.modelMesh};Ge.prototype.init_TEST=function(){};var ze=function(){this.point2dArray=[],this.repository={}};ze.prototype.makeDefault=function(t){var e=t[0],i=t[1],r=e>i?i:e,o=.05*r,n=.75*i,a=.2*e,s=.5*e,l=.2*r;function h(t,e,i,r,o){var n=[t,e];return r&&o&&(n.push(r),n.push(o)),{point:n,command:i}}this.point2dArray[0]=h(s,i-o,"moveTo"),this.point2dArray[1]=h(s+a/2,n,"lineTo"),this.point2dArray[2]=h(e-l,n,"lineTo"),this.point2dArray[3]=h(e-o,n,"quadraticCurveTo",e-o,n-l),this.point2dArray[4]=h(e-o,l,"lineTo"),this.point2dArray[5]=h(e-o,o,"quadraticCurveTo",e-l,o),this.point2dArray[6]=h(l,o,"lineTo"),this.point2dArray[7]=h(o,o,"quadraticCurveTo",o,l),this.point2dArray[8]=h(o,n-l,"lineTo"),this.point2dArray[9]=h(o,n,"quadraticCurveTo",l,n),this.point2dArray[10]=h(s-a/2,n,"lineTo")},ze.prototype.getPng=function(t,e,i){var r=[];r.push(t),r.push(e),r.push(i);var o=JSON.stringify(r);if(this.repository[o])return this.repository[o].toDataURL();this.makeDefault(t);var n=function(t,e,i,r){var o=document.createElement("canvas"),n=t[0],a=t[1];o.width=n,o.height=a;var s=o.getContext("2d");s.save(),s.fillStyle=e,s.strokeStyle="#000000",s.lineWidth=2,s.beginPath();for(var l=r.length,h=0;h<l;h++){var d=r[h];2===d.point.length?s[d.command].call(s,d.point[0],d.point[1]):s[d.command].call(s,d.point[0],d.point[1],d.point[2],d.point[3])}if(s.closePath(),s.fill(),s.stroke(),i){var c=i.text,u=wi(i.pixel,10),f=wi(i.font,"sans-serif"),g=wi(i.color,"white"),p=wi(i.borderColor,"black");s.font="bold "+u+"px "+f,s.fillStyle=g,s.strokeStyle=p,s.textAlign="center",s.strokeText(c,n/2,a/2),s.fillText(c,n/2,a/2)}return s.restore(),o}(t,e,i,this.point2dArray);return this.repository[o]=n,n.toDataURL()};var He=function(t){if(e.call(this),!(this instanceof He))throw new Error(ot.CONSTRUCT_ERROR);this.geoCoordSegment=t};He.prototype=Object.create(e.prototype),He.prototype.constructor=He,He.prototype.makeMesh=function(t){var e=U.getArcInterpolatedGeoCoords(this.geoCoordSegment.strGeoCoord,this.geoCoordSegment.endGeoCoord,1500,void 0),i=k.getRenderableObjectOfGeoCoordsArray(e,t,{color:"#ffff00",thickness:2});void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(i),this.setDirty(!1)};var We=function(t){if(e.call(this,t),!(this instanceof We))throw new Error(ot.CONSTRUCT_ERROR);this.height,this.point2DList,void 0!==t&&(void 0!==t.points2dArray&&(void 0===this.point2DList&&(this.point2DList=new cr),this.point2DList.pointsArray=t.points2dArray),void 0!==t.height&&(this.height=t.height))};We.prototype=Object.create(e.prototype),We.prototype.constructor=We,We.prototype.makeMesh=function(){for(var t=new xr,e=t.newOuterRing().newElement("POLYLINE"),i=this.point2DList.getPointsCount(),r=0;r<i;r++){var o=this.point2DList.getPoint(r);e.newPoint2d(o.x,o.y)}var n=this.height;void 0===this.objectsArray&&(this.objectsArray=[]);var a=or.getExtrudedMesh(t,n,1,void 0,!0,!0,void 0);this.objectsArray.push(a),this.dirty=!1};var Xe=function(t,i,r,o){if(e.call(this),!(this instanceof Xe))throw new Error(ot.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.height=5,void 0!==t&&(this.intRadius=t),void 0!==i&&(this.extRadius=i),void 0!==r&&(this.height=r),this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==o){var n=o.color;n&&(this.color4=new _,this.color4.setRGBA(n.r,n.g,n.b,n.a));var a=o.selectedColor;a&&(this.selectedColor4=new _,this.selectedColor4.setRGBA(a.r,a.g,a.b,a.a))}};Xe.prototype=Object.create(e.prototype),Xe.prototype.constructor=Xe,Xe.prototype.getBoundingBox=function(){if(void 0===this.bbox){this.bbox=new y;var t=this.extRadius;t<this.intRadius&&(t=this.intRadius),this.bbox.set(-t,-t,0,t,t,this.height)}return this.bbox},Xe.prototype.makeMesh=function(){var t,e=new xr;(t=e.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.extRadius),(t=e.newInnerRing().newElement("CIRCLE")).setCenterPosition(0,0),t.setRadius(this.intRadius);var i=this.height,r=or.getExtrudedMesh(e,i,1,void 0,!0,!0,void 0);this.objectsArray.push(r),this.dirty=!1};var Ye=function(t){if(!(this instanceof Ye))throw new Error(ot.CONSTRUCT_ERROR);if(this.name,this.id,this.thickness=1,this.color4,this.vertexList,this.vboKeysContainer,t&&(t.thickness&&(this.thickness=t.thickness),t.color))if("string"==typeof t.color){var e=_.fromHexCode(t.color,void 0);this.color4=e}else this.color4=t.color};Ye.prototype.renderAsChild=function(t,e,i,r,o,n){var a=!0,s=t.getGl();n&&void 0!==n.depthMask&&(a=n.depthMask),s.depthMask(a),this.render(t,e,i,r,o),s.depthMask(!0)},Ye.prototype.render=function(t,e,i,r,o){if(void 0!==this.vboKeysContainer){var n=this.vboKeysContainer.getVboKey(0),a=t.getGl();a.disable(a.CULL_FACE),a.enableVertexAttribArray(e.prev_loc),a.enableVertexAttribArray(e.current_loc),a.enableVertexAttribArray(e.next_loc),a.disableVertexAttribArray(e.color4_loc);var s=t.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),h=s.drawingBufferHeight;void 0===this.thickness&&(this.thickness=2),a.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform2fv(e.viewport_loc,[l[0],h[0]]),a.uniform1f(e.thickness_loc,this.thickness);var d=n.vboBufferPos,c=d.dataDimensions;if(d.isReady(a,t.vboMemoryManager)){if(n.vboBufferCol){if(!n.bindDataColor(e,t.vboMemoryManager))return;a.uniform1i(e.colorType_loc,1)}else a.uniform1i(e.colorType_loc,0),a.disableVertexAttribArray(e.color4_loc);a.bindBuffer(a.ARRAY_BUFFER,d.key),a.vertexAttribPointer(e.prev_loc,c,a.FLOAT,!1,16,0),a.vertexAttribPointer(e.current_loc,c,a.FLOAT,!1,16,32),a.vertexAttribPointer(e.next_loc,c,a.FLOAT,!1,16,96),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4),a.enable(a.CULL_FACE)}}},Ye.prototype.deleteObjects=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)};var Ke=function(t,i,r,o){if(e.call(this),!(this instanceof Ke))throw new Error(ot.CONSTRUCT_ERROR);this.PARALLEL_ROTATION_ANGLE=90,this.frame,this.frontArrow,this.rearArrow,this.frontArrowPos,this.rearArrowPos,this.width=t,this.length=i,this.height=r,this.wheelbase=.8*i,this.rearAngleDeg=0,this.frontAngleDeg=0,this.isDrawArrow=!0,this.eventStatus={changingFrontArrow:!1,changingRearArrow:!1,footOnAccel:!1},this.mode=De.MODE.NORMAL,this.accelStatus=De.ACCEL_STATUS.FORWARD,this.changingFrontArrowType=0,this.changingFrontArrowSpeed=.1,this.changingRearArrowType=0,this.changingRearArrowSpeed=.1,this.maxSpeed=12,this.frontCurrentSpeed=0,this.frontAcceleration=1,this.frontDeacceleration=3.8,this.rearCurrentSpeed=0,this.rearAcceleration=1,this.rearDeacceleration=3.8,this.pivotPointLC,this.isParallelDirection=!1,this.guidePoint=new fr,this.auxOffsetVector,this.parallelRotationDist=10,this.frame,this.carriedObjectsArray=[],this.shimmyMatDimension=new dr(.7*this.width,this.wheelbase),this.shimmyMat=new dr(2,12);for(this.trajectoryLength=2*this.length,this.frontTrajectoryPointList=new fr,this.rearTrajectoryPointList=new fr;50!==this.frontTrajectoryPointList.getPointsCount();)this.frontTrajectoryPointList.newPoint();for(;50!==this.rearTrajectoryPointList.getPointsCount();)this.rearTrajectoryPointList.newPoint();this.objectsArray.push(this.frontTrajectoryPointList),this.objectsArray.push(this.rearTrajectoryPointList)};Ke.prototype=Object.create(e.prototype),Ke.prototype.constructor=Ke,Ke.prototype.addToContainer=function(t,e){this.carriedObjectsArray.push(t),this.updateContainer(e)},Ke.prototype.updateContainer=function(t){for(var e=this.geoLocDataManager.getCurrentGeoLocationData(),i=e.getGeographicCoords(),r=0,o=this.carriedObjectsArray.length;r<o;r++){var n=this.carriedObjectsArray[r];if(n instanceof he){n.data.mapping_type="boundingboxcenter";n.data.geoLocDataManager.getCurrentGeoLocationData();var a=e.heading,s=n.data.bbox.getZLength()/2;n.changeLocationAndRotation(i.latitude,i.longitude,i.altitude+this.height+s,a,void 0,void 0,t)}}},Ke.prototype.render=function(t,e,i,r){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&(this.makeMesh(),this.arrowDirectionChanged(t)),void 0===this.objectsArray)return!1;var o=t.getGl();this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.uniform4fv(e.oneColor4_loc,[0,1,0,1]),this.changeArrow(t),this.move(t),o.uniform1i(e.refMatrixType_loc,0);var n=!1;if(0===i);else if(1===i){t.selectionManager.isObjectSelected(this)&&(n=!0),o.enable(o.BLEND),o.uniform1i(e.bApplySsao_loc,!0),o.uniform1i(e.colorType_loc,0),this.color4&&o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])}else if(2===i){t.selectionColor;var a=t.selectionColor.getAvailableColor(void 0),s=t.selectionColor.decodeColor3(a.r,a.g,a.b);t.selectionManager.setCandidateGeneral(s,this),o.uniform4fv(e.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1]),o.disable(o.BLEND)}n&&(void 0===this.selColor4&&(this.selColor4=new _,this.selColor4.setRGBA(.8,.4,.5,1)),o.uniform4fv(e.oneColor4_loc,[this.selColor4.r,this.selColor4.g,this.selColor4.b,1])),e.enableVertexAttribArray(e.position3_loc),this.guidePoint.renderAsChild(t,e,i,r),e.enableVertexAttribArray(e.normal3_loc);for(var l=this.objectsArray.length,h=0;h<l;h++){this.objectsArray[h].renderAsChild(t,e,i,r,n)}o.disable(o.BLEND)}},Ke.prototype.renderAsChild=function(t,e,i,r){},Ke.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]);var t=this.width,e=this.length,i=.15*this.height,r=new Ee(t,e,i,"frame");r.setOneColor(196/255,117/255,0,1);var o=new ur(0,0,this.height-i);r.tMatOriginal=new rt,r.tMatOriginal.setTranslation(o.x,o.y,o.z),this.objectsArray.push(r),this.frame=r;var n=new Le(10,50,.5,{totalLength:12,bodyWidth:2,headWidth:4,tailLength:1,extrude:2}),a=new Le(10,50,.5,{totalLength:12,bodyWidth:2,headWidth:4,tailLength:1,extrude:2});this.objectsArray.push(n),this.frontArrow=n,this.frontArrow.setOneColor(.9,.1,.1,1),this.frontArrowPos=new ur(0,1.5*this.wheelbase,this.height),n.tMatOriginal=new rt,n.tMatOriginal.setTranslation(this.frontArrowPos.x,this.frontArrowPos.y,this.frontArrowPos.z),this.objectsArray.push(a),this.rearArrow=a,this.rearArrowPos=new ur(0,1.5*-this.wheelbase,this.height),a.tMatOriginal=new rt,a.tMatOriginal.setTranslation(this.rearArrowPos.x,this.rearArrowPos.y,this.rearArrowPos.z);var s=.25*this.width,l=this.height-i,h=this.getShimmyGearAssembly();this.shimmyGearAssembly=new h(s,.5,l),this.shimmyGearAssembly.setOneColor(196/255,117/255,0,1),this.shimmyGearAssembly.tMatOriginal=new rt,this.shimmyGearAssembly.tMatOriginal.setTranslation(0,0,l),this.shimmyGearAssembly.makeMesh();for(var d=this.shimmyMat.x,c=this.shimmyMat.y,u=this.shimmyMatDimension.x/(d-1),f=this.shimmyMatDimension.y/(c-1),g=0;g<d;g++)for(var p=0;p<c;p++){var v=new h(s,.5,l);v.frame=this.shimmyGearAssembly.frame,v.rightWheel=this.shimmyGearAssembly.rightWheel,v.leftWheel=this.shimmyGearAssembly.leftWheel,v.color4=this.shimmyGearAssembly.color4,v.makeMesh();var y=f*p,m=new ur(u*g-.5*this.shimmyMatDimension.x,y-.5*this.shimmyMatDimension.y,l);v.tMatOriginal=new rt,v.tMatOriginal.setTranslation(m.x,m.y,m.z),v.orginShimmyPos=m,this.objectsArray.push(v)}this.updateMatrix(),this.setDirty(!1)},Ke.prototype.doChangeFrontAngleDeg=function(t){this.eventStatus.changingFrontArrow=!0,this.changingFrontArrowType="left"===t?0:1},Ke.prototype.stopChangeFrontAngleDeg=function(){this.eventStatus.changingFrontArrow=!1},Ke.prototype.doChangeRearAngleDeg=function(t){this.eventStatus.changingRearArrow=!0,this.changingRearArrowType="left"===t?0:1},Ke.prototype.stopChangeRearAngleDeg=function(){this.eventStatus.changingRearArrow=!1},Ke.prototype._updateLastTime=function(t){this.lastTime=t},Ke.prototype.moveParallelTranslate=function(t,e){var i=this.geoLocDataManager.newGeoLocationData(),r=i.geographicCoord,o=this.frontDirection2D;this.accelStatus===De.ACCEL_STATUS.REVERSE&&((o=new dr).copyFrom(this.frontDirection2D),o.inverse());var n=new ur(o.x,o.y,0),a=new ur(n.x*this.frontCurrentSpeed*t,n.y*this.frontCurrentSpeed*t,n.z*this.frontCurrentSpeed*t),s=i.rotMatrix.rotatePoint3D(a),l=new Float32Array(3),h=new Float32Array(3);h[0]=i.positionLOW[0]+s.x,h[1]=i.positionLOW[1]+s.y,h[2]=i.positionLOW[2]+s.z,l[0]=i.positionHIGH[0],l[1]=i.positionHIGH[1],l[2]=i.positionHIGH[2];var d=i.localCoordToWorldCoord(a);r=Ei.pointToGeographicCoord(d,r),i=Ei.calculateGeoLocationDataByAbsolutePoint(h[0]+l[0],h[1]+l[1],h[2]+l[2],i,e)},Ke.prototype.moveCircularRotation=function(t,e){if(this.pivotPointLC){var i=this.geoLocDataManager.newGeoLocationData(),r=(i.geographicCoord,this.frontArrowPos),o=this.rearArrowPos,n=this.frontLine2D,a=(this.rearLine2D,this.frontDirection2D),s=this.rearDirection2D;this.auxOffsetVector||(this.auxOffsetVector=new ur(0,0,0));var l=this.frontCurrentSpeed,h=l*t,d=new ur(r.x,r.y,0);d.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);var u=this.pivotPointLC.distToPoint(r);if(u<.001)return this._updateLastTime(void 0),void(this.frontCurrentSpeed=0);var f=h/u;n.getRelativeSideOfPoint(this.pivotPointLC)===c.relativePosition2D.RIGHT&&(f*=-1),this.accelStatus===De.ACCEL_STATUS.REVERSE&&(f*=-1);var g=new rt;g.rotationAxisAngRad(f,0,0,1);var p=g.rotatePoint3D(d),v=new ur(p.x,p.y,p.z);v.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);s.scalarProduct(a);var y=new ur(o.x,o.y,0);y.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);this.pivotPointLC.distToPoint(o);var m=f,x=new rt;x.rotationAxisAngRad(m,0,0,1);var b=x.rotatePoint3D(y),C=new ur(b.x,b.y,b.z);C.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);var A=new ur((v.x+C.x)/2,(v.y+C.y)/2,0),T=new wr(C,v).getDirection(),M=new dr(0,1),P=T.angleDegToVector(M);T.x>0&&(P*=-1);var w=i.rotMatrix,_=new Float32Array(3),S=new Float32Array(3),L=w.rotatePoint3D(A);S[0]=i.positionLOW[0]+L.x,S[1]=i.positionLOW[1]+L.y,S[2]=i.positionLOW[2]+L.z,_[0]=i.positionHIGH[0],_[1]=i.positionHIGH[1],_[2]=i.positionHIGH[2],void 0===i.heading&&(i.heading=0),P=i.heading+P;var R=new ur(S[0]+_[0],S[1]+_[1],S[2]+_[2]),D=Ei.pointToGeographicCoord(R);D.altitude=0,i=Ei.calculateGeoLocationData(D.longitude,D.latitude,D.altitude,De.degreeValidator(P),i.pitch,i.roll,i,e),this.update(e)}},Ke.prototype.changeParallelRotationDist=function(t){0===t?this.parallelRotationDist-=.1:this.parallelRotationDist+=.1},Ke.prototype.moveNormal=function(t,e){this.isParallelDirection?this.moveParallelTranslate(t,e):this.moveCircularRotation(t,e)},Ke.prototype.moveParallelRotation=function(t,e){var i=this.geoLocDataManager.newGeoLocationData(),r=(i.geographicCoord,this.frontArrowPos),o=this.rearArrowPos,n=this.frontDirection2D,a=this.rearDirection2D,s=new wr(new dr(r.x,r.y),new dr(r.x+n.x,r.y+n.y)),l=new wr(new dr(o.x,o.y),new dr(o.x+a.x,o.y+a.y));this.frontLine2D=s.getLine(),this.rearLine2D=l.getLine();var h=this.frontLine2D;this.rearLine2D;this.pivotPointLC||(this.pivotPointLC=new ur),this.setPivotPointLC(0,this.parallelRotationDist,0,e),this.guidePoint.deleteObjects(e),this.guidePoint.addPoint(new ur(this.pivotPointLC.x,this.pivotPointLC.y,2.2));var d=new dr(this.pivotPointLC.x,this.pivotPointLC.y);d.inverse(),this.auxOffsetVector=d;var u=this.frontCurrentSpeed,f=u*t,g=new ur(r.x,r.y,0);g.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);var p=this.pivotPointLC.distToPoint(r);if(p<.001)return this._updateLastTime(void 0),void(this.frontCurrentSpeed=0);var v=f/p;h.getRelativeSideOfPoint(this.pivotPointLC)===c.relativePosition2D.RIGHT&&(v*=-1),this.accelStatus===De.ACCEL_STATUS.REVERSE&&(v*=-1);var y=new rt;y.rotationAxisAngRad(v,0,0,1);var m=y.rotatePoint3D(g),x=new ur(m.x,m.y,m.z);x.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);this.parallelRotationDist,this.wheelbase,f=this.parallelRotationDist-.5*this.wheelbase;var b=new ur(o.x,o.y,0);b.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);this.pivotPointLC.distToPoint(o);var C=v,A=new rt;A.rotationAxisAngRad(C,0,0,1);var T=A.rotatePoint3D(b),M=new ur(T.x,T.y,T.z);M.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);var P=new ur((x.x+M.x)/2,(x.y+M.y)/2,0),w=new wr(M,x).getDirection(),_=new dr(0,1),S=w.angleDegToVector(_);w.x>0&&(S*=-1);var L=i.rotMatrix,R=new Float32Array(3),D=new Float32Array(3),E=L.rotatePoint3D(P);D[0]=i.positionLOW[0]+E.x,D[1]=i.positionLOW[1]+E.y,D[2]=i.positionLOW[2]+E.z,R[0]=i.positionHIGH[0],R[1]=i.positionHIGH[1],R[2]=i.positionHIGH[2],void 0===i.heading&&(i.heading=0),S=i.heading+S;var I=new ur(D[0]+R[0],D[1]+R[1],D[2]+R[2]),O=Ei.pointToGeographicCoord(I);O.altitude=0,i=Ei.calculateGeoLocationData(O.longitude,O.latitude,O.altitude,De.degreeValidator(S),i.pitch,i.roll,i,e),this.update(e)},Ke.prototype.move=function(t){if(void 0!==this.renderingFase&&null!==this.renderingFase||(this.renderingFase=t.renderingFase),this.renderingFase!==t.renderingFase&&(this.eventStatus.footOnAccel||0!==this.frontCurrentSpeed)){var e=t.getCurrentTime();this.lastTime||this._updateLastTime(e);var i=(e-this.lastTime)/1e3;if(0!==i){var r=this.eventStatus.footOnAccel?this.frontAcceleration:-this.frontDeacceleration;switch(this.frontCurrentSpeed=function(t,e,i){(i+=e*t)<0&&(i=0);return i}(i,r,this.frontCurrentSpeed),this.frontCurrentSpeed>this.maxSpeed&&(this.frontCurrentSpeed=this.maxSpeed),this.mode){case De.MODE.NORMAL:this.moveNormal(i,t);break;case De.MODE.CIRCULAR_ROTATION:this.moveCircularRotation(i,t);break;case De.MODE.PARALLEL_TRANSLATE:this.moveParallelTranslate(i,t);break;case De.MODE.PARALLEL_ROTATION:this.moveParallelRotation(i,t)}var o=this.geoLocDataManager.getCurrentGeoLocationData().geographicCoord,n=this.smartTileOwner,a=o.longitude,s=o.latitude;if(!n.intersectPoint(a,s)){n.eraseObjectByComparision(this,"name");var l=n.depth;t.smartTileManager.putObject(l,this,t)}0!==this.frontCurrentSpeed||this.eventStatus.footOnAccel||(e=void 0),this._updateLastTime(e),this.renderingFase=!this.renderingFase,this.updateContainer(t)}}},Ke.prototype.getFrameDirection2D=function(t){t||(t=new dr);var e=this.geoLocDataManager.getCurrentGeoLocationData().heading*Math.PI/180;return t.set(-Math.sin(e),Math.cos(e)),t},Ke.prototype.getFrontDirection2D=function(t){t||(t=new dr);var e=this.frontAngleDeg*Math.PI/180;return t.set(-Math.sin(e),Math.cos(e)),t},Ke.prototype.getRearDirection2D=function(t){t||(t=new dr);var e=this.rearAngleDeg*Math.PI/180;return t.set(-Math.sin(e),Math.cos(e)),t},Ke.prototype.footOnAccel=function(){this.eventStatus.footOnAccel=!0,this.accelStatus=De.ACCEL_STATUS.FORWARD},Ke.prototype.footOnReverseAccel=function(){this.eventStatus.footOnAccel=!0,this.accelStatus=De.ACCEL_STATUS.REVERSE},Ke.prototype.footOffAccel=function(){this.eventStatus.footOnAccel=!1},Ke.prototype.arrowDirectionChanged=function(t){this.update(t);var e=this.frontDirection2D,i=this.rearDirection2D;if(this.isParallelDirection=e.isParallelToPoint(i,.1),this.isParallelDirection)this.linearTrajectory(),this.frontTrajectoryPointList.deleteVboKeysContainer(t),this.rearTrajectoryPointList.deleteVboKeysContainer(t);else{var r=this.frontArrowPos,o=this.rearArrowPos,n=new wr(new dr(r.x,r.y),new dr(r.x+e.x,r.y+e.y)),a=new wr(new dr(o.x,o.y),new dr(o.x+i.x,o.y+i.y));this.frontLine2D=n.getLine(),this.rearLine2D=a.getLine();var s=this.frontLine2D,l=this.rearLine2D,h=s.getPerpendicularRight(),d=l.getPerpendicularRight(),c=h.intersectionWithLine(d);if(!c)return;this.setPivotPointLC(c.x,c.y,0,t),this.guidePoint.deleteObjects(t),this.guidePoint.addPoint(new ur(this.pivotPointLC.x,this.pivotPointLC.y,2.2));var u=new dr(c.x,c.y);u.inverse(),this.auxOffsetVector=u}},Ke.prototype.changeArrow=function(t){var e=!1,i=this.mode;switch(i){case De.MODE.NORMAL:if(this.eventStatus.changingFrontArrow){var r=this.changingFrontArrowSpeed;this.changingFrontArrowType>0&&(r=-r),this.frontAngleDeg=this.frontAngleDeg+r,this.frontAngleDeg=De.degreeValidator(this.frontAngleDeg),e=!0}if(this.eventStatus.changingRearArrow){r=this.changingRearArrowSpeed;this.changingRearArrowType>0&&(r=-r),this.rearAngleDeg=this.rearAngleDeg+r,this.rearAngleDeg=De.degreeValidator(this.rearAngleDeg),e=!0}break;case De.MODE.CIRCULAR_ROTATION:case De.MODE.PARALLEL_TRANSLATE:if(this.eventStatus.changingFrontArrow||this.eventStatus.changingRearArrow){r=this.changingFrontArrowSpeed;(this.eventStatus.changingFrontArrow?this.changingFrontArrowType:this.changingRearArrowType)>0&&(r=-r),this.frontAngleDeg=this.frontAngleDeg+r,this.rearAngleDeg=i===De.MODE.CIRCULAR_ROTATION?-this.frontAngleDeg:this.frontAngleDeg,e=!0}break;case De.MODE.PARALLEL_ROTATION:this.frontAngleDeg=this.PARALLEL_ROTATION_ANGLE,this.rearAngleDeg=this.PARALLEL_ROTATION_ANGLE,e=!0}e&&this.arrowDirectionChanged(t)},Ke.prototype.update=function(t){var e=this.frontArrow,i=new rt;i.setTranslation(this.frontArrowPos.x,this.frontArrowPos.y,this.frontArrowPos.z);var r=new rt;r.rotationAxisAngDeg(this.frontAngleDeg,0,0,1),this.frontDirection2D=this.getFrontDirection2D();var o=r.getMultipliedByMatrix(i);e.tMatOriginal=o;var n=this.rearArrow,a=new rt;a.setTranslation(this.rearArrowPos.x,this.rearArrowPos.y,this.rearArrowPos.z);var s=new rt;s.rotationAxisAngDeg(this.rearAngleDeg,0,0,1),this.rearDirection2D=this.getRearDirection2D();var l=s.getMultipliedByMatrix(a);n.tMatOriginal=l;var h=this.pivotPointLC;if(h&&h.x!==1/0){var d=new dr(h.x,h.y),c=new dr(0,1);for(g=0,p=this.objectsArray.length;g<p;g++){if(!((v=this.objectsArray[g])instanceof Ee||v instanceof Le||v instanceof fr)){x=v.orginShimmyPos;(y=new rt).setTranslation(x.x,x.y,x.z);m=new rt;var u=d.getVectorToPoint(new dr(x.x,x.y));u.unitary();var f=90-c.angleDegToVector(u);u.x<0&&(f*=-1),m.rotationAxisAngDeg(f,0,0,1);b=m.getMultipliedByMatrix(y);v.tMatOriginal=b}}}else for(var g=0,p=this.objectsArray.length;g<p;g++){var v;if(!((v=this.objectsArray[g])instanceof Ee||v instanceof Le||v instanceof fr)){var y,m,x=v.orginShimmyPos;(y=new rt).setTranslation(x.x,x.y,x.z),(m=new rt).rotationAxisAngDeg(this.frontAngleDeg,0,0,1);var b=m.getMultipliedByMatrix(y);v.tMatOriginal=b}}this.updateMatrix()},Ke.prototype.getShimmyGearAssembly=function(){var t=function(t,i,r,o){e.call(this),this.width=t,this.height=r,this.wheelRadius=.4*this.height,this.frameLength=.4*i,this.frameHeight=this.height-.5*this.wheelRadius,this.frame};return(t.prototype=Object.create(e.prototype)).constructor=t,t.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]),void 0===this.objectsMap&&(this.objectsMap={});var t=new xr,e=t.newOuterRing(),i=.5*this.frameLength,r=.25*this.width,o=e.newElement("POLYLINE");o.newPoint2d(i,0),o.newPoint2d(-i,0),o.newPoint2d(-i,-this.frameHeight),o.newPoint2d(i,-this.frameHeight),o.newPoint2d(2.5*i,.5*-this.frameHeight);var n=r,a=or.getExtrudedMesh(t,n,1,void 0,!0,!0,void 0);a.name="frame",a.rotate(90,1,0,0),a.rotate(90,0,0,1),a.translate(.5*-n,0,0),this.objectsArray.push(a),this.objectsMap[a.name]=a;var s=this.wheelRadius,l=.5*s,h=.5*this.width-.5*r,d=new qe(l,s,h,{borderRadius:.2*h}),c=new qe(l,s,h,{borderRadius:.2*h});d.setOneColor(.1,.1,.15,1),c.setOneColor(.1,.1,.15,1),this.objectsArray.push(d),this.objectsArray.push(c);var u=new ur(.5*-r-.5*h,0,-this.height+s),f=new ur(.5*r+.5*h,0,-this.height+s);d.tMatOriginal=new rt,d.tMatOriginal.setTranslation(u.x,u.y,u.z),c.tMatOriginal=new rt,c.tMatOriginal.setTranslation(f.x,f.y,f.z),this.dirty=!1},t.prototype.renderAsChild=function(t,e,i,r){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.objectsArray)return!1;var o=t.getGl();o.uniform1i(e.refMatrixType_loc,0);var n=!1;if(0===i);else if(1===i){t.selectionManager.isObjectSelected(this)&&(n=!0),o.enable(o.BLEND),o.uniform1i(e.bApplySsao_loc,!0),o.uniform1i(e.colorType_loc,0),this.color4&&o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])}else if(2===i){t.selectionColor;var a=t.selectionColor.getAvailableColor(void 0),s=t.selectionColor.decodeColor3(a.r,a.g,a.b);t.selectionManager.setCandidateGeneral(s,this),o.uniform4fv(e.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1]),o.disable(o.BLEND)}n&&(void 0===this.selColor4&&(this.selColor4=new _,this.selColor4.setRGBA(.8,.4,.5,1)),o.uniform4fv(e.oneColor4_loc,[this.selColor4.r,this.selColor4.g,this.selColor4.b,1])),this.tMat&&o.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays);for(var l=this.objectsArray.length,h=0;h<l;h++){this.objectsArray[h].renderAsChild(t,e,i,r,n)}o.disable(o.BLEND)}},t},Ke.prototype.setPivotPointLC=function(t,e,i,r){switch(this.pivotPointLC||(this.pivotPointLC=new ur),this.pivotPointLC.set(t,e,i),this.mode){case De.MODE.NORMAL:this.isParallelDirection?this.linearTrajectory():this.circleTrajectory();break;case De.MODE.PARALLEL_TRANSLATE:this.linearTrajectory();break;case De.MODE.CIRCULAR_ROTATION:case De.MODE.PARALLEL_ROTATION:this.circleTrajectory()}this.frontTrajectoryPointList.deleteVboKeysContainer(r),this.rearTrajectoryPointList.deleteVboKeysContainer(r)},Ke.prototype.linearTrajectory=function(){for(var t=this.frontTrajectoryPointList.getPointsCount(),e=this.trajectoryLength/t,i=0;i<t;i++){var r=this.frontTrajectoryPointList.getPoint(i),o=this.rearTrajectoryPointList.getPoint(i);r.set(this.frontDirection2D.x*e*(i+1),this.frontDirection2D.y*e*(i+1),this.height),o.set(this.frontDirection2D.x*-e*(i+1),this.frontDirection2D.y*-e*(i+1),this.height)}},Ke.prototype.circleTrajectory=function(){if(this.pivotPointLC){var t=this.frontTrajectoryPointList.getPointsCount(),e=new dr(-this.pivotPointLC.x,-this.pivotPointLC.y),i=new dr(1,0),r=e.angleRadToVector(i);e.y<0&&(r*=-1);for(var o=e.getModul(),n=this.trajectoryLength/o/(t-1),a=0;a<t;a++){var s=this.frontTrajectoryPointList.getPoint(a),l=this.rearTrajectoryPointList.getPoint(a),h=r+a*n,d=r+a*-n;s.set(-e.x+o*Math.cos(h),-e.y+o*Math.sin(h),this.height),l.set(-e.x+o*Math.cos(d),-e.y+o*Math.sin(d),this.height)}}};var qe=function(t,i,r,o){if(e.call(this),!(this instanceof qe))throw new Error(ot.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.width=5,this.color4=new _,this.color4.setRGBA(.2,.2,.25,1),void 0!==t&&(this.intRadius=t),void 0!==i&&(this.extRadius=i),void 0!==r&&(this.width=r),this.borderRadius=.2*(this.extRadius-this.intRadius),void 0!==o){var n=o.color;n&&this.color4.setRGBA(n.r,n.g,n.b,n.a);var a=o.borderRadius;a&&(this.borderRadius=a)}this.width,this.borderRadius,this.borderRadius=.2*this.width};qe.prototype=Object.create(e.prototype),qe.prototype.constructor=qe,qe.prototype.makeMesh=function(){var t=new xr,e=t.newOuterRing(),i=.5*this.width,r=this.extRadius-this.borderRadius,o=e.newElement("POLYLINE");o.newPoint2d(-i,this.intRadius),o.newPoint2d(i,this.intRadius),o.newPoint2d(i,r);var n=e.newElement("ARC");n.setCenterPosition(i-this.borderRadius,r),n.setRadius(this.borderRadius),n.setStartAngleDegree(0),n.setSweepAngleDegree(90);var a=e.newElement("POLYLINE");a.newPoint2d(i-this.borderRadius,this.extRadius),a.newPoint2d(-i+this.borderRadius,this.extRadius);var s=e.newElement("ARC");s.setCenterPosition(-i+this.borderRadius,r),s.setRadius(this.borderRadius),s.setStartAngleDegree(90),s.setSweepAngleDegree(90),e.newElement("POLYLINE").newPoint2d(-i,r);var l=new wr,h=new dr(-1,0),d=new dr(1,0);l.setPoints(h,d);var c=or.getRevolvedSolidMesh(t,360,18,l,!1,!1,void 0);this.mesh=c.getCopySurfaceIndependentMesh(c),this.dirty=!1},qe.prototype.render=function(t,e,i,r){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();if(this.geoLocDataManager){if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),o.uniform1i(e.refMatrixType_loc,0),o.uniform1i(e.colorType_loc,0),2===i){t.selectionColor;var n=t.selectionColor.getAvailableColor(void 0),a=t.selectionColor.decodeColor3(n.r,n.g,n.b);t.selectionManager.setCandidateGeneral(a,this),o.uniform4fv(e.oneColor4_loc,[n.r/255,n.g/255,n.b/255,1]),o.disable(o.BLEND)}this.mesh.render(t,e,i,r),o.disable(o.BLEND)}}},qe.prototype.renderAsChild=function(t,e,i,r){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=t.getGl();if(1===i)o.enable(o.BLEND),o.uniform1i(e.colorType_loc,0),t.selectionManager.isObjectSelected(this)?o.uniform4fv(e.oneColor4_loc,[.9,.1,.1,1]):this.color4&&o.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]);else if(2===i){t.selectionColor;var n=t.selectionColor.getAvailableColor(void 0),a=t.selectionColor.decodeColor3(n.r,n.g,n.b);t.selectionManager.setCandidateGeneral(a,this),o.uniform4fv(e.oneColor4_loc,[n.r/255,n.g/255,n.b/255,1]),o.disable(o.BLEND)}this.tMat&&o.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.tMat._floatArrays),this.mesh.render(t,e,i,r),o.disable(o.BLEND)}};var Ze=function(){if(!(this instanceof Ze))throw new Error(ot.CONSTRUCT_ERROR);this.attribLocationEnabled=!1},Qe=function(t){if(!(this instanceof Qe))throw new Error(ot.CONSTRUCT_ERROR);this.gl=t,this.name,this.attribLocationCacheObj={},this.uniformsArrayGeneral=[],this.uniformsMapGeneral={},this.uniformsArrayLocal=[],this.uniformsMapLocal={},this.camera,this.program,this.shader_vertex,this.shader_fragment,this.last_tex_id,this.last_isAditionalMovedZero=!1,this.lastVboKeyBindedMap={},this.attribLocationStateArray=[],this.shaderManager};Qe.createShader=function(t,e,i){var r=t.createShader(e);if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r));return r},Qe.createProgram=function(t,e,i){var r=t.createProgram(),o=Qe.createShader(t,t.VERTEX_SHADER,e),n=Qe.createShader(t,t.FRAGMENT_SHADER,i);if(t.attachShader(r,o),t.attachShader(r,n),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(r));for(var a={program:r},s=t.getProgramParameter(r,t.ACTIVE_ATTRIBUTES),l=0;l<s;l++){var h=t.getActiveAttrib(r,l);a[h.name]=t.getAttribLocation(r,h.name)}var d=t.getProgramParameter(r,t.ACTIVE_UNIFORMS);for(l=0;l<d;l++){var c=t.getActiveUniform(r,l);a[c.name]=t.getUniformLocation(r,c.name)}return a},Qe.prototype.resetLastBuffersBinded=function(){if(this.last_tex_id=void 0,this.last_isAditionalMovedZero=!1,this.lastVboKeyBindedMap={},this.disableVertexAttribArrayAll(),this.attribLocationStateArray){for(var t=this.attribLocationStateArray.length,e=0;e<t;e++){var i=this.attribLocationStateArray[e];void 0!==i&&(i.attribLocationEnabled=void 0,this.attribLocationStateArray[e]=void 0)}this.attribLocationStateArray.length=0}},Qe.prototype.enableVertexAttribArray=function(t){if(void 0===t||t<0)return!1;var e=this.attribLocationStateArray[t];return void 0===e&&(e=new Ze,this.attribLocationStateArray[t]=e,e.attribLocationEnabled=!1),e.attribLocationEnabled||(this.gl.enableVertexAttribArray(t),e.attribLocationEnabled=!0),!0},Qe.prototype.disableTextureImagesUnitsAll=function(){for(var t=this.gl,e=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),i=0;i<e;i++)t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,null)},Qe.prototype.disableVertexAttribArrayAll=function(){for(var t=this.gl,e=t.getParameter(t.MAX_VERTEX_ATTRIBS),i=0;i<e;i++)t.disableVertexAttribArray(i)},Qe.prototype.disableVertexAttribArray=function(t){if(!(void 0===t||t<0)){var e=this.attribLocationStateArray[t];void 0===e&&(e=new Ze,this.attribLocationStateArray[t]=e,e.attribLocationEnabled=!0),e.attribLocationEnabled&&(this.gl.disableVertexAttribArray(t),e.attribLocationEnabled=!1)}},Qe.prototype.useProgram=function(){var t=this.gl;t.getParameter(t.CURRENT_PROGRAM)!==this.program&&(t.useProgram(this.program),this.shaderManager.currentShaderUsing=this),this.resetLastBuffersBinded()},Qe.prototype.bindUniformGenerals=function(){if(void 0!==this.uniformsArrayGeneral){for(var t=this.uniformsArrayGeneral.length,e=0;e<t;e++)this.uniformsArrayGeneral[e].bindUniform();this.camera&&this.camera.bindUniforms(this.gl,this)}},Qe.prototype.getUniformDataPair=function(t){return this.uniformsMapGeneral[t]},Qe.prototype.newUniformDataPair=function(t,e){var i;return"Matrix4fv"===t?(i=new ii(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"Vec4fv"===t?(i=new ni(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"Vec3fv"===t?(i=new oi(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"Vec2fv"===t?(i=new ri(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"1f"===t?(i=new ti(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i):"1i"===t&&(i=new ei(this.gl,e),this.uniformsArrayGeneral.push(i),this.uniformsMapGeneral[e]=i),i},Qe.prototype.newUniformDataPairLocal=function(t,e){var i;return"Matrix4fv"===t?(i=new ii(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"Vec4fv"===t?(i=new ni(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"Vec3fv"===t?(i=new oi(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"Vec2fv"===t?(i=new ri(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"1f"===t?(i=new ti(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i):"1i"===t&&(i=new ei(this.gl,e),this.uniformsArrayLocal.push(i),this.uniformsMapLocal[e]=i),i},Qe.prototype.createUniformGenerals=function(t,e,i){var r,o;if(null!==(o=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"))&&void 0!==o&&((r=e.newUniformDataPair("Matrix4fv","mvpMat4RelToEye")).uniformLocation=o,r.matrix4fv=i.modelViewProjRelToEyeMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"ModelViewProjectionMatrix"))&&void 0!==o&&((r=e.newUniformDataPair("Matrix4fv","mvpMat4")).uniformLocation=o,r.matrix4fv=i.modelViewProjMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"))&&void 0!==o&&((r=e.newUniformDataPair("Matrix4fv","mvMat4RelToEye")).uniformLocation=o,r.matrix4fv=i.modelViewRelToEyeMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"modelViewMatrix"))&&void 0!==o&&((r=e.newUniformDataPair("Matrix4fv","modelViewMatrix")).uniformLocation=o,r.matrix4fv=i.modelViewMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"modelViewMatrixInv"))&&void 0!==o){(r=e.newUniformDataPair("Matrix4fv","modelViewMatrixInv")).uniformLocation=o;var n=i.getModelViewMatrixInv();r.matrix4fv=n._floatArrays}null!==(o=t.getUniformLocation(e.program,"projectionMatrix"))&&void 0!==o&&((r=e.newUniformDataPair("Matrix4fv","pMat4")).uniformLocation=o,r.matrix4fv=i.projectionMatrix._floatArrays),null!==(o=t.getUniformLocation(e.program,"normalMatrix4"))&&void 0!==o&&((r=e.newUniformDataPair("Matrix4fv","normalMat4")).uniformLocation=o,r.matrix4fv=i.normalMatrix4._floatArrays),null!==(o=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"))&&void 0!==o&&((r=e.newUniformDataPair("Vec3fv","encodedCamPosHigh")).uniformLocation=o,r.vec3fv=i.encodedCamPosHigh),null!==(o=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"))&&void 0!==o&&((r=e.newUniformDataPair("Vec3fv","encodedCamPosLow")).uniformLocation=o,r.vec3fv=i.encodedCamPosLow),null!==(o=t.getUniformLocation(e.program,"fov"))&&void 0!==o&&((r=e.newUniformDataPair("1f","fovyRad")).uniformLocation=o,r.floatValue=i.camera.frustum.fovyRad),null!==(o=t.getUniformLocation(e.program,"tangentOfHalfFovy"))&&void 0!==o&&((r=e.newUniformDataPair("1f","tangentOfHalfFovy")).uniformLocation=o,r.floatValue=i.camera.frustum.tangentOfHalfFovy),null!==(o=t.getUniformLocation(e.program,"aspectRatio"))&&void 0!==o&&((r=e.newUniformDataPair("1f","aspectRatio")).uniformLocation=o,r.floatValue=i.camera.frustum.aspectRatio),null!==(o=t.getUniformLocation(e.program,"screenWidth"))&&void 0!==o&&((r=e.newUniformDataPair("1f","drawBuffWidht")).uniformLocation=o,r.floatValue=i.drawingBufferWidth),null!==(o=t.getUniformLocation(e.program,"screenHeight"))&&void 0!==o&&((r=e.newUniformDataPair("1f","drawBuffHeight")).uniformLocation=o,r.floatValue=i.drawingBufferHeight),null!==(o=t.getUniformLocation(e.program,"depthTex"))&&void 0!==o&&((r=e.newUniformDataPair("1i","depthTex")).uniformLocation=o,r.intValue=0),null!==(o=t.getUniformLocation(e.program,"noiseTex"))&&void 0!==o&&((r=e.newUniformDataPair("1i","noiseTex")).uniformLocation=o,r.intValue=1),null!==(o=t.getUniformLocation(e.program,"diffuseTex"))&&void 0!==o&&((r=e.newUniformDataPair("1i","diffuseTex")).uniformLocation=o,r.intValue=2),null!==(o=t.getUniformLocation(e.program,"shadowMapTex"))&&void 0!==o&&((r=e.newUniformDataPair("1i","shadowMapTex")).uniformLocation=o,r.intValue=3),null!==(o=t.getUniformLocation(e.program,"shadowMapTex2"))&&void 0!==o&&((r=e.newUniformDataPair("1i","shadowMapTex2")).uniformLocation=o,r.intValue=4),null!==(o=t.getUniformLocation(e.program,"specularColor"))&&void 0!==o&&((r=e.newUniformDataPair("Vec3fv","specularColor")).uniformLocation=o,r.vec3fv=i.specularColor),null!==(o=t.getUniformLocation(e.program,"ambientColor"))&&void 0!==o&&((r=e.newUniformDataPair("Vec3fv","ambientColor")).uniformLocation=o,r.vec3fv=i.ambientColor),null!==(o=t.getUniformLocation(e.program,"radius"))&&void 0!==o&&((r=e.newUniformDataPair("1f","radius")).uniformLocation=o,r.floatValue=i.ssaoRadius),null!==(o=t.getUniformLocation(e.program,"ambientReflectionCoef"))&&void 0!==o&&((r=e.newUniformDataPair("1f","ambientReflectionCoef")).uniformLocation=o,r.floatValue=i.ambientReflectionCoef),null!==(o=t.getUniformLocation(e.program,"diffuseReflectionCoef"))&&void 0!==o&&((r=e.newUniformDataPair("1f","diffuseReflectionCoef")).uniformLocation=o,r.floatValue=i.diffuseReflectionCoef),null!==(o=t.getUniformLocation(e.program,"specularReflectionCoef"))&&void 0!==o&&((r=e.newUniformDataPair("1f","specularReflectionCoef")).uniformLocation=o,r.floatValue=i.specularReflectionCoef),null!==(o=t.getUniformLocation(e.program,"shininessValue"))&&void 0!==o&&((r=e.newUniformDataPair("1f","shininessValue")).uniformLocation=o,r.floatValue=i.shininessValue),null!==(o=t.getUniformLocation(e.program,"noiseScale"))&&void 0!==o&&((r=e.newUniformDataPair("Vec2fv","ssaoNoiseScale2")).uniformLocation=o,r.vec2fv=i.ssaoNoiseScale2),null!==(o=t.getUniformLocation(e.program,"kernel"))&&void 0!==o&&((r=e.newUniformDataPair("Vec3fv","ssaoKernel16")).uniformLocation=o,r.vec3fv=i.ssaoKernel16),this.camera=i.camera},Qe.prototype.bindAttribLocations=function(t,e){t.bindAttribLocation(e.program,0,"position"),t.bindAttribLocation(e.program,1,"normal"),t.bindAttribLocation(e.program,2,"texCoord"),t.bindAttribLocation(e.program,3,"color4")},Qe.prototype.createUniformLocals=function(t,e,i){e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.sunMatrix_loc=t.getUniformLocation(e.program,"sunMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.textureFlipYAxis_loc=t.getUniformLocation(e.program,"textureFlipYAxis"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.sunPosHigh_loc=t.getUniformLocation(e.program,"sunPosHIGH"),e.sunPosLow_loc=t.getUniformLocation(e.program,"sunPosLOW"),e.shadowMapWidth_loc=t.getUniformLocation(e.program,"shadowMapWidth"),e.shadowMapHeight_loc=t.getUniformLocation(e.program,"shadowMapHeight"),e.sunDirWC_loc=t.getUniformLocation(e.program,"sunDirWC"),e.sunIdx_loc=t.getUniformLocation(e.program,"sunIdx"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.texCoord2_loc=t.getAttribLocation(e.program,"texCoord"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.color4_loc=t.getAttribLocation(e.program,"color4"),e.bUse1Color_loc=t.getUniformLocation(e.program,"bUse1Color"),e.oneColor4_loc=t.getUniformLocation(e.program,"oneColor4"),e.bApplySsao_loc=t.getUniformLocation(e.program,"bApplySsao"),e.bApplyShadow_loc=t.getUniformLocation(e.program,"bApplyShadow"),e.bSilhouette_loc=t.getUniformLocation(e.program,"bSilhouette"),e.bApplyClippingPlanes_loc=t.getUniformLocation(e.program,"bApplyClippingPlanes"),e.clippingPlanesCount_loc=t.getUniformLocation(e.program,"clippingPlanesCount"),e.clippingPlanes_loc=t.getUniformLocation(e.program,"clippingPlanes"),e.posDataByteSize_loc=t.getUniformLocation(e.program,"posDataByteSize"),e.texCoordByteSize_loc=t.getUniformLocation(e.program,"texCoordByteSize"),e.compressionMaxPoint_loc=t.getUniformLocation(e.program,"compressionMaxPoint"),e.compressionMinPoint_loc=t.getUniformLocation(e.program,"compressionMinPoint"),e.bApplySpecularLighting_loc=t.getUniformLocation(e.program,"bApplySpecularLighting"),e.colorType_loc=t.getUniformLocation(e.program,"colorType"),e.externalAlpha_loc=t.getUniformLocation(e.program,"externalAlpha"),e.fixPointSize_loc=t.getUniformLocation(e.program,"fixPointSize"),e.bUseFixPointSize_loc=t.getUniformLocation(e.program,"bUseFixPointSize"),e.frustumNear_loc=t.getUniformLocation(e.program,"near"),e.frustumFar_loc=t.getUniformLocation(e.program,"far"),e.scaleLC_loc=t.getUniformLocation(e.program,"scaleLC"),e.colorMultiplier_loc=t.getUniformLocation(e.program,"colorMultiplier"),e.modelViewProjectionMatrixInv_loc=t.getUniformLocation(e.program,"modelViewProjectionMatrixInv"),e.projectionMatrixInv_loc=t.getUniformLocation(e.program,"projectionMatrixInv"),e.modelViewMatrixRelToEyeInv_loc=t.getUniformLocation(e.program,"modelViewMatrixRelToEyeInv"),e.uRenderType_loc=t.getUniformLocation(e.program,"uRenderType"),e.uTime_loc=t.getUniformLocation(e.program,"uTime")};var Je=function(t){if(!(this instanceof Je))throw new Error(ot.CONSTRUCT_ERROR);this.gl,this.pFx_shaders_array=[],this.shadersMap={},this.modelRefShader,this.modelRefSilhouetteShader,this.lodBuildingShader,this.currentShaderUsing=void 0,this.bUseLogarithmicDepth=!1,t&&t.useLogarithmicDepth&&(this.bUseLogarithmicDepth=t.useLogarithmicDepth)};Je.prototype.newShader=function(t){var e=new Qe(this.gl);return e.name=t,e.shaderManager=this,this.shadersMap[t]=e,e},Je.prototype.getCurrentShader=function(){return this.currentShaderUsing},Je.prototype.isCurrentShader=function(t){return this.currentShaderUsing===t},Je.prototype.useProgram=function(t){this.isCurrentShader(t)||(t.useProgram(),this.currentShaderUsing=t)},Je.prototype.getShader=function(t){return this.shadersMap[t]},Je.prototype.createShaderProgram=function(t,e,i,r,o){var n=this.newShader(r);n.program=t.createProgram(),n.shader_vertex=this.createShader(t,e,t.VERTEX_SHADER,"VERTEX"),n.shader_fragment=this.createShader(t,i,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(n.program,n.shader_vertex),t.attachShader(n.program,n.shader_fragment),n.bindAttribLocations(t,n),t.linkProgram(n.program),n.createUniformGenerals(t,n,o.sceneState),n.createUniformLocals(t,n,o.sceneState);for(var a=t.getProgramParameter(n.program,t.ACTIVE_ATTRIBUTES),s=0;s<a;s++){var l=t.getActiveAttrib(n.program,s);n[l.name]=t.getAttribLocation(n.program,l.name)}var h=t.getProgramParameter(n.program,t.ACTIVE_UNIFORMS);for(s=0;s<h;s++){var d=t.getActiveUniform(n.program,s);n[d.name]=t.getUniformLocation(n.program,d.name)}return n},Je.prototype.createShader=function(t,e,i,r){var o=t.createShader(i);return t.shaderSource(o,e),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(alert("ERROR IN "+r+" SHADER : "+t.getShaderInfoLog(o)),!1)},Je.prototype.createDefaultShaders=function(t,e){this.modelRefSilhouetteShader=this.createSilhouetteShaderModelRef(t),this.triPolyhedronShader=this.createSsaoShaderBox(t)},Je.prototype.getModelRefSilhouetteShader=function(){return this.modelRefSilhouetteShader},Je.prototype.getTriPolyhedronDepthShader=function(){return this.triPolyhedronDepthShader},Je.prototype.getTriPolyhedronShader=function(){return this.triPolyhedronShader},Je.prototype.getInvertedBoxShader=function(){return this.invertedBoxShader},Je.prototype.createSilhouetteShaderModelRef=function(t){var e=new Qe(this.gl);e.name="SilhouetteShaderModelRef",this.pFx_shaders_array.push(void 0);var i=$e.SilhouetteVS,r=$e.SilhouetteFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.camSpacePixelTranslation_loc=t.getUniformLocation(e.program,"camSpacePixelTranslation"),e.screenSize_loc=t.getUniformLocation(e.program,"screenSize"),e.ProjectionMatrix_loc=t.getUniformLocation(e.program,"ProjectionMatrix"),e.ModelViewMatrixRelToEye_loc=t.getUniformLocation(e.program,"ModelViewMatrixRelToEye"),e},Je.prototype.createSsaoShaderBox=function(t){var e=new Qe(this.gl);this.pFx_shaders_array.push(e);var i=$e.BoxSsaoVS,r=$e.BoxSsaoFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewMatrix4RelToEye_loc=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.normalMatrix4_loc=t.getUniformLocation(e.program,"normalMatrix4"),e.projectionMatrix4_loc=t.getUniformLocation(e.program,"projectionMatrix"),e.modelViewMatrix4_loc=t.getUniformLocation(e.program,"modelViewMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.bUse1Color_loc=t.getUniformLocation(e.program,"bUse1Color"),e.oneColor4_loc=t.getUniformLocation(e.program,"oneColor4"),e.bUseNormal_loc=t.getUniformLocation(e.program,"bUseNormal"),e.bScale_loc=t.getUniformLocation(e.program,"bScale"),e.scale_loc=t.getUniformLocation(e.program,"scale"),t.bindAttribLocation(e.program,0,"position"),t.bindAttribLocation(e.program,1,"normal"),t.bindAttribLocation(e.program,2,"texCoord"),t.bindAttribLocation(e.program,3,"color4"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.color4_loc=t.getAttribLocation(e.program,"color4"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.normal=t.getAttribLocation(e.program,"normal"),e.attribLocationCacheObj.color4=t.getAttribLocation(e.program,"color4"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.near_loc=t.getUniformLocation(e.program,"near"),e.far_loc=t.getUniformLocation(e.program,"far"),e.fov_loc=t.getUniformLocation(e.program,"fov"),e.aspectRatio_loc=t.getUniformLocation(e.program,"aspectRatio"),e.screenWidth_loc=t.getUniformLocation(e.program,"screenWidth"),e.screenHeight_loc=t.getUniformLocation(e.program,"screenHeight"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.depthTex_loc=t.getUniformLocation(e.program,"depthTex"),e.noiseTex_loc=t.getUniformLocation(e.program,"noiseTex"),e.diffuseTex_loc=t.getUniformLocation(e.program,"diffuseTex"),e.useRefTransfMatrix_loc=t.getUniformLocation(e.program,"useRefTransfMatrix"),e.useTexture_loc=t.getUniformLocation(e.program,"useTexture"),e.invertNormals_loc=t.getUniformLocation(e.program,"invertNormals"),e},Je.prototype.createInvertedBoxShader=function(t){var e=new Qe(this.gl);this.pFx_shaders_array.push(void 0);var i=$e.InvertedBoxVS,r=$e.InvertedBoxFS;return e.program=t.createProgram(),e.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),e.shader_fragment=this.createShader(t,r,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(e.program,e.shader_vertex),t.attachShader(e.program,e.shader_fragment),e.bindAttribLocations(t,e),t.linkProgram(e.program),e.cameraPosHIGH_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCHigh"),e.cameraPosLOW_loc=t.getUniformLocation(e.program,"encodedCameraPositionMCLow"),e.buildingPosHIGH_loc=t.getUniformLocation(e.program,"buildingPosHIGH"),e.buildingPosLOW_loc=t.getUniformLocation(e.program,"buildingPosLOW"),e.modelViewMatrix4RelToEye_loc=t.getUniformLocation(e.program,"modelViewMatrixRelToEye"),e.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(e.program,"ModelViewProjectionMatrixRelToEye"),e.normalMatrix4_loc=t.getUniformLocation(e.program,"normalMatrix4"),e.projectionMatrix4_loc=t.getUniformLocation(e.program,"projectionMatrix"),e.refMatrix_loc=t.getUniformLocation(e.program,"RefTransfMatrix"),e.buildingRotMatrix_loc=t.getUniformLocation(e.program,"buildingRotMatrix"),e.refMatrixType_loc=t.getUniformLocation(e.program,"refMatrixType"),e.refTranslationVec_loc=t.getUniformLocation(e.program,"refTranslationVec"),e.position3_loc=t.getAttribLocation(e.program,"position"),e.texCoord2_loc=t.getAttribLocation(e.program,"texCoord"),e.normal3_loc=t.getAttribLocation(e.program,"normal"),e.attribLocationCacheObj.position=t.getAttribLocation(e.program,"position"),e.attribLocationCacheObj.texCoord=t.getAttribLocation(e.program,"texCoord"),e.attribLocationCacheObj.normal=t.getAttribLocation(e.program,"normal"),e.aditionalMov_loc=t.getUniformLocation(e.program,"aditionalPosition"),e.noiseScale2_loc=t.getUniformLocation(e.program,"noiseScale"),e.kernel16_loc=t.getUniformLocation(e.program,"kernel"),e.near_loc=t.getUniformLocation(e.program,"near"),e.far_loc=t.getUniformLocation(e.program,"far"),e.fov_loc=t.getUniformLocation(e.program,"fov"),e.aspectRatio_loc=t.getUniformLocation(e.program,"aspectRatio"),e.screenWidth_loc=t.getUniformLocation(e.program,"screenWidth"),e.screenHeight_loc=t.getUniformLocation(e.program,"screenHeight"),e.shininessValue_loc=t.getUniformLocation(e.program,"shininessValue"),e.hasTexture_loc=t.getUniformLocation(e.program,"hasTexture"),e.color4Aux_loc=t.getUniformLocation(e.program,"vColor4Aux"),e.textureFlipYAxis_loc=t.getUniformLocation(e.program,"textureFlipYAxis"),e.depthTex_loc=t.getUniformLocation(e.program,"depthTex"),e.noiseTex_loc=t.getUniformLocation(e.program,"noiseTex"),e.diffuseTex_loc=t.getUniformLocation(e.program,"diffuseTex"),e.specularColor_loc=t.getUniformLocation(e.program,"specularColor"),e.ssaoRadius_loc=t.getUniformLocation(e.program,"radius"),e.ambientReflectionCoef_loc=t.getUniformLocation(e.program,"ambientReflectionCoef"),e.diffuseReflectionCoef_loc=t.getUniformLocation(e.program,"diffuseReflectionCoef"),e.specularReflectionCoef_loc=t.getUniformLocation(e.program,"specularReflectionCoef"),e};var $e={atmosphereFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;\nuniform bool bIsMakingDepth;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \n\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\nvarying float depthValue;\nvarying vec3 v3Pos;\nvarying vec3 camPos;\nvarying vec4 vcolor4;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nuniform float externalAlpha;\nconst float equatorialRadius = 6378137.0;\nconst float polarRadius = 6356752.3142;\nconst float PI = 3.1415926535897932384626433832795;\nconst float PI_2 = 1.57079632679489661923; \nconst float PI_4 = 0.785398163397448309616;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n} \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}               \n\n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{  \n\tif(bIsMakingDepth)\n\t{\n\t\tgl_FragColor = packDepth(-depthValue);\n\t}\n\telse{\n\t\tvec4 textureColor = oneColor4;\n\t\tif(colorType == 0)\n\t\t{\n\t\t\ttextureColor = oneColor4;\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse if(colorType == 2)\n\t\t{\n\t\t\t//if(textureFlipYAxis)\n\t\t\t//{\n\t\t\t//\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t//}\n\t\t\t//else{\n\t\t\t//\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\t//}\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse{\n\t\t\ttextureColor = oneColor4;\n\t\t}\n\t\t\n\t\tgl_FragColor = vcolor4; \n\t}\n}",atmosphereVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bIsMakingDepth;\nuniform float near;\nuniform float far;\n\nvarying vec3 vNormal;\nvarying vec3 v3Pos;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 vertexPos;\nvarying float depthValue;\nvarying vec3 camPos;\n\nconst float equatorialRadius = 6378137.0;\nconst float polarRadius = 6356752.3142;\nconst float PI = 3.1415926535897932384626433832795;\nconst float PI_2 = 1.57079632679489661923; \nconst float PI_4 = 0.785398163397448309616;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\tvNormal = (normalMatrix4 * vec4(normal, 1.0)).xyz;\n\n\tif(bIsMakingDepth)\n\t{\n\t\tdepthValue = (modelViewMatrixRelToEye * pos4).z/far;\n\t}\n\telse\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tcamPos = encodedCameraPositionMCHigh.xyz + encodedCameraPositionMCLow.xyz;\n\tv3Pos = vec3((modelViewMatrixRelToEye * pos4).xyz);\n\n\t// Calculate color.\n\tfloat distToCam = length(vec3(v3Pos));\n\tvec3 camDir = normalize(vec3(v3Pos.x, v3Pos.y, v3Pos.z));\n\tvec3 normal = vNormal;\n\tfloat angRad = acos(dot(camDir, normal));\n\tfloat angDeg = angRad*180.0/PI;\n\t/*\n\tif(angDeg > 130.0)\n\t\ttextureColor = vec4(1.0, 0.0, 0.0, 1.0);\n\telse if(angDeg > 120.0)\n\t\ttextureColor = vec4(0.0, 1.0, 0.0, 1.0);\n\telse if(angDeg > 110.0)\n\t\ttextureColor = vec4(0.0, 0.0, 1.0, 1.0);\n\telse if(angDeg > 100.0)\n\t\ttextureColor = vec4(1.0, 1.0, 0.0, 1.0);\n\telse if(angDeg > 90.0)\n\t\ttextureColor = vec4(1.0, 0.0, 1.0, 1.0);\n\t\t*/\n\t\t\n\t//textureColor = vec4(vNormal, 1.0);\n\n\t//float maxAngDeg = 100.5;\n\tfloat maxAngDeg = 101.2;\n\tfloat minAngDeg = 90.0;\n\n\tfloat A = 1.0/(maxAngDeg-minAngDeg);\n\tfloat B = -A*minAngDeg;\n\tfloat alphaReal = A*angDeg+B;\n\tfloat alpha2 = alphaReal*alphaReal;\n\tfloat alpha = alpha2*alpha2;\n\tif(alpha < 0.0 )\n\talpha = 0.0;\n\telse if(alpha > 2.0 )\n\talpha = 2.0;\n\t\n\tfloat alphaPlusPerDist = 4.0*(distToCam/equatorialRadius);\n\tif(alphaPlusPerDist > 1.0)\n\talphaPlusPerDist = 1.0;\n\n\tfloat extra = (1.0-alpha);\n\tif(extra < 0.0)\n\textra = 0.0;\n\n\tfloat extraPerDist = (1.0-alphaPlusPerDist); // near -> more blue.\n\n\talpha *= alphaPlusPerDist;\n\tvcolor4 = vec4(alpha*0.75, alpha*0.88 + extra*0.4 + extraPerDist*0.1, alpha + extra*2.5 + extraPerDist*0.8, alpha);\n}",BlendingCubeFS:"\tprecision lowp float;\n\tvarying vec4 vColor;\n\n\tvoid main()\n    {\n\t\tgl_FragColor = vColor;\n\t}",BlendingCubeVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nattribute vec4 color;\nvarying vec4 vColor;\n\nvoid main()\n{\n    vec3 highDifference = -encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = position.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(position.xyz, 1.0);\n\n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",BlurFS:"#ifdef GL_ES\n    precision highp float;\n    #endif\nuniform sampler2D colorTex;\nuniform vec2 texelSize;\nvarying vec2 vTexCoord; \t \t\n\nvoid main()\n{\n    vec3 result = vec3(0.0);\n    for (int i = 0; i < 4; ++i) {\n        for (int j = 0; j < 4; ++j) {\n            vec2 offset = vec2(texelSize.x * float(j), texelSize.y * float(i));\n            result += texture2D(colorTex, vTexCoord + offset).rgb;\n        }\n    }\n            \n    gl_FragColor.rgb = vec3(result * 0.0625); \n    gl_FragColor.a = 1.0;\n}\n",BlurVS:"attribute vec4 position;\nattribute vec2 texCoord;\n\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;  \n\nvarying vec2 vTexCoord;\n\nvoid main()\n{\t\n    vTexCoord = texCoord;\n    \n    gl_Position = projectionMatrix * modelViewMatrix * position;\n}\n",BoxSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\nuniform bool bUseNormal;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nconst int kernelSize = 16;  \nconst float radius = 0.5;      \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{                          \n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{ \n\tvec4 textureColor;\n\ttextureColor = vcolor4;  \n\tif(bUseNormal)\n    {\n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\tfloat linearDepth = getDepth(screenPos);          \n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\t\tvec3 normal2 = vNormal;   \n\t\t\t\t\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\t\t\n\t\tfloat occlusion = 0.0;\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\tvec3 sample = origin + (tbn * kernel[i]) * radius;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n\t\t\tif (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t\t\n\t\t}   \n\t\t\t\n\t\tocclusion = 1.0 - occlusion / float(kernelSize);\n\t\t\t\t\t\t\t\t\t\n\t\tvec3 lightPos = vec3(10.0, 10.0, 10.0);\n\t\tvec3 L = normalize(lightPos);\n\t\tfloat DiffuseFactor = dot(normal2, L);\n\t\tfloat NdotL = abs(DiffuseFactor);\n\t\tvec3 diffuse = vec3(NdotL);\n\t\tvec3 ambient = vec3(1.0);\n\t\tgl_FragColor.rgb = vec3((textureColor.xyz)*vLightWeighting * occlusion); \n\t\tgl_FragColor.a = 1.0; \n\t}\n\telse\n\t{\n\t\tgl_FragColor.rgb = vec3(textureColor.xyz); \n\t\tgl_FragColor.a = 1.0; \n\t}\t\n}\n",BoxSsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool bUseNormal;\nuniform vec3 scale;\nuniform bool bScale;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;  \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec4 position2 = vec4(position.xyz, 1.0);\n    if(bScale)\n    {\n        position2.x *= scale.x;\n        position2.y *= scale.y;\n        position2.z *= scale.z;\n    }\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    if(bUseNormal)\n    {\n\t\tvec4 rotatedNormal = buildingRotMatrix * vec4(normal.xyz, 1.0);\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8, 0.8, 0.8);\n\t\tvec3 uLightingDirection = vec3(0.5, 0.5, 0.5);\n\t\tvec3 directionalLightColor = vec3(0.6, 0.6, 0.6);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t}\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",CloudFS:"precision lowp float;\nvarying vec3 vColor;\n\nvoid main()\n{\n    gl_FragColor = vec4(vColor, 1.);\n}",CloudVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 cloudPosHIGH;\nuniform vec3 cloudPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nattribute vec3 color;\nvarying vec3 vColor;\n\nvoid main()\n{\n    vec3 objPosHigh = cloudPosHIGH;\n    vec3 objPosLow = cloudPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",ColorFS:"precision mediump float;\nuniform int byteColor_r;\nuniform int byteColor_g;\nuniform int byteColor_b;\n\nvoid main()\n{\n    float byteMaxValue = 255.0;\n\n    gl_FragColor = vec4(float(byteColor_r)/byteMaxValue, float(byteColor_g)/byteMaxValue, float(byteColor_b)/byteMaxValue, 1);\n}\n",ColorSelectionSsaoFS:"precision highp float;\nuniform vec4 oneColor4;\n\nvoid main()\n{          \n    gl_FragColor = oneColor4;\n}\n",ColorSelectionSsaoVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvoid main()\n{\n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    gl_PointSize = 10.0;\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",ColorVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 RefTransfMatrix;\n\nvoid main()\n{\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}\n",draw_frag:"precision mediump float;\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\t\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tfloat r = speed_t;\n\t\tgl_FragColor = vec4(r,g,b,1.0);\n\t}\n\telse{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\tgl_FragColor = vec4(intensity,intensity,intensity,1.0);\n\t}\n}\n",draw_frag3D:"precision highp float;\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\nuniform float u_tailAlpha;\nuniform float u_externAlpha;\n\nvarying vec2 v_particle_pos;\n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat minHeight_rainbow = 0.0;\n\tfloat maxHeight_rainbow = 1.0;\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\nvoid main() {\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\t\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tvec3 col3 = getRainbowColor_byHeight(speed_t);\n\t\tfloat r = speed_t;\n\t\tgl_FragColor = vec4(col3.x, col3.y, col3.z ,u_tailAlpha*u_externAlpha);\n\t}\n\telse{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\tgl_FragColor = vec4(intensity,intensity,intensity,u_tailAlpha*u_externAlpha);\n\t}\n}",draw_vert:"precision mediump float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n    gl_PointSize = 1.0;\n    gl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n}\n",draw_vert3D:"precision highp float;\n\n// This shader draws windParticles in 3d directly from positions on u_particles image.***\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 u_camPosWC;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float pendentPointSize;\nuniform float u_tailAlpha;\nuniform float u_layerAltitude;\n\nvarying vec2 v_particle_pos;\n\n#define M_PI 3.1415926535897932384626433832795\n\nvec2 splitValue(float value)\n{\n\tfloat doubleHigh;\n\tvec2 resultSplitValue;\n\tif (value >= 0.0) \n\t{\n\t\tdoubleHigh = floor(value / 65536.0) * 65536.0; //unsigned short max\n\t\tresultSplitValue.x = doubleHigh;\n\t\tresultSplitValue.y = value - doubleHigh;\n\t}\n\telse \n\t{\n\t\tdoubleHigh = floor(-value / 65536.0) * 65536.0;\n\t\tresultSplitValue.x = -doubleHigh;\n\t\tresultSplitValue.y = value + doubleHigh;\n\t}\n\t\n\treturn resultSplitValue;\n}\n\t\nvec3 geographicToWorldCoord(float lonRad, float latRad, float alt)\n{\n\t// defined in the LINZ standard LINZS25000 (Standard for New Zealand Geodetic Datum 2000)\n\t// https://www.linz.govt.nz/data/geodetic-system/coordinate-conversion/geodetic-datum-conversions/equations-used-datum\n\t// a = semi-major axis.\n\t// e2 = firstEccentricitySquared.\n\t// v = a / sqrt(1 - e2 * sin2(lat)).\n\t// x = (v+h)*cos(lat)*cos(lon).\n\t// y = (v+h)*cos(lat)*sin(lon).\n\t// z = [v*(1-e2)+h]*sin(lat).\n\tfloat equatorialRadius = 6378137.0; // meters.\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat cosLon = cos(lonRad);\n\tfloat cosLat = cos(latRad);\n\tfloat sinLon = sin(lonRad);\n\tfloat sinLat = sin(latRad);\n\tfloat a = equatorialRadius;\n\tfloat e2 = firstEccentricitySquared;\n\tfloat v = a/sqrt(1.0 - e2 * sinLat * sinLat);\n\tfloat h = alt;\n\t\n\tfloat x = (v+h)*cosLat*cosLon;\n\tfloat y = (v+h)*cosLat*sinLon;\n\tfloat z = (v*(1.0-e2)+h)*sinLat;\n\t\n\t\n\tvec3 resultCartesian = vec3(x, y, z);\n\t\n\treturn resultCartesian;\n}\n\nvoid main() {\n\t\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n\t// Now, must calculate geographic coords of the pos2d.***\n\tfloat altitude = u_layerAltitude;\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\tfloat longitudeRad = -minLonRad + v_particle_pos.x * lonRadRange;\n\tfloat latitudeRad = maxLatRad - v_particle_pos.y * latRadRange;\n\t\n\t// Now, calculate worldPosition of the geographicCoords (lon, lat, alt).***\n\t//vec3 posWC = geographicToWorldCoord(longitudeRad, latitudeRad, altitude);\n\t//vec4 posCC = vec4((posWC - encodedCameraPositionMCHigh) - encodedCameraPositionMCLow, 1.0);\n\t\n\t// Alternative.\n\t\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tfloat distortion = cos((minLatRad + v_particle_pos.y * latRadRange ));\n\tfloat xOffset = (v_particle_pos.x - 0.5)*distortion * lonRadRange * radius;\n\tfloat yOffset = (0.5 - v_particle_pos.y) * latRadRange * radius;\n\tvec4 rotatedPos = buildingRotMatrix * vec4(xOffset, yOffset, 0.0, 1.0);\n\t\n\t\n\tvec4 posWC = vec4((rotatedPos.xyz+buildingPosLOW) +( buildingPosHIGH ), 1.0);\n\tvec4 posCC = vec4((rotatedPos.xyz+buildingPosLOW- encodedCameraPositionMCLow) +( buildingPosHIGH- encodedCameraPositionMCHigh), 1.0);\n\t\n\t// Now calculate the position on camCoord.***\n\t//gl_Position = ModelViewProjectionMatrix * posWC;\n\tgl_Position = ModelViewProjectionMatrixRelToEye * posCC;\n\t//gl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n\t//gl_Position = vec4(v_particle_pos.x, v_particle_pos.y, 0, 1);\n\t\n\t// Now calculate the point size.\n\tfloat dist = distance(vec4(u_camPosWC.xyz, 1.0), vec4(posWC.xyz, 1.0));\n\tgl_PointSize = (1.0 + pendentPointSize/(dist))*u_tailAlpha; \n\t\n\tif(gl_PointSize > 10.0)\n\tgl_PointSize = 10.0;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",filterSilhouetteFS:"precision mediump float;\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform mat4 projectionMatrix;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \n\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tvec3 normal2 = vec3(0.0, 0.0, 1.0);\n\tfloat radiusAux = radius * 5.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\tfloat linearDepth = getDepth(screenPos); \n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\t\t\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\t//vec3 sample = origin + (tbn * kernel[i]) * radiusAux;\n\t\t\tvec3 sample = origin + (kernel[i]) * radiusAux;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\tif(sampleDepth > 0.49)\n\t\t\t\tcontinue;\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\n\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)+radiusAux*0.998;\n\t\t\tif (range_check > radius*1.001 && depthBufferValue <= sampleDepth)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t}   \n\t\t\n\t\tif(occlusion > float(kernelSize)*0.4)\n\t\t{\n\t\t\tocclusion = occlusion / float(kernelSize);\n\t\t}\n\t\telse{\n\t\t\tocclusion = 0.0;\n\t\t}\n\t\t//occlusion = 1.0 - occlusion / float(kernelSize);\n\t}\n\telse{\n\t\tocclusion = 0.0;\n\t}\n\n    vec4 finalColor;\n\tfinalColor = vec4(1.0, 1.0, 1.0, occlusion*0.9);\n    gl_FragColor = finalColor; \n}\n",ImageViewerRectangleShaderFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\nuniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nvarying float applySpecLighting;\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}  \n\nfloat UnpackDepth32( in vec4 pack )\n{\n    float depth = dot( pack, 1.0 / vec4(1.0, 256.0, 256.0*256.0, 16777216.0) ); // 256.0*256.0*256.0 = 16777216.0\n    return depth * (16777216.0) / (16777216.0 - 1.0);\n}              \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return UnpackDepth32(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tvec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\tfloat alfa = externalAlpha;\n\tfloat depth = UnpackDepth32(textureColor);\n\t\n    vec4 finalColor;\n\tfinalColor = vec4(depth, depth, depth, alfa);\n\n\t//finalColor = vec4(vNormal, 1.0); // test to render normal color coded.***\n    gl_FragColor = finalColor; \n}",ImageViewerRectangleShaderVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying float applySpecLighting;\n\tvarying vec4 aColor4; // color from attributes\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\t//vertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\t\n\t\tif(colorType == 1)\n\t\t\taColor4 = color4;\n\t}",InvertedBoxFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;\n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec3 lightPos = vec3(20.0, 60.0, 20.0);\n    vec3 L = normalize(lightPos - vertexPos);\n    float lambertian = max(dot(normal2, L), 0.0);\n    float specular = 0.0;\n    if(lambertian > 0.0)\n    {\n        vec3 R = reflect(-L, normal2);      // Reflected light vector\n        vec3 V = normalize(-vertexPos); // Vector to viewer\n        \n        // Compute the specular term\n        float specAngle = max(dot(R, V), 0.0);\n        specular = pow(specAngle, shininessValue);\n    }\n\t\n\tif(lambertian < 0.5)\n    {\n\t\tlambertian = 0.5;\n\t}\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vColor4Aux;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\n    gl_FragColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, 1.0); \n}\n",InvertedBoxVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t}\n",ModelRefSsaoFS:'\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform sampler2D shadowMapTex;\nuniform sampler2D shadowMapTex2;\nuniform bool textureFlipYAxis;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;   \nuniform float shadowMapWidth;    \nuniform float shadowMapHeight; \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\n\nuniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform vec3 specularColor;\nuniform vec3 ambientColor;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nuniform bool bApplySsao;\nuniform bool bApplyShadow;\nuniform float externalAlpha;\nuniform vec4 colorMultiplier;\nuniform bool bUseLogarithmicDepth;\n\n//uniform int sunIdx;\n\n// clipping planes.***\n//uniform bool bApplyClippingPlanes;\n//uniform int clippingPlanesCount;\n//uniform vec4 clippingPlanes[6];\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec3 diffuseColor;\nvarying vec3 vertexPos;\nvarying float applySpecLighting;\nvarying vec4 vPosRelToLight; \nvarying vec3 vLightDir; \nvarying vec3 vNormalWC;\nvarying float currSunIdx; \nvarying float discardFrag;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}  \n\n\nfloat UnpackDepth32( in vec4 pack )\n{\n\tfloat depth = dot( pack, vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605) );\n    return depth * 1.000000059605;// 1.000000059605 = (16777216.0) / (16777216.0 - 1.0);\n}             \n\nvec3 getViewRay(vec2 tc)\n{\n\t/*\n\t// The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\tfloat farForDepth = 30000.0;\n\tfloat hfar = 2.0 * tangentOfHalfFovy * farForDepth;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -farForDepth);  \n\t*/\t\n\t\n\t\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n\t\n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n\treturn unpackDepth(texture2D(depthTex, coord.xy));\n}   \n\nfloat getDepthShadowMap(vec2 coord)\n{\n\t// currSunIdx\n\tif(currSunIdx > 0.0 && currSunIdx < 1.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex, coord.xy));\n\t}\n    else if(currSunIdx > 1.0 && currSunIdx < 2.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex2, coord.xy));\n\t}\n\telse\n\t\treturn -1.0;\n}  \n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvoid main()\n{\n\t//gl_FragColor = vColor4; \n\t//return;\n\t// 1rst, check if there are clipping planes.\n\t/*\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = true;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(discardFrag)\n\t\tdiscard;\n\t}\n\t*/\n\n\t//bool testBool = false;\n\tfloat occlusion = 1.0; // ambient occlusion.***\n\tfloat shadow_occlusion = 1.0;\n\tvec3 normal2 = vNormal;\t\n\t\t\n\tif(bApplySsao)\n\t{        \n\t\t////float farForDepth = 30000.0;\n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat linearDepth = getDepth(screenPos);  \n\t\tvec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t\tvec3 origin = ray * linearDepth;  \n\t\tfloat tolerance = radius/far; // original.***\n\t\t////float tolerance = radius/(far-near);// test.***\n\t\t////float tolerance = radius/farForDepth;\n\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);   \n\t\tfloat minDepthBuffer;\n\t\tfloat maxDepthBuffer;\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\tvec3 sample = origin + (tbn * vec3(kernel[i].x*1.0, kernel[i].y*1.0, kernel[i].z)) * radius*2.0;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\t\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;  \t\t\t\t\n\t\t\tfloat sampleDepth = -sample.z/far;// original.***\n\t\t\t////float sampleDepth = -sample.z/(far-near);// test.***\n\t\t\t////float sampleDepth = -sample.z/farForDepth;\n\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\n\n\t\t\tif(depthBufferValue > 0.00391 && depthBufferValue < 0.00393)\n\t\t\t{\n\t\t\t\tif (depthBufferValue < sampleDepth-tolerance*1000.0)\n\t\t\t\t{\n\t\t\t\t\tocclusion +=  0.5;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tcontinue;\n\t\t\t}\t\t\t\n\t\t\t\n\t\t\tif (depthBufferValue < sampleDepth-tolerance)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t} \n\n\t\tocclusion = 1.0 - occlusion / float(kernelSize);\t\n\t}\n\t\n    // Do specular lighting.***\n\tfloat lambertian;\n\tfloat specular;\n\t\n\tif(applySpecLighting> 0.0)\n\t{\n\t\tvec3 L;\n\t\tif(bApplyShadow)\n\t\t{\n\t\t\tL = vLightDir;// test.***\n\t\t\tlambertian = max(dot(normal2, L), 0.0); // original.***\n\t\t\t//lambertian = max(dot(vNormalWC, L), 0.0); // test.\n\t\t}\n\t\telse\n\t\t{\n\t\t\tvec3 lightPos = vec3(1.0, 1.0, 1.0);\n\t\t\tL = normalize(lightPos - vertexPos);\n\t\t\tlambertian = max(dot(normal2, L), 0.0);\n\t\t}\n\t\t\n\t\tspecular = 0.0;\n\t\tif(lambertian > 0.0)\n\t\t{\n\t\t\tvec3 R = reflect(-L, normal2);      // Reflected light vector\n\t\t\tvec3 V = normalize(-vertexPos); // Vector to viewer\n\t\t\t\n\t\t\t// Compute the specular term\n\t\t\tfloat specAngle = max(dot(R, V), 0.0);\n\t\t\tspecular = pow(specAngle, shininessValue);\n\t\t\t\n\t\t\tif(specular > 1.0)\n\t\t\t{\n\t\t\t\tspecular = 1.0;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif(lambertian < 0.5)\n\t\t{\n\t\t\tlambertian = 0.5;\n\t\t}\n\n\t}\n\t\n\tif(bApplyShadow)\n\t{\n\t\tif(currSunIdx > 0.0)\n\t\t{\n\t\t\tfloat ligthAngle = dot(vLightDir, vNormalWC);\n\t\t\tif(ligthAngle > 0.0)\n\t\t\t{\n\t\t\t\t// The angle between the light direction & face normal is less than 90 degree, so, the face is in shadow.***\n\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvec3 posRelToLight = vPosRelToLight.xyz / vPosRelToLight.w;\n\t\t\t\tfloat tolerance = 0.9963;\n\t\t\t\tposRelToLight = posRelToLight * 0.5 + 0.5; // transform to [0,1] range\n\t\t\t\tif(posRelToLight.x >= 0.0 && posRelToLight.x <= 1.0)\n\t\t\t\t{\n\t\t\t\t\tif(posRelToLight.y >= 0.0 && posRelToLight.y <= 1.0)\n\t\t\t\t\t{\n\t\t\t\t\t\tfloat depthRelToLight = getDepthShadowMap(posRelToLight.xy);\n\t\t\t\t\t\tif(posRelToLight.z > depthRelToLight*tolerance )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// test. Calculate the zone inside the pixel.************************************\n\t\t\t\t//https://docs.microsoft.com/ko-kr/windows/win32/dxtecharts/cascaded-shadow-maps\n\t\t\t}\n\t\t}\n\t}\n\t\n\n    vec4 textureColor;\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\t\n\t//textureColor = vec4(0.85, 0.85, 0.85, 1.0);\n\t\n\tvec3 ambientColorAux = vec3(textureColor.x*ambientColor.x, textureColor.y*ambientColor.y, textureColor.z*ambientColor.z);\n\tfloat alfa = textureColor.w * externalAlpha;\n\n    vec4 finalColor;\n\tif(applySpecLighting> 0.0)\n\t{\n\t\tfinalColor = vec4((ambientReflectionCoef * ambientColorAux + \n\t\t\t\t\t\t\tdiffuseReflectionCoef * lambertian * textureColor.xyz + \n\t\t\t\t\t\t\tspecularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion * shadow_occlusion, alfa); \n\t}\n\telse{\n\t\tfinalColor = vec4((textureColor.xyz) * occlusion * shadow_occlusion, alfa);\n\t}\n\t\n\t//if(testBool)\n\t//finalColor *= vec4(0.99, 0.33, 0.32, 1.0);\n\t\n\tfinalColor *= colorMultiplier;\n\n\n\t//finalColor = vec4(linearDepth, linearDepth, linearDepth, 1.0); // test to render depth color coded.***\n    gl_FragColor = finalColor; \n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}',ModelRefSsaoVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform mat4 sunMatrix[2]; \n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 sunPosHIGH[2];\n\tuniform vec3 sunPosLOW[2];\n\tuniform int sunIdx;\n\tuniform vec3 sunDirWC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bApplyShadow;\n\tuniform bool bUseLogarithmicDepth;\n\t\n\t// clipping planes.***\n\tuniform mat4 clippingPlanesRotMatrix; \n\tuniform vec3 clippingPlanesPosHIGH;\n\tuniform vec3 clippingPlanesPosLOW;\n\tuniform bool bApplyClippingPlanes;\n\tuniform int clippingPlanesCount;\n\tuniform vec4 clippingPlanes[6];\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying float applySpecLighting;\n\tvarying vec4 vColor4; // color from attributes\n\tvarying vec4 vPosRelToLight; \n\tvarying vec3 vLightDir; \n\tvarying vec3 vNormalWC; \n\tvarying float currSunIdx;  \n\tvarying float discardFrag;\n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\t\n\tbool clipVertexByPlane(in vec4 plane, in vec3 point)\n\t{\n\t\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\t\n\t\tif(dist < 0.0)\n\t\treturn true;\n\t\telse return false;\n\t}\n\t\n\tvoid main()\n    {\t\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\t\t// Check if clipping.********************************************\n\t\tif(bApplyClippingPlanes)\n\t\t{\n\t\t\tdiscardFrag = 1.0; // true.\n\t\t\tfor(int i=0; i<6; i++)\n\t\t\t{\n\t\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\t\t\n\t\t\t\t// calculate any point of the plane.\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t\t{\n\t\t\t\t\tdiscardFrag = -1.0; // false.\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif(i >= clippingPlanesCount)\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\t//if(discardFrag)\n\t\t\t//discard;\n\t\t}\n\t\t//----------------------------------------------------------------\n\t\t\n\t\tvec3 uLightingDirection = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496); \n\t\tuAmbientColor = vec3(1.0);\n\t\tvNormalWC = rotatedNormal;\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\t\tvLightDir = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tfloat directionalLightWeighting = 1.0;\n\t\t\n\t\tcurrSunIdx = -1.0; // initially no apply shadow.\n\t\tif(bApplyShadow)\n\t\t{\n\t\t\t//vLightDir = normalize(vec3(normalMatrix4 * vec4(sunDirWC.xyz, 1.0)).xyz); // test.***\n\t\t\tvLightDir = sunDirWC;\n\t\t\tvNormalWC = rotatedNormal;\n\t\t\t\t\t\t\n\t\t\t// the sun lights count are 2.\n\t\t\t\n\t\t\tvec3 currSunPosLOW;\n\t\t\tvec3 currSunPosHIGH;\n\t\t\tmat4 currSunMatrix;\n\t\t\tif(sunIdx == 0)\n\t\t\t{\n\t\t\t\tcurrSunPosLOW = sunPosLOW[0];\n\t\t\t\tcurrSunPosHIGH = sunPosHIGH[0];\n\t\t\t\tcurrSunMatrix = sunMatrix[0];\n\t\t\t\tcurrSunIdx = 0.5;\n\t\t\t}\n\t\t\telse if(sunIdx == 1)\n\t\t\t{\n\t\t\t\tcurrSunPosLOW = sunPosLOW[1];\n\t\t\t\tcurrSunPosHIGH = sunPosHIGH[1];\n\t\t\t\tcurrSunMatrix = sunMatrix[1];\n\t\t\t\tcurrSunIdx = 1.5;\n\t\t\t}\n\t\t\t\n\t\t\t// Calculate the vertex relative to light.***\n\t\t\tvec3 highDifferenceSun = objPosHigh.xyz - currSunPosHIGH.xyz;\n\t\t\tvec3 lowDifferenceSun = objPosLow.xyz - currSunPosLOW.xyz;\n\t\t\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\t\t\tvPosRelToLight = currSunMatrix * pos4Sun;\n\t\t\t\n\t\t\tuLightingDirection = sunDirWC; \n\t\t\t//directionalLightColor = vec3(0.9, 0.9, 0.9);\n\t\t\tdirectionalLightWeighting = max(dot(rotatedNormal, -sunDirWC), 0.0);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tuAmbientColor = vec3(0.8);\n\t\t\tuLightingDirection = normalize(vec3(0.6, 0.6, 0.6));\n\t\t\tdirectionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\t}\n\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\n\t\t\t// https://www.gamasutra.com/blogs/BranoKemen/20090812/85207/Logarithmic_Depth_Buffer.php\n\t\t\t// z = log(C*z + 1) / log(C*Far + 1) * w\n\t\t\t/*\n\t\t\tif(orthoPos.z < 0.0)\n\t\t\t{\n\t\t\t\tfloat z = gl_Position.z;\n\t\t\t\tfloat C = 0.001;\n\t\t\t\tfloat w = gl_Position.w;\n\t\t\t\t//gl_Position.z = (2.0*log(C*w + 1.0) / log(C*far + 1.0) - 1.0) * w; // https://outerra.blogspot.com/2009/08/logarithmic-z-buffer.html\n\t\t\t\tgl_Position.z = 2.0*log(z/near) / log(far/near)-1.0; // another way.\n\t\t\t\tgl_Position.z *= w;\n\t\t\t}\n\t\t\t*/\n\t\t\t//https://www.shaderific.com/blog/2014/3/13/tutorial-how-to-update-a-shader-for-opengl-es-30\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\t//if(orthoPos.z < 0.0)\n\t\t//aColor4 = vec4(1.0, 0.0, 0.0, 1.0);\n\t\t//else\n\t\t//aColor4 = vec4(0.0, 1.0, 0.0, 1.0);\n\t\tgl_PointSize = 5.0;\n\t}",OrthogonalDepthShaderFS:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float near;\nuniform float far;\n\nvarying float depth;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvec4 PackDepth32( in float depth )\n{\n    depth *= (16777216.0 - 1.0) / (16777216.0);\n    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n}\n\nvoid main()\n{     \n    gl_FragData[0] = PackDepth32(depth);\n\t//gl_FragData[0] = packDepth(-depth);\n}",OrthogonalDepthShaderVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvarying float depth;\n  \nvoid main()\n{\t\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n    //depth = (modelViewMatrixRelToEye * pos4).z/far; // original.***\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tdepth = gl_Position.z*0.5+0.5;\n}\n",PngImageFS:"precision highp float;\nvarying vec2 v_texcoord;\nuniform bool textureFlipYAxis;\nuniform sampler2D u_texture;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 oneColor4;\n\n\nvarying vec2 imageSizeInPixels;\n\nvoid main()\n{\n    vec4 textureColor;\n\n\t// 1rst, check if the texture.w != 0.\n\tif(textureFlipYAxis)\n\t{\n\t\ttextureColor = texture2D(u_texture, vec2(v_texcoord.s, 1.0 - v_texcoord.t));\n\t}\n\telse\n\t{\n\t\ttextureColor = texture2D(u_texture, v_texcoord);\n\t}\n\t//if(textureColor.w < 0.005)\n\tif(textureColor.w == 0.0)\n\t{\n\t\tdiscard;\n\t}\n\tif(colorType == 2)\n\t{\n\t\t// do nothing.\n\t}\n\telse if( colorType == 0)\n\t{\n\t\ttextureColor = oneColor4;\n\t}\n\n    gl_FragColor = textureColor;\n}",PngImageVS:"attribute vec4 position;\nattribute vec2 texCoord;\nuniform mat4 buildingRotMatrix;\nuniform mat4 modelViewMatrixRelToEye;  \nuniform mat4 ModelViewProjectionMatrixRelToEye;  \nuniform mat4 projectionMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec2 scale2d;\nuniform vec2 size2d;\nuniform vec3 aditionalOffset;\nuniform vec2 imageSize;\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform bool bUseOriginalImageSize;\nvarying vec2 v_texcoord;\nvarying vec2 imageSizeInPixels;\n\nvoid main()\n{\n    vec4 position2 = vec4(position.xyz, 1.0);\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t//imageSizeInPixels = vec2(imageSize.x, imageSize.y);\n\t\n\tfloat order_w = position.w;\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n    v_texcoord = texCoord;\n\tvec4 projected = ModelViewProjectionMatrixRelToEye * pos4;\n\t//vec4 projected2 = modelViewMatrixRelToEye * pos4;\n\n\t// Now, calculate the pixelSize in the plane of the projected point.\n\tfloat pixelWidthRatio = 2. / (screenWidth * projectionMatrix[0][0]);\n\t// alternative : float pixelWidthRatio = 2. / (screenHeight * projectionMatrix[1][1]);\n\tfloat pixelWidth = projected.w * pixelWidthRatio;\n\t\n\tif(projected.w < 5.0)\n\t\tpixelWidth = 5.0 * pixelWidthRatio;\n\t\n\tvec4 offset;\n\tfloat offsetX;\n\tfloat offsetY;\n\tif(bUseOriginalImageSize)\n\t{\n\t\toffsetX = pixelWidth*imageSize.x/2.0;\n\t\toffsetY = pixelWidth*imageSize.y/2.0;\n\t}\n\telse{\n\t\toffsetX = pixelWidth*size2d.x/2.0;\n\t\toffsetY = pixelWidth*size2d.y/2.0;\n\t}\n\t\n\t// Offset our position along the normal\n\tif(orderInt == 1)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == -1)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == 2)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, offsetY*4.0*scale2d.y, 0.0, 1.0);\n\t}\n\telse if(orderInt == -2)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, offsetY*4.0*scale2d.y, 0.0, 1.0);\n\t}\n\n\tgl_Position = projected + offset + vec4(aditionalOffset.x*pixelWidth, aditionalOffset.y*pixelWidth, aditionalOffset.z*pixelWidth, 0.0); \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",PointCloudDepthFS:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float near;\nuniform float far;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes;\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\n\nvarying float depth;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    vec4 res = fract(depth * bit_shift);\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvec4 PackDepth32( in float depth )\n{\n    depth *= (16777216.0 - 1.0) / (16777216.0);\n    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n}\n\nvoid main()\n{     \n    gl_FragData[0] = packDepth(-depth);\n\t//gl_FragData[0] = PackDepth32(depth);\n}",PointCloudDepthVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 modelViewMatrixRelToEye; \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nattribute vec4 color4;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nvarying vec4 vColor;\n//varying float glPointSize;\nvarying float depth;  \n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\tfloat maxShort = 65535.0;\n\t\trealPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n    float z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n    if(gl_PointSize > maxPointSize)\n        gl_PointSize = maxPointSize;\n\tif(gl_PointSize < 2.0)\n\t\tgl_PointSize = 2.0;\n\t\t\n\tdepth = (modelViewMatrixRelToEye * pos).z/far; // original.***\n}\n",PointCloudFS:"\tprecision lowp float;\n\tuniform vec4 uStrokeColor;\n\tvarying vec4 vColor;\n\tvarying float glPointSize;\n\tuniform int uPointAppereance; // square, circle, romboide,...\n\tuniform int uStrokeSize;\n\n\tvoid main()\n    {\n\t\tvec2 pt = gl_PointCoord - vec2(0.5);\n\t\tfloat distSquared = pt.x*pt.x+pt.y*pt.y;\n\t\tif(distSquared > 0.25)\n\t\t\tdiscard;\n\n\t\tvec4 finalColor = vColor;\n\t\tfloat strokeDist = 0.1;\n\t\tif(glPointSize > 10.0)\n\t\tstrokeDist = 0.15;\n\n\t\tif(uStrokeSize > 0)\n\t\t{\n\t\t\tif(distSquared >= strokeDist)\n\t\t\t{\n\t\t\t\tfinalColor = uStrokeColor;\n\t\t\t}\n\t\t}\n\t\tgl_FragColor = finalColor;\n\t}",PointCloudSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform mat4 projectionMatrix;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\nvarying vec4 vColor;\nvarying float glPointSize;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tif(pt.x*pt.x+pt.y*pt.y > 0.25)\n\t\tdiscard;\n\t\n\tfloat occlusion = 0.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat linearDepth = getDepth(screenPos);\n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;\n\t\tfloat radiusAux = glPointSize/1.9;\n\t\tradiusAux = 1.5;\n\t\tvec2 screenPosAdjacent;\n\t\t\n\t\tfor(int j = 0; j < 1; ++j)\n\t\t{\n\t\t\tradiusAux = 1.5 *(float(j)+1.0);\n\t\t\tfor(int i = 0; i < 8; ++i)\n\t\t\t{    \t \n\t\t\t\tif(i == 0)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 1)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 2)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 3)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\telse if(i == 4)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 5)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 6)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 7)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\tfloat depthBufferValue = getDepth(screenPosAdjacent);\n\t\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)*far;\n\t\t\t\tif (range_check > 1.5 && depthBufferValue > linearDepth)\n\t\t\t\t{\n\t\t\t\t\tif (range_check < 20.0)\n\t\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t}   \n\t\t}   \n\t\t\t\n\t\tif(occlusion > 6.0)\n\t\t\tocclusion = 8.0;\n\t\t//else occlusion = 0.0;\n\t\tocclusion = 1.0 - occlusion / 8.0;\n\t}\n\telse{\n\t\tocclusion = 1.0;\n\t}\n\n    vec4 finalColor;\n\tfinalColor = vec4((vColor.xyz) * occlusion, externalAlpha);\n\t//finalColor = vec4(vec3(0.8, 0.8, 0.8) * occlusion, externalAlpha);\n    gl_FragColor = finalColor; \n}",PointCloudSsaoFS_rainbow:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform mat4 projectionMatrix;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nuniform bool bUseColorCodingByHeight;\nuniform float minHeight_rainbow;   \nuniform float maxHeight_rainbow;  \nvarying vec4 aColor4; // color from attributes\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}  \n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n}   \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat linearDepth = getDepth(screenPos);\n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;\n\t\tfloat radiusAux = glPointSize/1.9;\n\t\tradiusAux = 1.5;\n\t\tvec2 screenPosAdjacent;\n\t\t\n\t\tfor(int j = 0; j < 1; ++j)\n\t\t{\n\t\t\tradiusAux = 1.5 *(float(j)+1.0);\n\t\t\tfor(int i = 0; i < 8; ++i)\n\t\t\t{    \t \n\t\t\t\tif(i == 0)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 1)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 2)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 3)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\telse if(i == 4)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 5)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 6)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 7)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\tfloat depthBufferValue = getDepth(screenPosAdjacent);\n\t\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)*far;\n\t\t\t\tif (range_check > 1.5 && depthBufferValue > linearDepth)\n\t\t\t\t{\n\t\t\t\t\tif (range_check < 20.0)\n\t\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t}   \n\t\t}   \n\t\t\t\n\t\tif(occlusion > 6.0)\n\t\t\tocclusion = 8.0;\n\t\t//else occlusion = 0.0;\n\t\tocclusion = 1.0 - occlusion / 8.0;\n\t}\n\telse{\n\t\tocclusion = 1.0;\n\t}\n\n    vec4 finalColor;\n\tif(bUseColorCodingByHeight)\n\t{\n\t\tfloat rainbow = 0.5;\n\t\tfloat texCol = 0.5;\n\t\tvec3 rainbowColor3 = getRainbowColor_byHeight(realHeigh);\n\t\tvec3 blendedColor3 = vec3(vColor.x * texCol + rainbowColor3.r * rainbow, vColor.y * texCol + rainbowColor3.g * rainbow, vColor.z * texCol + rainbowColor3.b * rainbow);\n\t\tfinalColor = vec4(blendedColor3 * occlusion, externalAlpha);\n\t}\n\telse\n\t\tfinalColor = vec4((vColor.xyz) * occlusion, externalAlpha);\n\t//finalColor = vec4(vec3(0.8, 0.8, 0.8) * occlusion, externalAlpha);\n    gl_FragColor = finalColor; \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",PointCloudVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nuniform bool bUseColorCodingByHeight;\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float glPointSize;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\tfloat maxShort = 65535.0;\n\t\trealPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://www.gamasutra.com/blogs/BranoKemen/20090812/85207/Logarithmic_Depth_Buffer.php\n\t\t// z = log(C*z + 1) / log(C*Far + 1) * w\n\t\tfloat z = gl_Position.z;\n\t\t//float C = 1.0;\n\t\tfloat w = gl_Position.w;\n\t\t////gl_Position.z = log(C*z + 1.0) / log(C*far + 1.0) * w;\n\t\tgl_Position.z = log(z/near) / log(far/near)*w; // another way.\n\t}\n\n\tif(bUseFixPointSize)\n\t{\n\t\tgl_PointSize = fixPointSize;\n\t}\n\telse{\n\t\tfloat z_b = gl_Position.z/gl_Position.w;\n\t\tfloat z_n = 2.0 * z_b - 1.0;\n\t\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\t\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t\tif(gl_PointSize > maxPointSize)\n\t\t\tgl_PointSize = maxPointSize;\n\t\tif(gl_PointSize < 2.0)\n\t\t\tgl_PointSize = 2.0;\n\t}\n\tglPointSize = gl_PointSize;\n}",PointCloudVS_rainbow:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\tfloat maxShort = 65535.0;\n\t\trealPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trealHeigh = realPos.z;\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n    float z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n    gl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n    if(gl_PointSize > maxPointSize)\n        gl_PointSize = maxPointSize;\n    if(gl_PointSize < 2.0)\n        gl_PointSize = 2.0;\n        \n    glPointSize = gl_PointSize;\n}\n",quad_vert:"precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}\n",RenderShowDepthFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform float near;\nuniform float far;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes;\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform bool bUseLogarithmicDepth;\n\nvarying float depth;  \nvarying vec3 vertexPos;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0); // original.***\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625);  // original.*** \n\t\n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\n\n//vec4 PackDepth32( in float depth )\n//{\n//    depth *= (16777216.0 - 1.0) / (16777216.0);\n//    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n//    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n//}\n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvoid main()\n{     \n\t// 1rst, check if there are clipping planes.\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = true;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(discardFrag)\n\t\tdiscard;\n\t}\n\t\n    gl_FragData[0] = packDepth(-depth);\n\t//gl_FragData[0] = PackDepth32(depth);\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",RenderShowDepthVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 scaleLC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform bool bUseLogarithmicDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying float depth;\nvarying vec3 vertexPos;\n  \nvoid main()\n{\t\n\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n    depth = orthoPos.z/far; // original.***\n\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\n\tvertexPos = orthoPos.xyz;\n}",ScreenQuadFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D shadowMapTex;\nuniform sampler2D shadowMapTex2;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 modelViewMatrixInv;\nuniform mat4 modelViewProjectionMatrixInv;\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform mat4 projectionMatrix;\nuniform mat4 projectionMatrixInv;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform bool bApplyShadow;\nuniform bool bSilhouette;\nuniform mat4 sunMatrix[2]; \nuniform vec3 sunPosHIGH[2];\nuniform vec3 sunPosLOW[2];\nuniform int sunIdx;\nuniform float screenWidth;    \nuniform float screenHeight;   \nuniform float near;\nuniform float far;\nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\nvarying vec4 vColor; \n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckeviius' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat unpackDepthMago(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n} \n\nfloat UnpackDepth32( in vec4 pack )\n{\n\tfloat depth = dot( pack, vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605) );\n    return depth * 1.000000059605;// 1.000000059605 = (16777216.0) / (16777216.0 - 1.0);\n}  \n\nfloat getDepthShadowMap(vec2 coord)\n{\n\t// currSunIdx\n\tif(sunIdx == 0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex, coord.xy));\n\t}\n    else if(sunIdx ==1)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex2, coord.xy));\n\t}\n\telse\n\t\treturn -1.0;\n}\n\nbool isInShadow(vec4 pointWC, int currSunIdx)\n{\n\tbool inShadow = false;\n\tvec3 currSunPosLOW;\n\tvec3 currSunPosHIGH;\n\tmat4 currSunMatrix;\n\tif(currSunIdx == 0)\n\t{\n\t\tcurrSunPosLOW = sunPosLOW[0];\n\t\tcurrSunPosHIGH = sunPosHIGH[0];\n\t\tcurrSunMatrix = sunMatrix[0];\n\t}\n\telse if(currSunIdx == 1)\n\t{\n\t\tcurrSunPosLOW = sunPosLOW[1];\n\t\tcurrSunPosHIGH = sunPosHIGH[1];\n\t\tcurrSunMatrix = sunMatrix[1];\n\t}\n\telse\n\treturn false;\n\t\n\t\t\n\tvec3 highDifferenceSun = pointWC.xyz -currSunPosHIGH.xyz;\n\tvec3 lowDifferenceSun = -currSunPosLOW.xyz;\n\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\tvec4 vPosRelToLight = currSunMatrix * pos4Sun;\n\n\tvec3 posRelToLight = vPosRelToLight.xyz / vPosRelToLight.w;\n\tfloat tolerance = 0.9963;\n\tposRelToLight = posRelToLight * 0.5 + 0.5; // transform to [0,1] range\n\tif(posRelToLight.x >= 0.0 && posRelToLight.x <= 1.0)\n\t{\n\t\tif(posRelToLight.y >= 0.0 && posRelToLight.y <= 1.0)\n\t\t{\n\t\t\tfloat depthRelToLight;\n\t\t\tif(currSunIdx == 0)\n\t\t\t{depthRelToLight = UnpackDepth32(texture2D(shadowMapTex, posRelToLight.xy));}\n\t\t\telse if(currSunIdx == 1)\n\t\t\t{depthRelToLight = UnpackDepth32(texture2D(shadowMapTex2, posRelToLight.xy));}\n\t\t\tif(posRelToLight.z > depthRelToLight*tolerance )\n\t\t\t{\n\t\t\t\tinShadow = true;\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn inShadow;\n}\n\nvoid main()\n{\n\t// 1rst, check if this is silhouette rendering.\n\tif(bSilhouette)\n\t{\n\t\t// Check the adjacent pixels to decide if this is silhouette.\n\t\t// Analize a 5x5 rectangle of the depthTexture: if there are objectDepth & backgroundDepth => is silhouette.\n\t\tfloat pixelSizeW = 1.0/screenWidth;\n\t\tfloat pixelSizeH = 1.0/screenHeight;\n\t\tint objectDepthCount = 0;\n\t\tint backgroundDepthCount = 0;\n\t\tfloat tolerance = 0.9963;\n\t\ttolerance = 0.9963;\n\t\t\n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight); // centerPos.\n\t\tvec2 screenPos_LD = vec2(screenPos.x - pixelSizeW*1.5, screenPos.y - pixelSizeH*1.5); // left-down corner.\n\t\t\n\t\tfor(int w = 0; w<3; w++)\n\t\t{\n\t\t\tfor(int h=0; h<3; h++)\n\t\t\t{\n\t\t\t\tvec2 screenPosAux = vec2(screenPos_LD.x + pixelSizeW*float(w), screenPos_LD.y + pixelSizeH*float(h));\n\t\t\t\tfloat z_window  = unpackDepthMago(texture2D(depthTex, screenPosAux.xy)); // z_window  is [0.0, 1.0] range depth.\n\n\t\t\t\tif(z_window > tolerance)\n\t\t\t\t{\n\t\t\t\t\t// is background.\n\t\t\t\t\tbackgroundDepthCount += 1;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// is object.\n\t\t\t\t\tobjectDepthCount += 1;\n\t\t\t\t}\n\n\t\t\t\tif(backgroundDepthCount > 0 && objectDepthCount > 0)\n\t\t\t\t{\n\t\t\t\t\t// is silhouette.\n\t\t\t\t\tgl_FragColor = vec4(0.2, 1.0, 0.3, 1.0);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t}\n\t\t}\n\t\t\n\t\treturn;\n\t}\n\t\n\tfloat shadow_occlusion = 1.0;\n\tfloat alpha = 0.0;\n\tvec4 finalColor;\n\tfinalColor = vec4(0.2, 0.2, 0.2, 0.8);\n\tif(bApplyShadow)\n\t{\n\t\t// the sun lights count are 2.\n\t\t// 1rst, calculate the pixelPosWC.\n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat z_window  = unpackDepth(texture2D(depthTex, screenPos.xy)); // z_window  is [0.0, 1.0] range depth.\n\t\tif(z_window < 0.001)\n\t\tdiscard;\n\t\t\n\t\t// https://stackoverflow.com/questions/11277501/how-to-recover-view-space-position-given-view-space-depth-value-and-ndc-xy\n\t\tfloat depthRange_near = 0.0;\n\t\tfloat depthRange_far = 1.0;\n\t\tfloat x_ndc = 2.0 * screenPos.x - 1.0;\n\t\tfloat y_ndc = 2.0 * screenPos.y - 1.0;\n\t\tfloat z_ndc = (2.0 * z_window - depthRange_near - depthRange_far) / (depthRange_far - depthRange_near);\n\t\t\n\t\tvec4 viewPosH = projectionMatrixInv * vec4(x_ndc, y_ndc, z_ndc, 1.0);\n\t\tvec3 posCC = viewPosH.xyz/viewPosH.w;\n\t\tvec4 posWC = modelViewMatrixRelToEyeInv * vec4(posCC.xyz, 1.0) + vec4((encodedCameraPositionMCHigh + encodedCameraPositionMCLow).xyz, 1.0);\n\t\t//----------------------------------------------------------------\n\t\n\t\t// 2nd, calculate the vertex relative to light.***\n\t\t// 1rst, try with the closest sun. sunIdx = 0.\n\t\tbool pointIsinShadow = isInShadow(posWC, 0);\n\t\tif(!pointIsinShadow)\n\t\t{\n\t\t\tpointIsinShadow = isInShadow(posWC, 1);\n\t\t}\n\n\t\tif(pointIsinShadow)\n\t\t{\n\t\t\tshadow_occlusion = 0.5;\n\t\t\talpha = 0.5;\n\t\t}\n\t\t\n\t}\n    gl_FragColor = vec4(finalColor.rgb*shadow_occlusion, alpha);\n}",ScreenQuadVS:"precision mediump float;\n\nattribute vec2 position;\nvarying vec4 vColor; \n\nvoid main() {\n\tvColor = vec4(0.2, 0.2, 0.2, 0.5);\n    gl_Position = vec4(1.0 - 2.0 * position, 0.0, 1.0);\n}",screen_frag:"precision mediump float;\n\nuniform sampler2D u_screen;\nuniform float u_opacity;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_screen, 1.0 - v_tex_pos);\n    // a hack to guarantee opacity fade out even with a value close to 1.0\n    gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n}\n",SilhouetteFS:"precision highp float;\nuniform vec4 vColor4Aux;\n\nvoid main()\n{          \n    gl_FragColor = vColor4Aux;\n}",SilhouetteVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewMatrixRelToEye;\nuniform mat4 ProjectionMatrix;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform vec2 camSpacePixelTranslation;\nuniform vec2 screenSize;   \nvarying vec2 camSpaceTranslation;\n\nvoid main()\n{    \n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 camSpacePos = ModelViewMatrixRelToEye * pos4;\n    vec4 translationVec = ProjectionMatrix * vec4(camSpacePixelTranslation.x*(-camSpacePos.z), camSpacePixelTranslation.y*(-camSpacePos.z), 0.0, 1.0);\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n    gl_Position += translationVec;  \n}",StandardFS:"precision lowp float;\nvarying vec3 vColor;\n\nvoid main()\n{\n    gl_FragColor = vec4(vColor, 1.);\n}",StandardVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 RefTransfMatrix;\nattribute vec3 color;\nvarying vec3 vColor;\n\nvoid main()\n{\n    vec4 rotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n \n    vColor=color;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",Test_QuadFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n \nuniform sampler2D diffuseTex;  \nvarying vec2 vTexCoord; \nvoid main()\n{          \n    vec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n    gl_FragColor = textureColor; \n}\n",Test_QuadVS:"attribute vec3 position;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \n\nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",TextureA1FS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}\n",TextureA1VS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n \n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}",TextureFS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}",TextureNormalFS:"\tprecision mediump float;\n\tvarying vec4 vColor;\n\tvarying vec2 vTextureCoord;\n\tuniform sampler2D uSampler;\n\tvarying vec3 vLightWeighting;\n\n\tvoid main()\n    {\n\t\tvec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n        \n\t\tgl_FragColor = vec4(textureColor.rgb * vLightWeighting, textureColor.a);\n\t}\n",TextureNormalVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nattribute vec3 aVertexNormal;\nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nuniform mat3 uNMatrix;\n\nvoid main()\n{\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    vColor = aVertexColor;\n    vTextureCoord = aTextureCoord;\n    \n    vLightWeighting = vec3(1.0, 1.0, 1.0);\n    uAmbientColor = vec3(0.7, 0.7, 0.7);\n    vec3 uLightingDirection = vec3(0.8, 0.2, -0.9);\n    vec3 directionalLightColor = vec3(0.4, 0.4, 0.4);\n    vec3 transformedNormal = uNMatrix * aVertexNormal;\n    float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);\n    vLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n}\n",texturesMergerFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D texture_0;  \nuniform sampler2D texture_1;\nuniform sampler2D texture_2;\nuniform sampler2D texture_3;\nuniform sampler2D texture_4;\nuniform sampler2D texture_5;\nuniform sampler2D texture_6;\nuniform sampler2D texture_7;\n\nuniform float externalAlphasArray[8];\nuniform int uActiveTextures[8];\nuniform vec4 uExternalTexCoordsArray[8]; // vec4 (minS, minT, maxS, maxT).\nuniform vec2 uMinMaxAltitudes; // used for altitudes textures as bathymetry.\n\nvarying vec2 v_tex_pos;\n\n//vec4 mixColor(sampler2D tex)\nbool intersects(vec2 texCoord, vec4 extension)\n{\n    bool bIntersects = true;\n    float minS = extension.x;\n    float minT = extension.y;\n    float maxS = extension.z;\n    float maxT = extension.w;\n\n    if(texCoord.x < minS || texCoord.x > maxS)\n    return false;\n    else if(texCoord.y < minT || texCoord.y > maxT)\n    return false;\n\n    return bIntersects;\n}\n\nvoid getTextureColor(in int activeNumber, in vec4 currColor4, in vec2 texCoord,  inout bool victory, in float externalAlpha, in vec4 externalTexCoords, inout vec4 resultTextureColor)\n{\n    if(activeNumber == 1 || activeNumber == 2)\n    {\n        if(currColor4.w > 0.0 && externalAlpha > 0.0)\n        {\n            if(victory)\n            {\n                resultTextureColor = mix(resultTextureColor, currColor4, currColor4.w*externalAlpha);\n            }\n            else{\n                currColor4.w *= externalAlpha;\n                resultTextureColor = currColor4;\n            }\n            \n            victory = true;\n        }\n    }\n    else if(activeNumber == 10)\n    {\n        // Bathymetry texture.\n        float altitude = 1000000.0;\n        if(currColor4.w > 0.0)\n        {\n            // decode the grayScale.***\n            altitude = uMinMaxAltitudes.x + currColor4.r * (uMinMaxAltitudes.y - uMinMaxAltitudes.x);\n        \n            if(altitude < 0.0)\n            {\n                float minHeight_rainbow = -100.0;\n                float maxHeight_rainbow = 0.0;\n                float gray = (altitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n                //vec3 rainbowColor = getRainbowColor_byHeight(altitude);\n\n                if(gray < 0.05)\n                gray = 0.05;\n                float red = gray + 0.1;//float red = gray + 0.2;\n                float green = gray + 0.5;//float green = gray + 0.6;\n                float blue = gray*2.0 + 2.0;\n                vec4 fogColor = vec4(red, green, blue, 1.0);\n                \n                resultTextureColor = mix(resultTextureColor, fogColor, 0.7); \n            }\n        }\n    }\n}\n\nvoid main()\n{           \n    // Debug.\n    /*\n    if(v_tex_pos.x < 0.002 || v_tex_pos.x > 0.998)\n    {\n        gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n        return;\n    }\n\n    if(v_tex_pos.y < 0.002 || v_tex_pos.y > 0.998)\n    {\n        gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n        return;\n    }\n    */\n\n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y);\n\n    // Take the base color.\n    vec4 textureColor = vec4(0.0, 0.0, 0.0, 0.0);\n    bool victory = false;\n\n    if(uActiveTextures[0] > 0)\n    {\n        if(uActiveTextures[0] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[0];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[0], texture2D(texture_0, texCoord), texCoord,  victory, externalAlphasArray[0], uExternalTexCoordsArray[0], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[0], texture2D(texture_0, texCoord), texCoord,  victory, externalAlphasArray[0], uExternalTexCoordsArray[0], textureColor);\n        \n    }\n    if(uActiveTextures[1] > 0)\n    {\n        if(uActiveTextures[1] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[1];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[1], texture2D(texture_1, texCoord), texCoord,  victory, externalAlphasArray[1], uExternalTexCoordsArray[1], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[1], texture2D(texture_1, texCoord), texCoord,  victory, externalAlphasArray[1], uExternalTexCoordsArray[1], textureColor);\n    }\n    if(uActiveTextures[2] > 0)\n    {\n        if(uActiveTextures[2] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[2];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[2], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[2], uExternalTexCoordsArray[2], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[2], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[2], uExternalTexCoordsArray[2], textureColor);\n    }\n    if(uActiveTextures[3] > 0)\n    {\n        if(uActiveTextures[3] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[3];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[3], texture2D(texture_3, texCoord), texCoord,  victory, externalAlphasArray[3], uExternalTexCoordsArray[3], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[3], texture2D(texture_3, texCoord), texCoord,  victory, externalAlphasArray[3], uExternalTexCoordsArray[3], textureColor);\n    }\n    if(uActiveTextures[4] > 0)\n    {\n        if(uActiveTextures[4] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[4];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[4], texture2D(texture_4, texCoord), texCoord,  victory, externalAlphasArray[4], uExternalTexCoordsArray[4], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[4], texture2D(texture_4, texCoord), texCoord,  victory, externalAlphasArray[4], uExternalTexCoordsArray[4], textureColor);\n    }\n    if(uActiveTextures[5] > 0)\n    {\n        if(uActiveTextures[5] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[5];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[5], texture2D(texture_5, texCoord), texCoord,  victory, externalAlphasArray[5], uExternalTexCoordsArray[5], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[5], texture2D(texture_5, texCoord), texCoord,  victory, externalAlphasArray[5], uExternalTexCoordsArray[5], textureColor);\n    }\n    if(uActiveTextures[6] > 0)\n    {\n        if(uActiveTextures[6] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[6];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[6], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[6], uExternalTexCoordsArray[6], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[6], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[6], uExternalTexCoordsArray[6], textureColor);\n    }\n    if(uActiveTextures[7] > 0)\n    {\n        if(uActiveTextures[7] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[7];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[7], texture2D(texture_7, texCoord), texCoord,  victory, externalAlphasArray[7], uExternalTexCoordsArray[7], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[7], texture2D(texture_7, texCoord), texCoord,  victory, externalAlphasArray[7], uExternalTexCoordsArray[7], textureColor);\n    }\n    \n    if(!victory)\n    discard;\n    \n    gl_FragColor = textureColor;\n\t\n}",texturesMergerVS:"precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    //vec2 pos = a_pos*0.5;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}",TextureVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 Mmatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec4 rotatedPos = Mmatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n    \n}",thickLineDepthVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\n\nvarying vec4 vColor;\nvarying float depth;\nvarying float flogz;\nvarying float Fcoef_half;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat direction = (thickness*sense*projectedDepth)/1000.0;\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * direction, 0.0, 1.0);\n\tgl_Position = currentProjected + offset; \n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\n    depth = (modelViewMatrixRelToEye * current).z/far; // original.***\n\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",thickLineFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main() {\n\tgl_FragColor = vColor;\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",thickLineVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat direction = (thickness*sense*projectedDepth)/1000.0;\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * direction, 0.0, 1.0);\n\tgl_Position = currentProjected + offset; \n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",TinTerrainAltitudesFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nvarying float vAltitude;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvec4 PackDepth32( in float depth )\n{\n    depth *= (16777216.0 - 1.0) / (16777216.0);\n    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n}\n\nvoid main()\n{     \n    gl_FragData[0] = PackDepth32(vAltitude);\n\t//gl_FragData[0] = packDepth(-depth);\n}",TinTerrainAltitudesVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrix;\n\nvarying float vAltitude;\n  \nvoid main()\n{\t\n    vec4 pos4 = vec4(position.xyz, 1.0);\n\tgl_Position = ModelViewProjectionMatrix * pos4;\n\tvAltitude = position.z;\n}\n",TinTerrainFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n  \nuniform sampler2D shadowMapTex;// 0\nuniform sampler2D shadowMapTex2;// 1\n//uniform sampler2D depthTex;//2\n//uniform sampler2D noiseTex;//3\nuniform sampler2D diffuseTex;  // 4\nuniform sampler2D diffuseTex_1;// 5\nuniform sampler2D diffuseTex_2;// 6\nuniform sampler2D diffuseTex_3;// 7\nuniform sampler2D diffuseTex_4;// 8\nuniform sampler2D diffuseTex_5;// 9\nuniform bool textureFlipYAxis;\nuniform bool bIsMakingDepth;\nuniform bool bExistAltitudes;\nuniform bool bApplyCaustics;\nuniform mat4 projectionMatrix;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform int uActiveTextures[8];\nuniform float externalAlphasArray[8];\nuniform vec2 uMinMaxAltitudes;\nuniform int uTileDepth;\nuniform int uSeaOrTerrainType;\nuniform int uRenderType;\n\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying float depthValue;\n\nconst int kernelSize = 16;  \nuniform float radius;      \nuniform float uTime;  \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nuniform float externalAlpha;\nuniform bool bApplyShadow;\nuniform bool bApplySsao;\nuniform float shadowMapWidth;    \nuniform float shadowMapHeight;\nuniform bool bUseLogarithmicDepth;\n\nvarying vec3 v3Pos;\nvarying float vFogAmount;\n\nvarying float applySpecLighting;\nvarying vec4 vPosRelToLight; \nvarying vec3 vLightDir; \nvarying vec3 vNormal;\nvarying vec3 vNormalWC;\nvarying float currSunIdx;\nvarying float vAltitude;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nconst float equatorialRadius = 6378137.0;\nconst float polarRadius = 6356752.3142;\n\n// water caustics: https://catlikecoding.com/unity/tutorials/flow/texture-distortion/\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n} \n\nfloat unpackDepthOcean(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n} \n\nfloat UnpackDepth32( in vec4 pack )\n{\n    float depth = dot( pack, 1.0 / vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return depth * (16777216.0) / (16777216.0 - 1.0);\n}\n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}               \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}\n\n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n\t// in this shader the depthTex is "diffuseTex"\n\treturn unpackDepth(texture2D(diffuseTex, coord.xy));\n}\n\n//linear view space depth\n//float getDepth(vec2 coord)\n//{\n//    return unpackDepth(texture2D(depthTex, coord.xy));\n//}  \n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat minHeight_rainbow = -200.0;\n\tfloat maxHeight_rainbow = 0.0;\n\t\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\nfloat getDepthShadowMap(vec2 coord)\n{\n\t// currSunIdx\n\tif(currSunIdx > 0.0 && currSunIdx < 1.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex, coord.xy));\n\t}\n    else if(currSunIdx > 1.0 && currSunIdx < 2.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex2, coord.xy));\n\t}\n\telse\n\t\treturn 1000.0;\n} \n\nfloat getGridLineWidth(int depth)\n{\n\tfloat gridLineWidth = 0.025;\n\t\n\tif(depth == 17)\n\t{\n\t\tgridLineWidth = 0.025;\n\t}\n\telse{\n\t\tint dif = 18 - depth;\n\t\tif(dif < 1)\n\t\tdif = 1;\n\t\tgridLineWidth = (0.04/17.0) * float(depth/dif);\n\t}\n\t\n\treturn gridLineWidth;\n}\n\n//#define SHOW_TILING\n#define TAU 6.28318530718 // https://www.shadertoy.com/view/4sXfDj\n#define MAX_ITER 5 // https://www.shadertoy.com/view/4sXfDj\n\n// Water Caustics with BCC-Noise :https://www.shadertoy.com/view/wlc3zr\n\nvec3 causticColor(vec2 texCoord)\n{\n\t// To avoid mosaic repetitions.******************\n\tfloat uPlus = texCoord.x - 1.0;\n\tfloat vPlus = texCoord.y - 1.0;\n\t//float timePlus = max(uPlus, vPlus);\n\tfloat timePlus = uPlus + vPlus;\n\tif(timePlus < 0.0)\n\ttimePlus = 0.0;\n\t// End avoid mosaic repetitions.-------------------------\n\t\n\t// Water turbulence effect by joltz0r 2013-07-04, improved 2013-07-07\n\tfloat time = (uTime+timePlus) * .5+23.0;\n    // uv should be the 0-1 uv of texture...\n\n\t\n\n\tvec2 uv = texCoord;\n    \n#ifdef SHOW_TILING\n\tvec2 p = mod(uv*TAU*2.0, TAU)-250.0;\n#else\n    vec2 p = mod(uv*TAU, TAU)-250.0;\n#endif\n\tvec2 i = vec2(p);\n\tfloat c = 1.0;\n\tfloat inten = .005;\n\n\tfor (int n = 0; n < MAX_ITER; n++) \n\t{\n\t\tfloat t = time * (1.0 - (3.5 / float(n+1)));\n\t\ti = p + vec2(cos(t - i.x) + sin(t + i.y), sin(t - i.y) + cos(t + i.x));\n\t\tc += 1.0/length(vec2(p.x / (sin(i.x+t)/inten),p.y / (cos(i.y+t)/inten)));\n\t}\n\tc /= float(MAX_ITER);\n\tc = 1.17-pow(c, 1.4);\n\tvec3 colour = vec3(pow(abs(c), 8.0));\n    colour = clamp(colour + vec3(0.0, 0.35, 0.5), 0.0, 1.0);\n\n\t#ifdef SHOW_TILING\n\t// Flash tile borders...\n\tvec2 pixel = 2.0 / vec2(screenWidth, screenHeight);//iResolution.xy;\n\tuv *= 2.0;\n\n\tfloat f = floor(mod(time*.5, 2.0)); \t// Flash value.\n\tvec2 first = step(pixel, uv) * f;\t\t   \t// Rule out first screen pixels and flash.\n\tuv  = step(fract(uv), pixel);\t\t\t\t// Add one line of pixels per tile.\n\tcolour = mix(colour, vec3(1.0, 1.0, 0.0), (uv.x + uv.y) * first.x * first.y); // Yellow line\n\t\n\t#endif\n\n\treturn colour;\n}\n\nvoid getTextureColor(in int activeNumber, in vec4 currColor4, in vec2 texCoord,  inout bool victory, in float externalAlpha, inout vec4 resultTextureColor)\n{\n    if(activeNumber == 1)\n    {\n        if(currColor4.w > 0.0 && externalAlpha > 0.0)\n        {\n            if(victory)\n            {\n                resultTextureColor = mix(resultTextureColor, currColor4, currColor4.w*externalAlpha);\n            }\n            else{\n                currColor4.w *= externalAlpha;\n                resultTextureColor = currColor4;\n            }\n            \n            victory = true;\n        }\n    }\n    else if(activeNumber == 2)\n    {\n        // custom image.\n        // Check uExternalTexCoordsArray.\n        \n    }\n}\n\nvoid main()\n{    \n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n\n\tif(bIsMakingDepth)\n\t{\n\t\tgl_FragColor = packDepth(-depthValue);\n\t}\n\telse\n\t{\n\t\tif(uRenderType == 2)\n\t\t{\n\t\t\tgl_FragColor = oneColor4; \n\t\t\treturn;\n\t\t}\n\n\t\tif(uSeaOrTerrainType == 1)\n\t\t{\n\t\t\t//gl_FragColor = vec4(oneColor4.xyz * shadow_occlusion * lambertian, 0.5); // original.***\n\t\t\t// Render a dot matrix in the sea surface.***\n\t\t\t\n\n\t\t\treturn;\n\t\t}\n\n\t\t\n\n\t\tfloat shadow_occlusion = 1.0;\n\t\tif(bApplyShadow)\n\t\t{\n\t\t\tif(currSunIdx > 0.0)\n\t\t\t{\n\t\t\t\tvec3 fragCoord = gl_FragCoord.xyz;\n\t\t\t\tvec3 fragWC;\n\t\t\t\t\n\t\t\t\t//float ligthAngle = dot(vLightDir, vNormalWC);\n\t\t\t\t//if(ligthAngle > 0.0)\n\t\t\t\t//{\n\t\t\t\t//\t// The angle between the light direction & face normal is less than 90 degree, so, the face is in shadow.***\n\t\t\t\t//\tshadow_occlusion = 0.5;\n\t\t\t\t//}\n\t\t\t\t//else\n\t\t\t\t{\n\n\t\t\t\t\tvec3 posRelToLight = vPosRelToLight.xyz / vPosRelToLight.w;\n\t\t\t\t\tfloat tolerance = 0.9963;\n\t\t\t\t\t//tolerance = 0.9962;\n\t\t\t\t\t//tolerance = 1.0;\n\t\t\t\t\tposRelToLight = posRelToLight * 0.5 + 0.5; // transform to [0,1] range\n\t\t\t\t\tif(posRelToLight.x >= 0.0 && posRelToLight.x <= 1.0)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(posRelToLight.y >= 0.0 && posRelToLight.y <= 1.0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfloat depthRelToLight = getDepthShadowMap(posRelToLight.xy);\n\t\t\t\t\t\t\tif(posRelToLight.z > depthRelToLight*tolerance )\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// Do specular lighting.***\n\t\tvec3 normal2 = vNormal;\t\n\t\tfloat lambertian = 1.0;\n\t\tfloat specular;\n\t\tvec2 texCoord;\n\t\tif(applySpecLighting> 0.0)\n\t\t{\n\t\t\tvec3 L;\n\t\t\tif(bApplyShadow)\n\t\t\t{\n\t\t\t\tL = vLightDir;// test.***\n\t\t\t\tlambertian = max(dot(normal2, L), 0.0); // original.***\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvec3 lightPos = vec3(0.0, 0.0, 0.0);\n\t\t\t\tL = normalize(lightPos - v3Pos);\n\t\t\t\tlambertian = max(dot(normal2, L), 0.0);\n\t\t\t}\n\t\t\t/*\n\t\t\tspecular = 0.0;\n\t\t\tif(lambertian > 0.0)\n\t\t\t{\n\t\t\t\tvec3 R = reflect(-L, normal2);      // Reflected light vector\n\t\t\t\tvec3 V = normalize(-v3Pos); // Vector to viewer\n\t\t\t\t\n\t\t\t\t// Compute the specular term\n\t\t\t\tfloat specAngle = max(dot(R, V), 0.0);\n\t\t\t\tspecular = pow(specAngle, shininessValue);\n\t\t\t\t\n\t\t\t\tif(specular > 1.0)\n\t\t\t\t{\n\t\t\t\t\tspecular = 1.0;\n\t\t\t\t}\n\t\t\t}\n\t\t\t*/\n\t\t\t// test.\n\t\t\tlambertian += 0.3;\n\n\t\t\tif(lambertian < 0.8)\n\t\t\t{\n\t\t\t\tlambertian = 0.8;\n\t\t\t}\n\t\t\telse if(lambertian > 1.0)\n\t\t\t{\n\t\t\t\tlambertian = 1.0;\n\t\t\t}\n\t\t}\n\t\t\n\t\t// check if apply ssao.\n\t\tfloat occlusion = 1.0;\n\t\t//vec3 normal2 = vNormal;\t\n\t\t\n\t\n\t\tvec4 textureColor = vec4(0.0);\n\t\tif(colorType == 0) // one color.\n\t\t{\n\t\t\ttextureColor = oneColor4;\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse if(colorType == 2) // texture color.\n\t\t{\n\t\t\t\n\t\t\tif(textureFlipYAxis)\n\t\t\t{\n\t\t\t\ttexCoord = vec2(vTexCoord.s, 1.0 - vTexCoord.t);\n\t\t\t}\n\t\t\telse{\n\t\t\t\ttexCoord = vec2(vTexCoord.s, vTexCoord.t);\n\t\t\t}\n\t\t\t\n\t\t\tbool firstColorSetted = false;\n\t\t\tfloat externalAlpha = 0.0;\n\n\t\t\tif(uActiveTextures[2] > 0 && uActiveTextures[2] != 10)\n\t\t\t\tgetTextureColor(uActiveTextures[2], texture2D(diffuseTex, texCoord), texCoord,  firstColorSetted, externalAlphasArray[2], textureColor);\n\t\t\tif(uActiveTextures[3] > 0 && uActiveTextures[3] != 10)\n\t\t\t\tgetTextureColor(uActiveTextures[3], texture2D(diffuseTex_1, texCoord), texCoord,  firstColorSetted, externalAlphasArray[3], textureColor);\n\t\t\tif(uActiveTextures[4] > 0 && uActiveTextures[4] != 10)\n\t\t\t\tgetTextureColor(uActiveTextures[4], texture2D(diffuseTex_2, texCoord), texCoord,  firstColorSetted, externalAlphasArray[4], textureColor);\n\t\t\tif(uActiveTextures[5] > 0 && uActiveTextures[5] != 10)\n\t\t\t\tgetTextureColor(uActiveTextures[5], texture2D(diffuseTex_3, texCoord), texCoord,  firstColorSetted, externalAlphasArray[5], textureColor);\n\t\t\tif(uActiveTextures[6] > 0 && uActiveTextures[6] != 10)\n\t\t\t\tgetTextureColor(uActiveTextures[6], texture2D(diffuseTex_4, texCoord), texCoord,  firstColorSetted, externalAlphasArray[6], textureColor);\n\t\t\tif(uActiveTextures[7] > 0 && uActiveTextures[7] != 10)\n\t\t\t\tgetTextureColor(uActiveTextures[7], texture2D(diffuseTex_5, texCoord), texCoord,  firstColorSetted, externalAlphasArray[7], textureColor);\n\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse{\n\t\t\ttextureColor = oneColor4;\n\t\t}\n\n\t\ttextureColor.w = externalAlpha;\n\t\tvec4 fogColor = vec4(0.9, 0.9, 0.9, 1.0);\n\t\t\n\t\t\n\t\t// Dem image.***************************************************************************************************************\n\t\tfloat altitude = 1000000.0;\n\t\tif(uActiveTextures[5] == 10)\n\t\t{\n\t\t\tvec4 layersTextureColor = texture2D(diffuseTex_3, texCoord);\n\t\t\tif(layersTextureColor.w > 0.0)\n\t\t\t{\n\t\t\t\t// decode the grayScale.***\n\t\t\t\taltitude = uMinMaxAltitudes.x + layersTextureColor.r * (uMinMaxAltitudes.y - uMinMaxAltitudes.x);\n\t\t\t}\n\t\t}\n\t\t// End Dem image.------------------------------------------------------------------------------------------------------------\n\t\tif(bApplySsao && altitude<0.0)\n\t\t{\n\t\t\t// must find depthTex & noiseTex.***\n\t\t\t////float farForDepth = 30000.0;\n\t\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\t\tfloat linearDepth = getDepth(screenPos);  \n\t\t\tvec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t\t\tvec3 origin = ray * linearDepth;  \n\t\t\tfloat ssaoRadius = radius*20.0;\n\t\t\tfloat tolerance = ssaoRadius/far; // original.***\n\t\t\t////float tolerance = radius/(far-near);// test.***\n\t\t\t////float tolerance = radius/farForDepth;\n\n\t\t\t// in this shader noiseTex is "diffusse_1".\n\t\t\tvec3 rvec = texture2D(diffuseTex_1, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\t\tvec3 bitangent = cross(normal2, tangent);\n\t\t\tmat3 tbn = mat3(tangent, bitangent, normal2);   \n\t\t\t//float minDepthBuffer;\n\t\t\t//float maxDepthBuffer;\n\t\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t\t{    \t \n\t\t\t\tvec3 sample = origin + (tbn * vec3(kernel[i].x*3.0, kernel[i].y*3.0, kernel[i].z)) * ssaoRadius*2.0; // original.***\n\t\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\t\t\t\n\t\t\t\toffset.xy /= offset.w;\n\t\t\t\toffset.xy = offset.xy * 0.5 + 0.5;  \t\t\t\t\n\t\t\t\tfloat sampleDepth = -sample.z/far;// original.***\n\n\t\t\t\tfloat depthBufferValue = getDepth(offset.xy);\n\t\t\t\t/*\n\t\t\t\tif(depthBufferValue > 0.00391 && depthBufferValue < 0.00393)\n\t\t\t\t{\n\t\t\t\t\tif (depthBufferValue < sampleDepth-tolerance*1000.0)\n\t\t\t\t\t{\n\t\t\t\t\t\tocclusion +=  0.5;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tcontinue;\n\t\t\t\t}\t\t\t\n\t\t\t\t*/\n\t\t\t\tif (depthBufferValue < sampleDepth)//-tolerance)\n\t\t\t\t{\n\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t} \n\n\t\t\tocclusion = 1.0 - occlusion / float(kernelSize);\n\t\t\t\n\t\t\tshadow_occlusion *= occlusion;\n\t\t}\n\t\t\n\t\tif(altitude < 0.0)\n\t\t{\n\t\t\tfloat minHeight_rainbow = -100.0;\n\t\t\tfloat maxHeight_rainbow = 0.0;\n\t\t\tfloat gray = (altitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\t\t\t//float gray = (vAltitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\t\t\t//vec3 rainbowColor = getRainbowColor_byHeight(altitude);\n\n\t\t\t// caustics.*********************\n\t\t\tif(bApplyCaustics)\n\t\t\t{\n\t\t\t\tif(uTime > 0.0 && uTileDepth > 6 && gray > 0.0)//&& altitude > -120.0)\n\t\t\t\t{\n\t\t\t\t\t// Active this code if want same size caustic effects for different tileDepths.***\n\t\t\t\t\t// Take tileDepth 14 as the unitary tile depth.\n\t\t\t\t\t//float tileDethDiff = float(16 - uTileDepth);\n\t\t\t\t\t//vec2 cauticsTexCoord = texCoord*pow(2.0, tileDethDiff);\n\t\t\t\t\t//-----------------------------------------------------------------------\n\t\t\t\t\tvec2 cauticsTexCoord = texCoord;\n\t\t\t\t\tvec3 causticColor = causticColor(cauticsTexCoord)*gray*0.4;\n\t\t\t\t\ttextureColor = vec4(textureColor.r+ causticColor.x, textureColor.g+ causticColor.y, textureColor.b+ causticColor.z, 1.0);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// End caustics.--------------------------\n\n\t\t\t\n\t\t\tif(gray < 0.05)\n\t\t\tgray = 0.05;\n\t\t\tfloat red = gray + 0.2;\n\t\t\tfloat green = gray + 0.6;\n\t\t\tfloat blue = gray*2.0 + 2.0;\n\t\t\tfogColor = vec4(red, green, blue, 1.0);\n\t\t\t\n\t\t\t// Test drawing grid.***\n\t\t\t//if(uTileDepth > 7)\n\t\t\t//{\n\t\t\t//\tfloat numSegs = 5.0;\n\t\t\t//\tfloat fX = fract(texCoord.x * numSegs);\n\t\t\t//\n\t\t\t//\tfloat gridLineWidth = getGridLineWidth(uTileDepth);\n\t\t\t//\tif( fX < gridLineWidth || fX > 1.0-gridLineWidth)\n\t\t\t//\t{\n\t\t\t//\t\tvec3 color = vec3(0.99, 0.5, 0.5);\n\t\t\t//\t\tgl_FragColor = vec4(color.rgb* shadow_occlusion * lambertian, 1.0);\n\t\t\t//\t\treturn;\n\t\t\t//\t}\n\t\t\t//\t\n\t\t\t//\tfloat fY = fract(texCoord.y * numSegs);\n\t\t\t//\tif( fY < gridLineWidth|| fY > 1.0-gridLineWidth)\n\t\t\t//\t{\n\t\t\t//\t\tvec3 color = vec3(0.3, 0.5, 0.99);\n\t\t\t//\t\tgl_FragColor = vec4(color.rgb* shadow_occlusion * lambertian, 1.0);\n\t\t\t//\t\treturn;\n\t\t\t//\t}\n\t\t\t//}\n\t\t\t\n\t\t\t// End test drawing grid.---\n\t\t\tfloat specularReflectionCoef = 0.6;\n\t\t\tvec3 specularColor = vec3(0.8, 0.8, 0.8);\n\t\t\t//textureColor = mix(textureColor, fogColor, 0.2); \n\t\t\t//gl_FragColor = vec4(finalColor.xyz * shadow_occlusion * lambertian + specularReflectionCoef * specular * specularColor * shadow_occlusion, 1.0); // with specular.***\n\t\t\tgl_FragColor = vec4(textureColor.xyz * shadow_occlusion * lambertian, 1.0); // original.***\n\n\t\t\treturn;\n\t\t}\n\t\telse{\n\t\t\tif(uSeaOrTerrainType == 1)\n\t\t\tdiscard;\n\t\t\n\t\t}\n\t\t\n\t\t\n\t\tvec4 finalColor = mix(textureColor, fogColor, vFogAmount); \n\t\tgl_FragColor = vec4(finalColor.xyz * shadow_occlusion * lambertian, 1.0); // original.***\n\t\t//gl_FragColor = textureColor; // test.***\n\t\t//gl_FragColor = vec4(vNormal.xyz, 1.0); // test.***\n\t\t\n\t\t//if(currSunIdx > 0.0 && currSunIdx < 1.0 && shadow_occlusion<0.9)gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t\t\n\t}\n}',TinTerrainVS:'\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\nattribute float altitude;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInv;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 normalMatrix4;\nuniform mat4 sunMatrix[2]; \nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 sunPosHIGH[2];\nuniform vec3 sunPosLOW[2];\nuniform vec3 sunDirWC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bIsMakingDepth;\nuniform bool bExistAltitudes;\nuniform float near;\nuniform float far;\nuniform bool bApplyShadow;\nuniform int sunIdx;\nuniform bool bApplySpecularLighting;\nuniform bool bUseLogarithmicDepth;\n\nvarying float applySpecLighting;\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 v3Pos;\nvarying float depthValue;\nvarying float vFogAmount;\n\nvarying vec4 vPosRelToLight; \nvarying vec3 vLightDir; \nvarying vec3 vNormalWC;\nvarying float currSunIdx;\nvarying float vAltitude;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\tvNormal = normalize((normalMatrix4 * vec4(normal.x, normal.y, normal.z, 1.0)).xyz); // original.***\n\tvLightDir = vec3(normalMatrix4*vec4(sunDirWC.xyz, 1.0)).xyz;\n\tvAltitude = altitude;\n\t\n\tcurrSunIdx = -1.0; // initially no apply shadow.\n\tif(bApplyShadow && !bIsMakingDepth)\n\t{\n\t\tvec3 rotatedNormal = vec3(0.0, 0.0, 1.0); // provisional.***\n\t\tvNormalWC = rotatedNormal;\n\t\t\t\t\t\n\t\t// the sun lights count are 2.\n\t\tvec3 currSunPosLOW;\n\t\tvec3 currSunPosHIGH;\n\t\tmat4 currSunMatrix;\n\t\tif(sunIdx == 0)\n\t\t{\n\t\t\tcurrSunPosLOW = sunPosLOW[0];\n\t\t\tcurrSunPosHIGH = sunPosHIGH[0];\n\t\t\tcurrSunMatrix = sunMatrix[0];\n\t\t\tcurrSunIdx = 0.5;\n\t\t}\n\t\telse if(sunIdx == 1)\n\t\t{\n\t\t\tcurrSunPosLOW = sunPosLOW[1];\n\t\t\tcurrSunPosHIGH = sunPosHIGH[1];\n\t\t\tcurrSunMatrix = sunMatrix[1];\n\t\t\tcurrSunIdx = 1.5;\n\t\t}\n\t\t\n\t\t// Calculate the vertex relative to light.***\n\t\tvec3 highDifferenceSun = objPosHigh.xyz - currSunPosHIGH.xyz;\n\t\tvec3 lowDifferenceSun = objPosLow.xyz - currSunPosLOW.xyz;\n\t\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\t\tvec4 posRelToLightAux = currSunMatrix * pos4Sun;\n\t\t\n\t\t// now, check if "posRelToLightAux" is inside of the lightVolume (inside of the depthTexture of the light).\n\t\tvec3 posRelToLightNDC = posRelToLightAux.xyz / posRelToLightAux.w;\n\t\tvPosRelToLight = posRelToLightAux;\n\t}\n\t\n\tif(bApplySpecularLighting)\n\t{\n\t\tapplySpecLighting = 1.0;\n\t}\n\telse{\n\t\tapplySpecLighting = -1.0;\n\t}\n\t\n\tif(bIsMakingDepth)\n\t{\n\t\t\n\t\tdepthValue = (modelViewMatrixRelToEye * pos4).z/far;\n\t}\n\telse\n\t{\n\t\t\n\t\tvTexCoord = texCoord;\n\t}\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tv3Pos = (modelViewMatrixRelToEye * pos4).xyz;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://www.gamasutra.com/blogs/BranoKemen/20090812/85207/Logarithmic_Depth_Buffer.php\n\t\t// z = log(C*z + 1) / log(C*Far + 1) * w\n\t\t// https://android.developreference.com/article/21119961/Logarithmic+Depth+Buffer+OpenGL\n\t\t//if(v3Pos.z < 0.0)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t\t}\n\t}\n\n\t// calculate fog amount.\n\tfloat fogParam = 1.15 * v3Pos.z/(far - 10000.0);\n\tfloat fogParam2 = fogParam*fogParam;\n\tvFogAmount = fogParam2*fogParam2;\n\tif(vFogAmount < 0.0)\n\tvFogAmount = 0.0;\n\telse if(vFogAmount > 1.0)\n\tvFogAmount = 1.0;\n\t//vFogAmount = ((-v3Pos.z))/(far);\n}',update_frag:"precision highp float;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_wind;\nuniform vec2 u_wind_res;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_interpolation;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\nuniform bool u_flipTexCoordY_windMap;\nuniform vec4 u_visibleTilesRanges[16];\nuniform int u_visibleTilesRangesCount;\n\nvarying vec2 v_tex_pos;\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\n// wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\nvec2 lookup_wind(const vec2 uv) {\n    //return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n\t\n    vec2 px = 1.0 / u_wind_res;\n    vec2 vc = (floor(uv * u_wind_res)) * px;\n    vec2 f = fract(uv * u_wind_res);\n    vec2 tl = texture2D(u_wind, vc).rg;\n    vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n    vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n    vec2 br = texture2D(u_wind, vc + px).rg;\n    return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n\t\n}\n\nbool checkFrustumCulling(vec2 pos)\n{\n\tfor(int i=0; i<16; i++)\n\t{\n\t\tif(i >= u_visibleTilesRangesCount)\n\t\treturn false;\n\t\t\n\t\tvec4 range = u_visibleTilesRanges[i]; // range = minX(x), minY(y), maxX(z), maxY(w)\n\n\t\tfloat minX = range.x;\n\t\tfloat minY = range.y;\n\t\tfloat maxX = range.z;\n\t\tfloat maxY = range.w;\n\t\t\n\t\tif(pos.x > minX && pos.x < maxX)\n\t\t{\n\t\t\tif(pos.y > minY && pos.y < maxY)\n\t\t\t{\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t}\n\treturn false;\n}\n\nvoid main() {\n    vec4 color = texture2D(u_particles, v_tex_pos);\n    vec2 pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n\tvec2 windMapTexCoord = pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, lookup_wind(windMapTexCoord));\n    float speed_t = length(velocity) / length(u_wind_max);\n\n    // take EPSG:4236 distortion into account for calculating where the particle moved\n\tfloat minLat = u_geoCoordRadiansMin.y;\n\tfloat maxLat = u_geoCoordRadiansMax.y;\n\tfloat latRange = maxLat - minLat;\n\tfloat distortion = cos((minLat + pos.y * latRange ));\n    vec2 offset = vec2(velocity.x / distortion, -velocity.y) * 0.0001 * u_speed_factor * u_interpolation;\n\n    // update particle position, wrapping around the date line\n    pos = fract(1.0 + pos + offset);\n\n\n    // drop rate is a chance a particle will restart at random position, to avoid degeneration\n\tfloat drop = 0.0;\n\n\tif(u_interpolation < 0.99) // 0.9\n\t{\n\t\tdrop = 0.0;\n\t}\n\telse\n\t{\n\t\t// a random seed to use for the particle drop\n\t\tvec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\t\tfloat drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n\t\tdrop = step(1.0 - drop_rate, rand(seed));\n\t}\n\t/*\n\tif(drop > 0.5) // 0.01\n\t{\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tfloat randomValue = (u_rand_seed);\n\t\tint index = int(floor(float(u_visibleTilesRangesCount+1)*(randomValue)));\n\t\tfor(int i=0; i<32; i++)\n\t\t{\n\t\t\tif(i >= u_visibleTilesRangesCount)\n\t\t\tbreak;\n\t\t\n\t\t\tif(i == index)\n\t\t\t{\n\t\t\t\tvec4 posAux4 = u_visibleTilesRanges[i];\n\t\t\t\tfloat width = (posAux4.z-posAux4.x);\n\t\t\t\tfloat height = (posAux4.w-posAux4.y);\n\t\t\t\tfloat scaledX = posAux4.x + random_pos.x*width;\n\t\t\t\tfloat scaledY = posAux4.y + random_pos.y*height;\n\t\t\t\trandom_pos = vec2(scaledX, 1.0-scaledY);\n\t\t\t\tpos = random_pos;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t*/\n\t\n\t\n\tif(drop > 0.01)\n\t{\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tpos = random_pos;\n\t}\n\t\n\n    // encode the new particle position back into RGBA\n    gl_FragColor = vec4(\n        fract(pos * 255.0),\n        floor(pos * 255.0) / 255.0);\n}",vol_fs:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n//---------------------------------------------------------\n// MACROS\n//---------------------------------------------------------\n\n#define EPS       0.0001\n#define PI        3.14159265\n#define HALFPI    1.57079633\n#define ROOTTHREE 1.73205081\n\n#define EQUALS(A,B) ( abs((A)-(B)) < EPS )\n#define EQUALSZERO(A) ( ((A)<EPS) && ((A)>-EPS) )\n\n\n//---------------------------------------------------------\n// CONSTANTS\n//---------------------------------------------------------\n\n// 32 48 64 96 128\n#define MAX_STEPS 64\n\n#define LIGHT_NUM 2\n//#define uTMK 20.0\n#define TM_MIN 0.05\n\n\n//---------------------------------------------------------\n// SHADER VARS\n//---------------------------------------------------------\n\nvarying vec2 vUv;\nvarying vec3 vPos0; // position in world coords\nvarying vec3 vPos1; // position in object coords\nvarying vec3 vPos1n; // normalized 0 to 1, for texture lookup\n\nuniform vec3 uOffset; // TESTDEBUG\n\nuniform vec3 uCamPos;\n\nuniform vec3 uLightP[LIGHT_NUM];  // point lights\nuniform vec3 uLightC[LIGHT_NUM];\n\nuniform vec3 uColor;      // color of volume\nuniform sampler2D uTex;   // 3D(2D) volume texture\nuniform vec3 uTexDim;     // dimensions of texture\n\nuniform float uTMK;\n\nfloat gStepSize;\nfloat gStepFactor;\n\n\n//---------------------------------------------------------\n// PROGRAM\n//---------------------------------------------------------\n\n// TODO: convert world to local volume space\nvec3 toLocal(vec3 p) {\n  return p + vec3(0.5);\n}\n\nfloat sampleVolTex(vec3 pos) {\n  pos = pos + uOffset; // TESTDEBUG\n  \n  // note: z is up in 3D tex coords, pos.z is tex.y, pos.y is zSlice\n  float zSlice = (1.0-pos.y)*(uTexDim.z-1.0);   // float value of slice number, slice 0th to 63rd\n  \n  // calc pixels from top of texture\n  float fromTopPixels =\n    floor(zSlice)*uTexDim.y +   // offset pix from top of tex, from upper slice  \n    pos.z*(uTexDim.y-1.0) +     // y pos in pixels, range 0th to 63rd pix\n    0.5;  // offset to center of cell\n    \n  // calc y tex coords of two slices\n  float y0 = min( (fromTopPixels)/(uTexDim.y*uTexDim.z), 1.0);\n  float y1 = min( (fromTopPixels+uTexDim.y)/(uTexDim.y*uTexDim.z), 1.0);\n    \n  // get (bi)linear interped texture reads at two slices\n  float z0 = texture2D(uTex, vec2(pos.x, y0)).g;\n  float z1 = texture2D(uTex, vec2(pos.x, y1)).g;\n  \n  // lerp them again (thus trilinear), using remaining fraction of zSlice\n  return mix(z0, z1, fract(zSlice));\n}\n\n// accumulate density by ray marching\nfloat getDensity(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  float density = 0.0;\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    density += (1.0-density) * sampleVolTex(pos) * gStepFactor;\n    //density += sampleVolTex(pos);\n    \n    pos += step;\n    \n    if (density > 0.95 ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  return density;\n}\n\n// calc transmittance\nfloat getTransmittance(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  float tm = 1.0;\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    tm *= exp( -uTMK*gStepSize*sampleVolTex(pos) );\n    \n    pos += step;\n    \n    if (tm < TM_MIN ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  return tm;\n}\n\nvec4 raymarchNoLight(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  vec3 col = vec3(0.0);\n  float tm = 1.0;\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    float dtm = exp( -uTMK*gStepSize*sampleVolTex(pos) );\n    tm *= dtm;\n    \n    col += (1.0-dtm) * uColor * tm;\n    \n    pos += step;\n    \n    if (tm < TM_MIN ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  float alpha = 1.0-tm;\n  return vec4(col/alpha, alpha);\n}\n\nvec4 raymarchLight(vec3 ro, vec3 rd) {\n  vec3 step = rd*gStepSize;\n  vec3 pos = ro;\n  \n  \n  vec3 col = vec3(0.0);   // accumulated color\n  float tm = 1.0;         // accumulated transmittance\n  \n  for (int i=0; i<MAX_STEPS; ++i) {\n    // delta transmittance \n    float dtm = exp( -uTMK*gStepSize*sampleVolTex(pos) );\n    tm *= dtm;\n    \n    // get contribution per light\n    for (int k=0; k<LIGHT_NUM; ++k) {\n      vec3 ld = normalize( toLocal(uLightP[k])-pos );\n      float ltm = getTransmittance(pos,ld);\n      \n      col += (1.0-dtm) * uColor*uLightC[k] * tm * ltm;\n    }\n    \n    pos += step;\n    \n    if (tm < TM_MIN ||\n      pos.x > 1.0 || pos.x < 0.0 ||\n      pos.y > 1.0 || pos.y < 0.0 ||\n      pos.z > 1.0 || pos.z < 0.0)\n      break;\n  }\n  \n  float alpha = 1.0-tm;\n  return vec4(col/alpha, alpha);\n}\n\nvoid main() {\n  // in world coords, just for now\n  vec3 ro = vPos1n;\n  vec3 rd = normalize( ro - toLocal(uCamPos) );\n  //vec3 rd = normalize(ro-uCamPos);\n  \n  // step_size = root_three / max_steps ; to get through diagonal  \n  gStepSize = ROOTTHREE / float(MAX_STEPS);\n  gStepFactor = 32.0 * gStepSize;\n  \n  gl_FragColor = raymarchLight(ro, rd);\n  //gl_FragColor = vec4(uColor, getDensity(ro,rd));\n  //gl_FragColor = vec4(vec3(sampleVolTex(pos)), 1.0);\n  //gl_FragColor = vec4(vPos1n, 1.0);\n  //gl_FragColor = vec4(uLightP[0], 1.0);\n}",vol_vs:"attribute vec3 aPosition;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nvarying vec3 vNormal;\nvarying vec3 vPosObjectCoord;\nvarying vec3 vPosCameraCoord;\nvarying vec3 vPosWorldCoord;\n\n// Render a fullScreen quad (2 triangles).***\nvoid main()\n{\n\tvec4 rotatedPos = buildingRotMatrix * vec4(position.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}",wgs84_volumFS:"precision mediump float;\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D volumeTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInv;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform float aspectRatio;\nuniform float far;\nuniform float fovyRad;\nuniform float tanHalfFovy;\n\n// volume tex definition.***\nuniform int texNumCols;\nuniform int texNumRows;\nuniform int texNumSlices;\nuniform int numSlicesPerStacks;\nuniform int slicesNumCols;\nuniform int slicesNumRows;\nuniform float maxLon;\nuniform float minLon;\nuniform float maxLat;\nuniform float minLat;\nuniform float maxAlt;\nuniform float minAlt;\nuniform vec4 cuttingPlanes[6];   \nuniform int cuttingPlanesCount;\n\nuniform float maxValue;\nuniform float minValue;\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tanHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n} \n\nfloat squaredLength(vec3 point1, vec3 point2)\n{\n\tfloat a = point1.x - point2.x;\n\tfloat b = point1.y - point2.y;\n\tfloat c = point1.z - point2.z;\n\t\n\tfloat sqDist = a*a + b*b + c*c;\n\treturn sqDist;\n}\n\nvoid intersectionLineSphere(float radius, vec3 rayPos, vec3 rayDir, out int intersectType, out vec3 nearIntersectPos, out vec3 farIntersectPos)\n{\n\t// line: (x, y, z) = x1 + t(x2 - x1), y1 + t(y2 - y1), z1 + t(z2 - z1)\n\t// sphere: (x - x3)^2 + (y - y3)^2 + (z - z3)^2 = r^2, where x3, y3, z3 is the center of the sphere.\n\t\n\t// line:\n\tvec3 p1 = rayPos;\n\tvec3 lineDir = rayDir;\n\tfloat dist = 1000.0;// any value is ok.***\n\tvec3 p2 = vec3(p1.x + lineDir.x * dist, p1.y + lineDir.y * dist, p1.z + lineDir.z * dist);\n\tfloat x1 = p1.x;\n\tfloat y1 = p1.y;\n\tfloat z1 = p1.z;\n\tfloat x2 = p2.x;\n\tfloat y2 = p2.y;\n\tfloat z2 = p2.z;\n\n\t// sphere:\n\tfloat x3 = 0.0;\n\tfloat y3 = 0.0;\n\tfloat z3 = 0.0;\n\tfloat r = radius;\n\t\n\t// resolve:\n\tfloat x21 = (x2-x1);\n\tfloat y21 = (y2-y1);\n\tfloat z21 = (z2-z1);\n\t\n\tfloat a = x21*x21 + y21*y21 + z21*z21;\n\t\n\tfloat x13 = (x1-x3);\n\tfloat y13 = (y1-y3);\n\tfloat z13 = (z1-z3);\n\t\n\tfloat b = 2.0*(x21 * x13 + y21 * y13 + z21 * z13);\n\t\n\tfloat c = x3*x3 + y3*y3 + z3*z3 + x1*x1 + y1*y1 + z1*z1 - 2.0*(x3*x1 + y3*y1+ z3*z1) - r*r;\n\t\n\tfloat discriminant = b*b - 4.0*a*c;\n\t\n\tif (discriminant < 0.0)\n\t{\n\t\t// no intersection.***\n\t\tintersectType = 0;\n\t}\n\telse if (discriminant == 0.0)\n\t{\n\t\t// this is tangent.***\n\t\tintersectType = 1;\n\t\t\n\t\tfloat t1 = (-b)/(2.0*a);\n\t\tnearIntersectPos = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t}\n\telse\n\t{\n\t\tintersectType = 2;\n\t\t\n\t\t// find the nearest to p1.***\n\t\tfloat sqrtDiscriminant = sqrt(discriminant);\n\t\tfloat t1 = (-b + sqrtDiscriminant)/(2.0*a);\n\t\tfloat t2 = (-b - sqrtDiscriminant)/(2.0*a);\n\t\t\n\t\t// solution 1.***\n\t\tvec3 intersectPoint1 = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t\tvec3 intersectPoint2 = vec3(x1 + (x2 - x1)*t2, y1 + (y2 - y1)*t2, z1 + (z2 - z1)*t2);\n\t\t\n\t\tfloat dist1 = squaredLength(p1,intersectPoint1);\n\t\tfloat dist2 = squaredLength(p1,intersectPoint2);\n\t\t\n\t\t// nearIntersectPos, out vec3 farIntersectPos\n\t\tif (dist1 < dist2)\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint1;\n\t\t\tfarIntersectPos = intersectPoint2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint2;\n\t\t\tfarIntersectPos = intersectPoint1;\n\t\t}\n\t}\n}\n\nfloat atan2(float y, float x) \n{\n\tif(x > 0.0)\n\t{\n\t\treturn atan(y/x);\n\t}\n\telse if(x < 0.0)\n\t{\n\t\tif(y >= 0.0)\n\t\t{\n\t\t\treturn atan(y/x) + M_PI;\n\t\t}\n\t\telse{\n\t\t\treturn atan(y/x) - M_PI;\n\t\t}\n\t}\n\telse if(x == 0.0)\n\t{\n\t\tif(y>0.0)\n\t\t{\n\t\t\treturn M_PI/2.0;\n\t\t}\n\t\telse if(y<0.0)\n\t\t{\n\t\t\treturn -M_PI/2.0;\n\t\t}\n\t\telse{\n\t\t\treturn 0.0; // return undefined.***\n\t\t}\n\t}\n}\n\nvoid cartesianToGeographicWgs84(vec3 point, out vec3 result) \n{\n\t// From WebWorldWind.***\n\t// According to H. Vermeille, An analytical method to transform geocentric into geodetic coordinates\n\t// http://www.springerlink.com/content/3t6837t27t351227/fulltext.pdf\n\t\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat equatorialRadius = 6378137.0;\n\n\t// wwwind coord type.***\n\t// X = point.z;\n\t// Y = point.x;\n\t// Z = point.y;\n\n\t// magoWorld coord type.***\n\tfloat X = point.x;\n\tfloat Y = point.y;\n\tfloat Z = point.z;\n\tfloat XXpYY = X * X + Y * Y;\n\tfloat sqrtXXpYY = sqrt(XXpYY);\n\tfloat a = equatorialRadius;\n\tfloat ra2 = 1.0 / (a * a);\n\tfloat e2 = firstEccentricitySquared;\n\tfloat e4 = e2 * e2;\n\tfloat p = XXpYY * ra2;\n\tfloat q = Z * Z * (1.0 - e2) * ra2;\n\tfloat r = (p + q - e4) / 6.0;\n\tfloat h;\n\tfloat phi;\n\tfloat u;\n\tfloat evoluteBorderTest = 8.0 * r * r * r + e4 * p * q;\n\tfloat rad1;\n\tfloat rad2;\n\tfloat rad3;\n\tfloat atanAux;\n\tfloat v;\n\tfloat w;\n\tfloat k;\n\tfloat D;\n\tfloat sqrtDDpZZ;\n\tfloat e;\n\tfloat lambda;\n\tfloat s2;\n\tfloat cbrtFac = 1.0/3.0;\n\n\tif (evoluteBorderTest > 0.0 || q != 0.0) \n\t{\n\t\tif (evoluteBorderTest > 0.0) \n\t\t{\n\t\t\t// Step 2: general case\n\t\t\trad1 = sqrt(evoluteBorderTest);\n\t\t\trad2 = sqrt(e4 * p * q);\n\n\t\t\t// 10*e2 is my arbitrary decision of what Vermeille means by near... the cusps of the evolute.\n\t\t\tif (evoluteBorderTest > 10.0 * e2) \n\t\t\t{\n\t\t\t\trad3 = pow((rad1 + rad2) * (rad1 + rad2), cbrtFac);\n\t\t\t\tu = r + 0.5 * rad3 + 2.0 * r * r / rad3;\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tu = r + 0.5 * pow((rad1 + rad2) * (rad1 + rad2), cbrtFac)\n\t\t\t\t\t+ 0.5 * pow((rad1 - rad2) * (rad1 - rad2), cbrtFac);\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\t// Step 3: near evolute\n\t\t\trad1 = sqrt(-evoluteBorderTest);\n\t\t\trad2 = sqrt(-8.0 * r * r * r);\n\t\t\trad3 = sqrt(e4 * p * q);\n\t\t\tatanAux = 2.0 * atan2(rad3, rad1 + rad2) / 3.0;\n\n\t\t\tu = -4.0 * r * sin(atanAux) * cos(M_PI / 6.0 + atanAux);\n\t\t}\n\n\t\tv = sqrt(u * u + e4 * q);\n\t\tw = e2 * (u + v - q) / (2.0 * v);\n\t\tk = (u + v) / (sqrt(w * w + u + v) + w);\n\t\tD = k * sqrtXXpYY / (k + e2);\n\t\tsqrtDDpZZ = sqrt(D * D + Z * Z);\n\n\t\th = (k + e2 - 1.0) * sqrtDDpZZ / k;\n\t\tphi = 2.0 * atan2(Z, sqrtDDpZZ + D);\n\t}\n\telse \n\t{\n\t\t// Step 4: singular disk\n\t\trad1 = sqrt(1.0 - e2);\n\t\trad2 = sqrt(e2 - p);\n\t\te = sqrt(e2);\n\n\t\th = -a * rad1 * rad2 / e;\n\t\tphi = rad2 / (e * rad2 + rad1 * sqrt(p));\n\t}\n\n\t// Compute lambda\n\ts2 = sqrt(2.0);\n\tif ((s2 - 1.0) * Y < sqrtXXpYY + X) \n\t{\n\t\t// case 1 - -135deg < lambda < 135deg\n\t\tlambda = 2.0 * atan2(Y, sqrtXXpYY + X);\n\t}\n\telse if (sqrtXXpYY + Y < (s2 + 1.0) * X) \n\t{\n\t\t// case 2 - -225deg < lambda < 45deg\n\t\tlambda = -M_PI * 0.5 + 2.0 * atan2(X, sqrtXXpYY - Y);\n\t}\n\telse \n\t{\n\t\t// if (sqrtXXpYY-Y<(s2=1)*X) {  // is the test, if needed, but it's not\n\t\t// case 3: - -45deg < lambda < 225deg\n\t\tlambda = M_PI * 0.5 - 2.0 * atan2(X, sqrtXXpYY + Y);\n\t}\n\n\tfloat factor = 180.0 / M_PI;\n\tresult = vec3(factor * lambda, factor * phi, h); // (longitude, latitude, altitude).***\n}\n\nbool isPointRearCamera(vec3 point, vec3 camPos, vec3 camDir)\n{\n\tbool isRear = false;\n\tfloat lambdaX = 10.0;\n\tfloat lambdaY = 10.0;\n\tfloat lambdaZ = 10.0;\n\tif(abs(camDir.x) > 0.0000001)\n\t{\n\t\tfloat lambdaX = (point.x - camPos.x)/camDir.x;\n\t}\n\telse if(abs(camDir.y) > 0.0000001)\n\t{\n\t\tfloat lambdaY = (point.y - camPos.y)/camDir.y;\n\t}\n\telse if(abs(camDir.z) > 0.0000001)\n\t{\n\t\tfloat lambdaZ = (point.z - camPos.z)/camDir.z;\n\t}\n\t\n\tif(lambdaZ < 0.0 || lambdaY < 0.0 || lambdaX < 0.0)\n\t\t\tisRear = true;\n\t\telse\n\t\t\tisRear = false;\n\treturn isRear;\n}\n\nfloat distPointToPlane(vec3 point, vec4 plane)\n{\n\treturn (point.x*plane.x + point.y*plane.y + point.z*plane.z + plane.w);\n}\n\nbool getValue(vec3 geoLoc, out vec4 value)\n{\n\t// geoLoc = (longitude, latitude, altitude).***\n\tfloat lon = geoLoc.x;\n\tfloat lat = geoLoc.y;\n\tfloat alt = geoLoc.z;\n\t\n\t// 1rst, check if geoLoc intersects the volume.***\n\t// Note: minLon, maxLon, minLat, maxLat, minAlt & maxAlt are uniforms.***\n\tif(lon < minLon || lon > maxLon)\n\t\treturn false;\n\telse if(lat < minLat || lat > maxLat)\n\t\treturn false;\n\telse if(alt < minAlt || alt > maxAlt)\n\t\treturn false;\n\t\t\n\tfloat lonRange = maxLon - minLon;\n\tfloat latRange = maxLat - minLat;\n\tfloat altRange = maxAlt - minAlt;\n\tfloat col = (lon - minLon)/lonRange * float(slicesNumCols); \n\tfloat row = (lat - minLat)/latRange * float(slicesNumRows); \n\tfloat slice = (alt - minAlt)/altRange * float(texNumSlices); // slice if texture has only one stack.***\n\tfloat sliceDown = floor(slice);\n\tfloat sliceUp = ceil(slice);\n\tfloat sliceDownDist = slice - sliceDown;\n\t//slice = 18.0; // test. force slice to nearest to ground.***\n\t\n\tfloat stackDown = floor(sliceDown/float(numSlicesPerStacks));\n\tfloat realSliceDown = sliceDown - stackDown * float(numSlicesPerStacks);\n\tfloat tx = stackDown * float(slicesNumCols) + col;\n\tfloat ty = realSliceDown * float(slicesNumRows) + row;\n\tvec2 texCoord = vec2(tx/float(texNumCols), ty/float(texNumRows));\n\tvec4 valueDown = texture2D(volumeTex, texCoord);\n\t\n\tif(sliceDown < float(texNumSlices-1))\n\t{\n\t\tfloat stackUp = floor(sliceUp/float(numSlicesPerStacks));\n\t\tfloat realSliceUp = sliceUp - stackUp * float(numSlicesPerStacks);\n\t\tfloat tx2 = stackUp * float(slicesNumCols) + col;\n\t\tfloat ty2 = realSliceUp * float(slicesNumRows) + row;\n\t\tvec2 texCoord2 = vec2(tx2/float(texNumCols), ty2/float(texNumRows));\n\t\tvec4 valueUp = texture2D(volumeTex, texCoord2);\n\t\tvalue = valueDown*(1.0-sliceDownDist)+valueUp*(sliceDownDist);\n\t}\n\telse{\n\t\tvalue = valueDown;\n\t}\n\t//if((value.r * (maxValue - minValue)) > maxValue * 0.3)\n\t//\treturn true;\n\t//else return false;\n\treturn true;\n}\n\nvoid main() {\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\tfloat linearDepth = 1.0; // the quad is 1m of dist of the camera.***          \n    vec3 rayCamCoord = getViewRay(screenPos) * linearDepth;  \n\trayCamCoord = normalize(rayCamCoord);\n\t\n\tvec3 camTarget = rayCamCoord * 10000.0;\n\tvec4 camPosWorld = vec4(encodedCameraPositionMCHigh + encodedCameraPositionMCLow, 1.0);\n\tvec4 camTargetWorld = modelViewMatrixInv * vec4(camTarget.xyz, 1.0);\n\tvec3 camDirWorld = camTargetWorld.xyz - camPosWorld.xyz;\n\tcamDirWorld = normalize(camDirWorld);\n\n\t// now, must find sampling points.***\n\tint intersectType = 0;\n\tvec3 nearP;\n\tvec3 farP;\n\tfloat radius = 6378137.0 + maxAlt; // equatorial radius.***\n\t//radius = 6250000.0 + maxAlt; // test radius.***\n\t\n\tintersectionLineSphere(radius, camPosWorld.xyz, camDirWorld, intersectType, nearP, farP);\n\t\n\tif(intersectType == 0)\n\t{\n\t\tdiscard;\n\t}\n\t\t\n\tif(intersectType == 1)\n\t{\n\t\t// provisionally discard.***\n\t\tdiscard;\t\n\t}\n\t\n\t// check if nearP is rear of the camera.***\n\tif(isPointRearCamera(nearP, camPosWorld.xyz, camDirWorld.xyz))\n\t{\n\t\tnearP = vec3(camPosWorld.xyz);\n\t}\n\tfloat dist = distance(nearP, farP);\n\tfloat testDist = dist;\n\tif(dist > 1500000.0)\n\t\ttestDist = 1500000.0;\n\t\n\t// now calculate the geographicCoords of 2 points.***\n\t// now, depending the dist(nearP, endPoint), determine numSmples.***\n\t// provisionally take 16 samples.***\n\tfloat numSamples = 512.0;\n\tvec4 color = vec4(0.0, 0.0, 0.0, 0.0);\n\tfloat alpha = 0.8/numSamples;\n\tfloat tempRange = maxValue - minValue;\n\tvec4 value;\n\tfloat totalValue = 0.0;\n\tint sampledsCount = 0;\n\tint intAux = 0;\n\tfloat increDist = testDist / numSamples;\n\tint c = 0;\n\tbool isPointRearPlane = true;\n\tfor(int i=0; i<512; i++)\n\t{\n\t\tvec3 currGeoLoc;\n\t\tvec3 currPosWorld = vec3(nearP.x + camDirWorld.x * increDist*float(c), nearP.y + camDirWorld.y * increDist*float(c), nearP.z + camDirWorld.z * increDist*float(c));\n\t\t// Check if the currPosWorld is in front or rear of planes (if exist planes).***\n\t\tint planesCounter = 0;\n\t\tfor(int j=0; j<6; j++)\n\t\t{\n\t\t\tif(planesCounter == cuttingPlanesCount)\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tvec4 plane = cuttingPlanes[j];\n\t\t\tfloat dist = distPointToPlane(currPosWorld, plane);\n\t\t\tif(dist > 0.0)\n\t\t\t{\n\t\t\t\tisPointRearPlane = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tisPointRearPlane = true;\n\t\t\t}\n\t\t\tplanesCounter++;\n\t\t}\n\t\t\n\t\t\n\t\tif(isPointRearPlane)\n\t\t{\n\t\t\tcartesianToGeographicWgs84(currPosWorld, currGeoLoc);\n\t\t\tif(getValue(currGeoLoc, value))\n\t\t\t{\n\t\t\t\tfloat realValue = value.r * tempRange + minValue*255.0;\n\t\t\t\ttotalValue += (value.r);\n\t\t\t\tsampledsCount += 1;\n\t\t\t}\n\t\t}\n\t\tif(sampledsCount >= 1)\n\t\t{\n\t\t\tbreak;\n\t\t}\n\t\tc++;\n\t}\n\tif(sampledsCount == 0)\n\t{\n\t\tdiscard;\n\t}\n\tfloat fValue = totalValue/numSamples;\n\tfValue = totalValue;\n\tif(fValue > 1.0)\n\t{\n\t\tgl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t\treturn;\n\t}\n\tfloat b = 1.0 - fValue;\n\tfloat g;\n\tif(fValue > 0.5)\n\t{\n\t\tg = 2.0-2.0*fValue;\n\t}\n\telse{\n\t\tg = 2.0*fValue;\n\t}\n\tfloat r = fValue;\n\tcolor += vec4(r,g,b,0.8);\n\tgl_FragColor = color;\n}",wgs84_volumVS:"precision mediump float;\n\nattribute vec3 position;\nuniform mat4 projectionMatrix;\n\nvoid main()\n{\t\n\tvec4 pos = projectionMatrix * vec4(position.xyz, 1.0);\n    gl_Position = pos;\n}"},ti=function(t,e){if(!(this instanceof ti))throw new Error(ot.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.floatValue};ti.prototype.bindUniform=function(){this.gl.uniform1f(this.uniformLocation,this.floatValue[0])};var ei=function(t,e){if(!(this instanceof ei))throw new Error(ot.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.intValue};ei.prototype.bindUniform=function(){this.gl.uniform1i(this.uniformLocation,this.intValue)};var ii=function(t,e){if(!(this instanceof ii))throw new Error(ot.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.matrix4fv};ii.prototype.bindUniform=function(){this.gl.uniformMatrix4fv(this.uniformLocation,!1,this.matrix4fv)};var ri=function(t,e){if(!(this instanceof ri))throw new Error(ot.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.vec2fv};ri.prototype.bindUniform=function(){this.gl.uniform2fv(this.uniformLocation,this.vec2fv)};var oi=function(t,e){if(!(this instanceof oi))throw new Error(ot.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.vec3fv};oi.prototype.bindUniform=function(){this.gl.uniform3fv(this.uniformLocation,this.vec3fv)};var ni=function(t,e){if(!(this instanceof ni))throw new Error(ot.CONSTRUCT_ERROR);this.gl=t,this.name=e,this.uniformLocation,this.vec4fv};ni.prototype.bindUniform=function(){this.gl.uniform4fv(this.uniformLocation,this.vec4fv)};var ai=function(){this.dataArray,this.width,this.height,this.geographicExtent};ai.prototype.getValue=function(t,e){if(void 0!==this.dataArray&&0!==this.dataArray.length){var i=li.getIndexOfArray(this.width,t,e);return this.dataArray[i]}},ai.prototype.setValue=function(t,e,i){if(void 0===this.dataArray||0===this.dataArray.length)return!1;var r=li.getIndexOfArray(this.width,t,e);this.dataArray[r]=i},ai.getMinMaxValuesOfArray=function(t,e){if(void 0===t||0===t.length)return e;void 0===e&&(e=[]);var i,r,o,n=t.length;r=t[0],o=t[0];for(var a=1;a<n;a++)(i=t[a])>o?o=i:i<r&&(r=i);return e.push(r),e.push(o),e},ai.getColumn=function(t,e,i){if(void 0===i)return[];for(var r,o=t,n=e,a=0;a<o;a++)r=t.getValue(n,a),i.push(r);return i},ai.getSplittedVertical=function(t,e,i,r,o){if(void 0===t)return e;if(void 0===e)return[];var n=t.width,a=t.height,s=Math.floor(n/2),l=new ai,h=new ai,d=s+1,c=n-s;void 0===o&&(o=!1),!0===o&&(c+=1);var u,f=d*a,g=c*a;if(i&&r){var p,v,y,m,x,b,C=i.minGeographicCoord,A=i.maxGeographicCoord,T=(A.longitude-C.longitude)*(d/n),M=new G,P=new G;p=C.longitude,v=C.latitude,y=C.altitude,m=C.longitude+T,x=A.latitude,b=A.altitude,M.setExtent(p,v,y,m,x,b),p=C.longitude+T,v=C.latitude,y=C.altitude,m=A.longitude,x=A.latitude,b=A.altitude,P.setExtent(p,v,y,m,x,b),r.push(M),r.push(P)}l.dataArray=new Float32Array(f),l.width=d,l.height=a,h.dataArray=new Float32Array(g),h.width=c,h.height=a;for(var w=0;w<a;w++){for(var _=0;_<n;_++)u=t.getValue(_,w),_<s?l.setValue(_,w,u):_===s?(l.setValue(_,w,u),h.setValue(_-s,w,u)):h.setValue(_-s,w,u);o&&(u=t.getValue(0,w),h.setValue(h.width-1,w,u))}return e.push(l),e.push(h),e},ai.exaggerateAltitude=function(t){};var si=function(){this.slicesArray};si.prototype.newSlice=function(){void 0===this.slicesArray&&(this.slicesArray=[]);var t=new ai;return this.slicesArray.push(t),t},si.prototype.getSlicesCount=function(){return void 0===this.slicesArray?0:this.slicesArray.length},si.prototype.getSlice=function(t){if(void 0!==this.slicesArray&&!(t>=this.slicesArraylength))return this.slicesArray[t]};var li=function(){this.stacksArray,this.numSlicesPerStack};li.getIndexOfArray=function(t,e,i){return e+i*t},li.getIndexOfArray3D=function(t,e,i,r,o,n,a,s){var l=s*t+o,h=a*e+n,d=r*t;return li.getIndexOfArray(d,l,h)},li.prototype.getStack=function(t){if(void 0!==this.stacksArray&&!(t>=this.stacksArray.length))return this.stacksArray[t]},li.prototype.getStacksCount=function(){return void 0===this.stacksArray?0:this.stacksArray.length},li.prototype.newStack=function(){void 0===this.stacksArray&&(this.stacksArray=[]);var t=new si;return this.stacksArray.push(t),t},li.prototype.reverseSlicesOfStacks=function(){if(void 0!==this.stacksArray)for(var t=this.stacksArray.length,e=0;e<t;e++){this.stacksArray[e].slicesArray.reverse()}},li.prototype.getAnUniqueSlice=function(t){void 0===t&&(t=new ai);var e=this.stacksArray.length,i=this.stacksArray[0];void 0===this.numSlicesPerStack&&(this.numSlicesPerStack=i.slicesArray.length);var r=this.numSlicesPerStack,o=i.slicesArray[0],n=o.width,a=n*e,s=o.height*r;t.width=a,t.height=s;var l=a*s;t.dataArray=new Uint8Array(l);for(var h,d=-1,c=0;c<e;c++)for(var u=(i=this.stacksArray[c]).slicesArray.length,f=0;f<u;f++)for(var g=(o=i.slicesArray[f]).height,p=o.width,v=0;v<g;v++)for(var y=0;y<p;y++){if(y>=n-1);h=o.getValue(y,v),d=li.getIndexOfArray3D(p,g,r,e,y,v,f,c),t.dataArray[d]=h}return t};var hi=function(){};hi.calculateNumStacks=function(t,e,i,r){var o=-1;if(e>t)return-1;for(var n=!1,a=1;!n;){if(i*Math.ceil(r/a)<t){if(n=!0,e*a>t)return-1;o=a}if(++a>=r)return-1}return o},hi.convertMonoStackImage3DToMultiStackImage3D=function(t,e,i){if(void 0!==t&&void 0!==t.stacksArray&&0!==t.stacksArray.length){void 0===e&&(e=new li);var r=t.stacksArray[0],o=(u=r.slicesArray[0]).width,n=u.height,a=r.slicesArray.length,s=hi.calculateNumStacks(i,o,n,a),l=Math.ceil(a/s);e.numSlicesPerStack=l;var h=0,d=e.newStack();d.slicesArray=[];for(var c=0;c<a;c++){h>=l&&((d=e.newStack()).slicesArray=[],h=0);var u=r.slicesArray[c];d.slicesArray.push(u),h++}return e.reverseSlicesOfStacks(),e}};var di={lat:[89.921875,89.765625,89.609375,89.453125,89.296875,89.140625,88.984375,88.828125,88.671875,88.515625,88.359375,88.203125,88.046875,87.890625,87.734375,87.578125,87.421875,87.265625,87.109375,86.953125,86.796875,86.640625,86.484375,86.328125,86.171875,86.015625,85.859375,85.703125,85.546875,85.390625,85.234375,85.078125,84.921875,84.765625,84.609375,84.453125,84.296875,84.140625,83.984375,83.828125,83.671875,83.515625,83.359375,83.203125,83.046875,82.890625,82.734375,82.578125,82.421875,82.265625,82.109375,81.953125,81.796875,81.640625,81.484375,81.328125,81.171875,81.015625,80.859375,80.703125,80.546875,80.390625,80.234375,80.078125,79.921875,79.765625,79.609375,79.453125,79.296875,79.140625,78.984375,78.828125,78.671875,78.515625,78.359375,78.203125,78.046875,77.890625,77.734375,77.578125,77.421875,77.265625,77.109375,76.953125,76.796875,76.640625,76.484375,76.328125,76.171875,76.015625,75.859375,75.703125,75.546875,75.390625,75.234375,75.078125,74.921875,74.765625,74.609375,74.453125,74.296875,74.140625,73.984375,73.828125,73.671875,73.515625,73.359375,73.203125,73.046875,72.890625,72.734375,72.578125,72.421875,72.265625,72.109375,71.953125,71.796875,71.640625,71.484375,71.328125,71.171875,71.015625,70.859375,70.703125,70.546875,70.390625,70.234375,70.078125,69.921875,69.765625,69.609375,69.453125,69.296875,69.140625,68.984375,68.828125,68.671875,68.515625,68.359375,68.203125,68.046875,67.890625,67.734375,67.578125,67.421875,67.265625,67.109375,66.953125,66.796875,66.640625,66.484375,66.328125,66.171875,66.015625,65.859375,65.703125,65.546875,65.390625,65.234375,65.078125,64.921875,64.765625,64.609375,64.453125,64.296875,64.140625,63.984375,63.828125,63.671875,63.515625,63.359375,63.203125,63.046875,62.890625,62.734375,62.578125,62.421875,62.265625,62.109375,61.953125,61.796875,61.640625,61.484375,61.328125,61.171875,61.015625,60.859375,60.703125,60.546875,60.390625,60.234375,60.078125,59.921875,59.765625,59.609375,59.453125,59.296875,59.140625,58.984375,58.828125,58.671875,58.515625,58.359375,58.203125,58.046875,57.890625,57.734375,57.578125,57.421875,57.265625,57.109375,56.953125,56.796875,56.640625,56.484375,56.328125,56.171875,56.015625,55.859375,55.703125,55.546875,55.390625,55.234375,55.078125,54.921875,54.765625,54.609375,54.453125,54.296875,54.140625,53.984375,53.828125,53.671875,53.515625,53.359375,53.203125,53.046875,52.890625,52.734375,52.578125,52.421875,52.265625,52.109375,51.953125,51.796875,51.640625,51.484375,51.328125,51.171875,51.015625,50.859375,50.703125,50.546875,50.390625,50.234375,50.078125,49.921875,49.765625,49.609375,49.453125,49.296875,49.140625,48.984375,48.828125,48.671875,48.515625,48.359375,48.203125,48.046875,47.890625,47.734375,47.578125,47.421875,47.265625,47.109375,46.953125,46.796875,46.640625,46.484375,46.328125,46.171875,46.015625,45.859375,45.703125,45.546875,45.390625,45.234375,45.078125,44.921875,44.765625,44.609375,44.453125,44.296875,44.140625,43.984375,43.828125,43.671875,43.515625,43.359375,43.203125,43.046875,42.890625,42.734375,42.578125,42.421875,42.265625,42.109375,41.953125,41.796875,41.640625,41.484375,41.328125,41.171875,41.015625,40.859375,40.703125,40.546875,40.390625,40.234375,40.078125,39.921875,39.765625,39.609375,39.453125,39.296875,39.140625,38.984375,38.828125,38.671875,38.515625,38.359375,38.203125,38.046875,37.890625,37.734375,37.578125,37.421875,37.265625,37.109375,36.953125,36.796875,36.640625,36.484375,36.328125,36.171875,36.015625,35.859375,35.703125,35.546875,35.390625,35.234375,35.078125,34.921875,34.765625,34.609375,34.453125,34.296875,34.140625,33.984375,33.828125,33.671875,33.515625,33.359375,33.203125,33.046875,32.890625,32.734375,32.578125,32.421875,32.265625,32.109375,31.953125,31.796875,31.640625,31.484375,31.328125,31.171875,31.015625,30.859375,30.703125,30.546875,30.390625,30.234375,30.078125,29.921875,29.765625,29.609375,29.453125,29.296875,29.140625,28.984375,28.828125,28.671875,28.515625,28.359375,28.203125,28.046875,27.890625,27.734375,27.578125,27.421875,27.265625,27.109375,26.953125,26.796875,26.640625,26.484375,26.328125,26.171875,26.015625,25.859375,25.703125,25.546875,25.390625,25.234375,25.078125,24.921875,24.765625,24.609375,24.453125,24.296875,24.140625,23.984375,23.828125,23.671875,23.515625,23.359375,23.203125,23.046875,22.890625,22.734375,22.578125,22.421875,22.265625,22.109375,21.953125,21.796875,21.640625,21.484375,21.328125,21.171875,21.015625,20.859375,20.703125,20.546875,20.390625,20.234375,20.078125,19.921875,19.765625,19.609375,19.453125,19.296875,19.140625,18.984375,18.828125,18.671875,18.515625,18.359375,18.203125,18.046875,17.890625,17.734375,17.578125,17.421875,17.265625,17.109375,16.953125,16.796875,16.640625,16.484375,16.328125,16.171875,16.015625,15.859375,15.703125,15.546875,15.390625,15.234375,15.078125,14.921875,14.765625,14.609375,14.453125,14.296875,14.140625,13.984375,13.828125,13.671875,13.515625,13.359375,13.203125,13.046875,12.890625,12.734375,12.578125,12.421875,12.265625,12.109375,11.953125,11.796875,11.640625,11.484375,11.328125,11.171875,11.015625,10.859375,10.703125,10.546875,10.390625,10.234375,10.078125,9.921875,9.765625,9.609375,9.453125,9.296875,9.140625,8.984375,8.828125,8.671875,8.515625,8.359375,8.203125,8.046875,7.890625,7.734375,7.578125,7.421875,7.265625,7.109375,6.953125,6.796875,6.640625,6.484375,6.328125,6.171875,6.015625,5.859375,5.703125,5.546875,5.390625,5.234375,5.078125,4.921875,4.765625,4.609375,4.453125,4.296875,4.140625,3.984375,3.828125,3.671875,3.515625,3.359375,3.203125,3.046875,2.890625,2.734375,2.578125,2.421875,2.265625,2.109375,1.953125,1.796875,1.640625,1.484375,1.328125,1.171875,1.015625,.859375,.703125,.546875,.390625,.234375,.078125,-.078125,-.234375,-.390625,-.546875,-.703125,-.859375,-1.015625,-1.171875,-1.328125,-1.484375,-1.640625,-1.796875,-1.953125,-2.109375,-2.265625,-2.421875,-2.578125,-2.734375,-2.890625,-3.046875,-3.203125,-3.359375,-3.515625,-3.671875,-3.828125,-3.984375,-4.140625,-4.296875,-4.453125,-4.609375,-4.765625,-4.921875,-5.078125,-5.234375,-5.390625,-5.546875,-5.703125,-5.859375,-6.015625,-6.171875,-6.328125,-6.484375,-6.640625,-6.796875,-6.953125,-7.109375,-7.265625,-7.421875,-7.578125,-7.734375,-7.890625,-8.046875,-8.203125,-8.359375,-8.515625,-8.671875,-8.828125,-8.984375,-9.140625,-9.296875,-9.453125,-9.609375,-9.765625,-9.921875,-10.078125,-10.234375,-10.390625,-10.546875,-10.703125,-10.859375,-11.015625,-11.171875,-11.328125,-11.484375,-11.640625,-11.796875,-11.953125,-12.109375,-12.265625,-12.421875,-12.578125,-12.734375,-12.890625,-13.046875,-13.203125,-13.359375,-13.515625,-13.671875,-13.828125,-13.984375,-14.140625,-14.296875,-14.453125,-14.609375,-14.765625,-14.921875,-15.078125,-15.234375,-15.390625,-15.546875,-15.703125,-15.859375,-16.015625,-16.171875,-16.328125,-16.484375,-16.640625,-16.796875,-16.953125,-17.109375,-17.265625,-17.421875,-17.578125,-17.734375,-17.890625,-18.046875,-18.203125,-18.359375,-18.515625,-18.671875,-18.828125,-18.984375,-19.140625,-19.296875,-19.453125,-19.609375,-19.765625,-19.921875,-20.078125,-20.234375,-20.390625,-20.546875,-20.703125,-20.859375,-21.015625,-21.171875,-21.328125,-21.484375,-21.640625,-21.796875,-21.953125,-22.109375,-22.265625,-22.421875,-22.578125,-22.734375,-22.890625,-23.046875,-23.203125,-23.359375,-23.515625,-23.671875,-23.828125,-23.984375,-24.140625,-24.296875,-24.453125,-24.609375,-24.765625,-24.921875,-25.078125,-25.234375,-25.390625,-25.546875,-25.703125,-25.859375,-26.015625,-26.171875,-26.328125,-26.484375,-26.640625,-26.796875,-26.953125,-27.109375,-27.265625,-27.421875,-27.578125,-27.734375,-27.890625,-28.046875,-28.203125,-28.359375,-28.515625,-28.671875,-28.828125,-28.984375,-29.140625,-29.296875,-29.453125,-29.609375,-29.765625,-29.921875,-30.078125,-30.234375,-30.390625,-30.546875,-30.703125,-30.859375,-31.015625,-31.171875,-31.328125,-31.484375,-31.640625,-31.796875,-31.953125,-32.109375,-32.265625,-32.421875,-32.578125,-32.734375,-32.890625,-33.046875,-33.203125,-33.359375,-33.515625,-33.671875,-33.828125,-33.984375,-34.140625,-34.296875,-34.453125,-34.609375,-34.765625,-34.921875,-35.078125,-35.234375,-35.390625,-35.546875,-35.703125,-35.859375,-36.015625,-36.171875,-36.328125,-36.484375,-36.640625,-36.796875,-36.953125,-37.109375,-37.265625,-37.421875,-37.578125,-37.734375,-37.890625,-38.046875,-38.203125,-38.359375,-38.515625,-38.671875,-38.828125,-38.984375,-39.140625,-39.296875,-39.453125,-39.609375,-39.765625,-39.921875,-40.078125,-40.234375,-40.390625,-40.546875,-40.703125,-40.859375,-41.015625,-41.171875,-41.328125,-41.484375,-41.640625,-41.796875,-41.953125,-42.109375,-42.265625,-42.421875,-42.578125,-42.734375,-42.890625,-43.046875,-43.203125,-43.359375,-43.515625,-43.671875,-43.828125,-43.984375,-44.140625,-44.296875,-44.453125,-44.609375,-44.765625,-44.921875,-45.078125,-45.234375,-45.390625,-45.546875,-45.703125,-45.859375,-46.015625,-46.171875,-46.328125,-46.484375,-46.640625,-46.796875,-46.953125,-47.109375,-47.265625,-47.421875,-47.578125,-47.734375,-47.890625,-48.046875,-48.203125,-48.359375,-48.515625,-48.671875,-48.828125,-48.984375,-49.140625,-49.296875,-49.453125,-49.609375,-49.765625,-49.921875,-50.078125,-50.234375,-50.390625,-50.546875,-50.703125,-50.859375,-51.015625,-51.171875,-51.328125,-51.484375,-51.640625,-51.796875,-51.953125,-52.109375,-52.265625,-52.421875,-52.578125,-52.734375,-52.890625,-53.046875,-53.203125,-53.359375,-53.515625,-53.671875,-53.828125,-53.984375,-54.140625,-54.296875,-54.453125,-54.609375,-54.765625,-54.921875,-55.078125,-55.234375,-55.390625,-55.546875,-55.703125,-55.859375,-56.015625,-56.171875,-56.328125,-56.484375,-56.640625,-56.796875,-56.953125,-57.109375,-57.265625,-57.421875,-57.578125,-57.734375,-57.890625,-58.046875,-58.203125,-58.359375,-58.515625,-58.671875,-58.828125,-58.984375,-59.140625,-59.296875,-59.453125,-59.609375,-59.765625,-59.921875,-60.078125,-60.234375,-60.390625,-60.546875,-60.703125,-60.859375,-61.015625,-61.171875,-61.328125,-61.484375,-61.640625,-61.796875,-61.953125,-62.109375,-62.265625,-62.421875,-62.578125,-62.734375,-62.890625,-63.046875,-63.203125,-63.359375,-63.515625,-63.671875,-63.828125,-63.984375,-64.140625,-64.296875,-64.453125,-64.609375,-64.765625,-64.921875,-65.078125,-65.234375,-65.390625,-65.546875,-65.703125,-65.859375,-66.015625,-66.171875,-66.328125,-66.484375,-66.640625,-66.796875,-66.953125,-67.109375,-67.265625,-67.421875,-67.578125,-67.734375,-67.890625,-68.046875,-68.203125,-68.359375,-68.515625,-68.671875,-68.828125,-68.984375,-69.140625,-69.296875,-69.453125,-69.609375,-69.765625,-69.921875,-70.078125,-70.234375,-70.390625,-70.546875,-70.703125,-70.859375,-71.015625,-71.171875,-71.328125,-71.484375,-71.640625,-71.796875,-71.953125,-72.109375,-72.265625,-72.421875,-72.578125,-72.734375,-72.890625,-73.046875,-73.203125,-73.359375,-73.515625,-73.671875,-73.828125,-73.984375,-74.140625,-74.296875,-74.453125,-74.609375,-74.765625,-74.921875,-75.078125,-75.234375,-75.390625,-75.546875,-75.703125,-75.859375,-76.015625,-76.171875,-76.328125,-76.484375,-76.640625,-76.796875,-76.953125,-77.109375,-77.265625,-77.421875,-77.578125,-77.734375,-77.890625,-78.046875,-78.203125,-78.359375,-78.515625,-78.671875,-78.828125,-78.984375,-79.140625,-79.296875,-79.453125,-79.609375,-79.765625,-79.921875,-80.078125,-80.234375,-80.390625,-80.546875,-80.703125,-80.859375,-81.015625,-81.171875,-81.328125,-81.484375,-81.640625,-81.796875,-81.953125,-82.109375,-82.265625,-82.421875,-82.578125,-82.734375,-82.890625,-83.046875,-83.203125,-83.359375,-83.515625,-83.671875,-83.828125,-83.984375,-84.140625,-84.296875,-84.453125,-84.609375,-84.765625,-84.921875,-85.078125,-85.234375,-85.390625,-85.546875,-85.703125,-85.859375,-86.015625,-86.171875,-86.328125,-86.484375,-86.640625,-86.796875,-86.953125,-87.109375,-87.265625,-87.421875,-87.578125,-87.734375,-87.890625,-88.046875,-88.203125,-88.359375,-88.515625,-88.671875,-88.828125,-88.984375,-89.140625,-89.296875,-89.453125,-89.609375,-89.765625,-89.921875],lon:[.117188,.351563,.585938,.820313,1.054688,1.289063,1.523438,1.757813,1.992188,2.226563,2.460938,2.695313,2.929688,3.164063,3.398438,3.632813,3.867188,4.101563,4.335938,4.570313,4.804688,5.039063,5.273438,5.507813,5.742188,5.976563,6.210938,6.445313,6.679688,6.914063,7.148438,7.382813,7.617188,7.851563,8.085938,8.320313,8.554688,8.789063,9.023438,9.257813,9.492188,9.726563,9.960938,10.195313,10.429688,10.664063,10.898438,11.132813,11.367188,11.601563,11.835938,12.070313,12.304688,12.539063,12.773438,13.007813,13.242188,13.476563,13.710938,13.945313,14.179688,14.414063,14.648438,14.882813,15.117188,15.351563,15.585938,15.820313,16.054688,16.289062,16.523438,16.757812,16.992188,17.226562,17.460938,17.695312,17.929688,18.164062,18.398438,18.632812,18.867188,19.101562,19.335938,19.570312,19.804688,20.039062,20.273438,20.507812,20.742188,20.976562,21.210938,21.445312,21.679688,21.914062,22.148438,22.382812,22.617188,22.851562,23.085938,23.320312,23.554688,23.789062,24.023438,24.257812,24.492188,24.726562,24.960938,25.195312,25.429688,25.664062,25.898438,26.132812,26.367188,26.601562,26.835938,27.070312,27.304688,27.539062,27.773438,28.007812,28.242188,28.476562,28.710938,28.945312,29.179688,29.414062,29.648438,29.882812,30.117188,30.351562,30.585938,30.820312,31.054688,31.289062,31.523438,31.757812,31.992188,32.226562,32.460938,32.695312,32.929688,33.164062,33.398438,33.632812,33.867188,34.101562,34.335938,34.570312,34.804688,35.039062,35.273438,35.507812,35.742188,35.976562,36.210938,36.445312,36.679688,36.914062,37.148438,37.382812,37.617188,37.851562,38.085938,38.320312,38.554688,38.789062,39.023438,39.257812,39.492188,39.726562,39.960938,40.195312,40.429688,40.664062,40.898438,41.132812,41.367188,41.601562,41.835938,42.070312,42.304688,42.539062,42.773438,43.007812,43.242188,43.476562,43.710938,43.945312,44.179688,44.414062,44.648438,44.882812,45.117188,45.351562,45.585938,45.820312,46.054688,46.289062,46.523438,46.757812,46.992188,47.226562,47.460938,47.695312,47.929688,48.164062,48.398438,48.632812,48.867188,49.101562,49.335938,49.570312,49.804688,50.039062,50.273438,50.507812,50.742188,50.976562,51.210938,51.445312,51.679688,51.914062,52.148438,52.382812,52.617188,52.851562,53.085938,53.320312,53.554688,53.789062,54.023438,54.257812,54.492188,54.726562,54.960938,55.195312,55.429688,55.664062,55.898438,56.132812,56.367188,56.601562,56.835938,57.070312,57.304688,57.539062,57.773438,58.007812,58.242188,58.476562,58.710938,58.945312,59.179688,59.414062,59.648438,59.882812,60.117188,60.351562,60.585938,60.820312,61.054688,61.289062,61.523438,61.757812,61.992188,62.226562,62.460938,62.695312,62.929688,63.164062,63.398438,63.632812,63.867188,64.10156,64.33594,64.57031,64.80469,65.03906,65.27344,65.50781,65.74219,65.97656,66.21094,66.44531,66.67969,66.91406,67.14844,67.38281,67.61719,67.85156,68.08594,68.32031,68.55469,68.78906,69.02344,69.25781,69.49219,69.72656,69.96094,70.19531,70.42969,70.66406,70.89844,71.13281,71.36719,71.60156,71.83594,72.07031,72.30469,72.53906,72.77344,73.00781,73.24219,73.47656,73.71094,73.94531,74.17969,74.41406,74.64844,74.88281,75.11719,75.35156,75.58594,75.82031,76.05469,76.28906,76.52344,76.75781,76.99219,77.22656,77.46094,77.69531,77.92969,78.16406,78.39844,78.63281,78.86719,79.10156,79.33594,79.57031,79.80469,80.03906,80.27344,80.50781,80.74219,80.97656,81.21094,81.44531,81.67969,81.91406,82.14844,82.38281,82.61719,82.85156,83.08594,83.32031,83.55469,83.78906,84.02344,84.25781,84.49219,84.72656,84.96094,85.19531,85.42969,85.66406,85.89844,86.13281,86.36719,86.60156,86.83594,87.07031,87.30469,87.53906,87.77344,88.00781,88.24219,88.47656,88.71094,88.94531,89.17969,89.41406,89.64844,89.88281,90.11719,90.35156,90.58594,90.82031,91.05469,91.28906,91.52344,91.75781,91.99219,92.22656,92.46094,92.69531,92.92969,93.16406,93.39844,93.63281,93.86719,94.10156,94.33594,94.57031,94.80469,95.03906,95.27344,95.50781,95.74219,95.97656,96.21094,96.44531,96.67969,96.91406,97.14844,97.38281,97.61719,97.85156,98.08594,98.32031,98.55469,98.78906,99.02344,99.25781,99.49219,99.72656,99.96094,100.19531,100.42969,100.66406,100.89844,101.13281,101.36719,101.60156,101.83594,102.07031,102.30469,102.53906,102.77344,103.00781,103.24219,103.47656,103.71094,103.94531,104.17969,104.41406,104.64844,104.88281,105.11719,105.35156,105.58594,105.82031,106.05469,106.28906,106.52344,106.75781,106.99219,107.22656,107.46094,107.69531,107.92969,108.16406,108.39844,108.63281,108.86719,109.10156,109.33594,109.57031,109.80469,110.03906,110.27344,110.50781,110.74219,110.97656,111.21094,111.44531,111.67969,111.91406,112.14844,112.38281,112.61719,112.85156,113.08594,113.32031,113.55469,113.78906,114.02344,114.25781,114.49219,114.72656,114.96094,115.19531,115.42969,115.66406,115.89844,116.13281,116.36719,116.60156,116.83594,117.07031,117.30469,117.53906,117.77344,118.00781,118.24219,118.47656,118.71094,118.94531,119.17969,119.41406,119.64844,119.88281,120.11719,120.35156,120.58594,120.82031,121.05469,121.28906,121.52344,121.75781,121.99219,122.22656,122.46094,122.69531,122.92969,123.16406,123.39844,123.63281,123.86719,124.10156,124.33594,124.57031,124.80469,125.03906,125.27344,125.50781,125.74219,125.97656,126.21094,126.44531,126.67969,126.91406,127.14844,127.38281,127.61719,127.85156,128.08594,128.32031,128.55469,128.78906,129.02344,129.25781,129.49219,129.72656,129.96094,130.19531,130.42969,130.66406,130.89844,131.13281,131.36719,131.60156,131.83594,132.07031,132.30469,132.53906,132.77344,133.00781,133.24219,133.47656,133.71094,133.94531,134.17969,134.41406,134.64844,134.88281,135.11719,135.35156,135.58594,135.82031,136.05469,136.28906,136.52344,136.75781,136.99219,137.22656,137.46094,137.69531,137.92969,138.16406,138.39844,138.63281,138.86719,139.10156,139.33594,139.57031,139.80469,140.03906,140.27344,140.50781,140.74219,140.97656,141.21094,141.44531,141.67969,141.91406,142.14844,142.38281,142.61719,142.85156,143.08594,143.32031,143.55469,143.78906,144.02344,144.25781,144.49219,144.72656,144.96094,145.19531,145.42969,145.66406,145.89844,146.13281,146.36719,146.60156,146.83594,147.07031,147.30469,147.53906,147.77344,148.00781,148.24219,148.47656,148.71094,148.94531,149.17969,149.41406,149.64844,149.88281,150.11719,150.35156,150.58594,150.82031,151.05469,151.28906,151.52344,151.75781,151.99219,152.22656,152.46094,152.69531,152.92969,153.16406,153.39844,153.63281,153.86719,154.10156,154.33594,154.57031,154.80469,155.03906,155.27344,155.50781,155.74219,155.97656,156.21094,156.44531,156.67969,156.91406,157.14844,157.38281,157.61719,157.85156,158.08594,158.32031,158.55469,158.78906,159.02344,159.25781,159.49219,159.72656,159.96094,160.19531,160.42969,160.66406,160.89844,161.13281,161.36719,161.60156,161.83594,162.07031,162.30469,162.53906,162.77344,163.00781,163.24219,163.47656,163.71094,163.94531,164.17969,164.41406,164.64844,164.88281,165.11719,165.35156,165.58594,165.82031,166.05469,166.28906,166.52344,166.75781,166.99219,167.22656,167.46094,167.69531,167.92969,168.16406,168.39844,168.63281,168.86719,169.10156,169.33594,169.57031,169.80469,170.03906,170.27344,170.50781,170.74219,170.97656,171.21094,171.44531,171.67969,171.91406,172.14844,172.38281,172.61719,172.85156,173.08594,173.32031,173.55469,173.78906,174.02344,174.25781,174.49219,174.72656,174.96094,175.19531,175.42969,175.66406,175.89844,176.13281,176.36719,176.60156,176.83594,177.07031,177.30469,177.53906,177.77344,178.00781,178.24219,178.47656,178.71094,178.94531,179.17969,179.41406,179.64844,179.88281,180.11719,180.35156,180.58594,180.82031,181.05469,181.28906,181.52344,181.75781,181.99219,182.22656,182.46094,182.69531,182.92969,183.16406,183.39844,183.63281,183.86719,184.10156,184.33594,184.57031,184.80469,185.03906,185.27344,185.50781,185.74219,185.97656,186.21094,186.44531,186.67969,186.91406,187.14844,187.38281,187.61719,187.85156,188.08594,188.32031,188.55469,188.78906,189.02344,189.25781,189.49219,189.72656,189.96094,190.19531,190.42969,190.66406,190.89844,191.13281,191.36719,191.60156,191.83594,192.07031,192.30469,192.53906,192.77344,193.00781,193.24219,193.47656,193.71094,193.94531,194.17969,194.41406,194.64844,194.88281,195.11719,195.35156,195.58594,195.82031,196.05469,196.28906,196.52344,196.75781,196.99219,197.22656,197.46094,197.69531,197.92969,198.16406,198.39844,198.63281,198.86719,199.10156,199.33594,199.57031,199.80469,200.03906,200.27344,200.50781,200.74219,200.97656,201.21094,201.44531,201.67969,201.91406,202.14844,202.38281,202.61719,202.85156,203.08594,203.32031,203.55469,203.78906,204.02344,204.25781,204.49219,204.72656,204.96094,205.19531,205.42969,205.66406,205.89844,206.13281,206.36719,206.60156,206.83594,207.07031,207.30469,207.53906,207.77344,208.00781,208.24219,208.47656,208.71094,208.94531,209.17969,209.41406,209.64844,209.88281,210.11719,210.35156,210.58594,210.82031,211.05469,211.28906,211.52344,211.75781,211.99219,212.22656,212.46094,212.69531,212.92969,213.16406,213.39844,213.63281,213.86719,214.10156,214.33594,214.57031,214.80469,215.03906,215.27344,215.50781,215.74219,215.97656,216.21094,216.44531,216.67969,216.91406,217.14844,217.38281,217.61719,217.85156,218.08594,218.32031,218.55469,218.78906,219.02344,219.25781,219.49219,219.72656,219.96094,220.19531,220.42969,220.66406,220.89844,221.13281,221.36719,221.60156,221.83594,222.07031,222.30469,222.53906,222.77344,223.00781,223.24219,223.47656,223.71094,223.94531,224.17969,224.41406,224.64844,224.88281,225.11719,225.35156,225.58594,225.82031,226.05469,226.28906,226.52344,226.75781,226.99219,227.22656,227.46094,227.69531,227.92969,228.16406,228.39844,228.63281,228.86719,229.10156,229.33594,229.57031,229.80469,230.03906,230.27344,230.50781,230.74219,230.97656,231.21094,231.44531,231.67969,231.91406,232.14844,232.38281,232.61719,232.85156,233.08594,233.32031,233.55469,233.78906,234.02344,234.25781,234.49219,234.72656,234.96094,235.19531,235.42969,235.66406,235.89844,236.13281,236.36719,236.60156,236.83594,237.07031,237.30469,237.53906,237.77344,238.00781,238.24219,238.47656,238.71094,238.94531,239.17969,239.41406,239.64844,239.88281,240.11719,240.35156,240.58594,240.82031,241.05469,241.28906,241.52344,241.75781,241.99219,242.22656,242.46094,242.69531,242.92969,243.16406,243.39844,243.63281,243.86719,244.10156,244.33594,244.57031,244.80469,245.03906,245.27344,245.50781,245.74219,245.97656,246.21094,246.44531,246.67969,246.91406,247.14844,247.38281,247.61719,247.85156,248.08594,248.32031,248.55469,248.78906,249.02344,249.25781,249.49219,249.72656,249.96094,250.19531,250.42969,250.66406,250.89844,251.13281,251.36719,251.60156,251.83594,252.07031,252.30469,252.53906,252.77344,253.00781,253.24219,253.47656,253.71094,253.94531,254.17969,254.41406,254.64844,254.88281,255.11719,255.35156,255.58594,255.82031,256.0547,256.28906,256.52344,256.7578,256.9922,257.22656,257.46094,257.6953,257.9297,258.16406,258.39844,258.6328,258.8672,259.10156,259.33594,259.5703,259.8047,260.03906,260.27344,260.5078,260.7422,260.97656,261.21094,261.4453,261.6797,261.91406,262.14844,262.3828,262.6172,262.85156,263.08594,263.3203,263.5547,263.78906,264.02344,264.2578,264.4922,264.72656,264.96094,265.1953,265.4297,265.66406,265.89844,266.1328,266.3672,266.60156,266.83594,267.0703,267.3047,267.53906,267.77344,268.0078,268.2422,268.47656,268.71094,268.9453,269.1797,269.41406,269.64844,269.8828,270.1172,270.35156,270.58594,270.8203,271.0547,271.28906,271.52344,271.7578,271.9922,272.22656,272.46094,272.6953,272.9297,273.16406,273.39844,273.6328,273.8672,274.10156,274.33594,274.5703,274.8047,275.03906,275.27344,275.5078,275.7422,275.97656,276.21094,276.4453,276.6797,276.91406,277.14844,277.3828,277.6172,277.85156,278.08594,278.3203,278.5547,278.78906,279.02344,279.2578,279.4922,279.72656,279.96094,280.1953,280.4297,280.66406,280.89844,281.1328,281.3672,281.60156,281.83594,282.0703,282.3047,282.53906,282.77344,283.0078,283.2422,283.47656,283.71094,283.9453,284.1797,284.41406,284.64844,284.8828,285.1172,285.35156,285.58594,285.8203,286.0547,286.28906,286.52344,286.7578,286.9922,287.22656,287.46094,287.6953,287.9297,288.16406,288.39844,288.6328,288.8672,289.10156,289.33594,289.5703,289.8047,290.03906,290.27344,290.5078,290.7422,290.97656,291.21094,291.4453,291.6797,291.91406,292.14844,292.3828,292.6172,292.85156,293.08594,293.3203,293.5547,293.78906,294.02344,294.2578,294.4922,294.72656,294.96094,295.1953,295.4297,295.66406,295.89844,296.1328,296.3672,296.60156,296.83594,297.0703,297.3047,297.53906,297.77344,298.0078,298.2422,298.47656,298.71094,298.9453,299.1797,299.41406,299.64844,299.8828,300.1172,300.35156,300.58594,300.8203,301.0547,301.28906,301.52344,301.7578,301.9922,302.22656,302.46094,302.6953,302.9297,303.16406,303.39844,303.6328,303.8672,304.10156,304.33594,304.5703,304.8047,305.03906,305.27344,305.5078,305.7422,305.97656,306.21094,306.4453,306.6797,306.91406,307.14844,307.3828,307.6172,307.85156,308.08594,308.3203,308.5547,308.78906,309.02344,309.2578,309.4922,309.72656,309.96094,310.1953,310.4297,310.66406,310.89844,311.1328,311.3672,311.60156,311.83594,312.0703,312.3047,312.53906,312.77344,313.0078,313.2422,313.47656,313.71094,313.9453,314.1797,314.41406,314.64844,314.8828,315.1172,315.35156,315.58594,315.8203,316.0547,316.28906,316.52344,316.7578,316.9922,317.22656,317.46094,317.6953,317.9297,318.16406,318.39844,318.6328,318.8672,319.10156,319.33594,319.5703,319.8047,320.03906,320.27344,320.5078,320.7422,320.97656,321.21094,321.4453,321.6797,321.91406,322.14844,322.3828,322.6172,322.85156,323.08594,323.3203,323.5547,323.78906,324.02344,324.2578,324.4922,324.72656,324.96094,325.1953,325.4297,325.66406,325.89844,326.1328,326.3672,326.60156,326.83594,327.0703,327.3047,327.53906,327.77344,328.0078,328.2422,328.47656,328.71094,328.9453,329.1797,329.41406,329.64844,329.8828,330.1172,330.35156,330.58594,330.8203,331.0547,331.28906,331.52344,331.7578,331.9922,332.22656,332.46094,332.6953,332.9297,333.16406,333.39844,333.6328,333.8672,334.10156,334.33594,334.5703,334.8047,335.03906,335.27344,335.5078,335.7422,335.97656,336.21094,336.4453,336.6797,336.91406,337.14844,337.3828,337.6172,337.85156,338.08594,338.3203,338.5547,338.78906,339.02344,339.2578,339.4922,339.72656,339.96094,340.1953,340.4297,340.66406,340.89844,341.1328,341.3672,341.60156,341.83594,342.0703,342.3047,342.53906,342.77344,343.0078,343.2422,343.47656,343.71094,343.9453,344.1797,344.41406,344.64844,344.8828,345.1172,345.35156,345.58594,345.8203,346.0547,346.28906,346.52344,346.7578,346.9922,347.22656,347.46094,347.6953,347.9297,348.16406,348.39844,348.6328,348.8672,349.10156,349.33594,349.5703,349.8047,350.03906,350.27344,350.5078,350.7422,350.97656,351.21094,351.4453,351.6797,351.91406,352.14844,352.3828,352.6172,352.85156,353.08594,353.3203,353.5547,353.78906,354.02344,354.2578,354.4922,354.72656,354.96094,355.1953,355.4297,355.66406,355.89844,356.1328,356.3672,356.60156,356.83594,357.0703,357.3047,357.53906,357.77344,358.0078,358.2422,358.47656,358.71094,358.9453,359.1797,359.41406,359.64844,359.8828]},ci=function(){if(!(this instanceof ci))throw new Error(ot.CONSTRUCT_ERROR);this.precipitationData,this.gl,this.maxPrecipitation,this.minPrecipitation,this.geographicExtent,this.weatherStation};ci.prototype.init=function(t,e){this.gl=t,this.loadData(),void 0===this.geographicExtent&&(this.geographicExtent=new G),this.geographicExtent.setExtent(-180,-90,0,180,90,0)},ci.prototype.loadData=function(){var t=di.lon.length,e=di.lat.length,i=this.weatherStation.provisional_geometryDataPath+"/volumRenderingTest/rain_iSuSok/Total_precipitation_surface_3_Hour_Accumulation.bin",r=new fi;r.numCols=t,r.numRows=e,ge.loadBinaryData(i,r,this)},ci.prototype.parseData=function(t){this.gl;var e=di.lon.length,i=di.lat.length,r=e*i,o=new DataStream(t.dataArraybuffer,0,DataStream.BIG_ENDIAN).readFloat32Array(r);t.dataArraybuffer=o;var n,a=o.length;this.maxPrecipitation=o[0],this.minPrecipitation=o[0];for(var s=1;s<a;s++)(n=o[s])>this.maxPrecipitation?this.maxPrecipitation=n:n<this.minPrecipitation&&(this.minPrecipitation=n);var l=this.maxPrecipitation-this.minPrecipitation;this.image3d=new li;var h=e,d=i;this.resampledWidth=h,this.resampledHeght=d;for(s=0;s<e;s++)di.lon[s]-=180;for(var c=di.lon[0],u=di.lon[e-1],f=di.lat[0],g=di.lat[i-1],p=e/2,v=Math.floor(e/h),y=Math.floor(i/d),m=this.image3d.newStack(),x=0;x<1;x++){var b=m.newSlice(),C=h*d;b.dataArray=new Uint8Array(C),b.width=h,b.height=d;for(var A=0;A<d;A++)for(s=0;s<h;s++){var T=s*v,M=A*y+x*i;(T+=p)>e&&(T-=e);var P=li.getIndexOfArray(e,T,M),w=li.getIndexOfArray(h,s,A),_=o[P],S=Math.floor(256*(_-this.minPrecipitation)/l);b.dataArray[w]=S}void 0===b.geographicExtent&&(b.geographicExtent=new G),b.geographicExtent.setExtent(c,f,0,u,g,0)}},ci.prototype.test_makeGeometryFromSlice=function(t,e,i,r,o,n,a){if(void 0!==this.image3d){Math.PI;var s,l,h,d,c,u,f,g,p=t.geographicExtent.minGeographicCoord.longitude,v=t.geographicExtent.minGeographicCoord.latitude,y=t.geographicExtent.maxGeographicCoord.longitude,m=t.geographicExtent.maxGeographicCoord.latitude,x=(y-p)/(t.width-1),b=(m-v)/(t.height-1),C=p,A=v,T=new kr,M=a*(a-n)*5-n;.8;for(var P=i;P<=o;P++){c=T.newVertexList(),l=A+P*b;for(var w=e;w<=r;w++){var S=w;S>=t.width&&(S-=t.width),s=C+S*x,h=t?t.getValue(S,P):0,h*=5*(h-n),h+=1e3,f=c.newVertex(),(u=(h-n)/M)>1?u=1:u<0&&(u=0),d=_.grayToRGB_MagoStyle(u,d),g=W.geographicToCartesianWgs84(s,l,h,g),f.setPosition(g[0],g[1],g[2]),f.setColorRGBA(d.b,d.g,d.r,.8)}}var L=new rr,R=kr.makeSurface(T,void 0,!1,!0);R.calculateVerticesNormals(),L.addSurface(R),void 0===this.meshesArray&&(this.meshesArray=[]),this.meshesArray.push(L)}},ci.prototype.test_makeGeometryFromData=function(t){if(void 0!==this.image3d)for(var e,i,r,o,n=this.image3d.getStacksCount(),a=0;a<n;a++)for(var s=this.image3d.getStack(a),l=s.getSlicesCount(),h=0;h<l;h++){for(var d=s.getSlice(h),c=[],u=(c=ai.getMinMaxValuesOfArray(d.dataArray,c))[0],f=c[1],g=Math.floor(d.width/300),p=Math.floor(d.height/300),v=0;v<=p;v++)for(var y=0;y<=g;y++)e=300*y,(i=300*(y+1))>d.width&&(i=d.width),r=300*v,(o=300*(v+1))>d.height&&(o=d.height),this.test_makeGeometryFromSlice(d,e,r,i,o,u,f);break}},ci.prototype.renderMesh=function(t,e,i){if(void 0!==this.meshesArray)for(var r=this.meshesArray.length,o=0;o<r;o++)this.meshesArray[o].render(t,e,i)};var ui={isobaric:[40,50,100,200,300,500,700,1e3,1500,2e3,3e3,5e3,7e3,1e4,15e3,2e4,25e3,3e4,4e4,5e4,6e4,7e4,85e3,92500,95e3,1e5],lat:[89.921875,89.765625,89.609375,89.453125,89.296875,89.140625,88.984375,88.828125,88.671875,88.515625,88.359375,88.203125,88.046875,87.890625,87.734375,87.578125,87.421875,87.265625,87.109375,86.953125,86.796875,86.640625,86.484375,86.328125,86.171875,86.015625,85.859375,85.703125,85.546875,85.390625,85.234375,85.078125,84.921875,84.765625,84.609375,84.453125,84.296875,84.140625,83.984375,83.828125,83.671875,83.515625,83.359375,83.203125,83.046875,82.890625,82.734375,82.578125,82.421875,82.265625,82.109375,81.953125,81.796875,81.640625,81.484375,81.328125,81.171875,81.015625,80.859375,80.703125,80.546875,80.390625,80.234375,80.078125,79.921875,79.765625,79.609375,79.453125,79.296875,79.140625,78.984375,78.828125,78.671875,78.515625,78.359375,78.203125,78.046875,77.890625,77.734375,77.578125,77.421875,77.265625,77.109375,76.953125,76.796875,76.640625,76.484375,76.328125,76.171875,76.015625,75.859375,75.703125,75.546875,75.390625,75.234375,75.078125,74.921875,74.765625,74.609375,74.453125,74.296875,74.140625,73.984375,73.828125,73.671875,73.515625,73.359375,73.203125,73.046875,72.890625,72.734375,72.578125,72.421875,72.265625,72.109375,71.953125,71.796875,71.640625,71.484375,71.328125,71.171875,71.015625,70.859375,70.703125,70.546875,70.390625,70.234375,70.078125,69.921875,69.765625,69.609375,69.453125,69.296875,69.140625,68.984375,68.828125,68.671875,68.515625,68.359375,68.203125,68.046875,67.890625,67.734375,67.578125,67.421875,67.265625,67.109375,66.953125,66.796875,66.640625,66.484375,66.328125,66.171875,66.015625,65.859375,65.703125,65.546875,65.390625,65.234375,65.078125,64.921875,64.765625,64.609375,64.453125,64.296875,64.140625,63.984375,63.828125,63.671875,63.515625,63.359375,63.203125,63.046875,62.890625,62.734375,62.578125,62.421875,62.265625,62.109375,61.953125,61.796875,61.640625,61.484375,61.328125,61.171875,61.015625,60.859375,60.703125,60.546875,60.390625,60.234375,60.078125,59.921875,59.765625,59.609375,59.453125,59.296875,59.140625,58.984375,58.828125,58.671875,58.515625,58.359375,58.203125,58.046875,57.890625,57.734375,57.578125,57.421875,57.265625,57.109375,56.953125,56.796875,56.640625,56.484375,56.328125,56.171875,56.015625,55.859375,55.703125,55.546875,55.390625,55.234375,55.078125,54.921875,54.765625,54.609375,54.453125,54.296875,54.140625,53.984375,53.828125,53.671875,53.515625,53.359375,53.203125,53.046875,52.890625,52.734375,52.578125,52.421875,52.265625,52.109375,51.953125,51.796875,51.640625,51.484375,51.328125,51.171875,51.015625,50.859375,50.703125,50.546875,50.390625,50.234375,50.078125,49.921875,49.765625,49.609375,49.453125,49.296875,49.140625,48.984375,48.828125,48.671875,48.515625,48.359375,48.203125,48.046875,47.890625,47.734375,47.578125,47.421875,47.265625,47.109375,46.953125,46.796875,46.640625,46.484375,46.328125,46.171875,46.015625,45.859375,45.703125,45.546875,45.390625,45.234375,45.078125,44.921875,44.765625,44.609375,44.453125,44.296875,44.140625,43.984375,43.828125,43.671875,43.515625,43.359375,43.203125,43.046875,42.890625,42.734375,42.578125,42.421875,42.265625,42.109375,41.953125,41.796875,41.640625,41.484375,41.328125,41.171875,41.015625,40.859375,40.703125,40.546875,40.390625,40.234375,40.078125,39.921875,39.765625,39.609375,39.453125,39.296875,39.140625,38.984375,38.828125,38.671875,38.515625,38.359375,38.203125,38.046875,37.890625,37.734375,37.578125,37.421875,37.265625,37.109375,36.953125,36.796875,36.640625,36.484375,36.328125,36.171875,36.015625,35.859375,35.703125,35.546875,35.390625,35.234375,35.078125,34.921875,34.765625,34.609375,34.453125,34.296875,34.140625,33.984375,33.828125,33.671875,33.515625,33.359375,33.203125,33.046875,32.890625,32.734375,32.578125,32.421875,32.265625,32.109375,31.953125,31.796875,31.640625,31.484375,31.328125,31.171875,31.015625,30.859375,30.703125,30.546875,30.390625,30.234375,30.078125,29.921875,29.765625,29.609375,29.453125,29.296875,29.140625,28.984375,28.828125,28.671875,28.515625,28.359375,28.203125,28.046875,27.890625,27.734375,27.578125,27.421875,27.265625,27.109375,26.953125,26.796875,26.640625,26.484375,26.328125,26.171875,26.015625,25.859375,25.703125,25.546875,25.390625,25.234375,25.078125,24.921875,24.765625,24.609375,24.453125,24.296875,24.140625,23.984375,23.828125,23.671875,23.515625,23.359375,23.203125,23.046875,22.890625,22.734375,22.578125,22.421875,22.265625,22.109375,21.953125,21.796875,21.640625,21.484375,21.328125,21.171875,21.015625,20.859375,20.703125,20.546875,20.390625,20.234375,20.078125,19.921875,19.765625,19.609375,19.453125,19.296875,19.140625,18.984375,18.828125,18.671875,18.515625,18.359375,18.203125,18.046875,17.890625,17.734375,17.578125,17.421875,17.265625,17.109375,16.953125,16.796875,16.640625,16.484375,16.328125,16.171875,16.015625,15.859375,15.703125,15.546875,15.390625,15.234375,15.078125,14.921875,14.765625,14.609375,14.453125,14.296875,14.140625,13.984375,13.828125,13.671875,13.515625,13.359375,13.203125,13.046875,12.890625,12.734375,12.578125,12.421875,12.265625,12.109375,11.953125,11.796875,11.640625,11.484375,11.328125,11.171875,11.015625,10.859375,10.703125,10.546875,10.390625,10.234375,10.078125,9.921875,9.765625,9.609375,9.453125,9.296875,9.140625,8.984375,8.828125,8.671875,8.515625,8.359375,8.203125,8.046875,7.890625,7.734375,7.578125,7.421875,7.265625,7.109375,6.953125,6.796875,6.640625,6.484375,6.328125,6.171875,6.015625,5.859375,5.703125,5.546875,5.390625,5.234375,5.078125,4.921875,4.765625,4.609375,4.453125,4.296875,4.140625,3.984375,3.828125,3.671875,3.515625,3.359375,3.203125,3.046875,2.890625,2.734375,2.578125,2.421875,2.265625,2.109375,1.953125,1.796875,1.640625,1.484375,1.328125,1.171875,1.015625,.859375,.703125,.546875,.390625,.234375,.078125,-.078125,-.234375,-.390625,-.546875,-.703125,-.859375,-1.015625,-1.171875,-1.328125,-1.484375,-1.640625,-1.796875,-1.953125,-2.109375,-2.265625,-2.421875,-2.578125,-2.734375,-2.890625,-3.046875,-3.203125,-3.359375,-3.515625,-3.671875,-3.828125,-3.984375,-4.140625,-4.296875,-4.453125,-4.609375,-4.765625,-4.921875,-5.078125,-5.234375,-5.390625,-5.546875,-5.703125,-5.859375,-6.015625,-6.171875,-6.328125,-6.484375,-6.640625,-6.796875,-6.953125,-7.109375,-7.265625,-7.421875,-7.578125,-7.734375,-7.890625,-8.046875,-8.203125,-8.359375,-8.515625,-8.671875,-8.828125,-8.984375,-9.140625,-9.296875,-9.453125,-9.609375,-9.765625,-9.921875,-10.078125,-10.234375,-10.390625,-10.546875,-10.703125,-10.859375,-11.015625,-11.171875,-11.328125,-11.484375,-11.640625,-11.796875,-11.953125,-12.109375,-12.265625,-12.421875,-12.578125,-12.734375,-12.890625,-13.046875,-13.203125,-13.359375,-13.515625,-13.671875,-13.828125,-13.984375,-14.140625,-14.296875,-14.453125,-14.609375,-14.765625,-14.921875,-15.078125,-15.234375,-15.390625,-15.546875,-15.703125,-15.859375,-16.015625,-16.171875,-16.328125,-16.484375,-16.640625,-16.796875,-16.953125,-17.109375,-17.265625,-17.421875,-17.578125,-17.734375,-17.890625,-18.046875,-18.203125,-18.359375,-18.515625,-18.671875,-18.828125,-18.984375,-19.140625,-19.296875,-19.453125,-19.609375,-19.765625,-19.921875,-20.078125,-20.234375,-20.390625,-20.546875,-20.703125,-20.859375,-21.015625,-21.171875,-21.328125,-21.484375,-21.640625,-21.796875,-21.953125,-22.109375,-22.265625,-22.421875,-22.578125,-22.734375,-22.890625,-23.046875,-23.203125,-23.359375,-23.515625,-23.671875,-23.828125,-23.984375,-24.140625,-24.296875,-24.453125,-24.609375,-24.765625,-24.921875,-25.078125,-25.234375,-25.390625,-25.546875,-25.703125,-25.859375,-26.015625,-26.171875,-26.328125,-26.484375,-26.640625,-26.796875,-26.953125,-27.109375,-27.265625,-27.421875,-27.578125,-27.734375,-27.890625,-28.046875,-28.203125,-28.359375,-28.515625,-28.671875,-28.828125,-28.984375,-29.140625,-29.296875,-29.453125,-29.609375,-29.765625,-29.921875,-30.078125,-30.234375,-30.390625,-30.546875,-30.703125,-30.859375,-31.015625,-31.171875,-31.328125,-31.484375,-31.640625,-31.796875,-31.953125,-32.109375,-32.265625,-32.421875,-32.578125,-32.734375,-32.890625,-33.046875,-33.203125,-33.359375,-33.515625,-33.671875,-33.828125,-33.984375,-34.140625,-34.296875,-34.453125,-34.609375,-34.765625,-34.921875,-35.078125,-35.234375,-35.390625,-35.546875,-35.703125,-35.859375,-36.015625,-36.171875,-36.328125,-36.484375,-36.640625,-36.796875,-36.953125,-37.109375,-37.265625,-37.421875,-37.578125,-37.734375,-37.890625,-38.046875,-38.203125,-38.359375,-38.515625,-38.671875,-38.828125,-38.984375,-39.140625,-39.296875,-39.453125,-39.609375,-39.765625,-39.921875,-40.078125,-40.234375,-40.390625,-40.546875,-40.703125,-40.859375,-41.015625,-41.171875,-41.328125,-41.484375,-41.640625,-41.796875,-41.953125,-42.109375,-42.265625,-42.421875,-42.578125,-42.734375,-42.890625,-43.046875,-43.203125,-43.359375,-43.515625,-43.671875,-43.828125,-43.984375,-44.140625,-44.296875,-44.453125,-44.609375,-44.765625,-44.921875,-45.078125,-45.234375,-45.390625,-45.546875,-45.703125,-45.859375,-46.015625,-46.171875,-46.328125,-46.484375,-46.640625,-46.796875,-46.953125,-47.109375,-47.265625,-47.421875,-47.578125,-47.734375,-47.890625,-48.046875,-48.203125,-48.359375,-48.515625,-48.671875,-48.828125,-48.984375,-49.140625,-49.296875,-49.453125,-49.609375,-49.765625,-49.921875,-50.078125,-50.234375,-50.390625,-50.546875,-50.703125,-50.859375,-51.015625,-51.171875,-51.328125,-51.484375,-51.640625,-51.796875,-51.953125,-52.109375,-52.265625,-52.421875,-52.578125,-52.734375,-52.890625,-53.046875,-53.203125,-53.359375,-53.515625,-53.671875,-53.828125,-53.984375,-54.140625,-54.296875,-54.453125,-54.609375,-54.765625,-54.921875,-55.078125,-55.234375,-55.390625,-55.546875,-55.703125,-55.859375,-56.015625,-56.171875,-56.328125,-56.484375,-56.640625,-56.796875,-56.953125,-57.109375,-57.265625,-57.421875,-57.578125,-57.734375,-57.890625,-58.046875,-58.203125,-58.359375,-58.515625,-58.671875,-58.828125,-58.984375,-59.140625,-59.296875,-59.453125,-59.609375,-59.765625,-59.921875,-60.078125,-60.234375,-60.390625,-60.546875,-60.703125,-60.859375,-61.015625,-61.171875,-61.328125,-61.484375,-61.640625,-61.796875,-61.953125,-62.109375,-62.265625,-62.421875,-62.578125,-62.734375,-62.890625,-63.046875,-63.203125,-63.359375,-63.515625,-63.671875,-63.828125,-63.984375,-64.140625,-64.296875,-64.453125,-64.609375,-64.765625,-64.921875,-65.078125,-65.234375,-65.390625,-65.546875,-65.703125,-65.859375,-66.015625,-66.171875,-66.328125,-66.484375,-66.640625,-66.796875,-66.953125,-67.109375,-67.265625,-67.421875,-67.578125,-67.734375,-67.890625,-68.046875,-68.203125,-68.359375,-68.515625,-68.671875,-68.828125,-68.984375,-69.140625,-69.296875,-69.453125,-69.609375,-69.765625,-69.921875,-70.078125,-70.234375,-70.390625,-70.546875,-70.703125,-70.859375,-71.015625,-71.171875,-71.328125,-71.484375,-71.640625,-71.796875,-71.953125,-72.109375,-72.265625,-72.421875,-72.578125,-72.734375,-72.890625,-73.046875,-73.203125,-73.359375,-73.515625,-73.671875,-73.828125,-73.984375,-74.140625,-74.296875,-74.453125,-74.609375,-74.765625,-74.921875,-75.078125,-75.234375,-75.390625,-75.546875,-75.703125,-75.859375,-76.015625,-76.171875,-76.328125,-76.484375,-76.640625,-76.796875,-76.953125,-77.109375,-77.265625,-77.421875,-77.578125,-77.734375,-77.890625,-78.046875,-78.203125,-78.359375,-78.515625,-78.671875,-78.828125,-78.984375,-79.140625,-79.296875,-79.453125,-79.609375,-79.765625,-79.921875,-80.078125,-80.234375,-80.390625,-80.546875,-80.703125,-80.859375,-81.015625,-81.171875,-81.328125,-81.484375,-81.640625,-81.796875,-81.953125,-82.109375,-82.265625,-82.421875,-82.578125,-82.734375,-82.890625,-83.046875,-83.203125,-83.359375,-83.515625,-83.671875,-83.828125,-83.984375,-84.140625,-84.296875,-84.453125,-84.609375,-84.765625,-84.921875,-85.078125,-85.234375,-85.390625,-85.546875,-85.703125,-85.859375,-86.015625,-86.171875,-86.328125,-86.484375,-86.640625,-86.796875,-86.953125,-87.109375,-87.265625,-87.421875,-87.578125,-87.734375,-87.890625,-88.046875,-88.203125,-88.359375,-88.515625,-88.671875,-88.828125,-88.984375,-89.140625,-89.296875,-89.453125,-89.609375,-89.765625,-89.921875],lon:[.117188,.351563,.585938,.820313,1.054688,1.289063,1.523438,1.757813,1.992188,2.226563,2.460938,2.695313,2.929688,3.164063,3.398438,3.632813,3.867188,4.101563,4.335938,4.570313,4.804688,5.039063,5.273438,5.507813,5.742188,5.976563,6.210938,6.445313,6.679688,6.914063,7.148438,7.382813,7.617188,7.851563,8.085938,8.320313,8.554688,8.789063,9.023438,9.257813,9.492188,9.726563,9.960938,10.195313,10.429688,10.664063,10.898438,11.132813,11.367188,11.601563,11.835938,12.070313,12.304688,12.539063,12.773438,13.007813,13.242188,13.476563,13.710938,13.945313,14.179688,14.414063,14.648438,14.882813,15.117188,15.351563,15.585938,15.820313,16.054688,16.289062,16.523438,16.757812,16.992188,17.226562,17.460938,17.695312,17.929688,18.164062,18.398438,18.632812,18.867188,19.101562,19.335938,19.570312,19.804688,20.039062,20.273438,20.507812,20.742188,20.976562,21.210938,21.445312,21.679688,21.914062,22.148438,22.382812,22.617188,22.851562,23.085938,23.320312,23.554688,23.789062,24.023438,24.257812,24.492188,24.726562,24.960938,25.195312,25.429688,25.664062,25.898438,26.132812,26.367188,26.601562,26.835938,27.070312,27.304688,27.539062,27.773438,28.007812,28.242188,28.476562,28.710938,28.945312,29.179688,29.414062,29.648438,29.882812,30.117188,30.351562,30.585938,30.820312,31.054688,31.289062,31.523438,31.757812,31.992188,32.226562,32.460938,32.695312,32.929688,33.164062,33.398438,33.632812,33.867188,34.101562,34.335938,34.570312,34.804688,35.039062,35.273438,35.507812,35.742188,35.976562,36.210938,36.445312,36.679688,36.914062,37.148438,37.382812,37.617188,37.851562,38.085938,38.320312,38.554688,38.789062,39.023438,39.257812,39.492188,39.726562,39.960938,40.195312,40.429688,40.664062,40.898438,41.132812,41.367188,41.601562,41.835938,42.070312,42.304688,42.539062,42.773438,43.007812,43.242188,43.476562,43.710938,43.945312,44.179688,44.414062,44.648438,44.882812,45.117188,45.351562,45.585938,45.820312,46.054688,46.289062,46.523438,46.757812,46.992188,47.226562,47.460938,47.695312,47.929688,48.164062,48.398438,48.632812,48.867188,49.101562,49.335938,49.570312,49.804688,50.039062,50.273438,50.507812,50.742188,50.976562,51.210938,51.445312,51.679688,51.914062,52.148438,52.382812,52.617188,52.851562,53.085938,53.320312,53.554688,53.789062,54.023438,54.257812,54.492188,54.726562,54.960938,55.195312,55.429688,55.664062,55.898438,56.132812,56.367188,56.601562,56.835938,57.070312,57.304688,57.539062,57.773438,58.007812,58.242188,58.476562,58.710938,58.945312,59.179688,59.414062,59.648438,59.882812,60.117188,60.351562,60.585938,60.820312,61.054688,61.289062,61.523438,61.757812,61.992188,62.226562,62.460938,62.695312,62.929688,63.164062,63.398438,63.632812,63.867188,64.10156,64.33594,64.57031,64.80469,65.03906,65.27344,65.50781,65.74219,65.97656,66.21094,66.44531,66.67969,66.91406,67.14844,67.38281,67.61719,67.85156,68.08594,68.32031,68.55469,68.78906,69.02344,69.25781,69.49219,69.72656,69.96094,70.19531,70.42969,70.66406,70.89844,71.13281,71.36719,71.60156,71.83594,72.07031,72.30469,72.53906,72.77344,73.00781,73.24219,73.47656,73.71094,73.94531,74.17969,74.41406,74.64844,74.88281,75.11719,75.35156,75.58594,75.82031,76.05469,76.28906,76.52344,76.75781,76.99219,77.22656,77.46094,77.69531,77.92969,78.16406,78.39844,78.63281,78.86719,79.10156,79.33594,79.57031,79.80469,80.03906,80.27344,80.50781,80.74219,80.97656,81.21094,81.44531,81.67969,81.91406,82.14844,82.38281,82.61719,82.85156,83.08594,83.32031,83.55469,83.78906,84.02344,84.25781,84.49219,84.72656,84.96094,85.19531,85.42969,85.66406,85.89844,86.13281,86.36719,86.60156,86.83594,87.07031,87.30469,87.53906,87.77344,88.00781,88.24219,88.47656,88.71094,88.94531,89.17969,89.41406,89.64844,89.88281,90.11719,90.35156,90.58594,90.82031,91.05469,91.28906,91.52344,91.75781,91.99219,92.22656,92.46094,92.69531,92.92969,93.16406,93.39844,93.63281,93.86719,94.10156,94.33594,94.57031,94.80469,95.03906,95.27344,95.50781,95.74219,95.97656,96.21094,96.44531,96.67969,96.91406,97.14844,97.38281,97.61719,97.85156,98.08594,98.32031,98.55469,98.78906,99.02344,99.25781,99.49219,99.72656,99.96094,100.19531,100.42969,100.66406,100.89844,101.13281,101.36719,101.60156,101.83594,102.07031,102.30469,102.53906,102.77344,103.00781,103.24219,103.47656,103.71094,103.94531,104.17969,104.41406,104.64844,104.88281,105.11719,105.35156,105.58594,105.82031,106.05469,106.28906,106.52344,106.75781,106.99219,107.22656,107.46094,107.69531,107.92969,108.16406,108.39844,108.63281,108.86719,109.10156,109.33594,109.57031,109.80469,110.03906,110.27344,110.50781,110.74219,110.97656,111.21094,111.44531,111.67969,111.91406,112.14844,112.38281,112.61719,112.85156,113.08594,113.32031,113.55469,113.78906,114.02344,114.25781,114.49219,114.72656,114.96094,115.19531,115.42969,115.66406,115.89844,116.13281,116.36719,116.60156,116.83594,117.07031,117.30469,117.53906,117.77344,118.00781,118.24219,118.47656,118.71094,118.94531,119.17969,119.41406,119.64844,119.88281,120.11719,120.35156,120.58594,120.82031,121.05469,121.28906,121.52344,121.75781,121.99219,122.22656,122.46094,122.69531,122.92969,123.16406,123.39844,123.63281,123.86719,124.10156,124.33594,124.57031,124.80469,125.03906,125.27344,125.50781,125.74219,125.97656,126.21094,126.44531,126.67969,126.91406,127.14844,127.38281,127.61719,127.85156,128.08594,128.32031,128.55469,128.78906,129.02344,129.25781,129.49219,129.72656,129.96094,130.19531,130.42969,130.66406,130.89844,131.13281,131.36719,131.60156,131.83594,132.07031,132.30469,132.53906,132.77344,133.00781,133.24219,133.47656,133.71094,133.94531,134.17969,134.41406,134.64844,134.88281,135.11719,135.35156,135.58594,135.82031,136.05469,136.28906,136.52344,136.75781,136.99219,137.22656,137.46094,137.69531,137.92969,138.16406,138.39844,138.63281,138.86719,139.10156,139.33594,139.57031,139.80469,140.03906,140.27344,140.50781,140.74219,140.97656,141.21094,141.44531,141.67969,141.91406,142.14844,142.38281,142.61719,142.85156,143.08594,143.32031,143.55469,143.78906,144.02344,144.25781,144.49219,144.72656,144.96094,145.19531,145.42969,145.66406,145.89844,146.13281,146.36719,146.60156,146.83594,147.07031,147.30469,147.53906,147.77344,148.00781,148.24219,148.47656,148.71094,148.94531,149.17969,149.41406,149.64844,149.88281,150.11719,150.35156,150.58594,150.82031,151.05469,151.28906,151.52344,151.75781,151.99219,152.22656,152.46094,152.69531,152.92969,153.16406,153.39844,153.63281,153.86719,154.10156,154.33594,154.57031,154.80469,155.03906,155.27344,155.50781,155.74219,155.97656,156.21094,156.44531,156.67969,156.91406,157.14844,157.38281,157.61719,157.85156,158.08594,158.32031,158.55469,158.78906,159.02344,159.25781,159.49219,159.72656,159.96094,160.19531,160.42969,160.66406,160.89844,161.13281,161.36719,161.60156,161.83594,162.07031,162.30469,162.53906,162.77344,163.00781,163.24219,163.47656,163.71094,163.94531,164.17969,164.41406,164.64844,164.88281,165.11719,165.35156,165.58594,165.82031,166.05469,166.28906,166.52344,166.75781,166.99219,167.22656,167.46094,167.69531,167.92969,168.16406,168.39844,168.63281,168.86719,169.10156,169.33594,169.57031,169.80469,170.03906,170.27344,170.50781,170.74219,170.97656,171.21094,171.44531,171.67969,171.91406,172.14844,172.38281,172.61719,172.85156,173.08594,173.32031,173.55469,173.78906,174.02344,174.25781,174.49219,174.72656,174.96094,175.19531,175.42969,175.66406,175.89844,176.13281,176.36719,176.60156,176.83594,177.07031,177.30469,177.53906,177.77344,178.00781,178.24219,178.47656,178.71094,178.94531,179.17969,179.41406,179.64844,179.88281,180.11719,180.35156,180.58594,180.82031,181.05469,181.28906,181.52344,181.75781,181.99219,182.22656,182.46094,182.69531,182.92969,183.16406,183.39844,183.63281,183.86719,184.10156,184.33594,184.57031,184.80469,185.03906,185.27344,185.50781,185.74219,185.97656,186.21094,186.44531,186.67969,186.91406,187.14844,187.38281,187.61719,187.85156,188.08594,188.32031,188.55469,188.78906,189.02344,189.25781,189.49219,189.72656,189.96094,190.19531,190.42969,190.66406,190.89844,191.13281,191.36719,191.60156,191.83594,192.07031,192.30469,192.53906,192.77344,193.00781,193.24219,193.47656,193.71094,193.94531,194.17969,194.41406,194.64844,194.88281,195.11719,195.35156,195.58594,195.82031,196.05469,196.28906,196.52344,196.75781,196.99219,197.22656,197.46094,197.69531,197.92969,198.16406,198.39844,198.63281,198.86719,199.10156,199.33594,199.57031,199.80469,200.03906,200.27344,200.50781,200.74219,200.97656,201.21094,201.44531,201.67969,201.91406,202.14844,202.38281,202.61719,202.85156,203.08594,203.32031,203.55469,203.78906,204.02344,204.25781,204.49219,204.72656,204.96094,205.19531,205.42969,205.66406,205.89844,206.13281,206.36719,206.60156,206.83594,207.07031,207.30469,207.53906,207.77344,208.00781,208.24219,208.47656,208.71094,208.94531,209.17969,209.41406,209.64844,209.88281,210.11719,210.35156,210.58594,210.82031,211.05469,211.28906,211.52344,211.75781,211.99219,212.22656,212.46094,212.69531,212.92969,213.16406,213.39844,213.63281,213.86719,214.10156,214.33594,214.57031,214.80469,215.03906,215.27344,215.50781,215.74219,215.97656,216.21094,216.44531,216.67969,216.91406,217.14844,217.38281,217.61719,217.85156,218.08594,218.32031,218.55469,218.78906,219.02344,219.25781,219.49219,219.72656,219.96094,220.19531,220.42969,220.66406,220.89844,221.13281,221.36719,221.60156,221.83594,222.07031,222.30469,222.53906,222.77344,223.00781,223.24219,223.47656,223.71094,223.94531,224.17969,224.41406,224.64844,224.88281,225.11719,225.35156,225.58594,225.82031,226.05469,226.28906,226.52344,226.75781,226.99219,227.22656,227.46094,227.69531,227.92969,228.16406,228.39844,228.63281,228.86719,229.10156,229.33594,229.57031,229.80469,230.03906,230.27344,230.50781,230.74219,230.97656,231.21094,231.44531,231.67969,231.91406,232.14844,232.38281,232.61719,232.85156,233.08594,233.32031,233.55469,233.78906,234.02344,234.25781,234.49219,234.72656,234.96094,235.19531,235.42969,235.66406,235.89844,236.13281,236.36719,236.60156,236.83594,237.07031,237.30469,237.53906,237.77344,238.00781,238.24219,238.47656,238.71094,238.94531,239.17969,239.41406,239.64844,239.88281,240.11719,240.35156,240.58594,240.82031,241.05469,241.28906,241.52344,241.75781,241.99219,242.22656,242.46094,242.69531,242.92969,243.16406,243.39844,243.63281,243.86719,244.10156,244.33594,244.57031,244.80469,245.03906,245.27344,245.50781,245.74219,245.97656,246.21094,246.44531,246.67969,246.91406,247.14844,247.38281,247.61719,247.85156,248.08594,248.32031,248.55469,248.78906,249.02344,249.25781,249.49219,249.72656,249.96094,250.19531,250.42969,250.66406,250.89844,251.13281,251.36719,251.60156,251.83594,252.07031,252.30469,252.53906,252.77344,253.00781,253.24219,253.47656,253.71094,253.94531,254.17969,254.41406,254.64844,254.88281,255.11719,255.35156,255.58594,255.82031,256.0547,256.28906,256.52344,256.7578,256.9922,257.22656,257.46094,257.6953,257.9297,258.16406,258.39844,258.6328,258.8672,259.10156,259.33594,259.5703,259.8047,260.03906,260.27344,260.5078,260.7422,260.97656,261.21094,261.4453,261.6797,261.91406,262.14844,262.3828,262.6172,262.85156,263.08594,263.3203,263.5547,263.78906,264.02344,264.2578,264.4922,264.72656,264.96094,265.1953,265.4297,265.66406,265.89844,266.1328,266.3672,266.60156,266.83594,267.0703,267.3047,267.53906,267.77344,268.0078,268.2422,268.47656,268.71094,268.9453,269.1797,269.41406,269.64844,269.8828,270.1172,270.35156,270.58594,270.8203,271.0547,271.28906,271.52344,271.7578,271.9922,272.22656,272.46094,272.6953,272.9297,273.16406,273.39844,273.6328,273.8672,274.10156,274.33594,274.5703,274.8047,275.03906,275.27344,275.5078,275.7422,275.97656,276.21094,276.4453,276.6797,276.91406,277.14844,277.3828,277.6172,277.85156,278.08594,278.3203,278.5547,278.78906,279.02344,279.2578,279.4922,279.72656,279.96094,280.1953,280.4297,280.66406,280.89844,281.1328,281.3672,281.60156,281.83594,282.0703,282.3047,282.53906,282.77344,283.0078,283.2422,283.47656,283.71094,283.9453,284.1797,284.41406,284.64844,284.8828,285.1172,285.35156,285.58594,285.8203,286.0547,286.28906,286.52344,286.7578,286.9922,287.22656,287.46094,287.6953,287.9297,288.16406,288.39844,288.6328,288.8672,289.10156,289.33594,289.5703,289.8047,290.03906,290.27344,290.5078,290.7422,290.97656,291.21094,291.4453,291.6797,291.91406,292.14844,292.3828,292.6172,292.85156,293.08594,293.3203,293.5547,293.78906,294.02344,294.2578,294.4922,294.72656,294.96094,295.1953,295.4297,295.66406,295.89844,296.1328,296.3672,296.60156,296.83594,297.0703,297.3047,297.53906,297.77344,298.0078,298.2422,298.47656,298.71094,298.9453,299.1797,299.41406,299.64844,299.8828,300.1172,300.35156,300.58594,300.8203,301.0547,301.28906,301.52344,301.7578,301.9922,302.22656,302.46094,302.6953,302.9297,303.16406,303.39844,303.6328,303.8672,304.10156,304.33594,304.5703,304.8047,305.03906,305.27344,305.5078,305.7422,305.97656,306.21094,306.4453,306.6797,306.91406,307.14844,307.3828,307.6172,307.85156,308.08594,308.3203,308.5547,308.78906,309.02344,309.2578,309.4922,309.72656,309.96094,310.1953,310.4297,310.66406,310.89844,311.1328,311.3672,311.60156,311.83594,312.0703,312.3047,312.53906,312.77344,313.0078,313.2422,313.47656,313.71094,313.9453,314.1797,314.41406,314.64844,314.8828,315.1172,315.35156,315.58594,315.8203,316.0547,316.28906,316.52344,316.7578,316.9922,317.22656,317.46094,317.6953,317.9297,318.16406,318.39844,318.6328,318.8672,319.10156,319.33594,319.5703,319.8047,320.03906,320.27344,320.5078,320.7422,320.97656,321.21094,321.4453,321.6797,321.91406,322.14844,322.3828,322.6172,322.85156,323.08594,323.3203,323.5547,323.78906,324.02344,324.2578,324.4922,324.72656,324.96094,325.1953,325.4297,325.66406,325.89844,326.1328,326.3672,326.60156,326.83594,327.0703,327.3047,327.53906,327.77344,328.0078,328.2422,328.47656,328.71094,328.9453,329.1797,329.41406,329.64844,329.8828,330.1172,330.35156,330.58594,330.8203,331.0547,331.28906,331.52344,331.7578,331.9922,332.22656,332.46094,332.6953,332.9297,333.16406,333.39844,333.6328,333.8672,334.10156,334.33594,334.5703,334.8047,335.03906,335.27344,335.5078,335.7422,335.97656,336.21094,336.4453,336.6797,336.91406,337.14844,337.3828,337.6172,337.85156,338.08594,338.3203,338.5547,338.78906,339.02344,339.2578,339.4922,339.72656,339.96094,340.1953,340.4297,340.66406,340.89844,341.1328,341.3672,341.60156,341.83594,342.0703,342.3047,342.53906,342.77344,343.0078,343.2422,343.47656,343.71094,343.9453,344.1797,344.41406,344.64844,344.8828,345.1172,345.35156,345.58594,345.8203,346.0547,346.28906,346.52344,346.7578,346.9922,347.22656,347.46094,347.6953,347.9297,348.16406,348.39844,348.6328,348.8672,349.10156,349.33594,349.5703,349.8047,350.03906,350.27344,350.5078,350.7422,350.97656,351.21094,351.4453,351.6797,351.91406,352.14844,352.3828,352.6172,352.85156,353.08594,353.3203,353.5547,353.78906,354.02344,354.2578,354.4922,354.72656,354.96094,355.1953,355.4297,355.66406,355.89844,356.1328,356.3672,356.60156,356.83594,357.0703,357.3047,357.53906,357.77344,358.0078,358.2422,358.47656,358.71094,358.9453,359.1797,359.41406,359.64844,359.8828]},fi=function(){},gi=function(){if(!(this instanceof gi))throw new Error(ot.CONSTRUCT_ERROR);this.volumeTex,this.gl,this.maxTemperature,this.minTemperature,this.geographicExtent,this.weatherStation,this.cuttingPlanesArray,this.weatherEarthArray};gi.prototype.loadVolumeTexture=function(t,e){var i=document.createElement("img");i.onload=function(e){for(var r=t.columns,o=i.width/r,n=t.slices,a=i.height/(n/r),s=document.createElement("canvas"),l=s.getContext("2d"),h=new Uint8Array(o*a*n),d=0;d<r;d++){s.width=o,s.height=i.height,l.drawImage(i,-d*o,0);for(var c=l.getImageData(0,0,s.width,s.height).data,u=0;u<h.length/r;u++)h[u+d*h.length/r]=c[4*u]}var f=new Uint8ClampedArray(3*h.length),g=0,p=0,v=0;for(u=0;u<h.length;u++)g=h[u-1]-h[u+1],isNaN(g)?f[3*u]=128:f[3*u]=g+128,p=h[u-o]-h[u+o],isNaN(p)?f[3*u+1]=128:f[3*u+1]=p+128,v=h[u-o*a]-h[u+o*a],isNaN(v)?f[3*u+2]=128:f[3*u+2]=v+128;f=new Uint8Array(f)},i.src=t.src},gi.prototype.loadVolumeData=function(){var t=ui.lon.length,e=ui.lat.length,i=ui.isobaric.length,r=this.weatherStation.provisional_geometryDataPath+"/volumRenderingTest/Temperature.bin",o=new fi;o.numCols=t,o.numRows=e,o.numSlices=i,ge.loadBinaryData(r,o,this)},gi.createTexture=function(t,e,i,r,o){var n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),i instanceof Uint8Array?t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,r,o,0,t.LUMINANCE,t.UNSIGNED_BYTE,i):t.texImage2D(t.TEXTURE_2D,0,t.LUMINANCE,t.LUMINANCE,t.UNSIGNED_BYTE,i),t.bindTexture(t.TEXTURE_2D,null),n},gi.calculateNumStacks=function(t,e,i,r){var o=-1,n=t.getParameter(t.MAX_TEXTURE_SIZE);if(e>n)return-1;for(var a=!1,s=1;!a;){if(i*Math.ceil(r/s)<n){if(a=!0,e*s>n)return-1;o=s}if(++s>=r)return-1}return o},gi.prototype.parseData=function(t){var e=this.gl,i=ui.lon.length,r=ui.lat.length,o=ui.isobaric.length,n=i*r*o,a=new DataStream(t.dataArraybuffer,0,DataStream.BIG_ENDIAN).readFloat32Array(n);t.dataArraybuffer=a;var s,l=a.length;this.maxTemperature=a[0],this.minTemperature=a[0];for(var h=1;h<l;h++)(s=a[h])>this.maxTemperature?this.maxTemperature=s:s<this.minTemperature&&(this.minTemperature=s);var d=this.maxTemperature-this.minTemperature;this.image3d=new li;var c=i,u=r;this.resampledWidth=c,this.resampledHeght=u;for(h=0;h<i;h++)ui.lon[h]-=180;for(var f=ui.lon[0],g=ui.lon[i-1],p=ui.lat[0],v=ui.lat[r-1],y=i/2,m=Math.floor(i/c),x=Math.floor(r/u),b=this.image3d.newStack(),C=0;C<o;C++){var A=b.newSlice(),T=c*u;A.dataArray=new Uint8Array(T),A.width=c,A.height=u;for(var M=0;M<u;M++)for(h=0;h<c;h++){var P=h*m,w=M*x+C*r;(P+=y)>i&&(P-=i);var _=li.getIndexOfArray(i,P,w),S=li.getIndexOfArray(c,h,M),L=a[_],R=Math.floor(256*(L-this.minTemperature)/d);A.dataArray[S]=R}void 0===A.geographicExtent&&(A.geographicExtent=new G),A.geographicExtent.setExtent(f,p,0,g,v,0)}this.image3d.stacksArray[0].slicesArray.reverse();var D=e.getParameter(e.MAX_TEXTURE_SIZE);this.reorderedImage3d=hi.convertMonoStackImage3DToMultiStackImage3D(this.image3d,void 0,D),this.uniqueSlice=this.reorderedImage3d.getAnUniqueSlice(void 0);var E=this.uniqueSlice.width,I=this.uniqueSlice.height,O=e.LINEAR,F=gi.createTexture(e,O,this.uniqueSlice.dataArray,E,I);this.volumeTex=new At,this.volumeTex.texId=F},gi.prototype.init=function(t,e){this.gl=t,this.loadVolumeData();e.sceneState;var i=e.myCameraSCX.bigFrustum,r=(e.sceneState.camera.frustum.fovyRad,i.aspectRatio[0]),o=i.tangentOfHalfFovy[0],n=o*r,a=new ur(-n,-o,-1),s=new ur(n,-o,-1),l=new ur(n,o,-1),h=new ur(-n,o,-1);if(void 0===this.quadBuffer){var d=new Float32Array([a.x,a.y,a.z,s.x,s.y,s.z,h.x,h.y,h.z,s.x,s.y,s.z,l.x,l.y,l.z,h.x,h.y,h.z]);this.quadBuffer=R.createBuffer(t,d)}var c=$e.wgs84_volumVS,u=$e.wgs84_volumFS;this.temperatureProgram=Shader.createProgram(t,c,u),void 0===this.geographicExtent&&(this.geographicExtent=new G),this.geographicExtent.setExtent(-180,-90,0,180,90,0)},gi.prototype.test_makeGeometryFromSlice=function(t,e,i,r,o,n,a){if(void 0!==this.image3d){Math.PI;var s,l,h,d,c,u,f,g,p=t.geographicExtent.minGeographicCoord.longitude,v=t.geographicExtent.minGeographicCoord.latitude,y=t.geographicExtent.maxGeographicCoord.longitude,m=t.geographicExtent.maxGeographicCoord.latitude,x=(y-p)/(t.width-1),b=(m-v)/(t.height-1),C=p,A=v,T=new kr,M=a*(a-n)*5-n;.6;for(var P=i;P<=o;P++){c=T.newVertexList(),l=A+P*b;for(var w=e;w<=r;w++){var S=w;S>=t.width&&(S-=t.width),s=C+S*x,h=t?t.getValue(S,P):0,h*=5*(h-n),f=c.newVertex(),(u=(h-n)/M)>1?u=1:u<0&&(u=0),d=_.grayToRGB_MagoStyle(u,d),g=W.geographicToCartesianWgs84(s,l,h,g),f.setPosition(g[0],g[1],g[2]),f.setColorRGBA(d.b,d.g,d.r,.6)}}var L=new rr,R=kr.makeSurface(T,void 0,!1,!0);R.calculateVerticesNormals(),L.addSurface(R),void 0===this.meshesArray&&(this.meshesArray=[]),this.meshesArray.push(L)}},gi.prototype.test_makeGeometryFromData=function(t){if(void 0!==this.image3d)for(var e,i,r,o,n=this.image3d.getStacksCount(),a=0;a<n;a++)for(var s=this.image3d.getStack(a),l=s.getSlicesCount(),h=0;h<l;h++){for(var d=s.getSlice(0),c=[],u=(c=ai.getMinMaxValuesOfArray(d.dataArray,c))[0],f=c[1],g=Math.floor(d.width/300),p=Math.floor(d.height/300),v=0;v<=p;v++)for(var y=0;y<=g;y++)e=300*y,(i=300*(y+1))>d.width&&(i=d.width),r=300*v,(o=300*(v+1))>d.height&&(o=d.height),this.test_makeGeometryFromSlice(d,e,r,i,o,u,f);break}},gi.prototype.test_makeCuttingPlane=function(t){void 0===this.cuttingPlanesArray&&(this.cuttingPlanesArray=[]);var e=new Ui;this.cuttingPlanesArray.push(e);var i=128,r=37.5,o=0;void 0===e.geoLocDataManager&&(e.geoLocDataManager=new H);var n=e.geoLocDataManager.newGeoLocationData("default"),a=90,s=45,l=0;Ei.calculateGeoLocationData(i,r,o,a,s,l,n,t);var h=5e5,d=5e5;e.makeRectangle(h,d);e=new Ui;this.cuttingPlanesArray.push(e);i=128,r=32,o=0;void 0===e.geoLocDataManager&&(e.geoLocDataManager=new H);n=e.geoLocDataManager.newGeoLocationData("default"),a=0,s=90,l=0;Ei.calculateGeoLocationData(i,r,o,a,s,l,n,t);h=5e5,d=5e5;e.makeRectangle(h,d)},gi.prototype.test_renderCuttingPlanes=function(t,e,i){if(void 0!==this.cuttingPlanesArray)for(var r=t.sceneState.gl,o=this.cuttingPlanesArray.length,n=0;n<o;n++){var a=this.cuttingPlanesArray[n],s=a.geoLocDataManager;if(void 0!==s){var l=s.getCurrentGeoLocationData();void 0!==l&&(r.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,l.rotMatrix._floatArrays),r.uniform3fv(e.buildingPosHIGH_loc,l.positionHIGH),r.uniform3fv(e.buildingPosLOW_loc,l.positionLOW),r.uniform3fv(e.aditionalMov_loc,[0,0,0]),a.render(t,e,i))}}},gi.prototype.test_getCuttingPlanesParams=function(t){var e=this.cuttingPlanesArray.length;if(t=new Float32Array(24),e>0)for(var i=0;i<e;i++){var r=this.cuttingPlanesArray[i].getPlane();t[4*i]=r.a,t[4*i+1]=r.b,t[4*i+2]=r.c,t[4*i+3]=r.d}return t},gi.prototype.renderMesh=function(t,e,i){if(void 0!==this.meshesArray)for(var r=this.meshesArray.length,o=0;o<r;o++)this.meshesArray[o].render(t,e,i)},gi.prototype.render=function(t){if(void 0!==this.volumeTex&&void 0!==this.reorderedImage3d){var e=t.sceneState,i=e.getModelViewMatrixInv(),r=e.projectionMatrix,o=t.myCameraSCX.bigFrustum,n=this.gl;n.enable(n.BLEND);var a=this.temperatureProgram;n.useProgram(a.program),n.enableVertexAttribArray(a.position),n.bindBuffer(n.ARRAY_BUFFER,this.quadBuffer),n.vertexAttribPointer(a.position,3,n.FLOAT,!1,0,0),R.bindTexture(n,this.volumeTex.texId,0),n.uniformMatrix4fv(a.modelViewMatrixInv,!1,i._floatArrays),n.uniformMatrix4fv(a.projectionMatrix,!1,r._floatArrays),n.uniform3fv(a.encodedCameraPositionMCHigh,e.encodedCamPosHigh),n.uniform3fv(a.encodedCameraPositionMCLow,e.encodedCamPosLow),n.uniform1f(a.screenWidth,e.drawingBufferWidth[0]),n.uniform1f(a.screenHeight,e.drawingBufferHeight[0]),n.uniform1f(a.aspectRatio,o.aspectRatio[0]),n.uniform1f(a.far,o.far[0]),n.uniform1f(a.fovyRad,o.fovyRad[0]),n.uniform1f(a.tanHalfFovy,o.tangentOfHalfFovy[0]);var s=ui.isobaric.length,l=this.reorderedImage3d.stacksArray[0],h=(this.reorderedImage3d.stacksArray.length,l.slicesArray.length),d=l.slicesArray[0],c=d.width,u=d.height,f=this.uniqueSlice.width,g=this.uniqueSlice.height;n.uniform1i(a.texNumCols,f),n.uniform1i(a.texNumRows,g),n.uniform1i(a.texNumSlices,s),n.uniform1i(a.numSlicesPerStacks,h),n.uniform1i(a.slicesNumCols,c),n.uniform1i(a.slicesNumRows,u);var p=0;this.cuttingPlanesArray&&(p=this.cuttingPlanesArray.length);var v=this.test_getCuttingPlanesParams(void 0);n.uniform1i(a.cuttingPlanesCount,p);var y=n.getUniformLocation(a.program,"cuttingPlanes");n.uniform4fv(y,v),n.uniform1f(a.maxLon,180),n.uniform1f(a.minLon,-180),n.uniform1f(a.maxLat,90),n.uniform1f(a.minLat,-90),n.uniform1f(a.maxAlt,15e4),n.uniform1f(a.minAlt,0),n.uniform1f(a.maxValue,this.maxTemperature),n.uniform1f(a.minValue,this.minTemperature),n.drawArrays(n.TRIANGLES,0,6),n.disable(n.BLEND)}};var pi=function(){if(!(this instanceof pi))throw new Error(ot.CONSTRUCT_ERROR);this.provisional_geometryDataPath,this.windLayersArray,this.windVolumesArray,this.tempLayersArray,this.precipitLayersArray,this.focusedWindLayerIdx,this.windDisplayBox};pi.prototype.getWindLayersCount=function(){return void 0===this.windLayersArray?0:this.windLayersArray.length},pi.prototype.getWindLayer=function(t){if(void 0!==this.windLayersArray)return this.windLayersArray[t]},pi.prototype.newWindLayer=function(t){void 0===this.windLayersArray&&(this.windLayersArray=[]);var e=new vi(t);return e.weatherStation=this,this.windLayersArray.push(e),e},pi.prototype.newWindVolume=function(t){void 0===this.windVolumesArray&&(this.windVolumesArray=[]);var e=new yi(t);return e.weatherStation=this,this.windVolumesArray.push(e),e},pi.prototype.newTemperatureLayer=function(){void 0===this.tempLayersArray&&(this.tempLayersArray=[]);var t=new gi;return t.weatherStation=this,this.tempLayersArray.push(t),t},pi.prototype.newPrecipitationLayer=function(){void 0===this.precipitLayersArray&&(this.precipitLayersArray=[]);var t=new ci;return t.weatherStation=this,this.precipitLayersArray.push(t),t},pi.prototype.test_createTemperaturaLayerExample=function(t){var e=t.sceneState.gl;(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=t.readerWriter.geometryDataPath),void 0===this.tempLayersArray||0===this.tempLayersArray.length)&&((o=this.newTemperatureLayer()).init(e,t),o.test_makeCuttingPlane(t),o.test_makeGeometryFromData(t));var i=0;this.tempLayersArray&&(i=this.tempLayersArray.length);for(var r=0;r<i;r++){var o;void 0===(o=this.tempLayersArray[r]).meshesArray&&o.test_makeGeometryFromData(t)}},pi.prototype.test_createPrecipitationLayerExample=function(t){void 0===this.precipitLayersArray&&(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=t.readerWriter.geometryDataPath),(r=this.newPrecipitationLayer()).init());var e=0;this.precipitLayersArray&&(e=this.precipitLayersArray.length);for(var i=0;i<e;i++){var r;void 0===(r=this.precipitLayersArray[i]).meshesArray&&r.test_makeGeometryFromData(t)}},pi.prototype.test_createWindLayerExample=function(t){var e=t.sceneState.gl;if(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=t.readerWriter.geometryDataPath),void 0===this.windLayersArray||0===this.windLayersArray.length){var i=this.provisional_geometryDataPath,r={name:"JeJu Island",speedFactor:2,dropRate:.003,dropRateBump:.001,numParticles:4096,layerAltitude:1e3,windMapFileName:"OBS-QWM_2016062000.grib2_wind_000",windMapFolderPath:i+"/JeJu_wind_20191127"};this.newWindLayer(r).init(e)}},pi.prototype.renderWindMultiLayers=function(t){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length){var e,i;void 0===this.focusedWindLayerIdx&&(this.focusedWindLayerIdx=0);for(var r=this.windLayersArray.length-1;r>=0;r--)(i=this.windLayersArray[r]).isReadyToRender()?(i.renderMode3D(t),e=i.gl,R.bindTexture(e,i.windMapTexture.texId,0),i.updateParticlesPositions(t)):i.prepareWindLayer()}},pi.prototype.renderWindLayerDisplayPlanes=function(t){if(void 0!==this.windVolumesArray&&0!==this.windVolumesArray.length)for(var e=this.windVolumesArray.length,i=0;i<e;i++)i>0&&this.windVolumesArray[i].windDisplayBox&&this.windVolumesArray[i].windDisplayBox.setOneColor(.2,.7,.8,0),this.windVolumesArray[i].renderWindLayerDisplayPlanes(t)},pi.prototype.test_loadWindData3d=function(t,e,i){t.getGl(),t.readerWriter.geometryDataPath;this.altitudeAux=0,this.newWindVolume().loadWindData3d(t,e,i),this.newWindVolume().loadWindData3d(t,e,i),this.newWindVolume().loadWindData3d(t,e,i)},pi.prototype.test_renderWindLayer=function(t){if(this.test_createWindLayerExample(t),void 0!==this.windLayersArray&&0!==this.windLayersArray.length){for(var e,i=this.windLayersArray.length,r=0;r<i;r++){if(!(r<i-1))(o=this.windLayersArray[r]).renderMode3D(t),e=o.gl}for(r=0;r<i;r++){var o;if(!(r<i-1))(o=this.windLayersArray[r]).windMapTexture.fileLoadState===c.fileLoadState.BINDING_FINISHED&&(R.bindTexture(e,o.windMapTexture.texId,0),o.updateParticlesPositions(t))}}},pi.prototype.test_renderTemperatureLayer=function(t){(this.test_createTemperaturaLayerExample(t),void 0!==this.tempLayersArray)&&(0!==this.tempLayersArray.length&&this.tempLayersArray[0].render(t))},pi.prototype.test_renderTemperatureMesh=function(t,e,i){(this.test_createTemperaturaLayerExample(t),void 0!==this.tempLayersArray)&&(0!==this.tempLayersArray.length&&this.tempLayersArray[0].renderMesh(t,e,i))},pi.prototype.test_renderPrecipitationMesh=function(t,e,i){(this.test_createPrecipitationLayerExample(t),void 0!==this.precipitLayersArray)&&(0!==this.precipitLayersArray.length&&this.precipitLayersArray[0].renderMesh(t,e,i))},pi.prototype.test_renderCuttingPlanes=function(t,e){if(void 0!==this.tempLayersArray&&0!==this.tempLayersArray.length){var i,r=this.tempLayersArray[0],o=t.sceneState.gl;2===e?((i=t.postFxShadersManager.getShader("modelRefColorCoding")).useProgram(),i.bindUniformGenerals(),i.disableVertexAttribArray(i.texCoord2_loc),i.enableVertexAttribArray(i.position3_loc),i.disableVertexAttribArray(i.normal3_loc),i.disableVertexAttribArray(i.color4_loc)):0===e?((i=t.postFxShadersManager.getShader("modelRefDepth")).useProgram(),i.bindUniformGenerals(),i.enableVertexAttribArray(i.position3_loc)):1===e&&((i=t.postFxShadersManager.getShader("modelRefSsao")).useProgram(),i.bindUniformGenerals(),i.disableVertexAttribArray(i.texCoord2_loc),i.enableVertexAttribArray(i.position3_loc),i.enableVertexAttribArray(i.normal3_loc),i.disableVertexAttribArray(i.color4_loc)),o.uniform1i(i.bApplySpecularLighting_loc,!1),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,t.depthFboNeo.colorBuffer),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,t.noiseTexture),o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,t.textureAux_1x1),r.test_renderCuttingPlanes(t,i,e)}};var vi=function(t){if(!(this instanceof vi))throw new Error(ot.CONSTRUCT_ERROR);this.weatherStation,this.gl,this.windMapsArray=[],this.windMapTexture,this.windMapJson,this.windMapFileName,this.windMapFolderPath,this.windData,this.currWindMap,this.currWindMapIdx=0,this.screenTexture0,this.screenTexture1,this.screenTexWidth,this.screenTexHeight,this.geoExtent,this.layerAltitude=6e3,this.geoLocDataManager,this.drawParticlesProgram,this.screenFadeProgram,this.updateParticlesProgram,this.drawRegionProgram,this.quadBuffer,this.particlesPositionTexture0,this.particlesPositionTexture1,this.weatherEarth,this.fadeOpacity=.9999,this.speedFactor=.04,this.dropRate=.003,this.dropRateBump=.001,this.speedFactor=3,this.dropRate=.003,this.dropRateBump=.01,this.numParticles=16384,this.flipTexCoordsY_windMap=!0,this.externalAlpha=.7,void 0!==t&&(void 0!==t.speedFactor&&(this.speedFactor=t.speedFactor),void 0!==t.dropRate&&(this.dropRate=t.dropRate),void 0!==t.dropRateBump&&(this.dropRateBump=t.dropRateBump),void 0!==t.numParticles&&(this.numParticles=t.numParticles),void 0!==t.windMapFileName&&(this.windMapFileName=t.windMapFileName),void 0!==t.windMapFolderPath&&(this.windMapFolderPath=t.windMapFolderPath),void 0!==t.layerAltitude&&(this.layerAltitude=t.layerAltitude))};vi.prototype.init=function(t,e){if(this.gl=t,void 0===this.quadBuffer){var i=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=R.createBuffer(t,i)}void 0===this.windFramebuffer&&(this.windFramebuffer=t.createFramebuffer());var r=$e.draw_vert,o=$e.draw_frag;this.drawParticlesProgram=Qe.createProgram(t,r,o),r=$e.quad_vert,o=$e.screen_frag,this.screenFadeProgram=Qe.createProgram(t,r,o),r=$e.quad_vert,o=$e.update_frag,this.updateParticlesProgram=Qe.createProgram(t,r,o),this.updateParticlesProgram.u_visibleTilesRanges=t.getUniformLocation(this.updateParticlesProgram.program,"u_visibleTilesRanges");r=$e.draw_vert3D,o=$e.draw_frag3D;this.drawParticles3DShader=e.postFxShadersManager.createShaderProgram(t,r,o,"drawWindParticles3d",e),this.drawParticlesProgram3D=this.drawParticles3DShader.program;var n=this.particleStateResolution=Math.ceil(Math.sqrt(this.numParticles));this.numParticles=n*n;for(var a=new Uint8Array(4*this.numParticles),s=0;s<a.length;s++)a[s]=Math.floor(256*Math.random());this.particlesPositionTexturesArray=[];for(s=0;s<10;s++){var l=At.createTexture(t,t.NEAREST,a,n,n);this.particlesPositionTexturesArray.push(l)}var h=new Float32Array(this.numParticles);for(s=0;s<this.numParticles;s++)h[s]=s;this.particleIndexBuffer=R.createBuffer(t,h)},vi.prototype.prepareWindLayer=function(){if(void 0===this.windMapTexture&&(this.windMapTexture=new At,this.windMapTexture.texId=this.gl.createTexture()),this.windMapTexture.fileLoadState===c.fileLoadState.READY){var t=this.windMapFolderPath+"/"+this.windMapFileName+".png";return ge.loadImage(this.gl,t,this.windMapTexture),!1}if(void 0===this.windMapJsonFileLoadState||this.windMapJsonFileLoadState===c.fileLoadState.READY){this.windMapJsonFileLoadState=c.fileLoadState.LOADING_STARTED;var e=this;return Di(this.windMapFolderPath+"/"+this.windMapFileName+".json",void 0,void 0,"json","GET").done(function(t){e.windMapJson=t,e.windMapJsonFileLoadState=c.fileLoadState.LOADING_FINISHED;var i=e.windMapJson.lon.length,r=e.windMapJson.lat.length,o=e.windMapJson.lon[0],n=e.windMapJson.lon[i-1],a=e.windMapJson.lat[r-1],s=e.windMapJson.lat[0];e.windMapJson.minLon&&(o=e.windMapJson.minLon),e.windMapJson.maxLon&&(n=e.windMapJson.maxLon),e.windMapJson.minLat&&(a=e.windMapJson.minLat),e.windMapJson.maxLat&&(s=e.windMapJson.maxLat);var l=10;void 0!==e.windMapJson.height_above_ground&&(l=e.windMapJson.height_above_ground[0]);var h=o,d=a,u=l,f=n,g=s,p=l;e.geoExtent=new G(h,d,u,f,g,p),void 0===e.windData&&(e.windData={}),e.windData.uMin=e.windMapJson.uMin,e.windData.vMin=e.windMapJson.vMin,e.windData.uMax=e.windMapJson.uMax,e.windData.vMax=e.windMapJson.vMax,e.windData.height=e.windMapJson.height,e.windData.width=e.windMapJson.width,e.windData.height_above_ground=e.windMapJson.height_above_ground[0],e.geoLocDataManager=new H;var v=e.geoLocDataManager.newGeoLocationData("centerOfTile"),y=e.layerAltitude;Ei.calculateGeoLocationData((o+n)/2,(a+s)/2,y,0,0,0,v)}),!1}return!0},vi.prototype.isReadyToRender=function(){return void 0!==this.windMapTexture&&this.windMapTexture.fileLoadState===c.fileLoadState.BINDING_FINISHED&&void 0!==this.windMapJsonFileLoadState&&this.windMapJsonFileLoadState===c.fileLoadState.LOADING_FINISHED},vi.prototype.createEarthRegion=function(t,e,i,r,o,n){void 0===t&&(t=-180),void 0===e&&(e=-90),void 0===i&&(i=180),void 0===r&&(r=90),void 0===o&&(o=0),this.weatherEarth=new ve,this.weatherEarth.geographicExtent=new G,this.weatherEarth.geographicExtent.minGeographicCoord=new j,this.weatherEarth.geographicExtent.maxGeographicCoord=new j,this.weatherEarth.geographicExtent.minGeographicCoord.setLonLatAlt(t,e,o),this.weatherEarth.geographicExtent.maxGeographicCoord.setLonLatAlt(i,r,o),this.weatherEarth.centerX=new Float64Array([0]),this.weatherEarth.centerY=new Float64Array([0]),this.weatherEarth.centerZ=new Float64Array([0]);void 0===o&&(o=16e3),this.weatherEarth.makeMeshVirtuallyCRS84(72,36,o),this.weatherEarth.centerX[0]=0,this.weatherEarth.centerX[1]=0,this.weatherEarth.centerX[2]=0,this.weatherEarth.makeVbo(n.vboMemoryManager)},vi.prototype.getVelocityVector2d=function(t,e,i,r){var o=new Uint8Array(4);t<0&&(t=0),e<0&&(e=0);var n=r.getGl();n.readPixels(t,e,1,1,n.RGBA,n.UNSIGNED_BYTE,o);var a=o[0]/255,s=o[1]/255,l=this.windData.uMin,h=this.windData.vMin,d=l*(1-a)+this.windData.uMax*a,c=h*(1-s)+this.windData.vMax*s;return void 0===i&&(i=new dr),i.set(d,c),i},vi.prototype.getTrajectory=function(t,e,i,r){var o=this.geoExtent.getMinLongitudeRad(),n=this.geoExtent.getMinLatitudeRad(),a=this.geoExtent.getMaxLongitudeRad(),s=this.geoExtent.getMaxLatitudeRad(),l=(this.geoExtent.getMinAltitude(),this.geoExtent.getMaxAltitude(),a-o),h=s-n,d=180/Math.PI,c=t.altitude,u=this.windData.uMin,f=this.windData.vMin,g=this.windData.uMax,p=this.windData.vMax,v=(new dr(u,f),new dr(g,p)),y=i.getGl();this.windMapTexture.imageWidth,this.windMapTexture.imageHeight;if(void 0===this.framebuffer&&(this.framebuffer=y.createFramebuffer()),y.bindFramebuffer(y.FRAMEBUFFER,this.framebuffer),y.framebufferTexture2D(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.TEXTURE_2D,this.windMapTexture.texId,0),y.checkFramebufferStatus(y.FRAMEBUFFER)===y.FRAMEBUFFER_COMPLETE){if(!this.geoExtent.intersects2dWithGeoCoord(t))return e;void 0===e&&(e=[]),t.attributes||(t.attributes={}),t.attributes.windSpeed=0,e.push(t);var m=t.getLongitudeRad(),x=t.getLatitudeRad(),b=this.windMapTexture.imageWidth,C=this.windMapTexture.imageHeight,A=2e-7,T=20;r&&(void 0!==r.speedFactor&&(A=r.speedFactor),void 0!==r.numPoints&&(T=r.numPoints));for(var M=0;M<T;M++){var P=Math.floor((m-o)/l*b),w=Math.floor((x-n)/h*C),_=this.getVelocityVector2d(P,w,void 0,i),S=_.getModul()/v.getModul(),L=Math.cos(n+x*h),R=new dr(_.x/L*A,_.y*A);m+=R.x,x+=R.y;var D=new j(m*d,x*d,c);if(D.attributes||(D.attributes={}),D.attributes.windSpeed=S,!this.geoExtent.intersects2dWithGeoCoord(D))return e;e.push(D)}}return y.bindFramebuffer(y.FRAMEBUFFER,null),e},vi.prototype.renderMode3D=function(t){if(this.isReadyToRender()){if(void 0!==this.windDisplayPlane){this.windDisplayPlane;var e=t.sceneState.camera.position,i=this.gl,r=this.drawParticles3DShader,o=r.program;i.useProgram(o),this.drawParticles3DShader.bindUniformGenerals(),i.enableVertexAttribArray(r.a_index);var n=t.sceneState.modelViewProjMatrix;i.uniformMatrix4fv(r.ModelViewProjectionMatrix,!1,n._floatArrays),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,r),this.windDisplayPlane.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,r),i.bindBuffer(i.ARRAY_BUFFER,this.particleIndexBuffer),i.vertexAttribPointer(r.a_index,1,i.FLOAT,!1,0,0),i.uniform1i(r.u_colorScale,!0),i.uniform1i(r.u_wind,0),i.uniform1i(r.u_particles,1),R.bindTexture(i,this.windMapTexture.texId,0);var a=this.windData.uMin,s=this.windData.vMin,l=this.windData.uMax,h=this.windData.vMax;this.weatherStation.windData&&this.weatherStation.windData.uMin&&(a=this.weatherStation.windData.uMin,s=this.weatherStation.windData.vMin,l=this.weatherStation.windData.uMax,h=this.weatherStation.windData.vMax),i.uniform1f(r.u_particles_res,this.particleStateResolution),i.uniform2f(r.u_wind_min,a,s),i.uniform2f(r.u_wind_max,l,h),i.uniform1i(r.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap);var d=this.geoExtent.getMinLongitudeRad(),c=this.geoExtent.getMinLatitudeRad(),u=this.geoExtent.getMaxLongitudeRad(),f=this.geoExtent.getMaxLatitudeRad(),g=this.geoExtent.getMinAltitude(),p=this.geoExtent.getMaxAltitude();i.uniform3fv(r.u_geoCoordRadiansMax,[u,f,p]),i.uniform3fv(r.u_geoCoordRadiansMin,[d,c,g]),i.uniform3fv(r.u_camPosWC,[e.x,e.y,e.z]),i.uniform1f(r.pendentPointSize,1e3),i.uniform1f(r.u_externAlpha,this.externalAlpha),i.enable(i.BLEND);for(var v=this.particlesPositionTexturesArray.length,y=v-1;y>=0;y--){var m=1/v*(y+1);m=0===y?.1:1/v*(y+1),i.uniform1f(r.u_tailAlpha,m),R.bindTexture(i,this.particlesPositionTexturesArray[y],1),i.drawArrays(i.POINTS,0,this.numParticles)}i.disable(i.BLEND)}}else this.prepareWindLayer()},vi.prototype.render=function(t){var e=this.gl;if(this.weatherEarth){var i=t.postFxShadersManager.getShader("testQuad"),r=i.program;e.useProgram(r),e.enableVertexAttribArray(i.texCoord2_loc),e.enableVertexAttribArray(i.position3_loc),i.bindUniformGenerals(),i.resetLastBuffersBinded(),this.flipTexCoordsY_windMap=!0,void 0===this.wwwMat&&(this.wwwMat=new rt,this.wwwMat.rotationAxisAngDeg(90,1,0,0),this.flipTexCoordsY_windMap=!1),t.configInformation.geo_view_library===u.WORLDWIND?e.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,this.wwwMat._floatArrays):e.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e.uniform3fv(i.buildingPosHIGH_loc,[0,0,0]),e.uniform3fv(i.buildingPosLOW_loc,[0,0,0]),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.screenTexture0);var o=this.weatherEarth.vboKeyContainer.vboCacheKeysArray[0];if(!o.bindDataTexCoord(i,t.vboMemoryManager))return;if(!o.bindDataPosition(i,t.vboMemoryManager))return;if(!o.bindDataIndice(i,t.vboMemoryManager))return;e.enable(e.BLEND),e.drawElements(e.TRIANGLES,o.indicesCount,e.UNSIGNED_SHORT,0),e.disable(e.BLEND)}},vi.prototype.renderWindScreen=function(){var t=this.gl;R.bindFramebuffer(t,this.windFramebuffer,this.screenTexture0),t.viewport(0,0,this.screenTexWidth,this.screenTexHeight),this.drawFadeScreen(this.screenTexture1,this.fadeOpacity),this.renderParticles();var e=this.screenTexture1;this.screenTexture1=this.screenTexture0,this.screenTexture0=e},vi.prototype.drawFadeScreen=function(t,e){var i=this.gl,r=this.screenFadeProgram;i.useProgram(r.program),R.bindAttribute(i,this.quadBuffer,r.a_pos,2),R.bindTexture(i,t,2),i.uniform1i(r.u_screen,2),i.uniform1f(r.u_opacity,e),i.drawArrays(i.TRIANGLES,0,6)},vi.prototype.renderParticles=function(){var t=this.gl,e=this.drawParticlesProgram;t.useProgram(e.program),R.bindAttribute(t,this.particleIndexBuffer,e.a_index,1),t.uniform1i(e.u_colorScale,!0),t.uniform1i(e.u_wind,0),t.uniform1i(e.u_particles,1),t.uniform1f(e.u_particles_res,this.particleStateResolution),t.uniform2f(e.u_wind_min,this.windData.uMin,this.windData.vMin),t.uniform2f(e.u_wind_max,this.windData.uMax,this.windData.vMax),t.uniform1i(e.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),t.drawArrays(t.POINTS,0,this.numParticles)},vi.prototype.updateParticlesPositions=function(t){if(void 0===this.counterAux&&(this.counterAux=0),this.counterAux+=1,!(this.counterAux<8)){this.counterAux=0;var e=t.getGl();2;var i=this.particlesPositionTexturesArray[this.particlesPositionTexturesArray.length-1];R.bindTexture(e,i,1);for(var r=0;r<2;r++){var o=.5*(1+r);this.updateParticlesPositionsForInterpolation(t,o)}}},vi.prototype.updateParticlesPositionsForInterpolation=function(t,e){var i=this.gl,r=this.particlesPositionTexturesArray.shift(),o=t.sceneState.camera,n=o.position,a=(o.getCameraElevation(),{}),s=t.myCameraSCX.bigFrustum;a=vt.getFrustumIntersectedTilesNames(s,6,n,t,a);var l=[];for(var h in a)if(Object.prototype.hasOwnProperty.call(a,h)){var d=h.split("\\"),c=(parseInt(d[0]),a[h]),u=(c.minGeographicCoord.longitude+180)/360,f=(c.minGeographicCoord.latitude+90)/180,g=(c.maxGeographicCoord.longitude+180)/360,p=(c.maxGeographicCoord.latitude+90)/180;l.push(u),l.push(f),l.push(g),l.push(p)}if(this.windData){R.bindFramebuffer(i,this.windFramebuffer,r),i.viewport(0,0,this.particleStateResolution,this.particleStateResolution);var v=this.updateParticlesProgram;i.useProgram(v.program),R.bindAttribute(i,this.quadBuffer,v.a_pos,2),i.uniform1i(v.u_wind,0),i.uniform1i(v.u_particles,1);var y=Math.random();i.uniform1f(v.u_rand_seed,y),i.uniform2f(v.u_wind_res,this.windData.width,this.windData.height),i.uniform2f(v.u_wind_min,this.windData.uMin,this.windData.vMin),i.uniform2f(v.u_wind_max,this.windData.uMax,this.windData.vMax),i.uniform1f(v.u_speed_factor,this.speedFactor),i.uniform1f(v.u_interpolation,e),i.uniform1f(v.u_drop_rate,this.dropRate),i.uniform1f(v.u_drop_rate_bump,this.dropRateBump),i.uniform1i(v.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap);var m=this.geoExtent.getMinLongitudeRad(),x=this.geoExtent.getMinLatitudeRad(),b=this.geoExtent.getMaxLongitudeRad(),C=this.geoExtent.getMaxLatitudeRad();i.uniform3fv(v.u_geoCoordRadiansMax,[b,C,16e3]),i.uniform3fv(v.u_geoCoordRadiansMin,[m,x,0]);var A=l.length/4;A>16&&(A=16);var T=new Float32Array(l);i.uniform4fv(v.u_visibleTilesRanges,T),i.uniform1i(v.u_visibleTilesRangesCount,A),i.drawArrays(i.TRIANGLES,0,6),this.particlesPositionTexturesArray.push(r),R.bindFramebuffer(i,null)}},vi.prototype.updateParticlesPositions2dMode=function(){var t=this.gl;R.bindFramebuffer(t,this.windFramebuffer,this.particlesPositionTexture1),t.viewport(0,0,this.particleStateResolution,this.particleStateResolution);var e=this.updateParticlesProgram;t.useProgram(e.program),R.bindAttribute(t,this.quadBuffer,e.a_pos,2),t.uniform1i(e.u_wind,0),t.uniform1i(e.u_particles,1);var i=Math.random();t.uniform1f(e.u_rand_seed,i),t.uniform2f(e.u_wind_res,this.windData.width,this.windData.height),t.uniform2f(e.u_wind_min,this.windData.uMin,this.windData.vMin),t.uniform2f(e.u_wind_max,this.windData.uMax,this.windData.vMax),t.uniform1f(e.u_speed_factor,this.speedFactor),t.uniform1f(e.u_drop_rate,this.dropRate),t.uniform1f(e.u_drop_rate_bump,this.dropRateBump),t.uniform1i(e.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),t.drawArrays(t.TRIANGLES,0,6);var r=this.particlesPositionTexture0;this.particlesPositionTexture0=this.particlesPositionTexture1,this.particlesPositionTexture1=r,R.bindFramebuffer(t,null)};var yi=function(t){if(!(this instanceof yi))throw new Error(ot.CONSTRUCT_ERROR);this.windLayersArray,this.weatherStation,this.extrusionHeight,this.windDisplayBox,this.windDisplayPlane,this.windDisplayPlanesArray=[]};yi.prototype.getWindLayersCount=function(){return void 0===this.windLayersArray?0:this.windLayersArray.length},yi.prototype.getWindLayer=function(t){if(void 0!==this.windLayersArray)return this.windLayersArray[t]},yi.prototype.newWindLayer=function(t){void 0===this.windLayersArray&&(this.windLayersArray=[]);var e=new vi(t);return e.weatherStation=this.weatherStation,e.windVolume=this,this.windLayersArray.push(e),e},yi.prototype.createWindDisplayPlane=function(t){var e=this.windLayersArray[0].geoExtent;if(!e)return!1;var i=e.minGeographicCoord,r=e.maxGeographicCoord,o=i.longitude,n=r.longitude,a=i.latitude,s=r.latitude,l=i.altitude,h=(r.altitude,new k);h.newGeoCoord(o,a,l),h.newGeoCoord(n,a,l),h.newGeoCoord(n,s,l),h.newGeoCoord(o,s,l);for(var d=0;d<1;d++){var c=h.getExtrudedMeshRenderableObject(.1,!0,void 0,t,void 0);c.setOneColor(.8,.7,.2,0),c.setWireframeColor(.2,.3,.4,1),c.attributes.isMovable=!0,c.attributes.movementInAxisZ=!0,c.attributes.minAltitude=this.getMinAltitude(),c.attributes.maxAltitude=this.getMaxAltitude(),c.attributes.name="windDisplayPlane",c.attributes.selectedColor4=new _(1,0,0,0),void 0===c.options&&(c.options={}),c.options.renderWireframe=!0,c.options.renderShaded=!0,c.options.depthMask=!1;t.modeler.addObject(c,10),this.windDisplayPlanesArray.push(c)}return!0},yi.prototype.createWindDisplayBox=function(t){var e=this.windLayersArray[0],i=this.windLayersArray[this.windLayersArray.length-1],r=e.geoExtent;if(!r)return!1;var o=r.minGeographicCoord,n=r.maxGeographicCoord,a=o.longitude,s=n.longitude,l=o.latitude,h=n.latitude,d=o.altitude,c=(n.altitude,new k);c.newGeoCoord(a,l,d),c.newGeoCoord(s,l,d),c.newGeoCoord(s,h,d),c.newGeoCoord(a,h,d);var u=i.windData.height_above_ground-e.windData.height_above_ground;this.windDisplayBox=c.getExtrudedMeshRenderableObject(u,!0,void 0,t,void 0),this.windDisplayBox.setOneColor(.2,.7,.8,.2),this.windDisplayBox.attributes.isMovable=!1,this.windDisplayBox.attributes.isSelectable=!1,this.windDisplayBox.attributes.name="windDisplayBox",this.windDisplayBox.attributes.selectedColor4=new _(1,0,0,0),void 0===this.windDisplayBox.options&&(this.windDisplayBox.options={}),this.windDisplayBox.options.renderWireframe=!0,this.windDisplayBox.options.renderShaded=!0,this.windDisplayBox.options.depthMask=!1;return t.modeler.addObject(this.windDisplayBox,10),!0},yi.prototype.createdElemsForDisplayBox=function(t){void 0===this.windDisplayBox&&this.createWindDisplayBox(t)&&0===this.windDisplayPlanesArray.length&&this.createWindDisplayPlane(t)},yi.prototype.loadWindData3d=function(t,e,i){var r=t.getGl();t.readerWriter.geometryDataPath;this.altitudeAux=0;for(var o=e.length,n=0;n<o;n++){this.altitudeAux+=10;var a,s={name:"JeJu Island",speedFactor:2,dropRate:.003,dropRateBump:.001,numParticles:4096,layerAltitude:this.altitudeAux,windMapFileName:e[n],windMapFolderPath:i};this.getWindLayersCount()>0&&(a=this.getWindLayer(0));var l=this.newWindLayer(s);l.init(r,t),void 0!==a&&(l.particlesPositionTexturesArray=a.particlesPositionTexturesArray)}},yi.prototype.prepareWindVolume=function(t){if(void 0===this.allWindLayersAreReady&&(this.allWindLayersAreReady=!1),!this.allWindLayersAreReady){for(var e=!0,i=this.windLayersArray.length,r=0;r<i;r++){var o=this.windLayersArray[r];o.isReadyToRender()||(o.prepareWindLayer(),e=!1)}this.allWindLayersAreReady=e}return this.allWindLayersAreReady},yi.prototype.getMaxAltitude=function(){for(var t,e=this.windLayersArray.length,i=0;i<e;i++){var r=this.windLayersArray[i];0===i?t=r.windData.height_above_ground:r.windData.height_above_ground>t&&(t=r.windData.height_above_ground)}return t},yi.prototype.getMinAltitude=function(){for(var t,e=this.windLayersArray.length,i=0;i<e;i++){var r=this.windLayersArray[i];0===i?t=r.windData.height_above_ground:r.windData.height_above_ground<t&&(t=r.windData.height_above_ground)}return t},yi.prototype.getNearestWindLayerByAltitude=function(t){for(var e,i=this.windLayersArray.length,r=0;r<i-1;r++){var o=this.windLayersArray[r],n=this.windLayersArray[r+1];if(t>o.windData.height_above_ground&&t<n.windData.height_above_ground){e=o;break}if(0===r&&t<o.windData.height_above_ground){e=o;break}if(r===i-2&&t>n.windData.height_above_ground){e=n;break}}return e||(e=this.windLayersArray[0]),e},yi.prototype.renderMode3DThickLines=function(t){if(void 0===this.thickLinesReady||!1===this.thickLinesReady){var e={speedFactor:2e-7,numPoints:10},i=this.getNearestWindLayerByAltitude(50),r=i.geoExtent.getMinLongitudeRad(),o=i.geoExtent.getMinLatitudeRad(),n=i.geoExtent.getMaxLongitudeRad(),a=i.geoExtent.getMaxLatitudeRad(),s=(i.geoExtent.getMinAltitude(),i.geoExtent.getMaxAltitude(),180/Math.PI),l={};l.startColor=new _(.6,.99,.99,0),l.endColor=new _(.7,.9,.99,1);for(var h=0;h<40;h++){var d=Math.random()*(n-r)+r,c=Math.random()*(a-o)+o,u=new j(d*s,c*s,50),f=i.getTrajectory(u,void 0,t,e),g=k.getRenderableObjectOfGeoCoordsArray(f,t,l);t.modeler.addObject(g,10)}this.thickLinesReady=!0}},yi.prototype.renderWindLayerDisplayPlanes=function(t){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length&&this.prepareWindVolume())if(void 0!==this.windDisplayBox){if(void 0===this.windData){this.windData={};for(var e=this.windLayersArray.length,i=0;i<e;i++){(a=this.windLayersArray[i]).windData&&(0===i?(this.windData.uMin=a.windData.uMin,this.windData.vMin=a.windData.vMin,this.windData.uMax=a.windData.uMax,this.windData.vMax=a.windData.vMax,this.windData.height=a.windData.height,this.windData.width=a.windData.width):(a.windData.uMin<this.windData.uMin&&(this.windData.uMin=a.windData.uMin),a.windData.vMin<this.windData.vMin&&(this.windData.vMin=a.windData.vMin),a.windData.uMax>this.windData.uMax&&(this.windData.uMax=a.windData.uMax),a.windData.vMax>this.windData.vMax&&(this.windData.vMax=a.windData.vMax)))}}for(var r=t.getGl(),o=this.windDisplayPlanesArray.length,n=0;n<o;n++){var a,s=this.windDisplayPlanesArray[n];for(i=(e=this.windLayersArray.length)-1;i>=0;i--){var l=10;if(this.windDisplayBox)l=s.geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude;if(a=this.getNearestWindLayerByAltitude(l)){if(a.windDisplayPlane=s,a.isReadyToRender()){a.renderMode3D(t),r=a.gl;break}a.prepareWindLayer()}}void 0!==a&&void 0!==a.windMapTexture&&a.windMapTexture.fileLoadState===c.fileLoadState.BINDING_FINISHED&&(R.bindTexture(r,a.windMapTexture.texId,0),a.updateParticlesPositions(t))}}else this.createdElemsForDisplayBox(t)};var mi=function(t){if(!(this instanceof mi))throw new Error(ot.CONSTRUCT_ERROR);this.nodeOwner,t&&(this.nodeOwner=t),this.id,this.nodesArray,this.edgesArray,this.spacesArray,this.attributes,this.edgesVboKeysContainer,this.nodesVboKeysContainer,this.renderSpaces=!0,this.spacesAlpha=.2};mi.prototype.newNode=function(){void 0===this.nodesArray&&(this.nodesArray=[]);var t=new bi(this);return this.nodesArray.push(t),t},mi.prototype.newEdge=function(){void 0===this.edgesArray&&(this.edgesArray=[]);var t=new xi(this);return this.edgesArray.push(t),t},mi.prototype.newSpace=function(){void 0===this.spacesArray&&(this.spacesArray=[]);var t=new Ci(this);return this.spacesArray.push(t),t},mi.prototype.test__makeVbos=function(t){var e=0;this.edgesArray&&(e=this.edgesArray.length);for(var i=[],r=0;r<e;r++){var o=this.edgesArray[r].vtxSegment,n=o.startVertex.point3d,a=o.endVertex.point3d;i.push(n.x),i.push(n.y),i.push(n.z),i.push(a.x),i.push(a.y),i.push(a.z)}void 0===this.edgesVboKeysContainer&&(this.edgesVboKeysContainer=new Nt);var s=this.edgesVboKeysContainer.newVBOVertexIdxCacheKey(),l=3*(2*e),h=t.vboMemoryManager.getClassifiedBufferSize(l);s.posVboDataArray=new Float32Array(h),s.posVboDataArray.set(i),s.posArrayByteSize=i.length,s.segmentsCount=e},mi.prototype.parseTopologyData=function(t,e){var i=new y;i.minX=e.min_X,i.minY=e.min_Y,i.minZ=e.min_Z,i.maxX=e.max_X,i.maxY=e.max_Y,i.maxZ=e.max_Z;var r=new ur;r.set(-115.0978055,31.885502,-28.5);for(var o={},n=e.nodes.length,a=0;a<n;a++){var s=e.nodes[a],l=this.newNode();l.id="#"+s.id,l.position=new ur(s.coordinates[0],s.coordinates[1],s.coordinates[2]),l.position.addPoint(r),l.position.add(0,0,.1),l.box=new Ee(.6,.6,.6),o[l.id]=l}var h={},d=e.cellSpaceMembers.length;for(a=0;a<d;a++){var c=e.cellSpaceMembers[a],u=(c.href,this.newSpace()),f=new rr;u.mesh=f;for(var g=f.getVertexList(),p=c.surfaceMember.length,v=0;v<p;v++){for(var m=f.newSurface().newFace(),x=c.surfaceMember[v].coordinates,b=x.length/3,C=0;C<b;C++){var A=x[3*C],T=x[3*C+1],M=x[3*C+2],P=g.newVertex();P.setPosition(A,T,M),P.point3d.addPoint(r),m.addVertex(P)}m.solveUroborus(),m.calculateVerticesNormals()}h[c.href]=c}var w=e.edges.length;for(a=0;a<w;a++){var _=e.edges[a],S=this.newEdge(),L=_.stateMembers[0].coordinates,R=_.stateMembers[1].coordinates,D=new jr,E=new jr;D.setPosition(L[0],L[1],L[2]),E.setPosition(R[0],R[1],R[2]),D.point3d.addPoint(r),D.point3d.add(0,0,.1),E.point3d.addPoint(r),E.point3d.add(0,0,.1);var I=new Yr(D,E);S.vtxSegment=I;var O=_.connects[0],F=_.connects[1];S.strNodeId=O,S.endNodeId=F}this.test__makeVbos(t)},mi.prototype.renderColorCoding=function(t,e,i){var r=t.selectionColor,o=(n=t.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===o&&(o=n.newCandidatesFamily("networkNodes"));var n,a=(n=t.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===a&&(a=n.newCandidatesFamily("networkEdges"));var s=t.vboMemoryManager,l=t.sceneState.gl;e.disableVertexAttribArray(e.texCoord2_loc),e.enableVertexAttribArray(e.normal3_loc),l.uniform1i(e.hasTexture_loc,!1),l.uniform4fv(e.oneColor4_loc,[.8,.8,.8,1]),e.last_isAditionalMovedZero||(l.uniform1i(e.hasAditionalMov_loc,!1),l.uniform3fv(e.aditionalMov_loc,[0,0,0]),e.last_isAditionalMovedZero=!0);var h,d=0;if(this.nodesArray&&(d=this.nodesArray.length),d>0){var c=1;l.uniform1i(e.refMatrixType_loc,c);for(var u=this.nodesArray[0],f=0;f<d;f++){var g=this.nodesArray[f];l.uniform3fv(e.refTranslationVec_loc,[g.position.x,g.position.y,g.position.z]);var p=r.getAvailableColor(void 0),v=r.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(v,"networkNodes",g),l.uniform4fv(e.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),u.box.render(t,e,i)}}if(this.edgesVboKeysContainer&&(h=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(l,s)){e.disableVertexAttribArray(e.texCoord2_loc),e.disableVertexAttribArray(e.normal3_loc),c=0,l.uniform1i(e.refMatrixType_loc,c),h.meshVertexCacheKey!==e.lastVboKeyBindedMap[e.position3_loc]&&(l.bindBuffer(l.ARRAY_BUFFER,h.meshVertexCacheKey),l.vertexAttribPointer(e.position3_loc,3,l.FLOAT,!1,0,0),e.lastVboKeyBindedMap[e.position3_loc]=h.meshVertexCacheKey);var y=this.edgesArray.length;for(f=0;f<y;f++){var m=this.edgesArray[f];p=r.getAvailableColor(void 0),v=r.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(v,"networkEdges",m),l.uniform4fv(e.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),l.drawArrays(l.LINES,2*f,2)}}},mi.prototype.render=function(t,e,i){if(2!==i){t.selectionColor.init();var r=(o=t.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===r&&(r=o.newCandidatesFamily("networkNodes"));var o,n=(o=t.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===n&&(n=o.newCandidatesFamily("networkEdges"));var a=t.vboMemoryManager,s=t.sceneState.gl;e.disableVertexAttribArray(e.texCoord2_loc),e.enableVertexAttribArray(e.normal3_loc),s.uniform1i(e.colorType_loc,0),s.uniform4fv(e.oneColor4_loc,[.8,.8,.8,1]),e.last_isAditionalMovedZero||(s.uniform1i(e.hasAditionalMov_loc,!1),s.uniform3fv(e.aditionalMov_loc,[0,0,0]),e.last_isAditionalMovedZero=!0);var l,h=0;if(this.nodesArray&&(h=this.nodesArray.length),h>0){s.uniform1i(e.colorType_loc,0);var d=1;s.uniform1i(e.refMatrixType_loc,d),s.uniform4fv(e.oneColor4_loc,[.3,.3,.9,1]);for(var c=this.nodesArray[0],u=0;u<h;u++){var f=this.nodesArray[u];f===r.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.9,.5,.1,1]),s.uniform3fv(e.refTranslationVec_loc,[f.position.x,f.position.y,f.position.z]),c.box.render(t,e,i),f===r.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.3,.3,.9,1])}}if(this.edgesVboKeysContainer)if((l=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(s,a)){e.disableVertexAttribArray(e.texCoord2_loc),e.disableVertexAttribArray(e.normal3_loc),s.uniform1i(e.colorType_loc,0),d=0,s.uniform1i(e.refMatrixType_loc,d),s.uniform4fv(e.oneColor4_loc,[.1,.1,.6,1]),l.meshVertexCacheKey!==e.lastVboKeyBindedMap[e.position3_loc]&&(s.bindBuffer(s.ARRAY_BUFFER,l.meshVertexCacheKey),s.vertexAttribPointer(e.position3_loc,3,s.FLOAT,!1,0,0),e.lastVboKeyBindedMap[e.position3_loc]=l.meshVertexCacheKey);var g=this.edgesArray.length;for(u=0;u<g;u++){var p=this.edgesArray[u];p===n.currentSelected&&s.uniform4fv(e.oneColor4_loc,[0,1,0,1]),s.drawArrays(s.LINES,2*u,2),p===n.currentSelected&&s.uniform4fv(e.oneColor4_loc,[.1,.1,.6,1])}}if(this.renderSpaces=t.tempSettings.renderSpaces,this.spacesAlpha=t.tempSettings.spacesAlpha,1===i&&e.enableVertexAttribArray(e.normal3_loc),this.renderSpaces){s.uniform1i(e.colorType_loc,0),d=0,s.uniform1i(e.refMatrixType_loc,d),s.uniform4fv(e.oneColor4_loc,[.8,.8,.8,this.spacesAlpha]),s.enable(s.BLEND);var v=0;this.spacesArray&&(v=this.spacesArray.length);for(u=0;u<v;u++){this.spacesArray[u].mesh.render(t,e)}s.disable(s.BLEND)}}else this.renderColorCoding(t,e,i)};var xi=function(t){if(!(this instanceof xi))throw new Error(ot.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.strNode,this.endNode,this.sense,this.attributes,this.strNodeId,this.endNodeId},bi=function(t){if(!(this instanceof bi))throw new Error(ot.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.edgesArray,this.attributes,this.box},Ci=function(t){if(!(this instanceof Ci))throw new Error(ot.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.mesh,this.attributes};function Ai(){return function(){throw new Error("Unimplemented abstract method.")}()}var Ti=function(){if(!(this instanceof Ti))throw new Error(ot.CONSTRUCT_ERROR);this.ByteR=0,this.ByteG=0,this.ByteB=0,this.ByteAlfa=255};Ti.prototype.destroy=function(){this.ByteR=null,this.ByteG=null,this.ByteB=null,this.ByteAlfa=null},Ti.prototype.set=function(t,e,i){this.ByteR=t,this.ByteG=e,this.ByteB=i};var Mi=function(){if(!(this instanceof Mi))throw new Error(ot.CONSTRUCT_ERROR);this.startGeoCoord,this.targetGeoCoord,this.travelDurationInSeconds,this.acceleration,this.velocity};function Pi(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function wi(t,e){return void 0!==t&&null!==t?t:e}function _i(t,e){return void 0!==t&&null!==t&&t.toString().trim().length>0?t:e}function Si(t){return void 0!==t&&null!==t}var Li=function(){if(!(this instanceof Li))throw new Error(ot.CONSTRUCT_ERROR)};function Ri(t){return""===t||null===t||void 0===t||null!==t&&"object"==typeof t&&!Object.keys(t).length}function Di(t,e,i,r,o){if(!Si(t))throw new Error("url required");return new Promise(function(n,a){void 0===e&&(e=new XMLHttpRequest),o=o||"GET",e.open(o,t,!0),e.responseType=r||"arraybuffer",void 0!==i&&(e.timeout=i),e.onload=function(){e.status<200||e.status>=300?a(e.status):n(e.response)},e.ontimeout=function(t){a(-1)},e.onerror=function(t){console.log("Invalid XMLHttpRequest response type."),a(e.status)},e.send(null)})}Li.projectPoint3DInToBestPlaneToProject=function(t,e,i){return void 0===i&&(i=new dr),0===e?i.set(t.x,t.y):1===e?i.set(t.y,t.z):2===e&&i.set(t.x,t.z),i},Li.projectTriangle3DInToBestPlaneToProject=function(t,e,i){void 0===i&&(i=new Fr);var r=t.vertex0.getPosition(),o=Li.projectPoint3DInToBestPlaneToProject(r,e,void 0),n=t.vertex1.getPosition(),a=Li.projectPoint3DInToBestPlaneToProject(n,e,void 0),s=t.vertex2.getPosition(),l=Li.projectPoint3DInToBestPlaneToProject(s,e,void 0);return i.setPoints(o,a,l),i},Li.getNextIdx=function(t,e){return t===e-1?0:t+1},Li.getPrevIdx=function(t,e){return 0===t?e-1:t-1},Li.getIndicesTrianglesRegularNet=function(t,e,i,r,o,n,a,s){var l,h,d;void 0===i&&(i=new Uint16Array(3*((t-1)*(e-1)*2)));var c=0,u={},f=!1,g=!0;void 0!==s&&(void 0!==s.bLoopColumns&&(f=s.bLoopColumns),void 0!==s.bTrianglesSenseCCW&&(g=s.bTrianglesSenseCCW));for(var p=0;p<e-1;p++)for(var v=0;v<t-1;v++)l=kr.getIndexOfArray(t,e,v,p),h=kr.getIndexOfArray(t,e,v+1,p),d=kr.getIndexOfArray(t,e,v,p+1),g?(i[c]=l,i[++c]=h,i[++c]=d,c++):(i[c]=l,i[++c]=d,i[++c]=h,c++),l=kr.getIndexOfArray(t,e,v+1,p),h=kr.getIndexOfArray(t,e,v+1,p+1),d=kr.getIndexOfArray(t,e,v,p+1),g?(i[c]=l,i[++c]=h,i[++c]=d,c++):(i[c]=l,i[++c]=d,i[++c]=h,c++);u.indicesArray=i;var y=!1;if(s&&void 0!==s.bCalculateBorderIndices&&!0===s.bCalculateBorderIndices&&(y=!0),y){r||(r=new Uint16Array(t));for(v=0;v<t;v++){var m=kr.getIndexOfArray(t,e,v,0);r[v]=m}u.southIndicesArray=r,o||(o=new Uint16Array(e));for(p=0;p<e;p++){m=kr.getIndexOfArray(t,e,t-1,p);o[p]=m}u.eastIndicesArray=o,n||(n=new Uint16Array(t));var x=0;for(v=t-1;v>=0;v--){m=kr.getIndexOfArray(t,e,v,e-1);n[x]=m,x++}u.northIndicesArray=n,a||(a=new Uint16Array(e)),x=0;for(p=e-1;p>=0;p--){m=kr.getIndexOfArray(t,e,0,p);a[x]=m,x++}u.westIndicesArray=a}if(f){var b=t;for(p=0;p<e-1;p++)l=kr.getIndexOfArray(t,e,b,p),h=kr.getIndexOfArray(t,e,0,p),d=kr.getIndexOfArray(t,e,b,p+1),g?(i[c]=l,i[++c]=h,i[++c]=d,c++):(i[c]=l,i[++c]=d,i[++c]=h,c++),l=kr.getIndexOfArray(t,e,0,p),h=kr.getIndexOfArray(t,e,0,p+1),d=kr.getIndexOfArray(t,e,b,p+1),g?(i[c]=l,i[++c]=h,i[++c]=d,c++):(i[c]=l,i[++c]=d,i[++c]=h,c++)}return u};var Ei=function(){};Ei.getIndexToInsertBySquaredDistToEye=function(t,e,i,r){void 0===i&&(i=0),void 0===r&&(r=t.length-1);var o=r-i;if(o<=0)return 0;if(o<6){var n,a=!1,s=i;for(t.length;!a&&s<=r;)e.distToCamera<t[s].distToCamera&&(n=s,a=!0),s++;return a?n:r+1}var l,h,d=i+Math.floor(o/2);return t[d].distToCamera>e.distToCamera?(l=i,h=d):(l=d,h=r),Ei.getIndexToInsertBySquaredDistToEye(t,e,l,h)},Ei.pointToGeographicCoord=function(t,e){if(!t)throw new Error("point is requred");void 0===e&&(e=new j);var i=W.CartesianToGeographicWgs84(t.x,t.y,t.z,i);return e.setLonLatAlt(i.longitude,i.latitude,i.altitude),e},Ei.geographicCoordToWorldPoint=function(t,e,i,r){void 0===r&&(r=new ur);var o=W.geographicToCartesianWgs84(t,e,i,void 0);return r.set(o[0],o[1],o[2]),r},Ei.translatePivotPointGeoLocationData=function(t,e){if(void 0!==t){var i=new ur;i.set(-e.x,-e.y,-e.z),t.pivotPointTraslationLC=i,t.doEffectivePivotPointTranslation()}},Ei.calculateGeoLocationMatrixAtWorldPosition=function(t,e){return void 0===e&&(e=new rt),W.transformMatrixAtCartesianPointWgs84(t.x,t.y,t.z,e._floatArrays),e},Ei.calculateGeoLocationMatrixAtLonLatAlt=function(t,e,i,r){void 0===r&&(r=new rt);var o=this.geographicCoordToWorldPoint(t,e,i,o);return r=Ei.calculateGeoLocationMatrixAtWorldPosition(o,r)},Ei.calculateTransformMatrixAtWorldPosition=function(t,e,i,r,o,n){var a,s,l,h=new rt,d=new rt,c=new rt;return void 0!==e&&0!==e&&c.rotationAxisAngDeg(e,0,0,1),void 0!==i&&0!==i&&h.rotationAxisAngDeg(i,1,0,0),void 0!==r&&0!==r&&d.rotationAxisAngDeg(r,0,1,0),void 0===o&&(o=new rt),void 0===n&&(n=new rt),o=Ei.calculateGeoLocationMatrixAtWorldPosition(t,o),n.copyFromMatrix4(o),a=c.getMultipliedByMatrix(n,a),s=h.getMultipliedByMatrix(a,s),n=l=d.getMultipliedByMatrix(s,l)},Ei.calculateGeoLocationData=function(t,e,i,r,o,n,a){if(void 0===a&&(a=new z),void 0===a.geographicCoord&&(a.geographicCoord=new j),void 0!==t?a.geographicCoord.longitude=t:t=a.geographicCoord.longitude,void 0!==e?a.geographicCoord.latitude=e:e=a.geographicCoord.latitude,void 0!==i?a.geographicCoord.altitude=i:i=a.geographicCoord.altitude,void 0!==r&&(a.heading=r),void 0!==o&&(a.pitch=o),void 0!==n&&(a.roll=n),void 0!==a.geographicCoord.longitude&&void 0!==a.geographicCoord.latitude)return a.position=Ei.geographicCoordToWorldPoint(t,e,i,a.position),void 0===a.positionHIGH&&(a.positionHIGH=new Float32Array([0,0,0])),void 0===a.positionLOW&&(a.positionLOW=new Float32Array([0,0,0])),Ei.calculateSplited3fv([a.position.x,a.position.y,a.position.z],a.positionHIGH,a.positionLOW),void 0===a.tMatrix?a.tMatrix=new rt:a.tMatrix.Identity(),void 0===a.geoLocMatrix?a.geoLocMatrix=new rt:a.geoLocMatrix.Identity(),void 0===a.rotMatrix?a.rotMatrix=new rt:a.rotMatrix.Identity(),a.tMatrixInv=void 0,a.rotMatrixInv=void 0,a.geoLocMatrixInv=void 0,a.tMatrix=Ei.calculateTransformMatrixAtWorldPosition(a.position,a.heading,a.pitch,a.roll,a.geoLocMatrix,a.tMatrix),a.rotMatrix.copyFromMatrix4(a.tMatrix),a.rotMatrix._floatArrays[12]=0,a.rotMatrix._floatArrays[13]=0,a.rotMatrix._floatArrays[14]=0,void 0===a.pivotPoint&&(a.pivotPoint=new ur),a.pivotPoint.set(a.position.x,a.position.y,a.position.z),a.doEffectivePivotPointTranslation(),a},Ei.calculateGeoLocationDataByAbsolutePoint=function(t,e,i,r,o){if(void 0===r&&(r=new z),void 0===r.geographicCoord&&(r.geographicCoord=new j),void 0!==o.configInformation)return void 0===r.position&&(r.position=new ur),r.position.x=t,r.position.y=e,r.position.z=i,r.geographicCoord=Ei.pointToGeographicCoord(new ur(t,e,i)),void 0===r.positionHIGH&&(r.positionHIGH=new Float32Array([0,0,0])),void 0===r.positionLOW&&(r.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([r.position.x,r.position.y,r.position.z],r.positionHIGH,r.positionLOW),void 0===r.tMatrix?r.tMatrix=new rt:r.tMatrix.Identity(),void 0===r.geoLocMatrix?r.geoLocMatrix=new rt:r.geoLocMatrix.Identity(),void 0===r.rotMatrix?r.rotMatrix=new rt:r.rotMatrix.Identity(),r.tMatrixInv=void 0,r.rotMatrixInv=void 0,r.geoLocMatrixInv=void 0,r.tMatrix=Ei.calculateTransformMatrixAtWorldPosition(r.position,r.heading,r.pitch,r.roll,r.geoLocMatrix,r.tMatrix),r.rotMatrix.copyFromMatrix4(r.tMatrix),r.rotMatrix._floatArrays[12]=0,r.rotMatrix._floatArrays[13]=0,r.rotMatrix._floatArrays[14]=0,void 0===r.pivotPoint&&(r.pivotPoint=new ur),r.pivotPoint.set(r.position.x,r.position.y,r.position.z),r.doEffectivePivotPointTranslation(),r},Ei.calculateGeoLocationDataByAbsolutePoint__original=function(t,e,i,r,o){if(void 0===r&&(r=new z),void 0===r.geographicCoord&&(r.geographicCoord=new j),void 0!==o.configInformation){if(void 0===r.position&&(r.position=new ur),r.position.x=t,r.position.y=e,r.position.z=i,o.isCesiumGlobe()){var n=new Cesium.Cartographic,a=new Cesium.Cartesian3;a.x=t,a.y=e,a.z=i,n=Cesium.Cartographic.fromCartesian(a,o.scene._globe._ellipsoid,n),r.geographicCoord.longitude=180*n.longitude/Math.PI,r.geographicCoord.latitude=180*n.latitude/Math.PI,r.geographicCoord.altitude=n.height}void 0===r.positionHIGH&&(r.positionHIGH=new Float32Array([0,0,0])),void 0===r.positionLOW&&(r.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([r.position.x,r.position.y,r.position.z],r.positionHIGH,r.positionLOW),void 0===r.tMatrix?r.tMatrix=new rt:r.tMatrix.Identity(),void 0===r.geoLocMatrix?r.geoLocMatrix=new rt:r.geoLocMatrix.Identity(),void 0===r.geoLocMatrixInv?r.geoLocMatrixInv=new rt:r.geoLocMatrixInv.Identity(),void 0===r.tMatrixInv?r.tMatrixInv=new rt:r.tMatrixInv.Identity(),void 0===r.rotMatrix?r.rotMatrix=new rt:r.rotMatrix.Identity(),void 0===r.rotMatrixInv?r.rotMatrixInv=new rt:r.rotMatrixInv.Identity();var s=new rt,l=new rt,h=new rt;if(void 0!==r.heading&&0!==r.heading&&h.rotationAxisAngDeg(r.heading,0,0,-1),void 0!==r.pitch&&0!==r.pitch&&s.rotationAxisAngDeg(r.pitch,-1,0,0),void 0!==r.roll&&0!==r.roll&&l.rotationAxisAngDeg(r.roll,0,-1,0),o.isCesiumGlobe()){Cesium.Transforms.eastNorthUpToFixedFrame(r.position,void 0,r.tMatrix._floatArrays),r.geoLocMatrix.copyFromMatrix4(r.tMatrix);var d=h.getMultipliedByMatrix(r.tMatrix,d),c=s.getMultipliedByMatrix(d,c),u=l.getMultipliedByMatrix(c,u);r.tMatrix=u,r.rotMatrix.copyFromMatrix4(r.tMatrix),r.rotMatrix._floatArrays[12]=0,r.rotMatrix._floatArrays[13]=0,r.rotMatrix._floatArrays[14]=0,Cesium.Matrix4.inverse(r.tMatrix._floatArrays,r.tMatrixInv._floatArrays),Cesium.Matrix4.inverse(r.rotMatrix._floatArrays,r.rotMatrixInv._floatArrays),Cesium.Matrix4.inverse(r.geoLocMatrix._floatArrays,r.geoLocMatrixInv._floatArrays)}return void 0===r.pivotPoint&&(r.pivotPoint=new ur),r.pivotPoint.set(r.position.x,r.position.y,r.position.z),r}},Ei.calculateSplitedValues=function(t,e){var i;return void 0===e&&(e=new xt),t>=0?(i=65536*Math.floor(t/65536),e.high=i,e.low=t-i):(i=65536*Math.floor(-t/65536),e.high=-i,e.low=t+i),e},Ei.calculateSplited3fv=function(t,e,i){if(void 0!==t){void 0===e&&(e=new Float32Array(3)),void 0===i&&(i=new Float32Array(3));var r=new xt;r=this.calculateSplitedValues(t[0],r);var o=new xt;o=this.calculateSplitedValues(t[1],o);var n=new xt;n=this.calculateSplitedValues(t[2],n),e[0]=r.high,e[1]=o.high,e[2]=n.high,i[0]=r.low,i[1]=o.low,i[2]=n.low}},Ei.calculatePixelLinearDepth=function(t,e,i,r,o){if(void 0===r&&(r=o.depthFboNeo),r){r&&r.bind();var n=new Uint8Array(4);return t.readPixels(e,o.sceneState.drawingBufferHeight-i,1,1,t.RGBA,t.UNSIGNED_BYTE,n),(n[0]/16777216+n[1]/65536+n[2]/256+n[3])/256}},Ei.calculatePixelLinearDepthABGR=function(t,e,i,r,o){if(void 0===r&&(r=o.depthFboNeo),r){r&&r.bind();var n=new Uint8Array(4);return t.readPixels(e,o.sceneState.drawingBufferHeight-i,1,1,t.RGBA,t.UNSIGNED_BYTE,n),(n[3]/16581375+n[2]/65025+n[1]/255+n[0])/255}},Ei.calculatePixelPositionCamCoord=function(t,e,i,r,o,n,a,s){void 0===a&&(a=s.sceneState.camera.frustum.far),void 0===n&&(n=0);var l=Ei.calculatePixelLinearDepth(t,e,i,o,s);if(l){var h=l*a;return s.resultRaySC=Ei.getRayCamSpace(e,i,s.resultRaySC,s),void 0===r&&(r=new ur),r.set(s.resultRaySC[0]*h,s.resultRaySC[1]*h,s.resultRaySC[2]*h),t.bindFramebuffer(t.FRAMEBUFFER,null),r}},Ei.cameraCoordPositionToWorldCoord=function(t,e,i){var r=i.sceneState.getModelViewMatrixInv();if(void 0===e)e=new ur;return e=r.transformPoint3D(t,e)},Ei.screenCoordToWorldCoord=function(t,e,i,r,o,n,a,s){if(s.isCesiumGlobe()){var l=s.scene,h=l.globe,d=l.camera,c=new Cesium.Cartesian2(e,i),u=d.getPickRay(c);return h.pick(u,l)}var f=tr.screenToCamCoord(e,i,s);return Ei.cameraCoordPositionToWorldCoord(f,void 0,s)},Ei.calculatePixelPositionWorldCoord=function(t,e,i,r,o,n,a,s){var l=new ur;if(void 0===a&&(a=s.sceneState.camera.frustum.far),void 0===n&&(n=0),void 0===o&&(o=s.depthFboNeo),l=Ei.calculatePixelPositionCamCoord(t,e,i,l,o,n,a,s),void 0===r)r=new ur;return r=Ei.cameraCoordPositionToWorldCoord(l,r,s)},Ei.calculateWorldPositionToScreenCoord=function(t,e,i,r,o,n){void 0===o&&(o=new ur),void 0===n.pointSC&&(n.pointSC=new ur),void 0===n.pointSC2&&(n.pointSC2=new ur),n.pointSC.set(e,i,r);var a=n.pointSC2,s=n.sceneState,l=(a=s.modelViewMatrix.transformPoint3D(n.pointSC,a)).z;if(l>0)return o.set(-1,-1,0),o;var h=s.camera.frustum.tangentOfHalfFovy*l*2,d=h*s.camera.frustum.aspectRatio,c=-a.x*s.drawingBufferWidth/d,u=-a.y*s.drawingBufferHeight/h;return c+=s.drawingBufferWidth/2,u+=s.drawingBufferHeight/2,u=s.drawingBufferHeight-u,o.set(c,u,0),o},Ei.getRayCamSpace=function(t,e,i,r){var o=r.sceneState,n=o.camera.frustum,a=n.aspectRatio,s=2*n.tangentOfHalfFovy*1,l=s*a,h=t,d=o.drawingBufferHeight-e;return void 0===i&&(i=new Float32Array(3)),i[0]=l*(h/o.drawingBufferWidth-.5),i[1]=s*(d/o.drawingBufferHeight-.5),i[2]=-1,i},Ei.getRayWorldSpace=function(t,e,i,r,o){void 0===r&&(r=new Yi);var n=o.sceneState.camera.position,a=new Float32Array(3);a=Ei.getRayCamSpace(e,i,a,o),void 0===o.pointSC&&(o.pointSC=new ur);var s=o.pointSC,l=o.pointSC2;return s.set(a[0],a[1],a[2]),(l=o.sceneState.getModelViewMatrixInv().rotatePoint3D(s,l)).unitary(),r.setPointAndDir(n.x,n.y,n.z,l.x,l.y,l.z),r},Ei.getHeadingToNorthByTwoGeographicCoords=function(t,e,i){var r=Mago3D.ManagerUtils.calculateGeoLocationData(t.longitude,t.latitude,0,0,0,0,r,i),o=Mago3D.ManagerUtils.geographicCoordToWorldPoint(e.longitude,e.latitude,0,o,i),n=r.worldCoordToLocalCoord(o,n),a=new dr(n.x,n.y);a.unitary();var s=new dr(0,1).angleDegToVector(a);return a.x>0&&(s*=-1),s},Ei.getComplexCoordinateByScreenCoord=function(t,e,i,r,o,n,a){var s=Ei.screenCoordToWorldCoord(a.getGl(),e,i,s,void 0,void 0,void 0,a);if(!s)return null;var l=Ei.pointToGeographicCoord(s,l);return{screenCoordinate:new dr(e,i),worldCoordinate:s,geographicCoordinate:l}},Ei.geographicToWkt=function(t,e){var i="";switch(e){case"POINT":i="POINT (",i+=t.longitude,i+=" ",i+=t.latitude,i+=")";break;case"LINE":i="LINESTRING (";for(var r=0,o=t.length;r<o;r++)r>0&&(i+=","),i+=t[r].longitude,i+=" ",i+=t[r].latitude;i+=")";break;case"POLYGON":i="POLYGON ((";for(r=0,o=t.length;r<o;r++)r>0&&(i+=","),i+=t[r].longitude,i+=" ",i+=t[r].latitude;i+=",",i+=t[0].longitude,i+=" ",i+=t[0].latitude,i+="))"}return i};var Ii=function(){if(!(this instanceof Ii))throw new Error(ot.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.startAngleDeg,this.sweepAngleDeg,this.numPointsFor360Deg,this.startPoint,this.endPoint,this.sweepSense};Ii.prototype.deleteObjects=function(){void 0!==this.centerPoint&&this.centerPoint.deleteObjects(),this.centerPoint=void 0,this.radius=void 0,this.startAngleDeg=void 0,this.sweepAngleDeg=void 0,this.numPointsFor360Deg=void 0,void 0!==this.startPoint&&this.startPoint.deleteObjects(),this.startPoint=void 0,void 0!==this.endPoint&&this.endPoint.deleteObjects(),this.endPoint=void 0,this.sweepSense=void 0},Ii.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new dr),this.centerPoint.set(t,e)},Ii.prototype.setRadius=function(t){this.radius=t},Ii.prototype.setStartAngleDegree=function(t){this.startAngleDeg=t},Ii.prototype.setStartPoint=function(t,e){void 0===this.startPoint&&(this.startPoint=new dr),this.startPoint.set(t,e)},Ii.prototype.setEndPoint=function(t,e){void 0===this.endPoint&&(this.endPoint=new dr),this.endPoint.set(t,e)},Ii.prototype.setSense=function(t){this.sweepSense=t},Ii.prototype.setSweepAngleDegree=function(t){this.sweepAngleDeg=t},Ii.prototype.getPoints=function(t,e){if(void 0===this.centerPoint)return t;var i,r;if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.startAngleDeg){if(void 0===this.startPoint)return t;(i=new dr).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),r=i.getModul();var o=Math.acos(n/r);this.startPoint.y<0&&(o*=-1),this.startAngleDeg=180*o/Math.PI}if(void 0===this.radius){if(void 0===this.startPoint)return t;void 0===r&&(void 0===i&&(i=new dr).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),r=i.getModul()),this.radius=r}if(void 0===this.sweepAngleDeg){if(void 0===this.endPoint||void 0===this.sweepSense)return t;(new dr).set(this.endPoint.x-this.centerPoint.x,this.endPoint.y-this.endPoint.y);endPoint.getModul(),o=Math.acos(n/r);this.endPoint.y<0&&(o*=-1),this.sweepAngleDeg=180*o/Math.PI,this.sweepSense<0&&(this.sweepAngleDeg=360-this.sweepAngleDeg)}void 0===t&&(t=[]);var n,a,s,l=[],h=2*Math.PI/this.numPointsFor360Deg,d=this.centerPoint.x,c=this.centerPoint.y,u=Math.PI/180*this.startAngleDeg,f=Math.PI/180*this.sweepAngleDeg,g=Math.ceil(f/h),p=0;if(f>=0)for(var v=0;v<=g;v++)p>f&&(p=f),n=d+this.radius*Math.cos(p+u),a=c+this.radius*Math.sin(p+u),s=new dr(n,a),l.push(s),p+=h;else for(v=0;v<=g;v++)p<f&&(p=f),n=d+this.radius*Math.cos(p+u),a=c+this.radius*Math.sin(p+u),s=new dr(n,a),l.push(s),p-=h;var y=l.length;y>0&&(l[0].pointType=1,l[y-1].pointType=1);var m=t.length;for(v=0;v<y;v++)if(0===v)if(m>0){var x=t[m-1];s=l[v],x.isCoincidentToPoint(s,1e-4)||t.push(s)}else t.push(l[v]);else t.push(l[v]);if((m=t.length)>0){var b=t[m-1],C=t[0];b.isCoincidentToPoint(C,1e-4)&&(t.pop(),b.deleteObjects())}return t};var Oi=function(t){if(!(this instanceof Oi))throw new Error(ot.CONSTRUCT_ERROR);this.length=void 0===t?60:t,this.vbo_vicks_container=new Nt};Oi.prototype.setDimension=function(t){this.length=t},Oi.prototype.makeMesh=function(t){void 0!==t&&(this.length=t);var e=new nr;e.profile=new xr;var i,r=e.profile,o=r.newOuterRing(),n=this.length,a=.1*this.length,s=o.newElement("POLYLINE");s.newPoint2d(0,0);s.newPoint2d(.25*a,.25*n),s.newPoint2d(.25*a,.75*n),s.newPoint2d(.5*a,.75*n),s.newPoint2d(0,n),i=new wr;var l=new dr(0,-10),h=new dr(0,10);i.setPoints(l,h),e.revolve(r,360,8,i);var d=e.getSurfaceIndependentMesh(void 0,!1,!1);d.setColor(.1,1,.1,1),d.reverseSense();var c=new rt,u=d.getCopy(void 0);c.rotationAxisAngDeg(-90,0,0,1),u.transformByMatrix4(c),u.setColor(1,.1,.1,1);var f=d.getCopy(void 0);return c.rotationAxisAngDeg(90,1,0,0),f.transformByMatrix4(c),f.setColor(.1,.1,1,1),d.mergeMesh(u),d.mergeMesh(f),d},Oi.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container};var Fi=function(t,e){if(!(this instanceof Fi))throw new Error(ot.CONSTRUCT_ERROR);this.minX=Number.MAX_VALUE,this.maxX=Number.MIN_VALUE,this.minY=Number.MAX_VALUE,this.maxY=Number.MIN_VALUE};Fi.prototype.setInit=function(t){void 0!==t&&(this.minX=t.x,this.minY=t.y,this.maxX=t.x,this.maxY=t.y)},Fi.prototype.setInitByRectangle=function(t){void 0!==t&&(this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY)},Fi.prototype.addPoint=function(t){void 0!==t&&(t.x<this.minX?this.minX=t.x:t.x>this.maxX&&(this.maxX=t.x),t.y<this.minY?this.minY=t.y:t.y>this.maxY&&(this.maxY=t.y))},Fi.prototype.addRectangle=function(t){void 0!==t&&(t.minX<this.minX&&(this.minX=t.minX),t.maxX>this.maxX&&(this.maxX=t.maxX),t.minY<this.minY&&(this.minY=t.minY),t.maxY>this.maxY&&(this.maxY=t.maxY))},Fi.prototype.intersectsWithRectangle=function(t){return void 0!==t&&(!(t.minX>this.maxX)&&(!(t.maxX<this.minX)&&(!(t.minY>this.maxY)&&!(t.maxY<this.minY))))},Fi.prototype.getCenterPoint=function(){var t=(this.minX+this.maxX)/2,e=(this.minY+this.maxY)/2;return new dr(t,e)},Fi.prototype.getCenterPoint=function(){var t=(this.minX+this.maxX)/2,e=(this.minY+this.maxY)/2;return new dr(t,e)},Fi.prototype.getXLength=function(){return this.maxX-this.minX},Fi.prototype.getYLength=function(){return this.maxY-this.minY};var Ni=function(){if(!(this instanceof Ni))throw new Error(ot.CONSTRUCT_ERROR);this.triPolyhedron=new St,this.vbo_vicks_container=new Nt,this.vBOVertexIdxCacheKey=this.vbo_vicks_container.newVBOVertexIdxCacheKey()};Ni.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container},Ni.prototype.makeAABB=function(t,e,i){var r,o=-t/2,n=-e/2,a=-i/2,s=t/2,l=e/2,h=i/2,d=this.triPolyhedron.vertexList,c=d.newVertex();c.setPosition(o,n,a),(c=d.newVertex()).setPosition(s,n,a),(c=d.newVertex()).setPosition(s,l,a),(c=d.newVertex()).setPosition(o,l,a),(c=d.newVertex()).setPosition(o,n,h),(c=d.newVertex()).setPosition(s,n,h),(c=d.newVertex()).setPosition(s,l,h),(c=d.newVertex()).setPosition(o,l,h),(r=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(d.getVertex(0),d.getVertex(2),d.getVertex(1)),r.newTriangle().setVertices(d.getVertex(0),d.getVertex(3),d.getVertex(2)),(r=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(d.getVertex(4),d.getVertex(5),d.getVertex(6)),r.newTriangle().setVertices(d.getVertex(4),d.getVertex(6),d.getVertex(7)),(r=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(d.getVertex(0),d.getVertex(1),d.getVertex(5)),r.newTriangle().setVertices(d.getVertex(0),d.getVertex(5),d.getVertex(4)),(r=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(d.getVertex(1),d.getVertex(2),d.getVertex(6)),r.newTriangle().setVertices(d.getVertex(1),d.getVertex(6),d.getVertex(5)),(r=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(d.getVertex(2),d.getVertex(3),d.getVertex(7)),r.newTriangle().setVertices(d.getVertex(2),d.getVertex(7),d.getVertex(6)),(r=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(d.getVertex(3),d.getVertex(0),d.getVertex(4)),r.newTriangle().setVertices(d.getVertex(3),d.getVertex(4),d.getVertex(7))};var Bi=function(t){if(!(this instanceof Bi))throw new Error(ot.CONSTRUCT_ERROR);this.geoCoordsList,this.geoLocDataManager,this.bLoop=!1,this.knotPoints3dList,this.interpolatedPoints3dList,this.controlPoints3dMap,this.segmentLengthArray,this.dirty=!0,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges,this.state=c.parametricCurveState.NORMAL,t&&(t.knotPoints3dArray&&void 0===this.knotPoints3dList&&(this.knotPoints3dList=new fr,this.knotPoints3dList.pointsArray=t.knotPoints3dArray),void 0!==t.bLoop&&(this.bLoop=t.bLoop))};Bi.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new k,this.geoCoordsList.owner=this),this.geoCoordsList},Bi.prototype.getGeoLocationDataManager=function(t){if(void 0===this.geoLocDataManager&&void 0!==this.geoCoordsList){var e=this.geoCoordsList.getGeoCoord(0);if(void 0!==e){this.geoLocDataManager=new H;var i=this.geoLocDataManager.newGeoLocationData("default");i=Ei.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,i,t)}}return this.geoLocDataManager},Bi.prototype.renderKnotPoints=function(t,e,i){if(void 0===this.geoCoordsList)return!1;this.geoCoordsList.renderPoints(t,e,i,!1)},Bi.prototype.renderControlPoints=function(t,e,i){if(void 0===this.controlPoints3dList){this.controlPoints3dList=new fr;for(var r=this.knotPoints3dList.getPointsCount(),o=0;o<r;o++){var n=(u=this.controlPoints3dMap[o]).inningControlPoint,a=u.outingControlPoint;n&&this.controlPoints3dList.addPoint(n),a&&this.controlPoints3dList.addPoint(a)}this.controlPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager}var s=!1,l=t.getGl(),h=t.postFxShadersManager.getShader("pointsCloud");if(h.useProgram(),h.disableVertexAttribArrayAll(),h.resetLastBuffersBinded(),h.enableVertexAttribArray(h.position3_loc),h.bindUniformGenerals(),l.uniform1i(h.bPositionCompressed_loc,!1),l.uniform1i(h.bUse1Color_loc,!0),l.uniform4fv(h.oneColor4_loc,[.3,.9,.9,1]),l.uniform1f(h.fixPointSize_loc,5),l.uniform1i(h.bUseFixPointSize_loc,1),2===i?this.controlPoints3dList.renderPointsIndividually(t,h,i,s):this.controlPoints3dList.renderPoints(t,h,i,s),2!==i){if(void 0===this.armsLinesPoints3dList){this.armsLinesPoints3dList=new fr;var d=[],c=this.knotPoints3dList.getPointsCount();for(o=0;o<c;o++){n=(u=this.controlPoints3dMap[o]).inningControlPoint,a=u.outingControlPoint;var u,f=this.knotPoints3dList.getPoint(o);n&&(d.push(f),d.push(n)),a&&(d.push(f),d.push(a))}this.armsLinesPoints3dList.pointsArray=d,this.armsLinesPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager}s=!0;var g=l.LINES;this.armsLinesPoints3dList.renderLines(t,h,i,!1,s,g)}},Bi.prototype.render=function(t,e,i){if(void 0===this.geoCoordsList)return!1;if(this.renderKnotPoints(t,e,i),this.renderControlPoints(t,e,i),2!==i){var r=t.sceneState.gl;if(void 0!==this.interpolatedPoints3dList)(e=t.postFxShadersManager.getShader("pointsCloud")).useProgram(),e.disableVertexAttribArrayAll(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals(),r.uniform1i(e.bPositionCompressed_loc,!1),1===i&&(r.uniform1i(e.bUse1Color_loc,!0),void 0!==e.oneColor4_loc&&null!==e.oneColor4_loc&&r.uniform4fv(e.oneColor4_loc,[1,0,0,1])),r.uniform1f(e.fixPointSize_loc,5),r.uniform1i(e.bUseFixPointSize_loc,!0),this.interpolatedPoints3dList.renderLines(t,e,i,!1,!1)}},Bi.prototype.makeKnotPointsFromGeoCoordsList=function(t){void 0===this.geoCoordsList.points3dList&&this.geoCoordsList.makeLines(t),this.knotPoints3dList=new fr,this.knotPoints3dList.pointsArray=this.geoCoordsList.points3dList.pointsArray,this.knotPoints3dList.geoLocDataManager=this.geoCoordsList.points3dList.geoLocDataManager},Bi.prototype.makeControlPoints=function(t,e){if(void 0===this.knotPoints3dList&&(void 0===this.geoCoordsList.points3dList&&this.geoCoordsList.makeLines(e),this.knotPoints3dList=new fr,this.knotPoints3dList.pointsArray=this.geoCoordsList.points3dList.pointsArray,this.knotPoints3dList.geoLocDataManager=this.geoCoordsList.points3dList.geoLocDataManager),void 0!==this.knotPoints3dList.pointsArray){this.controlPoints3dMap={};var i,r,o,n,a,s=this.bLoop;void 0===t&&(t=.1);for(var l=this.knotPoints3dList.getPointsCount(),h=0;h<l;h++){if(i=this.knotPoints3dList.getPoint(h),0===h)o=this.knotPoints3dList.getPoint(h+1),a=t,(c=new ur).set(i.x*(1-a)+o.x*a,i.y*(1-a)+o.y*a,i.z*(1-a)+o.z*a),this.controlPoints3dMap[h]={inningControlPoint:void 0,outingControlPoint:c};else if(h===l-1){r=this.knotPoints3dList.getPoint(h-1),n=t,(d=new ur).set(i.x*(1-n)+r.x*n,i.y*(1-n)+r.y*n,i.z*(1-n)+r.z*n),this.controlPoints3dMap[h]={inningControlPoint:d,outingControlPoint:void 0}}else{r=this.knotPoints3dList.getPoint(h-1),o=this.knotPoints3dList.getPoint(h+1);var d,c,u=this.knotPoints3dList.getTangentLine3D(h,void 0,s).direction;n=i.distToPoint(r)*t,(d=new ur).set(i.x-u.x*n,i.y-u.y*n,i.z-u.z*n),a=i.distToPoint(o)*t,(c=new ur).set(i.x+u.x*a,i.y+u.y*a,i.z+u.z*a),this.controlPoints3dMap[h]={inningControlPoint:d,outingControlPoint:c}}}}},Bi.prototype.makeInterpolatedPoints=function(){if(void 0!==this.knotPoints3dList){void 0===this.controlPoints3dMap&&this.makeControlPoints(),void 0===this.interpolatedPoints3dList&&(this.interpolatedPoints3dList=new fr);for(var t=[],e=this.bLoop,i=this.knotPoints3dList.getPointsCount(),r=0;r<i-1;r++){var o=this.knotPoints3dList.getSegment3D(r,void 0,e),n=o.startPoint3d,a=o.endPoint3d,s=this.controlPoints3dMap[r].outingControlPoint,l=this.controlPoints3dMap[r+1].inningControlPoint;Bi.makeForSegment(n,s,l,a,10,t)}this.interpolatedPoints3dList.pointsArray=t,this.interpolatedPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager}},Bi.getLengthForSegment=function(t,e,i,r,o,n){void 0===o&&(o=1),void 0===n&&(n=10);for(var a,s,l=Bi.makeForSegmentPartial(t,e,i,r,o,n,void 0),h=0,d=l.length,c=0;c<d-1;c++)a=l[c],s=l[c+1],h+=a.distToPoint(s);return h},Bi.getLength=function(t,e){if(void 0!==t&&void 0!==t.knotPoints3dList){var i=t.knotPoints3dList.getPointsCount();if(void 0===t.segmentLengthArray){t.segmentLengthArray=[],void 0===e&&(e=20);for(var r=0;r<i-1;r++){var o=t.knotPoints3dList.getSegment3D(r,void 0,void 0),n=o.startPoint3d,a=o.endPoint3d,s=t.controlPoints3dMap[r].outingControlPoint,l=t.controlPoints3dMap[r+1].inningControlPoint,h=Bi.getLengthForSegment(n,s,l,a,1,e);t.segmentLengthArray[r]=h}}var d=0;for(r=0;r<i-1;r++)d+=t.segmentLengthArray[r];return d}},Bi.getUnitaryPositionForSegmentAtLinearPosition=function(t,e,i,r,o,n){for(var a,s=1/n,l=s,h=t.x,d=t.y,c=t.z,u=e.x,f=e.y,g=e.z,p=i.x,v=i.y,y=i.z,m=r.x,x=r.y,b=r.z,C=new ur(0,0,0),A=new ur(0,0,0),T=0,M=0;M<n+1;M++){var P=1-(l=M*s),w=Math.pow(P,2),_=Math.pow(P,3),S=l*l,L=S*l,R=3*w*l,D=3*P*S,E=_*h+R*u+D*p+L*m,I=_*d+R*f+D*v+L*x,O=_*c+R*g+D*y+L*b;if(C.set(E,I,O),M>0){var F=A.distToPoint(C);if((T+=F)>o){var N=(F-(T-o))/F;return a=(M-1)*s+(N/=n)}}A.set(E,I,O)}return void 0===a&&(a=1),a},Bi.getTangent=function(t,e,i,r){if(void 0===t.knotPoints3dList){t.makeControlPoints(.3,r)}var o=t.knotPoints3dList.getPointsCount();if(void 0===t.segmentLengthArray){t.segmentLengthArray=[];for(var n,a=20,s=1,l=0;l<o-1;l++){var h=(m=t.knotPoints3dList.getSegment3D(l,void 0,n)).startPoint3d,d=m.endPoint3d,c=t.controlPoints3dMap[l].outingControlPoint,u=t.controlPoints3dMap[l+1].inningControlPoint,f=Bi.getLengthForSegment(h,c,u,d,s,a);t.segmentLengthArray[l]=f}}for(var g=!1,p=(l=0,0),v=0,y=-1;!g&&l<o;){if((p+=t.segmentLengthArray[l])>=e){g=!0,y=l;var m,x=e-v,b=(s=x/t.segmentLengthArray[y],h=(m=t.knotPoints3dList.getSegment3D(y,void 0,n)).startPoint3d,d=m.endPoint3d,c=t.controlPoints3dMap[y].outingControlPoint,u=t.controlPoints3dMap[y+1].inningControlPoint,a=20,Bi.getUnitaryPositionForSegmentAtLinearPosition(h,c,u,d,x,a));i=Bi.getTangentForSegment(h,c,u,d,b,i)}v=p,l++}return i},Bi.getTangentForSegment=function(t,e,i,r,o,n){var a=o,s=1-a,l=s*s,h=a*a,d=2*s*a,c=t.x,u=t.y,f=t.z,g=e.x,p=e.y,v=e.z,y=i.x,m=i.y,x=i.z,b=l*c+d*g+h*y,C=l*u+d*p+h*m,A=l*f+d*v+h*x,T=l*g+d*y+h*r.x,M=l*p+d*m+h*r.y,P=l*v+d*x+h*r.z,w=new ur(b,C,A),_=new ur(T,M,P);void 0===n&&(n=new Yi);var S=w.getVectorToPoint(_,void 0);return S.unitary(),n.setPointAndDir(s*b+a*T,s*C+a*M,s*A+a*P,S.x,S.y,S.z),n},Bi.makeForSegment=function(t,e,i,r,o,n){return Bi.makeForSegmentPartial(t,e,i,r,1,o,n)},Bi.makeForSegmentPartial=function(t,e,i,r,o,n,a){void 0===a&&(a=[]);for(var s=o/n,l=s,h=t.x,d=t.y,c=t.z,u=e.x,f=e.y,g=e.z,p=i.x,v=i.y,y=i.z,m=r.x,x=r.y,b=r.z,C=0;C<n+1;C++){var A=1-(l=C*s),T=Math.pow(A,2),M=Math.pow(A,3),P=l*l,w=P*l,_=3*T*l,S=3*A*P,L=new ur(M*h+_*u+S*p+w*m,M*d+_*f+S*v+w*x,M*c+_*g+S*y+w*b);a.push(L)}return a};var Vi=function(){if(!(this instanceof Vi))throw new Error(ot.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.numPointsFor360Deg};Vi.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new dr),this.centerPoint.set(t,e)},Vi.prototype.setRadius=function(t){this.radius=t},Vi.prototype.getPoints=function(t,e){if(e&&(this.numPointsFor360Deg=e),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.centerPoint||void 0===this.radius)return t;var i=new Ii;return i.setCenterPosition(this.centerPoint.x,this.centerPoint.y),i.setRadius(this.radius),i.setStartAngleDegree(0),i.setSweepAngleDegree(360),i.setSense(1),void 0===t&&(t=[]),t=i.getPoints(t,this.numPointsFor360Deg)};var ji=function(t,e,i,r){if(!t||!t instanceof cr)throw new Error("point2DList is required");this.point2DList=t,this.depth=_i(e,8),this.quatTree,this.magoMangaer=i,this.renderFunction=r&&"function"==typeof r?r:this.defaultRenderFunc,this.initQuatTree()};ji.prototype.initQuatTree=function(){var t=this.getTreeOption();this.quatTree=new Cr(t),this.quatTree.data=this.point2DList.pointsArray,this.makeTreeByDepth()},ji.prototype.getTreeOption=function(){var t=this.point2DList.getBoundingRectangle(),e=t.getXLength(),i=t.getYLength(),r=t.getCenterPoint();return e<.03&&(e=.03),i<.03&&(i=.03),{halfWidth:e/2,halfHeight:i/2,center:r}},ji.prototype.addPoint=function(t){this.point2DList.addPoint(t),this.initQuatTree()},ji.prototype.deletePointByCondition=function(t){this.point2DList.deletePointByCondition(t),this.point2DList.getPointsCount()>0?this.initQuatTree():(this.quatTree=void 0,this.magoMangaer.objMarkerManager.setMarkerByCondition(function(t){return!t.tree}))},ji.prototype.updatePoint=function(t,e){var i=this.point2DList.findPointArray(e)[0];i.set(t.getX(),t.getY());for(var r=Object.keys(i),o=0,n=r.length;o<n;o++){var a=r[o];i[a]=t[a]}this.initQuatTree()},ji.prototype.makeTreeByDepth=function(){this.quatTree.makeTreeByDepth(this.depth)},ji.prototype.defaultRenderFunc=function(t,e){e.objMarkerManager.loadDefaultImages(e),e.objMarkerManager.objectMarkerArray=[];for(var i=t.length,r=0;r<i;r++){var o=t[r];if(o.hasChildren())for(var n,a=(n=o.displayPointsArray).length,s=0;s<a;s++){var l=(d=n[s]).mass;l>50&&(l=50),l<15&&(l=15);var h={positionWC:d,imageFilePath:"defaultRed",sizeX:l,sizeY:l};e.objMarkerManager.newObjectMarker(h,e)}else if(n=o.data)for(a=n.length,s=0;s<a;s++){var d=n[s];h={positionWC:Ei.geographicCoordToWorldPoint(d.x,d.y,0),imageFilePath:"defaultBlue",sizeX:8,sizeY:8};e.objMarkerManager.newObjectMarker(h,e)}}};var Ui=function(){if(!(this instanceof Ui))throw new Error(ot.CONSTRUCT_ERROR);this.plane,this.geoLocDataManager,this.mesh};Ui.prototype.getPlane=function(){void 0===this.plane&&(this.plane=new ut);var t=this.geoLocDataManager.getCurrentGeoLocationData(),e=t.tMatrix,i=t.position;return this.plane.setPointAndNormal(i.x,i.y,i.z,e._floatArrays[8],e._floatArrays[9],e._floatArrays[10]),this.plane},Ui.prototype.makeRectangle=function(t,e){void 0===this.mesh&&(this.mesh=new rr);var i=this.mesh.getVertexList(),r=t/2,o=e/2,n=i.newVertex();n.setPosition(-r,-o,100);var a=i.newVertex();a.setPosition(r,-o,100);var s=i.newVertex();s.setPosition(r,o,100);var l=i.newVertex();l.setPosition(-r,o,100),this.mesh.newSurface().newFace().addVerticesArray([n,a,s,l])},Ui.prototype.render=function(t,e,i){var r,o=t.sceneState.gl;if(2===i){var n=t.selectionColor,a=t.selectionManager,s=a.getSelectionCandidatesFamily("general");void 0===s&&(s=a.newCandidatesFamily("general"));var l=n.getAvailableColor(void 0),h=n.decodeColor3(l.r,l.g,l.b);a.setCandidateCustom(h,"general",this),o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[l.r/255,l.g/255,l.b/255,1])}else if(1===i){o.uniform1i(e.colorType_loc,0),o.uniform4fv(e.oneColor4_loc,[1,1,0,1]);var d=0;o.uniform1i(e.refMatrixType_loc,d),r=o.LINE_LOOP}else if(0===i){d=0;o.uniform1i(e.refMatrixType_loc,d)}this.mesh.render(t,e,i,r)};var ki=function(t){if(!(this instanceof ki))throw new Error(ot.CONSTRUCT_ERROR);if(this.geoCoordsList,this.geoLocDataManager,this.excavationDepthInMeters,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges,this.dirty=!0,this.color4=new _(222/255,184/255,135/255,1),void 0!==t){if(void 0!==t.geoCoordsArray){this.geoCoordsList=new k(t.geoCoordsArray),this.geoCoordsList.owner=this;var e=this.getGeoLocationData(),i=this.geoCoordsList.getGeoCoord(0);if(i){var r=i.getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(r)}}void 0!==t.excavationDepthInMeters&&(this.excavationDepthInMeters=t.excavationDepthInMeters),t.color&&t.color instanceof _&&(this.color4=t.color)}};ki.prototype.getGeographicCoordsList=function(){return this.geoCoordsList},ki.prototype.renderPoints=function(t,e,i){if(void 0===this.geoCoordsList)return!1;this.geoCoordsList.renderPoints(t,e,i,!1)},ki.prototype.render=function(t,e,i,r,o){if(this.dirty)this.makeMesh(t);else if(void 0!==this.meshPositive){var n=t.sceneState.gl;e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals(),1===i&&(e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.disableVertexAttribArray(e.texCoord2_loc),n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,0]),n.uniform1i(e.bApplySsao_loc,!0),n.uniform1i(e.colorType_loc,1),n.uniform1i(e.bApplySpecularLighting_loc,!0)),n.uniform1i(e.refMatrixType_loc,0),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),n.colorMask(!1,!1,!1,!1),n.depthMask(!1),n.enable(n.CULL_FACE),n.enable(n.STENCIL_TEST),n.clearStencil(0);n.cullFace(n.FRONT),n.stencilFunc(n.ALWAYS,0,255),n.stencilOp(n.KEEP,n.INCR,n.KEEP),this.meshPositive.render(t,e,i,void 0),n.cullFace(n.BACK),n.stencilFunc(n.ALWAYS,0,255),n.stencilOp(n.KEEP,n.DECR,n.KEEP),this.meshPositive.render(t,e,i,void 0),1===i&&(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])),n.colorMask(!0,!0,!0,!0),n.depthMask(!0),n.stencilMask(0),n.stencilFunc(n.LEQUAL,1,255),n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),n.cullFace(n.BACK),n.depthFunc(n.GREATER),this.meshNegative.render(t,e,i,void 0),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.disable(n.STENCIL_TEST),n.stencilOp(n.KEEP,n.KEEP,n.KEEP),n.disable(n.POLYGON_OFFSET_FILL),n.stencilMask(255)}},ki.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new H);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},ki.prototype.makeMesh=function(t){if(void 0===this.geoCoordsList)return!1;var e=this.getGeoLocationData(),i=(o=this.geoCoordsList.getGeoCoord(0)).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(i),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Hr);var r,o,n=[],a=[];void 0===this.excavationDepthInMeters&&(this.excavationDepthInMeters=30);for(var s=this.geoCoordsList.getGeoCoordsCount(),l=0;l<s;l++){o=this.geoCoordsList.getGeoCoord(l);var h=new ur,d=new ur;r=W.geographicToCartesianWgs84(o.longitude,o.latitude,o.altitude-this.excavationDepthInMeters,r),h.set(r[0],r[1],r[2]),r=W.geographicToCartesianWgs84(o.longitude,o.latitude,o.altitude+70,r),d.set(r[0],r[1],r[2]);var c=new ur,u=new ur;c=e.getTransformedRelativePosition(h,c),u=e.getTransformedRelativePosition(d,u),c.pointType=1,u.pointType=1,n[l]=c,a[l]=u}var f=this.vtxProfilesList.newVtxProfile(),g=this.vtxProfilesList.newVtxProfile();if(f.makeByPoints3DArray(n,void 0),g.makeByPoints3DArray(a,void 0),void 0===this.meshPositive){this.mesh=this.vtxProfilesList.getMesh(void 0,!0,!0),this.meshPositive=this.mesh.getCopySurfaceIndependentMesh(this.meshPositive),this.meshPositive.calculateVerticesNormals(),this.meshPositive.setColor(.1,.5,.5,1),this.meshPositive.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshPositive.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager),this.meshNegative=this.mesh.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}this.dirty=!1};var Gi=function(){if(!(this instanceof Gi))throw new Error(ot.CONSTRUCT_ERROR);this.vertexArray,this.hEdge,this.planeNormal,this.surfaceOwner};Gi.prototype.deleteObjects=function(){this.vertexArray=void 0,this.hEdge=void 0,void 0!==this.planeNormal&&(this.planeNormal.deleteObjects(),this.planeNormal=void 0),this.surfaceOwner=void 0},Gi.prototype.getVerticesCount=function(){return void 0===this.vertexArray?0:this.vertexArray.length},Gi.prototype.setVertexIdxInList=function(){for(var t=this.getVerticesCount(),e=0;e<t;e++)this.vertexArray[e].setIdxInList(e)},Gi.prototype.getHalfEdgeOutingFromVertex=function(t){for(var e,i=!1,r=0,o=this.hEdge,n=this.getVerticesCount();!i&&r<n;){if(o.startVertex===t){i=!0,e=o;break}o=o.next,r++}return e},Gi.prototype.changeVertex=function(t,e){var i=this.getVerticesCount();if(t<0||t>=i)return!1;var r=this.vertexArray[t];return this.getHalfEdgeOutingFromVertex(r).setStartVertex(e),this.vertexArray[t]=e,!0},Gi.prototype.addVertex=function(t){void 0===this.vertexArray&&(this.vertexArray=[]),this.vertexArray.push(t)},Gi.prototype.addVerticesArray=function(t){void 0===this.vertexArray&&(this.vertexArray=[]),Array.prototype.push.apply(this.vertexArray,t)},Gi.prototype.getVertex=function(t){if(void 0!==this.vertexArray)return this.vertexArray[t]},Gi.prototype.reverseSense=function(){this.vertexArray.reverse()},Gi.prototype.setColor=function(t,e,i,r){for(var o=this.getVerticesCount(),n=0;n<o;n++)this.getVertex(n).setColorRGBA(t,e,i,r)},Gi.prototype.getPlaneNormal=function(){return(void 0===this.planeNormal||this.planeNormal.isNAN())&&this.calculatePlaneNormal(),this.planeNormal},Gi.calculatePlaneNormal=function(t,e){void 0===e&&(e=new ur),e.set(0,0,0);for(var i=t.length,r=0;r<i;r++){var o=Ur.getPrevIdx(r,t),n=Ur.getVector(o,t,void 0),a=Ur.getVector(r,t,void 0);if(n.unitary(),a.unitary(),!n.isNAN()&&!a.isNAN()){var s=n.crossProduct(a,void 0);if(s.unitary(),!s.isNAN()){var l=n.scalarProduct(a);l>1?l=1:l<-1&&(l=-1);var h=Math.acos(l);e.add(s.x*h,s.y*h,s.z*h)}}}return e.unitary(),e},Gi.prototype.calculatePlaneNormal=function(){return this.planeNormal=Gi.calculatePlaneNormal(this.vertexArray,this.planeNormal),this.planeNormal},Gi.prototype.calculateVerticesNormals=function(t){var e=this.vertexArray.length;void 0!==t&&t&&this.calculatePlaneNormal(),void 0===this.planeNormal&&this.calculatePlaneNormal();e=this.getVerticesCount();for(var i=0;i<e;i++)this.vertexArray[i].setNormal(this.planeNormal.x,this.planeNormal.y,this.planeNormal.z)},Gi.prototype.calculateTexCoordsBox=function(t){var e=this.getPlaneNormal(),i=Gi.getBestCubeFaceToProject(e),r=t.minX,o=t.maxX,n=t.minY,a=t.maxY,s=t.minZ,l=o-r,h=a-n,d=t.maxZ-s,u=this.getVerticesCount();if(i===c.boxFace.TOP)for(var f=0;f<u;f++){var g=(m=this.getVertex(f)).getPosition(),p=m.getTexCoord(),v=(g.x-r)/l,y=(g.y-n)/h;p.set(v,y)}else if(i===c.boxFace.BOTTOM)for(f=0;f<u;f++){g=(m=this.getVertex(f)).getPosition(),p=m.getTexCoord(),v=(g.x-r)/l;y=1-(y=(g.y-n)/h),p.set(v,y)}else if(i===c.boxFace.FRONT)for(f=0;f<u;f++){g=(m=this.getVertex(f)).getPosition(),p=m.getTexCoord(),v=(g.x-r)/l,y=(g.z-s)/d;p.set(v,y)}else if(i===c.boxFace.REAR)for(f=0;f<u;f++){g=(m=this.getVertex(f)).getPosition(),p=m.getTexCoord(),v=(g.x-r)/l;y=1-(y=(g.z-s)/d),p.set(v,y)}else if(i===c.boxFace.LEFT)for(f=0;f<u;f++){g=(m=this.getVertex(f)).getPosition(),p=m.getTexCoord(),y=(g.y-n)/h,v=(g.z-s)/d;p.set(v,y)}else if(i===c.boxFace.RIGHT)for(f=0;f<u;f++){var m;g=(m=this.getVertex(f)).getPosition(),p=m.getTexCoord(),y=(g.y-n)/h;v=1-(v=(g.z-s)/d),p.set(v,y)}},Gi.prototype.solveUroborus=function(){var t=this.getVerticesCount();if(!(t<3)){var e=this.getVertex(0),i=this.getVertex(t-1),r=e.point3d,o=i.point3d;r.isCoincidentToPoint(o,1e-4)&&this.vertexArray.pop()}},Gi.setTwinsFacesOfArray=function(t){for(var e,i,r=t.length,o=0;o<r;o++){e=t[o];for(var n=o+1;n<r;n++)o!==n&&(i=t[n],e.setTwinFace(i))}},Gi.getBestFacePlaneToProject=function(t){var e=-1,i=Math.abs(t.x),r=Math.abs(t.y),o=Math.abs(t.z);return o>i&&o>=r?e=0:i>=r&&i>=o?e=1:r>i&&r>=o&&(e=2),e},Gi.getBestCubeFaceToProject=function(t){var e=c.boxFace.UNKNOWN,i=Gi.getBestFacePlaneToProject(t);if(0===i)e=t.z>0?c.boxFace.TOP:c.boxFace.BOTTOM;else if(1===i){e=t.x>0?c.boxFace.RIGHT:c.boxFace.LEFT}else if(2===i){e=t.y>0?c.boxFace.REAR:c.boxFace.FRONT}return e},Gi.getProjectedPolygon2D=function(t,e,i){void 0===i&&(i=new pr),void 0===i.point2dList&&(i.point2dList=new cr);var r=i.point2dList;return r.pointsArray=Ur.getProjectedPoints2DArray(t,e,r.pointsArray),i},Gi.prototype.getTessellatedTriangles=function(t){if(void 0===t&&(t=[]),this.getVerticesCount()<=3)return t=this.getTrianglesConvex(t);var e,i=this.getPlaneNormal(),r=Gi.getProjectedPolygon2D(this.vertexArray,i,void 0);e=r.calculateNormal(e);var o=[];r.tessellate(e,o),this.calculateVerticesNormals();for(var n=o.length,a=0;a<n;a++){var s=o[a];if(0!==s.point2dList.getPointsCount()){var l,h,d,c,u,f;l=s.point2dList.getPoint(0).ownerVertex3d;for(var g=s.point2dList.getPointsCount(),p=1;p<g-1;p++)u=s.point2dList.getPoint(p),f=s.point2dList.getPoint(p+1),h=u.ownerVertex3d,d=f.ownerVertex3d,c=new Or(l,h,d),t.push(c)}}return t},Gi.prototype.getTrianglesConvex=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,i,r,o;void 0===t&&(t=[]),e=this.getVertex(0);for(var n=this.getVerticesCount(),a=1;a<n-1;a++)i=this.getVertex(a),r=this.getVertex(a+1),o=new Or(e,i,r),t.push(o);return t},Gi.prototype.setTwinHalfEdge=function(t){for(var e=!1,i=this.hEdge,r=this.hEdge;!e;){if(r.setTwin(t))return!0;(r=r.next)===i&&(e=!0)}return!1},Gi.prototype.getFrontierHalfEdges=function(t){var e=this.getHalfEdgesLoop(void 0);if(void 0===e)return t;void 0===t&&(t=[]);for(var i,r=e.length,o=0;o<r;o++)(i=e[o]).isFrontier()&&t.push(i);return t},Gi.prototype.getHalfEdgesLoop=function(t){return void 0===this.hEdge?t:t=zi.getHalfEdgesLoop(this.hEdge,t)},Gi.prototype.setTwinFace=function(t){if(void 0===t)return!1;if(void 0===this.hEdge||void 0===t.hEdge)return!1;for(var e,i=t.getHalfEdgesLoop(void 0),r=i.length,o=!1,n=0;n<r;n++)e=i[n],this.setTwinHalfEdge(e)&&(o=!0);return o},Gi.prototype.createHalfEdges=function(t){if(void 0===this.vertexArray||0===this.vertexArray.length)return t;var e,i;void 0===t&&(t=[]);for(var r,o=this.getVerticesCount(),n=0;n<o;n++)e=this.getVertex(n),(i=new zi).setStartVertex(e),i.setFace(this),t.push(i);for(n=0;n<o;n++)i=t[n],r=t[Ur.getNextIdx(n,this.vertexArray)],i.setNext(r);return this.hEdge=t[0],t};var zi=function(){if(!(this instanceof zi))throw new Error(ot.CONSTRUCT_ERROR);this.startVertex,this.next,this.twin,this.face};zi.prototype.deleteObjects=function(){this.startVertex=void 0,this.next=void 0,this.twin=void 0,this.face=void 0},zi.prototype.setStartVertex=function(t){this.startVertex=t,t.outingHedge=this},zi.prototype.setNext=function(t){this.next=t},zi.prototype.setTwin=function(t){var e=zi.areTwinables(t,this);return e&&(this.twin=t,t.twin=this),e},zi.prototype.setFace=function(t){this.face=t,this.face.hEdge=this},zi.prototype.getSegment3d=function(){if(void 0!==this.next){var t=this.getStartVertex().getPosition(),e=this.getEndVertex().getPosition();return new _r(t,e)}},zi.prototype.getStartVertex=function(){return this.startVertex},zi.prototype.getEndVertex=function(){if(void 0!==this.next)return this.next.startVertex},zi.prototype.isFrontier=function(){return void 0===this.twin||null===this.twin},zi.prototype.getPrev=function(){for(var t=this;;){if(t.next===this)return t;if(void 0===t.next)return;t=t.next}},zi.prototype.getNextFrontier=function(){return this.getEndVertex().getOutingFrontierHEdge()},zi.areTwinables=function(t,e){return t.startVertex===e.getEndVertex()&&t.getEndVertex()===e.startVertex},zi.getHalfEdgesLoop=function(t,e){if(void 0===t)return e;void 0===e&&(e=[]),e.length=0;for(var i=t,r=t,o=!1;!o;)e.push(r),(r=r.next)!==i&&void 0!==r||(o=!0);return e};var Hi=function(){if(!(this instanceof Hi))throw new Error(ot.CONSTRUCT_ERROR);this.hEdgesArray};Hi.getSegment3dsFromHedgesArray=function(t,e){var i=t.length;if(0===i)return e;void 0===e&&(e=[]);for(var r=0;r<i;r++)e.push(t[r].getSegment3d());return e},Hi.prototype.deleteObjects=function(){if(void 0!==this.hEdgesArray){for(var t=this.hEdgesArray.length,e=0;e<t;e++)this.hEdgesArray[e].deleteObjects(),this.hEdgesArray[e]=void 0;this.hEdgesArray=void 0}},Hi.prototype.newHalfEdge=function(){void 0===this.hEdgesArray&&(this.hEdgesArray=[]);var t=new zi;return this.hEdgesArray.push(t),t},Hi.prototype.addHalfEdgesArray=function(t){void 0!==t&&(void 0===this.hEdgesArray&&(this.hEdgesArray=[]),Array.prototype.push.apply(this.hEdgesArray,t))};var Wi=function(){if(!(this instanceof Wi))throw new Error(ot.CONSTRUCT_ERROR);this.owner,this.idx};Wi.prototype.deleteObjects=function(){this.owner=void 0,this.idx=void 0};var Xi=function(){if(!(this instanceof Xi))throw new Error(ot.CONSTRUCT_ERROR);this.strIdx,this.endIdx};Xi.prototype.copyFrom=function(t){void 0!==t&&(this.strIdx=t.strIdx,this.endIdx=t.endIdx)},Xi.prototype.deleteObjects=function(){this.strIdx=void 0,this.endIdx=void 0};var Yi=function(t,e){if(!(this instanceof Yi))throw new Error(ot.CONSTRUCT_ERROR);this.point=void 0!==t?new ur(t.x,t.y,t.z):new ur,this.direction=void 0!==e?e:new ur};Yi.prototype.setPointAndDir=function(t,e,i,r,o,n){this.point.set(t,e,i),this.direction.set(r,o,n),this.direction.unitary()},Yi.prototype.getProjectedPoint=function(t,e){void 0===e&&(e=new ur);var i=new ut;return i.setPointAndNormal(t.x,t.y,t.z,this.direction.x,this.direction.y,this.direction.z),e=i.intersectionLine(this,e)},Yi.prototype.isCoincidentPoint=function(t,e){if(void 0===t)return!1;var i=this.getProjectedPoint(t);return void 0!==i&&(void 0===e&&(e=1e-7),i.squareDistToPoint(t)<e*e)};var Ki=function(){if(!(this instanceof Ki))throw new Error(ot.CONSTRUCT_ERROR);this.point=new dr,this.direction=new dr};Ki.prototype.setPointAndDir=function(t,e,i,r){this.point.set(t,e),this.direction.set(i,r),this.direction.unitary()},Ki.prototype.distToPoint=function(t){var e=this.getProjectedPoint(t);return t.distToPoint(e)},Ki.prototype.getPerpendicularRight=function(t){var e=new Ki;return t?e.point.set(t.x,t.y):e.point.set(this.point.x,this.point.y),e.direction.set(this.direction.y,-this.direction.x),e},Ki.prototype.getParallelRight=function(t){var e=this.getPerpendicularRight().direction,i=new Ki;return i.point.set(this.point.x+e.x*t,this.point.y+e.y*t),i.direction.copyFrom(this.direction),i},Ki.prototype.getParallelLeft=function(t){var e=this.getPerpendicularLeft().direction,i=new Ki;return i.point.set(this.point.x+e.x*t,this.point.y+e.y*t),i.direction.copyFrom(this.direction),i},Ki.prototype.getPerpendicularLeft=function(t){var e=new Ki;return t?e.point.set(t.x,t.y):e.point.set(this.point.x,this.point.y),e.direction.set(-this.direction.y,this.direction.x),e},Ki.prototype.getRelativeSideOfPoint=function(t,e){void 0===e&&(e=1e-7);var i=this.getProjectedPoint(t);if(t.squareDistToPoint(i)<e*e)return c.relativePosition2D.COINCIDENT;var r=new dr(t.x-i.x,t.y-i.y);return r.unitary(),Math.abs(r.x-this.direction.y)<e&&Math.abs(r.y+this.direction.x)<e?c.relativePosition2D.RIGHT:c.relativePosition2D.LEFT},Ki.prototype.getProjectedPoint=function(t,e){if(void 0!==t){void 0===e&&(e=new dr);var i=this.getPerpendicularLeft(t);return e=this.intersectionWithLine(i,e)}},Ki.prototype.isCoincidentPoint=function(t,e){if(void 0===t)return!1;void 0===e&&(e=1e-7);var i=this.getProjectedPoint(t,i);return t.squareDistToPoint(i)<e*e},Ki.prototype.isParallelToLine=function(t){if(void 0===t)return!1;var e=this.direction.angleRadToVector(t.direction);return e<1e-9||Math.abs(e-Math.PI)<1e-9},Ki.prototype.intersectionWithLine=function(t,e){if(void 0!==t&&!this.isParallelToLine(t)){var i,r;if(Math.abs(this.direction.x)<1e-9){var o=t.direction.y/t.direction.x,n=t.point.y-o*t.point.x;i=this.point.x,r=o*this.point.x+n}else if(Math.abs(this.direction.y)<1e-9)if(Math.abs(t.direction.x)<1e-9)i=t.point.x,r=this.point.y;else{o=t.direction.y/t.direction.x,n=t.point.y-o*t.point.x;i=(this.point.y-n)/o,r=this.point.y}else if(Math.abs(t.direction.x)<1e-9){var a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;r=(i=t.point.x)*a+s}else{a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;r=(o=t.direction.y/t.direction.x)*(i=(s-(n=t.point.y-o*t.point.x))/(o-a))+n}return void 0===e&&(e=new dr),e.set(i,r),e}};var qi=function(t,i){if(e.call(this),!(this instanceof qi))throw new Error(ot.CONSTRUCT_ERROR);this.setPosition(t),this.style={},i&&(this.style=i)};qi.prototype=Object.create(e.prototype),qi.prototype.constructor=qi,qi.prototype.setPosition=function(t){return Ai()},qi.prototype.setStyle=function(t,e){if(!t)throw new Error(ot.REQUIRED_EMPTY_ERROR("style"));for(var i in e&&e instanceof tt&&this.init(e),t)t.hasOwnProperty(i)&&(this.style[i]=t[i])};var Zi=function(){if(!(this instanceof Zi))throw new Error(ot.CONSTRUCT_ERROR);this.meshesArray,this.geoLocDataManager,this.vboKeysContainer};Zi.prototype.newParametricMesh=function(){void 0===this.meshesArray&&(this.meshesArray=[]);var t=new nr;return this.meshesArray.push(t),t},Zi.prototype.deleteObjects=function(){if(void 0!==this.meshesArray){for(var t=this.meshesArray.length,e=0;e<t;e++)this.meshesArray[e].deleteObjects(),this.meshesArray[e]=void 0;this.meshesArray=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0}},Zi.prototype.getMeshesCount=function(){return void 0===this.meshesArray?0:this.meshesArray.length},Zi.prototype.getMesh=function(t){if(void 0!==this.meshesArray)return this.meshesArray[t]};var Qi=function(t,e){if(!(this instanceof Qi))throw new Error(ot.CONSTRUCT_ERROR);this.geoCoord,qi.call(this,t,e);var i=new H,r=i.newGeoLocationData();r=Ei.calculateGeoLocationData(this.geoCoord.longitude,this.geoCoord.latitude,this.geoCoord.altitude,void 0,void 0,void 0,r),this.geoLocDataManager=i};Qi.prototype=Object.create(qi.prototype),Qi.prototype.constructor=Qi,Qi.prototype.setPosition=function(t){t&&(this.geoCoord=new j(t.longitude,t.latitude,t.altitude))},Qi.prototype.makeMesh=function(t){var e=new Nt,i=e.newVBOVertexIdxCacheKey(),r=t.vboMemoryManager,o=new Float32Array([0,0,0]);i.setDataArrayPos(o,r);var n=this.style,a=new Ue(n);a.vboKeysContainer=e,this.objectsArray.push(a),this.setDirty(!1)};var Ji=function(t,e){if(!(this instanceof Ji))throw new Error(ot.CONSTRUCT_ERROR);var i;this.knotGeoCoordsArray,qi.call(this,t,e),this.style.thickness||(this.style.thickness=2),i=this.knotGeoCoordsArray[0];var r=new H,o=r.newGeoLocationData();o=Ei.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,o),this.geoLocDataManager=r,o.rotMatrix.Identity()};Ji.prototype=Object.create(qi.prototype),Ji.prototype.constructor=Ji,Ji.prototype.setPosition=function(t){var e=t.coordinates.length;if(e>1){void 0===this.knotGeoCoordsArray&&(this.knotGeoCoordsArray=[]);for(var i=0;i<e;i++){var r=t.coordinates[i],o=new j(r.longitude,r.latitude,r.altitude);this.knotGeoCoordsArray.push(o)}}},Ji.prototype.makeMesh=function(t){if(void 0!==this.knotGeoCoordsArray){var e=_.fromHexCode(this.style.color,void 0),i={thickness:this.style.thickness,color:e},r=k.getRenderableObjectOfGeoCoordsArray(this.knotGeoCoordsArray,t,i);if(this.style.point){var o=this.style.point,n=this.knotGeoCoordsArray.length;if(n>1)for(var a=0;a<n;a++){var s=this.knotGeoCoordsArray[a],l={longitude:s.longitude,latitude:s.latitude,altitude:s.altitude},h=new Qi(l,o);this.objectsArray.push(h)}}this.objectsArray.push(r),this.setDirty(!1)}},Ji.prototype.getPointByIndex=function(t){var e=this.getPoints();if(e.length<=t)throw new Error("Out of range");if(e.length>0)return e[t]},Ji.prototype.getPoints=function(){return this.objectsArray.filter(function(t){return t instanceof Qi})};var $i=function(t,e){if(!(this instanceof $i))throw new Error(ot.CONSTRUCT_ERROR);var i;this.minGeographicCoord,this.maxGeographicCoord,qi.call(this,t,e),i=j.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,i);var r=new H,o=r.newGeoLocationData();o=Ei.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,o),this.geoLocDataManager=r,o.rotMatrix.Identity()};$i.prototype=Object.create(qi.prototype),$i.prototype.constructor=$i,$i.prototype.clone=function(){var t={minLongitude:this.minGeographicCoord.longitude,minLatitude:this.minGeographicCoord.latitude,maxLongitude:this.maxGeographicCoord.longitude,maxLatitude:this.maxGeographicCoord.latitude,altitude:this.maxGeographicCoord.altitude},e=JSON.parse(JSON.stringify(this.style));return new $i(t,e)},$i.prototype.setPosition=function(t){if(!t)throw new Error(ot.REQUIRED_EMPTY_ERROR("position"));var e=t.altitude;t.minLongitude&&t.minLatitude&&(this.minGeographicCoord=new j(t.minLongitude,t.minLatitude,e)),t.maxLongitude&&t.maxLatitude&&(this.maxGeographicCoord=new j(t.maxLongitude,t.maxLatitude,e))},$i.prototype.getArea=function(){var t=new j(this.minGeographicCoord.longitude,this.maxGeographicCoord.latitude,this.maxGeographicCoord.altitude),e=W.getArcDistanceBetweenGeographicCoords(this.minGeographicCoord,t),i=W.getArcDistanceBetweenGeographicCoords(t,this.maxGeographicCoord);return Math.abs(i*e)},$i.prototype.makeMesh=function(t){var e,i,r,o=this.minGeographicCoord.longitude,n=this.minGeographicCoord.latitude,a=this.maxGeographicCoord.longitude,s=this.maxGeographicCoord.latitude;e=Math.floor(5*(a-o)),i=Math.floor(5*(s-n)),e<1&&(e=1),i<1&&(i=1),r=this.minGeographicCoord.altitude;var l=Math.PI/180,h=o*l,d=n*l,c=a*l,u=s*l,f=c-h,g=u-d,p=f/e,v=g/i,y=(e+1)*(i+1),m=new Float32Array(y),x=new Float32Array(y),b=new Float32Array(y);this.texCoordsArray=new Float32Array(2*y);var C,A,T=h,M=d,P=0,w=0;r&&(w=r);for(var S=0;S<i+1;S++){(M=d+v*S)>u&&(M=u);for(var L=0;L<e+1;L++)(T=h+p*L)>c&&(T=c),m[P]=T,x[P]=M,b[P]=w,C=(T-h)/f,A=(M-d)/g,this.texCoordsArray[2*P]=C,this.texCoordsArray[2*P+1]=1-A,P++}this.cartesiansArray=void 0,this.cartesiansArray=W.geographicRadianArrayToFloat32ArrayWgs84(m,x,b,this.cartesiansArray),this.normalsArray=new Int8Array(3*y);for(var R=new ur,D=0;D<y;D++)R.set(this.cartesiansArray[3*D],this.cartesiansArray[3*D+1],this.cartesiansArray[3*D+2]),R.unitary(),this.normalsArray[3*D]=126*R.x,this.normalsArray[3*D+1]=126*R.y,this.normalsArray[3*D+2]=126*R.z;var E=e+1,I=i+1,O={bCalculateBorderIndices:!0},F=Li.getIndicesTrianglesRegularNet(E,I,void 0,void 0,void 0,void 0,void 0,O);this.indices=F.indicesArray,this.southIndices=F.southIndicesArray,this.eastIndices=F.eastIndicesArray,this.northIndices=F.northIndicesArray,this.westIndices=F.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;var N=this.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==this.cartesiansArray){var B=this.cartesiansArray.length/3;for(D=0;D<B;D++)this.cartesiansArray[3*D]-=N.position.x,this.cartesiansArray[3*D+1]-=N.position.y,this.cartesiansArray[3*D+2]-=N.position.z;var V=new Nt,j=V.newVBOVertexIdxCacheKey(),U=t.vboMemoryManager;j.setDataArrayPos(this.cartesiansArray,U),this.normalsArray&&j.setDataArrayNor(this.normalsArray,U),this.texCoordsArray&&j.setDataArrayTexCoord(this.texCoordsArray,U),j.setDataArrayIdx(this.indices,U);var k=new rr;if(k.vboKeysContainer=V,k.material=new er,this.style.imageUrl){var G=this.style.imageUrl;k.material.setDiffuseTextureUrl(G)}if(this.style.fillColor){var z=_.fromHexCode(this.style.fillColor,void 0);k.material.setColor4(z.r,z.g,z.b,1)}if(this.style.opacity&&(this.attributes.opacity=this.style.opacity),void 0!==this.style.strokeWidth){this.contourIndices=[],Array.prototype.push.apply(this.contourIndices,this.southIndices);var H=this.eastIndices.length;for(D=1;D<H;D++)this.contourIndices.push(this.eastIndices[D]);var X=this.northIndices.length;for(D=1;D<X;D++)this.contourIndices.push(this.northIndices[D]);var Y=this.westIndices.length;for(D=1;D<Y;D++)this.contourIndices.push(this.westIndices[D]);var K=[],q=this.contourIndices.length;for(D=0;D<q;D++){P=this.contourIndices[D];var Z=this.cartesiansArray[3*P],Q=this.cartesiansArray[3*P+1],J=this.cartesiansArray[3*P+2],$=new ur(Z,Q,J);K.push($)}O={thickness:this.style.strokeWidth};if(void 0!==this.style.strokeColor){z=_.fromHexCode(this.style.strokeColor,void 0);O.color=z}var tt=new Ye(O);tt.vboKeysContainer=fr.getVboThickLines(t,K,tt.vboKeysContainer,O),this.objectsArray.push(tt)}this.objectsArray.push(k),this.setDirty(!1)}},$i.prototype.setStyle=function(t,e){if(!t)throw new Error(ot.REQUIRED_EMPTY_ERROR("style"));e&&e instanceof tt&&this.init(e);var i=e.modeler.existObject(this);for(var r in t)if(t.hasOwnProperty(r)){var o="clampToTerrain"===r&&t[r]!==this.style[r];o&&i&&e.modeler.removeObject(this),this.style[r]=t[r],o&&i&&e.modeler.addObject(this,1),this.style.clampToTerrain&&"imageUrl"===r&&(this.texture=void 0,e.tinTerrainManager.imageryLayersChanged())}};var tr=function(t){if(!(this instanceof tr))throw new Error(ot.CONSTRUCT_ERROR);this.magoManager=t,this.cameraMovable=!0};tr.prototype.renderScene=function(){var t=this.magoManager,e=t.sceneState;if("none"!==e.canvas.parentElement.style.display){var i=e.gl;i.enable(i.DEPTH_TEST),i.viewport(0,0,i.viewportWidth,i.viewportHeight),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),t.start(void 0,!0,0,1)}},tr.prototype.goto=function(t,e,i,r,o){var n=W.geographicToCartesianWgs84(t,e,i,n),a=this.magoManager.sceneState.camera,s=a.position;if(r){var l=W.CartesianToGeographicWgs84(s.x,s.y,s.z,void 0,!1),h=new j(t,e,i),d=j.getMidPoint(l,h,void 0),u=j.getAngleBetweenCoords(l,h);d.altitude<3e4*u&&(d.altitude=3e4*u);var f=new Bi;f.getGeographicCoordsList().addGeoCoordsArray([l,d,h]);var g={animationType:c.animationType.PATH};g.path=f,g.birthTime=this.magoManager.getCurrentTime(),g.linearVelocityInMetersSecond=5e5,g.acceleration=2e3,g.durationInSeconds=wi(r,3),a.animationData=g,void 0===this.magoManager.animationManager&&(this.magoManager.animationManager=new v),this.magoManager.animationManager.putObject(a)}else this.changeCameraPosition(n,o)},tr.prototype.changeCameraOrientation=function(t,e,i,r){if(t=parseFloat(t),e=parseFloat(e),i=parseFloat(i),isNaN(t))throw new Error("Heading require number type.");if(isNaN(e))throw new Error("Pitch require number type.");if(isNaN(i))throw new Error("Roll require number type.");var o=this.magoManager.sceneState.camera;A.setOrientation(o,t,e,i),this.updateModelViewMatrixByCamera(o,r)},tr.prototype.moveBackward=function(t,e){var i=this.magoManager.sceneState.camera,r=i.position,o=i.direction;t*=-1;var n=ur.scale(o,t),a=ur.add(r,n);this.changeCameraPosition(ur.toArray(a),e)},tr.prototype.changeCameraPosition=function(t,e){var i=this.magoManager.sceneState.camera,r=i.position,o=i.direction,n=i.up,a=i.getOrientation(),s=180*a.headingRad/Math.PI,l=180*a.pitchRad/Math.PI;r.set(t[0],t[1],t[2]);var h=Ei.calculateTransformMatrixAtWorldPosition(r,s,l,0)._floatArrays;o.set(-h[8],-h[9],-h[10]),n.set(h[4],h[5],h[6]),this.updateModelViewMatrixByCamera(i,e)},tr.prototype.mousedown=function(t){this.magoManager.sceneState.mouseButton=t.button,tr.updateMouseStartClick(t.clientX,t.clientY,this.magoManager),this.magoManager.isCameraMoving=!0,this.magoManager.mouse_x=t.clientX,this.magoManager.mouse_y=t.clientY,0===this.magoManager.sceneState.mouseButton&&this.magoManager.mouseActionLeftDown(t.clientX,t.clientY)},tr.updateMouseClick=function(t,e,i){var r=i.sceneState.mouseAction;r.curX=t,r.curY=e},tr.prototype.mouseup=function(t){var e=this.magoManager;e.bPicking=!1,e.isCameraMoving=!1;var i=e.sceneState,r=i.mouseAction;if(0===i.mouseButton){if((new Date).getTime()-r.strTime<200){var o=t.clientX-r.strX,n=t.clientY-r.strY;Math.abs(o)<3&&Math.abs(n)<3&&(e.bPicking=!0,e.managePickingProcess())}this.magoManager.mouseActionLeftUp(t.clientX,t.clientY)}i.mouseButton=-1;var a=(new Date).getTime()-r.strTime,s=i.camera;a>.001&&a<200?s.lastMovement.deltaTime=a:s.lastMovement.movementType=c.movementType.NO_MOVEMENT,e.mustCheckIfDragging=!0},tr.prototype.mouseclick=function(t){if(2!==t.detail&&0===t.button){var e=t.clientX,i=t.clientY;this.magoManager.mouseActionLeftClick(e,i)}},tr.prototype.mouseRightClick=function(t){if(2!==t.detail&&2===t.button){var e=t.clientX,i=t.clientY;this.magoManager.mouseActionRightClick(e,i)}},tr.prototype.mouseDblClick=function(t){if(t.preventDefault(),t.stopPropagation(),0===t.button){var e=t.clientX,i=t.clientY;this.magoManager.mouseActionLeftDoubleClick(e,i)}},tr.prototype.mousewheel=function(t){if(this.cameraMovable){var e;t.wheelDelta?(e=t.wheelDelta/10,window.opera&&(e=-e)):e=-t.deltaY/3*12;var i=this.magoManager,r=(i.sceneState.mouseAction,i.sceneState.camera),o=r.position,n=r.direction,a=r.up,s=t.clientX,l=t.clientY,h=Ei.getRayWorldSpace(void 0,s,l,void 0,i).direction,d=r.getCameraElevation();if(!isNaN(d)){e*=d*d*1e-5+.001*d,e+=1;var c=.5*d;c>2e5&&(c=2e5),e<-c&&(e=-c),e>c&&(e=c);var u,f=new ur(o.x,o.y,o.z),g=new ur(o.x+h.x*e,o.y+h.y*e,o.z+h.z*e);if(o.set(g.x,g.y,g.z),(u=f.crossProduct(g,u)).unitary(),!u.isNAN()){var p=f.angleRadToVector(g);if(0!==p&&!isNaN(p)){var v=new rt;v.rotationAxisAngRad(p,u.x,u.y,u.z),n=v.transformPoint3D(n,n),a=v.transformPoint3D(a,a),this.updateModelViewMatrixByCamera(r)}}}}},tr.prototype.moveSelectedObject=function(t){var e=this.magoManager,i=e.selectionManager.getSelectedGeneral();e.moveSelectedObjectGeneral(void 0,i)},tr.prototype.mousemove=function(t){var e=this.magoManager,i=t.clientX,r=t.clientY;e.mouse_x=i,e.mouse_y=r,e.mustCheckIfDragging&&(e.isDragging()?e.mouseDragging=!0:e.mouseDragging=!1,e.mustCheckIfDragging=!1);var o=e.sceneState.mouseAction,n=this.magoManager.sceneState.camera,a=o.strX,s=o.strY;if(this.magoManager.mouseActionMove({x:i,y:r},{x:a,y:s}),this.cameraMovable){void 0===n.lastMovement&&(n.lastMovement=new at);var l=e.getCurrentTime()-o.strTime;if(0===e.sceneState.mouseButton){if(i===o.strX&&r===o.strY)return;var h=o.strX-i,d=o.strY-r;if(Math.abs(h)<3&&Math.abs(d)<3)return;e.sceneState.gl;var u=e.sceneState,f=o.strCamera,g=(p=o.strWorldPoint).getModul();if((v=o.strCamCoordPoint).getModul()<30){var p=o.strWorldPoint,v=o.strCamCoordPoint,y=(W.planeAtCartesianPointWgs84(p.x,p.y,p.z,void 0),W.normalAtCartesianPointWgs84(p.x,p.y,p.z,void 0)),m=new ur(y[0],y[1],y[2]),x=u.modelViewMatrix.rotatePoint3D(m,void 0),b=new ut;b.setPointAndNormal(v.x,v.y,v.z,x.x,x.y,x.z);var C=Ei.getRayCamSpace(i,r,L,this.magoManager);(L=new Yi).setPointAndDir(0,0,0,C[0],C[1],C[2]);var A=b.intersectionLine(L,void 0);if(void 0===A)return;var T=new ur(A.x-v.x,A.y-v.y,A.z-v.z),M=(R=u.getModelViewMatrixInv()).rotatePoint3D(T,void 0),P=M.getModul();if(P>100||P<1e-5)return;n.copyPosDirUpFrom(f),n.position.add(-M.x,-M.y,-M.z),this.updateModelViewMatrixByCamera(n);var w=new ur;w.copyFrom(M),w.unitary();var _=P/l*.25;n.lastMovement.movementType=c.movementType.TRANSLATION,n.lastMovement.currLinearVelocity=_,n.lastMovement.translationDir=w}else{var S,L;u=this.magoManager.sceneState,f=o.strCamera,n=this.magoManager.sceneState.camera,g=(p=o.strWorldPoint).getModul();L=Ei.getRayCamSpace(i,r,L,this.magoManager),void 0===this.pointSC&&(this.pointSC=new ur),this.pointSC.set(L[0],L[1],L[2]);var R=o.strModelViewMatrixInv;this.pointSC2=R.rotatePoint3D(this.pointSC,this.pointSC2),this.pointSC2.unitary(),S=new Yi;var D,E=f.position;if(S.setPointAndDir(1e-4*E.x,1e-4*E.y,1e-4*E.z,this.pointSC2.x,this.pointSC2.y,this.pointSC2.z),void 0===(D=this.magoManager.globe.intersectionLineWgs84(S,D,1e-4*g)))return;var I,O=new ur(1e-4*p.x,1e-4*p.y,1e-4*p.z),F=new ur(D[0],D[1],D[2]);if((I=O.crossProduct(F,I)).unitary(),I.isNAN())return;var N=O.angleRadToVector(F);if(N<1e-8||isNaN(N))return;n.copyPosDirUpFrom(f);var B=new rt;B.rotationAxisAngRad(-N,I.x,I.y,I.z),n.transformByMatrix4(B),this.updateModelViewMatrixByCamera(n);var V=N/l*.25;n.lastMovement.movementType=c.movementType.ROTATION,n.lastMovement.currAngularVelocity=V,n.lastMovement.rotationAxis=I,n.lastMovement.rotationPoint=void 0}}else if(1===this.magoManager.sceneState.mouseButton){f=o.strCamera;n.copyPosDirUpFrom(f);var j,U=o.strWorldPoint;void 0===this.magoManager.globe&&(this.magoManager.globe=new W),j=W.normalAtCartesianPointWgs84(U.x,U.y,U.z,j);var k=n.getCameraRight(),G=(i=t.clientX,r=t.clientY,.003*(i-o.strX)),z=.003*(r-o.strY),H=-o.startCamOrintation.pitchRad;Math.PI;if(H<0);else;if(z+H>-.1&&(z=H<0?-H:H),0===G&&0===z)return;void 0===this.rotMat&&(this.rotMat=new rt);var X=glMatrix.quat.create();X=glMatrix.quat.setAxisAngle(X,j,-G);var Y=glMatrix.quat.create();Y=glMatrix.quat.setAxisAngle(Y,[k.x,k.y,k.z],-z);var K=glMatrix.quat.create();K=glMatrix.quat.multiply(K,X,Y),this.rotMat._floatArrays=glMatrix.mat4.fromQuat(this.rotMat._floatArrays,K);var q=new ur(-U.x,-U.y,-U.z),Z=new ur(U.x,U.y,U.z);n.translate(q),n.transformByMatrix4(this.rotMat),n.translate(Z),this.updateModelViewMatrixByCamera(n);V=N/l*.3;n.lastMovement.movementType=c.movementType.ROTATION_ZX,n.lastMovement.rotationPoint=U,n.lastMovement.xAngVelocity=-z/l*.3,n.lastMovement.zAngVelocity=-G/l*.3}}},tr.screenToCamCoord=function(t,e,i,r){var o,n,a,s=i.sceneState.gl,l=i.sceneState.camera;void 0===r&&(r=new ur);for(var h=i.numFrustums,d=0;d<h;d++){var c=i.frustumVolumeControl.getFrustumVolumeCulling(d).depthFbo;if(Ei.calculatePixelLinearDepth(s,t,e,c,i)<.996){o=c;var u=l.getFrustum(d);n=u.far[0],a=u.near[0],!0;break}}return i.isCesiumGlobe()||(a=0),r=Ei.calculatePixelPositionCamCoord(s,t,e,r,o,a,n,i)},tr.updateMouseStartClick=function(t,e,i){var r=i.sceneState,o=r.gl,n=r.mouseAction;tr.updateMouseClick(t,e,i);var a=new Date;n.strTime=a.getTime(),n.strX=t,n.strY=e,0===r.mouseButton&&(i.bPicking=!0);for(var s,l=r.camera,h=!1,d=i.numFrustums,c=0;c<d;c++){var u=i.frustumVolumeControl.getFrustumVolumeCulling(c).depthFbo;if((s=Ei.calculatePixelLinearDepth(o,n.strX,n.strY,u,i))<.996){u;var f=l.getFrustum(c);f.far[0],f.near[0],h=!0;break}}if(h||void 0===i.scene){if(n.strLinealDepth=s,n.strCamCoordPoint=tr.screenToCamCoord(t,e,i,n.strCamCoordPoint),n.strCamCoordPoint){n.strWorldPoint=Ei.cameraCoordPositionToWorldCoord(n.strCamCoordPoint,n.strWorldPoint,i),n.strCamera.copyPosDirUpFrom(l),n.startCamOrintation=l.getOrientation();var g=r.modelViewMatrix,p=r.getModelViewMatrixInv();n.strModelViewMatrix._floatArrays=glMatrix.mat4.copy(n.strModelViewMatrix._floatArrays,g._floatArrays),n.strModelViewMatrixInv._floatArrays=glMatrix.mat4.copy(n.strModelViewMatrixInv._floatArrays,p._floatArrays)}}else{var v=i.scene,y=(l=v.frameState.camera).getPickRay(new Cesium.Cartesian2(t,e)),m=v.globe.pick(y,v);n.strWorldPoint=m}},tr.prototype.updateModelViewMatrixByCamera=function(t,e){e||this.magoManager.cameraMoveStart();var i=(t=this.magoManager.sceneState.camera).position,r=t.direction,o=t.up,n=t.frustum.far[0],a=i.x+r.x*n,s=i.y+r.y*n,l=i.z+r.z*n,h=this.magoManager.sceneState.modelViewMatrix;if(h._floatArrays=rt.lookAt(h._floatArrays,[i.x,i.y,i.z],[a,s,l],[o.x,o.y,o.z]),this.magoManager.sceneState.modelViewMatrixInv.dirty=!0,!e){var d=this;setTimeout(function(){d.magoManager.cameraMoveEnd()},10)}},tr.prototype.doTest__BSpline3DCubic=function(t){var e=this.magoManager,i=e.modeler;void 0===i.bSplineCubic3d&&(i.bSplineCubic3d=new Bi);var r=i.bSplineCubic3d;if(void 0!==r){void 0===r.geoCoordsList&&(r.geoCoordsList=new k),r.geoCoordsList=i.geoCoordsList;for(var o=r.geoCoordsList.geographicCoordsArray.length,n=0;n<o;n++){var a=r.geoCoordsList.geographicCoordsArray[n],s=a.getGeoLocationDataManager().newGeoLocationData("noName");s=Ei.calculateGeoLocationData(a.longitude,a.latitude,a.altitude,void 0,void 0,void 0,s,e)}r.getGeographicCoordsList().makeLines(e);r.makeControlPoints(.2,e),r.makeInterpolatedPoints()}},tr.prototype.doTest__ExtrudedObject=function(t){var e=this.magoManager,i=e.modeler.getGeographicCoordsList();if(i){var r=i.getExtrudedMeshRenderableObject(100,!0,void 0,e,void 0);r.setOneColor(.2,.7,.8,.3),r.attributes.isMovable=!0,r.attributes.isSelectable=!0,r.attributes.name="extrudedObject",r.attributes.selectedColor4=new _(1,1,0,0),void 0===r.options&&(r.options={}),r.options.renderWireframe=!0,r.options.renderShaded=!0,r.options.depthMask=!0,e.smartTileManager.putObject(10,r)}},tr.prototype.doTest__CameraOrientation=function(){var t=this.magoManager.sceneState.camera;A.setOrientation(t,145,80,void 0),this.updateModelViewMatrixByCamera(t);var e=t.getOrientation();e.headingRad,Math.PI,e.pitchRad,Math.PI,e.rollRad,Math.PI},tr.prototype.doTest__GoTo=function(t){this.goto(127,36,1500,3)},tr.prototype.doTest__TerrainScanner=function(){var t=new j(126.31394,33.18262,0),e=new j(126.34513,33.215,0),i=new U(t,e),r=new He(i),o=new H,n=o.newGeoLocationData();n=Ei.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,void 0,void 0,void 0,n),r.geoLocDataManager=o;this.magoManager.modeler.addObject(r,10),t.makeDefaultGeoLocationData(),e.makeDefaultGeoLocationData(),this.magoManager.modeler.addObject(t,10),this.magoManager.modeler.addObject(e,10)},tr.prototype.doTest__MagoRectangle=function(){void 0===this.countAux&&(this.countAux=0);var t={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:800},e=new $i(t,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.7,clampToTerrain:!0}),i=3;this.magoManager.modeler.addObject(e,i);t={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:800},e=new $i(t,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.7,clampToTerrain:!1}),i=3;this.magoManager.modeler.addObject(e,i),this.countAux++},tr.prototype.doTest__MagoPoint=function(){var t=new Qi({longitude:126.31394,latitude:33.18262,altitude:200},{size:10,strokeColor:"#FF0000",color:"#00FF00",opacity:.7});this.magoManager.modeler.addObject(t,10)},tr.prototype.doTest__MagoPolyline=function(){var t=new Ji({coordinates:[{longitude:126.31394,latitude:33.18262,altitude:200},{longitude:126.34513,latitude:33.215,altitude:200},{longitude:126.33,latitude:33.18,altitude:200},{longitude:126.35,latitude:33.18262,altitude:200},{longitude:126.38,latitude:33.195,altitude:200}]},{color:"#ff0000",thickness:2,point:{size:20,strokeColor:"#000000",strokeSize:1,color:"#00FF00",opacity:.7}});this.magoManager.modeler.addObject(t,1)},tr.prototype.doTest__ObjectMarker=function(){var t=this.magoManager,e=t.modeler.getGeographicCoordsList();if(e)for(var i=e.getGeoCoordsCount(),r=0;r<i;r++){t.speechBubble||(t.speechBubble=new Mago3D.SpeechBubble);var o=t.speechBubble,n=_.getHexCode(1,1,1),a=o.getPng([64,64],n,{pixel:12,color:"blue",borderColor:"white",text:"blabla"}),s=e.getGeoCoord(r),l=s.longitude,h=s.latitude,d=s.altitude,c={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(l,h,d),imageFilePath:a};t.objMarkerManager.newObjectMarker(c,t)}},tr.prototype.keydown=function(t){var e=t.key,i=this.magoManager;i.modeler;if("m"===e)void 0===i.magoMode&&(i.magoMode=c.magoMode.NORMAL),i.magoMode===c.magoMode.DRAWING?i.magoMode=c.magoMode.NORMAL:i.magoMode===c.magoMode.NORMAL&&(i.magoMode=c.magoMode.DRAWING);else if("t"===e)this.doTest__MagoRectangle();else if("p"===e&&void 0===this.smartTile_f4d_tested){var r=i.f4dController;this.smartTile_f4d_tested=1;i.readerWriter.geometryDataPath;r.smartTilePathInfo["busan-mj"]||(r.smartTilePathInfo["busan-mj"]={}),r.smartTilePathInfo["busan-mj"].projectId="busan-mj",r.smartTilePathInfo["busan-mj"].projectFolderPath="busan-mj",i.getObjectIndexFileSmartTileF4d("SmartTilesF4D_WorkFolder")}};var er=function(t,e){if(!(this instanceof er))throw new Error(ot.CONSTRUCT_ERROR);this.id,this.name=t,void 0===this.name&&(this.name="noName"),this.diffuseTexture,this.color4};er.prototype.setDiffuseTextureUrl=function(t){void 0===this.diffuseTexture&&(this.diffuseTexture=new At),this.diffuseTexture.url=t},er.prototype.setColor4=function(t,e,i,r){void 0===this.color4&&(this.color4=new _),this.color4.setRGBA(t,e,i,r)};var ir=function(t){if(!(this instanceof ir))throw new Error(ot.CONSTRUCT_ERROR);this.magoManager=t,this.materialsMap={},this.texturesManager,this.imagesPath="/images/materialImages"};ir.prototype.getMaterial=function(t){return this.materialsMap[t]},ir.prototype.getOrNewMaterial=function(t){var e=this.getMaterial(t);return void 0===e&&(e=new er(t),this.materialsMap[t]=e),e},ir.prototype.getOrLoadTexture=function(t){void 0===this.texturesManager&&(this.texturesManager=new Mt(this.magoManager));this.texturesManager.getTextureByName(t)};var rr=function(){if(!(this instanceof rr))throw new Error(ot.CONSTRUCT_ERROR);this.name,this.id,this.vertexList,this.surfacesArray,this.color4,this.hedgesList,this.edgesSegment3dsArray,this.vboKeysContainer,this.edgesVboKeysContainer,this.bbox,this.material};rr.fromVbo=function(t){if(void 0!==t){var e=new rr;e.vertexList=new Ur;var i=e.vertexList;e.hedgesList=new Hi;var r,o,n,a,s,l,h=e.hedgesList,d=e.newSurface();if(void 0!==t.vboBufferIdx);else{var c=t.vboBufferPos.dataArray;if(void 0===c)return;var u=c.length/3;if(0===u)return;var f=u/3,g=new Gr;g.vertexArray=new Array(u);for(var p=g.vertexArray,v=0;v<f;v++)r=new ur(c[9*v],c[9*v+1],c[9*v+2]),o=new ur(c[9*v+3],c[9*v+4],c[9*v+5]),n=new ur(c[9*v+6],c[9*v+7],c[9*v+8]),a=i.newVertex(r),s=i.newVertex(o),l=i.newVertex(n),(R=d.newFace()).addVerticesArray([a,s,l]),h.addHalfEdgesArray(R.createHalfEdges(void 0)),a.facesOwnerArray=[R],s.facesOwnerArray=[R],l.facesOwnerArray=[R],p[3*v]=a,p[3*v+1]=s,p[3*v+2]=l;var y=i.getBoundingBox(void 0),m=y.getMaxLength();g.setBoxSize(y.minX,y.minX+m,y.minY,y.minY+m,y.minZ,y.minZ+m);var x=m/30;x<.1&&(x=.1),g.makeTreeByMinSize(x);g.extractOctreesWithData();var b=i.getVertexCount();for(v=0;v<b;v++){var C=i.getVertex(v);if(-1!==C.getVertexType()){for(var A=C.vertexIndexingOctree.vertexArray,T=jr.getCoincidentVertexArray(C,A,void 0,1e-4),M=T.length,P=0;P<M;P++){var w=T[P];w.setVertexType(-1);for(var _=w.facesOwnerArray,S=_.length,L=0;L<S;L++){var R;(R=_[L]).setVertexIdxInList();var D=w.getIdxInList();R.changeVertex(D,C),C.facesOwnerArray.push(R)}}Gi.setTwinsFacesOfArray(C.facesOwnerArray)}}i.deleteVertexByVertexType(-1)}return e}},rr.prototype.deleteObjects=function(t){if(void 0!==this.vertexList&&this.vertexList.deleteObjects(),void 0!==this.surfacesArray){for(var e=this.surfacesArray.length,i=0;i<e;i++)this.surfacesArray[i].deleteObjects(),this.surfacesArray[i]=void 0;this.surfacesArray=void 0}void 0!==this.hedgesList&&(this.hedgesList.deleteGlObjects(),this.hedgesList=void 0),void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)},rr.prototype.deleteVbos=function(t){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(t.gl,t),this.vboKeysContainer=void 0)},rr.prototype.newSurface=function(t){void 0===this.surfacesArray&&(this.surfacesArray=[]);var e=new Ir(t);return this.surfacesArray.push(e),e},rr.prototype.getHalfEdgesList=function(){return void 0===this.hedgesList&&(this.hedgesList=new Hi),this.hedgesList},rr.prototype.getSurface=function(t){if(void 0!==this.surfacesArray)return this.surfacesArray[t]},rr.prototype.addSurface=function(t){void 0!==t&&(void 0===this.surfacesArray&&(this.surfacesArray=[]),this.surfacesArray.push(t))},rr.prototype.mergeMesh=function(t){if(void 0!==t){void 0===this.surfacesArray&&(this.surfacesArray=[]);for(var e=t.getSurfacesCount(),i=0;i<e;i++)this.addSurface(t.getSurface(i));t.surfacesArray=void 0}},rr.prototype.getSurfacesCount=function(){return void 0===this.surfacesArray?0:this.surfacesArray.length},rr.prototype.getCopySurfaceIndependentMesh=function(t){var e,i;void 0===t&&(t=new rr);for(var r=this.getSurfacesCount(),o=0;o<r;o++)e=this.getSurface(o),i=t.newSurface(),i=e.getCopyIndependentSurface(i);return t},rr.prototype.getTriangles=function(t){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return t;void 0===t&&(t=[]);for(var e=this.getSurfacesCount(),i=0;i<e;i++)t=this.getSurface(i).getTriangles(t);return t},rr.prototype.getTrianglesConvex=function(t){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return t;void 0===t&&(t=[]);for(var e=this.getSurfacesCount(),i=0;i<e;i++)t=this.getSurface(i).getTrianglesConvex(t);return t},rr.prototype.getNoRepeatedVerticesArray=function(t){var e,i,r;void 0===t&&(t=[]);for(var o,n,a=0,s=this.getSurfacesCount(),l=0;l<s;l++){e=(r=this.getSurface(l)).getFacesCount();for(var h=0;h<e;h++){n=(i=r.getFace(h)).getVerticesCount();for(var d=0;d<n;d++)(o=i.getVertex(d)).setIdxInList(a),a++}}var c,u={};for(s=this.getSurfacesCount(),l=0;l<s;l++){e=(r=this.getSurface(l)).getFacesCount();for(h=0;h<e;h++){n=(i=r.getFace(h)).getVerticesCount();for(d=0;d<n;d++)u[(o=i.getVertex(d)).getIdxInList().toString()]=o}}for(var f in u)Object.prototype.hasOwnProperty.call(u,f)&&(c=u[f],t.push(c));return t},rr.prototype.getVertexList=function(){return void 0===this.vertexList&&(this.vertexList=new Ur),this.vertexList},rr.prototype.getBoundingBox=function(){return void 0===this.bbox&&(this.bbox=new y,this.bbox=this.vertexList.getBoundingBox(this.bbox)),this.bbox},rr.prototype.rotate=function(t,e,i,r){var o=new rt,n=new ft,a=new ur(e,i,r);a.unitary(),n.rotationAngDeg(t,a.x,a.y,a.z),o.rotationByQuaternion(n),this.transformByMatrix4(o)},rr.prototype.transformByMatrix4=function(t){void 0===this.vertexList&&(this.vertexList=new Ur,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.transformPointsByMatrix4(t);this.calculateVerticesNormals(!0)},rr.prototype.translate=function(t,e,i){void 0===this.vertexList&&(this.vertexList=new Ur,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.translateVertices(t,e,i)},rr.prototype.calculateVerticesNormals=function(t){for(var e=this.getSurfacesCount(),i=0;i<e;i++)this.getSurface(i).calculateVerticesNormals(t)},rr.prototype.calculateTexCoordsBox=function(t){for(var e=this.getSurfacesCount(),i=0;i<e;i++)this.getSurface(i).calculateTexCoordsBox(t)},rr.prototype.calculateTexCoordsSpherical=function(){for(var t=new j,e=this.vertexList.getVertexCount(),i=0;i<e;i++){var r,o=this.vertexList.getVertex(i),n=(t=o.point3d.getSphericalCoords(t)).longitude/360;r=.5*(90+t.latitude)/90,void 0===o.texCoord&&(o.texCoord=new dr(n,r))}},rr.prototype.setColor=function(t,e,i,r){for(var o=this.getSurfacesCount(),n=0;n<o;n++)this.getSurface(n).setColor(t,e,i,r)},rr.prototype.setOneColor=function(t,e,i,r){void 0===this.color4&&(this.color4=new _),this.color4.setRGBA(t,e,i,r)},rr.prototype.setMaterial=function(t){this.material=t},rr.prototype.reverseSense=function(){for(var t=this.getSurfacesCount(),e=0;e<t;e++)this.getSurface(e).reverseSense();this.calculateVerticesNormals()},rr.prototype.getFrontierHalfEdges=function(t){for(var e=this.getSurfacesCount(),i=0;i<e;i++)t=this.getSurface(i).getFrontierHalfEdges(t);return t},rr.prototype.getCopy=function(t){var e,i,r,o,n,a,s,l;void 0===this.vertexList&&(this.vertexList=new Ur),void 0!==this.vertexList.vertexArray&&0!==this.vertexList.vertexArray.length||(this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),void 0===t&&(t=new rr),void 0===t.vertexList&&(t.vertexList=new Ur),t.vertexList.copyFrom(this.vertexList),this.vertexList.setIdxInList(),t.vertexList.setIdxInList();for(var h=this.getSurfacesCount(),d=0;d<h;d++){e=this.getSurface(d),(a=t.newSurface()).id=e.id,a.name=e.name,i=e.getFacesCount();for(var c=0;c<i;c++){r=e.getFace(c),s=a.newFace(),o=r.getVerticesCount();for(var u=0;u<o;u++)n=r.getVertex(u).getIdxInList(),l=t.vertexList.getVertex(n),s.addVertex(l)}}return t.calculateVerticesNormals(),t},rr.prototype.getTrianglesListsArrayBy2ByteSize=function(t,e){void 0===e&&(e=[]);var i=new Nr;if(e.push(i),3*(a=t.length)<65535)return i.trianglesArray=[],Array.prototype.push.apply(i.trianglesArray,t),e;var r=Nr.getNoRepeatedVerticesArray(t,void 0);if(r.length<65535)return i.trianglesArray=[],Array.prototype.push.apply(i.trianglesArray,t),e;Ur.setIdxInList(r);for(var o,n=[],a=t.length,s=0;s<a;s++)(o=t[s]).vertex0.idxInList<65535&&o.vertex1.idxInList<65535&&o.vertex2.idxInList<65535?i.addTriangle(o):n.push(o);return n.length>0&&(e=this.getTrianglesListsArrayBy2ByteSize(n,e)),e},rr.prototype.renderAsChild=function(t,e,i,r,o,n,a){var s=!0,l=!1,h=!0,d=t.getGl();a?(n&&(void 0!==n.renderWireframe&&(l=n.renderWireframe),void 0!==n.depthMask&&(h=n.depthMask)),l&&this.renderWireframe(t,e,i,r,o)):(n&&(void 0!==n.renderShaded&&(s=n.renderShaded),void 0!==n.depthMask&&(h=n.depthMask)),s&&(d.depthMask(h),this.render(t,e,i,r,o),d.depthMask(!0)))},rr.prototype.render=function(t,e,i,r,o){var n=t.vboMemoryManager;if(void 0!==this.vboKeysContainer){var a,s=t.sceneState.gl;if(0===i);else if(1===i&&!o){var l=!1,h=this.material;if(void 0!==h){var d=h.diffuseTexture;if(void 0!==d){if(void 0!==d.texId)s.uniform1i(e.colorType_loc,2),e.last_tex_id!==d.texId&&(s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,d.texId),e.last_tex_id=d.texId,l=!0);else if(d.fileLoadState===c.fileLoadState.READY){var u=d.url;return void Mt.loadTexture(u,d,t,!1)}}else{var f=h.color4;f&&(s.uniform1i(e.colorType_loc,0),s.uniform4fv(e.oneColor4_loc,[f.r,f.g,f.b,f.a]))}}!l&&this.color4&&(s.uniform1i(e.colorType_loc,0),s.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]))}for(var g=this.vboKeysContainer.vboCacheKeysArray.length,p=0;p<g;p++){var v=this.vboKeysContainer.vboCacheKeysArray[p];if(!v)return!1;if(!v.bindDataPosition(e,n))return!1;if(1===i){if(v.vboBufferNor){if(!v.bindDataNormal(e,n))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(v.vboBufferTCoord){if(!v.bindDataTexCoord(e,n))return!1}else e.disableVertexAttribArray(e.texCoord2_loc)}if(1===i||2===i)if(v.vboBufferCol){if(!v.bindDataColor(e,n))return!1}else e.disableVertexAttribArray(e.color4_loc);if(!v.bindDataIndice(e,n))return!1;a=r||s.TRIANGLES,s.drawElements(a,v.indicesCount,s.UNSIGNED_SHORT,0)}}else this.vboKeysContainer=this.getVbo(this.vboKeysContainer,n)},rr.prototype.renderWireframe=function(t,e,i,r,o){t.vboMemoryManager;if(void 0!==this.edgesVboKeysContainer){var n=t.sceneState.gl;if(0===i);else if(1===i&&!o)if(void 0!==this.material&&void 0!==this.material.diffuseTexture&&void 0!==this.material.diffuseTexture.texId){var a=this.material.diffuseTexture;n.uniform1i(e.colorType_loc,2),e.last_tex_id!==a.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,a.texId),e.last_tex_id=a.texId)}else this.color4&&(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]));var s=this.edgesVboKeysContainer.getVboKey(0);this.thickness=2,n.uniform1f(e.thickness_loc,this.thickness);var l=s.vboBufferPos,h=l.dataDimensions;l.isReady(n,t.vboMemoryManager)&&(n.bindBuffer(n.ARRAY_BUFFER,l.key),n.vertexAttribPointer(e.prev_loc,h,n.FLOAT,!1,16,0),n.vertexAttribPointer(e.current_loc,h,n.FLOAT,!1,16,32),n.vertexAttribPointer(e.next_loc,h,n.FLOAT,!1,16,96),n.drawArrays(n.TRIANGLE_STRIP,0,s.vertexCount-4),n.enable(n.CULL_FACE))}else this.edgesVboKeysContainer=this.getVboEdgesThickLines(this.edgesVboKeysContainer,t)},rr.prototype.getVbo=function(t,e){void 0===t&&(t=new Nt);for(var i,r,o=this.getTriangles(void 0),n=(o.length,this.getTrianglesListsArrayBy2ByteSize(o,void 0)),a=n.length,s=0;s<a;s++){r=(i=n[s]).getNoRepeatedVerticesArray(void 0);var l=t.newVBOVertexIdxCacheKey();Ur.setIdxInList(r),Ur.getVboDataArrays(r,l,e),i.assignVerticesIdx(),Nr.getVboFaceDataArray(i.trianglesArray,l,e)}return t},rr.prototype.getVboTrianglesConvex=function(t,e){void 0===t&&(t=new Nt);for(var i,r,o=this.getTrianglesConvex(void 0),n=(o.length,this.getTrianglesListsArrayBy2ByteSize(o,void 0)),a=n.length,s=0;s<a;s++){r=(i=n[s]).getNoRepeatedVerticesArray(void 0);var l=t.newVBOVertexIdxCacheKey();Ur.setIdxInList(r),Ur.getVboDataArrays(r,l,e),i.assignVerticesIdx(),Nr.getVboFaceDataArray(i.trianglesArray,l,e)}return t},rr.prototype.getEdgeSegment3ds=function(t){for(var e,i=[],r=this.getSurfacesCount(),o=0;o<r;o++)"outerLateral"===(e=this.getSurface(o)).name&&(i=e.getFrontierHalfEdges(i));var n,a,s,l,h,d,c=i.length;if(0===c)return t;t||(t=[]);for(o=0;o<c;o++)s=(n=i[o]).startVertex,l=n.getEndVertex(),h=s.getPosition(),d=l.getPosition(),a=new _r(h,d),t.push(a);return t},rr.prototype.getVboEdgesThickLines=function(t,e){return this.edgesSegment3dsArray=[],this.edgesSegment3dsArray=this.getEdgeSegment3ds(this.edgesSegment3dsArray),t=_r.getVboThickLines(e,this.edgesSegment3dsArray,t)},rr.prototype.getVboEdges=function(t,e){if(void 0!==t){for(var i,r,o,n=this.getFrontierHalfEdges(void 0),a=n.length,s=2*a,l=new Float32Array(3*s),h=new Uint16Array(s),d=0,c=0;c<a;c++)r=(i=n[c]).startVertex,o=i.getEndVertex(),l[6*c]=r.point3d.x,l[6*c+1]=r.point3d.y,l[6*c+2]=r.point3d.z,l[6*c+3]=o.point3d.x,l[6*c+4]=o.point3d.y,l[6*c+5]=o.point3d.z,h[2*c]=d,d++,h[2*c+1]=d,d++;var u=t.newVBOVertexIdxCacheKey();return u.setDataArrayPos(l,e),u.setDataArrayIdx(h,e),t}};var or=function(t){if(!(this instanceof or))throw new Error(ot.CONSTRUCT_ERROR);this.magoManager=t,this.mode=c.modelerMode.INACTIVE,this.drawingState=c.modelerDrawingState.NO_STARTED,this.drawingElement=c.modelerDrawingElement.NOTHING,this.planeGrid,this.polyLine2d,this.geoCoordsList,this.excavation,this.tunnel,this.bSplineCubic3d,this.sphere,this.clippingBox,this.magoRectangle,this.testObjectsArray,this.objectsArray,this.vectorsArray,this.currentVisibleObjectsArray};or.prototype.extractObjectsByClassName=function(t,e){if(void 0===this.objectsArray)return e;void 0===e&&(e=[]);for(var i=this.objectsArray.length,r=0;r<i;r++){var o=this.objectsArray[r];o.constructor.name===t&&e.push(o)}return e},or.prototype.newPipe=function(t){var e=t.interiorRadius,i=t.exteriorRadius,r=t.height,o=new je(e,i,r,t);return void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(o),o},or.prototype.newTube=function(t){var e=t.interiorRadius,i=t.exteriorRadius,r=t.height,o=new Xe(e,i,r,t);return void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(o),o},or.prototype.addObject=function(t,e){if(void 0===this.objectsArray&&(this.objectsArray=[]),t instanceof $i){var i=t.style;if(i&&i.clampToTerrain)return void this.magoManager.tinTerrainManager.addObjectToClampToTerrain(t)}this.objectsArray.push(t);var r=this.magoManager.smartTileManager,o=e||5;r.putObject(o,t,this.magoManager)},or.prototype.existObject=function(t){if(!this.objectsArray||Array.isArray(this.objectsArray)&&0===this.objectsArray.length)return!1;if(t instanceof $i){var e=t.style;if(e&&e.clampToTerrain)return this.magoManager.tinTerrainManager.objectsToClampToTerrainArray.filter(function(e){return e!==t}).length>0}return this.objectsArray.filter(function(e){return e!==t}).length>0},or.prototype.removeObject=function(t){if(void 0===t)return!1;if(t instanceof $i&&t.style.clampToTerrain)return this.magoManager.tinTerrainManager.removeObjectToClampToTerrain(t),void t.deleteObjects(this.magoManager.vboMemoryManager);t.deleteObjects(this.magoManager.vboMemoryManager);var e=t.smartTileOwner;e&&(e.nativeObjects.opaquesArray=e.nativeObjects.opaquesArray.filter(function(e){return e!==t}),e.nativeObjects.transparentsArray=e.nativeObjects.transparentsArray.filter(function(e){return e!==t})),this.objectsArray=this.objectsArray.filter(function(e){return e!==t})},or.prototype.newPerson=function(t){void 0===this.testObjectsArray&&(this.testObjectsArray=[]);var e=new Se;return this.testObjectsArray.push(e),e},or.prototype.newBasicFactory=function(t,e,i,r){var o=this.magoManager,n=o.materialsManager,a=n.getOrNewMaterial("basicFactoryRoof");if(void 0===a.diffuseTexture){a.diffuseTexture=new At,a.diffuseTexture.textureTypeName="diffuse",a.diffuseTexture.textureImageFileName="factoryRoof.jpg";var s=n.imagesPath+"//"+a.diffuseTexture.textureImageFileName;Mt.loadTexture(s,a.diffuseTexture,o,!0)}void 0===r&&(r={}),r.roof={material:a};var l=new Re(t,e,i,r);return l.bHasGround=!0,void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(l),l},or.getExtrudedSolidMesh=function(t,e,i,r,o,n,a){if(void 0!==t&&void 0!==e){var s=new Hr;s.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(t),void 0===r&&(r=new ur(0,0,1));for(var h=e/i,d=0;d<i;d++){var c=s.newVtxProfile();c.copyFrom(l),c.translate(0,0,h*(d+1))}return(a=s.getMesh(a,o,n)).calculateVerticesNormals(),a}},or.getExtrudedMesh=function(t,e,i,r,o,n,a){if(void 0!==t&&void 0!==e)return(a=or.getExtrudedSolidMesh(t,e,i,r,void 0).getCopySurfaceIndependentMesh(a)).calculateVerticesNormals(),a},or.getRevolvedSolidMesh=function(t,e,i,r,o,n,a){if(void 0!==t){var s=new Hr;s.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(t);var h=e/i,d=r.getLine(),c=new dr(0,0),u=d.getProjectedPoint(c);u.inverse();var f=new rt,g=new ft,p=r.getDirection(),v=new ur(p.x,p.y,0);v.unitary();for(var y=0;y<i;y++){g.rotationAngDeg(h*(y+1),v.x,v.y,v.z),f.rotationByQuaternion(g);var m=s.newVtxProfile();m.copyFrom(l),m.translate(u.x,u.y,0),m.transformPointsByMatrix4(f),m.translate(-u.x,-u.y,0)}return(a=s.getMesh(a,o,n)).calculateVerticesNormals(),a}},or.getPoints3DList_fromPoints3dArray=function(t,e,i){var r=new y;r.init(t[0]),r.addPointsArray(t);var o,n=r.getCenterPoint();if(void 0!==i&&void 0!==i.geoLocationData)o=i.geoLocationData;else{var a=Ei.pointToGeographicCoord(n,void 0);o=Ei.calculateGeoLocationData(a.longitude,a.latitude,a.altitude,0,0,0,void 0)}var s=o.getTransformedRelativePositionsArray(t,void 0);return void 0===e&&(e=new fr),e.pointsArray=s,void 0===e.geoLocDataManager&&(e.geoLocDataManager=new H),e.geoLocDataManager.addGeoLocationData(o),e},or.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new k),this.geoCoordsList},or.prototype.getExcavation=function(){return this.excavation},or.prototype.getTunnel=function(){return this.tunnel},or.prototype.addPointToPolyline=function(t){void 0===this.polyLine2d&&(this.polyLine2d=new vr),this.polyLine2d.newPoint2d(t.x,t.y)},or.prototype.render=function(t,e,i,r){if(void 0!==this.testObjectsArray)for(var o=this.testObjectsArray.length,n=0;n<o;n++){this.testObjectsArray[n].render(t)}if(void 0!==this.planeGrid&&this.planeGrid.render(t,e),void 0!==this.geoCoordsList&&1===i){if(void 0!==this.geoCoordsList.points3dList&&void 0!==this.geoCoordsList.points3dList.vboKeysContainer){var a=t.postFxShadersManager.getShader("thickLine");a.useProgram();var s=this.magoManager.getGl();s.uniform1i(a.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth);var l=this.magoManager.sceneState;s.uniform4fv(a.oneColor4_loc,[.9,.5,.3,1]),s.uniform2fv(a.viewport_loc,[l.drawingBufferWidth,l.drawingBufferHeight]),s.uniform1f(a.thickness_loc,5),this.geoCoordsList.points3dList.renderThickLines(t,a,i,!0,{}),e.useProgram()}this.geoCoordsList.renderPoints(t,e,i)}if(void 0!==this.excavation&&this.excavation.renderPoints(t,e,i),void 0!==this.tunnel&&this.tunnel.renderPoints(t,e,i),(1===i||2===i)&&void 0!==this.clippingBox){r=void 0;var h=!1;this.clippingBox.render(t,e,i,r,h)}void 0!==this.bSplineCubic3d&&(0===i&&((e=t.postFxShadersManager.getShader("pointsCloudDepth")).useProgram(),e.disableVertexAttribArrayAll(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals()),this.bSplineCubic3d.render(t,e,i)),void 0!==this.sphere&&this.sphere.render(t,e,i),0!==i&&this.magoRectangle&&this.magoRectangle.render(t,e,i,r,h)},or.prototype.createPlaneGrid=function(t,e,i,r){void 0===t&&(t=500),void 0===e&&(e=500),void 0===i&&(i=50),void 0===r&&(r=50),void 0===this.planeGrid&&(this.planeGrid=new hr(t,e,i,r))};var nr=function(){if(!(this instanceof nr))throw new Error(ot.CONSTRUCT_ERROR);this.vtxProfilesList,this.profile,this.vboKeyContainer,this.vboKeyContainerEdges};nr.prototype.deleteObjects=function(){this.profile&&this.profile.deleteObjects(),this.profile=void 0},nr.prototype.getVboKeysContainer=function(){return this.vboKeyContainer},nr.prototype.getMesh=function(t,e,i){return void 0===t&&(t=new rr),(t=this.vtxProfilesList.getMesh(t,e,i)).calculateVerticesNormals(),t},nr.prototype.getSurfaceIndependentMesh=function(t,e,i){return void 0===t&&(t=new rr),this.mesh=this.vtxProfilesList.getMesh(void 0,e,i),(t=this.mesh.getCopySurfaceIndependentMesh(t)).calculateVerticesNormals(),t},nr.prototype.revolve=function(t,e,i,r){if(void 0!==t){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Hr),this.vtxProfilesList.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var o=this.vtxProfilesList.newVtxProfile();o.makeByProfile2D(t);var n=e/i,a=r.getLine(),s=new dr(0,0),l=a.getProjectedPoint(s);l.inverse();var h=new rt,d=new ft,c=r.getDirection(),u=new ur(c.x,c.y,0);u.unitary();for(var f=0;f<i;f++){d.rotationAngDeg(n*(f+1),u.x,u.y,u.z),h.rotationByQuaternion(d);var g=this.vtxProfilesList.newVtxProfile();g.copyFrom(o),g.translate(l.x,l.y,0),g.transformPointsByMatrix4(h),g.translate(-l.x,-l.y,0)}}},nr.prototype.extrude=function(t,e,i,r){if(void 0!==t&&void 0!==e){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Hr),this.vtxProfilesList.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var o=this.vtxProfilesList.newVtxProfile();o.makeByProfile2D(t),void 0===r&&(r=new ur(0,0,1));for(var n=e/i,a=0;a<i;a++){var s=this.vtxProfilesList.newVtxProfile();s.copyFrom(o),s.translate(0,0,n*(a+1))}}};var ar=function(t){if(!(this instanceof ar))throw new Error(ot.CONSTRUCT_ERROR);this.geoCoordsList,void 0!==t&&(this.geoCoordsList=new k(t)),this.controlPointArmLength=.2,this.curvesArray,this.dirty=!0};ar.prototype.getTangent=function(t,e,i){if(this.dirty){void 0===this.curvesArray&&(this.curvesArray=[]);ar.insertPointsOnLargeSegments(this.geoCoordsList.geographicCoordsArray,.001,i);for(var r=this.geoCoordsList.geographicCoordsArray.length,o=0;o<r;o++){var n=this.geoCoordsList.geographicCoordsArray[o],a=n.getGeoLocationDataManager().newGeoLocationData("noName");a=Ei.calculateGeoLocationData(n.longitude,n.latitude,n.altitude,void 0,void 0,void 0,a,i)}var s=new Bi;this.curvesArray.push(s),s.geoCoordsList=this.geoCoordsList,s.geoCoordsList.makeLines(i);var l=this.controlPointArmLength;s.makeControlPoints(l,i),this.dirty=!1}s=this.curvesArray[0];return e=Bi.getTangent(s,t,e,i)},ar.prototype.getGeoLocationDataManager=function(){if(void 0!==this.curvesArray&&0!==this.curvesArray.length){var t=this.curvesArray[0];if(void 0!==t)return t.knotPoints3dList.geoLocDataManager}},ar.insertPointsOnLargeSegments=function(t,e,i){if(void 0!==t)for(var r=t.length,o=0;o<r-1;o++){var n=t[o],a=t[o+1];if(j.getAngleBetweenCoords(n,a)>e){var s=j.getMidPoint(n,a,void 0);t.splice(o+1,0,s),r=t.length,o--}}};var sr=function(){if(!(this instanceof sr))throw new Error(ot.CONSTRUCT_ERROR);this.position,this.radius},lr=function(t){if(!(this instanceof lr))throw new Error(ot.CONSTRUCT_ERROR);this.pipeKnotsArray,this.dirty=!0};lr.make=function(){};var hr=function(t,e,i,r){if(!(this instanceof hr))throw new Error(ot.CONSTRUCT_ERROR);this.geoLocDataManager,this.width,this.height,this.altitude=0,this.numCols,this.numRows,this.vboKeysContainer,this.setSize(t,e,i,r)};hr.prototype.setSize=function(t,e,i,r){void 0!==t&&(this.width=t),void 0!==e&&(this.height=e),void 0!==i&&(this.numCols=i),void 0!==r&&(this.numRows=r)},hr.prototype.render=function(t,e){if(void 0!==this.vboKeysContainer){var i=t.sceneState.gl,r=(t.vboMemoryManager,this.geoLocDataManager.getCurrentGeoLocationData());i.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,r.rotMatrix._floatArrays),i.uniform3fv(e.buildingPosHIGH_loc,r.positionHIGH),i.uniform3fv(e.buildingPosLOW_loc,r.positionLOW),i.uniform1i(e.refMatrixType_loc,0),i.uniform1i(e.hasAditionalMov_loc,!1),e.disableVertexAttribArray(e.texCoord2_loc),i.uniform1i(e.colorType_loc,0),i.uniform4fv(e.oneColor4_loc,[1,1,1,1]),i.uniform1i(e.bApplySpecularLighting_loc,!1),e.disableVertexAttribArrayAll();for(var o=this.vboKeysContainer.vboCacheKeysArray.length,n=0;n<o;n++){var a=this.vboKeysContainer.vboCacheKeysArray[n];if(void 0!==a.vboBufferPos&&!a.bindDataPosition(e,t.vboMemoryManager))return!1;if(void 0!==a.vboBufferNor){if(!vbo_vicky.bindDataNormal(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.normal3_loc);if(void 0!==a.vboBufferCol){if(!vbo_vicky.bindDataColor(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.color4_loc);if(void 0!==a.vboBufferTCoord){if(!vbo_vicky.bindDataTexCoord(e,t.vboMemoryManager))return!1}else e.disableVertexAttribArray(e.texCoord2_loc);i.drawArrays(i.LINES,0,a.vertexCount)}}},hr.prototype.makeVbo=function(t){var e,i,r,o,n=this.width/2,a=this.height/2,s=this.altitude,l=new ur(-n,-a,s),h=new ur(n,-a,s),d=(new ur(n,a,s),new ur(-n,a,s)),c=this.width/(this.numCols-1),u=this.height/(this.numRows-1),f=2*this.numCols+2*this.numRows,g=new Float32Array(3*f),p=0;i=l.y,o=d.y;for(var v=0;v<this.numCols;v++)r=e=l.x+v*c,g[p]=e,g[++p]=i,g[++p]=s,g[++p]=r,g[++p]=o,g[++p]=s,p++;e=l.x,r=h.x;for(var y=0;y<this.numRows;y++)o=i=l.y+y*u,g[p]=e,g[++p]=i,g[++p]=s,g[++p]=r,g[++p]=o,g[++p]=s,p++;void 0===this.vboKeysContainer&&(this.vboKeysContainer=new Nt),this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(g,t)};var dr=function(t,e){if(!(this instanceof dr))throw new Error(ot.CONSTRUCT_ERROR);this.x=t||0,this.y=e||0,this.ownerVertex3d,this.associated};dr.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0},dr.prototype.setAssociated=function(t){this.associated.x=t.x,this.associated.y=t.y},dr.prototype.getAssociated=function(){return this.associated},dr.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},dr.prototype.inverse=function(){this.x=-this.x,this.y=-this.y},dr.prototype.set=function(t,e){this.x=t,this.y=e},dr.prototype.getX=function(){return this.x},dr.prototype.getY=function(){return this.y},dr.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y},dr.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},dr.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t},dr.prototype.isParallelToPoint=function(t,e){if(void 0===t)return!1;var i=wi(e,1e-9),r=this.angleRadToVector(t);return r<i||Math.abs(r-Math.PI)<i},dr.prototype.squareDistToPoint=function(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i},dr.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},dr.prototype.getLeft=function(t){return void 0===t&&(t=new dr),t.set(-this.y,this.x),t},dr.prototype.getRight=function(t){return void 0===t&&(t=new dr),t.set(this.y,-this.x),t},dr.prototype.isCoincidentToPoint=function(t,e){var i=!1;return this.distToPoint(t)<e*e&&(i=!0),i},dr.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=new dr),e.set(t.x-this.x,t.y-this.y),e},dr.prototype.crossProduct=function(t){return this.x*t.y-t.x*this.y},dr.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y},dr.prototype.angleRadToVector=function(t){if(void 0!==t){var e=this.getModul(),i=t.getModul();if(!(e<1e-9||i<1e-9))return Math.acos(this.scalarProduct(t)/(e*i))}},dr.prototype.angleDegToVector=function(t){if(void 0!==t){var e=this.angleRadToVector(t);if(void 0!==e)return 180*e/Math.PI}};var cr=function(){if(!(this instanceof cr))throw new Error(ot.CONSTRUCT_ERROR);this.pointsArray};cr.prototype.deleteObjects=function(){if(void 0!==this.pointsArray){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].deleteObjects(),this.pointsArray[e]=void 0;this.pointsArray=void 0}},cr.prototype.addPoint=function(t){void 0!==t&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(t))},cr.prototype.newPoint=function(t,e){void 0===this.pointsArray&&(this.pointsArray=[]);var i=new dr(t,e);return this.pointsArray.push(i),i},cr.prototype.deletePointByCondition=function(t){this.pointsArray=this.findPointArray(t)},cr.prototype.findPointArray=function(t){var e=this;return e.pointsArray.filter(function(i){return t.call(e,i)})},cr.prototype.getPoint=function(t){return this.pointsArray[t]},cr.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},cr.prototype.getPrevIdx=function(t){var e=this.pointsArray.length;return 0===t?e-1:t-1},cr.prototype.getNextIdx=function(t){return t===this.pointsArray.length-1?0:t+1},cr.prototype.getIdxOfPoint=function(t){for(var e=this.pointsArray.length,i=0,r=-1,o=!1;!o&&i<e;)this.pointsArray[i]===t&&(o=!0,r=i),i++;return r},cr.prototype.getSegment=function(t,e){var i=this.getPoint(t),r=this.getNextIdx(t),o=this.getPoint(r);return void 0===e?e=new wr(i,o):e.setPoints(i,o),e},cr.prototype.setIdxInList=function(){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].idxInList=e},cr.prototype.getCopy=function(t){var e;void 0===t?t=new cr:t.deleteObjects();for(var i=this.getPointsCount(),r=0;r<i;r++)e=this.getPoint(r),t.newPoint(e.x,e.y);return t},cr.prototype.getBoundingRectangle=function(t){var e=this.getPointsCount();if(0===e)return t;void 0===t&&(t=new Fi);for(var i=0;i<e;i++)0===i?t.setInit(this.getPoint(i)):t.addPoint(this.getPoint(i));return t},cr.prototype.getNearestPointIdxToPoint=function(t){if(void 0!==t){for(var e,i,r,o=this.getPointsCount(),n=0;n<o;n++)i=this.getPoint(n).squareDistToPoint(t),void 0===e?(e=n,r=i):i<r&&(e=n,r=i);return e}},cr.prototype.reverse=function(){void 0!==this.pointsArray&&this.pointsArray.reverse()},cr.prototype.getPointsIdxSortedByDistToPoint=function(t,e){if(void 0===this.pointsArray)return e;void 0===e&&(e=[]);for(var i,r,o,n,a,s,l=this.pointsArray,h=[],d=l.length,c=0;c<d;c++)(r=l[c])!==t&&(o=t.squareDistToPoint(r),(i={}).pointIdx=c,i.squaredDist=o,n=0,a=h.length-1,s=this.getIndexToInsertBySquaredDist(h,i,n,a),h.splice(s,0,i));e.length=0;var u=h.length;for(c=0;c<u;c++)e.push(h[c].pointIdx);return e},cr.prototype.getIndexToInsertBySquaredDist=function(t,e,i,r){var o=r-i;if(0===t.length)return 0;if(o<6){for(var n,a=!1,s=i;!a&&s<=r;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:r+1}var l,h,d=i+Math.floor(o/2);return t[d].squaredDist>e.squaredDist?(l=i,h=d):(l=d,h=r),this.getIndexToInsertBySquaredDist(t,e,l,h)},cr.getExpandedPoints=function(t,e,i,r,o){if(void 0!==t){void 0===e&&(e=[]);var n,a,s,l,h,d,c,u,f,g,p,v,y,m=[],x=[],b=t.length,C=new wr(void 0,void 0),A=new wr(void 0,void 0);if(void 0===o&&(o=!1),o)for(var T=0;T<b;T++);else{for(T=0;T<b;T++)if(l=t[T],0===(n=T)){h=t[a=Li.getNextIdx(n,b)],A.setPoints(l,h),y=(c=A.getLine(c)).getPerpendicularLeft();var M=new dr(l.x+y.direction.x*i,l.y+y.direction.y*i);m.push(M);var P=new dr(l.x-y.direction.x*r,l.y-y.direction.y*r);x.push(P)}else if(n===b-1){d=t[s=Li.getPrevIdx(n,b)],A.setPoints(d,l),y=(c=A.getLine(c)).getPerpendicularLeft();M=new dr(l.x+y.direction.x*i,l.y+y.direction.y*i);m.push(M);P=new dr(l.x-y.direction.x*r,l.y-y.direction.y*r);x.push(P)}else{a=Li.getNextIdx(n,b),s=Li.getPrevIdx(n,b),h=t[a],d=t[s],C.setPoints(d,l),A.setPoints(l,h),u=C.getLine(u),c=A.getLine(c),g=u.getParallelLeft(i),f=c.getParallelLeft(i);M=g.intersectionWithLine(f,void 0);m.push(M),v=u.getParallelRight(r),p=c.getParallelRight(r);P=v.intersectionWithLine(p,void 0);x.push(P)}m.reverse(),e=m.concat(x)}return e}};var ur=function(t,e,i){if(!(this instanceof ur))throw new Error(i18next.t("error.construct.create"));this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.pointType};ur.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0,this.z=void 0},ur.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z},ur.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y+this.z*this.z},ur.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},ur.prototype.unitary=function(){var t=this.getModul();this.x/=t,this.y/=t,this.z/=t},ur.prototype.isNAN=function(){return!!(isNaN(this.x)||isNaN(this.y)||isNaN(this.z))},ur.prototype.crossProduct=function(t,e){return void 0===e&&(e=new ur),e.x=this.y*t.z-t.y*this.z,e.y=t.x*this.z-this.x*t.z,e.z=this.x*t.y-t.x*this.y,e},ur.prototype.scalarProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},ur.prototype.getSphericalCoords=function(t){void 0===t&&(t=new j);var e=new dr(this.x,this.y),i=new dr(1,0),r=e.angleDegToVector(i);this.y<0&&(r=360-r);var o=e.getModul(),n=180*Math.atan(this.z/o)/Math.PI;return this.z<0&&(n*=-1),t.longitude=r,t.latitude=n,t},ur.prototype.getRelativeOrientationToVector=function(t,e){var i=this.angleRadToVector(t);return i<e?0:Math.abs(Math.PI-i)<e?1:2},ur.prototype.angleRadToVector=function(t){if(void 0!==t){var e=this.getModul(),i=t.getModul();if(!(e<1e-9||i<1e-9))return Math.acos(this.scalarProduct(t)/(e*i))}},ur.prototype.angleDegToVector=function(t){if(void 0!==t){var e=this.angleRadToVector(t);if(void 0!==e)return 180*e/Math.PI}},ur.prototype.squareDistToPoint=function(t){var e=this.x-t.x,i=this.y-t.y,r=this.z-t.z;return e*e+i*i+r*r},ur.prototype.isCoincidentToPoint=function(t,e){var i=!1;return this.distToPoint(t)<e*e&&(i=!0),i},ur.prototype.isCoincidentToPointCHEAP=function(t,e){return!(Math.abs(this.x-t.x)>e)&&(!(Math.abs(this.y-t.y)>e)&&!(Math.abs(this.z-t.z)>e))},ur.prototype.squareDistTo=function(t,e,i){var r=this.x-t,o=this.y-e,n=this.z-i;return r*r+o*o+n*n},ur.prototype.distTo=function(t,e,i){return Math.sqrt(this.squareDistTo(t,e,i))},ur.prototype.distToPoint=function(t){return Math.sqrt(this.squareDistToPoint(t))},ur.prototype.distToSphere=function(t){return Math.sqrt(this.squareDistToPoint(t.centerPoint))-t.r},ur.prototype.aproxDistTo=function(t,e){var i,r,o,n,a=Math.abs(this.x-t.x),s=Math.abs(this.y-t.y),l=Math.abs(this.z-t.z);return a>s?a>l?(r=s/(i=a),o=l/(n=i*e[Math.floor(10*r)]),n*e[Math.floor(10*o)]):(r=a/(i=l),o=s/(n=i*e[Math.floor(10*r)]),n*e[Math.floor(10*o)]):s>l?(r=a/(i=s),o=l/(n=i*e[Math.floor(10*r)]),n*e[Math.floor(10*o)]):(r=a/(i=l),o=s/(n=i*e[Math.floor(10*r)]),n*e[Math.floor(10*o)])},ur.prototype.getVectorToPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=new ur),e.set(t.x-this.x,t.y-this.y,t.z-this.z),e},ur.prototype.set=function(t,e,i){this.x=t,this.y=e,this.z=i},ur.prototype.readDataFromBuffer=function(t,e){return this.x=new Float32Array(t.slice(e,e+4))[0],e+=4,this.y=new Float32Array(t.slice(e,e+4))[0],e+=4,this.z=new Float32Array(t.slice(e,e+4))[0],e+=4},ur.prototype.add=function(t,e,i){this.x+=t,this.y+=e,this.z+=i},ur.prototype.addPoint=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},ur.prototype.scale=function(t){this.x*=t,this.y*=t,this.z*=t},ur.scale=function(t,e){var i=t.x*e,r=t.y*e,o=t.z*e;return new ur(i,r,o)},ur.add=function(t,e){var i=t.x+e.x,r=t.y+e.y,o=t.z+e.z;return new ur(i,r,o)},ur.fromArray=function(t){return new ur(t[0],t[1],t[2])},ur.toArray=function(t){return[t.x,t.y,t.z]};var fr=function(t){if(!(this instanceof fr))throw new Error(ot.CONSTRUCT_ERROR);this.pointsArray,void 0!==t&&(this.pointsArray=t),this.bLoop,this.geoLocDataManager,this.vboKeysContainer};fr.prototype.deleteObjects=function(t){this.deletePoints3d(),this.deleteVboKeysContainer(t),void 0!==this.geoLocDataManager&&(this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0)},fr.prototype.deleteVboKeysContainer=function(t){if(void 0!==this.vboKeysContainer){var e=t.sceneState.gl;this.vboKeysContainer.deleteGlObjects(e,t.vboMemoryManager),this.vboKeysContainer=void 0}},fr.prototype.deletePoints3d=function(){if(void 0!==this.pointsArray){for(var t=this.pointsArray.length,e=0;e<t;e++)this.pointsArray[e].deleteObjects(),this.pointsArray[e]=void 0;this.pointsArray=void 0}},fr.prototype.addPoint=function(t){void 0!==t&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(t))},fr.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new H);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},fr.prototype.addPoint3dArray=function(t){void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push.apply(this.pointsArray,t)},fr.prototype.newPoint=function(t,e,i){void 0===this.pointsArray&&(this.pointsArray=[]);var r=new ur(t,e,i);return this.pointsArray.push(r),r},fr.prototype.getPoint=function(t){return this.pointsArray[t]},fr.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},fr.prototype.getPrevIdx=function(t){var e=this.pointsArray.length;return 0===t?e-1:t-1},fr.prototype.getNextIdx=function(t){return t===this.pointsArray.length-1?0:t+1},fr.prototype.getSegment3D=function(t,e,i){void 0===i&&(i=!1);var r=this.getPointsCount();if(i||t!==r-1){var o=this.getPoint(t),n=this.getNextIdx(t),a=this.getPoint(n);return void 0===e?e=new _r(o,a):e.setPoints(o,a),e}},fr.prototype.getTangentLine3D=function(t,e,i){void 0===e&&(e=new Yi);var r=this.getPoint(t),o=this.getBisectionPlane(t,void 0,i).getNormal();return e.setPointAndDir(r.x,r.y,r.z,o.x,o.y,o.z),e},fr.prototype.getBisectionPlane=function(t,e,i){void 0===i&&(i=!1);var r=this.getPointsCount();if(r<1)return e;void 0===e&&(e=new ut);var o,n,a=this.getPoint(t);if(i){s=this.getPrevIdx(t);o=this.getSegment3D(t,void 0,i),n=this.getSegment3D(s,void 0,i)}else if(t===r-1){var s=t-1;o=this.getSegment3D(s,void 0,i),n=this.getSegment3D(s,void 0,i)}else if(0===t)o=this.getSegment3D(t,void 0,i),n=this.getSegment3D(t,void 0,i);else{var s=t-1;o=this.getSegment3D(t,void 0,i),n=this.getSegment3D(s,void 0,i)}var l=o.getDirection(),h=n.getDirection();return l.addPoint(h),l.unitary,e.setPointAndNormal(a.x,a.y,a.z,l.x,l.y,l.z),e},fr.getVbo=function(t,e,i){if(e&&0!==e.length){void 0===i&&(i=new Nt);for(var r,o=e.length,n=new Float32Array(3*o),a=0;a<o;a++)r=e[a],n[3*a]=r.x,n[3*a+1]=r.y,n[3*a+2]=r.z;return i.newVBOVertexIdxCacheKey().setDataArrayPos(n,t.vboMemoryManager),i}},fr.getVboThickLines=function(t,e,i,r){if(void 0===e||e.length<2)return i;void 0===i&&(i=new Nt);for(var o,n=e.length,a=new Float32Array(4*n*4),s=0;s<n;s++)o=e[s],a[16*s]=o.x,a[16*s+1]=o.y,a[16*s+2]=o.z,a[16*s+3]=1,a[16*s+4]=o.x,a[16*s+5]=o.y,a[16*s+6]=o.z,a[16*s+7]=-1,a[16*s+8]=o.x,a[16*s+9]=o.y,a[16*s+10]=o.z,a[16*s+11]=2,a[16*s+12]=o.x,a[16*s+13]=o.y,a[16*s+14]=o.z,a[16*s+15]=-2;var l,h=new _(.6,.9,.99,1),d=new _(.6,.9,.99,1),c=!1;if(r&&(r.color&&(h.setRGBA(r.color.r,r.color.g,r.color.b,r.color.a),d.setRGBA(r.color.r,r.color.g,r.color.b,r.color.a)),r.startColor&&(h.setRGBA(r.startColor.r,r.startColor.g,r.startColor.b,r.startColor.a),c=!0),r.endColor&&(d.setRGBA(r.endColor.r,r.endColor.g,r.endColor.b,r.endColor.a),c=!0)),c){l=new Uint8Array(4*n*4);var u=new _(.6,.9,.99,1);u.copyFrom(h);var f=1;for(s=0;s<n;s++)f=1-s/(n-1),u=_.mix(h,d,f),l[16*s]=Math.floor(255*u.r),l[16*s+1]=Math.floor(255*u.g),l[16*s+2]=Math.floor(255*u.b),l[16*s+3]=Math.floor(255*u.a),l[16*s+4]=Math.floor(255*u.r),l[16*s+5]=Math.floor(255*u.g),l[16*s+6]=Math.floor(255*u.b),l[16*s+7]=Math.floor(255*u.a),l[16*s+8]=Math.floor(255*u.r),l[16*s+9]=Math.floor(255*u.g),l[16*s+10]=Math.floor(255*u.b),l[16*s+11]=Math.floor(255*u.a),l[16*s+12]=Math.floor(255*u.r),l[16*s+13]=Math.floor(255*u.g),l[16*s+14]=Math.floor(255*u.b),l[16*s+15]=Math.floor(255*u.a)}var g=i.newVBOVertexIdxCacheKey();return g.setDataArrayPos(a,t.vboMemoryManager,4),l&&g.setDataArrayCol(l,t.vboMemoryManager),i},fr.prototype.makeVbo=function(t){this.pointsArray&&0!==this.pointsArray.length&&(this.vboKeysContainer=fr.getVbo(t,this.pointsArray,this.vboKeysContainer))},fr.prototype.render=function(t,e,i,r,o){if(void 0!==this.vboKeysContainer){var n,a=t.getGl();e.enableVertexAttribArray(e.position3_loc),void 0===n&&(n=!0),n?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST);if(a.uniform1i(e.hasAditionalMov_loc,!1),a.uniform1i(e.refMatrixType_loc,0),a.uniform4fv(e.oneColor4_loc,[1,0,0,.7]),a.uniform1i(e.colorType_loc,0),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e),2===i){var s=t.selectionManager,l=t.selectionColor,h=l.getAvailableColor(void 0),d=l.decodeColor3(h.r,h.g,h.b);s.setCandidateGeneral(d,this),a.uniform4fv(e.oneColor4_loc,[h.r/255,h.g/255,h.b/255,1])}var c=this.vboKeysContainer.vboCacheKeysArray[0];if(!c.bindDataPosition(e,t.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,c.vertexCount),a.enable(a.DEPTH_TEST)}else this.makeVbo(t)},fr.prototype.renderAsChild=function(t,e,i,r,o){if(void 0!==this.vboKeysContainer){var n,a=t.getGl();e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.normal3_loc),void 0===n&&(n=!0),n?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST);if(a.uniform1i(e.hasAditionalMov_loc,!1),a.uniform1i(e.refMatrixType_loc,0),a.uniform1i(e.colorType_loc,0),2===i){var s=t.selectionManager,l=t.selectionColor,h=l.getAvailableColor(void 0),d=l.decodeColor3(h.r,h.g,h.b);s.setCandidateGeneral(d,this),a.uniform4fv(e.oneColor4_loc,[h.r/255,h.g/255,h.b/255,1])}var c=this.vboKeysContainer.vboCacheKeysArray[0];if(!c.bindDataPosition(e,t.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,c.vertexCount),a.enable(a.DEPTH_TEST)}else this.makeVbo(t)},fr.prototype.renderThickLines__element=function(t,e,i,r,o){if(void 0!==this.vboKeysContainer&&void 0!==this.geoLocDataManager){var n=this.vboKeysContainer.getVboKey(0);(e=t.postFxShadersManager.getShader("thickLine")).useProgram(),e.bindUniformGenerals();var a=t.getGl();a.enable(a.BLEND),a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.disable(a.CULL_FACE),a.enableVertexAttribArray(e.prev_loc),a.enableVertexAttribArray(e.current_loc),a.enableVertexAttribArray(e.next_loc),a.enableVertexAttribArray(e.order_loc);a.getAttribLocation(e.program,"order");this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e);var s=t.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),h=s.drawingBufferHeight;this.thickness=10,a.uniform4fv(e.color_loc,[.5,.7,.9,1]),a.uniform2fv(e.viewport_loc,[l[0],h[0]]),a.uniform1f(e.thickness_loc,this.thickness);var d=n.vboBufferPos,c=d.dataDimensions;if(d.isReady(a,t.vboMemoryManager)){a.bindBuffer(a.ARRAY_BUFFER,d.key),a.vertexAttribPointer(e.prev_loc,c,a.FLOAT,!1,0,0),a.vertexAttribPointer(e.current_loc,c,a.FLOAT,!1,0,12),a.vertexAttribPointer(e.next_loc,c,a.FLOAT,!1,0,24);var u=n.getVboCustom("thickLineOrder");if(u.isReady(a,t.vboMemoryManager)){a.bindBuffer(a.ARRAY_BUFFER,u.key),a.vertexAttribPointer(e.order_loc,u.dataDimensions,a.FLOAT,!1,0,0);var f=n.indicesCount;if(!n.bindDataIndice(e,t.vboMemoryManager))return!1;a.disable(a.DEPTH_TEST),a.drawElements(a.LINE_STRIP,f,a.UNSIGNED_SHORT,0),a.enable(a.DEPTH_TEST),a.enable(a.CULL_FACE),a.disable(a.BLEND)}}}},fr.prototype.renderThickLines=function(t,e,i,r,o){if(void 0!==this.vboKeysContainer&&void 0!==this.geoLocDataManager){var n=this.vboKeysContainer.getVboKey(0);(e=t.postFxShadersManager.getShader("thickLine")).useProgram(),e.bindUniformGenerals();var a=t.getGl();a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.disable(a.CULL_FACE),a.enableVertexAttribArray(e.prev_loc),a.enableVertexAttribArray(e.current_loc),a.enableVertexAttribArray(e.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e);var s=t.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),h=s.drawingBufferHeight;this.thickness=3,a.uniform4fv(e.color_loc,[.5,.7,.9,1]),a.uniform2fv(e.viewport_loc,[l[0],h[0]]),a.uniform1f(e.thickness_loc,this.thickness);var d=n.vboBufferPos,c=d.dataDimensions;d.isReady(a,t.vboMemoryManager)&&(a.bindBuffer(a.ARRAY_BUFFER,d.key),a.vertexAttribPointer(e.prev_loc,c,a.FLOAT,!1,16,0),a.vertexAttribPointer(e.current_loc,c,a.FLOAT,!1,16,32),a.vertexAttribPointer(e.next_loc,c,a.FLOAT,!1,16,96),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4),a.enable(a.CULL_FACE))}},fr.prototype.renderLines=function(t,e,i,r,o,n){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var a=t.sceneState.gl;if(void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()){if(e.enableVertexAttribArray(e.position3_loc),void 0===o&&(o=!0),o?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,e),2===i){var s=t.selectionManager,l=t.selectionColor,h=l.getAvailableColor(void 0),d=l.decodeColor3(h.r,h.g,h.b);s.setCandidateGeneral(d,this),a.uniform4fv(e.oneColor4_loc,[h.r/255,h.g/255,h.b/255,1])}var c=this.vboKeysContainer.vboCacheKeysArray[0];if(!c.bindDataPosition(e,t.vboMemoryManager))return!1;void 0===n&&(n=a.LINE_STRIP),a.drawArrays(n,0,c.vertexCount),a.enable(a.DEPTH_TEST)}else this.makeVbo(t)},fr.prototype.renderPoints=function(t,e,i,r){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var o=t.sceneState.gl;if(void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()){if(e.enableVertexAttribArray(e.position3_loc),void 0===r&&(r=!0),r?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),2===i){var n=t.selectionManager,a=t.selectionColor,s=a.getAvailableColor(void 0),l=a.decodeColor3(s.r,s.g,s.b);n.setCandidateGeneral(l,this),o.uniform4fv(e.oneColor4_loc,[s.r/255,s.g/255,s.b/255,1])}var h=this.vboKeysContainer.vboCacheKeysArray[0];if(!h.bindDataPosition(e,t.vboMemoryManager))return!1;o.drawArrays(o.POINTS,0,h.vertexCount),o.enable(o.DEPTH_TEST)}else this.makeVbo(t)},fr.prototype.renderPointsIndividually=function(t,e,i,r){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var o=t.sceneState.gl;if(void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()){if(e.enableVertexAttribArray(e.position3_loc),void 0===r&&(r=!0),r?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,e),2===i){var n=t.selectionManager,a=(l=t.selectionColor).getAvailableColor(void 0),s=l.decodeColor3(a.r,a.g,a.b);n.setCandidateGeneral(s,this),o.uniform4fv(e.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1])}if(!this.vboKeysContainer.vboCacheKeysArray[0].bindDataPosition(e,t.vboMemoryManager))return!1;n=t.selectionManager;for(var l=t.selectionColor,h=this.pointsArray.length,d=0;d<h;d++){if(2===i){a=l.getAvailableColor(void 0),s=l.decodeColor3(a.r,a.g,a.b);n.setCandidateGeneral(s,this.pointsArray[d]),o.uniform4fv(e.oneColor4_loc,[a.r/255,a.g/255,a.b/255,1])}o.drawArrays(o.POINTS,d,1)}o.enable(o.DEPTH_TEST)}else this.makeVbo(t)};var gr=function(t,e,i,r){if(!(this instanceof gr))throw new Error(ot.CONSTRUCT_ERROR);this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==r?r:0,this.pointType},pr=function(){if(!(this instanceof pr))throw new Error(ot.CONSTRUCT_ERROR);this.point2dList,this.normal,this.convexPolygonsArray,this.bRect};pr.prototype.deleteObjects=function(){void 0!==this.point2dList&&(this.point2dList.deleteObjects(),this.point2dList=void 0),this.normal=void 0},pr.prototype.getBoundingRectangle=function(t){return void 0===this.point2dList?t:t=this.point2dList.getBoundingRectangle(t)},pr.prototype.getEdgeDirection=function(t){return this.point2dList.getSegment(t).getDirection(void 0)},pr.prototype.getEdgeVector=function(t){return this.point2dList.getSegment(t).getVector(void 0)},pr.prototype.reverseSense=function(){void 0!==this.point2dList&&this.point2dList.reverse()},pr.prototype.getCopy=function(t){return void 0===this.point2dList?t:(void 0===t&&(t=new pr),void 0===t.point2dList&&(t.point2dList=new cr),t.point2dList=this.point2dList.getCopy(t.point2dList),this.normal&&(t.normal=this.normal),t)},pr.prototype.calculateNormal=function(t){void 0===t&&(t=[]),this.normal=0;for(var e=this.point2dList.getPointsCount(),i=0;i<e;i++){this.point2dList.getPoint(i);var r=this.point2dList.getPrevIdx(i),o=this.getEdgeDirection(r),n=this.getEdgeDirection(i),a=o.crossProduct(n,a),s=o.scalarProduct(n);if(a<0)a=-1,t.push(i);else{if(!(a>0))continue;a=1}var l=s,h=Math.acos(l);this.normal+=a*h}return this.normal>0?this.normal=1:this.normal=-1,t},pr.prototype.tessellate=function(t,e){var i=t.length;if(0===i)return e.push(this),e;for(var r,o=!1,n=0;!o&&n<i;){var a=t[n],s=this.point2dList.getPoint(a),l=[];this.getPointsIdxSortedByDistToPoint(s,l);for(var h=l.length,d=0;!o&&d<h;)if(r=l[d],this.point2dList.getPrevIdx(a)!==r&&this.point2dList.getNextIdx(a)!==r){var c=new wr(this.point2dList.getPoint(a),this.point2dList.getPoint(r));if(this.intersectionWithSegment(c))d++;else{var u=this.splitPolygon(a,r);if(u.length<2)d++;else{var f=u[0],g=u[1],p=f.calculateNormal(),v=g.calculateNormal(),y=f.normal,m=g.normal;y===this.normal&&m===this.normal&&(o=!0,p.length>0?e=f.tessellate(p,e):(void 0===e&&(e=[]),e.push(f)),v.length>0?e=g.tessellate(v,e):(void 0===e&&(e=[]),e.push(g))),d++}}}else d++;n++}return e},pr.prototype.intersectionWithSegment=function(t){if(void 0!==this.bRect){var e=t.getBoundaryRectangle(e);if(!this.bRect.intersectsWithRectangle(e))return!1}for(var i,r=this.point2dList.getPointsCount(),o=0;o<r;o++){if(i=this.point2dList.getSegment(o,i),!t.sharesPointsWithSegment(i))if(t.intersectionWithSegment(i,1e-7)===u.INTERSECTION_INTERSECT)return!0}return!1},pr.prototype.splitPolygon=function(t,e,i){void 0===i&&(i=[]);var r=new pr;r.point2dList=new cr,r.point2dList.pointsArray=[],r.point2dList.pointsArray.push(this.point2dList.getPoint(t)),r.point2dList.pointsArray.push(this.point2dList.getPoint(e));for(var o=!1,n=e,a=t,s=0,l=this.point2dList.getPointsCount();!o&&s<l;){(d=this.point2dList.getNextIdx(n))===a?o=!0:(r.point2dList.pointsArray.push(this.point2dList.getPoint(d)),n=d),s++}i.push(r);var h=new pr;for(h.point2dList=new cr,h.point2dList.pointsArray=[],h.point2dList.pointsArray.push(this.point2dList.getPoint(e)),h.point2dList.pointsArray.push(this.point2dList.getPoint(t)),o=!1,n=t,a=e,s=0;!o&&s<l;){var d;(d=this.point2dList.getNextIdx(n))===a?o=!0:(h.point2dList.pointsArray.push(this.point2dList.getPoint(d)),n=d),s++}return i.push(h),i},pr.prototype.getPointsIdxSortedByDistToPoint=function(t,e){return void 0===e&&(e=[]),e=this.point2dList.getPointsIdxSortedByDistToPoint(t,e)},pr.prototype.getTrianglesConvexPolygon=function(t){void 0===t&&(t=[]);var e,i=this.point2dList.getPointsCount();if(i<3)return t;for(var r=1;r<i-1;r++){e=new Or;var o=this.point2dList.getPoint(0).idxInList,n=this.point2dList.getPoint(r).idxInList,a=this.point2dList.getPoint(r+1).idxInList;e.vtxIdx0=o,e.vtxIdx1=n,e.vtxIdx2=a,t.push(e)}return t},pr.prototype.getVbo=function(t){void 0===t&&(t=new Ft);var e,i,r=[],o=[];i=this.normal>0?1:-1;for(var n=this.point2dList.getPointsCount(),a=0;a<n;a++)e=this.point2dList.getPoint(a),r.push(e.x),r.push(e.y),r.push(0),o.push(0),o.push(0),o.push(255*i);t.posVboDataArray=Float32Array.from(r),t.norVboDataArray=Int8Array.from(o),this.point2dList.setIdxInList();var s=[],l=this.convexPolygonsArray.length;for(a=0;a<l;a++){s=this.convexPolygonsArray[a].getTrianglesConvexPolygon(s)}return Nr.getVboFaceDataArray(s,t),t},pr.getVbo=function(t,e,i){void 0===i&&(i=new Ft);var r,o,n=[],a=[];o=t.normal>0?1:-1;for(var s=t.point2dList.getPointsCount(),l=0;l<s;l++)r=t.point2dList.getPoint(l),n.push(r.x),n.push(r.y),n.push(0),a.push(0),a.push(0),a.push(255*o);i.posVboDataArray=Float32Array.from(n),i.norVboDataArray=Int8Array.from(a),t.point2dList.setIdxInList();var h=[],d=e.length;for(l=0;l<d;l++){h=e[l].getTrianglesConvexPolygon(h)}return Nr.getVboFaceDataArray(h,i),i};var vr=function(){if(!(this instanceof vr))throw new Error(ot.CONSTRUCT_ERROR);this.point2dArray};vr.prototype.newPoint2d=function(t,e){void 0===this.point2dArray&&(this.point2dArray=[]);var i=new dr(t,e);return this.point2dArray.push(i),i},vr.prototype.getPointsCount=function(){return void 0===this.point2dArray?0:this.point2dArray.length},vr.prototype.deleteObjects=function(){for(var t=this.point2dArray.length,e=0;e<t;e++)this.point2dArray[e].deleteObjects(),this.point2dArray[e]=void 0;this.point2dArray=void 0},vr.prototype.getPoints=function(t){var e;void 0===t&&(t=[]);for(var i=t.length,r=this.point2dArray.length,o=0;o<r;o++)if(0===o)if(i>0){var n=t[i-1],a=this.point2dArray[o];n.isCoincidentToPoint(a,1e-7)||((e=new dr).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e))}else(e=new dr).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e);else(e=new dr).copyFrom(this.point2dArray[o]),e.pointType=1,t.push(e);return t};var yr=function(){if(!(this instanceof yr))throw new Error(ot.CONSTRUCT_ERROR);this.point3dArray,this.geoLocDataManager,this.vboKeysContainer};yr.prototype.newPoint3d=function(t,e,i){void 0===this.point3dArray&&(this.point3dArray=[]);var r=new ur(t,e,i);return this.point3dArray.push(r),r},yr.prototype.addPoint3dArray=function(t){void 0!==t&&(void 0===this.point3dArray&&(this.point3dArray=[]),this.point3dArray.push.apply(this.point3dArray,t))},yr.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new H);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},yr.prototype.makeVbo=function(t){this.point3dArray&&0!==this.point3dArray.length&&(this.vboKeysContainer=fr.getVbo(t,this.point3dArray,this.vboKeysContainer))},yr.prototype.renderLines=function(t,e,i,r,o){if(void 0===this.point3dArray)return!1;var n=t.sceneState.gl;if(void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()||this.makeVbo(t),e.enableVertexAttribArray(e.position3_loc),n.uniform1i(e.bPositionCompressed_loc,!1),n.uniform1i(e.bUse1Color_loc,!0),n.uniform4fv(e.oneColor4_loc,[1,1,.1,1]),n.uniform1f(e.fixPointSize_loc,5),n.uniform1i(e.bUseFixPointSize_loc,!0),void 0===o&&(o=!0),o?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,e),2===i){var a=t.selectionManager,s=t.selectionColor,l=s.getAvailableColor(void 0),h=s.decodeColor3(l.r,l.g,l.b);a.setCandidateGeneral(h,this),n.uniform4fv(e.oneColor4_loc,[l.r/255,l.g/255,l.b/255,1])}var d=this.vboKeysContainer.vboCacheKeysArray[0];if(!d.bindDataPosition(e,t.vboMemoryManager))return!1;n.drawArrays(n.LINE_STRIP,0,d.vertexCount),n.enable(n.DEPTH_TEST)},yr.prototype.renderPoints=function(t){};var mr=function(){if(!(this instanceof mr))throw new Error(ot.CONSTRUCT_ERROR);this.shadowMeshesMadeCount=0};mr.prototype.reset=function(){this.shadowMeshesMadeCount=0};var xr=function(){if(!(this instanceof xr))throw new Error(ot.CONSTRUCT_ERROR);this.outerRing,this.innerRingsList};xr.prototype.newOuterRing=function(){return void 0===this.outerRing?this.outerRing=new Tr:this.outerRing.deleteObjects(),this.outerRing},xr.prototype.newInnerRing=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new Mr),this.innerRingsList.newRing()},xr.prototype.getInnerRingsList=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new Mr),this.innerRingsList},xr.prototype.deleteObjects=function(){this.outerRing&&(this.outerRing.deleteObjects(),this.outerRing=void 0),this.innerRingsList&&(this.innerRingsList.deleteObjects(),this.innerRingsList=void 0)},xr.prototype.hasHoles=function(){return void 0!==this.innerRingsList&&0!==this.innerRingsList.getRingsCount()},xr.prototype.getVBO=function(t){if(void 0===this.outerRing)return t;this.getGeneralPolygon(void 0).getVbo(t)},xr.prototype.getConvexFacesIndicesData=function(t){if(void 0===this.outerRing)return resultVbo;var e,i,r,o,n,a,s=this.getGeneralPolygon(void 0);if(void 0===t&&(t=[]),this.outerRing.polygon.point2dList.setIdxInList(),void 0!==this.innerRingsList)for(var l=this.innerRingsList.getRingsCount(),h=0;h<l;h++){this.innerRingsList.getRing(h).polygon.point2dList.setIdxInList()}var d=s.convexPolygonsArray.length;for(h=0;h<d;h++){e=[];for(var c=(i=s.convexPolygonsArray[h]).point2dList.getPointsCount(),u=0;u<c;u++)o=(r=(a=i.point2dList.getPoint(u)).indexData).owner,r.idxInList=a.idxInList,n=o===this.outerRing?-1:this.innerRingsList.getRingIndex(o),r.ownerIdx=n,e.push(r);t.push(e)}return t},xr.prototype.getGeneralPolygon=function(t){if(this.checkNormals(),this.hasHoles())t=this.tessellateHoles(t);else{void 0===t&&(t=new pr),void 0===t.point2dList&&(t.point2dList=new cr);for(var e=this.outerRing.polygon,i=e.point2dList.getPointsCount(),r=0;r<i;r++)e.point2dList.getPoint(r),t.point2dList.addPoint(e.point2dList.getPoint(r))}t.convexPolygonsArray=[];var o=t.calculateNormal(o);return t.convexPolygonsArray=t.tessellate(o,t.convexPolygonsArray),t},xr.prototype.eliminateHolePolygonBySplitPoints=function(t,e,i,r,o){void 0===o&&(o=new pr),void 0===o.point2dList&&(o.point2dList=new cr);for(var n,a=t.point2dList.getPointsCount(),s=!1,l=0,h=i;!s&&l<a;)n=t.point2dList.getPoint(h),o.point2dList.addPoint(n),(h=t.point2dList.getNextIdx(h))===i&&(s=!0,n=t.point2dList.getPoint(h),o.point2dList.addPoint(n)),l++;var d,c=e.point2dList.getPointsCount();for(s=!1,l=0,h=r;!s&&l<c;)d=e.point2dList.getPoint(h),o.point2dList.addPoint(d),(h=e.point2dList.getNextIdx(h))===r&&(s=!0,d=e.point2dList.getPoint(h),o.point2dList.addPoint(d)),l++;return o},xr.prototype.eliminateHolePolygon=function(t,e,i,r){for(var o,n,a=[],s=e.polygon,l=s.point2dList.getPoint(i),h=(a=t.getPointsIdxSortedByDistToPoint(l,a)).length,d=new wr,c=!1,u=0;!c&&u<h;)o=a[u],n=t.point2dList.getPoint(o),d.setPoints(n,l),t.intersectionWithSegment(d)||s.intersectionWithSegment(d)?u++:(r=this.eliminateHolePolygonBySplitPoints(t,s,o,i,r),c=!0,u++);return!!c},xr.prototype.tessellateHoles=function(t){if(void 0===this.outerRing)return t;if(!this.hasHoles())return t;var e,i,r,o,n,a;void 0===t&&(t=new pr);var s=this.outerRing;void 0===s.polygon&&s.makePolygon();for(var l=s.polygon,h=l.calculateNormal(h),d=[],c=this.innerRingsList.getRingsCount(),u=0;u<c;u++)d.push(this.innerRingsList.getRing(u));var f=new pr,g=new pr;g.point2dList=new cr;var p=l.point2dList.getPointsCount();for(u=0;u<p;u++)l.point2dList.getPoint(u),g.point2dList.addPoint(l.point2dList.getPoint(u));for(var v=new dr,y=[],m=(c=d.length,u=0,!1);!m&&u<c;){if(a=Mr.getBoundingRectangle(d,a),v.set(a.minX,a.minY),y.length=0,e=(o=(y=Mr.getSortedRingsByDistToPoint(v,d,y))[0]).ring,i=o.ringIdx,r=e.polygon,n=o.pointIdx,r.calculateNormal(),this.eliminateHolePolygon(g,e,n,f)){if(g=f,1===d.length){m=!0;break}d.splice(i,1),f=new pr}u++}return t=g},xr.prototype.checkNormals=function(){if(void 0!==this.outerRing){var t=this.outerRing;void 0===t.polygon&&t.makePolygon();var e=t.polygon,i=e.calculateNormal(i),r=e.normal;if(void 0!==this.innerRingsList)for(var o,n=this.innerRingsList.getRingsCount(),a=0;a<n;a++){var s,l;void 0===(o=this.innerRingsList.getRing(a)).polygon&&o.makePolygon(),(s=o.polygon).calculateNormal(),(l=s.normal)===r&&(s.reverseSense(),s.normal=-l)}}},xr.prototype.TEST__setFigure_1=function(){var t,e,i,r=this.newOuterRing();(t=r.newElement("POLYLINE")).newPoint2d(7,7),t.newPoint2d(0,7),t.newPoint2d(0,0),t.newPoint2d(7,0),(e=r.newElement("ARC")).setCenterPosition(7,3.5),e.setRadius(3.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(i=this.newInnerRing().newElement("RECTANGLE")).setCenterPosition(3,3),i.setDimensions(2,2)},xr.prototype.TEST__setFigure_2holes=function(){var t,e,i,r,o=this.newOuterRing();(t=o.newElement("POLYLINE")).newPoint2d(7,7),t.newPoint2d(0,7),t.newPoint2d(0,0),t.newPoint2d(7,0),(e=o.newElement("ARC")).setCenterPosition(7,3.5),e.setRadius(3.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24;var n=this.newInnerRing();(r=n.newElement("RECTANGLE")).setCenterPosition(3,3),r.setDimensions(2,2),(i=(n=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(7,3),i.setRadius(1)},xr.prototype.TEST__setFigureHole_2=function(){var t,e,i,r,o,n=this.newOuterRing();(t=n.newElement("POLYLINE")).newPoint2d(-13,3),t.newPoint2d(-13,-11),(e=n.newElement("ARC")).setCenterPosition(-8,-11),e.setRadius(5),e.setStartAngleDegree(180),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-8,-16),t.newPoint2d(-5,-16),t.newPoint2d(-3,-15),t.newPoint2d(-3,-14),t.newPoint2d(-5,-12),t.newPoint2d(-3,-11),t.newPoint2d(-2,-9),t.newPoint2d(3,-9),(e=n.newElement("ARC")).setCenterPosition(9,-9),e.setRadius(6),e.setStartAngleDegree(180),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(15,-9),t.newPoint2d(16,-9),t.newPoint2d(16,4),(e=n.newElement("ARC")).setCenterPosition(11,4),e.setRadius(5),e.setStartAngleDegree(0),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(11,9),t.newPoint2d(4,9),(e=n.newElement("ARC")).setCenterPosition(4,11),e.setRadius(2),e.setStartAngleDegree(-90),e.setSweepAngleDegree(-180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(4,13),t.newPoint2d(9,13),(e=n.newElement("ARC")).setCenterPosition(9,14.5),e.setRadius(1.5),e.setStartAngleDegree(-90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(9,16),t.newPoint2d(2,16),t.newPoint2d(0,14),t.newPoint2d(-4,16),t.newPoint2d(-9,16),(e=n.newElement("ARC")).setCenterPosition(-9,14),e.setRadius(2),e.setStartAngleDegree(90),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-9,12),t.newPoint2d(-6,12),(e=n.newElement("ARC")).setCenterPosition(-6,10.5),e.setRadius(1.5),e.setStartAngleDegree(90),e.setSweepAngleDegree(-180),e.numPointsFor360Deg=24,(t=n.newElement("POLYLINE")).newPoint2d(-6,9),t.newPoint2d(-7,9),(e=n.newElement("ARC")).setCenterPosition(-7,3),e.setRadius(6),e.setStartAngleDegree(90),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24;var a=this.newInnerRing();(t=a.newElement("POLYLINE")).newPoint2d(-9,3),t.newPoint2d(-10,-4),t.newPoint2d(-10,-8),t.newPoint2d(-8,-11),t.newPoint2d(-3,-7),t.newPoint2d(4,-7),(e=a.newElement("ARC")).setCenterPosition(8,-7),e.setRadius(4),e.setStartAngleDegree(180),e.setSweepAngleDegree(180),e.numPointsFor360Deg=24,(t=a.newElement("POLYLINE")).newPoint2d(12,-7),t.newPoint2d(12,-4),t.newPoint2d(8,-10),t.newPoint2d(4,-5),t.newPoint2d(-8,-5),t.newPoint2d(-7,4),t.newPoint2d(9,4),t.newPoint2d(9,-5),t.newPoint2d(14,2),t.newPoint2d(13,2),t.newPoint2d(11,0),t.newPoint2d(11,7),t.newPoint2d(13,8),t.newPoint2d(5,8),t.newPoint2d(9,6),t.newPoint2d(-6,6),(e=a.newElement("ARC")).setCenterPosition(-6,3),e.setRadius(3),e.setStartAngleDegree(90),e.setSweepAngleDegree(90),e.numPointsFor360Deg=24,(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-10,-13),i.setRadius(1),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-6.5,-14),o.setRadiusCount(5),o.setInteriorRadius(.6),o.setExteriorRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-9,14),o.setRadiusCount(6),o.setInteriorRadius(.5),o.setExteriorRadius(1.5),(r=(a=this.newInnerRing()).newElement("RECTANGLE")).setCenterPosition(-4.5,1.5),r.setDimensions(3,3),(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-4.5,-2.5),i.setRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(0,0),o.setRadiusCount(5),o.setInteriorRadius(1),o.setExteriorRadius(2.5),(i=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-6,14),i.setRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-1.5,11),o.setRadiusCount(12),o.setInteriorRadius(.6),o.setExteriorRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(13.5,5),o.setRadiusCount(25),o.setInteriorRadius(.4),o.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(9,-13),o.setRadiusCount(10),o.setInteriorRadius(.4),o.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(5.5,1.5),o.setRadiusCount(7),o.setInteriorRadius(.7),o.setExteriorRadius(2)};var br=function(){if(!(this instanceof br))throw new Error(ot.CONSTRUCT_ERROR);this.profilesArray,this.auxiliarAxis};br.prototype.newProfile=function(){void 0===this.profilesArray&&(this.profilesArray=[]);var t=new xr;return this.profilesArray.push(t),t},br.prototype.deleteObjects=function(){if(this.profilesArray){for(var t=this.profilesArray.length,e=0;e<t;e++)this.profilesArray[e].deleteObjects(),this.profilesArray=void 0;this.profilesArray=void 0}};var Cr=function(t,e){this.center=t.center||void 0,this.halfWidth=t.halfWidth||void 0,this.halfHeight=t.halfHeight||void 0,this.quatOwner=t.quatOwner||void 0,this.renderFunc=t.renderFunc||this.defaultRender,this.numberName,this.depth=0,this.children,this.data,this.dirty=!0,this.magoManager=e,this.displayPointsArray,this.realDatasCount,this.numberName,this.quatOwner||(this.numberName=1)};Cr.CHILDREN_CNT=4,Cr.getLimitDistByRadius=function(t){return 1.5*t},Cr.prototype.init=function(){this.children=void 0,this.data=void 0,this.dirty=!0,this.displayPointsArray=void 0,this.realDatasCount=void 0},Cr.prototype.hasChildren=function(){return this.children&&Array.isArray(this.children)&&this.children.length>0},Cr.prototype.hasData=function(){return this.data&&Array.isArray(this.data)&&this.data.length>0},Cr.prototype.getDisplayPoints=function(t){if(t||(t=[]),!this.displayPointsArray||0===this.displayPointsArray.length)if(this.hasChildren()){for(var e=this.children.length,i=[],r=new ur(0,0,0),o=0;o<e;o++)i=this.children[o].getDisplayPoints(i);var n=i.length,a=0;for(o=0;o<n;o++){var s=(c=i[o]).mass,l=new ur(c.x,c.y,c.z);l.scale(s),r.addPoint(l),a+=s}r.scale(1/a),r.mass=a,this.displayPointsArray=[],this.displayPointsArray.push(r)}else if(this.hasData()){var h=this.data.length,d=new ur(0,0,0);for(o=0;o<h;o++){var c=this.data[o];d.addPoint(Ei.geographicCoordToWorldPoint(c.x,c.y,0))}d.scale(1/h),d.mass=h,this.displayPointsArray=[],this.displayPointsArray.push(d)}return this.displayPointsArray&&t.push.apply(t,this.displayPointsArray),t},Cr.prototype.getQuatTreeByCamDistance=function(t,e){t||(t=[]),this.bSphereWC||this.makeBSphereWC();var i=this.bSphereWC;if(e.distToSphere(i)<Cr.getLimitDistByRadius(i.getRadius()))if(this.children)for(var r=this.children.length,o=0;o<r;o++){this.children[o].getQuatTreeByCamDistance(t,e)}else this.data&&t.push(this);else this.displayPointsArray&&t.push(this);return t},Cr.prototype.makeBSphereWC=function(){var t=this.center,e=this.center.x+this.halfWidth,i=this.center.y+this.halfHeight,r=new dr(e,i),o=Ei.geographicCoordToWorldPoint(t.x,t.y,0),n=Ei.geographicCoordToWorldPoint(r.x,r.y,0),a=o.distToPoint(n);this.bSphereWC=new m(o.x,o.y,o.z,a)},Cr.prototype.setData=function(t){this.data||(this.data=[]);for(var e=t.length,i=0;i<e;i++){var r=t[i];this.pushData(r)}},Cr.prototype.pushData=function(t){var e=this.magoManager.sceneState.modelViewProjMatrix.transformPoint4D__test([t.x,t.y,t.z,1]),i=e[3],r=e[0]/i,o=e[1]/i;if(r<1&&r>-1&&o<1&&o>-1){var n=new dr(r,o);n.orgPos=t,this.data.push(n)}},Cr.prototype.addPoint2DToChild=function(t){var e,i=t.x,r=t.y,o=this.center;e=i<o.x?r<o.y?0:3:r<o.y?1:2,this.children||this.createChildren(),this.children[e].data||(this.children[e].data=[]),this.children[e].data.push(t)},Cr.prototype.createChildren=function(){this.children=[];var t={};t.quatOwner=this;var e=this.center.x-this.halfWidth,i=this.center.y-this.halfHeight,r=this.center.x+this.halfWidth,o=this.center.y+this.halfHeight,n=this.center.x,a=this.center.y,s=new Cr(t,this.magoManager);s.depth=this.depth+1,s.numberName=10*this.numberName+1,s.setSize(e,i,n,a);var l=new Cr(t,this.magoManager);l.depth=this.depth+1,l.numberName=10*this.numberName+2,l.setSize(n,i,r,a);var h=new Cr(t,this.magoManager);h.depth=this.depth+1,h.numberName=10*this.numberName+3,h.setSize(n,a,r,o);var d=new Cr(t,this.magoManager);d.depth=this.depth+1,d.numberName=10*this.numberName+4,d.setSize(e,a,n,o),this.children.push(s),this.children.push(l),this.children.push(h),this.children.push(d)},Cr.prototype.setSize=function(t,e,i,r){var o=(i+t)/2,n=(r+e)/2;this.center=new dr(o,n),this.halfWidth=(i-t)/2,this.halfHeight=(r-e)/2},Cr.prototype.makeTreeByDepth=function(t){if(!(this.depth>=t)){if(this.data){for(var e=this.data.length,i=0;i<e;i++){var r=this.data[i];this.addPoint2DToChild(r)}delete this.data}if(this.children){var o=this.children.length;for(i=0;i<o;i++)this.children[i].makeTreeByDepth(t)}this.dirty=!1}},Cr.prototype.extractLeaf=function(t){if(t&&Array.isArray(t)||(t=[]),this.data&&this.data.length>0&&t.push(this),this.children)for(var e=this.children.length,i=0;i<e;i++)this.children[i].extractLeaf(t);return t},Cr.prototype.defaultRender=function(t){if(t){this.magoManager.objMarkerManager.objectMarkerArray=[];for(var e=t.length,i=0;i<e;i++){for(var r=t[i].data,o=new y,n=r.length,a=0;a<n;a++){var s=r[a];0===a?o.init(s.orgPos):o.addPoint(s.orgPos)}var l=o.getCenterPoint();n>50&&(n=50);var h=n,d=n;h<5&&(h=5),d<5&&(d=5);var c={positionWC:new ur(l.x,l.y,l.z),imageFilePath:"defaultBlue",imageFilePathSelected:"defaultRed",sizeX:h,sizeY:d};this.magoManager.objMarkerManager.newObjectMarker(c,this.magoManager)}}};var Ar=function(){if(!(this instanceof Ar))throw new Error(ot.CONSTRUCT_ERROR);this.centerPoint,this.width,this.height,this.minX,this.minY,this.maxX,this.maxY};Ar.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new dr),this.centerPoint.set(t,e)},Ar.prototype.setExtension=function(t,e,i,r){this.minX=t,this.minY=e,this.maxX=i,this.maxY=r},Ar.prototype.setDimensions=function(t,e){this.width=t,this.height=e},Ar.prototype.getCenterPosition=function(){return this.centerPoint},Ar.prototype.getWidth=function(){return this.width},Ar.prototype.getHeight=function(){return this.height},Ar.prototype.getMaxPoint=function(t){return void 0===t&&(t=new dr),t.set(this.maxX,this.maxY),t},Ar.prototype.getMinPoint=function(t){return void 0===t&&(t=new dr),t.set(this.minX,this.minY),t},Ar.prototype.getPoints=function(t){if(void 0===this.centerPoint||void 0===this.width||void 0===this.height)return t;var e;void 0===t&&(t=[]);var i=this.width/2,r=this.height/2;return(e=new dr(this.centerPoint.x-i,this.centerPoint.y-r)).pointType=1,t.push(e),(e=new dr(this.centerPoint.x+i,this.centerPoint.y-r)).pointType=1,t.push(e),(e=new dr(this.centerPoint.x+i,this.centerPoint.y+r)).pointType=1,t.push(e),(e=new dr(this.centerPoint.x-i,this.centerPoint.y+r)).pointType=1,t.push(e),t};var Tr=function(){if(!(this instanceof Tr))throw new Error(ot.CONSTRUCT_ERROR);this.elemsArray=[],this.polygon=void 0,this.isOpen};Tr.prototype.getElement=function(t){return 0===this.elemsArray.length?null:this.elemsArray[t]},Tr.prototype.deleteObjects=function(){for(var t=0,e=this.elemsArray.length;t<e;t++)this.elemsArray[t].deleteObjects();this.elemsArray=[],void 0!==this.polygon&&this.polygon.deleteObjects(),this.polygon=void 0},Tr.prototype.addElement=function(t){this.elemsArray.push(t)},Tr.prototype.newElement=function(t){var e=void 0;return"ARC"===t?e=new Ii:"CIRCLE"===t?e=new Vi:"POLYLINE"===t?e=new vr:"RECTANGLE"===t?e=new Ar:"STAR"===t&&(e=new Rr),this.elemsArray.push(e),e},Tr.prototype.makePolygon=function(){return this.polygon=this.getPolygon(this.polygon),this.polygon},Tr.prototype.getPolygon=function(t){var e;void 0===t&&(t=new pr),void 0===t.point2dList&&(t.point2dList=new cr),t.point2dList.deleteObjects(),t.point2dList.pointsArray=this.getPoints(t.point2dList.pointsArray);for(var i=t.point2dList.getPointsCount(),r=0;r<i;r++)(e=t.point2dList.getPoint(r)).indexData=new Wi,e.indexData.owner=this;return t},Tr.prototype.getPoints=function(t){void 0===t&&(t=[]);for(var e=0,i=this.elemsArray.length;e<i;e++)this.elemsArray[e].getPoints(t);var r=t.length;if(r>1){var o=t[0],n=t[r-1];n.pointType=1,o.isCoincidentToPoint(n,1e-7)&&((n=t.pop()).deleteObjects(),n=void 0)}return t};var Mr=function(){if(!(this instanceof Mr))throw new Error(ot.CONSTRUCT_ERROR);this.ringsArray=[],this.idxInList};Mr.prototype.newRing=function(){var t=new Tr;return this.ringsArray.push(t),t},Mr.prototype.addRing=function(t){this.ringsArray.push(t)},Mr.prototype.deleteObjects=function(){for(var t=0,e=this.ringsArray.length;t<e;t++)this.ringsArray[t].deleteObjects(),this.ringsArray[t]=void 0;this.ringsArray=[]},Mr.prototype.getRingsCount=function(){return this.ringsArray.length},Mr.prototype.getRingIndex=function(t){return this.ringsArray.indexOf(t)},Mr.prototype.getRing=function(t){return this.ringsArray[t]},Mr.getBoundingRectangle=function(t,e){var i,r;void 0===e&&(e=new Fi);for(var o=0,n=t.length;o<n;o++)void 0!==(i=t[o]).polygon&&(r=i.polygon.getBoundingRectangle(r),e.addRectangle(r));return e},Mr.prototype.setIdxInList=function(){for(var t=0,e=this.ringsArray.length;t<e;t++)this.ringsArray[t].idxInList=t},Mr.prototype.intersectionWithSegment=function(t){if(void 0===t)return!1;for(var e=0,i=!1,r=this.getRingsCount();!i&&e<r;)this.ringsArray[e].intersectionWithSegment(t)&&(i=!0),e++;return i},Mr.getSortedRingsByDistToPoint=function(t,e,i){if(void 0===t)return i;void 0===i&&(i=[]);for(var r,o,n,a,s,l,h,d=[],c=0,u=e.length;c<u;c++)o=(r=e[c]).polygon.point2dList.getNearestPointIdxToPoint(t),n=r.polygon.point2dList.getPoint(o).squareDistToPoint(t),(a={}).ring=r,a.ringIdx=c,a.pointIdx=o,a.squaredDist=n,s=0,l=d.length-1,h=Mr.getIndexToInsertBySquaredDist(d,a,s,l),d.splice(h,0,a);for(c=0,u=d.length;c<u;c++)i.push(d[c]);return i},Mr.getIndexToInsertBySquaredDist=function(t,e,i,r){var o=r-i;if(0===t.length)return 0;if(o<6){for(var n,a=!1,s=i;!a&&s<=r;)e.squaredDist<t[s].squaredDist&&(n=s,a=!0),s++;return a?n:r+1}var l,h,d=i+Math.floor(o/2);return t[d].squaredDist>e.squaredDist?(l=i,h=d):(l=d,h=r),this.getIndexToInsertBySquaredDist(t,e,l,h)},Mr.getBinarySearchIndex=function(t,e,i){var r=0,o=t.length-1;for(i=i||function(t){return t};r<=o;){var n=Math.floor((r+o)/2);i(t[n])<i(e)?r=n+1:o=n-1}return r};var Pr=function(t){if(!(this instanceof Pr))throw new Error(ot.CONSTRUCT_ERROR);this.vboCacheKey,this.init(t)};Pr.prototype.init=function(t){var e=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.vboCacheKey=new Ft;this.vboCacheKey.setDataArrayPos(e,t,2)},Pr.prototype.render=function(t,e){var i=t.getGl();this.vboCacheKey.bindDataPosition(e,t.vboMemoryManager)&&i.drawArrays(i.TRIANGLES,0,6)};var wr=function(t,e){if(!(this instanceof wr))throw new Error(ot.CONSTRUCT_ERROR);this.startPoint2d,this.endPoint2d,t&&(this.startPoint2d=t),e&&(this.endPoint2d=e)};wr.prototype.setPoints=function(t,e){void 0!==t&&(this.startPoint2d=t),void 0!==e&&(this.endPoint2d=e)},wr.prototype.getVector=function(t){if(void 0!==this.startPoint2d&&void 0!==this.endPoint2d)return void 0===t&&(t=new dr),t=this.startPoint2d.getVectorToPoint(this.endPoint2d,t)},wr.prototype.getDirection=function(t){return void 0===t&&(t=new dr),(t=this.getVector(t)).unitary(),t},wr.prototype.getBoundaryRectangle=function(t){return void 0===t&&(t=new BoundaryRectangle),t.setInit(this.startPoint2d),t.addPoint(this.endPoint2d),t},wr.prototype.getLine=function(t){void 0===t&&(t=new Ki);var e=this.getDirection(),i=this.startPoint2d;return t.setPointAndDir(i.x,i.y,e.x,e.y),t},wr.prototype.getSquaredLength=function(){return this.startPoint2d.squareDistToPoint(this.endPoint2d)},wr.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},wr.prototype.intersectionWithPointByDistances=function(t,e){if(void 0!==t){void 0===e&&(e=1e-7);var i=this.startPoint2d.distToPoint(t),r=this.endPoint2d.distToPoint(t),o=this.getLength();return i<e?u.INTERSECTION_POINT_A:r<e?u.INTERSECTION_POINT_B:i>o||r>o?u.INTERSECTION_OUTSIDE:Math.abs(i+r-o)<e?u.INTERSECTION_INSIDE:void 0}},wr.prototype.intersectionWithPoint=function(t,e){if(void 0!==t)return void 0===e&&(e=1e-7),this.getLine().isCoincidentPoint(t,e)?this.intersectionWithPointByDistances(t,e):u.INTERSECTION_OUTSIDE},wr.prototype.intersectionWithSegment=function(t,e){if(void 0!==t){void 0===e&&(e=1e-7);var i=this.getLine(),r=t.getLine(),o=i.intersectionWithLine(r);if(void 0!==o){var n=this.intersectionWithPointByDistances(o),a=t.intersectionWithPointByDistances(o);return n===u.INTERSECTION_OUTSIDE?u.INTERSECTION_OUTSIDE:a===u.INTERSECTION_OUTSIDE?u.INTERSECTION_OUTSIDE:u.INTERSECTION_INTERSECT}}},wr.prototype.hasPoint=function(t){return void 0!==t&&(t===this.startPoint2d||t===this.endPoint2d)},wr.prototype.sharesPointsWithSegment=function(t){return void 0!==t&&!(!this.hasPoint(t.startPoint2d)&&!this.hasPoint(t.endPoint2d))};var _r=function(t,e){if(!(this instanceof _r))throw new Error(ot.CONSTRUCT_ERROR);this.startPoint3d,this.endPoint3d,t&&(this.startPoint3d=t),e&&(this.endPoint3d=e)};_r.getVboThickLines=function(t,e,i){if(void 0===e)return i;void 0===i&&(i=new Nt);for(var r,o,n,a=e.length,s=new Float32Array(4*(2*a)*4),l=0;l<a;l++)o=(r=e[l]).startPoint3d,n=r.endPoint3d,s[32*l]=o.x,s[32*l+1]=o.y,s[32*l+2]=o.z,s[32*l+3]=1,s[32*l+4]=o.x,s[32*l+5]=o.y,s[32*l+6]=o.z,s[32*l+7]=-1,s[32*l+8]=o.x,s[32*l+9]=o.y,s[32*l+10]=o.z,s[32*l+11]=2,s[32*l+12]=o.x,s[32*l+13]=o.y,s[32*l+14]=o.z,s[32*l+15]=-2,s[32*l+16]=n.x,s[32*l+17]=n.y,s[32*l+18]=n.z,s[32*l+19]=1,s[32*l+20]=n.x,s[32*l+21]=n.y,s[32*l+22]=n.z,s[32*l+23]=-1,s[32*l+24]=n.x,s[32*l+25]=n.y,s[32*l+26]=n.z,s[32*l+27]=2,s[32*l+28]=n.x,s[32*l+29]=n.y,s[32*l+30]=n.z,s[32*l+31]=-2;return i.newVBOVertexIdxCacheKey().setDataArrayPos(s,t.vboMemoryManager,4),i},_r.prototype.intersectionWithPoint=function(t,e){if(void 0===t)return!1;void 0===e&&(e=1e-7);var i=this.getLength()-this.startPoint3d.distToPoint(t)-this.endPoint3d.distToPoint(t);return Math.abs(i)<e},_r.prototype.getLine=function(t){void 0===t&&(t=new Yi);var e=this.getDirection();return t.setPointAndDir(this.startPoint3d.x,this.startPoint3d.y,this.startPoint3d.z,e.x,e.y,e.z),t},_r.prototype.setPoints=function(t,e){t&&(this.startPoint3d=t),e&&(this.endPoint3d=e)},_r.prototype.getVector=function(t){if(void 0!==this.startPoint3d&&void 0!==this.endPoint3d)return void 0===t&&(t=new ur),t=this.startPoint3d.getVectorToPoint(this.endPoint3d,t)},_r.prototype.getDirection=function(t){return void 0===t&&(t=new ur),(t=this.getVector(t)).unitary(),t},_r.prototype.invertSense=function(){var t=this.startPoint3d;this.startPoint3d=this.endPoint3d,this.endPoint3d=t},_r.prototype.getLength=function(){return this.startPoint3d.distToPoint(this.endPoint3d)};var Sr=function(){if(!(this instanceof Sr))throw new Error(ot.CONSTRUCT_ERROR);this.name,this.id,this.mesh},Lr=function(){if(!(this instanceof Lr))throw new Error(ot.CONSTRUCT_ERROR);this.ellipsoid};Lr.prototype.render=function(t,e,i,r){if(void 0!==this.ellipsoid){var o=t.getGl();o.uniform3fv(e.buildingPosHIGH_loc,this.ellipsoid.terrainPositionHIGH),o.uniform3fv(e.buildingPosLOW_loc,this.ellipsoid.terrainPositionLOW);a=W.equatorialRadius(),s=W.polarRadius()+n;o.uniform1f(e.equatorialRadius_loc,a),o.depthRange(1,1),o.enable(o.BLEND),this.ellipsoid.render(t,e,i,r),o.depthRange(0,1),o.disable(o.BLEND)}else{var n=15e4,a=W.equatorialRadius()+n,s=W.polarRadius()+n;this.ellipsoid=new Ne(a,a,s);this.ellipsoid.makeMesh({bLoopColumns:!1,bTrianglesSenseCCW:!1});var l=t.vboMemoryManager;this.ellipsoid.makeVbo(l)}};var Rr=function(){if(!(this instanceof Rr))throw new Error(ot.CONSTRUCT_ERROR);this.centerPoint,this.interiorRadius,this.exteriorRadius,this.radiusCount};Rr.prototype.setCenterPosition=function(t,e){void 0===this.centerPoint&&(this.centerPoint=new dr),this.centerPoint.set(t,e)},Rr.prototype.setInteriorRadius=function(t){this.interiorRadius=t},Rr.prototype.setExteriorRadius=function(t){this.exteriorRadius=t},Rr.prototype.setRadiusCount=function(t){this.radiusCount=t},Rr.prototype.getPoints=function(t){var e,i,r,o=360/this.radiusCount*Math.PI/180,n=o/2,a=90*Math.PI/180;void 0===t&&(t=[]);for(var s=0;s<this.radiusCount;s++)i=this.centerPoint.x+this.exteriorRadius*Math.cos(a),r=this.centerPoint.y+this.exteriorRadius*Math.sin(a),(e=new dr(i,r)).pointType=1,t.push(e),i=this.centerPoint.x+this.interiorRadius*Math.cos(a+n),r=this.centerPoint.y+this.interiorRadius*Math.sin(a+n),(e=new dr(i,r)).pointType=1,t.push(e),a+=o;return t};var Dr=function(){if(!(this instanceof Dr))throw new Error(ot.CONSTRUCT_ERROR);this.guid="",this.buildingFolderName="",this.projectFolderName="",this.neoBuilding=void 0},Er=function(){if(!(this instanceof Er))throw new Error(ot.CONSTRUCT_ERROR);this.staticModelsMap={}};Er.prototype.addStaticModel=function(t,e){this.staticModelsMap[t]=e},Er.prototype.getStaticModel=function(t){var e=this.staticModelsMap[t];if(void 0===e)throw new Error("StaticModel is not exist.");return e},Er.manageStaticModel=function(t,e){var i=t.data.attributes;if(void 0!==i){var r,o=t.data.neoBuilding;if(void 0!==i.projectId&&void 0!==i.isReference&&!0===i.isReference)if(void 0===o){var n=i.buildingFolderName;r=i.projectFolderName;var a=i.projectId,s=e.hierarchyManager.getStaticModelsManager().getStaticModel(a);o=s.neoBuilding,n=s.buildingFolderName,r=s.projectFolderName;var l=new x;l.fisrtName=n,l.name=n,l.buildingId=n,l.buildingFileName=n,l.geographicCoord=new j(i.longitude,i.latitude,i.height),l.rotationsDegree=new ur(i.pitch,i.roll,i.heading),l.bBox=new y,l.bBox.init(),l.bBox.expand(10),l.geographicCoordOfBBox=new j(i.longitude,i.latitude,i.height),l.smartTileOwner,o.buildingFileName=n,o.nodeOwner=t,t.data.neoBuilding=o,t.data.buildingSeed=l,t.data.projectFolderName=r,void 0===o.metaData&&(o.metaData=new Jt,void 0===o.metaData.geographicCoord&&(o.metaData.geographicCoord=new j),void 0===o.metaData.bbox&&(o.metaData.bbox=new y),o.metaData.geographicCoord.setLonLatAlt(l.geographicCoord.longitude,l.geographicCoord.latitude,l.geographicCoord.altitude),o.metaData.bbox.copyFrom(l.bBox),o.metaData.heading=l.rotationsDegree.z,o.metaData.pitch=l.rotationsDegree.x,o.metaData.roll=l.rotationsDegree.y),o.name="test_"+n,o.buildingId=n,o.buildingType="basicBuilding",void 0===o.bbox&&(o.bbox=new y),o.bbox.copyFrom(l.bBox),o.projectFolderName=t.data.projectFolderName}}};var Ir=function(t){if(!(this instanceof Ir))throw new Error(ot.CONSTRUCT_ERROR);this.id,this.name,this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0,void 0!==t&&(void 0!==t.id&&(this.id=t.id),void 0!==t.name&&(this.name=t.name))};Ir.prototype.deleteObjects=function(){for(var t=0,e=this.facesArray.length;t<e;t++)this.facesArray[t].deleteObjects(),this.facesArray[t]=void 0;this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0},Ir.prototype.newFace=function(){var t=new Gi;return this.facesArray.push(t),t},Ir.prototype.getFacesCount=function(){return this.facesArray.length},Ir.prototype.getFace=function(t){return this.facesArray[t]},Ir.prototype.setColor=function(t,e,i,r){for(var o=0,n=this.getFacesCount();o<n;o++)this.getFace(o).setColor(t,e,i,r)},Ir.prototype.addFacesArray=function(t){void 0!==t&&Array.prototype.push.apply(this.facesArray,t)},Ir.prototype.getFrontierHalfEdges=function(t){if(void 0===this.facesArray)return t;t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getFrontierHalfEdges(t);return t},Ir.prototype.getAnyFrontierHalfEdge=function(){if(void 0!==this.facesArray)for(var t=[],e=0,i=this.getFacesCount();e<i;e++)if((t=this.getFace(e).getFrontierHalfEdges(t)).length>0)return t[0]},Ir.prototype.getFrontierPolyline=function(t){var e=this.getAnyFrontierHalfEdge();if(void 0!==e){void 0===t&&(t=new yr);for(var i=e.startVertex.point3d,r=(t.newPoint3d(i.x,i.y,i.z),e.getNextFrontier());void 0!==r&&r!==e;)i=r.startVertex.point3d,t.newPoint3d(i.x,i.y,i.z),r=r.getNextFrontier();return t}},Ir.prototype.getHalfEdges=function(t){t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getHalfEdgesLoop(t);return t},Ir.prototype.getCopyIndependentSurface=function(t){void 0===t&&(t=new Ir),void 0===t.localVertexList&&(t.localVertexList=new Ur);var e,i=t.localVertexList;t.id=this.id,t.name=this.name;for(var r,o,n,a=this.getNoRepeatedVerticesArray(),s=a.length,l=0;l<s;l++)(e=a[l]).setIdxInList(l),i.newVertex().copyFrom(e);var h=this.getFacesCount();for(l=0;l<h;l++){r=this.getFace(l),(o=t.newFace()).vertexArray=[],s=r.getVerticesCount();for(var d=0;d<s;d++)n=(e=r.getVertex(d)).getIdxInList(),o.vertexArray.push(i.getVertex(n));o.createHalfEdges([])}return t.setTwinsFaces(),t},Ir.setTwinsFacesBetweenFaceAndFacesArrays=function(t,e,i){if(void 0===e)return!1;for(var r=!1,o=0,n=e.length;o<n;o++)if(e[o].setTwinFace(t)&&(r=!0,i))return!0;return r},Ir.setTwinsFacesBetweenFacesArrays_regularQuadGrid=function(t,e){if(void 0===t||void 0===e)return!1;for(var i,r,o=0,n=t.length-1;o<n;o++)i=t[o],r=e[o+1],i.setTwinFace(r)||(i=t[o+1],r=e[o],i.setTwinFace(r)||(i=t[o],r=e[o],i.setTwinFace(r)||(i=t[o+1],r=e[o+1],i.setTwinFace(r))))},Ir.prototype.setTwinsFaces=function(){for(var t,e,i=this.facesArray.length,r=0;r<i;r++){t=this.getFace(r);for(var o=r+1;o<i;o++)r!==o&&(e=this.getFace(o),t.setTwinFace(e))}},Ir.prototype.getNoRepeatedVerticesArray=function(t){var e,i;t=t||[];for(var r=0,o=this.getFacesCount(),n=0;n<o;n++)for(var a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)(i=e.getVertex(a)).setIdxInList(r),r++;var l,h={};for(n=0;n<o;n++)for(a=0,s=(e=this.getFace(n)).getVerticesCount();a<s;a++)h[(i=e.getVertex(a)).getIdxInList().toString()]=i;for(var d in h)Object.prototype.hasOwnProperty.call(h,d)&&(l=h[d],t.push(l));return t},Ir.prototype.getTrianglesConvex=function(t){t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getTrianglesConvex(t);return t},Ir.prototype.getTriangles=function(t){t=t||[];for(var e=0,i=this.getFacesCount();e<i;e++)t=this.getFace(e).getTessellatedTriangles(t);return t},Ir.prototype.calculateVerticesNormals=function(t){for(var e=this.getFacesCount(),i=0;i<e;i++)this.getFace(i).calculateVerticesNormals(t)},Ir.prototype.calculateTexCoordsBox=function(t){for(var e=this.getFacesCount(),i=0;i<e;i++)this.getFace(i).calculateTexCoordsBox(t)},Ir.prototype.reverseSense=function(){for(var t=this.getFacesCount(),e=0;e<t;e++)this.getFace(e).reverseSense()};var Or=function(t,e,i){if(!(this instanceof Or))throw new Error(ot.CONSTRUCT_ERROR);this.vertex0,this.vertex1,this.vertex2,this.vtxIdx0,this.vtxIdx1,this.vtxIdx2,this.normal,void 0!==t&&(this.vertex0=t),void 0!==e&&(this.vertex1=e),void 0!==i&&(this.vertex2=i),this.hEdge};Or.prototype.deleteObjects=function(){this.vertex0&&(this.vertex0=void 0),this.vertex1&&(this.vertex1=void 0),this.vertex2&&(this.vertex2=void 0),this.normal&&(this.normal.deleteObjects(),this.normal=void 0),this.vtxIdx0=void 0,this.vtxIdx1=void 0,this.vtxIdx2=void 0},Or.prototype.setVertices=function(t,e,i){this.vertex0=t,this.vertex1=e,this.vertex2=i},Or.prototype.assignVerticesIdx=function(){void 0!==this.vertex0&&void 0!==this.vertex1&&void 0!==this.vertex2&&(this.vtxIdx0=this.vertex0.getIdxInList(),this.vtxIdx1=this.vertex1.getIdxInList(),this.vtxIdx2=this.vertex2.getIdxInList())},Or.prototype.getIndicesArray=function(t){return void 0===t&&(t=[]),void 0!==this.vtxIdx0&&void 0!==this.vtxIdx1&&void 0!==this.vtxIdx2&&(t.push(this.vtxIdx0),t.push(this.vtxIdx1),t.push(this.vtxIdx2)),t},Or.prototype.invertSense=function(){var t=this.vertex1;this.vertex1=this.vertex2,this.vertex2=t,this.calculatePlaneNormal()},Or.prototype.calculatePlaneNormal=function(){void 0===this.normal&&(this.normal=new ur),this.getCrossProduct(0,this.normal),this.normal.unitary()},Or.calculateNormal=function(t,e,i,r){var o=t,n=i,a=e,s=new ur(o.x-n.x,o.y-n.y,o.z-n.z),l=new ur(a.x-o.x,a.y-o.y,a.z-o.z);return s.unitary(),l.unitary(),void 0===r&&(r=new ur),(r=s.crossProduct(l,r)).unitary(),r},Or.prototype.getPlaneNormal=function(){return void 0===this.normal&&this.calculatePlaneNormal(),this.normal},Or.prototype.getCrossProduct=function(t,e){var i,r,o;void 0===e&&(e=new ur),0===t?(i=this.vertex0.point3d,r=this.vertex2.point3d,o=this.vertex1.point3d):1===t?(i=this.vertex1.point3d,r=this.vertex0.point3d,o=this.vertex2.point3d):2===t&&(i=this.vertex2.point3d,r=this.vertex1.point3d,o=this.vertex0.point3d);var n=new ur,a=new ur;return n.set(i.x-r.x,i.y-r.y,i.z-r.z),a.set(o.x-i.x,o.y-i.y,o.z-i.z),n.unitary(),a.unitary(),e=n.crossProduct(a,e)},Or.prototype.getBoundingBox=function(t){return void 0===t&&(t=new y),t.init(this.vertex0.getPosition()),t.addPoint(this.vertex1.getPosition()),t.addPoint(this.vertex2.getPosition()),t},Or.prototype.getPlane=function(t){void 0===t&&(t=new ut);var e=this.vertex0.getPosition(),i=this.getPlaneNormal();return t.setPointAndNormal(e.x,e.y,e.z,i.x,i.y,i.z),t},Or.prototype.getSegment=function(t,e){if(void 0!==t)return void 0===e&&(e=new _r),0===t?e.setPoints(this.vertex0.getPosition(),this.vertex1.getPosition()):1===t?e.setPoints(this.vertex1.getPosition(),this.vertex2.getPosition()):2===t&&e.setPoints(this.vertex2.getPosition(),this.vertex0.getPosition()),e};var Fr=function(t,e,i){if(!(this instanceof Fr))throw new Error(ot.CONSTRUCT_ERROR);this.point2d0,this.point2d1,this.point2d2,void 0!==t&&(this.point2d0=t),void 0!==e&&(this.point2d1=e),void 0!==i&&(this.point2d2=i)};Fr.prototype.setPoints=function(t,e,i){this.point2d0=t,this.point2d1=e,this.point2d2=i},Fr.sign=function(t,e,i){return(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y)},Fr.prototype.isPoint2dInside=function(t){var e=Fr.sign(t,this.point2d0,this.point2d1)<0,i=Fr.sign(t,this.point2d1,this.point2d2)<0,r=Fr.sign(t,this.point2d2,this.point2d0)<0;return e===i&&i===r};var Nr=function(){if(!(this instanceof Nr))throw new Error(ot.CONSTRUCT_ERROR);this.trianglesArray=[]};Nr.prototype.newTriangle=function(t,e,i){var r=new Or(t,e,i);return this.trianglesArray.push(r),r},Nr.prototype.addTriangle=function(t){this.trianglesArray.push(t)},Nr.prototype.deleteObjects=function(){for(var t=this.getTrianglesCount(),e=0;e<t;e++)this.trianglesArray[e].deleteObjects(),this.trianglesArray[e]=void 0;this.trianglesArray=[]},Nr.prototype.getTrianglesCount=function(){return this.trianglesArray.length},Nr.prototype.getTriangle=function(t){return this.trianglesArray[t]},Nr.prototype.assignVerticesIdx=function(){Nr.assignVerticesIdx(this.trianglesArray)},Nr.assignVerticesIdx=function(t){if(void 0!==t)for(var e=t.length,i=(t=t,0);i<e;i++)t[i].assignVerticesIdx()},Nr.getTrianglesIndicesArray=function(t,e){var i=t.length;void 0===e&&(e=new Uint16Array(3*i));for(var r=0;r<i;r++)e[3*r]=t[r].vtxIdx0,e[3*r+1]=t[r].vtxIdx1,e[3*r+2]=t[r].vtxIdx2;return e},Nr.prototype.getNoRepeatedVerticesArray=function(t){return t=Nr.getNoRepeatedVerticesArray(this.trianglesArray,t)},Nr.getNoRepeatedVerticesArray=function(t,e){var i;void 0===e&&(e=[]);for(var r,o,n,a=0,s=t.length,l=0;l<s;l++)r=(i=t[l]).vertex0,o=i.vertex1,n=i.vertex2,r.setIdxInList(a),a++,o.setIdxInList(a),a++,n.setIdxInList(a),a++;var h,d={};for(l=0;l<s;l++)r=(i=t[l]).vertex0,o=i.vertex1,n=i.vertex2,d[r.getIdxInList().toString()]=r,d[o.getIdxInList().toString()]=o,d[n.getIdxInList().toString()]=n;for(var c in d)Object.prototype.hasOwnProperty.call(d,c)&&(h=d[c],e.push(h));return e},Nr.getVboFaceDataArray=function(t,e,i){if(void 0===e&&(e=new Ft),void 0===t)return e;if(0===t.length)return e;var r=Nr.getTrianglesIndicesArray(t,void 0);return e.setDataArrayIdx(r,i),e};var Br=function(){if(!(this instanceof Br))throw new Error(ot.CONSTRUCT_ERROR);this.trianglesListsArray=[]};Br.prototype.deleteObjects=function(){for(var t=this.trianglesListsArray.length,e=0;e<t;e++)this.trianglesListsArray[e].deleteObjects(),this.trianglesListsArray[e]=void 0;this.trianglesListsArray=[]},Br.prototype.getTrianglesList=function(t){return this.trianglesListsArray[t]},Br.prototype.getTrianglesListsCount=function(){return this.trianglesListsArray.length},Br.prototype.newTrianglesList=function(){var t=new Nr;return this.trianglesListsArray.push(t),t},Br.prototype.assignVerticesIdx=function(){for(var t=this.trianglesListsArray.length,e=0;e<t;e++)this.trianglesListsArray[e].assignVerticesIdx()},Br.prototype.getVboFaceDataArray=function(t){for(var e=[],i=this.trianglesListsArray.length,r=0;r<i;r++)e=this.trianglesListsArray[r].getTrianglesIndicesArray(e);return t.idxVboDataArray=Int16Array.from(e),t.indicesCount=t.idxVboDataArray.length,t};var Vr=function(){if(!(this instanceof Vr))throw new Error(ot.CONSTRUCT_ERROR);this.geoCoordsListPath,this.geoCoordsListProfile,this.geoLocDataManager,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges};Vr.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new H);var t=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default")),t},Vr.prototype.getPathGeographicCoordsList=function(){return void 0===this.geoCoordsListPath&&(this.geoCoordsListPath=new k,this.geoCoordsListPath.owner=this),this.geoCoordsListPath},Vr.prototype.getProfileGeographicCoordsList=function(){return void 0===this.geoCoordsListProfile&&(this.geoCoordsListProfile=new k,this.geoCoordsListProfile.owner=this),this.geoCoordsListProfile},Vr.prototype.renderPoints=function(t,e,i){if(void 0===this.geoCoordsListPath)return!1;this.renderTunnel(t,e,i),this.geoCoordsListPath.renderPoints(t,e,i,!1),this.geoCoordsListPath.renderLines(t,e,i,!1,!1)},Vr.prototype.renderMesh=function(t,e,i){if(void 0!==this.meshPositive){var r=t.sceneState.gl;this.getGeoLocationData().bindGeoLocationUniforms(r,e),this.meshPositive.render(t,e,i)}},Vr.prototype.renderTunnel=function(t,e,i){if(void 0!==this.meshPositive){var r=t.sceneState.gl;e.useProgram(),e.resetLastBuffersBinded(),e.enableVertexAttribArray(e.position3_loc),e.disableVertexAttribArray(e.color4_loc),e.enableVertexAttribArray(e.normal3_loc),e.disableVertexAttribArray(e.texCoord2_loc),e.bindUniformGenerals(),r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[1,1,.1,0]),r.uniform1i(e.bApplySsao_loc,!1),r.uniform1i(e.refMatrixType_loc,0),r.uniform1i(e.colorType_loc,1),r.uniform1i(e.bApplySpecularLighting_loc,!0),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.depthRange(0,1),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,e),r.colorMask(!1,!1,!1,!1),r.depthMask(!1),r.enable(r.CULL_FACE),r.enable(r.STENCIL_TEST),r.clearStencil(0);r.cullFace(r.FRONT),r.stencilFunc(r.ALWAYS,0,255),r.stencilOp(r.KEEP,r.INCR,r.KEEP),this.meshPositive.render(t,e,i,void 0),r.cullFace(r.BACK),r.stencilFunc(r.ALWAYS,0,255),r.stencilOp(r.KEEP,r.DECR,r.KEEP),this.meshPositive.render(t,e,i,void 0),r.uniform1i(e.colorType_loc,0),r.uniform4fv(e.oneColor4_loc,[222/255,184/255,135/255,1]),r.colorMask(!0,!0,!0,!0),r.depthMask(!0),r.stencilMask(0),r.stencilFunc(r.LEQUAL,1,255),r.stencilOp(r.REPLACE,r.REPLACE,r.REPLACE),r.cullFace(r.BACK),r.depthFunc(r.ALWAYS),this.meshNegative.render(t,e,i,void 0),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.disable(r.STENCIL_TEST),r.stencilOp(r.KEEP,r.KEEP,r.KEEP),r.disable(r.POLYGON_OFFSET_FILL),r.depthRange(0,1),r.useProgram(null),r.depthMask(!0),r.stencilMask(255)}},Vr.prototype.makeMesh=function(t){if(void 0===this.geoCoordsListPath||void 0===this.geoCoordsListProfile)return!1;var e=this.getGeoLocationData(),i=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(i),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Hr);var r=this.geoCoordsListPath.getWgs84Points3D(void 0),o=e.getTransformedRelativePositionsArray(r,void 0),n=new fr(o),a=n.getBisectionPlane(0,void 0,!1),s=new xr,l=s.newOuterRing(),h=l.newElement("CIRCLE");h.setCenterPosition(0,0),h.setRadius(15);l.getPoints([],24);var d=a.getRotationMatrix(void 0),c=n.getPoint(0);if(d.setTranslation(c.x,c.y,c.z),void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var u=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=u.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=u.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}},Vr.prototype.remakeMesh=function(t){if(void 0===this.vtxProfilesList)return!1;var e=this.getGeoLocationData(),i=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();e.copyFrom(i);var r=this.geoCoordsListPath.getWgs84Points3D(void 0),o=e.getTransformedRelativePositionsArray(r,void 0),n=new fr(o),a=n.getBisectionPlane(0,void 0,!1),s=new xr,l=s.newOuterRing(),h=l.newElement("CIRCLE");h.setCenterPosition(0,0),h.setRadius(15);l.getPoints([],24);var d=a.getRotationMatrix(void 0),c=n.getPoint(0);if(d.setTranslation(c.x,c.y,c.z),this.meshPositive=void 0,this.meshNegative=void 0,this.vtxProfilesList.deleteObjects(),this.vtxProfilesList=new Hr,void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var u=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=u.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=u.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,t.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,t.vboMemoryManager)}};var jr=function(t){if(!(this instanceof jr))throw new Error(ot.CONSTRUCT_ERROR);this.point3d,this.normal,this.texCoord,this.color4,this.outingHedge,this.vertexType,this.idxInList,this.point3d=t||new ur};jr.prototype.deleteObjects=function(){this.point3d&&this.point3d.deleteObjects(),this.normal&&this.normal.deleteObjects(),this.texCoord&&this.texCoord.deleteObjects(),this.color4&&this.color4.deleteObjects(),this.point3d=void 0,this.normal=void 0,this.texCoord=void 0,this.color4=void 0},jr.prototype.getIdxInList=function(){return this.idxInList},jr.prototype.setIdxInList=function(t){this.idxInList=t},jr.prototype.setVertexType=function(t){this.vertexType=t},jr.prototype.getVertexType=function(){return this.vertexType},jr.prototype.copyFrom=function(t){t.point3d&&(void 0===this.point3d&&(this.point3d=new ur),this.point3d.copyFrom(t.point3d)),t.normal&&(void 0===this.normal&&(this.normal=new ur),this.normal.copyFrom(t.normal)),t.texCoord&&(void 0===this.texCoord&&(this.texCoord=new dr),this.texCoord.copyFrom(t.texCoord)),t.color4&&(void 0===this.color4&&(this.color4=new _),this.color4.copyFrom(t.color4)),this.vertexType=t.vertexType},jr.prototype.getPosition=function(){return this.point3d},jr.prototype.setPosition=function(t,e,i){void 0===this.point3d&&(this.point3d=new ur),this.point3d.set(t,e,i)},jr.prototype.setTexCoord=function(t,e){void 0===this.texCoord&&(this.texCoord=new dr),this.texCoord.set(t,e)},jr.prototype.setColorRGB=function(t,e,i){void 0===this.color4&&(this.color4=new _),this.color4.setRGB(t,e,i)},jr.prototype.setColorRGBA=function(t,e,i,r){void 0===this.color4&&(this.color4=new _),this.color4.setRGBA(t,e,i,r)},jr.prototype.setNormal=function(t,e,i){void 0===this.normal&&(this.normal=new ur),this.normal.set(t,e,i)},jr.prototype.getNormal=function(){return void 0===this.normal&&(this.normal=new ur),this.normal},jr.prototype.getTexCoord=function(){return void 0===this.texCoord&&(this.texCoord=new dr),this.texCoord},jr.prototype.translate=function(t,e,i){this.point3d.add(t,e,i)},jr.prototype.getOutingHEdges=function(t){return void 0===t&&(t=[]),t},jr.prototype.getOutingFrontierHEdge=function(){if(this.outingHedge.isFrontier())return this.outingHedge;for(var t=this.outingHedge.twin.next;;){if(t.isFrontier())return t;if(void 0===(t=t.twin.next)||t===this.outingHedge)return}},jr.getCoincidentVertexArray=function(t,e,i,r){if(void 0===t||void 0===e)return i;void 0===i&&(i=[]),void 0===r&&(r=1e-4);for(var o=t.getPosition(),n=e.length,a=0;a<n;a++){var s=e[a];if(t!==s){var l=s.getPosition();o.isCoincidentToPointCHEAP(l,r)&&i.push(s)}}return i},jr.getProjectedOntoPlane=function(t,e,i,r){if(void 0===t)return r;var o,n=t.getPosition(),a=new Yi(n,i);return o=e.intersectionLine(a,o),void 0===r&&(r=new jr),r.copyFrom(t),r.setPosition(o.x,o.y,o.z),r};var Ur=function(){if(!(this instanceof Ur))throw new Error(ot.CONSTRUCT_ERROR);this.vertexArray=[]};Ur.getPrevIdx=function(t,e){var i=e.length;if(!(t<0||t>i-1))return 0===t?i-1:t-1},Ur.getNextIdx=function(t,e){var i=e.length;if(!(t<0||t>i-1))return t===i-1?0:t+1},Ur.getVtxSegment=function(t,e,i){var r=e[t],o=e[Ur.getNextIdx(t,e)];return void 0===i?i=new Yr(r,o):i.setVertices(r,o),i},Ur.getVector=function(t,e,i){var r=e[t],o=e[Ur.getNextIdx(t,e)],n=r.point3d,a=o.point3d;return void 0===i?i=new ur(a.x-n.x,a.y-n.y,a.z-n.z):i.set(a.x-n.x,a.y-n.y,a.z-n.z),i},Ur.getDirection=function(t,e,i){return(i=Ur.getVector(t,e,i)).unitary(),i},Ur.getCrossProduct=function(t,e,i){var r=Ur.getVector(t,e,void 0),o=Ur.getPrevIdx(t,e);return i=Ur.getVector(o,e,void 0).crossProduct(r,i)},Ur.getProjectedOntoPlane=function(t,e,i,r){if(void 0===t)return r;var o,n;void 0===r&&(r=new Ur);for(var a=t.getVertexCount(),s=0;s<a;s++)o=t.getVertex(s),n=r.newVertex(),n=jr.getProjectedOntoPlane(o,e,i,n);return r},Ur.getProjectedPoints2DArray=function(t,e,i){if(void 0===t)return i;void 0===i&&(i=[]);var r,o=Gi.getBestFacePlaneToProject(e),n=t.length;if(0===o)for(var a=0;a<n;a++){var s=(l=t[a]).point3d;(r=e.z>0?new dr(s.x,s.y):new dr(s.x,-s.y)).ownerVertex3d=l,i.push(r)}else if(1===o)for(a=0;a<n;a++){s=(l=t[a]).point3d;(r=e.x>0?new dr(s.y,s.z):new dr(-s.y,s.z)).ownerVertex3d=l,i.push(r)}else if(2===o)for(a=0;a<n;a++){var l;s=(l=t[a]).point3d;(r=e.y>0?new dr(-s.x,s.z):new dr(s.x,s.z)).ownerVertex3d=l,i.push(r)}return i},Ur.prototype.deleteVertexByVertexType=function(t){for(var e=[],i=this.getVertexCount(),r=0;r<i;r++){var o=this.getVertex(r);o.getVertexType()!==t?e.push(o):o.deleteObjects()}this.vertexArray=e},Ur.prototype.deleteObjects=function(){for(var t=0,e=this.vertexArray.length;t<e;t++)this.vertexArray[t].deleteObjects(),this.vertexArray[t]=void 0;this.vertexArray=void 0},Ur.prototype.copyFrom=function(t){var e;this.deleteObjects(),this.vertexArray=[];for(var i=t.getVertexCount(),r=0;r<i;r++)e=t.getVertex(r),this.newVertex().copyFrom(e)},Ur.prototype.copyFromPoint3DArray=function(t){if(void 0!==t){var e,i;this.deleteObjects(),this.vertexArray=[];for(var r=t.length,o=0;o<r;o++)e=t[o],(i=this.newVertex()).point3d=new ur,i.point3d.set(e.x,e.y,e.z),i.point3d.pointType=e.pointType,i.vertexType=e.pointType}},Ur.prototype.copyFromPoint2DList=function(t,e){var i,r;this.deleteObjects(),this.vertexArray=[],void 0===e&&(e=0);for(var o=t.getPointsCount(),n=0;n<o;n++)i=t.getPoint(n),(r=this.newVertex()).point3d=new ur,r.point3d.set(i.x,i.y,e),r.point3d.pointType=i.pointType,r.vertexType=i.pointType},Ur.prototype.setNormal=function(t,e,i){for(var r=this.getVertexCount(),o=0;o<r;o++)this.getVertex(o).setNormal(t,e,i)},Ur.prototype.newVertex=function(t){var e=new jr(t);return this.vertexArray.push(e),e},Ur.prototype.getVertex=function(t){return this.vertexArray[t]},Ur.prototype.getVertexCount=function(){return this.vertexArray.length},Ur.prototype.getPrevIdx=function(t){return Ur.getPrevIdx(t,this.vertexArray)},Ur.prototype.getNextIdx=function(t){return Ur.getNextIdx(t,this.vertexArray)},Ur.prototype.getIdxOfVertex=function(t){for(var e=this.vertexArray.length,i=0,r=-1,o=!1;!o&&i<e;)this.vertexArray[i]===t&&(o=!0,r=i),i++;return r},Ur.prototype.getVtxSegment=function(t,e){return Ur.getVtxSegment(t,this.vertexArray,e)},Ur.prototype.translateVertices=function(t,e,i){for(var r=0,o=this.vertexArray.length;r<o;r++)this.vertexArray[r].translate(t,e,i)},Ur.prototype.getBoundingBox=function(t){void 0===t&&(t=new y);for(var e=0,i=this.vertexArray.length;e<i;e++)0===e?t.init(this.vertexArray[e].point3d):t.addPoint(this.vertexArray[e].point3d);return t},Ur.prototype.transformPointsByMatrix4=function(t){for(var e=0,i=this.vertexArray.length;e<i;e++){var r=this.vertexArray[e];t.transformPoint3D(r.point3d,r.point3d)}},Ur.prototype.setIdxInList=function(){Ur.setIdxInList(this.vertexArray)},Ur.setIdxInList=function(t){if(void 0!==t)for(var e=0,i=t.length;e<i;e++)t[e].idxInList=e},Ur.prototype.getVboDataArrays=function(t,e){return Ur.getVboDataArrays(this.vertexArray,t,e),t},Ur.getVboDataArrays=function(t,e,i){var r,o,n,a,s,l=t.length;if(0===l)return e;void 0===e&&(e=new Ft);var h,d,c,u,f=!1,g=!1,p=!1;if(void 0===(r=t[0]).point3d)return e;(void 0!==r.normal&&(f=!0),void 0!==r.color4&&(g=!0),void 0!==r.texCoord&&(p=!0),h=new Float32Array(3*l),f)&&(d=new Int8Array(3*l));g&&(c=new Uint8Array(4*l));p&&(u=new Float32Array(2*l));for(var v=0;v<l;v++)void 0!==(r=t[v]).point3d&&(o=r.point3d,h[3*v]=o.x,h[3*v+1]=o.y,h[3*v+2]=o.z,f&&(n=r.normal,d[3*v]=127*n.x,d[3*v+1]=127*n.y,d[3*v+2]=127*n.z),g&&(a=r.color4,c[4*v]=255*a.r,c[4*v+1]=255*a.g,c[4*v+2]=255*a.b,c[4*v+3]=255*a.a),p&&(s=r.texCoord,u[2*v]=s.x,u[2*v+1]=s.y));return e.setDataArrayPos(h,i),f&&e.setDataArrayNor(d,i),g&&e.setDataArrayCol(c,i),p&&e.setDataArrayTexCoord(u,i),e};var kr=function(){if(!(this instanceof kr))throw new Error(ot.CONSTRUCT_ERROR);this.vertexListsArray=[],this.totalVertexArraySC=[]};kr.prototype.deleteObjects=function(){for(var t=0,e=this.vertexListsArray.length;t<e;t++)this.vertexListsArray[t].deleteObjects(),this.vertexListsArray[t]=void 0;this.vertexListsArray=void 0},kr.prototype.newVertexList=function(){var t=new Ur;return this.vertexListsArray.push(t),t},kr.prototype.getVertexList=function(t){return t>=0&&t<this.vertexListsArray.length?this.vertexListsArray[t]:void 0},kr.prototype.copyFrom=function(t){if(void 0!==t)for(var e,i=t.vertexListsArray.length,r=0;r<i;r++)e=t.getVertexList(r),this.newVertexList().copyFrom(e)},kr.prototype.getBoundingBox=function(t){void 0===t&&(t=new y),this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);for(var e=0,i=this.totalVertexArraySC.length;e<i;e++)0===e?t.init(this.totalVertexArraySC[e].point3d):t.addPoint(this.totalVertexArraySC[e].point3d);return t},kr.prototype.setVertexIdxInList=function(){for(var t=0,e=0,i=this.vertexListsArray.length;e<i;e++)for(var r=this.vertexListsArray[e],o=0,n=r.vertexArray.length;o<n;o++){r.getVertex(o).mIdxInList=t,t++}},kr.prototype.getVertexCount=function(){for(var t=0,e=0,i=this.vertexListsArray.length;e<i;e++)t+=this.vertexListsArray[e].getVertexCount();return t},kr.prototype.getTotalVertexArray=function(t){for(var e=0,i=this.vertexListsArray.length;e<i;e++)for(var r=this.vertexListsArray[e],o=0,n=r.vertexArray.length;o<n;o++){var a=r.getVertex(o);t.push(a)}return t},kr.prototype.getVBOVertexColorFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(6*e));for(var i=0;i<e;i++){var r=this.totalVertexArraySC[i];t[6*i]=r.point3d.x,t[6*i+1]=r.point3d.y,t[6*i+2]=r.point3d.z,t[6*i+3]=r.color4.r,t[6*i+4]=r.color4.g,t[6*i+5]=r.color4.b}return t},kr.prototype.getVBOVertexColorRGBAFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(7*e));for(var i=0;i<e;i++){var r=this.totalVertexArraySC[i];t[7*i]=r.point3d.x,t[7*i+1]=r.point3d.y,t[7*i+2]=r.point3d.z,t[7*i+3]=r.color4.r,t[7*i+4]=r.color4.g,t[7*i+5]=r.color4.b,t[7*i+6]=r.color4.a}return t},kr.prototype.getVBOVertexFloatArray=function(t){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var e=this.totalVertexArraySC.length;void 0===t&&(t=new Float32Array(3*e));for(var i=0;i<e;i++){var r=this.totalVertexArraySC[i];t[3*i]=r.point3d.x,t[3*i+1]=r.point3d.y,t[3*i+2]=r.point3d.z}return t},kr.prototype.translateVertices=function(t,e,i){for(var r=0,o=this.vertexListsArray.length;r<o;r++)this.vertexListsArray[r].translateVertices(t,e,i)},kr.prototype.makeTTrianglesLateralSidesLOOP=function(t){for(var e,i,r,o,n,a=0,s=0,l=this.vertexListsArray.length;s<l-1;s++){e=this.vertexListsArray[s],i=this.vertexListsArray[s+1],r=t.newTTrianglesList(),a=e.vertexArray.length;for(var h=0;h<a;h++)o=r.newTTriangle(),n=r.newTTriangle(),h===a-1?(o.setVertices(e.getVertex(h),i.getVertex(h),i.getVertex(0)),n.setVertices(e.getVertex(h),i.getVertex(0),e.getVertex(0))):(o.setVertices(e.getVertex(h),i.getVertex(h),i.getVertex(h+1)),n.setVertices(e.getVertex(h),i.getVertex(h+1),e.getVertex(h+1)))}},kr.makeMatrixByDataArray=function(t,e,i,r,o,n,a){if(void 0!==t){var s,l,h,d,c,u,f,g,p,v,y,m,x;void 0===a&&(a=new kr);for(var b=0;b<n;b++){s=a.newVertexList();for(var C=0;C<o;C++)l=s.newVertex(),h=t[3*C],d=t[3*C+1],c=t[3*C+2],l.setPosition(h,d,c),e&&(u=e[3*C],f=e[3*C+1],g=e[3*C+2],l.setNormal(u,f,g)),i&&(p=i[2*C],v=i[2*C+1],l.setTexCoord(p,v)),r&&(b=r[4*C],y=r[4*C+1],m=r[4*C+2],x=r[4*C+3],l.setColorRGBA(b,y,m,x))}return a}},kr.makeFacesBetweenVertexLists=function(t,e,i,r,o){var n,a;void 0===i&&(i=[]);var s,l,h,d,c=t.vertexArray.length;void 0===o&&(o=!1);var u=[],f=[];if(o)for(var g=0;g<c;g++)u.length=0,f.length=0,g<c-1?(s=t.getVertex(g),l=t.getVertex(g+1),h=e.getVertex(g+1),d=e.getVertex(g),n=new Gi,a=new Gi,n.addVerticesArray([s,d,l]),a.addVerticesArray([l,d,h]),i.push(n),i.push(a)):void 0!==r&&!0===r&&(s=t.getVertex(g),l=t.getVertex(0),h=e.getVertex(0),d=e.getVertex(g),n=new Gi,a=new Gi,n.addVerticesArray([s,d,l]),a.addVerticesArray([l,d,h]),i.push(n),i.push(a)),a;else for(g=0;g<c;g++)u.length=0,f.length=0,g<c-1?(s=t.getVertex(g),l=t.getVertex(g+1),h=e.getVertex(g+1),d=e.getVertex(g),n=new Gi,a=new Gi,n.addVerticesArray([s,l,d]),a.addVerticesArray([l,h,d]),i.push(n),i.push(a)):void 0!==r&&!0===r&&(s=t.getVertex(g),l=t.getVertex(0),h=e.getVertex(0),d=e.getVertex(g),n=new Gi,a=new Gi,n.addVerticesArray([s,l,d]),a.addVerticesArray([l,h,d]),i.push(n),i.push(a)),a;return i},kr.makeSurface=function(t,e,i,r){var o,n;void 0===e&&(e=new Ir);for(var a=[],s=t.vertexListsArray.length,l=0;l<s-1;l++)o=t.vertexListsArray[l],n=t.vertexListsArray[l+1],a=kr.makeFacesBetweenVertexLists(o,n,a,i,r),e.addFacesArray(a),a.length=0;return e},kr.prototype.makeTrianglesLateralSides=function(t,e){for(var i,r,o,n,a,s=0,l=0,h=this.vertexListsArray.length;l<h-1;l++){i=this.vertexListsArray[l],r=this.vertexListsArray[l+1],o=t.newTrianglesList(),s=i.vertexArray.length;for(var d=0;d<s;d++)d===s-1?void 0!==e&&!0===e&&(n=o.newTriangle(),a=o.newTriangle(),n.setVertices(i.getVertex(d),r.getVertex(d),r.getVertex(0)),a.setVertices(i.getVertex(d),r.getVertex(0),i.getVertex(0))):(n=o.newTriangle(),a=o.newTriangle(),n.setVertices(i.getVertex(d),r.getVertex(d),r.getVertex(d+1)),a.setVertices(i.getVertex(d),r.getVertex(d+1),i.getVertex(d+1)))}},kr.getIndexOfArray=function(t,e,i,r){return i+r*t},kr.prototype.transformPointsByMatrix4=function(t){for(var e=0,i=this.vertexListsArray.length;e<i;e++){this.vertexListsArray[e].transformPointsByMatrix4(t)}};var Gr=function(t){if(!(this instanceof Gr))throw new Error(ot.CONSTRUCT_ERROR);this.octree_owner=t,this.octree_level=0,this.octree_number_name=0,this.subOctrees_array,this.vertexArray,this.centerPos=new ur,this.half_dx=0,this.half_dy=0,this.half_dz=0};Gr.prototype.setBoxSize=function(t,e,i,r,o,n){this.centerPos.x=(e+t)/2,this.centerPos.y=(r+i)/2,this.centerPos.z=(n+o)/2,this.half_dx=(e-t)/2,this.half_dy=(r-i)/2,this.half_dz=(n-o)/2},Gr.prototype.new_subOctree=function(){var t=new Gr(this);return t.octree_level=this.octree_level+1,this.subOctrees_array.push(t),t},Gr.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array&&this.subOctrees_array.length>0){var t=this.centerPos.x,e=this.centerPos.y,i=this.centerPos.z,r=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(r,t,o,e,n,i),this.subOctrees_array[1].setBoxSize(t,a,o,e,n,i),this.subOctrees_array[2].setBoxSize(t,a,e,s,n,i),this.subOctrees_array[3].setBoxSize(r,t,e,s,n,i),this.subOctrees_array[4].setBoxSize(r,t,o,e,i,l),this.subOctrees_array[5].setBoxSize(t,a,o,e,i,l),this.subOctrees_array[6].setBoxSize(t,a,e,s,i,l),this.subOctrees_array[7].setBoxSize(r,t,e,s,i,l);for(var h=0;h<8;h++)this.subOctrees_array[h].setSizesSubBoxes()}},Gr.prototype.createChildren=function(){this.subOctrees_array=[];for(var t=0;t<8;t++){this.new_subOctree().octree_number_name=10*this.octree_number_name+(t+1)}this.setSizesSubBoxes()},Gr.prototype.makeTreeByMinSize=function(t){if(void 0!==this.vertexArray&&0!==this.vertexArray.length&&2*Math.min.apply(null,[this.half_dx,this.half_dy,this.half_dz])>t){this.createChildren();for(var e=this.vertexArray.length,i=0;i<e;i++)this.insertVertexToChildren(this.vertexArray[i]);this.vertexArray.length=0;for(i=0;i<8;i++)this.subOctrees_array[i].makeTreeByMinSize(t)}},Gr.prototype.extractOctreesWithData=function(t){if(void 0===t&&(t=[]),void 0!==this.vertexArray&&this.vertexArray.length>0&&t.push(this),this.subOctrees_array)for(var e=this.subOctrees_array.length,i=0;i<e;i++)this.subOctrees_array[i].extractOctreesWithData(t);return t},Gr.prototype.insertVertexToChildren=function(t){var e=-1,i=t.getPosition();e=i.x<this.centerPos.x?i.y<this.centerPos.y?i.z<this.centerPos.z?0:4:i.z<this.centerPos.z?3:7:i.y<this.centerPos.y?i.z<this.centerPos.z?2:6:i.z<this.centerPos.z?1:5;var r=this.subOctrees_array[e];void 0===r.vertexArray&&(r.vertexArray=[]),t.vertexIndexingOctree=r,r.vertexArray.push(t)};var zr=function(){if(!(this instanceof zr))throw new Error(ot.CONSTRUCT_ERROR);this.outerVtxRing,this.innerVtxRingsList};zr.prototype.deleteObjects=function(){void 0!==this.outerVtxRing&&(this.outerVtxRing.deleteObjects(),this.outerVtxRing=void 0),void 0!==this.innerVtxRingsList&&(this.innerVtxRingsList.deleteObjects(),this.innerVtxRingsList=void 0)},zr.prototype.getInnerVtxRingsCount=function(){return void 0===this.innerVtxRingsList||0===this.innerVtxRingsList.getRingsCount?0:this.innerVtxRingsList.getVtxRingsCount()},zr.prototype.getInnerVtxRing=function(t){if(void 0!==this.innerVtxRingsList&&0!==this.innerVtxRingsList.getRingsCount)return this.innerVtxRingsList.getVtxRing(t)},zr.prototype.setVerticesIdxInList=function(){this.outerVtxRing&&this.outerVtxRing.vertexList&&this.outerVtxRing.vertexList.setIdxInList(),this.innerVtxRingsList&&this.innerVtxRingsList.setVerticesIdxInList()},zr.prototype.copyFrom=function(t){t.outerVtxRing&&(void 0===this.outerVtxRing&&(this.outerVtxRing=new Wr),this.outerVtxRing.copyFrom(t.outerVtxRing)),t.innerVtxRingsList&&(void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Xr),this.innerVtxRingsList.copyFrom(t.innerVtxRingsList))},zr.prototype.translate=function(t,e,i){void 0!==this.outerVtxRing&&this.outerVtxRing.translate(t,e,i),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.translate(t,e,i)},zr.prototype.rotate=function(t,e,i,r){var o=new rt,n=new ft,a=new ur(e,i,r);a.unitary(),n.rotationAngDeg(t,a.x,a.y,a.z),o.rotationByQuaternion(n),this.transformPointsByMatrix4(o)},zr.prototype.transformPointsByMatrix4=function(t){void 0!==this.outerVtxRing&&this.outerVtxRing.transformPointsByMatrix4(t),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.transformPointsByMatrix4(t)},zr.prototype.getProjectedProfile2D=function(t){if(void 0===this.outerVtxRing)return t;var e=this.outerVtxRing.calculatePlaneNormal(void 0);if(void 0===e)return t;if(void 0===t&&(t=new xr),t.outerRing=this.outerVtxRing.getProjectedPolyLineBasedRing2D(t.outerRing,e),void 0!==this.innerVtxRingsList){var i,r=this.innerVtxRingsList.getVtxRingsCount();r>0&&(i=t.getInnerRingsList());for(var o=0;o<r;o++){var n=this.innerVtxRingsList.getVtxRing(o).getProjectedPolyLineBasedRing2D(void 0,e);i.addRing(n)}}return t},zr.prototype.makeByPoints3DArray=function(t,e){void 0!==t&&(void 0===this.outerVtxRing&&(this.outerVtxRing=new Wr),this.outerVtxRing.makeByPoints3DArray(t))},zr.prototype.updateByPoints3DArray=function(t,e){void 0!==t&&void 0!==this.outerVtxRing&&this.outerVtxRing.updateByPoints3DArray(t)},zr.prototype.makeByProfile2D=function(t){if(void 0!==t&&void 0!==t.outerRing){var e=t.outerRing;void 0===e.polygon&&e.makePolygon(),void 0===this.outerVtxRing&&(this.outerVtxRing=new Wr);var i=e.polygon.point2dList;if(this.outerVtxRing.makeByPoint2DList(i,0),void 0!==t.innerRingsList){var r=t.innerRingsList,o=r.getRingsCount();if(0!==o){var n;void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Xr);for(var a=0;a<o;a++)void 0===(n=r.getRing(a)).polygon&&n.makePolygon(),i=n.polygon.point2dList,this.innerVtxRingsList.newVtxRing().makeByPoint2DList(i,0)}}}},zr.prototype.getAllVertices=function(t){return void 0!==this.outerVtxRing&&this.outerVtxRing.getAllVertices(t),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.getAllVertices(t),t},zr.getProjectedOntoPlane=function(t,e,i,r){return void 0===t.outerVtxRing?r:(void 0===r&&(r=new zr),r.outerVtxRing=Wr.getProjectedOntoPlane(t.outerVtxRing,e,i,r.outerVtxRing),void 0!==t.innerVtxRingsList&&(r.innerVtxRingsList=Xr.getProjectedOntoPlane(t.innerVtxRingsList,e,i,r.innerVtxRingsList)),r)};var Hr=function(t,e){if(!(this instanceof Hr))throw new Error(ot.CONSTRUCT_ERROR);this.vtxProfilesArray,this.convexFacesIndicesData};Hr.prototype.deleteObjects=function(){if(void 0!==this.vtxProfilesArray){for(var t=this.vtxProfilesArray.length,e=0;e<t;e++)this.vtxProfilesArray[e].deleteObjects(),this.vtxProfilesArray[e]=void 0;this.vtxProfilesArray=void 0}void 0!==this.convexFacesIndicesData&&(this.convexFacesIndicesData=void 0)},Hr.getLateralFaces=function(t,e,i,r,o){void 0===i&&(i=[]);var n,a,s,l,h,d,c,u,f=r.getHalfEdgesList(),g=[];for(n=o.strIdx;n!==o.endIdx;)a=t.vertexList.getNextIdx(n),c=new Gi,i.push(c),c.vertexArray=[],s=t.vertexList.getVertex(n),l=t.vertexList.getVertex(a),h=e.vertexList.getVertex(a),d=e.vertexList.getVertex(n),Array.prototype.push.apply(c.vertexArray,[s,l,h,d]),g.length=0,g=c.createHalfEdges(g),f.addHalfEdgesArray(g),void 0!==u&&c.setTwinFace(u),u=c,n=a;return i},Hr.prototype.addVtxProfile=function(t){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]),this.vtxProfilesArray.push(t)},Hr.prototype.newVtxProfile=function(){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]);var t=new zr;return this.vtxProfilesArray.push(t),t},Hr.prototype.getVtxProfilesCount=function(){return void 0===this.vtxProfilesArray?0:this.vtxProfilesArray.length},Hr.prototype.getVtxProfile=function(t){if(void 0!==this.vtxProfilesArray)return this.vtxProfilesArray[t]},Hr.prototype.getAllVertices=function(t){void 0===t&&(t=[]);for(var e=this.getVtxProfilesCount(),i=0;i<e;i++)t=this.getVtxProfile(i).getAllVertices(t);return t},Hr.prototype.getMesh=function(t,e,i,r){if(void 0===this.vtxProfilesArray)return resultTriangleMatrix;void 0===r&&(r=!1),!0===r&&(e=!1,i=!1);var o,n,a=this.getVtxProfilesCount();if(a<2)return resultTriangleMatrix;void 0===t&&(t=new rr),void 0===t.vertexList&&(t.vertexList=new Ur),t.vertexList.vertexArray=this.getAllVertices(t.vertexList.vertexArray);for(var s,l,h,d,c,u,f=(o=this.getVtxProfile(0)).outerVtxRing,g=[],p=f.elemsIndexRangesArray.length,v={name:"outerLateral"},y=0;y<p;y++){d=t.newSurface(v),c=void 0,s=f.getElementIndexRange(y);for(var m=0;m<a;m++){if(m===a-1){if(!r)break;o=this.getVtxProfile(m),n=this.getVtxProfile(0)}else o=this.getVtxProfile(m),n=this.getVtxProfile(m+1);if(l=o.outerVtxRing,h=n.outerVtxRing,g.length=0,g=Hr.getLateralFaces(l,h,g,t,s),d.addFacesArray(g),void 0!==c&&c.length>0)for(var x=g.length,b=0;b<x;b++)T=g[b],M=c[b],T.setTwinFace(M);c=[],Array.prototype.push.apply(c,g)}}v.name="innerLateral";var C,A=o.getInnerVtxRingsCount();for(b=0;b<A;b++){p=(u=o.getInnerVtxRing(b)).elemsIndexRangesArray.length;for(y=0;y<p;y++){d=t.newSurface(v),c=void 0,s=u.getElementIndexRange(y);for(m=0;m<a;m++){if(m===a-1){if(!r)break;o=this.getVtxProfile(m),n=this.getVtxProfile(0)}else o=this.getVtxProfile(m),n=this.getVtxProfile(m+1);if(l=o.getInnerVtxRing(b),h=n.getInnerVtxRing(b),g.length=0,g=Hr.getLateralFaces(l,h,g,t,s),d.addFacesArray(g),void 0!==c&&c.length>0){x=g.length;for(var T,M,P=0;P<x;P++)T=g[P],M=c[P],T.setTwinFace(M)}c=[],Array.prototype.push.apply(c,g)}}}if(void 0===this.convexFacesIndicesData){var w=this.getVtxProfile(0).getProjectedProfile2D(w);this.convexFacesIndicesData=w.getConvexFacesIndicesData(this.convexFacesIndicesData)}return void 0!==i&&!0!==i||(v.name="top",n=this.getVtxProfile(a-1),C=t.newSurface(v),C=Hr.getTransversalSurface(n,this.convexFacesIndicesData,C)),void 0!==e&&!0!==e||(v.name="bottom",o=this.getVtxProfile(0),C=t.newSurface(v),(C=Hr.getTransversalSurface(o,this.convexFacesIndicesData,C)).reverseSense()),t},Hr.getTransversalSurface=function(t,e,i){var r,o,n,a,s,l,h;void 0===i&&(i=new Ir);for(var d=e.length,c=0;c<d;c++){(l=i.newFace()).vertexArray=[],s=(r=e[c]).length;for(var u=0;u<s;u++)n=(o=r[u]).ownerIdx,a=o.idxInList,h=(-1===n?t.outerVtxRing:t.innerVtxRingsList.getVtxRing(n)).vertexList.getVertex(a),l.vertexArray.push(h)}return i},Hr.prototype.makeLoft=function(t,e,i){this.convexFacesIndicesData=t.getConvexFacesIndicesData(void 0);var r=new zr;r.makeByProfile2D(t),void 0===i&&(i=!1);var o,n,a=e.getBisectionPlane(0,void 0,i),s=e.getPoint(0),l=a.getRotationMatrix(void 0);l.setTranslation(s.x,s.y,s.z),r.transformPointsByMatrix4(l);for(var h=e.getPointsCount(),d=0;d<h;d++){e.getPoint(d),o=e.getBisectionPlane(d,void 0,i),n=(0===d?e.getSegment3D(d,void 0,i):e.getSegment3D(d-1,void 0,i)).getDirection(void 0);var c=zr.getProjectedOntoPlane(r,o,n,void 0);this.addVtxProfile(c),r=c}};var Wr=function(){if(!(this instanceof Wr))throw new Error(ot.CONSTRUCT_ERROR);this.vertexList,this.elemsIndexRangesArray,this.isOpen};Wr.prototype.deleteObjects=function(){void 0!==this.vertexList&&(this.vertexList.deleteObjects(),this.vertexList=void 0),void 0!==this.elemsIndexRangesArray&&this.deleteElementIndexRanges()},Wr.prototype.deleteElementIndexRanges=function(){if(void 0!==this.elemsIndexRangesArray){for(var t=this.elemsIndexRangesArray.length,e=0;e<t;e++)this.elemsIndexRangesArray[e].deleteObjects(),this.elemsIndexRangesArray[e]=void 0;this.elemsIndexRangesArray=void 0}},Wr.prototype.newElementIndexRange=function(){void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);var t=new Xi;return this.elemsIndexRangesArray.push(t),t},Wr.prototype.getElementIndexRange=function(t){if(void 0!==this.elemsIndexRangesArray)return this.elemsIndexRangesArray[t]},Wr.prototype.getAllVertices=function(t){return void 0===this.vertexList||void 0===this.vertexList.vertexArray?t:(void 0===t&&(t=[]),t.push.apply(t,this.vertexList.vertexArray),t)},Wr.prototype.copyFrom=function(t){if(void 0!==t.vertexList&&(void 0===this.vertexList&&(this.vertexList=new Ur),this.vertexList.copyFrom(t.vertexList)),void 0!==t.elemsIndexRangesArray){var e;void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);for(var i=t.elemsIndexRangesArray.length,r=0;r<i;r++)e=t.elemsIndexRangesArray[r],this.newElementIndexRange().copyFrom(e)}this.isOpen=t.isOpen},Wr.prototype.translate=function(t,e,i){void 0!==this.vertexList&&this.vertexList.translateVertices(t,e,i)},Wr.prototype.transformPointsByMatrix4=function(t){void 0!==this.vertexList&&this.vertexList.transformPointsByMatrix4(t)},Wr.prototype.getProjectedPolyLineBasedRing2D=function(t,e){if(void 0===this.vertexList)return t;void 0===t&&(t=new Tr);var i=[];return i=Ur.getProjectedPoints2DArray(this.vertexList.vertexArray,e,i),t.newElement("POLYLINE").point2dArray=i,t},Wr.prototype.makeByPoints3DArray=function(t){if(void 0!==t){void 0===this.vertexList&&(this.vertexList=new Ur),this.vertexList.copyFromPoint3DArray(t);for(var e=this.vertexList.getVertexCount(),i=0;i<e;i++)this.vertexList.getVertex(i).setVertexType(1);this.calculateElementsIndicesRange()}},Wr.prototype.updateByPoints3DArray=function(t){if(void 0!==t){var e,i;void 0===this.vertexList&&(this.vertexList=new Ur);for(var r=t.length,o=0;o<r;o++)i=t[o],void 0===(e=this.vertexList.getVertex(o))&&(e=this.vertexList.newVertex()),void 0===e.point3d&&(e.point3d=new ur),e.point3d.set(i.x,i.y,i.z);this.vertexList.copyFromPoint3DArray(t)}},Wr.prototype.makeByPoint2DList=function(t,e){void 0!==t&&(void 0===e&&(e=0),void 0===this.vertexList&&(this.vertexList=new Ur),this.vertexList.copyFromPoint2DList(t,e),this.calculateElementsIndicesRange())},Wr.prototype.calculatePlaneNormal=function(t){return Gi.calculatePlaneNormal(this.vertexList.vertexArray,void 0)},Wr.prototype.calculateElementsIndicesRange=function(){if(void 0===this.vertexList)return!1;this.deleteElementIndexRanges(),this.elemsIndexRangesArray=[];for(var t,e=void 0,i=this.vertexList.getVertexCount(),r=0;r<i;r++)(t=this.vertexList.getVertex(r).vertexType)&&1===t&&(void 0!==e&&(e.endIdx=r),r!==i&&((e=this.newElementIndexRange()).strIdx=r));void 0!==e&&(e.endIdx=0)},Wr.getProjectedOntoPlane=function(t,e,i,r){return void 0===t.vertexList?resultRing2d:(void 0===r&&(r=new Wr),r.vertexList=Ur.getProjectedOntoPlane(t.vertexList,e,i,r.vertexList),r.calculateElementsIndicesRange(),r)};var Xr=function(){if(!(this instanceof Xr))throw new Error(ot.CONSTRUCT_ERROR);this.vtxRingsArray};Xr.prototype.deleteObjects=function(){if(void 0!==this.vtxRingsArray){for(var t=this.vtxRingsArray.length,e=0;e<t;e++)this.vtxRingsArray[e].deleteObjects(),this.vtxRingsArray[e]=void 0;this.vtxRingsArray=void 0}},Xr.prototype.getVtxRingsCount=function(){return void 0===this.vtxRingsArray?0:this.vtxRingsArray.length},Xr.prototype.getVtxRing=function(t){if(void 0!==this.vtxRingsArray)return this.vtxRingsArray[t]},Xr.prototype.newVtxRing=function(){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);var t=new Wr;return this.vtxRingsArray.push(t),t},Xr.prototype.copyFrom=function(t){if(void 0!==t){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);for(var e=t.getVtxRingsCount(),i=0;i<e;i++)this.newVtxRing().copyFrom(t.getVtxRing(i))}},Xr.prototype.translate=function(t,e,i){for(var r=this.getVtxRingsCount(),o=0;o<r;o++)this.vtxRingsArray[o].translate(t,e,i)},Xr.prototype.transformPointsByMatrix4=function(t){for(var e=this.getVtxRingsCount(),i=0;i<e;i++)this.vtxRingsArray[i].transformPointsByMatrix4(t)},Xr.prototype.getAllVertices=function(t){if(void 0===this.vtxRingsArray)return t;for(var e=this.getVtxRingsCount(),i=0;i<e;i++)this.vtxRingsArray[i].getAllVertices(t);return t},Xr.prototype.setVerticesIdxInList=function(){if(void 0!==this.vtxRingsArray)for(var t=this.getVtxRingsCount(),e=0;e<t;e++)this.vtxRingsArray[e].setVerticesIdxInList()},Xr.getProjectedOntoPlane=function(t,e,i,r){if(void 0===t)return r;var o,n;void 0===r&&(r=new Xr);for(var a=t.getVtxRingsCount(),s=0;s<a;s++)o=t.getVtxRing(s),n=r.newVtxRing(),n=Wr.getProjectedOntoPlane(o,e,i,n);return r};var Yr=function(t,e){if(!(this instanceof Yr))throw new Error(ot.CONSTRUCT_ERROR);this.startVertex,this.endVertex,t&&(this.startVertex=t),e&&(this.endVertex=e)};Yr.prototype.setVertices=function(t,e){this.startVertex=t,this.endVertex=e},Yr.prototype.getDirection=function(t){if(void 0!==(t=this.getVector()))return t.unitary(),t},Yr.prototype.getVector=function(t){if(void 0!==this.startVertex&&void 0!==this.endVertex){var e=this.startVertex.point3d,i=this.endVertex.point3d;if(void 0!==e&&void 0!==i)return t=e.getVectorToPoint(i,t)}},Yr.prototype.getLine=function(t){void 0===t&&(t=new Yi);var e=this.getDirection(),i=this.startVertex.point3d;return t.setPointAndDir(i.x,i.y,i.z,e.x,e.y,e.z),t},Yr.prototype.getSquaredLength=function(){return this.startVertex.point3d.squareDistToPoint(this.endVertex.point3d)},Yr.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},Yr.prototype.intersectionWithPoint=function(t,e){var i=this.getLine();if(void 0===e&&(e=1e-7),!i.isCoincidentPoint(t,e))return u.INTERSECTION_OUTSIDE;var r=this.startVertex.point3d.distToPoint(t),o=this.endVertex.point3d.distToPoint(t),n=this.getLength();return r<e?u.INTERSECTION_POINT_A:o<e?u.INTERSECTION_POINT_B:r>n||o>n?u.INTERSECTION_OUTSIDE:Math.abs(r+o-n)<e?u.INTERSECTION_INSIDE:void 0},"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,e){(arguments.length?this.then.apply(this,arguments):this).then(null,function(t){setTimeout(function(){throw t},0)})}),function t(e,i,r){function o(a,s){if(!i[a]){if(!e[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var d=i[a]={exports:{}};e[a][0].call(d.exports,function(t){var i=e[a][1][t];return o(i||t)},d,d.exports,t,e,i,r)}return i[a].exports}for(var n="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(t,e,i){var r=t("asap/raw");function o(){}var n=null,a={};function s(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._37=0,this._12=null,this._59=[],t!==o&&f(t,this)}function l(t,e){for(;3===t._37;)t=t._12;0!==t._37?r(function(){var i=1===t._37?e.onFulfilled:e.onRejected;if(null!==i){var r=function(t,e){try{return t(e)}catch(t){return n=t,a}}(i,t._12);r===a?d(e.promise,n):h(e.promise,r)}else 1===t._37?h(e.promise,t._12):d(e.promise,t._12)}):t._59.push(e)}function h(t,e){if(e===t)return d(t,new TypeError("A promise cannot be resolved with itself."));if(e&&("object"==typeof e||"function"==typeof e)){var i=function(t){try{return t.then}catch(t){return n=t,a}}(e);if(i===a)return d(t,n);if(i===t.then&&e instanceof s)return t._37=3,t._12=e,void c(t);if("function"==typeof i)return void f(i.bind(e),t)}t._37=1,t._12=e,c(t)}function d(t,e){t._37=2,t._12=e,c(t)}function c(t){for(var e=0;e<t._59.length;e++)l(t,t._59[e]);t._59=null}function u(t,e,i){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=i}function f(t,e){var i=!1,r=function(t,e,i){try{t(e,i)}catch(t){return n=t,a}}(t,function(t){i||(i=!0,h(e,t))},function(t){i||(i=!0,d(e,t))});i||r!==a||(i=!0,d(e,n))}e.exports=s,s._99=o,s.prototype.then=function(t,e){if(this.constructor!==s)return function(t,e,i){return new t.constructor(function(r,n){var a=new s(o);a.then(r,n),l(t,new u(e,i,a))})}(this,t,e);var i=new s(o);return l(this,new u(t,e,i)),i}},{"asap/raw":4}],2:[function(t,e,i){var r=t("./core.js");e.exports=r;var o=d(!0),n=d(!1),a=d(null),s=d(void 0),l=d(0),h=d("");function d(t){var e=new r(r._99);return e._37=1,e._12=t,e}r.resolve=function(t){if(t instanceof r)return t;if(null===t)return a;if(void 0===t)return s;if(!0===t)return o;if(!1===t)return n;if(0===t)return l;if(""===t)return h;if("object"==typeof t||"function"==typeof t)try{var e=t.then;if("function"==typeof e)return new r(e.bind(t))}catch(t){return new r(function(e,i){i(t)})}return d(t)},r.all=function(t){var e=Array.prototype.slice.call(t);return new r(function(t,i){if(0===e.length)return t([]);var o=e.length;function n(a,s){if(s&&("object"==typeof s||"function"==typeof s)){if(s instanceof r&&s.then===r.prototype.then){for(;3===s._37;)s=s._12;return 1===s._37?n(a,s._12):(2===s._37&&i(s._12),void s.then(function(t){n(a,t)},i))}var l=s.then;if("function"==typeof l)return void new r(l.bind(s)).then(function(t){n(a,t)},i)}e[a]=s,0==--o&&t(e)}for(var a=0;a<e.length;a++)n(a,e[a])})},r.reject=function(t){return new r(function(e,i){i(t)})},r.race=function(t){return new r(function(e,i){t.forEach(function(t){r.resolve(t).then(e,i)})})},r.prototype.catch=function(t){return this.then(null,t)}},{"./core.js":1}],3:[function(t,e,i){var r=t("./raw"),o=[],n=[],a=r.makeRequestCallFromTimer(function(){if(n.length)throw n.shift()});function s(t){var e;(e=o.length?o.pop():new l).task=t,r(e)}function l(){this.task=null}e.exports=s,l.prototype.call=function(){try{this.task.call()}catch(t){s.onerror?s.onerror(t):(n.push(t),a())}finally{this.task=null,o[o.length]=this}}},{"./raw":4}],4:[function(t,e,i){(function(t){function i(t){o.length||(r(),!0),o[o.length]=t}e.exports=i;var r,o=[],n=0,a=1024;function s(){for(;n<o.length;){var t=n;if(n+=1,o[t].call(),n>a){for(var e=0,i=o.length-n;e<i;e++)o[e]=o[e+n];o.length-=n,n=0}}o.length=0,n=0,!1}var l,h,d,c=t.MutationObserver||t.WebKitMutationObserver;function u(t){return function(){var e=setTimeout(r,0),i=setInterval(r,50);function r(){clearTimeout(e),clearInterval(i),t()}}}"function"==typeof c?(l=1,h=new c(s),d=document.createTextNode(""),h.observe(d,{characterData:!0}),r=function(){l=-l,d.data=l}):r=u(s),i.requestFlush=r,i.makeRequestCallFromTimer=u}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(t,e,i){"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(t,e){(arguments.length?this.then.apply(this,arguments):this).then(null,function(t){setTimeout(function(){throw t},0)})})},{}],6:[function(t,e,i){t("asap");"undefined"==typeof Promise&&(Promise=t("./lib/core.js"),t("./lib/es6-extensions.js")),t("./polyfill-done.js")},{"./lib/core.js":1,"./lib/es6-extensions.js":2,"./polyfill-done.js":5,asap:3}]},{},[6]),Promise.prototype.finally=Promise.prototype.finally||{finally(t){const e=e=>Promise.resolve(t()).then(()=>e);return this.then(t=>e(t),t=>e(Promise.reject(t)))}}.finally;var Kr=function(e){if(!(this instanceof Kr))throw new Error(ot.CONSTRUCT_ERROR);t.call(this),this.style,e?this.setStyle(e):this.style={},this.manager,this.collection,this.active=!1,this.result=[]};Kr.prototype=Object.create(t.prototype),Kr.prototype.constructor=Kr,Kr.prototype.getStyle=function(){return this.style},Kr.prototype.setStyle=function(t){this.style=t},Kr.prototype.setActive=function(t){if(!(this.manager&&this.manager instanceof tt))throw new Error(ot.REQUIRED_EMPTY_ERROR("MagoManager"));if(this.active!==t){this.collection||(this.collection=this.manager.interactions);t?(this.collection.emit(Y.EVENT_TYPE.ACTIVE,this),this.emit(this.constructor.EVENT_TYPE.ACTIVE,this)):(this.collection.emit(Y.EVENT_TYPE.DEACTIVE),this.emit(this.constructor.EVENT_TYPE.DEACTIVE))}},Kr.prototype.getActive=function(){return this.active},Kr.prototype.handle=function(){return Ai()},Kr.createDrawGeometryInteraction=function(t){if(!t)throw new Error(ot.REQUIRED_EMPTY_ERROR("geometry type"));var e;switch(t){case c.drawGeometryType.POINT:e=new Zr;break;case c.drawGeometryType.LINE:e=new qr;break;case c.drawGeometryType.POLYGON:e=new PolygonDrawer;break;case c.drawGeometryType.RECTANGLE:e=new Qr}return e};var qr=function(t){if(!(this instanceof qr))throw new Error(ot.CONSTRUCT_ERROR);Kr.call(this,t),this.points=[],this.height=200,this.tempLine,this.result=[]};qr.prototype=Object.create(Kr.prototype),qr.prototype.constructor=qr,qr.EVENT_TYPE={DRAWEND:"drawend"},qr.prototype.setHeight=function(t){this.height=t},qr.prototype.getHeight=function(){return this.height},qr.prototype.init=function(){this.points=[],this.tempLine=void 0,clearTimeout(this.timeout)},qr.prototype.clear=function(){this.init();for(var t=this.manager.modeler,e=this.result,i=0,r=e.length;i<r;i++){var o=e[i];t.removeObject(o)}this.result.length=0},qr.prototype.start=function(){if(!(this.manager&&this.manager instanceof tt))throw new Error(ot.REQUIRED_EMPTY_ERROR("MagoManager"));var t=this,e=t.manager;e.on(tt.EVENT_TYPE.LEFTUP,function(e){t.getActive()&&t.points.push(e.point.geographicCoordinate)}),e.on(tt.EVENT_TYPE.MOUSEMOVE,function(i){if(t.getActive()&&t.points.length>0){var r=t.points.slice(),o=i.endEvent.geographicCoordinate;r.push(o);var n={coordinates:r};t.tempLine?(t.tempLine.init(e),t.tempLine.setPosition(n)):(Object.keys(t.style).length<1&&(t.style={color:"#ff0000",thickness:2}),t.tempLine=new Ji(n,t.style),e.modeler.magoRectangle=t.tempLine)}}),e.on(tt.EVENT_TYPE.RIGHTCLICK,function(i){if(t.getActive()&&t.tempLine){t.points.push(i.clickCoordinate.geographicCoordinate);var r={coordinates:t.points};t.tempLine.init(e),t.tempLine.setPosition(r),t.end()}})},qr.prototype.end=function(){this.result.push(this.tempLine),this.manager.modeler.addObject(this.tempLine,1),this.emit(qr.EVENT_TYPE.DRAWEND,this.tempLine),this.init()};var Zr=function(t){if(!(this instanceof Zr))throw new Error(ot.CONSTRUCT_ERROR);Kr.call(this,t),this.startDraw=!1,this.result=[]};Zr.prototype=Object.create(Kr.prototype),Zr.prototype.constructor=Zr,Zr.EVENT_TYPE={DRAWEND:"drawend"},Zr.prototype.init=function(){this.startDraw=!1},Zr.prototype.clear=function(){this.init();for(var t=this.manager.modeler,e=this.result,i=0,r=e.length;i<r;i++){var o=e[i];t.removeObject(o)}this.result.length=0},Zr.prototype.start=function(){if(!(this.manager&&this.manager instanceof tt))throw new Error(ot.REQUIRED_EMPTY_ERROR("MagoManager"));var t=this,e=t.manager;e.on(tt.EVENT_TYPE.LEFTDOWN,function(e){t.getActive()&&(t.startDraw||(t.startDraw=!0))}),e.on(tt.EVENT_TYPE.LEFTUP,function(e){if(t.getActive()&&t.startDraw){var i=e.point.geographicCoordinate;Object.keys(t.style).length<1&&(t.style={size:10,color:"#00FF00"}),t.end(new Qi(i,t.style))}})},Zr.prototype.end=function(t){this.result.push(t),this.manager.modeler.addObject(t,1),this.emit(Zr.EVENT_TYPE.DRAWEND,t),this.init()};var Qr=function(t){if(!(this instanceof Qr))throw new Error(ot.CONSTRUCT_ERROR);Kr.call(this,t),this.startDraw=!1,this.dragging=!1,this.startPoint,this.endPoint,this.height=200,this.tempRectangle,this.result=[]};function Jr(t,e){this.jsonresponse=t,this.nodes=[],this.edges=[],this.cellSpaceMembers=[],this.cellSpaceBoundaryMembers=[],this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0,this.center_X=0,this.center_Y=0,this.ENU=new Cesium.Matrix4,this.jsonParsor,this.parsingJson(t,e),this.setCenter()}function $r(t){this.jsonresponse=t,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function to(t){this.jsonresponse=t,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function eo(t,e,i,r){if(this.description=t,this.href=e,this.id=i,this.surfaceMember=r,this.usage="",-1!=t.indexOf("Usage=")){var o=t.indexOf("Usage=")+6;this.usage=t.substring(o,t.indexOf(":",o))}if(this.section="",-1!=t.indexOf("Section=")){var n=t.indexOf("Section=")+8;this.section=t.substring(n,t.indexOf(":",n))}if(this.floor="",-1!=t.indexOf("Floor=")){var a=t.indexOf("Floor=")+6;this.floor=t.substring(a)}}function io(t){this.coordinates=t}function ro(t){this.coordinates=t}function oo(t,e,i){if(this.connects=t,this.description=e,this.stateMembers=i,null!=e){if(this.usage="",-1!=e.indexOf("Usage=")){var r=e.indexOf("Usage=")+6;this.usage=e.substring(r,e.indexOf(":",r))}if(this.section="",-1!=e.indexOf("Section=")){var o=e.indexOf("Section=")+8;this.section=e.substring(o,e.indexOf(":",o))}if(this.floor="",-1!=e.indexOf("Floor=")){var n=e.indexOf("Floor=")+6;this.floor=e.substring(n)}}}Qr.prototype=Object.create(Kr.prototype),Qr.prototype.constructor=Qr,Qr.EVENT_TYPE={DRAWEND:"drawend",ACTIVE:"active",DEACTIVE:"deactive"},Qr.prototype.setHeight=function(t){this.height=t},Qr.prototype.getHeight=function(){return this.height},Qr.prototype.init=function(){this.startDraw=!1,this.dragging=!1,this.startPoint=void 0,this.endPoint=void 0,this.tempRectangle=void 0,this.manager.magoWorld.cameraMovable=!0,this.manager.modeler.magoRectangle&&(this.manager.modeler.magoRectangle.deleteObjects(this.manager.vboMemoryManager),this.manager.modeler.magoRectangle=void 0)},Qr.prototype.clear=function(){this.init();for(var t=this.manager.modeler,e=this.result,i=0,r=e.length;i<r;i++){var o=e[i];t.removeObject(o)}this.result.length=0},Qr.prototype.start=function(){if(!(this.manager&&this.manager instanceof tt))throw new Error(ot.REQUIRED_EMPTY_ERROR("MagoManager"));var t=this,e=t.manager;e.on(tt.EVENT_TYPE.LEFTDOWN,function(i){t.getActive()&&(t.startDraw||(e.magoWorld.cameraMovable=!1,t.startDraw=!0,t.startPoint=i.point.geographicCoordinate))}),e.on(tt.EVENT_TYPE.MOUSEMOVE,function(i){if(t.getActive()&&t.startDraw&&t.startPoint){t.dragging=!0;var r=i.endEvent.geographicCoordinate,o={minLongitude:t.startPoint.longitude<r.longitude?t.startPoint.longitude:r.longitude,minLatitude:t.startPoint.latitude<r.latitude?t.startPoint.latitude:r.latitude,maxLongitude:t.startPoint.longitude<r.longitude?r.longitude:t.startPoint.longitude,maxLatitude:t.startPoint.latitude<r.latitude?r.latitude:t.startPoint.latitude,altitude:t.height};t.tempRectangle?(t.tempRectangle.init(e),t.tempRectangle.setPosition(o)):(Object.keys(t.style).length<1&&(t.style={fillColor:"#ff0000"}),t.tempRectangle=new $i(o,t.style),e.modeler.magoRectangle=t.tempRectangle)}}),e.on(tt.EVENT_TYPE.LEFTUP,function(e){t.getActive()&&t.dragging&&(t.endPoint=e.point,t.end())})},Qr.prototype.end=function(){this.manager.magoWorld.cameraMovable=!0,this.result.push(this.tempRectangle),this.manager.modeler.addObject(this.tempRectangle,1),this.emit(Qr.EVENT_TYPE.DRAWEND,this.tempRectangle),this.init()},Qr.prototype.cancle=function(){var t=this.result.length-1,e=this.result[t];this.manager.modeler.removeObject(e),this.result=this.result.slice(0,t)},Jr.prototype.parsingJson=function(t,e){"1.0.1"==e?this.jsonParsor=new $r(t):"1.0.3"==e?this.jsonParsor=new to(t):alert(e+" is not a vailid version!"),this.nodes=this.jsonParsor.parsingNodeData(t),this.edges=this.jsonParsor.parsingEdgeData(t),this.cellSpaceMembers=this.jsonParsor.parsingCellSpaceMember(t),this.max_X=this.jsonParsor.getMaxX(),this.max_Y=this.jsonParsor.getMaxY(),this.max_Z=this.jsonParsor.getMaxZ(),this.min_X=this.jsonParsor.getMinX(),this.min_Y=this.jsonParsor.getMinY(),this.min_Z=this.jsonParsor.getMinZ()},Jr.prototype.setCenter=function(){this.center_X=(this.min_X+this.max_X)/2,this.center_Y=(this.min_Y+this.max_Y)/2},Jr.prototype.rotateBuilding=function(t,e,i){var r=t.scene.globe.ellipsoid,o=new Cesium.Matrix4(Math.cos(i),-Math.sin(i),0,0,Math.sin(i),Math.cos(i),0,0,0,0,1,0,0,0,0,1);this.rotateCellSpaceMember(o,e,r),this.rotateCellSpaceBoundaryMembers(o,e,r),this.rotateNodes(o),this.rotateEdges(o)},Jr.prototype.rotateNodes=function(t){for(var e=this.nodes.length,i=0;i<e;i++){var r=new Cesium.Cartesian3(this.nodes[i].coordinates[0]-this.center_X,this.nodes[i].coordinates[1]-this.center_Y,this.nodes[i].coordinates[2]-this.min_Z),o=Cesium.Matrix4.multiplyByPoint(t,r,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,o,o);this.nodes[i].coordinates[0]=n.x,this.nodes[i].coordinates[1]=n.y,this.nodes[i].coordinates[2]=n.z}},Jr.prototype.rotateEdges=function(t){for(var e=0;e<this.edges.length;e++)for(var i=0;i<this.edges[e].stateMembers.length;i++){var r=new Cesium.Cartesian3(this.edges[e].stateMembers[i].coordinates[0]-this.center_X,this.edges[e].stateMembers[i].coordinates[1]-this.center_Y,this.edges[e].stateMembers[i].coordinates[2]-this.min_Z),o=Cesium.Matrix4.multiplyByPoint(t,r,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,o,o);this.edges[e].stateMembers[i].coordinates[0]=n.x,this.edges[e].stateMembers[i].coordinates[1]=n.y,this.edges[e].stateMembers[i].coordinates[2]=n.z}},Jr.prototype.rotateCellSpaceMember=function(t,e,i){Cesium.Transforms.eastNorthUpToFixedFrame(e,i,this.ENU);for(var r=0;r<this.cellSpaceMembers.length;r++)for(var o=this.cellSpaceMembers[r].surfaceMember.length,n=0;n<o;n++)for(var a=this.cellSpaceMembers[r].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceMembers[r].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceMembers[r].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceMembers[r].surfaceMember[n].coordinates[s+2]-this.min_Z),h=Cesium.Matrix4.multiplyByPoint(t,l,new Cesium.Cartesian3),d=Cesium.Matrix4.multiplyByPoint(this.ENU,h,h);this.cellSpaceMembers[r].surfaceMember[n].coordinates[s]=d.x,this.cellSpaceMembers[r].surfaceMember[n].coordinates[s+1]=d.y,this.cellSpaceMembers[r].surfaceMember[n].coordinates[s+2]=d.z}},Jr.prototype.rotateCellSpaceBoundaryMembers=function(t,e,i){Cesium.Transforms.eastNorthUpToFixedFrame(e,i,this.ENU);for(var r=0;r<this.cellSpaceBoundaryMembers.length;r++)for(var o=this.cellSpaceBoundaryMembers[r].surfaceMember.length,n=0;n<o;n++)for(var a=this.cellSpaceBoundaryMembers[r].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceBoundaryMembers[r].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceBoundaryMembers[r].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceBoundaryMembers[r].surfaceMember[n].coordinates[s+2]-this.min_Z),h=Cesium.Matrix4.multiplyByPoint(t,l,new Cesium.Cartesian3),d=Cesium.Matrix4.multiplyByPoint(this.ENU,h,h);this.cellSpaceBoundaryMembers[r].surfaceMember[n].coordinates[s]=d.x,this.cellSpaceBoundaryMembers[r].surfaceMember[n].coordinates[s+1]=d.y,this.cellSpaceBoundaryMembers[r].surfaceMember[n].coordinates[s+2]=d.z}},$r.prototype.parsingNodeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,r=i.length,o=0;o<r;o++){var n=new io(i[o].state.geometry.point.pos.value);e.push(n)}return e},$r.prototype.parsingEdgeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,r=0;r<i.length;r++){for(var o,n=[],a=0;a<i[r].transition.connects.length;a++)n.push(i[r].transition.connects[a].href);null!=i[r].transition.description&&(o=i[r].transition.description.value);for(var s=[],l=0;l<i[r].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var h=new io(i[r].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(h)}var d=new oo(n,o,s);e.push(d)}return e},$r.prototype.parsingCellSpaceMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,r=0;r<i;r++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[r],n="";null!=o.abstractFeature.value.description&&(n=o.abstractFeature.value.description.value);var a="";null!=o.abstractFeature.value.id&&(a=o.abstractFeature.value.id);var s="";null!=o.abstractFeature.value.duality.href&&(s=o.abstractFeature.value.duality.href);var l=new eo(n,s,a,[]);null!=o.abstractFeature.value.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(o):null!=o.abstractFeature.value.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(o)),e.push(l)}return e},$r.prototype.parsingCellSpaceBoundaryMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,r=0;r<i;r++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[r],n="";null!=o.abstractFeature.value.description&&(n=o.abstractFeature.value.description.value);var a="";null!=o.abstractFeature.value.id&&(a=o.abstractFeature.value.id);var s="";null!=o.abstractFeature.value.duality&&(s=o.abstractFeature.value.duality.href);var l=new eo(n,s,a,[]);null!=o.abstractFeature.value.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(o)),e.push(l)}return e},$r.prototype.getCsmSurfaceMemberFromGeometry3D=function(t){for(var e=t.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,i=[],r=0;r<e;r++){for(var o=t.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[r],n=new ro([]),a=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);i.push(n)}return i},$r.prototype.getCsmSurfaceMemberFromGeometry2D=function(t){for(var e=[],i=t.abstractFeature.value.geometry2D.abstractSurface.value.exterior.abstractRing,r=new ro([]),o=i.value.posOrPointPropertyOrPointRep.length,n=0;n<o;n++)r=this.abstractCoordinate(i.value.posOrPointPropertyOrPointRep[n].value.value,r);return e.push(r),e},$r.prototype.getCsbmSurfaceMemberFromGeometry3D=function(t){var e=new ro([]),i=[];if(null!=t.abstractFeature.value.geometry3D.abstractSurface.value.exterior)for(var r=t.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,o=0;o<r;o++)e=this.abstractCoordinate(t.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[o].value.value,e);return i.push(e),i},$r.prototype.abstractCoordinate=function(t,e){var i=t[0];e.coordinates.push(i),i>this.max_X?this.max_X=i:i<this.min_X&&(this.min_X=i);var r=t[1];e.coordinates.push(r),r>this.max_Y?this.max_Y=r:r<this.min_Y&&(this.min_Y=r);var o=t[2];return e.coordinates.push(o),o>this.max_Z?this.max_Z=o:o<this.min_Z&&(this.min_Z=o),e},$r.prototype.getMaxX=function(){return this.max_X},$r.prototype.getMaxY=function(){return this.max_Y},$r.prototype.getMaxZ=function(){return this.max_Z},$r.prototype.getMinX=function(){return this.min_X},$r.prototype.getMinY=function(){return this.min_Y},$r.prototype.getMinZ=function(){return this.min_Z},to.prototype.parsingNodeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,r=i.length,o=0;o<r;o++){var n=new io(i[o].state.geometry.point.pos.value);n.id=i[o].state.id,e.push(n)}return e},to.prototype.parsingEdgeData=function(t){for(var e=[],i=t.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,r=0;r<i.length;r++){for(var o,n=[],a=0;a<i[r].transition.connects.length;a++)n.push(i[r].transition.connects[a].href);null!=i[r].transition.description&&(o=i[r].transition.description.value);for(var s=[],l=0;l<i[r].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var h=new io(i[r].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(h)}var d=new oo(n,o,s);e.push(d)}return e},to.prototype.parsingCellSpaceMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,r=0;r<i;r++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[r],n="";null!=o.cellSpace.description&&(n=o.cellSpace.description.value);var a="";null!=o.cellSpace.id&&(a=o.cellSpace.id);var s="";null!=o.cellSpace.duality.href&&(s=o.cellSpace.duality.href);var l=new eo(n,s,a,[]);null!=o.cellSpace.cellSpaceGeometry.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(o):null!=o.cellSpace.cellSpaceGeometry.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(o)),e.push(l)}return e},to.prototype.parsingCellSpaceBoundaryMember=function(t){for(var e=[],i=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,r=0;r<i;r++){var o=t.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[r],n="";null!=o.cellSpaceBoundary.description&&(n=o.cellSpaceBoundary.description.value);var a="";null!=o.cellSpaceBoundary.id&&(a=o.cellSpaceBoundary.id);var s="";null!=o.cellSpaceBoundary.duality&&(s=o.cellSpaceBoundary.duality.href);var l=new eo(n,s,a,[]);null!=o.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(o)),e.push(l)}return e},to.prototype.getCsmSurfaceMemberFromGeometry3D=function(t){for(var e=t.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,i=[],r=0;r<e;r++){for(var o=t.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[r],n=new ro([]),a=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);i.push(n)}return i},to.prototype.getCsmSurfaceMemberFromGeometry2D=function(t){for(var e=[],i=t.cellSpace.cellSpaceGeometry.geometry2D.abstractSurface.value.exterior.abstractRing,r=new ro([]),o=i.value.posOrPointPropertyOrPointRep.length,n=0;n<o;n++)r=this.abstractCoordinate(i.value.posOrPointPropertyOrPointRep[n].value.value,r);return e.push(r),e},to.prototype.getCsbmSurfaceMemberFromGeometry3D=function(t){var e=new ro([]),i=[];if(null!=t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior)for(var r=t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,o=0;o<r;o++)e=this.abstractCoordinate(t.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[o].value.value,e);return i.push(e),i},to.prototype.abstractCoordinate=function(t,e){var i=t[0];e.coordinates.push(i),i>this.max_X?this.max_X=i:i<this.min_X&&(this.min_X=i);var r=t[1];e.coordinates.push(r),r>this.max_Y?this.max_Y=r:r<this.min_Y&&(this.min_Y=r);var o=t[2];return e.coordinates.push(o),o>this.max_Z?this.max_Z=o:o<this.min_Z&&(this.min_Z=o),e},to.prototype.getMaxX=function(){return this.max_X},to.prototype.getMaxY=function(){return this.max_Y},to.prototype.getMaxZ=function(){return this.max_Z},to.prototype.getMinX=function(){return this.min_X},to.prototype.getMinY=function(){return this.min_Y},to.prototype.getMinZ=function(){return this.min_Z};var no={VERSION:"2.0"};return no.Emitter=t,no.MagoRenderable=e,no.ViewerInit=i,no.ColorAPI=r,no.DrawAPI=o,no.LocationAndRotationAPI=n,no.LodAPI=a,no.AnimationData=p,no.AnimationManager=v,no.BoundingBox=y,no.BoundingSphere=m,no.BuildingSeed=x,no.BuildingSeedList=b,no.BuildingSeedMap=C,no.Camera=A,no.CCTV=M,no.CCTVList=T,no.CesiumViewerInit=P,no.CollisionCheckScene=w,no.Color=_,no.DynamicColor=S,no.F4dController=L,no.FBO=R,no.FileRequestControler=D,no.FirstPersonView=N,no.Frustum=B,no.FrustumVolumeControl=V,no.GeographicCoord=j,no.GeographicCoordSegment=U,no.GeographicCoordsList=k,no.GeographicExtent=G,no.GeoLocationData=z,no.GeoLocationDataManager=H,no.Globe=W,no.IdentifierManager=X,no.InteractionCollection=Y,no.LightSource=K,no.Mago3d=q,no.MagoEarthViewerInit=Z,no.MagoEvent=Q,no.MagoLayer=J,no.MagoLayerCollection=$,no.MagoManager=tt,no.MagoModel=et,no.ManagerFactory=it,no.Matrix4=rt,no.Message=me,no.MouseAction=nt,no.Movement=at,no.ObjectMarker=st,no.ObjectMarkerManager=lt,no.OcclusionCullingOctree=ht,no.OcclusionCullingOctreeCell=dt,no.Pin=ct,no.Plane=ut,no.Quaternion=ft,no.SelectionColor=gt,no.Settings=pt,no.SmartTile=vt,no.SmartTileManager=yt,no.Sphere=mt,no.SplitValue=xt,no.SunSystem=bt,no.TerranTile=Ct,no.Texture=At,no.TextureLayer=Tt,no.TexturesManager=Mt,no.TexturesStore=Pt,no.TriPolyhedron=St,no.TriSurface=Lt,no.VboBuffer=Rt,no.VBOKeysNation=Dt,no.VBOKeysStore=Et,no.VBOKeysWorld=It,no.VBOMemoryManager=Ot,no.VBOVertexIdxCacheKey=Ft,no.VBOVertexIdxCacheKeysContainer=Nt,no.VisibleObjectsController=Bt,no.WMSLayer=Vt,no.XYZLayer=jt,no.API=h,no.ChangeHistory=d,no.CODE=c,no.Constant=u,no.MagoConfig=f,no.Policy=g,no.Effect=s,no.EffectsManager=l,no.Accessor=Ut,no.Block=kt,no.BlocksArrayPartition=Gt,no.BlocksList=zt,no.CollisionCheckOctree=Ht,no.HierarchyManager=Wt,no.InspectorBox=Xt,no.Lego=Yt,no.LoadQueue=qt,no.LodBuilding=Zt,no.LodBuildingData=Qt,no.MetaData=Jt,no.ModelReferencedGroup=$t,no.MultiBuildings=ee,no.MultiBuildingsElement=ie,no.NeoBuilding=re,no.NeoBuildingsList=oe,no.NeoReference=ne,no.NeoReferencesMotherAndIndices=ae,no.NeoSimpleBuilding=se,no.NeoTexture=le,no.Node=he,no.Octree=de,no.ParseQueue=ce,no.ProcessQueue=ue,no.ProjectTree=fe,no.ReaderWriter=ge,no.SkinBuilding=pe,no.TinTerrain=ve,no.TinTerrainManager=ye,no.Arc2D=Ii,no.AxisXYZ=Oi,no.BoundingRectangle=Fi,no.BoxAux=Ni,no.BSplineCubic3D=Bi,no.Circle2D=Vi,no.Cluster=ji,no.CuttingPlane=Ui,no.Excavation=ki,no.Face=Gi,no.HalfEdge=zi,no.HalfEdgesList=Hi,no.IndexData=Wi,no.IndexRange=Xi,no.Intersect={OUTSIDE:0,INTERSECT:1,INSIDE:2,POINT_A:3,POINT_B:4},no.Line=Yi,no.Line2D=Ki,no.MagoGeometry=qi,no.MagoNativeProject=Zi,no.MagoPoint=Qi,no.MagoPolyline=Ji,no.MagoRectangle=$i,no.MagoWorld=tr,no.Material=er,no.MaterialsManager=ir,no.Mesh=rr,no.Modeler=or,no.ParametricMesh=nr,no.Path3D=ar,no.PipeKnot=sr,no.PipePath=lr,no.PlaneGrid=hr,no.Point2D=dr,no.Point2DList=cr,no.Point3D=ur,no.Point3DList=fr,no.Point4D=gr,no.Polygon2D=pr,no.PolyLine2D=vr,no.PolyLine3D=yr,no.ProcessCounterManager=mr,no.Profile2D=xr,no.Profiles2DList=br,no.QuatTree=Cr,no.Rectangle2D=Ar,no.Ring2D=Tr,no.Ring2DList=Mr,no.RingType={ARC:0,CIRCLE:1,POLYLINE:2,RECTANGLE:3,Star2D:4,NUMBER_OF_RING_TYPE:5},no.ScreenQuad=Pr,no.Segment2D=wr,no.Segment3D=_r,no.ShadowMesh=Sr,no.Sky=Lr,no.Star2D=Rr,no.StaticModel=Dr,no.Surface=Ir,no.Triangle=Or,no.Triangle2D=Fr,no.TrianglesList=Nr,no.TrianglesMatrix=Br,no.Tunnel=Vr,no.Vertex=jr,no.VertexList=Ur,no.VertexMatrix=kr,no.VertexOctree=Gr,no.VtxProfile=zr,no.VtxProfilesList=Hr,no.VtxRing=Wr,no.VtxRingsList=Xr,no.VtxSegment=Yr,no.Message=me,no.MessageSource=xe,no.GeoServer=be,no.AnimatedPerson=Se,no.Arrow=Le,no.BasicFactory=Re,no.BasicVehicle=De,no.Box=Ee,no.ClippingBox=Ie,no.ConcentricTubes=Oe,no.Cylinder=Fe,no.Ellipsoid=Ne,no.GolfHoleFlag=Be,no.ImageViewerRectangle=Ve,no.Pipe=je,no.PointMesh=Ue,no.RenderableObject=ke,no.SkeletalAnimationObject=Ge,no.SpeechBubble=ze,no.TerrainScannerLinear=He,no.TestFreeContourWallBuilding=We,no.Tube=Xe,no.VectorMesh=Ye,no.Vehicle=Ke,no.Wheel=qe,no.Renderer=Ae,no.RenderingSettings=Te,no.SceneState=Me,no.Selection=Pe,no.SelectionCandidateFamily=we,no.SelectionManager=_e,no.AttribLocationState=Ze,no.PostFxShader=Qe,no.PostFxShadersManager=Je,no.ShaderSource=$e,no.Uniform1fDataPair=ti,no.Uniform1iDataPair=ei,no.UniformMatrix4fvDataPair=ii,no.UniformVec2fvDataPair=ri,no.UniformVec3fvDataPair=oi,no.UniformVec4fvDataPair=ni,no.Network=mi,no.NetworkEdge=xi,no.NetworkNode=bi,no.NetworkSpace=Ci,no.abstract=Ai,no.ByteColor=Ti,no.CameraController=Mi,no.createGuid=Pi,no.defaultValue=wi,no.defaultValueCheckLength=_i,no.defined=Si,no.GeometryUtils=Li,no.isEmpty=Ri,no.loadWithXhr=Di,no.ManagerUtils=Ei,no.Image3D=li,no.PrecipitationLayer=ci,no.TemperatureLayer=gi,no.WeatherStation=pi,no.WindLayer=vi,no.WindVolume=yi,no["Promise.done"]=Promise.done,no.Promise=Promise,no.DrawGeometryInteraction=Kr,no.LineDrawer=qr,no.PointDrawer=Zr,no.RectangleDrawer=Qr,no.GMLDataContainer=Jr,no.JsonParsor_1_0_1=$r,no.JsonParsor_1_0_3=to,no.CellSpaceMember=eo,no.StateMember=io,no.SurfaceMember=ro,no.TransitionMember=oo,no}();